
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 09 | 用户态跟踪：如何使用 eBPF 排查应用程序？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>09 | 用户态跟踪：如何使用 eBPF 排查应用程序？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">09 | 用户态跟踪：如何使用 eBPF 排查应用程序？</h1><div><span>倪朋飞</span> <span> 2022-02-04</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/c4/69/c4e79253776f0772792fd367a4ffbd69.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：山荣</span><span>大小：18.81M</span><span> 时长：20:36</span></div></div><audio title="09 | 用户态跟踪：如何使用 eBPF 排查应用程序？" src="https://res001.geekbang.org/media/audio/2c/61/2cf6e8bddccd664bd26bbc267dcc3561/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="5206" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="5207"><span data-slate-object="text" data-key="5208"><span data-slate-leaf="true" data-offset-key="5208:0" data-first-offset="true"><span data-slate-string="true">你好，我是倪朋飞。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5209"><span data-slate-object="text" data-key="5210"><span data-slate-leaf="true" data-offset-key="5210:0" data-first-offset="true"><span data-slate-string="true">前面两讲，我带你梳理了查询 eBPF 跟踪点的常用方法，并以短时进程的跟踪为例，通过 bpftrace、BCC 和 libbpf 等三种方法实现了短时进程的跟踪程序。学完这些内容，我想你已经可以根据自己的实际需求，查询到内核跟踪点或内核函数，并自己开发一个 eBPF 内核跟踪程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5211"><span data-slate-object="text" data-key="5212"><span data-slate-leaf="true" data-offset-key="5212:0" data-first-offset="true"><span data-slate-string="true">也许你想问：我们能不能利用与跟踪内核状态类似的方法，去跟踪用户空间的进程呢？答案是肯定的。只要把内核态跟踪使用的 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5213"><span data-slate-object="text" data-key="5214"><span data-slate-leaf="true" data-offset-key="5214:0" data-first-offset="true"><span data-slate-string="true">kprobe</span></span></span></span><span data-slate-object="text" data-key="5215"><span data-slate-leaf="true" data-offset-key="5215:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 和 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5216"><span data-slate-object="text" data-key="5217"><span data-slate-leaf="true" data-offset-key="5217:0" data-first-offset="true"><span data-slate-string="true">tracepoint</span></span></span></span><span data-slate-object="text" data-key="5218"><span data-slate-leaf="true" data-offset-key="5218:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 替换成 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5219"><span data-slate-object="text" data-key="5220"><span data-slate-leaf="true" data-offset-key="5220:0" data-first-offset="true"><span data-slate-string="true">uprobe</span></span></span></span><span data-slate-object="text" data-key="5221"><span data-slate-leaf="true" data-offset-key="5221:0" data-first-offset="true"><span data-slate-string="true">&nbsp;，或者用户空间定义的静态跟踪点（User Statically Defined Tracing，简称 USDT），并找出用户进程需要跟踪的函数，作为 eBPF 程序的挂载点，你就可以去跟踪用户进程的内部状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5222"><span data-slate-object="text" data-key="5223"><span data-slate-leaf="true" data-offset-key="5223:0" data-first-offset="true"><span data-slate-string="true">那具体该怎么做呢？今天，我就带你一起来看看，如何使用 eBPF 去跟踪用户进程的执行状态。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5224" id="sr-toc-1"><span data-slate-object="text" data-key="5225"><span data-slate-leaf="true" data-offset-key="5225:0" data-first-offset="true"><span data-slate-string="true">如何查询用户进程跟踪点？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5226"><span data-slate-object="text" data-key="5227"><span data-slate-leaf="true" data-offset-key="5227:0" data-first-offset="true"><span data-slate-string="true">在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5228"><span data-slate-object="text" data-key="5229"><span data-slate-leaf="true" data-offset-key="5229:0" data-first-offset="true"><span data-slate-string="true">07 讲</span></span></span></a><span data-slate-object="text" data-key="5230"><span data-slate-leaf="true" data-offset-key="5230:0" data-first-offset="true"><span data-slate-string="true"> 中我曾提到，在跟踪内核的状态之前，你需要利用内核提供的调试信息查询内核函数、内核跟踪点以及性能事件等。类似地，在跟踪应用进程之前，你也需要知道</span></span></span><span data-slate-object="text" data-key="5231"><span data-slate-leaf="true" data-offset-key="5231:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这个进程所对应的二进制文件中提供了哪些可用的跟踪点</span></span></span></span><span data-slate-object="text" data-key="5232"><span data-slate-leaf="true" data-offset-key="5232:0" data-first-offset="true"><span data-slate-string="true">。那么，从哪里可以找到这些信息呢？如果你使用 GDB 之类的应用调试过程序，这时应该已经想到了，那就是</span></span></span><span data-slate-object="text" data-key="5233"><span data-slate-leaf="true" data-offset-key="5233:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">应用程序二进制文件中的调试信息</span></span></span></span><span data-slate-object="text" data-key="5234"><span data-slate-leaf="true" data-offset-key="5234:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5235"><span data-slate-object="text" data-key="5236"><span data-slate-leaf="true" data-offset-key="5236:0" data-first-offset="true"><span data-slate-string="true">在静态语言的编译过程中，通常你可以加上 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5237"><span data-slate-object="text" data-key="5238"><span data-slate-leaf="true" data-offset-key="5238:0" data-first-offset="true"><span data-slate-string="true">-g</span></span></span></span><span data-slate-object="text" data-key="5239"><span data-slate-leaf="true" data-offset-key="5239:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 选项保留调试信息。这样，源代码中的函数、变量以及它们对应的代码行号等信息，就以 &nbsp;</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5240"><span data-slate-object="text" data-key="5241"><span data-slate-leaf="true" data-offset-key="5241:0" data-first-offset="true"><span data-slate-string="true">DWARF</span></span></span></a><span data-slate-object="text" data-key="5242"><span data-slate-leaf="true" data-offset-key="5242:0" data-first-offset="true"><span data-slate-string="true">（Debugging With Attributed Record Formats，Linux 和类 Unix 平台最主流的调试信息格式）格式存储到了编译后的二进制文件中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5243"><span data-slate-object="text" data-key="5244"><span data-slate-leaf="true" data-offset-key="5244:0" data-first-offset="true"><span data-slate-string="true">有了调试信息，你就可以通过 &nbsp;</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5245"><span data-slate-object="text" data-key="5246"><span data-slate-leaf="true" data-offset-key="5246:0" data-first-offset="true"><span data-slate-string="true">readelf</span></span></span></a><span data-slate-object="text" data-key="5247"><span data-slate-leaf="true" data-offset-key="5247:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5248"><span data-slate-object="text" data-key="5249"><span data-slate-leaf="true" data-offset-key="5249:0" data-first-offset="true"><span data-slate-string="true">objdump</span></span></span></a><span data-slate-object="text" data-key="5250"><span data-slate-leaf="true" data-offset-key="5250:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5251"><span data-slate-object="text" data-key="5252"><span data-slate-leaf="true" data-offset-key="5252:0" data-first-offset="true"><span data-slate-string="true">nm</span></span></span></a><span data-slate-object="text" data-key="5253"><span data-slate-leaf="true" data-offset-key="5253:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 等工具，查询可用于跟踪的函数、变量等符号列表。比如，我经常使用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5254"><span data-slate-object="text" data-key="5255"><span data-slate-leaf="true" data-offset-key="5255:0" data-first-offset="true"><span data-slate-string="true">readelf</span></span></span></span><span data-slate-object="text" data-key="5256"><span data-slate-leaf="true" data-offset-key="5256:0" data-first-offset="true"><span data-slate-string="true"> 命令，查询二进制文件的基本信息。在终端中执行下面的命令，就可以查询 &nbsp;</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5257"><span data-slate-object="text" data-key="5258"><span data-slate-leaf="true" data-offset-key="5258:0" data-first-offset="true"><span data-slate-string="true">libc</span></span></span></a><span data-slate-object="text" data-key="5259"><span data-slate-leaf="true" data-offset-key="5259:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 动态链接库中的符号表：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5260"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5261"><span data-slate-object="text" data-key="5262"><span data-slate-leaf="true" data-offset-key="5262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 查询符号表（RHEL8 系统中请把动态库路径替换为 /usr/lib64/libc.so.6）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5263"><span data-slate-object="text" data-key="5264"><span data-slate-leaf="true" data-offset-key="5264:0" data-first-offset="true"><span data-slate-string="true">readelf -Ws /usr/lib/x86_64-linux-gnu/libc.so.6</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5265"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5266"><span data-slate-object="text" data-key="5267"><span data-slate-leaf="true" data-offset-key="5267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 查询 USDT 信息（USDT 信息位于 ELF 文件的 notes 段）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5268"><span data-slate-object="text" data-key="5269"><span data-slate-leaf="true" data-offset-key="5269:0" data-first-offset="true"><span data-slate-string="true">readelf -n /usr/lib/x86_64-linux-gnu/libc.so.6</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5270"><span data-slate-object="text" data-key="5271"><span data-slate-leaf="true" data-offset-key="5271:0" data-first-offset="true"><span data-slate-string="true">当然，我们 &nbsp;</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5272"><span data-slate-object="text" data-key="5273"><span data-slate-leaf="true" data-offset-key="5273:0" data-first-offset="true"><span data-slate-string="true">07 讲</span></span></span></a><span data-slate-object="text" data-key="5274"><span data-slate-leaf="true" data-offset-key="5274:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 中提到的 bpftrace 工具也可以用来查询 uprobe 和 USDT 跟踪点，其查询格式如下所示（同样支持 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5275"><span data-slate-object="text" data-key="5276"><span data-slate-leaf="true" data-offset-key="5276:0" data-first-offset="true"><span data-slate-string="true">*</span></span></span></span><span data-slate-object="text" data-key="5277"><span data-slate-leaf="true" data-offset-key="5277:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 通配符过滤）：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5278"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5279"><span data-slate-object="text" data-key="5280"><span data-slate-leaf="true" data-offset-key="5280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 查询 uprobe（RHEL8 系统中请把动态库路径替换为 /usr/lib64/libc.so.6）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5281"><span data-slate-object="text" data-key="5282"><span data-slate-leaf="true" data-offset-key="5282:0" data-first-offset="true"><span data-slate-string="true">bpftrace -l </span></span></span><span data-slate-object="text" data-key="5283"><span data-slate-leaf="true" data-offset-key="5283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'uprobe:/usr/lib/x86_64-linux-gnu/libc.so.6:*'</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5284"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5285"><span data-slate-object="text" data-key="5286"><span data-slate-leaf="true" data-offset-key="5286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 查询 USDT</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5287"><span data-slate-object="text" data-key="5288"><span data-slate-leaf="true" data-offset-key="5288:0" data-first-offset="true"><span data-slate-string="true">bpftrace -l </span></span></span><span data-slate-object="text" data-key="5289"><span data-slate-leaf="true" data-offset-key="5289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'usdt:/usr/lib/x86_64-linux-gnu/libc.so.6:*'</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5290"><span data-slate-object="text" data-key="5291"><span data-slate-leaf="true" data-offset-key="5291:0" data-first-offset="true"><span data-slate-string="true">同内核跟踪点类似，你也可以加上 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5292"><span data-slate-object="text" data-key="5293"><span data-slate-leaf="true" data-offset-key="5293:0" data-first-offset="true"><span data-slate-string="true">-v</span></span></span></span><span data-slate-object="text" data-key="5294"><span data-slate-leaf="true" data-offset-key="5294:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 选项查询用户探针的参数格式。不过需要再次强调的是，</span></span></span><span data-slate-object="text" data-key="5295"><span data-slate-leaf="true" data-offset-key="5295:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">想要通过二进制文件查询符号表和参数定义，必须在编译的时候保留 DWARF 调试信息</span></span></span></span><span data-slate-object="text" data-key="5296"><span data-slate-leaf="true" data-offset-key="5296:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5297"><span data-slate-object="text" data-key="5298"><span data-slate-leaf="true" data-offset-key="5298:0" data-first-offset="true"><span data-slate-string="true">除了符号表之外，理论上你可以把 uprobe 插桩到二进制文件的任意地址。不过这要求你对应用程序 ELF 格式的地址空间非常熟悉，并且具体的地址会随着应用的迭代更新而发生变化。所以，在需要跟踪地址的场景中，一定要记得去 ELF 二进制文件动态获取地址信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5299"><span data-slate-object="text" data-key="5300"><span data-slate-leaf="true" data-offset-key="5300:0" data-first-offset="true"><span data-slate-string="true">另外需要提醒你的是，</span></span></span><span data-slate-object="text" data-key="5301"><span data-slate-leaf="true" data-offset-key="5301:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">uprobe 是基于文件的。当文件中的某个函数被跟踪时，除非对进程 PID 进行了过滤，默认所有使用到这个文件的进程都会被插桩。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5302" id="sr-toc-2"><span data-slate-object="text" data-key="5303"><span data-slate-leaf="true" data-offset-key="5303:0" data-first-offset="true"><span data-slate-string="true">编程语言会影响 eBPF 的跟踪吗？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5304"><span data-slate-object="text" data-key="5305"><span data-slate-leaf="true" data-offset-key="5305:0" data-first-offset="true"><span data-slate-string="true">如果你了解过不同的编程语言，看到这里你肯定会想到，这些查询跟踪点信息的方法很可能是跟编程语言相关的。C 语言和 Python 语言是我们课程的学习基础，也是前面几讲的案例中反复使用的编程语言，我相信你至少已经对它们有了简单的了解。这里我们对比下这两种编程语言在运行方式上的区别：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5306"><div data-slate-type="list-line" data-slate-object="block" data-key="5307"><span data-slate-object="text" data-key="5308"><span data-slate-leaf="true" data-offset-key="5308:0" data-first-offset="true"><span data-slate-string="true">C 语言程序需要编译为二进制文件之后再执行，编译时加上 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5309"><span data-slate-object="text" data-key="5310"><span data-slate-leaf="true" data-offset-key="5310:0" data-first-offset="true"><span data-slate-string="true">-g</span></span></span></span><span data-slate-object="text" data-key="5311"><span data-slate-leaf="true" data-offset-key="5311:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 选项就可以在最终的二进制文件中保留调试信息；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5312"><span data-slate-object="text" data-key="5313"><span data-slate-leaf="true" data-offset-key="5313:0" data-first-offset="true"><span data-slate-string="true">Python 语言程序则是一个文本文件，不需要 C 语言那样的编译过程，而是由 Python 解释器进行语法分析后执行。因而，上述</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5314"><span data-slate-object="text" data-key="5315"><span data-slate-leaf="true" data-offset-key="5315:0" data-first-offset="true"><span data-slate-string="true"> readelf</span></span></span></span><span data-slate-object="text" data-key="5316"><span data-slate-leaf="true" data-offset-key="5316:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 等工具没法从 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5317"><span data-slate-object="text" data-key="5318"><span data-slate-leaf="true" data-offset-key="5318:0" data-first-offset="true"><span data-slate-string="true">python</span></span></span></span><span data-slate-object="text" data-key="5319"><span data-slate-leaf="true" data-offset-key="5319:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 二进制文件中直接读取到应用程序的调试信息。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5320"><span data-slate-object="text" data-key="5321"><span data-slate-leaf="true" data-offset-key="5321:0" data-first-offset="true"><span data-slate-string="true">当然，C 和 Python 只是我们课程中使用的两种编程语言，实际的编程语言种类要多得多。如果把常用的编程语言进行归类，按照其运行原理，我认为大致上可以分为三类：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5322"><div data-slate-type="list-line" data-slate-object="block" data-key="5323"><span data-slate-object="text" data-key="5324"><span data-slate-leaf="true" data-offset-key="5324:0" data-first-offset="true"><span data-slate-string="true">第一类是 C、C++、Golang 等编译为机器码后再执行的</span></span></span><span data-slate-object="text" data-key="5325"><span data-slate-leaf="true" data-offset-key="5325:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">编译型语言</span></span></span></span><span data-slate-object="text" data-key="5326"><span data-slate-leaf="true" data-offset-key="5326:0" data-first-offset="true"><span data-slate-string="true">。这类编程语言开发的程序，通常会编译成 ELF 格式的二进制文件，包含了保存在寄存器或栈中的函数参数和返回值，因而可以直接通过二进制文件中的符号进行跟踪。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5327"><span data-slate-object="text" data-key="5328"><span data-slate-leaf="true" data-offset-key="5328:0" data-first-offset="true"><span data-slate-string="true">第二类是 Python、Bash、Ruby 等通过解释器语法分析之后再执行的</span></span></span><span data-slate-object="text" data-key="5329"><span data-slate-leaf="true" data-offset-key="5329:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">解释型语言</span></span></span></span><span data-slate-object="text" data-key="5330"><span data-slate-leaf="true" data-offset-key="5330:0" data-first-offset="true"><span data-slate-string="true">。这类编程语言开发的程序，无法直接从语言运行时的二进制文件中获取应用程序的调试信息，通常需要跟踪解释器的函数，再从其参数中获取应用程序的运行细节。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5331"><span data-slate-object="text" data-key="5332"><span data-slate-leaf="true" data-offset-key="5332:0" data-first-offset="true"><span data-slate-string="true">最后一类是 Java、.Net、JavaScript 等先编译为字节码，再由即时编译器（JIT）编译为机器码执行的</span></span></span><span data-slate-object="text" data-key="5333"><span data-slate-leaf="true" data-offset-key="5333:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">即时编译型语言</span></span></span></span><span data-slate-object="text" data-key="5334"><span data-slate-leaf="true" data-offset-key="5334:0" data-first-offset="true"><span data-slate-string="true">。同解释型语言类似，这类编程语言无法直接从语言运行时的二进制文件中获取应用程序的调试信息。跟踪 JIT 编程语言开发的程序是最困难的，因为 JIT 编译的状态只存在于内存中。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5335"><span data-slate-object="text" data-key="5336"><span data-slate-leaf="true" data-offset-key="5336:0" data-first-offset="true"><span data-slate-string="true">对比这几类编程语言，你可以发现，编程语言的类型对 eBPF 跟踪也有非常大的影响，不同类型编程语言开发的应用程序，其跟踪过程和难度也不相同。接下来，我就用几个案例带你一起来看看每一类编程语言的跟踪方法。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5337" id="sr-toc-3"><span data-slate-object="text" data-key="5338"><span data-slate-leaf="true" data-offset-key="5338:0" data-first-offset="true"><span data-slate-string="true">跟踪编译型语言应用程序</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5339"><span data-slate-object="text" data-key="5340"><span data-slate-leaf="true" data-offset-key="5340:0" data-first-offset="true"><span data-slate-string="true">由于可以直接从调试信息中获取到符号（用于跟踪函数）和帧指针（用于跟踪调用栈），编译型语言开发的应用程序是比较容易跟踪的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5341"><span data-slate-object="text" data-key="5342"><span data-slate-leaf="true" data-offset-key="5342:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a9fae9d4" data-attr-id="39924" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">不过需要注意的是，大部分编译型语言遵循 &nbsp;</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5343"><span data-slate-object="text" data-key="5344"><span data-slate-leaf="true" data-offset-key="5344:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a9fae9d4" data-attr-id="39924" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">ABI（Application Binary Interface）</span></span></span></span></a><span data-slate-object="text" data-key="5345"><span data-slate-leaf="true" data-offset-key="5345:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a9fae9d4" data-attr-id="39924" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">&nbsp; 调用规范，函数的参数和返回值都存放在寄存器中。而 Go 1.17 之前使用的是 &nbsp;</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5346"><span data-slate-object="text" data-key="5347"><span data-slate-leaf="true" data-offset-key="5347:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a9fae9d4" data-attr-id="39924" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Plan 9</span></span></span></span></a><span data-slate-object="text" data-key="5348"><span data-slate-leaf="true" data-offset-key="5348:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a9fae9d4" data-attr-id="39924" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">&nbsp; 调用规范，函数的参数和返回值都存放在堆栈中；直到 1.17， Go 才从 Plan 9 切换到 ABI 调用规范。所以，在跟踪函数参数和返回值时，你需要</span></span></span></span><span data-slate-object="text" data-key="5349"><span data-slate-leaf="true" data-offset-key="5349:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a9fae9d4" data-attr-id="39924" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先区分编程语言的调用规范</span></span></span></span></span><span data-slate-object="text" data-key="5350"><span data-slate-leaf="true" data-offset-key="5350:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a9fae9d4" data-attr-id="39924" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">，然后再去寄存器或堆栈中读取函数的参数和返回值。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5351"><span data-slate-object="text" data-key="5352"><span data-slate-leaf="true" data-offset-key="5352:0" data-first-offset="true"><span data-slate-string="true">此外，</span></span></span><span data-slate-object="text" data-key="5353"><span data-slate-leaf="true" data-offset-key="5353:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">调试信息并非一定要内置于最终分发的应用程序二进制文件中，它们也可以放到独立的调试文件存储</span></span></span></span><span data-slate-object="text" data-key="5354"><span data-slate-leaf="true" data-offset-key="5354:0" data-first-offset="true"><span data-slate-string="true">。为了减少应用程序二进制文件的大小，通常会把调试信息从二进制文件中剥离出来，保存到 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5355"><span data-slate-object="text" data-key="5356"><span data-slate-leaf="true" data-offset-key="5356:0" data-first-offset="true"><span data-slate-string="true">&lt;应用名&gt;.debuginfo</span></span></span></span><span data-slate-object="text" data-key="5357"><span data-slate-leaf="true" data-offset-key="5357:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 或者 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5358"><span data-slate-object="text" data-key="5359"><span data-slate-leaf="true" data-offset-key="5359:0" data-first-offset="true"><span data-slate-string="true">&lt;build-id&gt;.debug</span></span></span></span><span data-slate-object="text" data-key="5360"><span data-slate-leaf="true" data-offset-key="5360:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 文件中，后续排查问题需要用到时再安装。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5361"><span data-slate-object="text" data-key="5362"><span data-slate-leaf="true" data-offset-key="5362:0" data-first-offset="true"><span data-slate-string="true">比如，在 RHEL 和 Ubuntu 等常见的 Linux 发行版中，调试信息跟应用程序通常是两个不同的软件包。而对很多开发者来说，每次编译和发布应用程序之前，</span></span><span data-slate-leaf="true" data-offset-key="5362:1"><span data-slate-object="annotation" data-annotation-key="gkann_ce271fa4" data-attr-id="39015" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">通常都需要执行一下 &nbsp;</span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5363"><span data-slate-object="text" data-key="5364"><span data-slate-leaf="true" data-offset-key="5364:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_ce271fa4" data-attr-id="39015" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">strip</span></span></span></span></span><span data-slate-object="text" data-key="5365"><span data-slate-leaf="true" data-offset-key="5365:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_ce271fa4" data-attr-id="39015" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">&nbsp; 命令，把调试信息删除后才发布到生产环境中。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5366"><span data-slate-object="text" data-key="5367"><span data-slate-leaf="true" data-offset-key="5367:0" data-first-offset="true"><span data-slate-string="true">这里给你个小提示：ELF 符号表包含 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5368"><span data-slate-object="text" data-key="5369"><span data-slate-leaf="true" data-offset-key="5369:0" data-first-offset="true"><span data-slate-string="true">.symtab</span></span></span></span><span data-slate-object="text" data-key="5370"><span data-slate-leaf="true" data-offset-key="5370:0" data-first-offset="true"><span data-slate-string="true">（应用本地的符号）和 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5371"><span data-slate-object="text" data-key="5372"><span data-slate-leaf="true" data-offset-key="5372:0" data-first-offset="true"><span data-slate-string="true">.dynsym</span></span></span></span><span data-slate-object="text" data-key="5373"><span data-slate-leaf="true" data-offset-key="5373:0" data-first-offset="true"><span data-slate-string="true">（调用到外部的符号），</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5374"><span data-slate-object="text" data-key="5375"><span data-slate-leaf="true" data-offset-key="5375:0" data-first-offset="true"><span data-slate-string="true">strip</span></span></span></span><span data-slate-object="text" data-key="5376"><span data-slate-leaf="true" data-offset-key="5376:0" data-first-offset="true"><span data-slate-string="true"> 命令实际上只是删除了 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5377"><span data-slate-object="text" data-key="5378"><span data-slate-leaf="true" data-offset-key="5378:0" data-first-offset="true"><span data-slate-string="true">.symtab</span></span></span></span><span data-slate-object="text" data-key="5379"><span data-slate-leaf="true" data-offset-key="5379:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 的内容。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5380"><span data-slate-object="text" data-key="5381"><span data-slate-leaf="true" data-offset-key="5381:0" data-first-offset="true"><span data-slate-string="true">接下来，我就以每个 Linux 用户都会使用的 Bash&nbsp; 为例（Bash 是一个典型的 C 语言程序），带你一起看看，如何跟踪编译型语言应用程序的执行状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5382"><span data-slate-object="text" data-key="5383"><span data-slate-leaf="true" data-offset-key="5383:0" data-first-offset="true"><span data-slate-string="true">在服务器的维护过程中，系统维护人员都需要审计每个用户登录后都执行了哪些命令，以便事后排查问题时参考。由于登录后所有命令的执行都发生在 Bash 中，那么，有没有可能使用 eBPF 来跟踪 Bash 里面到底执行过什么命令呢？答案是肯定的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5384"><span data-slate-object="text" data-key="5385"><span data-slate-leaf="true" data-offset-key="5385:0" data-first-offset="true"><span data-slate-string="true">在跟踪 Bash 之前，首先执行下面的命令，安装它的调试信息：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5386"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5387"><span data-slate-object="text" data-key="5388"><span data-slate-leaf="true" data-offset-key="5388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># Ubuntu</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5389"><span data-slate-object="text" data-key="5390"><span data-slate-leaf="true" data-offset-key="5390:0" data-first-offset="true"><span data-slate-string="true">sudo apt install bash-dbgsym</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5391"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5392"><span data-slate-object="text" data-key="5393"><span data-slate-leaf="true" data-offset-key="5393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># RHEL</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5394"><span data-slate-object="text" data-key="5395"><span data-slate-leaf="true" data-offset-key="5395:0" data-first-offset="true"><span data-slate-string="true">sudo debuginfo-install bash</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5396"><span data-slate-object="text" data-key="5397"><span data-slate-leaf="true" data-offset-key="5397:0" data-first-offset="true"><span data-slate-string="true">有了 Bash 调试信息之后，再执行下面的几步，查询 Bash 的符号表：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5398"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5399"><span data-slate-object="text" data-key="5400"><span data-slate-leaf="true" data-offset-key="5400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 第一步，查询 Build ID（用于关联调试信息）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5401"><span data-slate-object="text" data-key="5402"><span data-slate-leaf="true" data-offset-key="5402:0" data-first-offset="true"><span data-slate-string="true">readelf -n /usr/bin/bash | grep </span></span></span><span data-slate-object="text" data-key="5403"><span data-slate-leaf="true" data-offset-key="5403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'Build ID'</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5404"><span data-slate-object="text" data-key="5405"><span data-slate-leaf="true" data-offset-key="5405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 输出示例为：</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5406"><span data-slate-object="text" data-key="5407"><span data-slate-leaf="true" data-offset-key="5407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#     Build ID: 7b140b33fd79d0861f831bae38a0cdfdf639d8bc</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5408"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5409"><span data-slate-object="text" data-key="5410"><span data-slate-leaf="true" data-offset-key="5410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 第二步，找到调试信息对应的文件（调试信息位于目录 /usr/lib/debug/.build-id 中，上一步中得到的 Build ID 前两个字母为目录名）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5411"><span data-slate-object="text" data-key="5412"><span data-slate-leaf="true" data-offset-key="5412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ls</span></span></span></span><span data-slate-object="text" data-key="5413"><span data-slate-leaf="true" data-offset-key="5413:0" data-first-offset="true"><span data-slate-string="true"> /usr/lib/debug/.build-id/7b/140b33fd79d0861f831bae38a0cdfdf639d8bc.debug</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5414"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5415"><span data-slate-object="text" data-key="5416"><span data-slate-leaf="true" data-offset-key="5416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 第三步，从调试信息中查询符号表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5417"><span data-slate-object="text" data-key="5418"><span data-slate-leaf="true" data-offset-key="5418:0" data-first-offset="true"><span data-slate-string="true">readelf -Ws /usr/lib/debug/.build-id/7b/140b33fd79d0861f831bae38a0cdfdf639d8bc.debug</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5419"><span data-slate-object="text" data-key="5420"><span data-slate-leaf="true" data-offset-key="5420:0" data-first-offset="true"><span data-slate-string="true">参考 Bash 的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5421"><span data-slate-object="text" data-key="5422"><span data-slate-leaf="true" data-offset-key="5422:0" data-first-offset="true"><span data-slate-string="true">源代码</span></span></span></a><span data-slate-object="text" data-key="5423"><span data-slate-leaf="true" data-offset-key="5423:0" data-first-offset="true"><span data-slate-string="true">，每条 Bash 命令在运行前，都会调用 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5424"><span data-slate-object="text" data-key="5425"><span data-slate-leaf="true" data-offset-key="5425:0" data-first-offset="true"><span data-slate-string="true">char</span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5426"><span data-slate-object="text" data-key="5427"><span data-slate-leaf="true" data-offset-key="5427:0" data-first-offset="true"><span data-slate-type="italic" data-slate-object="mark"><span data-slate-string="true">readline (const char</span></span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5428"><span data-slate-object="text" data-key="5429"><span data-slate-leaf="true" data-offset-key="5429:0" data-first-offset="true"><span data-slate-string="true">prompt)</span></span></span></span><span data-slate-object="text" data-key="5430"><span data-slate-leaf="true" data-offset-key="5430:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 函数读取用户的输入，然后再去解析执行（Bash 自身是使用编译型语言 C 开发的，而 Bash 语言则是一种解释型语言）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5431"><span data-slate-object="text" data-key="5432"><span data-slate-leaf="true" data-offset-key="5432:0" data-first-offset="true"><span data-slate-string="true">注意，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5433"><span data-slate-object="text" data-key="5434"><span data-slate-leaf="true" data-offset-key="5434:0" data-first-offset="true"><span data-slate-string="true">readline</span></span></span></span><span data-slate-object="text" data-key="5435"><span data-slate-leaf="true" data-offset-key="5435:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 函数的参数是命令行提示符（通过环境变量 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5436"><span data-slate-object="text" data-key="5437"><span data-slate-leaf="true" data-offset-key="5437:0" data-first-offset="true"><span data-slate-string="true">PS1</span></span></span></span><span data-slate-object="text" data-key="5438"><span data-slate-leaf="true" data-offset-key="5438:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5439"><span data-slate-object="text" data-key="5440"><span data-slate-leaf="true" data-offset-key="5440:0" data-first-offset="true"><span data-slate-string="true">PS2</span></span></span></span><span data-slate-object="text" data-key="5441"><span data-slate-leaf="true" data-offset-key="5441:0" data-first-offset="true"><span data-slate-string="true"> 等设置），而返回值才是用户的输入。因而，我们只需要跟踪 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5442"><span data-slate-object="text" data-key="5443"><span data-slate-leaf="true" data-offset-key="5443:0" data-first-offset="true"><span data-slate-string="true">readline</span></span></span></span><span data-slate-object="text" data-key="5444"><span data-slate-leaf="true" data-offset-key="5444:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 函数的返回值，也就是使用 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5445"><span data-slate-object="text" data-key="5446"><span data-slate-leaf="true" data-offset-key="5446:0" data-first-offset="true"><span data-slate-string="true">uretprobe</span></span></span></span><span data-slate-object="text" data-key="5447"><span data-slate-leaf="true" data-offset-key="5447:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 跟踪。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5448"><span data-slate-object="text" data-key="5449"><span data-slate-leaf="true" data-offset-key="5449:0" data-first-offset="true"><span data-slate-string="true">bpftrace、BCC 以及 libbpf 等工具均支持 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5450"><span data-slate-object="text" data-key="5451"><span data-slate-leaf="true" data-offset-key="5451:0" data-first-offset="true"><span data-slate-string="true">uretprobe</span></span></span></span><span data-slate-object="text" data-key="5452"><span data-slate-leaf="true" data-offset-key="5452:0" data-first-offset="true"><span data-slate-string="true">，因而最简单的跟踪方法就是使用 bpftrace 的单行命令：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5453"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5454"><span data-slate-object="text" data-key="5455"><span data-slate-leaf="true" data-offset-key="5455:0" data-first-offset="true"><span data-slate-string="true">sudo bpftrace -e </span></span></span><span data-slate-object="text" data-key="5456"><span data-slate-leaf="true" data-offset-key="5456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'uretprobe:/usr/bin/bash:readline {printf("User %d executed \"%s\" command\n", uid, str(retval)); }'</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5457"><span data-slate-object="text" data-key="5458"><span data-slate-leaf="true" data-offset-key="5458:0" data-first-offset="true"><span data-slate-string="true">这个命令中具体内容的作用如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5459"><div data-slate-type="list-line" data-slate-object="block" data-key="5460"><span data-slate-type="code" data-slate-object="inline" data-key="5461"><span data-slate-object="text" data-key="5462"><span data-slate-leaf="true" data-offset-key="5462:0" data-first-offset="true"><span data-slate-string="true">uretprobe:/usr/bin/bash:readline</span></span></span></span><span data-slate-object="text" data-key="5463"><span data-slate-leaf="true" data-offset-key="5463:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 设置跟踪类型为 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5464"><span data-slate-object="text" data-key="5465"><span data-slate-leaf="true" data-offset-key="5465:0" data-first-offset="true"><span data-slate-string="true">uretprobe</span></span></span></span><span data-slate-object="text" data-key="5466"><span data-slate-leaf="true" data-offset-key="5466:0" data-first-offset="true"><span data-slate-string="true">，跟踪的二进制文件为 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5467"><span data-slate-object="text" data-key="5468"><span data-slate-leaf="true" data-offset-key="5468:0" data-first-offset="true"><span data-slate-string="true">/usr/bin/bash</span></span></span></span><span data-slate-object="text" data-key="5469"><span data-slate-leaf="true" data-offset-key="5469:0" data-first-offset="true"><span data-slate-string="true">，跟踪符号为 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5470"><span data-slate-object="text" data-key="5471"><span data-slate-leaf="true" data-offset-key="5471:0" data-first-offset="true"><span data-slate-string="true">readline</span></span></span></span><span data-slate-object="text" data-key="5472"><span data-slate-leaf="true" data-offset-key="5472:0" data-first-offset="true"><span data-slate-string="true">；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5473"><span data-slate-object="text" data-key="5474"><span data-slate-leaf="true" data-offset-key="5474:0" data-first-offset="true"><span data-slate-string="true">中括号里的内容为 uretprobe 的处理函数；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5475"><span data-slate-object="text" data-key="5476"><span data-slate-leaf="true" data-offset-key="5476:0" data-first-offset="true"><span data-slate-string="true">处理函数中，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5477"><span data-slate-object="text" data-key="5478"><span data-slate-leaf="true" data-offset-key="5478:0" data-first-offset="true"><span data-slate-string="true">uid</span></span></span></span><span data-slate-object="text" data-key="5479"><span data-slate-leaf="true" data-offset-key="5479:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 和 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5480"><span data-slate-object="text" data-key="5481"><span data-slate-leaf="true" data-offset-key="5481:0" data-first-offset="true"><span data-slate-string="true">retval</span></span></span></span><span data-slate-object="text" data-key="5482"><span data-slate-leaf="true" data-offset-key="5482:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 是两个内置变量，分别表示用户 UID 以及返回值；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5483"><span data-slate-type="code" data-slate-object="inline" data-key="5484"><span data-slate-object="text" data-key="5485"><span data-slate-leaf="true" data-offset-key="5485:0" data-first-offset="true"><span data-slate-string="true">str</span></span></span></span><span data-slate-object="text" data-key="5486"><span data-slate-leaf="true" data-offset-key="5486:0" data-first-offset="true"><span data-slate-string="true"> 用于从指针中读取字符串， </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5487"><span data-slate-object="text" data-key="5488"><span data-slate-leaf="true" data-offset-key="5488:0" data-first-offset="true"><span data-slate-string="true">str(retval)</span></span></span></span><span data-slate-object="text" data-key="5489"><span data-slate-leaf="true" data-offset-key="5489:0" data-first-offset="true"><span data-slate-string="true"> 就是 Bash 中输入命令的字符串；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5490"><span data-slate-type="code" data-slate-object="inline" data-key="5491"><span data-slate-object="text" data-key="5492"><span data-slate-leaf="true" data-offset-key="5492:0" data-first-offset="true"><span data-slate-string="true">printf</span></span></span></span><span data-slate-object="text" data-key="5493"><span data-slate-leaf="true" data-offset-key="5493:0" data-first-offset="true"><span data-slate-string="true"> 用于向终端中打印一个字符串。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5494"><span data-slate-object="text" data-key="5495"><span data-slate-leaf="true" data-offset-key="5495:0" data-first-offset="true"><span data-slate-string="true">打开一个终端，并在新终端中执行 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5496"><span data-slate-object="text" data-key="5497"><span data-slate-leaf="true" data-offset-key="5497:0" data-first-offset="true"><span data-slate-string="true">ps</span></span></span></span><span data-slate-object="text" data-key="5498"><span data-slate-leaf="true" data-offset-key="5498:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 命令，然后就会在第一个终端中看到如下的输出（即 UID 为 1000 的用户执行了 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5499"><span data-slate-object="text" data-key="5500"><span data-slate-leaf="true" data-offset-key="5500:0" data-first-offset="true"><span data-slate-string="true">ps</span></span></span></span><span data-slate-object="text" data-key="5501"><span data-slate-leaf="true" data-offset-key="5501:0" data-first-offset="true"><span data-slate-string="true"> 命令）：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="5502"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5503"><span data-slate-object="text" data-key="5504"><span data-slate-leaf="true" data-offset-key="5504:0" data-first-offset="true"><span data-slate-string="true">Attaching </span></span></span><span data-slate-object="text" data-key="5505"><span data-slate-leaf="true" data-offset-key="5505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="5506"><span data-slate-leaf="true" data-offset-key="5506:0" data-first-offset="true"><span data-slate-string="true"> probe...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5507"><span data-slate-object="text" data-key="5508"><span data-slate-leaf="true" data-offset-key="5508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">User</span></span></span></span><span data-slate-object="text" data-key="5509"><span data-slate-leaf="true" data-offset-key="5509:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5510"><span data-slate-leaf="true" data-offset-key="5510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000</span></span></span></span><span data-slate-object="text" data-key="5511"><span data-slate-leaf="true" data-offset-key="5511:0" data-first-offset="true"><span data-slate-string="true"> executed "ps" command</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5512"><span data-slate-object="text" data-key="5513"><span data-slate-leaf="true" data-offset-key="5513:0" data-first-offset="true"><span data-slate-string="true">和上一讲的案例类似，这里我们也可以使用 BCC 和 libbpf 实现相同的跟踪程序。由于它们的实现逻辑是类似的，并且 BCC 提供了对初学者更友好的接口，所以接下来，我就以 BCC 为例，带你一起看看如何来跟踪用户空间的 Bash。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5514"><span data-slate-object="text" data-key="5515"><span data-slate-leaf="true" data-offset-key="5515:0" data-first-offset="true"><span data-slate-string="true">还记得用 BCC 来开发一个 eBPF 跟踪程序的具体步骤吗？如果你不记得，也没关系，我来带你简单回顾一下。BCC 的使用可以分为两部分：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5516"><div data-slate-type="list-line" data-slate-object="block" data-key="5517"><span data-slate-object="text" data-key="5518"><span data-slate-leaf="true" data-offset-key="5518:0" data-first-offset="true"><span data-slate-string="true">第一部分是用 C 语言开发的 eBPF 程序。在 eBPF 程序中，你可以利用 BCC 提供的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5519"><span data-slate-object="text" data-key="5520"><span data-slate-leaf="true" data-offset-key="5520:0" data-first-offset="true"><span data-slate-string="true">库函数和宏定义</span></span></span></a><span data-slate-object="text" data-key="5521"><span data-slate-leaf="true" data-offset-key="5521:0" data-first-offset="true"><span data-slate-string="true">简化你的处理逻辑。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5522"><span data-slate-object="text" data-key="5523"><span data-slate-leaf="true" data-offset-key="5523:0" data-first-offset="true"><span data-slate-string="true">第二部分是用 Python 语言开发的前端界面，其中包含 eBPF 程序加载、挂载到内核函数和跟踪点，以及通过 BPF 映射获取和打印执行结果等部分。在前端程序中，你同样可以利用 BCC 库来访问 BPF 映射。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5524"><span data-slate-object="text" data-key="5525"><span data-slate-leaf="true" data-offset-key="5525:0" data-first-offset="true"><span data-slate-string="true">对于第一部分来说，我们要做的就是从 uretprobe 的处理函数中获取 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5526"><span data-slate-object="text" data-key="5527"><span data-slate-leaf="true" data-offset-key="5527:0" data-first-offset="true"><span data-slate-string="true">readline</span></span></span></span><span data-slate-object="text" data-key="5528"><span data-slate-leaf="true" data-offset-key="5528:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 的返回值，然后提交到性能事件映射中。这里你可能想问：如何获取返回值呢？是不是已经有库函数可以直接拿过来用呢？对此，特别提醒你一点：</span></span></span><span data-slate-object="text" data-key="5529"><span data-slate-leaf="true" data-offset-key="5529:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">当碰到不懂的问题，特别是不清楚接口调用的具体格式时，不要去互联网搜索，而是应该查询官方文档（或者源代码）</span></span></span></span><span data-slate-object="text" data-key="5530"><span data-slate-leaf="true" data-offset-key="5530:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">来</span></span></span></span><span data-slate-object="text" data-key="5531"><span data-slate-leaf="true" data-offset-key="5531:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">确认。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5532"><span data-slate-object="text" data-key="5533"><span data-slate-leaf="true" data-offset-key="5533:0" data-first-offset="true"><span data-slate-string="true">对于 BCC 的 uretprobe 来说，其官方文档链接就是 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5534"><span data-slate-object="text" data-key="5535"><span data-slate-leaf="true" data-offset-key="5535:0" data-first-offset="true"><span data-slate-string="true">uretprobes</span></span></span></a><span data-slate-object="text" data-key="5536"><span data-slate-leaf="true" data-offset-key="5536:0" data-first-offset="true"><span data-slate-string="true">。根据这里的文档，uretprobe 处理函数的定义格式应该为 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5537"><span data-slate-object="text" data-key="5538"><span data-slate-leaf="true" data-offset-key="5538:0" data-first-offset="true"><span data-slate-string="true">function_name(struct pt_regs *ctx)</span></span></span></span><span data-slate-object="text" data-key="5539"><span data-slate-leaf="true" data-offset-key="5539:0" data-first-offset="true"><span data-slate-string="true">，而返回值可以通过宏 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5540"><span data-slate-object="text" data-key="5541"><span data-slate-leaf="true" data-offset-key="5541:0" data-first-offset="true"><span data-slate-string="true">PT_REGS_RC(ctx)</span></span></span></span><span data-slate-object="text" data-key="5542"><span data-slate-leaf="true" data-offset-key="5542:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 来获取（实际上，kretprobe 也是采用相同的格式）。有了这些文档，就可以按照这里的函数格式来完成第一部分的开发了。代码如下所示，每一步我都加了详细的注释：</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="5543"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5544"><span data-slate-object="text" data-key="5545"><span data-slate-leaf="true" data-offset-key="5545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 包含头文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5546"><span data-slate-object="text" data-key="5547"><span data-slate-leaf="true" data-offset-key="5547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5548"><span data-slate-leaf="true" data-offset-key="5548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="5549"><span data-slate-leaf="true" data-offset-key="5549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5550"><span data-slate-leaf="true" data-offset-key="5550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;uapi/linux/ptrace.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5551"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5552"><span data-slate-object="text" data-key="5553"><span data-slate-leaf="true" data-offset-key="5553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定义数据结构和性能事件映射</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5554"><span data-slate-object="text" data-key="5555"><span data-slate-leaf="true" data-offset-key="5555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5556"><span data-slate-leaf="true" data-offset-key="5556:0" data-first-offset="true"><span data-slate-string="true"> data_t {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5557"><span data-slate-object="text" data-key="5558"><span data-slate-leaf="true" data-offset-key="5558:0" data-first-offset="true"><span data-slate-string="true">    u32 uid;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5559"><span data-slate-object="text" data-key="5560"><span data-slate-leaf="true" data-offset-key="5560:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5561"><span data-slate-leaf="true" data-offset-key="5561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="5562"><span data-slate-leaf="true" data-offset-key="5562:0" data-first-offset="true"><span data-slate-string="true"> command[</span></span></span><span data-slate-object="text" data-key="5563"><span data-slate-leaf="true" data-offset-key="5563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="5564"><span data-slate-leaf="true" data-offset-key="5564:0" data-first-offset="true"><span data-slate-string="true">];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5565"><span data-slate-object="text" data-key="5566"><span data-slate-leaf="true" data-offset-key="5566:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5567"><span data-slate-object="text" data-key="5568"><span data-slate-leaf="true" data-offset-key="5568:0" data-first-offset="true"><span data-slate-string="true">BPF_PERF_OUTPUT(events);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5569"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5570"><span data-slate-object="text" data-key="5571"><span data-slate-leaf="true" data-offset-key="5571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定义 uretprobe 处理函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5572"><span data-slate-object="text" data-key="5573"><span data-slate-leaf="true" data-offset-key="5573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5574"><span data-slate-leaf="true" data-offset-key="5574:0" data-first-offset="true"><span data-slate-string="true"> bash_readline(</span></span></span><span data-slate-object="text" data-key="5575"><span data-slate-leaf="true" data-offset-key="5575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5576"><span data-slate-leaf="true" data-offset-key="5576:0" data-first-offset="true"><span data-slate-string="true"> pt_regs *ctx)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5577"><span data-slate-object="text" data-key="5578"><span data-slate-leaf="true" data-offset-key="5578:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5579"><span data-slate-object="text" data-key="5580"><span data-slate-leaf="true" data-offset-key="5580:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5581"><span data-slate-leaf="true" data-offset-key="5581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 查询 uid</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5582"><span data-slate-object="text" data-key="5583"><span data-slate-leaf="true" data-offset-key="5583:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5584"><span data-slate-leaf="true" data-offset-key="5584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5585"><span data-slate-leaf="true" data-offset-key="5585:0" data-first-offset="true"><span data-slate-string="true"> data_t data = { };</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5586"><span data-slate-object="text" data-key="5587"><span data-slate-leaf="true" data-offset-key="5587:0" data-first-offset="true"><span data-slate-string="true">    data.uid = bpf_get_current_uid_gid();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5588"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5589"><span data-slate-object="text" data-key="5590"><span data-slate-leaf="true" data-offset-key="5590:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5591"><span data-slate-leaf="true" data-offset-key="5591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从 PT_REGS_RC (ctx) 读取返回值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5592"><span data-slate-object="text" data-key="5593"><span data-slate-leaf="true" data-offset-key="5593:0" data-first-offset="true"><span data-slate-string="true">    bpf_probe_read_user(&amp;data.command, </span></span></span><span data-slate-object="text" data-key="5594"><span data-slate-leaf="true" data-offset-key="5594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="5595"><span data-slate-leaf="true" data-offset-key="5595:0" data-first-offset="true"><span data-slate-string="true">(data.command), (</span></span></span><span data-slate-object="text" data-key="5596"><span data-slate-leaf="true" data-offset-key="5596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="5597"><span data-slate-leaf="true" data-offset-key="5597:0" data-first-offset="true"><span data-slate-string="true"> *)PT_REGS_RC(ctx));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5598"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5599"><span data-slate-object="text" data-key="5600"><span data-slate-leaf="true" data-offset-key="5600:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5601"><span data-slate-leaf="true" data-offset-key="5601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 提交性能事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5602"><span data-slate-object="text" data-key="5603"><span data-slate-leaf="true" data-offset-key="5603:0" data-first-offset="true"><span data-slate-string="true">    events.perf_submit(ctx, &amp;data, </span></span></span><span data-slate-object="text" data-key="5604"><span data-slate-leaf="true" data-offset-key="5604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="5605"><span data-slate-leaf="true" data-offset-key="5605:0" data-first-offset="true"><span data-slate-string="true">(data));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5606"><span data-slate-object="text" data-key="5607"><span data-slate-leaf="true" data-offset-key="5607:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5608"><span data-slate-leaf="true" data-offset-key="5608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5609"><span data-slate-leaf="true" data-offset-key="5609:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5610"><span data-slate-leaf="true" data-offset-key="5610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5611"><span data-slate-leaf="true" data-offset-key="5611:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5612"><span data-slate-object="text" data-key="5613"><span data-slate-leaf="true" data-offset-key="5613:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5614"><span data-slate-object="text" data-key="5615"><span data-slate-leaf="true" data-offset-key="5615:0" data-first-offset="true"><span data-slate-string="true">从代码中你可以看到，eBPF 程序的结构跟上一讲基本类似，唯一需要注意的是函数的定义格式以及返回值的读取位置。将上述代码保存到 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5616"><span data-slate-object="text" data-key="5617"><span data-slate-leaf="true" data-offset-key="5617:0" data-first-offset="true"><span data-slate-string="true">bashreadline.c</span></span></span></span><span data-slate-object="text" data-key="5618"><span data-slate-leaf="true" data-offset-key="5618:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 文件中，我们就完成了第一部分的开发。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5619"><span data-slate-object="text" data-key="5620"><span data-slate-leaf="true" data-offset-key="5620:0" data-first-offset="true"><span data-slate-string="true">有了 eBPF 程序之后，第二部分的 Python 前端也比较直观，代码如下所示：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="5621"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5622"><span data-slate-object="text" data-key="5623"><span data-slate-leaf="true" data-offset-key="5623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 引入 BCC 库</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5624"><span data-slate-object="text" data-key="5625"><span data-slate-leaf="true" data-offset-key="5625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="5626"><span data-slate-leaf="true" data-offset-key="5626:0" data-first-offset="true"><span data-slate-string="true"> bcc </span></span></span><span data-slate-object="text" data-key="5627"><span data-slate-leaf="true" data-offset-key="5627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="5628"><span data-slate-leaf="true" data-offset-key="5628:0" data-first-offset="true"><span data-slate-string="true"> BPF</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5629"><span data-slate-object="text" data-key="5630"><span data-slate-leaf="true" data-offset-key="5630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="5631"><span data-slate-leaf="true" data-offset-key="5631:0" data-first-offset="true"><span data-slate-string="true"> time </span></span></span><span data-slate-object="text" data-key="5632"><span data-slate-leaf="true" data-offset-key="5632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="5633"><span data-slate-leaf="true" data-offset-key="5633:0" data-first-offset="true"><span data-slate-string="true"> strftime</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5634"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5635"><span data-slate-object="text" data-key="5636"><span data-slate-leaf="true" data-offset-key="5636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 加载 eBPF 程序</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5637"><span data-slate-object="text" data-key="5638"><span data-slate-leaf="true" data-offset-key="5638:0" data-first-offset="true"><span data-slate-string="true">b = BPF(src_file=</span></span></span><span data-slate-object="text" data-key="5639"><span data-slate-leaf="true" data-offset-key="5639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"bashreadline.c"</span></span></span></span><span data-slate-object="text" data-key="5640"><span data-slate-leaf="true" data-offset-key="5640:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5641"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5642"><span data-slate-object="text" data-key="5643"><span data-slate-leaf="true" data-offset-key="5643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 挂载 uretprobe</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5644"><span data-slate-object="text" data-key="5645"><span data-slate-leaf="true" data-offset-key="5645:0" data-first-offset="true"><span data-slate-string="true">b.attach_uretprobe(name=</span></span></span><span data-slate-object="text" data-key="5646"><span data-slate-leaf="true" data-offset-key="5646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/usr/bin/bash"</span></span></span></span><span data-slate-object="text" data-key="5647"><span data-slate-leaf="true" data-offset-key="5647:0" data-first-offset="true"><span data-slate-string="true">, sym=</span></span></span><span data-slate-object="text" data-key="5648"><span data-slate-leaf="true" data-offset-key="5648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"readline"</span></span></span></span><span data-slate-object="text" data-key="5649"><span data-slate-leaf="true" data-offset-key="5649:0" data-first-offset="true"><span data-slate-string="true">, fn_name=</span></span></span><span data-slate-object="text" data-key="5650"><span data-slate-leaf="true" data-offset-key="5650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"bash_readline"</span></span></span></span><span data-slate-object="text" data-key="5651"><span data-slate-leaf="true" data-offset-key="5651:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5652"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5653"><span data-slate-object="text" data-key="5654"><span data-slate-leaf="true" data-offset-key="5654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 定义性能事件回调（输出时间、UID 以及 Bash 中执行的命令）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5655"><span data-slate-object="text" data-key="5656"><span data-slate-leaf="true" data-offset-key="5656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def</span></span></span></span><span data-slate-object="text" data-key="5657"><span data-slate-leaf="true" data-offset-key="5657:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5658"><span data-slate-leaf="true" data-offset-key="5658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">print_event</span></span></span></span><span data-slate-object="text" data-key="5659"><span data-slate-leaf="true" data-offset-key="5659:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="5660"><span data-slate-leaf="true" data-offset-key="5660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cpu, data, size</span></span></span></span><span data-slate-object="text" data-key="5661"><span data-slate-leaf="true" data-offset-key="5661:0" data-first-offset="true"><span data-slate-string="true">):</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5662"><span data-slate-object="text" data-key="5663"><span data-slate-leaf="true" data-offset-key="5663:0" data-first-offset="true"><span data-slate-string="true">    event = b[</span></span></span><span data-slate-object="text" data-key="5664"><span data-slate-leaf="true" data-offset-key="5664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"events"</span></span></span></span><span data-slate-object="text" data-key="5665"><span data-slate-leaf="true" data-offset-key="5665:0" data-first-offset="true"><span data-slate-string="true">].event(data)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5666"><span data-slate-object="text" data-key="5667"><span data-slate-leaf="true" data-offset-key="5667:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5668"><span data-slate-leaf="true" data-offset-key="5668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">print</span></span></span></span><span data-slate-object="text" data-key="5669"><span data-slate-leaf="true" data-offset-key="5669:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="5670"><span data-slate-leaf="true" data-offset-key="5670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"%-9s %-6d %s"</span></span></span></span><span data-slate-object="text" data-key="5671"><span data-slate-leaf="true" data-offset-key="5671:0" data-first-offset="true"><span data-slate-string="true"> % (strftime(</span></span></span><span data-slate-object="text" data-key="5672"><span data-slate-leaf="true" data-offset-key="5672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"%H:%M:%S"</span></span></span></span><span data-slate-object="text" data-key="5673"><span data-slate-leaf="true" data-offset-key="5673:0" data-first-offset="true"><span data-slate-string="true">), event.uid, event.command.decode(</span></span></span><span data-slate-object="text" data-key="5674"><span data-slate-leaf="true" data-offset-key="5674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"utf-8"</span></span></span></span><span data-slate-object="text" data-key="5675"><span data-slate-leaf="true" data-offset-key="5675:0" data-first-offset="true"><span data-slate-string="true">)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5676"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5677"><span data-slate-object="text" data-key="5678"><span data-slate-leaf="true" data-offset-key="5678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 打印头</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5679"><span data-slate-object="text" data-key="5680"><span data-slate-leaf="true" data-offset-key="5680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">print</span></span></span></span><span data-slate-object="text" data-key="5681"><span data-slate-leaf="true" data-offset-key="5681:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="5682"><span data-slate-leaf="true" data-offset-key="5682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"%-9s %-6s %s"</span></span></span></span><span data-slate-object="text" data-key="5683"><span data-slate-leaf="true" data-offset-key="5683:0" data-first-offset="true"><span data-slate-string="true"> % (</span></span></span><span data-slate-object="text" data-key="5684"><span data-slate-leaf="true" data-offset-key="5684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"TIME"</span></span></span></span><span data-slate-object="text" data-key="5685"><span data-slate-leaf="true" data-offset-key="5685:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="5686"><span data-slate-leaf="true" data-offset-key="5686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"UID"</span></span></span></span><span data-slate-object="text" data-key="5687"><span data-slate-leaf="true" data-offset-key="5687:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="5688"><span data-slate-leaf="true" data-offset-key="5688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"COMMAND"</span></span></span></span><span data-slate-object="text" data-key="5689"><span data-slate-leaf="true" data-offset-key="5689:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5690"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5691"><span data-slate-object="text" data-key="5692"><span data-slate-leaf="true" data-offset-key="5692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 绑定性能事件映射和输出函数，并从映射中循环读取数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5693"><span data-slate-object="text" data-key="5694"><span data-slate-leaf="true" data-offset-key="5694:0" data-first-offset="true"><span data-slate-string="true">b[</span></span></span><span data-slate-object="text" data-key="5695"><span data-slate-leaf="true" data-offset-key="5695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"events"</span></span></span></span><span data-slate-object="text" data-key="5696"><span data-slate-leaf="true" data-offset-key="5696:0" data-first-offset="true"><span data-slate-string="true">].open_perf_buffer(print_event)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5697"><span data-slate-object="text" data-key="5698"><span data-slate-leaf="true" data-offset-key="5698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="5699"><span data-slate-leaf="true" data-offset-key="5699:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5700"><span data-slate-leaf="true" data-offset-key="5700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="5701"><span data-slate-leaf="true" data-offset-key="5701:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5702"><span data-slate-object="text" data-key="5703"><span data-slate-leaf="true" data-offset-key="5703:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5704"><span data-slate-leaf="true" data-offset-key="5704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="5705"><span data-slate-leaf="true" data-offset-key="5705:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5706"><span data-slate-object="text" data-key="5707"><span data-slate-leaf="true" data-offset-key="5707:0" data-first-offset="true"><span data-slate-string="true">        b.perf_buffer_poll()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5708"><span data-slate-object="text" data-key="5709"><span data-slate-leaf="true" data-offset-key="5709:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5710"><span data-slate-leaf="true" data-offset-key="5710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">except</span></span></span></span><span data-slate-object="text" data-key="5711"><span data-slate-leaf="true" data-offset-key="5711:0" data-first-offset="true"><span data-slate-string="true"> KeyboardInterrupt:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5712"><span data-slate-object="text" data-key="5713"><span data-slate-leaf="true" data-offset-key="5713:0" data-first-offset="true"><span data-slate-string="true">        exit()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5714"><span data-slate-object="text" data-key="5715"><span data-slate-leaf="true" data-offset-key="5715:0" data-first-offset="true"><span data-slate-string="true">可以看到，这部分的代码跟上一讲案例的结构也是类似的。主要的不同点在于，挂载 uretprobe 的时候调用了 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5716"><span data-slate-object="text" data-key="5717"><span data-slate-leaf="true" data-offset-key="5717:0" data-first-offset="true"><span data-slate-string="true">b.attach_uretprobe()</span></span></span></span><span data-slate-object="text" data-key="5718"><span data-slate-leaf="true" data-offset-key="5718:0" data-first-offset="true"><span data-slate-string="true">&nbsp;，并在其参数中传入了二进制文件的路径 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5719"><span data-slate-object="text" data-key="5720"><span data-slate-leaf="true" data-offset-key="5720:0" data-first-offset="true"><span data-slate-string="true">name="/usr/bin/bash"</span></span></span></span><span data-slate-object="text" data-key="5721"><span data-slate-leaf="true" data-offset-key="5721:0" data-first-offset="true"><span data-slate-string="true">&nbsp;，以及要跟踪的符号 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5722"><span data-slate-object="text" data-key="5723"><span data-slate-leaf="true" data-offset-key="5723:0" data-first-offset="true"><span data-slate-string="true">sym="readline"</span></span></span></span><span data-slate-object="text" data-key="5724"><span data-slate-leaf="true" data-offset-key="5724:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5725"><span data-slate-object="text" data-key="5726"><span data-slate-leaf="true" data-offset-key="5726:0" data-first-offset="true"><span data-slate-string="true">在 BCC 的内部，当你挂载 uprobe 或者 uretprobe 到用户程序时，由于同一个符号可能出现多次，BCC 会首先查询该符号的所有地址，然后把 eBPF 程序挂载到所有不同的地址上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5727"><span data-slate-object="text" data-key="5728"><span data-slate-leaf="true" data-offset-key="5728:0" data-first-offset="true"><span data-slate-string="true">如果你没有使用 BCC 等库，你就需要自己来实现类似的逻辑。而要实现它，还需要详细了解 ELF 文件格式，以及对应库函数的使用方法，这个难度就要大很多了。这也是我推荐你使用 BCC、libbpf 等库进行 eBPF 程序开发的原因。这些库已经帮你把很多繁杂且跟 eBPF 事件处理主要逻辑无关的部分实现好了，你只需要调用它们实现你最核心的 eBPF 处理逻辑即可。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5729"><span data-slate-object="text" data-key="5730"><span data-slate-leaf="true" data-offset-key="5730:0" data-first-offset="true"><span data-slate-string="true">将上述代码保存到 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5731"><span data-slate-object="text" data-key="5732"><span data-slate-leaf="true" data-offset-key="5732:0" data-first-offset="true"><span data-slate-string="true">bashreadline.py</span></span></span></span><span data-slate-object="text" data-key="5733"><span data-slate-leaf="true" data-offset-key="5733:0" data-first-offset="true"><span data-slate-string="true">&nbsp;，然后执行 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5734"><span data-slate-object="text" data-key="5735"><span data-slate-leaf="true" data-offset-key="5735:0" data-first-offset="true"><span data-slate-string="true">sudo python3 bashreadline.py</span></span></span></span><span data-slate-object="text" data-key="5736"><span data-slate-leaf="true" data-offset-key="5736:0" data-first-offset="true"><span data-slate-string="true">&nbsp;，我们就可以运行这个跟踪程序。打开一个新终端并运行 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5737"><span data-slate-object="text" data-key="5738"><span data-slate-leaf="true" data-offset-key="5738:0" data-first-offset="true"><span data-slate-string="true">ls</span></span></span></span><span data-slate-object="text" data-key="5739"><span data-slate-leaf="true" data-offset-key="5739:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 命令，回到第一个终端，你就可以看到如下的输出：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="5740"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5741"><span data-slate-object="text" data-key="5742"><span data-slate-leaf="true" data-offset-key="5742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TIME</span></span></span></span><span data-slate-object="text" data-key="5743"><span data-slate-leaf="true" data-offset-key="5743:0" data-first-offset="true"><span data-slate-string="true">      UID    COMMAND</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5744"><span data-slate-object="text" data-key="5745"><span data-slate-leaf="true" data-offset-key="5745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">07</span></span></span></span><span data-slate-object="text" data-key="5746"><span data-slate-leaf="true" data-offset-key="5746:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="5747"><span data-slate-leaf="true" data-offset-key="5747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">17</span></span></span></span><span data-slate-object="text" data-key="5748"><span data-slate-leaf="true" data-offset-key="5748:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="5749"><span data-slate-leaf="true" data-offset-key="5749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">07</span></span></span></span><span data-slate-object="text" data-key="5750"><span data-slate-leaf="true" data-offset-key="5750:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5751"><span data-slate-leaf="true" data-offset-key="5751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000</span></span></span></span><span data-slate-object="text" data-key="5752"><span data-slate-leaf="true" data-offset-key="5752:0" data-first-offset="true"><span data-slate-string="true">   ls</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5753"><span data-slate-object="text" data-key="5754"><span data-slate-leaf="true" data-offset-key="5754:0" data-first-offset="true"><span data-slate-string="true">从这里的例子中，你可以发现：编译型语言应用程序的跟踪与内核的跟踪是类似的，只不过是把跟踪类型从 kprobe 换成了 uprobe 或者 USDT（USDT 的例子我会在接下来的内容中讲到）。不同的地方在于符号信息：应用程序的符号信息可以存放在 ELF 二进制文件中，也可以以单独文件的形式，放到调试文件中；而内核的符号信息除了可以存放到内核二进制文件中之外，还会以 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5755"><span data-slate-object="text" data-key="5756"><span data-slate-leaf="true" data-offset-key="5756:0" data-first-offset="true"><span data-slate-string="true">/proc/kallsyms</span></span></span></span><span data-slate-object="text" data-key="5757"><span data-slate-leaf="true" data-offset-key="5757:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 和 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5758"><span data-slate-object="text" data-key="5759"><span data-slate-leaf="true" data-offset-key="5759:0" data-first-offset="true"><span data-slate-string="true">/sys/kernel/debug</span></span></span></span><span data-slate-object="text" data-key="5760"><span data-slate-leaf="true" data-offset-key="5760:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 等形式暴露到用户空间。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5761" id="sr-toc-4"><span data-slate-object="text" data-key="5762"><span data-slate-leaf="true" data-offset-key="5762:0" data-first-offset="true"><span data-slate-string="true">跟踪解释型语言应用程序</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5763"><span data-slate-object="text" data-key="5764"><span data-slate-leaf="true" data-offset-key="5764:0" data-first-offset="true"><span data-slate-string="true">了解了编译型语言应用程序的跟踪方法之后，接下来，我们再来看看解释型语言应用程序又该如何跟踪。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5765"><span data-slate-object="text" data-key="5766"><span data-slate-leaf="true" data-offset-key="5766:0" data-first-offset="true"><span data-slate-string="true">上面我已经提到，你无法从解释型语言的二进制文件中直接获取应用程序的调试信息，而只能获得解释器本身的符号信息。所以，对于这类语言开发的应用程序，通常需要跟踪解释器内的函数，再从其参数中获取应用程序的运行细节。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5767"><span data-slate-object="text" data-key="5768"><span data-slate-leaf="true" data-offset-key="5768:0" data-first-offset="true"><span data-slate-string="true">对于各种解释型编程语言的二进制文件（如 Python、PHP 等），你可以使用类似编译型语言应用程序的跟踪点查询方法，查询它们在解释器层面的 uprobe 和 USDT 跟踪点。比如，对于 Python3 来说，你可以执行下面的命令查询：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5769"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5770"><span data-slate-object="text" data-key="5771"><span data-slate-leaf="true" data-offset-key="5771:0" data-first-offset="true"><span data-slate-string="true">sudo bpftrace -l </span></span></span><span data-slate-object="text" data-key="5772"><span data-slate-leaf="true" data-offset-key="5772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'*:/usr/bin/python3:*'</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5773"><span data-slate-object="text" data-key="5774"><span data-slate-leaf="true" data-offset-key="5774:0" data-first-offset="true"><span data-slate-string="true">命令执行后，你会得到 1500 多个跟踪点。接下来的难点在于，</span></span></span><span data-slate-object="text" data-key="5775"><span data-slate-leaf="true" data-offset-key="5775:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如何从这些解释器的跟踪点中找出应用程序的函数信息</span></span></span></span><span data-slate-object="text" data-key="5776"><span data-slate-leaf="true" data-offset-key="5776:0" data-first-offset="true"><span data-slate-string="true">，所以你需要对解释器的运行原理有一定的了解。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5777"><span data-slate-object="text" data-key="5778"><span data-slate-leaf="true" data-offset-key="5778:0" data-first-offset="true"><span data-slate-string="true">既然我们这门课中的案例大量使用了 Python 这种解释型编程语言，那我们下面就来试试，能不能从 Python 解释器的跟踪点中，跟踪应用程序的函数执行过程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5779"><span data-slate-object="text" data-key="5780"><span data-slate-leaf="true" data-offset-key="5780:0" data-first-offset="true"><span data-slate-string="true">实际上，根据 Python&nbsp;</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5781"><span data-slate-object="text" data-key="5782"><span data-slate-leaf="true" data-offset-key="5782:0" data-first-offset="true"><span data-slate-string="true">文档</span></span></span></a><span data-slate-object="text" data-key="5783"><span data-slate-leaf="true" data-offset-key="5783:0" data-first-offset="true"><span data-slate-string="true">，为其开启 USDT 跟踪点（编译选项为 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5784"><span data-slate-object="text" data-key="5785"><span data-slate-leaf="true" data-offset-key="5785:0" data-first-offset="true"><span data-slate-string="true">--with-dtrace</span></span></span></span><span data-slate-object="text" data-key="5786"><span data-slate-leaf="true" data-offset-key="5786:0" data-first-offset="true"><span data-slate-string="true">）之后，Python3 二进制文件中就会包含一系列的 USDT 跟踪点。这些跟踪点也可以通过 bpftrace 查询到：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5787"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5788"><span data-slate-object="text" data-key="5789"><span data-slate-leaf="true" data-offset-key="5789:0" data-first-offset="true"><span data-slate-string="true">$ bpftrace -l </span></span></span><span data-slate-object="text" data-key="5790"><span data-slate-leaf="true" data-offset-key="5790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'*:/usr/bin/python3:*'</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5791"><span data-slate-object="text" data-key="5792"><span data-slate-leaf="true" data-offset-key="5792:0" data-first-offset="true"><span data-slate-string="true">usdt:/usr/bin/python3:python:audit</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5793"><span data-slate-object="text" data-key="5794"><span data-slate-leaf="true" data-offset-key="5794:0" data-first-offset="true"><span data-slate-string="true">usdt:/usr/bin/python3:python:function__entry</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5795"><span data-slate-object="text" data-key="5796"><span data-slate-leaf="true" data-offset-key="5796:0" data-first-offset="true"><span data-slate-string="true">usdt:/usr/bin/python3:python:function__return</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5797"><span data-slate-object="text" data-key="5798"><span data-slate-leaf="true" data-offset-key="5798:0" data-first-offset="true"><span data-slate-string="true">usdt:/usr/bin/python3:python:gc__done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5799"><span data-slate-object="text" data-key="5800"><span data-slate-leaf="true" data-offset-key="5800:0" data-first-offset="true"><span data-slate-string="true">usdt:/usr/bin/python3:python:gc__start</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5801"><span data-slate-object="text" data-key="5802"><span data-slate-leaf="true" data-offset-key="5802:0" data-first-offset="true"><span data-slate-string="true">usdt:/usr/bin/python3:python:import__find__load__done</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5803"><span data-slate-object="text" data-key="5804"><span data-slate-leaf="true" data-offset-key="5804:0" data-first-offset="true"><span data-slate-string="true">usdt:/usr/bin/python3:python:import__find__load__start</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5805"><span data-slate-object="text" data-key="5806"><span data-slate-leaf="true" data-offset-key="5806:0" data-first-offset="true"><span data-slate-string="true">usdt:/usr/bin/python3:python:line</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5807"><span data-slate-object="text" data-key="5808"><span data-slate-leaf="true" data-offset-key="5808:0" data-first-offset="true"><span data-slate-string="true">其中，跟函数调用相关的正是 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5809"><span data-slate-object="text" data-key="5810"><span data-slate-leaf="true" data-offset-key="5810:0" data-first-offset="true"><span data-slate-string="true">function__entry</span></span></span></span><span data-slate-object="text" data-key="5811"><span data-slate-leaf="true" data-offset-key="5811:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 和 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5812"><span data-slate-object="text" data-key="5813"><span data-slate-leaf="true" data-offset-key="5813:0" data-first-offset="true"><span data-slate-string="true">function__return</span></span></span></span><span data-slate-object="text" data-key="5814"><span data-slate-leaf="true" data-offset-key="5814:0" data-first-offset="true"><span data-slate-string="true">，因而它们就可以用来跟踪函数的调用过程。根据 Python&nbsp;</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5815"><span data-slate-object="text" data-key="5816"><span data-slate-leaf="true" data-offset-key="5816:0" data-first-offset="true"><span data-slate-string="true">文档</span></span></span></a><span data-slate-object="text" data-key="5817"><span data-slate-leaf="true" data-offset-key="5817:0" data-first-offset="true"><span data-slate-string="true">，这两个函数的定义格式为：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="5818"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5819"><span data-slate-object="text" data-key="5820"><span data-slate-leaf="true" data-offset-key="5820:0" data-first-offset="true"><span data-slate-string="true">// 三个参数分别是文件名、函数名和行号</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5821"><span data-slate-object="text" data-key="5822"><span data-slate-leaf="true" data-offset-key="5822:0" data-first-offset="true"><span data-slate-string="true">function__entry(</span></span></span><span data-slate-object="text" data-key="5823"><span data-slate-leaf="true" data-offset-key="5823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">str</span></span></span></span><span data-slate-object="text" data-key="5824"><span data-slate-leaf="true" data-offset-key="5824:0" data-first-offset="true"><span data-slate-string="true"> filename, </span></span></span><span data-slate-object="text" data-key="5825"><span data-slate-leaf="true" data-offset-key="5825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">str</span></span></span></span><span data-slate-object="text" data-key="5826"><span data-slate-leaf="true" data-offset-key="5826:0" data-first-offset="true"><span data-slate-string="true"> funcname, </span></span></span><span data-slate-object="text" data-key="5827"><span data-slate-leaf="true" data-offset-key="5827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5828"><span data-slate-leaf="true" data-offset-key="5828:0" data-first-offset="true"><span data-slate-string="true"> lineno)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5829"><span data-slate-object="text" data-key="5830"><span data-slate-leaf="true" data-offset-key="5830:0" data-first-offset="true"><span data-slate-string="true">function__return(</span></span></span><span data-slate-object="text" data-key="5831"><span data-slate-leaf="true" data-offset-key="5831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">str</span></span></span></span><span data-slate-object="text" data-key="5832"><span data-slate-leaf="true" data-offset-key="5832:0" data-first-offset="true"><span data-slate-string="true"> filename, </span></span></span><span data-slate-object="text" data-key="5833"><span data-slate-leaf="true" data-offset-key="5833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">str</span></span></span></span><span data-slate-object="text" data-key="5834"><span data-slate-leaf="true" data-offset-key="5834:0" data-first-offset="true"><span data-slate-string="true"> funcname, </span></span></span><span data-slate-object="text" data-key="5835"><span data-slate-leaf="true" data-offset-key="5835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5836"><span data-slate-leaf="true" data-offset-key="5836:0" data-first-offset="true"><span data-slate-string="true"> lineno)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5837"><span data-slate-object="text" data-key="5838"><span data-slate-leaf="true" data-offset-key="5838:0" data-first-offset="true"><span data-slate-string="true">有了跟踪点的定义格式，我们就可以使用 eBPF 来跟踪这些函数。比如，对 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5839"><span data-slate-object="text" data-key="5840"><span data-slate-leaf="true" data-offset-key="5840:0" data-first-offset="true"><span data-slate-string="true">function__entry</span></span></span></span><span data-slate-object="text" data-key="5841"><span data-slate-leaf="true" data-offset-key="5841:0" data-first-offset="true"><span data-slate-string="true"> 来说，执行下面的 bpftrace 单行命令，就可以跟踪 Python 函数的调用信息：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5842"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5843"><span data-slate-object="text" data-key="5844"><span data-slate-leaf="true" data-offset-key="5844:0" data-first-offset="true"><span data-slate-string="true">sudo bpftrace -e </span></span></span><span data-slate-object="text" data-key="5845"><span data-slate-leaf="true" data-offset-key="5845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'usdt:/usr/bin/python3:function__entry {printf("%s:%d %s\n", str(arg0), arg2, str(arg1))}'</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5846"><span data-slate-object="text" data-key="5847"><span data-slate-leaf="true" data-offset-key="5847:0" data-first-offset="true"><span data-slate-string="true">在这个命令中， </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5848"><span data-slate-object="text" data-key="5849"><span data-slate-leaf="true" data-offset-key="5849:0" data-first-offset="true"><span data-slate-string="true">arg0</span></span></span></span><span data-slate-object="text" data-key="5850"><span data-slate-leaf="true" data-offset-key="5850:0" data-first-offset="true"><span data-slate-string="true">、 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5851"><span data-slate-object="text" data-key="5852"><span data-slate-leaf="true" data-offset-key="5852:0" data-first-offset="true"><span data-slate-string="true">arg1</span></span></span></span><span data-slate-object="text" data-key="5853"><span data-slate-leaf="true" data-offset-key="5853:0" data-first-offset="true"><span data-slate-string="true"> 、 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5854"><span data-slate-object="text" data-key="5855"><span data-slate-leaf="true" data-offset-key="5855:0" data-first-offset="true"><span data-slate-string="true">arg2</span></span></span></span><span data-slate-object="text" data-key="5856"><span data-slate-leaf="true" data-offset-key="5856:0" data-first-offset="true"><span data-slate-string="true"> 表示函数的三个参数。这条命令的含义就是把这几个参数拼接成 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5857"><span data-slate-object="text" data-key="5858"><span data-slate-leaf="true" data-offset-key="5858:0" data-first-offset="true"><span data-slate-string="true">文件名：行号 函数名</span></span></span></span><span data-slate-object="text" data-key="5859"><span data-slate-leaf="true" data-offset-key="5859:0" data-first-offset="true"><span data-slate-string="true"> 的格式，然后再打印到终端上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5860"><span data-slate-object="text" data-key="5861"><span data-slate-leaf="true" data-offset-key="5861:0" data-first-offset="true"><span data-slate-string="true">打开一个新终端，并执行下面的 Python 命令开启一个 http 服务：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5862"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5863"><span data-slate-object="text" data-key="5864"><span data-slate-leaf="true" data-offset-key="5864:0" data-first-offset="true"><span data-slate-string="true">python3 -m http.server 8080</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5865"><span data-slate-object="text" data-key="5866"><span data-slate-leaf="true" data-offset-key="5866:0" data-first-offset="true"><span data-slate-string="true">然后，再回到第一个终端，就可以看到如下的输出：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5867"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5868"><span data-slate-object="text" data-key="5869"><span data-slate-leaf="true" data-offset-key="5869:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5870"><span data-slate-object="text" data-key="5871"><span data-slate-leaf="true" data-offset-key="5871:0" data-first-offset="true"><span data-slate-string="true">/usr/lib/python3.9/socketserver.py:254 service_actions</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5872"><span data-slate-object="text" data-key="5873"><span data-slate-leaf="true" data-offset-key="5873:0" data-first-offset="true"><span data-slate-string="true">/usr/lib/python3.9/selectors.py:403 select</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5874"><span data-slate-object="text" data-key="5875"><span data-slate-leaf="true" data-offset-key="5875:0" data-first-offset="true"><span data-slate-string="true">/usr/lib/python3.9/socketserver.py:254 service_actions</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5876"><span data-slate-object="text" data-key="5877"><span data-slate-leaf="true" data-offset-key="5877:0" data-first-offset="true"><span data-slate-string="true">/usr/lib/python3.9/selectors.py:403 select</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5878"><span data-slate-object="text" data-key="5879"><span data-slate-leaf="true" data-offset-key="5879:0" data-first-offset="true"><span data-slate-string="true">恭喜，到这里，你已经成功从 Python 解释器中跟踪到了应用程序中的函数调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5880"><span data-slate-object="text" data-key="5881"><span data-slate-leaf="true" data-offset-key="5881:0" data-first-offset="true"><span data-slate-string="true">对于其他的解释型编程语言，其跟踪过程也是类似的，只是要把跟踪函数换成该语言解释器中处理函数调用的跟踪点。如果你不了解它们底层的实现原理，可以参考 BCC 的 &nbsp;</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5882"><span data-slate-object="text" data-key="5883"><span data-slate-leaf="true" data-offset-key="5883:0" data-first-offset="true"><span data-slate-string="true">ucalls</span></span></span></a><span data-slate-object="text" data-key="5884"><span data-slate-leaf="true" data-offset-key="5884:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 和 &nbsp;</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5885"><span data-slate-object="text" data-key="5886"><span data-slate-leaf="true" data-offset-key="5886:0" data-first-offset="true"><span data-slate-string="true">uflow</span></span></span></a><span data-slate-object="text" data-key="5887"><span data-slate-leaf="true" data-offset-key="5887:0" data-first-offset="true"><span data-slate-string="true">&nbsp;，开发针对它们的跟踪程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5888"><span data-slate-object="text" data-key="5889"><span data-slate-leaf="true" data-offset-key="5889:0" data-first-offset="true"><span data-slate-string="true">刚才我们使用的是 bpftrace，如果你想使用 BCC 和 libbpf 来开发更复杂的跟踪功能也是没问题的。比如，还是以 BCC 为例，它的跟踪过程与编译型语言相比，主要有两个不同点，下面我们来具体看看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5890"><span data-slate-object="text" data-key="5891"><span data-slate-leaf="true" data-offset-key="5891:0" data-first-offset="true"><span data-slate-string="true">第一，在 eBPF 程序部分，USDT 跟踪点需要调用 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5892"><span data-slate-object="text" data-key="5893"><span data-slate-leaf="true" data-offset-key="5893:0" data-first-offset="true"><span data-slate-string="true">bpf_usdt_readarg()</span></span></span></span><span data-slate-object="text" data-key="5894"><span data-slate-leaf="true" data-offset-key="5894:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 函数，来读取函数参数（对于指针类数据，还需调用 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="5895"><span data-slate-object="text" data-key="5896"><span data-slate-leaf="true" data-offset-key="5896:0" data-first-offset="true"><span data-slate-string="true">bpf_probe_read_user()</span></span></span></span><span data-slate-object="text" data-key="5897"><span data-slate-leaf="true" data-offset-key="5897:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 读取指针指向的内容），代码如下所示：</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="5898"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5899"><span data-slate-object="text" data-key="5900"><span data-slate-leaf="true" data-offset-key="5900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 头文件引用和数据结构定义...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5901"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5902"><span data-slate-object="text" data-key="5903"><span data-slate-leaf="true" data-offset-key="5903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5904"><span data-slate-leaf="true" data-offset-key="5904:0" data-first-offset="true"><span data-slate-string="true"> print_functions(</span></span></span><span data-slate-object="text" data-key="5905"><span data-slate-leaf="true" data-offset-key="5905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5906"><span data-slate-leaf="true" data-offset-key="5906:0" data-first-offset="true"><span data-slate-string="true"> pt_regs *ctx)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5907"><span data-slate-object="text" data-key="5908"><span data-slate-leaf="true" data-offset-key="5908:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5909"><span data-slate-object="text" data-key="5910"><span data-slate-leaf="true" data-offset-key="5910:0" data-first-offset="true"><span data-slate-string="true">    uint64_t argptr;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5911"><span data-slate-object="text" data-key="5912"><span data-slate-leaf="true" data-offset-key="5912:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5913"><span data-slate-leaf="true" data-offset-key="5913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5914"><span data-slate-leaf="true" data-offset-key="5914:0" data-first-offset="true"><span data-slate-string="true"> data_t data = { };</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5915"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5916"><span data-slate-object="text" data-key="5917"><span data-slate-leaf="true" data-offset-key="5917:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5918"><span data-slate-leaf="true" data-offset-key="5918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 参数 1 是文件名</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5919"><span data-slate-object="text" data-key="5920"><span data-slate-leaf="true" data-offset-key="5920:0" data-first-offset="true"><span data-slate-string="true">    bpf_usdt_readarg(</span></span></span><span data-slate-object="text" data-key="5921"><span data-slate-leaf="true" data-offset-key="5921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="5922"><span data-slate-leaf="true" data-offset-key="5922:0" data-first-offset="true"><span data-slate-string="true">, ctx, &amp;argptr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5923"><span data-slate-object="text" data-key="5924"><span data-slate-leaf="true" data-offset-key="5924:0" data-first-offset="true"><span data-slate-string="true">    bpf_probe_read_user(&amp;data.filename, </span></span></span><span data-slate-object="text" data-key="5925"><span data-slate-leaf="true" data-offset-key="5925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="5926"><span data-slate-leaf="true" data-offset-key="5926:0" data-first-offset="true"><span data-slate-string="true">(data.filename),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5927"><span data-slate-object="text" data-key="5928"><span data-slate-leaf="true" data-offset-key="5928:0" data-first-offset="true"><span data-slate-string="true">                (</span></span></span><span data-slate-object="text" data-key="5929"><span data-slate-leaf="true" data-offset-key="5929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="5930"><span data-slate-leaf="true" data-offset-key="5930:0" data-first-offset="true"><span data-slate-string="true"> *)argptr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5931"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5932"><span data-slate-object="text" data-key="5933"><span data-slate-leaf="true" data-offset-key="5933:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5934"><span data-slate-leaf="true" data-offset-key="5934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 参数 2 是函数名</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5935"><span data-slate-object="text" data-key="5936"><span data-slate-leaf="true" data-offset-key="5936:0" data-first-offset="true"><span data-slate-string="true">    bpf_usdt_readarg(</span></span></span><span data-slate-object="text" data-key="5937"><span data-slate-leaf="true" data-offset-key="5937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="5938"><span data-slate-leaf="true" data-offset-key="5938:0" data-first-offset="true"><span data-slate-string="true">, ctx, &amp;argptr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5939"><span data-slate-object="text" data-key="5940"><span data-slate-leaf="true" data-offset-key="5940:0" data-first-offset="true"><span data-slate-string="true">    bpf_probe_read_user(&amp;data.funcname, </span></span></span><span data-slate-object="text" data-key="5941"><span data-slate-leaf="true" data-offset-key="5941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="5942"><span data-slate-leaf="true" data-offset-key="5942:0" data-first-offset="true"><span data-slate-string="true">(data.funcname),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5943"><span data-slate-object="text" data-key="5944"><span data-slate-leaf="true" data-offset-key="5944:0" data-first-offset="true"><span data-slate-string="true">                (</span></span></span><span data-slate-object="text" data-key="5945"><span data-slate-leaf="true" data-offset-key="5945:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="5946"><span data-slate-leaf="true" data-offset-key="5946:0" data-first-offset="true"><span data-slate-string="true"> *)argptr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5947"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5948"><span data-slate-object="text" data-key="5949"><span data-slate-leaf="true" data-offset-key="5949:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5950"><span data-slate-leaf="true" data-offset-key="5950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 参数 3 是行号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5951"><span data-slate-object="text" data-key="5952"><span data-slate-leaf="true" data-offset-key="5952:0" data-first-offset="true"><span data-slate-string="true">  bpf_usdt_readarg(</span></span></span><span data-slate-object="text" data-key="5953"><span data-slate-leaf="true" data-offset-key="5953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="5954"><span data-slate-leaf="true" data-offset-key="5954:0" data-first-offset="true"><span data-slate-string="true">, ctx, &amp;data.lineno);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5955"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5956"><span data-slate-object="text" data-key="5957"><span data-slate-leaf="true" data-offset-key="5957:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5958"><span data-slate-leaf="true" data-offset-key="5958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 最后提交性能事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5959"><span data-slate-object="text" data-key="5960"><span data-slate-leaf="true" data-offset-key="5960:0" data-first-offset="true"><span data-slate-string="true">    events.perf_submit(ctx, &amp;data, </span></span></span><span data-slate-object="text" data-key="5961"><span data-slate-leaf="true" data-offset-key="5961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="5962"><span data-slate-leaf="true" data-offset-key="5962:0" data-first-offset="true"><span data-slate-string="true">(data));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5963"><span data-slate-object="text" data-key="5964"><span data-slate-leaf="true" data-offset-key="5964:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5965"><span data-slate-leaf="true" data-offset-key="5965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5966"><span data-slate-leaf="true" data-offset-key="5966:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5967"><span data-slate-leaf="true" data-offset-key="5967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5968"><span data-slate-leaf="true" data-offset-key="5968:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5969"><span data-slate-object="text" data-key="5970"><span data-slate-leaf="true" data-offset-key="5970:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5971"><span data-slate-object="text" data-key="5972"><span data-slate-leaf="true" data-offset-key="5972:0" data-first-offset="true"><span data-slate-string="true">第二，在 Python 前端程序中，挂载跟踪点时需要换成 USDT 跟踪点，即：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="5973"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5974"><span data-slate-object="text" data-key="5975"><span data-slate-leaf="true" data-offset-key="5975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">from</span></span></span></span><span data-slate-object="text" data-key="5976"><span data-slate-leaf="true" data-offset-key="5976:0" data-first-offset="true"><span data-slate-string="true"> bcc </span></span></span><span data-slate-object="text" data-key="5977"><span data-slate-leaf="true" data-offset-key="5977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="5978"><span data-slate-leaf="true" data-offset-key="5978:0" data-first-offset="true"><span data-slate-string="true"> BPF, USDT</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5979"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5980"><span data-slate-object="text" data-key="5981"><span data-slate-leaf="true" data-offset-key="5981:0" data-first-offset="true"><span data-slate-string="true">u = USDT(pid=pid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5982"><span data-slate-object="text" data-key="5983"><span data-slate-leaf="true" data-offset-key="5983:0" data-first-offset="true"><span data-slate-string="true">u.enable_probe(probe=</span></span></span><span data-slate-object="text" data-key="5984"><span data-slate-leaf="true" data-offset-key="5984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"function__entry"</span></span></span></span><span data-slate-object="text" data-key="5985"><span data-slate-leaf="true" data-offset-key="5985:0" data-first-offset="true"><span data-slate-string="true">, fn_name=</span></span></span><span data-slate-object="text" data-key="5986"><span data-slate-leaf="true" data-offset-key="5986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"print_functions"</span></span></span></span><span data-slate-object="text" data-key="5987"><span data-slate-leaf="true" data-offset-key="5987:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5988"><span data-slate-object="text" data-key="5989"><span data-slate-leaf="true" data-offset-key="5989:0" data-first-offset="true"><span data-slate-string="true">b = BPF(src_file=</span></span></span><span data-slate-object="text" data-key="5990"><span data-slate-leaf="true" data-offset-key="5990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"&lt;ebpf-program&gt;.c"</span></span></span></span><span data-slate-object="text" data-key="5991"><span data-slate-leaf="true" data-offset-key="5991:0" data-first-offset="true"><span data-slate-string="true">, usdt_contexts=[u])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5992"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5993"><span data-slate-object="text" data-key="5994"><span data-slate-leaf="true" data-offset-key="5994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 其他处理逻辑</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5995"><span data-slate-object="text" data-key="5996"><span data-slate-leaf="true" data-offset-key="5996:0" data-first-offset="true"><span data-slate-string="true">除了这两个不同点，其他的逻辑都是类似的。那么，参考上述的编译型语言跟踪程序，你能在这两个不同点的基础上，写出完整的 BCC 跟踪程序吗？这里你可以先想一想，这也是今天留给你的思考题。欢迎你在课后跟我分享你的思路和实现方法。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5997" id="sr-toc-5"><span data-slate-object="text" data-key="5998"><span data-slate-leaf="true" data-offset-key="5998:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">跟踪即时编译型语言应用程序</span></span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5999"><span data-slate-object="text" data-key="6000"><span data-slate-leaf="true" data-offset-key="6000:0" data-first-offset="true"><span data-slate-string="true">除了上面两类编程语言，还有一种是 Java、.Net 等即时编译型语言。对于这类编程语言开发的应用程序，应用源代码会先编译为字节码，再由即时编译器（JIT）编译为机器码执行。以 Java 为例，Java 虚拟机（JVM）除了会执行常规的 JIT 即时编译之外，还会在执行过程中对运行流程进行剖析和优化，因而也加大了跟踪的难度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6001"><span data-slate-object="text" data-key="6002"><span data-slate-leaf="true" data-offset-key="6002:0" data-first-offset="true"><span data-slate-string="true">同解释型编程语言类似，uprobe 和 USDT 跟踪只能用在即时编译器上，从即时编译器的跟踪点参数里面获取最终应用程序的函数信息。由于 USDT 跟踪点比 uprobe 更为稳定，如果编程语言提供了 USDT 跟踪功能，我推荐打开 USDT 跟踪（比如 Java 需要打开 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6003"><span data-slate-object="text" data-key="6004"><span data-slate-leaf="true" data-offset-key="6004:0" data-first-offset="true"><span data-slate-string="true">--enable-dtrace</span></span></span></span><span data-slate-object="text" data-key="6005"><span data-slate-leaf="true" data-offset-key="6005:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 编译选项），再利用 USDT 而不是 uprobe 去跟踪应用的执行过程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6006"><span data-slate-object="text" data-key="6007"><span data-slate-leaf="true" data-offset-key="6007:0" data-first-offset="true"><span data-slate-string="true">要找出即时编译器的跟踪点同应用程序运行之间的关系，就需要你对编程语言的底层运行原理非常熟悉，这也是跟踪即时编译型语言应用程序最难的一步。不过这一步梳理清楚之后，具体的跟踪步骤与解释型编程语言应用程序是类似的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6008"><span data-slate-object="text" data-key="6009"><span data-slate-leaf="true" data-offset-key="6009:0" data-first-offset="true"><span data-slate-string="true">如果你需要跟踪这类编程语言开发的应用，可以参考 BCC 提供的一系列</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6010"><span data-slate-object="text" data-key="6011"><span data-slate-leaf="true" data-offset-key="6011:0" data-first-offset="true"><span data-slate-string="true">用户态跟踪库</span></span></span></a><span data-slate-object="text" data-key="6012"><span data-slate-leaf="true" data-offset-key="6012:0" data-first-offset="true"><span data-slate-string="true">，这里面已经包含了常见的几种编程语言的适配，具体的跟踪步骤我在这里就不展开了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6013" id="sr-toc-6"><span data-slate-object="text" data-key="6014"><span data-slate-leaf="true" data-offset-key="6014:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">小结</span></span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6015"><span data-slate-object="text" data-key="6016"><span data-slate-leaf="true" data-offset-key="6016:0" data-first-offset="true"><span data-slate-string="true">今天，我带你一起梳理了应用进程的跟踪方法，并以 Bash 和 Python 这两种编程语言为例，带你开发了它们的 uprobe 和 USDT 等不同类型的跟踪程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6017"><span data-slate-object="text" data-key="6018"><span data-slate-leaf="true" data-offset-key="6018:0" data-first-offset="true"><span data-slate-string="true">在跟踪应用进程之前，你需要先获取这个进程所对应的二进制文件的跟踪点，以及这些跟踪点同应用程序函数的对应关系。</span></span></span><span data-slate-object="text" data-key="6019"><span data-slate-leaf="true" data-offset-key="6019:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这个对应关系依赖于编程语言的类型</span></span></span></span><span data-slate-object="text" data-key="6020"><span data-slate-leaf="true" data-offset-key="6020:0" data-first-offset="true"><span data-slate-string="true">：编译型语言开发的程序中直接包含了应用程序的符号信息，因而可以直接拿来跟踪；而解释型语言和即时编译型语言的二进制文件，只包含了解释器或即时编译器的符号信息，所以应用程序的运行状态还需要从解释器或即时编译器跟踪的参数中去获取。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6021"><span data-slate-object="text" data-key="6022"><span data-slate-leaf="true" data-offset-key="6022:0" data-first-offset="true"><span data-slate-string="true">在这一讲结束之前，我还想提醒你：</span></span></span><span data-slate-object="text" data-key="6023"><span data-slate-leaf="true" data-offset-key="6023:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">用户进程的跟踪</span></span></span></span><span data-slate-object="text" data-key="6024"><span data-slate-leaf="true" data-offset-key="6024:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">，</span></span></span></span><span data-slate-object="text" data-key="6025"><span data-slate-leaf="true" data-offset-key="6025:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">本质上是通过断点去执行 uprobe 处理程序。</span></span></span></span><span data-slate-object="text" data-key="6026"><span data-slate-leaf="true" data-offset-key="6026:0" data-first-offset="true"><span data-slate-string="true">虽然内核社区已经对 BPF 做了很多的性能调优，跟踪用户态函数（特别是锁争用、内存分配之类的高频函数）还是有可能带来很大的性能开销。因此，我们在使用 uprobe 时，应该尽量避免跟踪高频函数。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6027" id="sr-toc-7"><span data-slate-object="text" data-key="6028"><span data-slate-leaf="true" data-offset-key="6028:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6029"><span data-slate-object="text" data-key="6030"><span data-slate-leaf="true" data-offset-key="6030:0" data-first-offset="true"><span data-slate-string="true">在跟踪 Python 语言程序的 BCC 案例中，我列出了它在使用 USDT 跟踪时，相对于编译型语言的两个不同点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6031"><div data-slate-type="list-line" data-slate-object="block" data-key="6032"><span data-slate-object="text" data-key="6033"><span data-slate-leaf="true" data-offset-key="6033:0" data-first-offset="true"><span data-slate-string="true">eBPF 程序中需要调用 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6034"><span data-slate-object="text" data-key="6035"><span data-slate-leaf="true" data-offset-key="6035:0" data-first-offset="true"><span data-slate-string="true">bpf_usdt_readarg()</span></span></span></span><span data-slate-object="text" data-key="6036"><span data-slate-leaf="true" data-offset-key="6036:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 来读取参数；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6037"><span data-slate-object="text" data-key="6038"><span data-slate-leaf="true" data-offset-key="6038:0" data-first-offset="true"><span data-slate-string="true">Python 前端中需要挂载 USDT 跟踪点。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6039"><span data-slate-object="text" data-key="6040"><span data-slate-leaf="true" data-offset-key="6040:0" data-first-offset="true"><span data-slate-string="true">根据这些提示，以及上面的编译型语言 BCC 跟踪程序，你能试着写出完整的 BCC 跟踪程序吗？欢迎在评论区和我分享你的思路和解决方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6041"><span data-slate-object="text" data-key="6042"><span data-slate-leaf="true" data-offset-key="6042:0" data-first-offset="true"><span data-slate-string="true">期待你在留言区和我讨论，也欢迎把这节课分享给你的同事、朋友。让我们一起在实战中演练，在交流中进步。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/94/c1/9415076c60e63fc6303d9a3bc900b5c1.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-8">精选留言 (8)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>莫名</span></div></div><div>1. 跟踪编译型语言应用程序以 Bash Shell 作为例子，觉得有些容易与解释型语言混淆。解释型语言的特征是解释程序自身为编译型程序，利用自身内置的函数进行语法分析和执行，Bash readline 函数的功能即是如此。以编译型语言 Golang helloworld 程序使用 uprobes 或者开源的 Nginx 使用 USDT 可能更恰当一些。 

2. 思考题完整的 BCC 追踪程序：

----------- python_functions.c -------------

#include &lt;uapi/linux/ptrace.h&gt;

struct data_t {
	char filename [128];
	char funcname [64];
	int lineno;
};
BPF_PERF_OUTPUT (events);

int print_functions (struct pt_regs *ctx)
{
	uint64_t argptr;
	struct data_t data = { };

	bpf_usdt_readarg (1, ctx, &amp;argptr);
	bpf_probe_read_user (&amp;data.filename, sizeof (data.filename), (void *) argptr);
	bpf_usdt_readarg (2, ctx, &amp;argptr);
	bpf_probe_read_user (&amp;data.funcname, sizeof (data.funcname), (void *) argptr);
	bpf_usdt_readarg (3, ctx, &amp;data.lineno);

	events.perf_submit (ctx, &amp;data, sizeof (data));

	return 0;
};

----------- python_functions.py -------------

#!/usr/bin/python3

import sys
from bcc import BPF, USDT

if len (sys.argv) &lt; 2:
    print ("Usage: % s &lt;tracee_pid&gt;" % sys.argv [0])
    sys.exit (1)

u = USDT (pid=int (sys.argv [1]))
u.enable_probe (probe="function__entry", fn_name="print_functions")
b = BPF (src_file="python_functions.c", usdt_contexts=[u])


def print_event (cpu, data, size):
    event = b ["events"].event (data)
    printb ("%-9s %-6d % s" % (event.filename, event.lineno, event.funcname))


print ("%-9s %-6s % s" % ("FILENAME", "LINENO", "FUNCTION"))

b ["events"].open_perf_buffer (print_event)
while True:
    try:
        b.perf_buffer_poll ()
    except KeyboardInterrupt:
        exit ()</div><div><p>作者回复: 1. 其实最终还是要看跟踪的目的是什么：如果是要排查 Bash 内部的执行过程，那就是跟踪编译型语言；但要是排查 SHELL 脚本的执行过程，那就变成了跟踪解释性语言。
2. 非常棒的答案！</p></div><div><div>2022-02-04</div><div><div><i></i></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKwGurTWOiaZ2O2oCdxK9kbF4PcwGg0ALqsWhNq87hWvwPy8ZU9cxRzmcGOgdIeJkTOoKfbxgEKqrg/132"></div></div><div><div><div><span>ZR2021</span></div></div><div>老师，跟踪用户态程序的时候还有 512 字节的限制吗</div><div><p>作者回复: eBPF 栈空间的限制跟要跟跟踪的事件是没关系的，但其实都可以通过映射避免内存限制的问题。</p></div><div><div>2022-02-04</div><div><div><i></i><span>2</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJlaNica7xRH6LlMNJtrbK0toc1od8YdqLZOD2AbnOZ2QyKC13gvrrL9cOx5dyYNcsHnJkR6K4ibxZQ/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_59a6f9</span></div></div><div>用户态进程跟踪是不是使用 frida 效果更好？</div><div><p>作者回复：嗯嗯，展示效果都是可以在用户态程序中去自定义的。</p></div><div><div>2022-02-04</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/c4/91/a017bf72.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>coconut</span></div></div><div>/usr/bin/bash 即使没有用 debuginfo-install 安装调试符号，也能执行 bpftrace -e 'uretprobe:/usr/bin/bash:readline {printf ("User % d executed \"% s\"command\n", uid, str (retval)); }'</div><div><div>2022-07-25</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/32/a8/d5bf5445.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>郑海成</span></div></div><div>sudo bpftrace -l '*:/usr/bin/python3:*' 执行后没有任何跟踪点信息</div><div><div>2022-04-12</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek3340</span></div></div><div>sudo apt install bash-dbgsym 命令，执行后找不到 dbgsym 包的，可以参考这篇文章
https://cloud.tencent.com/developer/article/1637887</div><div><p>作者回复: 👍 谢谢分享安装步骤</p></div><div><div>2022-03-20</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/6f/a7/565214bc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>│．Sk</span></div></div><div>老师您好，请教一下

1. 执行了 strip 命令删除了  .symtab  的二进制文件，是否就 “不能” 用 .symtab 里的符号执行 bpftrace -e 'uretprobe:/usr/bin/bash: 符号  {...}' ？

2. 如果 1. 中的理解是对的，那么上面的 /usr/bin/bash 的 .symtab 实际已经被 strip 了，但是还能执行上面的 trace 是否是因为 BCC 会用 /usr/bin/bash 的 build id 去 /usr/lib/debug/.build-id/ 关联相应的符号表，然后再用符号找到函数地址？

谢谢老师！</div><div><p>作者回复：是的</p></div><div><div>2022-03-05</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/85/e3/7df90bff.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>王恒</span></div></div><div>某线程 CPU 占用率过高，通过 perf 工具生成了该线程的火焰图。发现该线程的系统函数占比较高，但是又无法查到这些系统函数的调用堆栈。（火焰图中，ia32_sysenter_target 函数占比约 6%，sysexit_from_sys_call 函数占比约 9%。）

特别想搞懂这些内核函数是什么时候被调用的，调用堆栈是怎么样的，为什么耗时这么久。所以特地来学习 ebpf，希望边学边解决工作中的实际问题。</div><div><p>作者回复：嗯 这时候可以跟踪一下相关函数的内核调用栈</p></div><div><div>2022-03-05</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".t"><outline class="toc-level-h1" data-reactid=".t.0" style="width: 175px;"><active data-reactid=".t.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".t.0.1"><span data-reactid=".t.0.1.0">09 | 用户态跟踪：如何使用 eBPF 排查应用程序？</span></a></outline><outline class="toc-level-h2" data-reactid=".t.1" style="width: 165px;"><active data-reactid=".t.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".t.1.1"><span data-reactid=".t.1.1.0">如何查询用户进程跟踪点？</span></a></outline><outline class="toc-level-h2" data-reactid=".t.2" style="width: 165px;"><active data-reactid=".t.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".t.2.1"><span data-reactid=".t.2.1.0">编程语言会影响 eBPF 的跟踪吗？</span></a></outline><outline class="toc-level-h2" data-reactid=".t.3" style="width: 165px;"><active data-reactid=".t.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".t.3.1"><span data-reactid=".t.3.1.0">跟踪编译型语言应用程序</span></a></outline><outline class="toc-level-h2" data-reactid=".t.4" style="width: 165px;"><active data-reactid=".t.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".t.4.1"><span data-reactid=".t.4.1.0">跟踪解释型语言应用程序</span></a></outline><outline class="toc-level-h2" data-reactid=".t.5" style="width: 165px;"><active data-reactid=".t.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".t.5.1"><span data-reactid=".t.5.1.0">跟踪即时编译型语言应用程序</span></a></outline><outline class="toc-level-h2" data-reactid=".t.6" style="width: 165px;"><active data-reactid=".t.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".t.6.1"><span data-reactid=".t.6.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".t.7" style="width: 165px;"><active data-reactid=".t.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".t.7.1"><span data-reactid=".t.7.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".t.8" style="width: 165px;"><active data-reactid=".t.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".t.8.1"><span data-reactid=".t.8.1.0">精选留言 (8)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/484458" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>