
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 05 | 索引（下）：位移索引和时间戳索引的区别是什么？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>05 | 索引（下）：位移索引和时间戳索引的区别是什么？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">为什么读源码逐渐成为了必选项？它究竟有什么作用呢？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">05 | 索引（下）：位移索引和时间戳索引的区别是什么？</h1><div><span>胡夕</span> <span> 2020-04-23</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/7c/16/7c4b39e4d7001e73aa3d3fe6a0517f16.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：13.07M</span><span> 时长：14:17</span></div></div><audio title="05 | 索引（下）：位移索引和时间戳索引的区别是什么？" src="https://res001.geekbang.org//media/audio/9a/97/9ab31ac33d92b925f577e8fc4aa48797/ld/ld.m3u8" __idm_id__="49160"></audio></div><div><div><div><div data-slate-editor="true" data-key="6525" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="6526"><span data-slate-object="text" data-key="6527"><span data-slate-leaf="true" data-offset-key="6527:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。今天，我们继续说索引那些事儿。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6528"><span data-slate-object="text" data-key="6529"><span data-slate-leaf="true" data-offset-key="6529:0" data-first-offset="true"><span data-slate-string="true">在上节课，我带你重点学习了 Kafka 源码中索引的抽象父类 AbstractIndex。我分析了 AbstractIndex 类的大体对象结构，还介绍了社区改进版的二分查找算法在 Kafka 索引上的应用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6530"><span data-slate-object="text" data-key="6531"><span data-slate-leaf="true" data-offset-key="6531:0" data-first-offset="true"><span data-slate-string="true">前面说过，Kafka 索引类型有三大类：位移索引、时间戳索引和已中止事务索引。相比于最后一类索引，前两类索引的出镜率更高一些。在 Kafka 的数据路径下，你肯定看到过很多. index 和. timeindex 后缀的文件。不知你是否有过这样的疑问：“这些文件是用来做什么的呢？” 现在我可以明确告诉你：.index 文件就是 Kafka 中的位移索引文件，而. timeindex 文件则是时间戳索引文件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6532"><span data-slate-object="text" data-key="6533"><span data-slate-leaf="true" data-offset-key="6533:0" data-first-offset="true"><span data-slate-string="true">那么，位移索引和时间戳索引到底是做什么用的呢？它们之间的区别是什么？今天，我就为你揭晓这些问题的答案。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6534" id="sr-toc-1"><span data-slate-object="text" data-key="6535"><span data-slate-leaf="true" data-offset-key="6535:0" data-first-offset="true"><span data-slate-string="true">位移索引</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6536"><span data-slate-object="text" data-key="6537"><span data-slate-leaf="true" data-offset-key="6537:0" data-first-offset="true"><span data-slate-string="true">在学习 Kafka 的任何一类索引的时候，我们都要关注两个问题：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6538"><div data-slate-type="list-line" data-slate-object="block" data-key="6539"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="6540"><span data-slate-leaf="true" data-offset-key="6540:0" data-first-offset="true"><span data-slate-string="true">索引中的索引项是如何定义的？</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="6541"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="6542"><span data-slate-leaf="true" data-offset-key="6542:0" data-first-offset="true"><span data-slate-string="true">如何向索引写入新的索引项？</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6543"><span data-slate-object="text" data-key="6544"><span data-slate-leaf="true" data-offset-key="6544:0" data-first-offset="true"><span data-slate-string="true">看到这里，你可能会很疑惑：“等等，难道我们不需要关心如何查询索引吗？” 当然需要啦！上节课我们不是讲过二分查找算法在索引中的应用了吗？如果你觉得有点生疏了，那就赶快先去复习一下吧。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6545"><span data-slate-object="text" data-key="6546"><span data-slate-leaf="true" data-offset-key="6546:0" data-first-offset="true"><span data-slate-string="true">现在，我们先来看下索引项的定义。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6547" id="sr-toc-2"><span data-slate-object="text" data-key="6548"><span data-slate-leaf="true" data-offset-key="6548:0" data-first-offset="true"><span data-slate-string="true">索引项的定义</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6549"><span data-slate-object="text" data-key="6550"><span data-slate-leaf="true" data-offset-key="6550:0" data-first-offset="true"><span data-slate-string="true">位移索引也就是所谓的 OffsetIndex，它可是一个老资历的组件了。如果我没记错的话，国内大面积使用 Kafka 应该是在 0.8 时代。从那个时候开始，OffsetIndex 就已经存在了。每当 Consumer 需要从主题分区的某个位置开始读取消息时，Kafka 就会用到 OffsetIndex 直接定位物理文件位置，从而避免了因为从头读取消息而引入的昂贵的 I/O 操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6551"><span data-slate-object="text" data-key="6552"><span data-slate-leaf="true" data-offset-key="6552:0" data-first-offset="true"><span data-slate-string="true">在上节课，我提到过，不同索引类型保存不同的 &lt;Key, Value&gt; 对。就 OffsetIndex 而言，Key 就是消息的相对位移，Value 是保存该消息的日志段文件中该消息第一个字节的物理文件位置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6553"><span data-slate-object="text" data-key="6554"><span data-slate-leaf="true" data-offset-key="6554:0" data-first-offset="true"><span data-slate-string="true">这里我来具体解释一下相对位移的含义。还记得 AbstractIndex 类中的抽象方法 entrySize 吗？它定义了单个 &lt;Key, Value&gt; 对所用的字节数。对于 OffsetIndex 来说，entrySize 就是 8，如 OffsetIndex.scala 中定义的那样：</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="6555"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6556"><span data-slate-object="text" data-key="6557"><span data-slate-leaf="true" data-offset-key="6557:0" data-first-offset="true"><span data-slate-string="true">    override </span></span></span><span data-slate-object="text" data-key="6558"><span data-slate-leaf="true" data-offset-key="6558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def</span></span></span></span><span data-slate-object="text" data-key="6559"><span data-slate-leaf="true" data-offset-key="6559:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6560"><span data-slate-leaf="true" data-offset-key="6560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">entrySize</span></span></span></span><span data-slate-object="text" data-key="6561"><span data-slate-leaf="true" data-offset-key="6561:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="6562"><span data-slate-leaf="true" data-offset-key="6562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">8</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6563"><span data-slate-object="text" data-key="6564"><span data-slate-leaf="true" data-offset-key="6564:0" data-first-offset="true"><span data-slate-string="true">为什么是 8 呢？相对位移是一个整型（Integer），占用 4 个字节，物理文件位置也是一个整型，同样占用 4 个字节，因此总共是 8 个字节。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6565"><span data-slate-object="text" data-key="6566"><span data-slate-leaf="true" data-offset-key="6566:0" data-first-offset="true"><span data-slate-string="true">那相对位移是什么值呢？我们知道，Kafka 中的消息位移值是一个长整型（Long），应该占用 8 个字节才对。在保存 OffsetIndex 的 &lt;Key, Value&gt; 对时，Kafka 做了一些优化。每个 OffsetIndex 对象在创建时，都已经保存了对应日志段对象的起始位移，因此，OffsetIndex 索引项没必要保存完整的 8 字节位移值。相反地，它只需要保存与起始位移的差值（Delta）就够了，而这个差值是可以被整型容纳的。这种设计可以让 OffsetIndex 每个索引项都节省 4 个字节。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6567"><span data-slate-object="text" data-key="6568"><span data-slate-leaf="true" data-offset-key="6568:0" data-first-offset="true"><span data-slate-string="true">举个简单的例子。假设一个索引文件保存了 1000 个索引项，使用相对位移值就能节省大约 4MB 的空间，这是不是一件很划算的事情呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6569"><span data-slate-object="text" data-key="6570"><span data-slate-leaf="true" data-offset-key="6570:0" data-first-offset="true"><span data-slate-string="true">OffsetIndex 定义了专门的方法，用于将一个 Long 型的位移值转换成相对位移，如下所示：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="6571"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6572"><span data-slate-object="text" data-key="6573"><span data-slate-leaf="true" data-offset-key="6573:0" data-first-offset="true"><span data-slate-string="true">def relativeOffset(offset: Long): Int = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6574"><span data-slate-object="text" data-key="6575"><span data-slate-leaf="true" data-offset-key="6575:0" data-first-offset="true"><span data-slate-string="true">    val relativeOffset = toRelative(offset)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6576"><span data-slate-object="text" data-key="6577"><span data-slate-leaf="true" data-offset-key="6577:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6578"><span data-slate-leaf="true" data-offset-key="6578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6579"><span data-slate-leaf="true" data-offset-key="6579:0" data-first-offset="true"><span data-slate-string="true"> (relativeOffset.isEmpty)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6580"><span data-slate-object="text" data-key="6581"><span data-slate-leaf="true" data-offset-key="6581:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6582"><span data-slate-leaf="true" data-offset-key="6582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果无法转换成功（比如差值超过了整型表示范围)，则抛出异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6583"><span data-slate-object="text" data-key="6584"><span data-slate-leaf="true" data-offset-key="6584:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6585"><span data-slate-leaf="true" data-offset-key="6585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="6586"><span data-slate-leaf="true" data-offset-key="6586:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6587"><span data-slate-leaf="true" data-offset-key="6587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="6588"><span data-slate-leaf="true" data-offset-key="6588:0" data-first-offset="true"><span data-slate-string="true"> IndexOffsetOverflowException(s</span></span></span><span data-slate-object="text" data-key="6589"><span data-slate-leaf="true" data-offset-key="6589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Integer overflow for offset: </span></span></span></span><span data-slate-object="text" data-key="6590"><span data-slate-leaf="true" data-offset-key="6590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$offset</span></span></span></span></span><span data-slate-object="text" data-key="6591"><span data-slate-leaf="true" data-offset-key="6591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> (</span></span></span></span><span data-slate-object="text" data-key="6592"><span data-slate-leaf="true" data-offset-key="6592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${file.getAbsoluteFile}</span></span></span></span></span><span data-slate-object="text" data-key="6593"><span data-slate-leaf="true" data-offset-key="6593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)"</span></span></span></span><span data-slate-object="text" data-key="6594"><span data-slate-leaf="true" data-offset-key="6594:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6595"><span data-slate-object="text" data-key="6596"><span data-slate-leaf="true" data-offset-key="6596:0" data-first-offset="true"><span data-slate-string="true">    relativeOffset.</span></span></span><span data-slate-object="text" data-key="6597"><span data-slate-leaf="true" data-offset-key="6597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6598"><span data-slate-object="text" data-key="6599"><span data-slate-leaf="true" data-offset-key="6599:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6600"><span data-slate-object="text" data-key="6601"><span data-slate-leaf="true" data-offset-key="6601:0" data-first-offset="true"><span data-slate-string="true">relativeOffset 方法调用了父类的 toRelative 方法执行真正的转换。我们来看一下 toRelative 方法的实现。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="6602"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6603"><span data-slate-object="text" data-key="6604"><span data-slate-leaf="true" data-offset-key="6604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="6605"><span data-slate-leaf="true" data-offset-key="6605:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="6606"><span data-slate-leaf="true" data-offset-key="6606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">toRelative</span></span></span></span><span data-slate-object="text" data-key="6607"><span data-slate-leaf="true" data-offset-key="6607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(offset: Long)</span></span></span></span><span data-slate-object="text" data-key="6608"><span data-slate-leaf="true" data-offset-key="6608:0" data-first-offset="true"><span data-slate-string="true">: Option[Int] = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6609"><span data-slate-object="text" data-key="6610"><span data-slate-leaf="true" data-offset-key="6610:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6611"><span data-slate-leaf="true" data-offset-key="6611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="6612"><span data-slate-leaf="true" data-offset-key="6612:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6613"><span data-slate-leaf="true" data-offset-key="6613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">relativeOffset</span></span></span></span><span data-slate-object="text" data-key="6614"><span data-slate-leaf="true" data-offset-key="6614:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6615"><span data-slate-leaf="true" data-offset-key="6615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="6616"><span data-slate-leaf="true" data-offset-key="6616:0" data-first-offset="true"><span data-slate-string="true"> offset - baseOffset</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6617"><span data-slate-object="text" data-key="6618"><span data-slate-leaf="true" data-offset-key="6618:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6619"><span data-slate-leaf="true" data-offset-key="6619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6620"><span data-slate-leaf="true" data-offset-key="6620:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6621"><span data-slate-leaf="true" data-offset-key="6621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(relativeOffset &lt; </span></span></span></span><span data-slate-object="text" data-key="6622"><span data-slate-leaf="true" data-offset-key="6622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></span><span data-slate-object="text" data-key="6623"><span data-slate-leaf="true" data-offset-key="6623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> || relativeOffset &gt; Int.MaxValue)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6624"><span data-slate-object="text" data-key="6625"><span data-slate-leaf="true" data-offset-key="6625:0" data-first-offset="true"><span data-slate-string="true">    None</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6626"><span data-slate-object="text" data-key="6627"><span data-slate-leaf="true" data-offset-key="6627:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6628"><span data-slate-leaf="true" data-offset-key="6628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6629"><span data-slate-object="text" data-key="6630"><span data-slate-leaf="true" data-offset-key="6630:0" data-first-offset="true"><span data-slate-string="true">    Some(relativeOffset.toInt)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6631"><span data-slate-object="text" data-key="6632"><span data-slate-leaf="true" data-offset-key="6632:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6633"><span data-slate-object="text" data-key="6634"><span data-slate-leaf="true" data-offset-key="6634:0" data-first-offset="true"><span data-slate-string="true">逻辑很简单：第一步是计算给定的 offset 值与 baseOffset 的差值；第二步是校验该差值不能是负数或不能超过整型表示范围。如果校验通过，就直接返回该差值作为相对位移值，否则就返回 None 表示转换失败。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6635"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/c2/00/c259aff07a71aa4fe16165f423b3d600.jpg?wh=2766*2180"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6636"><span data-slate-object="text" data-key="6637"><span data-slate-leaf="true" data-offset-key="6637:0" data-first-offset="true"><span data-slate-string="true">现在，你知道 OffsetIndex 中的索引项为什么是 8 个字节以及位移值是如何被转换成相对位移了吧？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6638"><span data-slate-object="text" data-key="6639"><span data-slate-leaf="true" data-offset-key="6639:0" data-first-offset="true"><span data-slate-string="true">当读取 OffsetIndex 时，源码还需要将相对位移值还原成之前的完整位移。这个是在 parseEntry 方法中实现的。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="6640"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6641"><span data-slate-object="text" data-key="6642"><span data-slate-leaf="true" data-offset-key="6642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">override</span></span></span></span></span><span data-slate-object="text" data-key="6643"><span data-slate-leaf="true" data-offset-key="6643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6644"><span data-slate-leaf="true" data-offset-key="6644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">protected</span></span></span></span></span><span data-slate-object="text" data-key="6645"><span data-slate-leaf="true" data-offset-key="6645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> def </span></span></span></span><span data-slate-object="text" data-key="6646"><span data-slate-leaf="true" data-offset-key="6646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">parseEntry</span></span></span></span></span><span data-slate-object="text" data-key="6647"><span data-slate-leaf="true" data-offset-key="6647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(buffer: ByteBuffer, n: Int)</span></span></span></span></span><span data-slate-object="text" data-key="6648"><span data-slate-leaf="true" data-offset-key="6648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: OffsetPosition =</span></span></span></span><span data-slate-object="text" data-key="6649"><span data-slate-leaf="true" data-offset-key="6649:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6650"><span data-slate-object="text" data-key="6651"><span data-slate-leaf="true" data-offset-key="6651:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6652"><span data-slate-leaf="true" data-offset-key="6652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">OffsetPosition</span></span></span></span><span data-slate-object="text" data-key="6653"><span data-slate-leaf="true" data-offset-key="6653:0" data-first-offset="true"><span data-slate-string="true">(baseOffset + </span></span></span><span data-slate-object="text" data-key="6654"><span data-slate-leaf="true" data-offset-key="6654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">relativeOffset</span></span></span></span><span data-slate-object="text" data-key="6655"><span data-slate-leaf="true" data-offset-key="6655:0" data-first-offset="true"><span data-slate-string="true">(buffer, n), </span></span></span><span data-slate-object="text" data-key="6656"><span data-slate-leaf="true" data-offset-key="6656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">physical</span></span></span></span><span data-slate-object="text" data-key="6657"><span data-slate-leaf="true" data-offset-key="6657:0" data-first-offset="true"><span data-slate-string="true">(buffer, n))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6658"><span data-slate-object="text" data-key="6659"><span data-slate-leaf="true" data-offset-key="6659:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6660"><span data-slate-object="text" data-key="6661"><span data-slate-leaf="true" data-offset-key="6661:0" data-first-offset="true"><span data-slate-string="true">我来给你解释下具体的实现方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6662"><span data-slate-object="text" data-key="6663"><span data-slate-leaf="true" data-offset-key="6663:0" data-first-offset="true"><span data-slate-string="true">这个方法返回一个 OffsetPosition 类型。该类有两个方法，分别返回索引项的 Key 和 Value。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6664"><span data-slate-object="text" data-key="6665"><span data-slate-leaf="true" data-offset-key="6665:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这里的 parseEntry 方法，就是要构造 OffsetPosition 所需的 Key 和 Value</span></span></span></span><span data-slate-object="text" data-key="6666"><span data-slate-leaf="true" data-offset-key="6666:0" data-first-offset="true"><span data-slate-string="true">。Key 是索引项中的完整位移值，</span></span></span><span data-slate-object="text" data-key="6667"><span data-slate-leaf="true" data-offset-key="6667:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">代码使用 baseOffset + relativeOffset (buffer, n) 的方式将相对位移值还原成完整位移值</span></span></span></span><span data-slate-object="text" data-key="6668"><span data-slate-leaf="true" data-offset-key="6668:0" data-first-offset="true"><span data-slate-string="true">；Value 是这个位移值上消息在日志段文件中的物理位置，代码调用 physical 方法计算这个物理位置并把它作为 Value。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6669"><span data-slate-object="text" data-key="6670"><span data-slate-leaf="true" data-offset-key="6670:0" data-first-offset="true"><span data-slate-string="true">最后，parseEntry 方法把 Key 和 Value 封装到一个 OffsetPosition 实例中，然后将这个实例返回。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6671"><span data-slate-object="text" data-key="6672"><span data-slate-leaf="true" data-offset-key="6672:0" data-first-offset="true"><span data-slate-string="true">由于索引文件的总字节数就是索引项字节数乘以索引项数，因此，代码结合 entrySize 和 buffer.getInt 方法能够轻松地计算出第 n 个索引项所处的物理文件位置。这就是 physical 方法做的事情。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6673" id="sr-toc-3"><span data-slate-object="text" data-key="6674"><span data-slate-leaf="true" data-offset-key="6674:0" data-first-offset="true"><span data-slate-string="true">写入索引项</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6675"><span data-slate-object="text" data-key="6676"><span data-slate-leaf="true" data-offset-key="6676:0" data-first-offset="true"><span data-slate-string="true">好了，有了这些基础，下面的内容就很容易理解了。我们来看下 OffsetIndex 中最重要的操作 ——</span></span></span><span data-slate-object="text" data-key="6677"><span data-slate-leaf="true" data-offset-key="6677:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 写入索引项 append 方法的实现</span></span></span></span><span data-slate-object="text" data-key="6678"><span data-slate-leaf="true" data-offset-key="6678:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="6679"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6680"><span data-slate-object="text" data-key="6681"><span data-slate-leaf="true" data-offset-key="6681:0" data-first-offset="true"><span data-slate-string="true">def append(offset: Long, position: Int): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6682"><span data-slate-object="text" data-key="6683"><span data-slate-leaf="true" data-offset-key="6683:0" data-first-offset="true"><span data-slate-string="true">  inLock(lock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6684"><span data-slate-object="text" data-key="6685"><span data-slate-leaf="true" data-offset-key="6685:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6686"><span data-slate-leaf="true" data-offset-key="6686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 索引文件如果已经写满，直接抛出异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6687"><span data-slate-object="text" data-key="6688"><span data-slate-leaf="true" data-offset-key="6688:0" data-first-offset="true"><span data-slate-string="true">    require(!isFull, </span></span></span><span data-slate-object="text" data-key="6689"><span data-slate-leaf="true" data-offset-key="6689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Attempt to append to a full index (size ="</span></span></span></span><span data-slate-object="text" data-key="6690"><span data-slate-leaf="true" data-offset-key="6690:0" data-first-offset="true"><span data-slate-string="true"> + _entries + </span></span></span><span data-slate-object="text" data-key="6691"><span data-slate-leaf="true" data-offset-key="6691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")."</span></span></span></span><span data-slate-object="text" data-key="6692"><span data-slate-leaf="true" data-offset-key="6692:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6693"><span data-slate-object="text" data-key="6694"><span data-slate-leaf="true" data-offset-key="6694:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6695"><span data-slate-leaf="true" data-offset-key="6695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 要保证待写入的位移值 offset 比当前索引文件中所有现存的位移值都要大</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6696"><span data-slate-object="text" data-key="6697"><span data-slate-leaf="true" data-offset-key="6697:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6698"><span data-slate-leaf="true" data-offset-key="6698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这主要是为了维护索引的单调增加性</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6699"><span data-slate-object="text" data-key="6700"><span data-slate-leaf="true" data-offset-key="6700:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6701"><span data-slate-leaf="true" data-offset-key="6701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6702"><span data-slate-leaf="true" data-offset-key="6702:0" data-first-offset="true"><span data-slate-string="true"> (_entries == </span></span></span><span data-slate-object="text" data-key="6703"><span data-slate-leaf="true" data-offset-key="6703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6704"><span data-slate-leaf="true" data-offset-key="6704:0" data-first-offset="true"><span data-slate-string="true"> || offset &gt; _lastOffset) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6705"><span data-slate-object="text" data-key="6706"><span data-slate-leaf="true" data-offset-key="6706:0" data-first-offset="true"><span data-slate-string="true">      trace(s</span></span></span><span data-slate-object="text" data-key="6707"><span data-slate-leaf="true" data-offset-key="6707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Adding index entry </span></span></span></span><span data-slate-object="text" data-key="6708"><span data-slate-leaf="true" data-offset-key="6708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$offset</span></span></span></span></span><span data-slate-object="text" data-key="6709"><span data-slate-leaf="true" data-offset-key="6709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt; </span></span></span></span><span data-slate-object="text" data-key="6710"><span data-slate-leaf="true" data-offset-key="6710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$position</span></span></span></span></span><span data-slate-object="text" data-key="6711"><span data-slate-leaf="true" data-offset-key="6711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> to </span></span></span></span><span data-slate-object="text" data-key="6712"><span data-slate-leaf="true" data-offset-key="6712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${file.getAbsolutePath}</span></span></span></span></span><span data-slate-object="text" data-key="6713"><span data-slate-leaf="true" data-offset-key="6713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="6714"><span data-slate-leaf="true" data-offset-key="6714:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6715"><span data-slate-object="text" data-key="6716"><span data-slate-leaf="true" data-offset-key="6716:0" data-first-offset="true"><span data-slate-string="true">      mmap.putInt(relativeOffset(offset)) </span></span></span><span data-slate-object="text" data-key="6717"><span data-slate-leaf="true" data-offset-key="6717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向 mmap 写入相对位移值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6718"><span data-slate-object="text" data-key="6719"><span data-slate-leaf="true" data-offset-key="6719:0" data-first-offset="true"><span data-slate-string="true">      mmap.putInt(position) </span></span></span><span data-slate-object="text" data-key="6720"><span data-slate-leaf="true" data-offset-key="6720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向 mmap 写入物理文件位置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6721"><span data-slate-object="text" data-key="6722"><span data-slate-leaf="true" data-offset-key="6722:0" data-first-offset="true"><span data-slate-string="true">      _entries += </span></span></span><span data-slate-object="text" data-key="6723"><span data-slate-leaf="true" data-offset-key="6723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="6724"><span data-slate-leaf="true" data-offset-key="6724:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6725"><span data-slate-leaf="true" data-offset-key="6725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新索引项个数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6726"><span data-slate-object="text" data-key="6727"><span data-slate-leaf="true" data-offset-key="6727:0" data-first-offset="true"><span data-slate-string="true">      _lastOffset = offset </span></span></span><span data-slate-object="text" data-key="6728"><span data-slate-leaf="true" data-offset-key="6728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新当前索引文件最大位移值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6729"><span data-slate-object="text" data-key="6730"><span data-slate-leaf="true" data-offset-key="6730:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6731"><span data-slate-leaf="true" data-offset-key="6731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 确保写入索引项格式符合要求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6732"><span data-slate-object="text" data-key="6733"><span data-slate-leaf="true" data-offset-key="6733:0" data-first-offset="true"><span data-slate-string="true">      require(_entries * entrySize == mmap.position(), s</span></span></span><span data-slate-object="text" data-key="6734"><span data-slate-leaf="true" data-offset-key="6734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="6735"><span data-slate-leaf="true" data-offset-key="6735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$entries</span></span></span></span></span><span data-slate-object="text" data-key="6736"><span data-slate-leaf="true" data-offset-key="6736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> entries but file position in index is </span></span></span></span><span data-slate-object="text" data-key="6737"><span data-slate-leaf="true" data-offset-key="6737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${mmap.position()}</span></span></span></span></span><span data-slate-object="text" data-key="6738"><span data-slate-leaf="true" data-offset-key="6738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">."</span></span></span></span><span data-slate-object="text" data-key="6739"><span data-slate-leaf="true" data-offset-key="6739:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6740"><span data-slate-object="text" data-key="6741"><span data-slate-leaf="true" data-offset-key="6741:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="6742"><span data-slate-leaf="true" data-offset-key="6742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="6743"><span data-slate-leaf="true" data-offset-key="6743:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6744"><span data-slate-object="text" data-key="6745"><span data-slate-leaf="true" data-offset-key="6745:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6746"><span data-slate-leaf="true" data-offset-key="6746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="6747"><span data-slate-leaf="true" data-offset-key="6747:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6748"><span data-slate-leaf="true" data-offset-key="6748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="6749"><span data-slate-leaf="true" data-offset-key="6749:0" data-first-offset="true"><span data-slate-string="true"> InvalidOffsetException(s</span></span></span><span data-slate-object="text" data-key="6750"><span data-slate-leaf="true" data-offset-key="6750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Attempt to append an offset (</span></span></span></span><span data-slate-object="text" data-key="6751"><span data-slate-leaf="true" data-offset-key="6751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$offset</span></span></span></span></span><span data-slate-object="text" data-key="6752"><span data-slate-leaf="true" data-offset-key="6752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) to position </span></span></span></span><span data-slate-object="text" data-key="6753"><span data-slate-leaf="true" data-offset-key="6753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$entries</span></span></span></span></span><span data-slate-object="text" data-key="6754"><span data-slate-leaf="true" data-offset-key="6754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> no larger than"</span></span></span></span><span data-slate-object="text" data-key="6755"><span data-slate-leaf="true" data-offset-key="6755:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6756"><span data-slate-object="text" data-key="6757"><span data-slate-leaf="true" data-offset-key="6757:0" data-first-offset="true"><span data-slate-string="true">        s</span></span></span><span data-slate-object="text" data-key="6758"><span data-slate-leaf="true" data-offset-key="6758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">" the last offset appended (</span></span></span></span><span data-slate-object="text" data-key="6759"><span data-slate-leaf="true" data-offset-key="6759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${_lastOffset}</span></span></span></span></span><span data-slate-object="text" data-key="6760"><span data-slate-leaf="true" data-offset-key="6760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) to </span></span></span></span><span data-slate-object="text" data-key="6761"><span data-slate-leaf="true" data-offset-key="6761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${file.getAbsolutePath}</span></span></span></span></span><span data-slate-object="text" data-key="6762"><span data-slate-leaf="true" data-offset-key="6762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">."</span></span></span></span><span data-slate-object="text" data-key="6763"><span data-slate-leaf="true" data-offset-key="6763:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6764"><span data-slate-object="text" data-key="6765"><span data-slate-leaf="true" data-offset-key="6765:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6766"><span data-slate-object="text" data-key="6767"><span data-slate-leaf="true" data-offset-key="6767:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6768"><span data-slate-object="text" data-key="6769"><span data-slate-leaf="true" data-offset-key="6769:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6770"><span data-slate-object="text" data-key="6771"><span data-slate-leaf="true" data-offset-key="6771:0" data-first-offset="true"><span data-slate-string="true">append 方法接收两个参数：</span></span></span><span data-slate-object="text" data-key="6772"><span data-slate-leaf="true" data-offset-key="6772:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Long 型的位移值</span></span></span></span><span data-slate-object="text" data-key="6773"><span data-slate-leaf="true" data-offset-key="6773:0" data-first-offset="true"><span data-slate-string="true">和 </span></span></span><span data-slate-object="text" data-key="6774"><span data-slate-leaf="true" data-offset-key="6774:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Integer 型的物理文件位置</span></span></span></span><span data-slate-object="text" data-key="6775"><span data-slate-leaf="true" data-offset-key="6775:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span><span data-slate-object="text" data-key="6776"><span data-slate-leaf="true" data-offset-key="6776:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">该方法最重要的两步，就是分别向 mmap 写入相对位移值和物理文件位置</span></span></span></span><span data-slate-object="text" data-key="6777"><span data-slate-leaf="true" data-offset-key="6777:0" data-first-offset="true"><span data-slate-string="true">。我使用一张图，来总结下 append 方法的执行流程：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6778"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/17/e6/176bec3d45790509c0587614be7f61e6.jpg?wh=2568*3354"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6779"><span data-slate-object="text" data-key="6780"><span data-slate-leaf="true" data-offset-key="6780:0" data-first-offset="true"><span data-slate-string="true">除了 append 方法，索引还有一个常见的操作：截断操作（Truncation）。</span></span></span><span data-slate-object="text" data-key="6781"><span data-slate-leaf="true" data-offset-key="6781:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">截断操作是指，将索引文件内容直接裁剪掉一部分</span></span></span></span><span data-slate-object="text" data-key="6782"><span data-slate-leaf="true" data-offset-key="6782:0" data-first-offset="true"><span data-slate-string="true">。比如，OffsetIndex 索引文件中当前保存了 100 个索引项，我想只保留最开始的 40 个索引项。源码定义了 truncateToEntries 方法来实现这个需求：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="6783"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6784"><span data-slate-object="text" data-key="6785"><span data-slate-leaf="true" data-offset-key="6785:0" data-first-offset="true"><span data-slate-string="true">private def truncateToEntries(entries: Int): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6786"><span data-slate-object="text" data-key="6787"><span data-slate-leaf="true" data-offset-key="6787:0" data-first-offset="true"><span data-slate-string="true">  inLock(lock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6788"><span data-slate-object="text" data-key="6789"><span data-slate-leaf="true" data-offset-key="6789:0" data-first-offset="true"><span data-slate-string="true">    _entries = entries</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6790"><span data-slate-object="text" data-key="6791"><span data-slate-leaf="true" data-offset-key="6791:0" data-first-offset="true"><span data-slate-string="true">    mmap.position(_entries * entrySize)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6792"><span data-slate-object="text" data-key="6793"><span data-slate-leaf="true" data-offset-key="6793:0" data-first-offset="true"><span data-slate-string="true">    _lastOffset = lastEntry.offset</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6794"><span data-slate-object="text" data-key="6795"><span data-slate-leaf="true" data-offset-key="6795:0" data-first-offset="true"><span data-slate-string="true">    debug(s</span></span></span><span data-slate-object="text" data-key="6796"><span data-slate-leaf="true" data-offset-key="6796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Truncated index </span></span></span></span><span data-slate-object="text" data-key="6797"><span data-slate-leaf="true" data-offset-key="6797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${file.getAbsolutePath}</span></span></span></span></span><span data-slate-object="text" data-key="6798"><span data-slate-leaf="true" data-offset-key="6798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> to </span></span></span></span><span data-slate-object="text" data-key="6799"><span data-slate-leaf="true" data-offset-key="6799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$entries</span></span></span></span></span><span data-slate-object="text" data-key="6800"><span data-slate-leaf="true" data-offset-key="6800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> entries;"</span></span></span></span><span data-slate-object="text" data-key="6801"><span data-slate-leaf="true" data-offset-key="6801:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6802"><span data-slate-object="text" data-key="6803"><span data-slate-leaf="true" data-offset-key="6803:0" data-first-offset="true"><span data-slate-string="true">      s</span></span></span><span data-slate-object="text" data-key="6804"><span data-slate-leaf="true" data-offset-key="6804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">" position is now </span></span></span></span><span data-slate-object="text" data-key="6805"><span data-slate-leaf="true" data-offset-key="6805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${mmap.position()}</span></span></span></span></span><span data-slate-object="text" data-key="6806"><span data-slate-leaf="true" data-offset-key="6806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> and last offset is now </span></span></span></span><span data-slate-object="text" data-key="6807"><span data-slate-leaf="true" data-offset-key="6807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${_lastOffset}</span></span></span></span></span><span data-slate-object="text" data-key="6808"><span data-slate-leaf="true" data-offset-key="6808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="6809"><span data-slate-leaf="true" data-offset-key="6809:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6810"><span data-slate-object="text" data-key="6811"><span data-slate-leaf="true" data-offset-key="6811:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6812"><span data-slate-object="text" data-key="6813"><span data-slate-leaf="true" data-offset-key="6813:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6814"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6815"><span data-slate-object="text" data-key="6816"><span data-slate-leaf="true" data-offset-key="6816:0" data-first-offset="true"><span data-slate-string="true">这个方法接收 entries 参数，表示</span></span></span><span data-slate-object="text" data-key="6817"><span data-slate-leaf="true" data-offset-key="6817:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">要截取到哪个槽</span></span></span></span><span data-slate-object="text" data-key="6818"><span data-slate-leaf="true" data-offset-key="6818:0" data-first-offset="true"><span data-slate-string="true">，主要的逻辑实现是调用 mmap 的 position 方法。源码中的 _entries * entrySize 就是 mmap 要截取到的字节处。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6819"><span data-slate-object="text" data-key="6820"><span data-slate-leaf="true" data-offset-key="6820:0" data-first-offset="true"><span data-slate-string="true">下面，我来说说 OffsetIndex 的使用方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6821"><span data-slate-object="text" data-key="6822"><span data-slate-leaf="true" data-offset-key="6822:0" data-first-offset="true"><span data-slate-string="true">既然 OffsetIndex 被用来快速定位消息所在的物理文件位置，那么必然需要定义一个方法执行对应的查询逻辑。这个方法就是 lookup。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="6823"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6824"><span data-slate-object="text" data-key="6825"><span data-slate-leaf="true" data-offset-key="6825:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="6826"><span data-slate-leaf="true" data-offset-key="6826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">lookup</span></span></span></span><span data-slate-object="text" data-key="6827"><span data-slate-leaf="true" data-offset-key="6827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(targetOffset: Long)</span></span></span></span><span data-slate-object="text" data-key="6828"><span data-slate-leaf="true" data-offset-key="6828:0" data-first-offset="true"><span data-slate-string="true">: OffsetPosition = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6829"><span data-slate-object="text" data-key="6830"><span data-slate-leaf="true" data-offset-key="6830:0" data-first-offset="true"><span data-slate-string="true">  maybeLock(lock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6831"><span data-slate-object="text" data-key="6832"><span data-slate-leaf="true" data-offset-key="6832:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6833"><span data-slate-leaf="true" data-offset-key="6833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="6834"><span data-slate-leaf="true" data-offset-key="6834:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6835"><span data-slate-leaf="true" data-offset-key="6835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">idx</span></span></span></span><span data-slate-object="text" data-key="6836"><span data-slate-leaf="true" data-offset-key="6836:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6837"><span data-slate-leaf="true" data-offset-key="6837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="6838"><span data-slate-leaf="true" data-offset-key="6838:0" data-first-offset="true"><span data-slate-string="true"> mmap.duplicate </span></span></span><span data-slate-object="text" data-key="6839"><span data-slate-leaf="true" data-offset-key="6839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 使用私有变量复制出整个索引映射区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6840"><span data-slate-object="text" data-key="6841"><span data-slate-leaf="true" data-offset-key="6841:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6842"><span data-slate-leaf="true" data-offset-key="6842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//largestLowerBoundSlotFor 方法底层使用了改进版的二分查找算法寻找对应的槽</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6843"><span data-slate-object="text" data-key="6844"><span data-slate-leaf="true" data-offset-key="6844:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6845"><span data-slate-leaf="true" data-offset-key="6845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="6846"><span data-slate-leaf="true" data-offset-key="6846:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6847"><span data-slate-leaf="true" data-offset-key="6847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">slot</span></span></span></span><span data-slate-object="text" data-key="6848"><span data-slate-leaf="true" data-offset-key="6848:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6849"><span data-slate-leaf="true" data-offset-key="6849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="6850"><span data-slate-leaf="true" data-offset-key="6850:0" data-first-offset="true"><span data-slate-string="true"> largestLowerBoundSlotFor(idx, targetOffset, IndexSearchType.KEY)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6851"><span data-slate-object="text" data-key="6852"><span data-slate-leaf="true" data-offset-key="6852:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6853"><span data-slate-leaf="true" data-offset-key="6853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果没找到，返回一个空的位置，即物理文件位置从 0 开始，表示从头读日志文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6854"><span data-slate-object="text" data-key="6855"><span data-slate-leaf="true" data-offset-key="6855:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6856"><span data-slate-leaf="true" data-offset-key="6856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 否则返回 slot 槽对应的索引项</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6857"><span data-slate-object="text" data-key="6858"><span data-slate-leaf="true" data-offset-key="6858:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6859"><span data-slate-leaf="true" data-offset-key="6859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6860"><span data-slate-leaf="true" data-offset-key="6860:0" data-first-offset="true"><span data-slate-string="true">(slot == -</span></span></span><span data-slate-object="text" data-key="6861"><span data-slate-leaf="true" data-offset-key="6861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="6862"><span data-slate-leaf="true" data-offset-key="6862:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6863"><span data-slate-object="text" data-key="6864"><span data-slate-leaf="true" data-offset-key="6864:0" data-first-offset="true"><span data-slate-string="true">      OffsetPosition(baseOffset, </span></span></span><span data-slate-object="text" data-key="6865"><span data-slate-leaf="true" data-offset-key="6865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6866"><span data-slate-leaf="true" data-offset-key="6866:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6867"><span data-slate-object="text" data-key="6868"><span data-slate-leaf="true" data-offset-key="6868:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6869"><span data-slate-leaf="true" data-offset-key="6869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6870"><span data-slate-object="text" data-key="6871"><span data-slate-leaf="true" data-offset-key="6871:0" data-first-offset="true"><span data-slate-string="true">      parseEntry(idx, slot)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6872"><span data-slate-object="text" data-key="6873"><span data-slate-leaf="true" data-offset-key="6873:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6874"><span data-slate-object="text" data-key="6875"><span data-slate-leaf="true" data-offset-key="6875:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6876"><span data-slate-object="text" data-key="6877"><span data-slate-leaf="true" data-offset-key="6877:0" data-first-offset="true"><span data-slate-string="true">我把主要的逻辑以注释的方式加到了代码中。该方法返回的，是不大于给定位移值 targetOffset 的最大位移值，以及对应的物理文件位置。你大致可以把这个方法，理解为位移值的 FLOOR 函数。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6878" id="sr-toc-4"><span data-slate-object="text" data-key="6879"><span data-slate-leaf="true" data-offset-key="6879:0" data-first-offset="true"><span data-slate-string="true">时间戳索引</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6880"><span data-slate-object="text" data-key="6881"><span data-slate-leaf="true" data-offset-key="6881:0" data-first-offset="true"><span data-slate-string="true">说完了 OffsetIndex，我们来看另一大类索引：时间戳索引，即 TimeIndex。与 OffsetIndex 类似，我们重点关注 TimeIndex 中索引项的定义，以及如何写入 TimeIndex 索引项。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6882" id="sr-toc-5"><span data-slate-object="text" data-key="6883"><span data-slate-leaf="true" data-offset-key="6883:0" data-first-offset="true"><span data-slate-string="true">索引项的定义</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6884"><span data-slate-object="text" data-key="6885"><span data-slate-leaf="true" data-offset-key="6885:0" data-first-offset="true"><span data-slate-string="true">与 OffsetIndex 不同的是，TimeIndex 保存的是 &lt;时间戳，相对位移值&gt; 对。时间戳需要一个长整型来保存，相对位移值使用 Integer 来保存。因此，TimeIndex 单个索引项需要占用 12 个字节。这也揭示了一个重要的事实：</span></span></span><span data-slate-object="text" data-key="6886"><span data-slate-leaf="true" data-offset-key="6886:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在保存同等数量索引项的基础上，TimeIndex 会比 OffsetIndex 占用更多的磁盘空间</span></span></span></span><span data-slate-object="text" data-key="6887"><span data-slate-leaf="true" data-offset-key="6887:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6888" id="sr-toc-6"><span data-slate-object="text" data-key="6889"><span data-slate-leaf="true" data-offset-key="6889:0" data-first-offset="true"><span data-slate-string="true">写入索引项</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6890"><span data-slate-object="text" data-key="6891"><span data-slate-leaf="true" data-offset-key="6891:0" data-first-offset="true"><span data-slate-string="true">TimeIndex 也有 append 方法，只不过它叫作 maybeAppend。我们来看下它的实现逻辑。</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="6892"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6893"><span data-slate-object="text" data-key="6894"><span data-slate-leaf="true" data-offset-key="6894:0" data-first-offset="true"><span data-slate-string="true">def maybeAppend(timestamp: Long, offset: Long, skipFullCheck: Boolean = </span></span></span><span data-slate-object="text" data-key="6895"><span data-slate-leaf="true" data-offset-key="6895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="6896"><span data-slate-leaf="true" data-offset-key="6896:0" data-first-offset="true"><span data-slate-string="true">): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6897"><span data-slate-object="text" data-key="6898"><span data-slate-leaf="true" data-offset-key="6898:0" data-first-offset="true"><span data-slate-string="true">  inLock(lock) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6899"><span data-slate-object="text" data-key="6900"><span data-slate-leaf="true" data-offset-key="6900:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6901"><span data-slate-leaf="true" data-offset-key="6901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6902"><span data-slate-leaf="true" data-offset-key="6902:0" data-first-offset="true"><span data-slate-string="true"> (!skipFullCheck)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6903"><span data-slate-object="text" data-key="6904"><span data-slate-leaf="true" data-offset-key="6904:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6905"><span data-slate-leaf="true" data-offset-key="6905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果索引文件已写满，抛出异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6906"><span data-slate-object="text" data-key="6907"><span data-slate-leaf="true" data-offset-key="6907:0" data-first-offset="true"><span data-slate-string="true">      require(!isFull, </span></span></span><span data-slate-object="text" data-key="6908"><span data-slate-leaf="true" data-offset-key="6908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Attempt to append to a full time index (size ="</span></span></span></span><span data-slate-object="text" data-key="6909"><span data-slate-leaf="true" data-offset-key="6909:0" data-first-offset="true"><span data-slate-string="true"> + _entries + </span></span></span><span data-slate-object="text" data-key="6910"><span data-slate-leaf="true" data-offset-key="6910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">")."</span></span></span></span><span data-slate-object="text" data-key="6911"><span data-slate-leaf="true" data-offset-key="6911:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6912"><span data-slate-object="text" data-key="6913"><span data-slate-leaf="true" data-offset-key="6913:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6914"><span data-slate-leaf="true" data-offset-key="6914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 确保索引单调增加性</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6915"><span data-slate-object="text" data-key="6916"><span data-slate-leaf="true" data-offset-key="6916:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6917"><span data-slate-leaf="true" data-offset-key="6917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6918"><span data-slate-leaf="true" data-offset-key="6918:0" data-first-offset="true"><span data-slate-string="true"> (_entries != </span></span></span><span data-slate-object="text" data-key="6919"><span data-slate-leaf="true" data-offset-key="6919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6920"><span data-slate-leaf="true" data-offset-key="6920:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; offset &lt;lastEntry.offset)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6921"><span data-slate-object="text" data-key="6922"><span data-slate-leaf="true" data-offset-key="6922:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6923"><span data-slate-leaf="true" data-offset-key="6923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="6924"><span data-slate-leaf="true" data-offset-key="6924:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6925"><span data-slate-leaf="true" data-offset-key="6925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="6926"><span data-slate-leaf="true" data-offset-key="6926:0" data-first-offset="true"><span data-slate-string="true"> InvalidOffsetException(s</span></span></span><span data-slate-object="text" data-key="6927"><span data-slate-leaf="true" data-offset-key="6927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Attempt to append an offset (</span></span></span></span><span data-slate-object="text" data-key="6928"><span data-slate-leaf="true" data-offset-key="6928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$offset</span></span></span></span></span><span data-slate-object="text" data-key="6929"><span data-slate-leaf="true" data-offset-key="6929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) to slot </span></span></span></span><span data-slate-object="text" data-key="6930"><span data-slate-leaf="true" data-offset-key="6930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${_entries}</span></span></span></span></span><span data-slate-object="text" data-key="6931"><span data-slate-leaf="true" data-offset-key="6931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> no larger than"</span></span></span></span><span data-slate-object="text" data-key="6932"><span data-slate-leaf="true" data-offset-key="6932:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6933"><span data-slate-object="text" data-key="6934"><span data-slate-leaf="true" data-offset-key="6934:0" data-first-offset="true"><span data-slate-string="true">        s</span></span></span><span data-slate-object="text" data-key="6935"><span data-slate-leaf="true" data-offset-key="6935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">" the last offset appended (</span></span></span></span><span data-slate-object="text" data-key="6936"><span data-slate-leaf="true" data-offset-key="6936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${lastEntry.offset}</span></span></span></span></span><span data-slate-object="text" data-key="6937"><span data-slate-leaf="true" data-offset-key="6937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) to </span></span></span></span><span data-slate-object="text" data-key="6938"><span data-slate-leaf="true" data-offset-key="6938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${file.getAbsolutePath}</span></span></span></span></span><span data-slate-object="text" data-key="6939"><span data-slate-leaf="true" data-offset-key="6939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">."</span></span></span></span><span data-slate-object="text" data-key="6940"><span data-slate-leaf="true" data-offset-key="6940:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6941"><span data-slate-object="text" data-key="6942"><span data-slate-leaf="true" data-offset-key="6942:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6943"><span data-slate-leaf="true" data-offset-key="6943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 确保时间戳的单调增加性</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6944"><span data-slate-object="text" data-key="6945"><span data-slate-leaf="true" data-offset-key="6945:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6946"><span data-slate-leaf="true" data-offset-key="6946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6947"><span data-slate-leaf="true" data-offset-key="6947:0" data-first-offset="true"><span data-slate-string="true"> (_entries != </span></span></span><span data-slate-object="text" data-key="6948"><span data-slate-leaf="true" data-offset-key="6948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6949"><span data-slate-leaf="true" data-offset-key="6949:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; timestamp &lt;lastEntry.timestamp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6950"><span data-slate-object="text" data-key="6951"><span data-slate-leaf="true" data-offset-key="6951:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6952"><span data-slate-leaf="true" data-offset-key="6952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throw</span></span></span></span><span data-slate-object="text" data-key="6953"><span data-slate-leaf="true" data-offset-key="6953:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6954"><span data-slate-leaf="true" data-offset-key="6954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="6955"><span data-slate-leaf="true" data-offset-key="6955:0" data-first-offset="true"><span data-slate-string="true"> IllegalStateException(s</span></span></span><span data-slate-object="text" data-key="6956"><span data-slate-leaf="true" data-offset-key="6956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Attempt to append a timestamp (</span></span></span></span><span data-slate-object="text" data-key="6957"><span data-slate-leaf="true" data-offset-key="6957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$timestamp</span></span></span></span></span><span data-slate-object="text" data-key="6958"><span data-slate-leaf="true" data-offset-key="6958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) to slot </span></span></span></span><span data-slate-object="text" data-key="6959"><span data-slate-leaf="true" data-offset-key="6959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${_entries}</span></span></span></span></span><span data-slate-object="text" data-key="6960"><span data-slate-leaf="true" data-offset-key="6960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> no larger"</span></span></span></span><span data-slate-object="text" data-key="6961"><span data-slate-leaf="true" data-offset-key="6961:0" data-first-offset="true"><span data-slate-string="true"> +</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6962"><span data-slate-object="text" data-key="6963"><span data-slate-leaf="true" data-offset-key="6963:0" data-first-offset="true"><span data-slate-string="true">        s</span></span></span><span data-slate-object="text" data-key="6964"><span data-slate-leaf="true" data-offset-key="6964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">" than the last timestamp appended (</span></span></span></span><span data-slate-object="text" data-key="6965"><span data-slate-leaf="true" data-offset-key="6965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${lastEntry.timestamp}</span></span></span></span></span><span data-slate-object="text" data-key="6966"><span data-slate-leaf="true" data-offset-key="6966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">) to </span></span></span></span><span data-slate-object="text" data-key="6967"><span data-slate-leaf="true" data-offset-key="6967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${file.getAbsolutePath}</span></span></span></span></span><span data-slate-object="text" data-key="6968"><span data-slate-leaf="true" data-offset-key="6968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">."</span></span></span></span><span data-slate-object="text" data-key="6969"><span data-slate-leaf="true" data-offset-key="6969:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6970"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6971"><span data-slate-object="text" data-key="6972"><span data-slate-leaf="true" data-offset-key="6972:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6973"><span data-slate-leaf="true" data-offset-key="6973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6974"><span data-slate-leaf="true" data-offset-key="6974:0" data-first-offset="true"><span data-slate-string="true"> (timestamp&gt; lastEntry.timestamp) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6975"><span data-slate-object="text" data-key="6976"><span data-slate-leaf="true" data-offset-key="6976:0" data-first-offset="true"><span data-slate-string="true">      trace(s</span></span></span><span data-slate-object="text" data-key="6977"><span data-slate-leaf="true" data-offset-key="6977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Adding index entry </span></span></span></span><span data-slate-object="text" data-key="6978"><span data-slate-leaf="true" data-offset-key="6978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$timestamp</span></span></span></span></span><span data-slate-object="text" data-key="6979"><span data-slate-leaf="true" data-offset-key="6979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> =&gt; </span></span></span></span><span data-slate-object="text" data-key="6980"><span data-slate-leaf="true" data-offset-key="6980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$offset</span></span></span></span></span><span data-slate-object="text" data-key="6981"><span data-slate-leaf="true" data-offset-key="6981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> to </span></span></span></span><span data-slate-object="text" data-key="6982"><span data-slate-leaf="true" data-offset-key="6982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${file.getAbsolutePath}</span></span></span></span></span><span data-slate-object="text" data-key="6983"><span data-slate-leaf="true" data-offset-key="6983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">."</span></span></span></span><span data-slate-object="text" data-key="6984"><span data-slate-leaf="true" data-offset-key="6984:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6985"><span data-slate-object="text" data-key="6986"><span data-slate-leaf="true" data-offset-key="6986:0" data-first-offset="true"><span data-slate-string="true">      mmap.putLong(timestamp) </span></span></span><span data-slate-object="text" data-key="6987"><span data-slate-leaf="true" data-offset-key="6987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向 mmap 写入时间戳</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6988"><span data-slate-object="text" data-key="6989"><span data-slate-leaf="true" data-offset-key="6989:0" data-first-offset="true"><span data-slate-string="true">      mmap.putInt(relativeOffset(offset)) </span></span></span><span data-slate-object="text" data-key="6990"><span data-slate-leaf="true" data-offset-key="6990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向 mmap 写入相对位移值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6991"><span data-slate-object="text" data-key="6992"><span data-slate-leaf="true" data-offset-key="6992:0" data-first-offset="true"><span data-slate-string="true">      _entries += </span></span></span><span data-slate-object="text" data-key="6993"><span data-slate-leaf="true" data-offset-key="6993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="6994"><span data-slate-leaf="true" data-offset-key="6994:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6995"><span data-slate-leaf="true" data-offset-key="6995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新索引项个数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6996"><span data-slate-object="text" data-key="6997"><span data-slate-leaf="true" data-offset-key="6997:0" data-first-offset="true"><span data-slate-string="true">      _lastEntry = TimestampOffset(timestamp, offset) </span></span></span><span data-slate-object="text" data-key="6998"><span data-slate-leaf="true" data-offset-key="6998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新当前最新的索引项</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6999"><span data-slate-object="text" data-key="7000"><span data-slate-leaf="true" data-offset-key="7000:0" data-first-offset="true"><span data-slate-string="true">      require(_entries * entrySize == mmap.position(), s</span></span></span><span data-slate-object="text" data-key="7001"><span data-slate-leaf="true" data-offset-key="7001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="7002"><span data-slate-leaf="true" data-offset-key="7002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${_entries}</span></span></span></span></span><span data-slate-object="text" data-key="7003"><span data-slate-leaf="true" data-offset-key="7003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> entries but file position in index is </span></span></span></span><span data-slate-object="text" data-key="7004"><span data-slate-leaf="true" data-offset-key="7004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${mmap.position()}</span></span></span></span></span><span data-slate-object="text" data-key="7005"><span data-slate-leaf="true" data-offset-key="7005:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">."</span></span></span></span><span data-slate-object="text" data-key="7006"><span data-slate-leaf="true" data-offset-key="7006:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7007"><span data-slate-object="text" data-key="7008"><span data-slate-leaf="true" data-offset-key="7008:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7009"><span data-slate-object="text" data-key="7010"><span data-slate-leaf="true" data-offset-key="7010:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7011"><span data-slate-object="text" data-key="7012"><span data-slate-leaf="true" data-offset-key="7012:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7013"><span data-slate-object="text" data-key="7014"><span data-slate-leaf="true" data-offset-key="7014:0" data-first-offset="true"><span data-slate-string="true">和 OffsetIndex 类似，向 TimeIndex 写入索引项的主体逻辑，是向 mmap 分别写入时间戳和相对位移值。只不过，</span></span></span><span data-slate-object="text" data-key="7015"><span data-slate-leaf="true" data-offset-key="7015:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">除了校验位移值的单调增加性之外，TimeIndex 还会确保顺序写入的时间戳也是单调增加的</span></span></span></span><span data-slate-object="text" data-key="7016"><span data-slate-leaf="true" data-offset-key="7016:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7017"><span data-slate-object="text" data-key="7018"><span data-slate-leaf="true" data-offset-key="7018:0" data-first-offset="true"><span data-slate-string="true">说到这里，我想到我当年读到这段代码时候的一个想法。那个时候，这段代码还没有加上时间戳单调增加的校验逻辑，我灵机一动，萌发了向 TimeIndex 写入一个过期时间戳的想法。一番动手操作之后，我真的向 TimeIndex 索引文件中写入了一个过期时间戳和位移。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7019"><span data-slate-object="text" data-key="7020"><span data-slate-leaf="true" data-offset-key="7020:0" data-first-offset="true"><span data-slate-string="true">你猜结果怎样？结果是引发了消费者端程序的彻底混乱。这是因为，当消费者端程序根据时间戳信息去过滤待读取的消息时，它读到了这个过期的时间戳并拿到了错误的位移值，因此返回了错误的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7021"><span data-slate-object="text" data-key="7022"><span data-slate-leaf="true" data-offset-key="7022:0" data-first-offset="true"><span data-slate-string="true">为此，我还给社区提交了一个 Jira，当时被驳回了 —— 理由是不允许向 TimeIndex 写入过期时间戳。跟你说这个趣事儿只是想说明，有的时候，读源码会诱发很多灵感或奇思妙想，而这些东西是你在平时使用过程中不会想到的。这也算是阅读源码的一大收获吧。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7023" id="sr-toc-7"><span data-slate-object="text" data-key="7024"><span data-slate-leaf="true" data-offset-key="7024:0" data-first-offset="true"><span data-slate-string="true">区别</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7025"><span data-slate-object="text" data-key="7026"><span data-slate-leaf="true" data-offset-key="7026:0" data-first-offset="true"><span data-slate-string="true">讲到这里，这节课就接近尾声了。最后，我用一张表格汇总下 OffsetIndex 和 TimeIndex 的特点和区别，希望能够帮助你更好地理解和消化今天的重点内容。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="7027"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a3/78/a359ce4e81eb073a9ebed2979082b578.jpg?wh=3860*2007"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7028" id="sr-toc-8"><span data-slate-object="text" data-key="7029"><span data-slate-leaf="true" data-offset-key="7029:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7030"><span data-slate-object="text" data-key="7031"><span data-slate-leaf="true" data-offset-key="7031:0" data-first-offset="true"><span data-slate-string="true">今天，我带你详细分析了 OffsetIndex 和 TimeIndex，以及它们的不同之处。虽然 OffsetIndex 和 TimeIndex 是不同类型的索引，但 Kafka 内部是把二者结合使用的。通常的流程是，先使用 TimeIndex 寻找满足时间戳要求的消息位移值，然后再利用 OffsetIndex 去定位该位移值所在的物理文件位置。因此，它们其实是合作的关系。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7032"><span data-slate-object="text" data-key="7033"><span data-slate-leaf="true" data-offset-key="7033:0" data-first-offset="true"><span data-slate-string="true">最后，我还想提醒你一点：</span></span></span><span data-slate-object="text" data-key="7034"><span data-slate-leaf="true" data-offset-key="7034:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不要对索引文件做任何修改！</span></span></span></span><span data-slate-object="text" data-key="7035"><span data-slate-leaf="true" data-offset-key="7035:0" data-first-offset="true"><span data-slate-string="true">我碰到过因用户擅自重命名索引文件，从而导致 Broker 崩溃无法启动的场景。另外，虽然 Kafka 能够重建索引，但是随意地删除索引文件依然是一个很危险的操作。在生产环境中，我建议你尽量不要执行这样的操作。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7036" id="sr-toc-9"><span data-slate-object="text" data-key="7037"><span data-slate-leaf="true" data-offset-key="7037:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7038"><span data-slate-object="text" data-key="7039"><span data-slate-leaf="true" data-offset-key="7039:0" data-first-offset="true"><span data-slate-string="true">OffsetIndex 中的 lookup 方法实现了类似于 FLOOR 函数的位移查找逻辑。你能否对应写一个类似于 CEILING 函数的位移查找逻辑，即返回不小于给定位移值 targetOffset 的最小位移值和对应的物理文件位置？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7040"><span data-slate-object="text" data-key="7041"><span data-slate-leaf="true" data-offset-key="7041:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区畅所欲言，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-10">精选留言 (12)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们重点了解了 Kafka 索引对象以及改进版的二分查找算法，课后我让你思考下改进版二分查找算法中冷区和热区的分割线设定在 8192 字节处的原理。鉴于这是一个开放式的问题，我说下我的理解：就像源码注释里面写的那样，8192 这个数字不大不小正合适。所谓不大不小是指它并不是太小，它足以确保大多数 lagging 很小的 follower 或 consumer 都只在热区查询；同时它也不会太大，对于主流 4KB 大小的 page size 而言， 热区大约也就只占用 2~3 个页面。

okay，你是怎么考虑的呢？我们可以一起讨论下。</div><div><div>2020-04-23</div><div><div><i></i><span></span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/67/49/864dba17.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 东风第一枝</span></div></div><div>课后作业：
  def lookup (targetOffset: Long): OffsetPosition = {
    maybeLock (lock) {
      val idx = mmap.duplicate
      val slot = smallestUpperBoundSlotFor (idx, targetOffset, IndexSearchType.KEY)
      if (slot == -1)
        OffsetPosition (baseOffset, 0)
      else
        parseEntry (idx, slot)
    }
  }
// 自己重写了一下二分查找，发现有现成的方法，😆</div><div><p>作者回复：嗯嗯，可以尝试写个 test case，测试下自己的方法：）</p></div><div><div>2020-05-26</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/53/4b/28991f30.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Alpha 👀</span></div></div><div>老师您好，请问一个问题，kafka 记录消费者的消费 offset 是对消费者组，还是对单个消费者？比如一个消费者组中新加入一个消费者，分区重新分配，那新加入的消费者是从哪里开始消费？</div><div><p>作者回复：针对消费者组，或者说针对每个 group id。保存的是 &lt;groupId, topicPartition, offset&gt; 三元组。新增消费者拿到要消费的分区后，去查看有无对应的三元组记录，如果没有，则根据 consumer 端参数 auto.offset.reset 值来决定从哪里开始消费</p></div><div><div>2020-05-08</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/83/c9/5d03981a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>thomas</span></div></div><div>老师，请问建立分区初始化的时候，log-segment 的位移索引和时间索引文件将近有 10M 的数据？
---------------------------------------------------------------------------------------》
-rw-r--r--  1 root root 10485760 Apr 25 14:23 00000000000000000000.index
-rw-r--r--  1 root root        0 Apr 25 14:23 00000000000000000000.log
-rw-r--r--  1 root root 10485756 Apr 25 14:23 00000000000000000000.timeindex

</div><div><p>作者回复：里面为空，只是预分配了 10MB 的空间</p></div><div><div>2020-04-25</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/37/61/51e10a30.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>QAQ</span></div></div><div>这些涉及到 + 1，-1 的各种 offset，position 计算操作，能否补充更多的图片加以说明，例如在添加多条记录时，log 文件到底怎么变的，index 文件到底怎么变的等等</div><div><div>2021-05-13</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/df/e5/65e37812.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>快跑</span></div></div><div>从消费者的角度，如果没有 &lt;groupId, topicPartition, offset&gt; 则从 auto.offset.reset 的 offset 开始读数据，这些步骤都能直接查到 offset 吧，那 TimeIndex 是在什么场景派上用场，发挥作用的？</div><div><p>作者回复：如果你要根据时间戳查询消息，TimeIndex 就用上了</p></div><div><div>2021-03-31</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/05/7f/d35ab9a1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>z.l</span></div></div><div>思考题，直接把 lookup 方法的最后一行改成 parseEntry (idx, slot+1)，可以吗？</div><div><p>作者回复：好像不太严谨。如果出现等于的情况呢？</p></div><div><div>2020-09-04</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>对与错</span></div></div><div>有个疑问：在 leader 写入消息的时候，时间戳索引项里面是
&lt;消息集合的最后一条消息的时间戳，当前 LEO 的值&gt;,
在 flowwer 写入消息的时候，时间戳索引项里面是
&lt; 消息集合的最后一条消息的时间戳，消息集合的最后一条消息的时间戳所对应的位移值 &gt;, 为什么这么设计？</div><div><p>作者回复：逻辑是统一的，都是写入最大的时间戳以及对应的位移</p></div><div><div>2020-08-28</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/88/d7/07f8bc6c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>sljoai</span></div></div><div>胡老师，请教几个问题：
1."假设一个索引文件保存了 1000 个索引项，使用相对位移值就能节省大约 4MB 的空间，这是不是一件很划算的事情呢？!". 请问具体是怎么计算的呢？4 字节 * 1000 ？
2.relativeOffset 方法已经变了，我看到的是如下：
   private def relativeOffset (buffer: ByteBuffer, n: Int): Int = buffer.getInt (n * entrySize)
 跟本文中介绍的有所不同，该怎么理解呢？</div><div><p>作者回复: 1. 嗯，差不多是这么计算的
2. 逻辑变得更加简单了。每一个索引项都是 &lt;offset, position&gt; 对，那么第 n 项的相对位移自然就是 buffer 的 n*entrySize 字节处开始的 4 个字节表示的整数值</p></div><div><div>2020-06-09</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZcwnxGkjzENwyeEd3RZsh9tpZDeYmnT51iciaMiaLV2XRfzrJolZvUWjf3L5DuE3BmBg7uCKg3iaSzQ/132"></div></div><div><div><div><span>RonnieXie</span></div></div><div>老师，我这边对 OffsetIndex 和 TimeIndex 二者结合使用的理解有些模糊；
为什么需要一起使用，消费者不是根据 Offset 找到对于位置值开始消费就好吗？而且结合使用性能也应该降低吧？</div><div><p>作者回复：你说的没错。不过一般情况下消费者并不是直接能够定位目标 offset，相反地它是通过时间戳先找到目标 offset 的</p></div><div><div>2020-05-09</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/84/4b/e4738ba8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>delete is create</span></div></div><div>老师 如果用 kafka 实现延迟消息有没有什么好的实践    rocketmq 这块原生就支持    想了解下 kafka 怎么做</div><div><p>作者回复：只能自己写程序实现了，Kafka 没有提供这方面的机制：(</p></div><div><div>2020-04-24</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/78/d3/1dc40aa2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Jonah</span></div></div><div>我自己实现了个 ceiling，发现源码中其实有 fetchUpperBoundOffset，我和他的思路就一个差异，就是当 smallestUpperBoundSlotFor 返回 - 1 的时候，为啥要返回 None，而不是下一个插入位置？
def fetchUpperBoundOffset (fetchOffset: OffsetPosition, fetchSize: Int): Option [OffsetPosition] = {
    maybeLock (lock) {
      val idx = mmap.duplicate
      val slot = smallestUpperBoundSlotFor (idx, fetchOffset.position + fetchSize, IndexSearchType.VALUE)
      if (slot == -1)
        // 为什么不能是 OffsetPosition (lastOffset, mmap.position ())
        None
      else
        Some (parseEntry (idx, slot))
    }
  }
</div><div><p>作者回复: fetchUpperBoundOffset 找的是大于给定物理文件位置的最小位置。smallestUpperBoundSlotFor 返回 - 1 说明当前索引文件中索引项保存的物理文件位置全都比 target 小。此时，Kafka 代码就要将下一个日志段（如果存在的话）对象的起始位移值作为要寻找的位移值，这也是 Log.addAbortedTransactions 方法中 upperBoundOffset 的确认逻辑。但无论如何，fetchUpperBoundOffset 作为单个函数而言，它不应该承载这么多逻辑，如果没找到直接返回 None 是最合理的做法。</p></div><div><div>2020-04-24</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".m"><outline class="toc-level-h1" data-reactid=".m.0" style="width: 175px;"><active data-reactid=".m.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".m.0.1"><span data-reactid=".m.0.1.0">05 | 索引（下）：位移索引和时间戳索引的区别是什么？</span></a></outline><outline class="toc-level-h2" data-reactid=".m.1" style="width: 165px;"><active data-reactid=".m.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".m.1.1"><span data-reactid=".m.1.1.0">位移索引</span></a></outline><outline class="toc-level-h3" data-reactid=".m.2" style="width: 155px;"><active data-reactid=".m.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".m.2.1"><span data-reactid=".m.2.1.0">索引项的定义</span></a></outline><outline class="toc-level-h3" data-reactid=".m.3" style="width: 155px;"><active data-reactid=".m.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".m.3.1"><span data-reactid=".m.3.1.0">写入索引项</span></a></outline><outline class="toc-level-h2" data-reactid=".m.4" style="width: 165px;"><active data-reactid=".m.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".m.4.1"><span data-reactid=".m.4.1.0">时间戳索引</span></a></outline><outline class="toc-level-h3" data-reactid=".m.5" style="width: 155px;"><active data-reactid=".m.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".m.5.1"><span data-reactid=".m.5.1.0">索引项的定义</span></a></outline><outline class="toc-level-h3" data-reactid=".m.6" style="width: 155px;"><active data-reactid=".m.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".m.6.1"><span data-reactid=".m.6.1.0">写入索引项</span></a></outline><outline class="toc-level-h2" data-reactid=".m.7" style="width: 165px;"><active data-reactid=".m.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".m.7.1"><span data-reactid=".m.7.1.0">区别</span></a></outline><outline class="toc-level-h2" data-reactid=".m.8" style="width: 165px;"><active data-reactid=".m.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".m.8.1"><span data-reactid=".m.8.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".m.9" style="width: 165px;"><active data-reactid=".m.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".m.9.1"><span data-reactid=".m.9.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".m.a" style="width: 165px;"><active data-reactid=".m.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".m.a.1"><span data-reactid=".m.a.1.0">精选留言 (12)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/227601" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>