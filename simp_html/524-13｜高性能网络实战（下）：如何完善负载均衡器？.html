
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 13｜高性能网络实战（下）：如何完善负载均衡器？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>13｜高性能网络实战（下）：如何完善负载均衡器？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">13｜高性能网络实战（下）：如何完善负载均衡器？</h1><div><span>倪朋飞</span> <span> 2022-02-14</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/bf/1f/bf2d54245175098d1a6e9e9fee20211f.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：山荣</span><span>大小：14.06M</span><span> 时长：15:23</span></div></div><audio title="13｜高性能网络实战（下）：如何完善负载均衡器？" src="https://res001.geekbang.org/media/audio/d1/19/d13bbcca839bbbc1b9141c7a2e1d9c19/ld/ld.m3u8" __idm_id__="434190"></audio></div><div><div><div><div data-slate-editor="true" data-key="9017" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="9018"><span data-slate-object="text" data-key="9019"><span data-slate-leaf="true" data-offset-key="9019:0" data-first-offset="true"><span data-slate-string="true">你好，我是倪朋飞。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9020"><span data-slate-object="text" data-key="9021"><span data-slate-leaf="true" data-offset-key="9021:0" data-first-offset="true"><span data-slate-string="true">上一讲，我带你使用 sockops 和 sk_msg 等套接字 eBPF 程序，在内核态对套接字进行转发，提升了负载均衡的性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9022"><span data-slate-object="text" data-key="9023"><span data-slate-leaf="true" data-offset-key="9023:0" data-first-offset="true"><span data-slate-string="true">对于网络优化来说，除了套接字 eBPF 程序，XDP 程序和 TC 程序也可以用来优化网络的性能。特别是 XDP 程序，由于它在 Linux 内核协议栈之前就可以处理网络包，在负载均衡、防火墙等需要高性能网络的场景中已经得到大量的应用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9024"><span data-slate-object="text" data-key="9025"><span data-slate-leaf="true" data-offset-key="9025:0" data-first-offset="true"><span data-slate-string="true">XDP 程序在内核协议栈初始化之前运行，这也就意味着在 XDP 程序中，你并不能像在 sockops 等程序中那样直接获得套接字的详细信息。使用 XDP 程序加速负载均衡，通常也就意味着需要从头开发一个负载均衡程序。这是不是说 XDP 的使用就特别复杂，需要重新实现内核协议栈的很多逻辑呢？不要担心，</span></span></span><span data-slate-object="text" data-key="9026"><span data-slate-leaf="true" data-offset-key="9026:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">XDP 处理过的数据包还可以正常通过内核协议栈继续处理，所以你只需要在 XDP 程序中实现最核心的网络逻辑就可以了</span></span></span></span><span data-slate-object="text" data-key="9027"><span data-slate-leaf="true" data-offset-key="9027:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9028"><span data-slate-object="text" data-key="9029"><span data-slate-leaf="true" data-offset-key="9029:0" data-first-offset="true"><span data-slate-string="true">今天，我就以 XDP 程序为例，带你继续优化和完善负载均衡器的性能。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9030" id="sr-toc-1"><span data-slate-object="text" data-key="9031"><span data-slate-leaf="true" data-offset-key="9031:0" data-first-offset="true"><span data-slate-string="true">案例准备</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9032"><span data-slate-object="text" data-key="9033"><span data-slate-leaf="true" data-offset-key="9033:0" data-first-offset="true"><span data-slate-string="true">跟上一讲类似，为了方便环境的重现，负载均衡器、Web 服务器以及客户端都还是运行在容器中，它们的 IP 和 MAC 等基本信息如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9034"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/e9/15/e923026f577f7b991be2610734f9e415.jpg?wh=1920x1706"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9035"><span data-slate-object="text" data-key="9036"><span data-slate-leaf="true" data-offset-key="9036:0" data-first-offset="true"><span data-slate-string="true">执行下面的命令，启动这几个容器：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9037"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9038"><span data-slate-object="text" data-key="9039"><span data-slate-leaf="true" data-offset-key="9039:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># Webserver</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9040"><span data-slate-object="text" data-key="9041"><span data-slate-leaf="true" data-offset-key="9041:0" data-first-offset="true"><span data-slate-string="true">docker run -itd --name=http1 --hostname=http1 feisky/webserver</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9042"><span data-slate-object="text" data-key="9043"><span data-slate-leaf="true" data-offset-key="9043:0" data-first-offset="true"><span data-slate-string="true">docker run -itd --name=http2 --hostname=http2 feisky/webserver</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9044"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9045"><span data-slate-object="text" data-key="9046"><span data-slate-leaf="true" data-offset-key="9046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># Client</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9047"><span data-slate-object="text" data-key="9048"><span data-slate-leaf="true" data-offset-key="9048:0" data-first-offset="true"><span data-slate-string="true">docker run -itd --name=client alpine</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9049"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9050"><span data-slate-object="text" data-key="9051"><span data-slate-leaf="true" data-offset-key="9051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># LB</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9052"><span data-slate-object="text" data-key="9053"><span data-slate-leaf="true" data-offset-key="9053:0" data-first-offset="true"><span data-slate-string="true">docker run -itd --name=lb --privileged -v /sys/kernel/debug:/sys/kernel/debug alpine</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="block-quote" data-slate-object="block" data-key="9054"><div data-slate-type="quote-line" data-slate-object="block" data-key="9055"><span data-slate-object="text" data-key="9056"><span data-slate-leaf="true" data-offset-key="9056:0" data-first-offset="true"><span data-slate-string="true">小提示：在默认安装的 Docker 环境中，假如你没有运行其他容器，运行上述命令后得到的 IP 地址跟图中是相同的。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9057"><span data-slate-object="text" data-key="9058"><span data-slate-leaf="true" data-offset-key="9058:0" data-first-offset="true"><span data-slate-string="true">注意，我们把作为负载均衡器的 Nginx 换成了基于 alpine 镜像的 SHELL 容器，并且以特权容器的方式运行，以便有足够的权限加载并运行 XDP 程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9059"><span data-slate-object="text" data-key="9060"><span data-slate-leaf="true" data-offset-key="9060:0" data-first-offset="true"><span data-slate-string="true">把 XDP 程序放入容器中，除了容易复现案例环境之外，在开发和调试 XDP 程序的过程中也不会影响主机的网络（否则，错误的 XDP 程序可能导致主机网络中断，进而也会影响远程 SSH 连接）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9061"><span data-slate-object="text" data-key="9062"><span data-slate-leaf="true" data-offset-key="9062:0" data-first-offset="true"><span data-slate-string="true">由于负载均衡容器只启动了一个 SHELL 环境，并没有运行真正的负载均衡服务。此时，访问负载均衡器的 TCP 80 端口会直接失败。你可以运行下面的命令到客户端容器中验证（</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9063"><span data-slate-object="text" data-key="9064"><span data-slate-leaf="true" data-offset-key="9064:0" data-first-offset="true"><span data-slate-string="true">/ #</span></span></span></span><span data-slate-object="text" data-key="9065"><span data-slate-leaf="true" data-offset-key="9065:0" data-first-offset="true"><span data-slate-string="true"> 后的命令表示在容器终端中运行）：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9066"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9067"><span data-slate-object="text" data-key="9068"><span data-slate-leaf="true" data-offset-key="9068:0" data-first-offset="true"><span data-slate-string="true">docker </span></span></span><span data-slate-object="text" data-key="9069"><span data-slate-leaf="true" data-offset-key="9069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exec</span></span></span></span><span data-slate-object="text" data-key="9070"><span data-slate-leaf="true" data-offset-key="9070:0" data-first-offset="true"><span data-slate-string="true"> -it client sh</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9071"><span data-slate-object="text" data-key="9072"><span data-slate-leaf="true" data-offset-key="9072:0" data-first-offset="true"><span data-slate-string="true">/ </span></span></span><span data-slate-object="text" data-key="9073"><span data-slate-leaf="true" data-offset-key="9073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># apk add curl --update</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9074"><span data-slate-object="text" data-key="9075"><span data-slate-leaf="true" data-offset-key="9075:0" data-first-offset="true"><span data-slate-string="true">/ </span></span></span><span data-slate-object="text" data-key="9076"><span data-slate-leaf="true" data-offset-key="9076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># curl "http://172.17.0.5"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9077"><span data-slate-object="text" data-key="9078"><span data-slate-leaf="true" data-offset-key="9078:0" data-first-offset="true"><span data-slate-string="true">curl: (7) Failed to connect to 172.17.0.5 port 80 after 1 ms: Connection refused</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9079"><span data-slate-object="text" data-key="9080"><span data-slate-leaf="true" data-offset-key="9080:0" data-first-offset="true"><span data-slate-string="true">案例所需的容器环境启动完毕后，接下来我们再来看看，如何使用 XDP 开发一个负载均衡服务。由于需要把 XDP 字节码放到容器中运行，本着最小依赖的原则，我们将使用 libbpf 作为 XDP 的基础库，这样只需要把编译后的二进制文件放入容器中即可运行。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9081" id="sr-toc-2"><span data-slate-object="text" data-key="9082"><span data-slate-leaf="true" data-offset-key="9082:0" data-first-offset="true"><span data-slate-string="true">如何用 XDP 开发一个负载均衡器？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9083"><span data-slate-object="text" data-key="9084"><span data-slate-leaf="true" data-offset-key="9084:0" data-first-offset="true"><span data-slate-string="true">还记得我在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9085"><span data-slate-object="text" data-key="9086"><span data-slate-leaf="true" data-offset-key="9086:0" data-first-offset="true"><span data-slate-string="true"> 08 讲</span></span></span></a><span data-slate-object="text" data-key="9087"><span data-slate-leaf="true" data-offset-key="9087:0" data-first-offset="true"><span data-slate-string="true"> 中提到过的基于 libbpf 开发 eBPF 程序的基本步骤吗？不记得也没关系，我们再来回顾一下。 libbpf 的使用通常分为以下几步：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9088"><div data-slate-type="list-line" data-slate-object="block" data-key="9089"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="9090"><span data-slate-leaf="true" data-offset-key="9090:0" data-first-offset="true"><span data-slate-string="true">开发 eBPF 程序，并把源文件命名为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9091"><span data-slate-object="text" data-key="9092"><span data-slate-leaf="true" data-offset-key="9092:0" data-first-offset="true"><span data-slate-string="true">&lt;程序名&gt;.bpf.c</span></span></span></span><span data-slate-object="text" data-key="9093"><span data-slate-leaf="true" data-offset-key="9093:0" data-first-offset="true"><span data-slate-string="true">；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="9094"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="9095"><span data-slate-leaf="true" data-offset-key="9095:0" data-first-offset="true"><span data-slate-string="true">编译 eBPF 程序为字节码，然后再调用 &nbsp;</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9096"><span data-slate-object="text" data-key="9097"><span data-slate-leaf="true" data-offset-key="9097:0" data-first-offset="true"><span data-slate-string="true">bpftool gen skeleton</span></span></span></span><span data-slate-object="text" data-key="9098"><span data-slate-leaf="true" data-offset-key="9098:0" data-first-offset="true"><span data-slate-string="true">&nbsp; 为 eBPF 字节码生成脚手架头文件；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="9099"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="9100"><span data-slate-leaf="true" data-offset-key="9100:0" data-first-offset="true"><span data-slate-string="true">开发用户态程序，引入生成的脚手架头文件后，加载 eBPF 程序并挂载到相应的内核事件中。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9101"><span data-slate-object="text" data-key="9102"><span data-slate-leaf="true" data-offset-key="9102:0" data-first-offset="true"><span data-slate-string="true">接下来，我们就按这几个步骤来开发 XDP 负载均衡程序。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9103" id="sr-toc-3"><span data-slate-object="text" data-key="9104"><span data-slate-leaf="true" data-offset-key="9104:0" data-first-offset="true"><span data-slate-string="true">开发 XDP eBPF 程序</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9105"><span data-slate-object="text" data-key="9106"><span data-slate-leaf="true" data-offset-key="9106:0" data-first-offset="true"><span data-slate-string="true">第一步是开发一个运行在内核态的 eBPF 程序。参考内核中 BPF_PROG_TYPE_XDP 程序类型的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9107"><span data-slate-object="text" data-key="9108"><span data-slate-leaf="true" data-offset-key="9108:0" data-first-offset="true"><span data-slate-string="true">定义格式</span></span></span></a><span data-slate-object="text" data-key="9109"><span data-slate-leaf="true" data-offset-key="9109:0" data-first-offset="true"><span data-slate-string="true">，它的参数类型为 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9110"><span data-slate-object="text" data-key="9111"><span data-slate-leaf="true" data-offset-key="9111:0" data-first-offset="true"><span data-slate-string="true">struct xdp_md</span></span></span></a><span data-slate-object="text" data-key="9112"><span data-slate-leaf="true" data-offset-key="9112:0" data-first-offset="true"><span data-slate-string="true">：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9113"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9114"><span data-slate-object="text" data-key="9115"><span data-slate-leaf="true" data-offset-key="9115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9116"><span data-slate-leaf="true" data-offset-key="9116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9117"><span data-slate-leaf="true" data-offset-key="9117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> BPF_PROG_TYPE(_id, _name, prog_ctx_type, kern_ctx_type)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9118"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9119"><span data-slate-object="text" data-key="9120"><span data-slate-leaf="true" data-offset-key="9120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BPF_PROG_TYPE</span></span></span></span><span data-slate-object="text" data-key="9121"><span data-slate-leaf="true" data-offset-key="9121:0" data-first-offset="true"><span data-slate-string="true">(BPF_PROG_TYPE_XDP, xdp,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9122"><span data-slate-object="text" data-key="9123"><span data-slate-leaf="true" data-offset-key="9123:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="9124"><span data-slate-leaf="true" data-offset-key="9124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9125"><span data-slate-leaf="true" data-offset-key="9125:0" data-first-offset="true"><span data-slate-string="true"> xdp_md, </span></span></span><span data-slate-object="text" data-key="9126"><span data-slate-leaf="true" data-offset-key="9126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9127"><span data-slate-leaf="true" data-offset-key="9127:0" data-first-offset="true"><span data-slate-string="true"> xdp_buff)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9128"><span data-slate-object="text" data-key="9129"><span data-slate-leaf="true" data-offset-key="9129:0" data-first-offset="true"><span data-slate-string="true">因而，你就可以使用如下的格式来定义这个 XDP 程序：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9130"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9131"><span data-slate-object="text" data-key="9132"><span data-slate-leaf="true" data-offset-key="9132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SEC</span></span></span></span><span data-slate-object="text" data-key="9133"><span data-slate-leaf="true" data-offset-key="9133:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9134"><span data-slate-leaf="true" data-offset-key="9134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"xdp"</span></span></span></span><span data-slate-object="text" data-key="9135"><span data-slate-leaf="true" data-offset-key="9135:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9136"><span data-slate-object="text" data-key="9137"><span data-slate-leaf="true" data-offset-key="9137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="9138"><span data-slate-leaf="true" data-offset-key="9138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9139"><span data-slate-leaf="true" data-offset-key="9139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xdp_proxy</span></span></span></span></span><span data-slate-object="text" data-key="9140"><span data-slate-leaf="true" data-offset-key="9140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="9141"><span data-slate-leaf="true" data-offset-key="9141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="9142"><span data-slate-leaf="true" data-offset-key="9142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> xdp_md *ctx)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9143"><span data-slate-object="text" data-key="9144"><span data-slate-leaf="true" data-offset-key="9144:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9145"><span data-slate-object="text" data-key="9146"><span data-slate-leaf="true" data-offset-key="9146:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9147"><span data-slate-leaf="true" data-offset-key="9147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// </span></span></span></span><span data-slate-object="text" data-key="9148"><span data-slate-leaf="true" data-offset-key="9148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TODO:</span></span></span></span></span><span data-slate-object="text" data-key="9149"><span data-slate-leaf="true" data-offset-key="9149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> 添加 XDP 负载均衡逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9150"><span data-slate-object="text" data-key="9151"><span data-slate-leaf="true" data-offset-key="9151:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9152"><span data-slate-object="text" data-key="9153"><span data-slate-leaf="true" data-offset-key="9153:0" data-first-offset="true"><span data-slate-string="true">这段代码中，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9154"><span data-slate-object="text" data-key="9155"><span data-slate-leaf="true" data-offset-key="9155:0" data-first-offset="true"><span data-slate-string="true">SEC("xdp")</span></span></span></span><span data-slate-object="text" data-key="9156"><span data-slate-leaf="true" data-offset-key="9156:0" data-first-offset="true"><span data-slate-string="true"> 表示程序的类型为 XDP 程序。你可以在 libbpf 中 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9157"><span data-slate-object="text" data-key="9158"><span data-slate-leaf="true" data-offset-key="9158:0" data-first-offset="true"><span data-slate-string="true">section_defs</span></span></span></a><span data-slate-object="text" data-key="9159"><span data-slate-leaf="true" data-offset-key="9159:0" data-first-offset="true"><span data-slate-string="true"> 找到所有 eBPF 程序类型对应的段名称格式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9160"><span data-slate-object="text" data-key="9161"><span data-slate-leaf="true" data-offset-key="9161:0" data-first-offset="true"><span data-slate-string="true">参考 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9162"><span data-slate-object="text" data-key="9163"><span data-slate-leaf="true" data-offset-key="9163:0" data-first-offset="true"><span data-slate-string="true">linux/bpf.h</span></span></span></span><span data-slate-object="text" data-key="9164"><span data-slate-leaf="true" data-offset-key="9164:0" data-first-offset="true"><span data-slate-string="true"> 头文件中 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9165"><span data-slate-object="text" data-key="9166"><span data-slate-leaf="true" data-offset-key="9166:0" data-first-offset="true"><span data-slate-string="true">struct xdp_md</span></span></span></a><span data-slate-object="text" data-key="9167"><span data-slate-leaf="true" data-offset-key="9167:0" data-first-offset="true"><span data-slate-string="true"> 的定义格式，你可以发现，它比上一讲用到的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9168"><span data-slate-object="text" data-key="9169"><span data-slate-leaf="true" data-offset-key="9169:0" data-first-offset="true"><span data-slate-string="true">struct bpf_sock_ops</span></span></span></a><span data-slate-object="text" data-key="9170"><span data-slate-leaf="true" data-offset-key="9170:0" data-first-offset="true"><span data-slate-string="true"> 简单多了，只包含了如下的几个字段：</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="9171"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9172"><span data-slate-object="text" data-key="9173"><span data-slate-leaf="true" data-offset-key="9173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9174"><span data-slate-leaf="true" data-offset-key="9174:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9175"><span data-slate-leaf="true" data-offset-key="9175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xdp_md</span></span></span></span><span data-slate-object="text" data-key="9176"><span data-slate-leaf="true" data-offset-key="9176:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9177"><span data-slate-object="text" data-key="9178"><span data-slate-leaf="true" data-offset-key="9178:0" data-first-offset="true"><span data-slate-string="true">  __</span></span></span><span data-slate-object="text" data-key="9179"><span data-slate-leaf="true" data-offset-key="9179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="9180"><span data-slate-leaf="true" data-offset-key="9180:0" data-first-offset="true"><span data-slate-string="true"> data;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9181"><span data-slate-object="text" data-key="9182"><span data-slate-leaf="true" data-offset-key="9182:0" data-first-offset="true"><span data-slate-string="true">  __</span></span></span><span data-slate-object="text" data-key="9183"><span data-slate-leaf="true" data-offset-key="9183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="9184"><span data-slate-leaf="true" data-offset-key="9184:0" data-first-offset="true"><span data-slate-string="true"> data_end;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9185"><span data-slate-object="text" data-key="9186"><span data-slate-leaf="true" data-offset-key="9186:0" data-first-offset="true"><span data-slate-string="true">  __</span></span></span><span data-slate-object="text" data-key="9187"><span data-slate-leaf="true" data-offset-key="9187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="9188"><span data-slate-leaf="true" data-offset-key="9188:0" data-first-offset="true"><span data-slate-string="true"> data_meta;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9189"><span data-slate-object="text" data-key="9190"><span data-slate-leaf="true" data-offset-key="9190:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9191"><span data-slate-leaf="true" data-offset-key="9191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* Below access go through struct xdp_rxq_info */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9192"><span data-slate-object="text" data-key="9193"><span data-slate-leaf="true" data-offset-key="9193:0" data-first-offset="true"><span data-slate-string="true">  __</span></span></span><span data-slate-object="text" data-key="9194"><span data-slate-leaf="true" data-offset-key="9194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="9195"><span data-slate-leaf="true" data-offset-key="9195:0" data-first-offset="true"><span data-slate-string="true"> ingress_ifindex; </span></span></span><span data-slate-object="text" data-key="9196"><span data-slate-leaf="true" data-offset-key="9196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* rxq-&gt;dev-&gt;ifindex */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9197"><span data-slate-object="text" data-key="9198"><span data-slate-leaf="true" data-offset-key="9198:0" data-first-offset="true"><span data-slate-string="true">  __</span></span></span><span data-slate-object="text" data-key="9199"><span data-slate-leaf="true" data-offset-key="9199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="9200"><span data-slate-leaf="true" data-offset-key="9200:0" data-first-offset="true"><span data-slate-string="true"> rx_queue_index;  </span></span></span><span data-slate-object="text" data-key="9201"><span data-slate-leaf="true" data-offset-key="9201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* rxq-&gt;queue_index  */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9202"><span data-slate-object="text" data-key="9203"><span data-slate-leaf="true" data-offset-key="9203:0" data-first-offset="true"><span data-slate-string="true">  __</span></span></span><span data-slate-object="text" data-key="9204"><span data-slate-leaf="true" data-offset-key="9204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32</span></span></span></span><span data-slate-object="text" data-key="9205"><span data-slate-leaf="true" data-offset-key="9205:0" data-first-offset="true"><span data-slate-string="true"> egress_ifindex;  </span></span></span><span data-slate-object="text" data-key="9206"><span data-slate-leaf="true" data-offset-key="9206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* txq-&gt;dev-&gt;ifindex */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9207"><span data-slate-object="text" data-key="9208"><span data-slate-leaf="true" data-offset-key="9208:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9209"><span data-slate-object="text" data-key="9210"><span data-slate-leaf="true" data-offset-key="9210:0" data-first-offset="true"><span data-slate-string="true">从 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9211"><span data-slate-object="text" data-key="9212"><span data-slate-leaf="true" data-offset-key="9212:0" data-first-offset="true"><span data-slate-string="true">struct xdp_md</span></span></span></span><span data-slate-object="text" data-key="9213"><span data-slate-leaf="true" data-offset-key="9213:0" data-first-offset="true"><span data-slate-string="true"> 的定义中你可以看到，所有的字段都是整型数值，其中前三个表示数据指针信息（包括开始位置、结束位置、元数据位置），而后三个表示关联网卡的信息（包括入口网卡、入口网卡队列以及出口网卡的编号）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9214"><span data-slate-object="text" data-key="9215"><span data-slate-leaf="true" data-offset-key="9215:0" data-first-offset="true"><span data-slate-string="true">由于 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9216"><span data-slate-object="text" data-key="9217"><span data-slate-leaf="true" data-offset-key="9217:0" data-first-offset="true"><span data-slate-string="true">struct xdp_md</span></span></span></span><span data-slate-object="text" data-key="9218"><span data-slate-leaf="true" data-offset-key="9218:0" data-first-offset="true"><span data-slate-string="true"> 中并不包含 skb 数据结构，在 XDP 程序中，你只能通过 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9219"><span data-slate-object="text" data-key="9220"><span data-slate-leaf="true" data-offset-key="9220:0" data-first-offset="true"><span data-slate-string="true">data</span></span></span></span><span data-slate-object="text" data-key="9221"><span data-slate-leaf="true" data-offset-key="9221:0" data-first-offset="true"><span data-slate-string="true"> 和 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9222"><span data-slate-object="text" data-key="9223"><span data-slate-leaf="true" data-offset-key="9223:0" data-first-offset="true"><span data-slate-string="true">data_end</span></span></span></span><span data-slate-object="text" data-key="9224"><span data-slate-leaf="true" data-offset-key="9224:0" data-first-offset="true"><span data-slate-string="true"> 这两个指针去访问网络报文数据。而要想利用原始网络数据指针来访问网络数据，就需要你了解 TCP/IP 网络报文的基本格式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9225"><span data-slate-object="text" data-key="9226"><span data-slate-leaf="true" data-offset-key="9226:0" data-first-offset="true"><span data-slate-string="true">为了方便你理解，我画了一张图，标记了以太网头、IP 头以及 TCP 头等相对于 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9227"><span data-slate-object="text" data-key="9228"><span data-slate-leaf="true" data-offset-key="9228:0" data-first-offset="true"><span data-slate-string="true">struct xdp_md</span></span></span></span><span data-slate-object="text" data-key="9229"><span data-slate-leaf="true" data-offset-key="9229:0" data-first-offset="true"><span data-slate-string="true"> 中数据指针的位置关系：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9230"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/yy/91/yy7887570f06c1d075eb31701924e791.jpg?wh=1920x577"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9231"><span data-slate-object="text" data-key="9232"><span data-slate-leaf="true" data-offset-key="9232:0" data-first-offset="true"><span data-slate-string="true">有了这些对应关系，要访问 TCP/IP 协议某一层的头结构，就可以使用开始指针 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9233"><span data-slate-object="text" data-key="9234"><span data-slate-leaf="true" data-offset-key="9234:0" data-first-offset="true"><span data-slate-string="true">data</span></span></span></span><span data-slate-object="text" data-key="9235"><span data-slate-leaf="true" data-offset-key="9235:0" data-first-offset="true"><span data-slate-string="true"> 再加上它之前所有头结构大小的偏移。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9236"><span data-slate-object="text" data-key="9237"><span data-slate-leaf="true" data-offset-key="9237:0" data-first-offset="true"><span data-slate-string="true">比如，对于以太网头，它的位置跟开始位置 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9238"><span data-slate-object="text" data-key="9239"><span data-slate-leaf="true" data-offset-key="9239:0" data-first-offset="true"><span data-slate-string="true">data</span></span></span></span><span data-slate-object="text" data-key="9240"><span data-slate-leaf="true" data-offset-key="9240:0" data-first-offset="true"><span data-slate-string="true"> 是相同的，因而你就可以使用下面的方式，把它转换为指针格式进行访问：</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="9241"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9242"><span data-slate-object="text" data-key="9243"><span data-slate-leaf="true" data-offset-key="9243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="9244"><span data-slate-leaf="true" data-offset-key="9244:0" data-first-offset="true"><span data-slate-string="true"> *data = (</span></span></span><span data-slate-object="text" data-key="9245"><span data-slate-leaf="true" data-offset-key="9245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="9246"><span data-slate-leaf="true" data-offset-key="9246:0" data-first-offset="true"><span data-slate-string="true"> *)(</span></span></span><span data-slate-object="text" data-key="9247"><span data-slate-leaf="true" data-offset-key="9247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="9248"><span data-slate-leaf="true" data-offset-key="9248:0" data-first-offset="true"><span data-slate-string="true">)ctx-&gt;data;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9249"><span data-slate-object="text" data-key="9250"><span data-slate-leaf="true" data-offset-key="9250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="9251"><span data-slate-leaf="true" data-offset-key="9251:0" data-first-offset="true"><span data-slate-string="true"> *data_end = (</span></span></span><span data-slate-object="text" data-key="9252"><span data-slate-leaf="true" data-offset-key="9252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="9253"><span data-slate-leaf="true" data-offset-key="9253:0" data-first-offset="true"><span data-slate-string="true"> *)(</span></span></span><span data-slate-object="text" data-key="9254"><span data-slate-leaf="true" data-offset-key="9254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="9255"><span data-slate-leaf="true" data-offset-key="9255:0" data-first-offset="true"><span data-slate-string="true">)ctx-&gt;data_end;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9256"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9257"><span data-slate-object="text" data-key="9258"><span data-slate-leaf="true" data-offset-key="9258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9259"><span data-slate-leaf="true" data-offset-key="9259:0" data-first-offset="true"><span data-slate-string="true"> ethhdr *eth = data;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9260"><span data-slate-object="text" data-key="9261"><span data-slate-leaf="true" data-offset-key="9261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9262"><span data-slate-leaf="true" data-offset-key="9262:0" data-first-offset="true"><span data-slate-string="true"> (data + </span></span></span><span data-slate-object="text" data-key="9263"><span data-slate-leaf="true" data-offset-key="9263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="9264"><span data-slate-leaf="true" data-offset-key="9264:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9265"><span data-slate-leaf="true" data-offset-key="9265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9266"><span data-slate-leaf="true" data-offset-key="9266:0" data-first-offset="true"><span data-slate-string="true"> ethhdr) &gt; data_end)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9267"><span data-slate-object="text" data-key="9268"><span data-slate-leaf="true" data-offset-key="9268:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9269"><span data-slate-object="text" data-key="9270"><span data-slate-leaf="true" data-offset-key="9270:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9271"><span data-slate-leaf="true" data-offset-key="9271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9272"><span data-slate-leaf="true" data-offset-key="9272:0" data-first-offset="true"><span data-slate-string="true"> XDP_ABORTED;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9273"><span data-slate-object="text" data-key="9274"><span data-slate-leaf="true" data-offset-key="9274:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9275"><span data-slate-object="text" data-key="9276"><span data-slate-leaf="true" data-offset-key="9276:0" data-first-offset="true"><span data-slate-string="true">为了帮助 eBPF 校验器验证数据访问的合法性，在访问以太网头数据结构 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9277"><span data-slate-object="text" data-key="9278"><span data-slate-leaf="true" data-offset-key="9278:0" data-first-offset="true"><span data-slate-string="true">struct ethhdr</span></span></span></span><span data-slate-object="text" data-key="9279"><span data-slate-leaf="true" data-offset-key="9279:0" data-first-offset="true"><span data-slate-string="true"> 之前，你需要检查数据指针是否越界。如果检查失败，就要返回一个错误（这儿返回的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9280"><span data-slate-object="text" data-key="9281"><span data-slate-leaf="true" data-offset-key="9281:0" data-first-offset="true"><span data-slate-string="true">XDP_ABORTED</span></span></span></span><span data-slate-object="text" data-key="9282"><span data-slate-leaf="true" data-offset-key="9282:0" data-first-offset="true"><span data-slate-string="true"> 表示丢弃数据包并记录错误行为以便排错）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9283"><span data-slate-object="text" data-key="9284"><span data-slate-leaf="true" data-offset-key="9284:0" data-first-offset="true"><span data-slate-string="true">了解了太网头的访问格式之后，IP 头的访问也是类似的。在开始指针 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9285"><span data-slate-object="text" data-key="9286"><span data-slate-leaf="true" data-offset-key="9286:0" data-first-offset="true"><span data-slate-string="true">data</span></span></span></span><span data-slate-object="text" data-key="9287"><span data-slate-leaf="true" data-offset-key="9287:0" data-first-offset="true"><span data-slate-string="true"> 之后加上太网头数据结构的长度偏移，就是 IP 头所指向的位置。拿到 IP 头之后，你还可以对网络数据进行初步的校验，比如忽略 IPv6、UDP 等我们不关心的数据，只处理 TCP 数据包，代码如下：</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="9288"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9289"><span data-slate-object="text" data-key="9290"><span data-slate-leaf="true" data-offset-key="9290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9291"><span data-slate-leaf="true" data-offset-key="9291:0" data-first-offset="true"><span data-slate-string="true"> iphdr *iph = data + </span></span></span><span data-slate-object="text" data-key="9292"><span data-slate-leaf="true" data-offset-key="9292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="9293"><span data-slate-leaf="true" data-offset-key="9293:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9294"><span data-slate-leaf="true" data-offset-key="9294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9295"><span data-slate-leaf="true" data-offset-key="9295:0" data-first-offset="true"><span data-slate-string="true"> ethhdr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9296"><span data-slate-object="text" data-key="9297"><span data-slate-leaf="true" data-offset-key="9297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9298"><span data-slate-leaf="true" data-offset-key="9298:0" data-first-offset="true"><span data-slate-string="true"> (data + </span></span></span><span data-slate-object="text" data-key="9299"><span data-slate-leaf="true" data-offset-key="9299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="9300"><span data-slate-leaf="true" data-offset-key="9300:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9301"><span data-slate-leaf="true" data-offset-key="9301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9302"><span data-slate-leaf="true" data-offset-key="9302:0" data-first-offset="true"><span data-slate-string="true"> ethhdr) + </span></span></span><span data-slate-object="text" data-key="9303"><span data-slate-leaf="true" data-offset-key="9303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="9304"><span data-slate-leaf="true" data-offset-key="9304:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9305"><span data-slate-leaf="true" data-offset-key="9305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9306"><span data-slate-leaf="true" data-offset-key="9306:0" data-first-offset="true"><span data-slate-string="true"> iphdr) &gt; data_end)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9307"><span data-slate-object="text" data-key="9308"><span data-slate-leaf="true" data-offset-key="9308:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9309"><span data-slate-object="text" data-key="9310"><span data-slate-leaf="true" data-offset-key="9310:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9311"><span data-slate-leaf="true" data-offset-key="9311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9312"><span data-slate-leaf="true" data-offset-key="9312:0" data-first-offset="true"><span data-slate-string="true"> XDP_ABORTED;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9313"><span data-slate-object="text" data-key="9314"><span data-slate-leaf="true" data-offset-key="9314:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9315"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9316"><span data-slate-object="text" data-key="9317"><span data-slate-leaf="true" data-offset-key="9317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9318"><span data-slate-leaf="true" data-offset-key="9318:0" data-first-offset="true"><span data-slate-string="true"> (eth-&gt;h_proto != bpf_htons(ETH_P_IP))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9319"><span data-slate-object="text" data-key="9320"><span data-slate-leaf="true" data-offset-key="9320:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9321"><span data-slate-object="text" data-key="9322"><span data-slate-leaf="true" data-offset-key="9322:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9323"><span data-slate-leaf="true" data-offset-key="9323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9324"><span data-slate-leaf="true" data-offset-key="9324:0" data-first-offset="true"><span data-slate-string="true"> XDP_PASS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9325"><span data-slate-object="text" data-key="9326"><span data-slate-leaf="true" data-offset-key="9326:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9327"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9328"><span data-slate-object="text" data-key="9329"><span data-slate-leaf="true" data-offset-key="9329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9330"><span data-slate-leaf="true" data-offset-key="9330:0" data-first-offset="true"><span data-slate-string="true"> (iph-&gt;protocol != IPPROTO_TCP)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9331"><span data-slate-object="text" data-key="9332"><span data-slate-leaf="true" data-offset-key="9332:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9333"><span data-slate-object="text" data-key="9334"><span data-slate-leaf="true" data-offset-key="9334:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9335"><span data-slate-leaf="true" data-offset-key="9335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9336"><span data-slate-leaf="true" data-offset-key="9336:0" data-first-offset="true"><span data-slate-string="true"> XDP_PASS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9337"><span data-slate-object="text" data-key="9338"><span data-slate-leaf="true" data-offset-key="9338:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9339"><span data-slate-object="text" data-key="9340"><span data-slate-leaf="true" data-offset-key="9340:0" data-first-offset="true"><span data-slate-string="true">这段代码中返回的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9341"><span data-slate-object="text" data-key="9342"><span data-slate-leaf="true" data-offset-key="9342:0" data-first-offset="true"><span data-slate-string="true">XDP_PASS</span></span></span></span><span data-slate-object="text" data-key="9343"><span data-slate-leaf="true" data-offset-key="9343:0" data-first-offset="true"><span data-slate-string="true"> 表示把网络包传递给内核协议栈，内核协议栈接收到网络包后，按正常流程继续处理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9344"><span data-slate-object="text" data-key="9345"><span data-slate-leaf="true" data-offset-key="9345:0" data-first-offset="true"><span data-slate-string="true">进行了基本的校验之后，再接下来就是实现负载均衡的逻辑了。由于我们想要实现的是一个四层负载均衡，试想一下，负载均衡器收到客户端的请求之后，需要把目的地址（包括 IP 和 MAC）替换成后端 Webserver 的地址，再重新发到内核协议栈中继续处理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9346"><span data-slate-object="text" data-key="9347"><span data-slate-leaf="true" data-offset-key="9347:0" data-first-offset="true"><span data-slate-string="true">参考内核中</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9348"><span data-slate-object="text" data-key="9349"><span data-slate-leaf="true" data-offset-key="9349:0" data-first-offset="true"><span data-slate-string="true">以太网头</span></span></span></a><span data-slate-object="text" data-key="9350"><span data-slate-leaf="true" data-offset-key="9350:0" data-first-offset="true"><span data-slate-string="true">和 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9351"><span data-slate-object="text" data-key="9352"><span data-slate-leaf="true" data-offset-key="9352:0" data-first-offset="true"><span data-slate-string="true">IP 头</span></span></span></a><span data-slate-object="text" data-key="9353"><span data-slate-leaf="true" data-offset-key="9353:0" data-first-offset="true"><span data-slate-string="true">的定义格式， IP 地址都是以 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9354"><span data-slate-object="text" data-key="9355"><span data-slate-leaf="true" data-offset-key="9355:0" data-first-offset="true"><span data-slate-string="true">__be16</span></span></span></span><span data-slate-object="text" data-key="9356"><span data-slate-leaf="true" data-offset-key="9356:0" data-first-offset="true"><span data-slate-string="true"> 类型的大端格式存储，而 MAC 地址则是以字符数组 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9357"><span data-slate-object="text" data-key="9358"><span data-slate-leaf="true" data-offset-key="9358:0" data-first-offset="true"><span data-slate-string="true">unsigned char h_dest[6]</span></span></span></span><span data-slate-object="text" data-key="9359"><span data-slate-leaf="true" data-offset-key="9359:0" data-first-offset="true"><span data-slate-string="true"> 的形式存储。因而，MAC 地址可以直接通过数据下标进行访问，而我们案例开始时列出的 IP 地址，还需要先转换为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9360"><span data-slate-object="text" data-key="9361"><span data-slate-leaf="true" data-offset-key="9361:0" data-first-offset="true"><span data-slate-string="true">__be16</span></span></span></span><span data-slate-object="text" data-key="9362"><span data-slate-leaf="true" data-offset-key="9362:0" data-first-offset="true"><span data-slate-string="true"> 格式的大端存储格式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9363"><span data-slate-object="text" data-key="9364"><span data-slate-leaf="true" data-offset-key="9364:0" data-first-offset="true"><span data-slate-string="true">如果你还不熟悉 IP 地址的转换方法，那可以参考下面的程序，调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9365"><span data-slate-object="text" data-key="9366"><span data-slate-leaf="true" data-offset-key="9366:0" data-first-offset="true"><span data-slate-string="true">inet_addr()</span></span></span></span><span data-slate-object="text" data-key="9367"><span data-slate-leaf="true" data-offset-key="9367:0" data-first-offset="true"><span data-slate-string="true"> 库函数帮你完成转换：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9368"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9369"><span data-slate-object="text" data-key="9370"><span data-slate-leaf="true" data-offset-key="9370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9371"><span data-slate-leaf="true" data-offset-key="9371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="9372"><span data-slate-leaf="true" data-offset-key="9372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9373"><span data-slate-leaf="true" data-offset-key="9373:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;stdio.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9374"><span data-slate-object="text" data-key="9375"><span data-slate-leaf="true" data-offset-key="9375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9376"><span data-slate-leaf="true" data-offset-key="9376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="9377"><span data-slate-leaf="true" data-offset-key="9377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9378"><span data-slate-leaf="true" data-offset-key="9378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;arpa/inet.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9379"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9380"><span data-slate-object="text" data-key="9381"><span data-slate-leaf="true" data-offset-key="9381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="9382"><span data-slate-leaf="true" data-offset-key="9382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9383"><span data-slate-leaf="true" data-offset-key="9383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="9384"><span data-slate-leaf="true" data-offset-key="9384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="9385"><span data-slate-leaf="true" data-offset-key="9385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9386"><span data-slate-leaf="true" data-offset-key="9386:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9387"><span data-slate-object="text" data-key="9388"><span data-slate-leaf="true" data-offset-key="9388:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9389"><span data-slate-leaf="true" data-offset-key="9389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="9390"><span data-slate-leaf="true" data-offset-key="9390:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9391"><span data-slate-leaf="true" data-offset-key="9391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9392"><span data-slate-leaf="true" data-offset-key="9392:0" data-first-offset="true"><span data-slate-string="true"> a1 = </span></span></span><span data-slate-object="text" data-key="9393"><span data-slate-leaf="true" data-offset-key="9393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inet_addr</span></span></span></span><span data-slate-object="text" data-key="9394"><span data-slate-leaf="true" data-offset-key="9394:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9395"><span data-slate-leaf="true" data-offset-key="9395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"172.17.0.2"</span></span></span></span><span data-slate-object="text" data-key="9396"><span data-slate-leaf="true" data-offset-key="9396:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9397"><span data-slate-object="text" data-key="9398"><span data-slate-leaf="true" data-offset-key="9398:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9399"><span data-slate-leaf="true" data-offset-key="9399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="9400"><span data-slate-leaf="true" data-offset-key="9400:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9401"><span data-slate-leaf="true" data-offset-key="9401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9402"><span data-slate-leaf="true" data-offset-key="9402:0" data-first-offset="true"><span data-slate-string="true"> a2 = </span></span></span><span data-slate-object="text" data-key="9403"><span data-slate-leaf="true" data-offset-key="9403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inet_addr</span></span></span></span><span data-slate-object="text" data-key="9404"><span data-slate-leaf="true" data-offset-key="9404:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9405"><span data-slate-leaf="true" data-offset-key="9405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"172.17.0.3"</span></span></span></span><span data-slate-object="text" data-key="9406"><span data-slate-leaf="true" data-offset-key="9406:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9407"><span data-slate-object="text" data-key="9408"><span data-slate-leaf="true" data-offset-key="9408:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9409"><span data-slate-leaf="true" data-offset-key="9409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="9410"><span data-slate-leaf="true" data-offset-key="9410:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9411"><span data-slate-leaf="true" data-offset-key="9411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9412"><span data-slate-leaf="true" data-offset-key="9412:0" data-first-offset="true"><span data-slate-string="true"> a3 = </span></span></span><span data-slate-object="text" data-key="9413"><span data-slate-leaf="true" data-offset-key="9413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inet_addr</span></span></span></span><span data-slate-object="text" data-key="9414"><span data-slate-leaf="true" data-offset-key="9414:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9415"><span data-slate-leaf="true" data-offset-key="9415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"172.17.0.4"</span></span></span></span><span data-slate-object="text" data-key="9416"><span data-slate-leaf="true" data-offset-key="9416:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9417"><span data-slate-object="text" data-key="9418"><span data-slate-leaf="true" data-offset-key="9418:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9419"><span data-slate-leaf="true" data-offset-key="9419:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="9420"><span data-slate-leaf="true" data-offset-key="9420:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9421"><span data-slate-leaf="true" data-offset-key="9421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9422"><span data-slate-leaf="true" data-offset-key="9422:0" data-first-offset="true"><span data-slate-string="true"> a4 = </span></span></span><span data-slate-object="text" data-key="9423"><span data-slate-leaf="true" data-offset-key="9423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inet_addr</span></span></span></span><span data-slate-object="text" data-key="9424"><span data-slate-leaf="true" data-offset-key="9424:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9425"><span data-slate-leaf="true" data-offset-key="9425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"172.17.0.5"</span></span></span></span><span data-slate-object="text" data-key="9426"><span data-slate-leaf="true" data-offset-key="9426:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9427"><span data-slate-object="text" data-key="9428"><span data-slate-leaf="true" data-offset-key="9428:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9429"><span data-slate-leaf="true" data-offset-key="9429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">printf</span></span></span></span><span data-slate-object="text" data-key="9430"><span data-slate-leaf="true" data-offset-key="9430:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9431"><span data-slate-leaf="true" data-offset-key="9431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"0x%x 0x%x 0x%x 0x%x\n"</span></span></span></span><span data-slate-object="text" data-key="9432"><span data-slate-leaf="true" data-offset-key="9432:0" data-first-offset="true"><span data-slate-string="true">, a1, a2, a3, a4);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9433"><span data-slate-object="text" data-key="9434"><span data-slate-leaf="true" data-offset-key="9434:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9435"><span data-slate-object="text" data-key="9436"><span data-slate-leaf="true" data-offset-key="9436:0" data-first-offset="true"><span data-slate-string="true">为了方便你理解接下来的程序，我把转换后的容器地址信息整理成了一个表格，你可以在后续的开发和问题排查过程中参考：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9437"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/d3/bb/d31389c380dc3dddf2128495d35b6ebb.jpg?wh=2284x1510"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9438"><span data-slate-object="text" data-key="9439"><span data-slate-leaf="true" data-offset-key="9439:0" data-first-offset="true"><span data-slate-string="true">接下来，就是负载均衡的实现过程了，也就是根据请求的来源，把目的地址修改为 Webserver 的地址。下面的代码展示的就是一个最简单的负载均衡实现逻辑：</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="9440"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9441"><span data-slate-object="text" data-key="9442"><span data-slate-leaf="true" data-offset-key="9442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 1. 常量定义 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9443"><span data-slate-object="text" data-key="9444"><span data-slate-leaf="true" data-offset-key="9444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9445"><span data-slate-leaf="true" data-offset-key="9445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9446"><span data-slate-leaf="true" data-offset-key="9446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> CLIENT_IP 0x40011ac</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9447"><span data-slate-object="text" data-key="9448"><span data-slate-leaf="true" data-offset-key="9448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9449"><span data-slate-leaf="true" data-offset-key="9449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9450"><span data-slate-leaf="true" data-offset-key="9450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> LOADBALANCER_IP 0x50011ac</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9451"><span data-slate-object="text" data-key="9452"><span data-slate-leaf="true" data-offset-key="9452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9453"><span data-slate-leaf="true" data-offset-key="9453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9454"><span data-slate-leaf="true" data-offset-key="9454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ENDPOINT1_IP 0x20011ac</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9455"><span data-slate-object="text" data-key="9456"><span data-slate-leaf="true" data-offset-key="9456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9457"><span data-slate-leaf="true" data-offset-key="9457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9458"><span data-slate-leaf="true" data-offset-key="9458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ENDPOINT2_IP 0x30011ac</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9459"><span data-slate-object="text" data-key="9460"><span data-slate-leaf="true" data-offset-key="9460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9461"><span data-slate-leaf="true" data-offset-key="9461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9462"><span data-slate-leaf="true" data-offset-key="9462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> CLIENT_MAC_SUFFIX 0x04</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9463"><span data-slate-object="text" data-key="9464"><span data-slate-leaf="true" data-offset-key="9464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9465"><span data-slate-leaf="true" data-offset-key="9465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9466"><span data-slate-leaf="true" data-offset-key="9466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> LOADBALANCER_MAC_SUFFIX 0x05</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9467"><span data-slate-object="text" data-key="9468"><span data-slate-leaf="true" data-offset-key="9468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9469"><span data-slate-leaf="true" data-offset-key="9469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9470"><span data-slate-leaf="true" data-offset-key="9470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ENDPOINT1_MAC_SUFFIX 0x02</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9471"><span data-slate-object="text" data-key="9472"><span data-slate-leaf="true" data-offset-key="9472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9473"><span data-slate-leaf="true" data-offset-key="9473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="9474"><span data-slate-leaf="true" data-offset-key="9474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ENDPOINT2_MAC_SUFFIX 0x03</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9475"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9476"><span data-slate-object="text" data-key="9477"><span data-slate-leaf="true" data-offset-key="9477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 2. 从客户端发送过来的请求，目的地址改为后端 Webserver 的地址 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9478"><span data-slate-object="text" data-key="9479"><span data-slate-leaf="true" data-offset-key="9479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9480"><span data-slate-leaf="true" data-offset-key="9480:0" data-first-offset="true"><span data-slate-string="true"> (iph-&gt;saddr == </span></span></span><span data-slate-object="text" data-key="9481"><span data-slate-leaf="true" data-offset-key="9481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CLIENT_IP</span></span></span></span><span data-slate-object="text" data-key="9482"><span data-slate-leaf="true" data-offset-key="9482:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9483"><span data-slate-object="text" data-key="9484"><span data-slate-leaf="true" data-offset-key="9484:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9485"><span data-slate-object="text" data-key="9486"><span data-slate-leaf="true" data-offset-key="9486:0" data-first-offset="true"><span data-slate-string="true">  iph-&gt;daddr = ENDPOINT1_IP;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9487"><span data-slate-object="text" data-key="9488"><span data-slate-leaf="true" data-offset-key="9488:0" data-first-offset="true"><span data-slate-string="true">  eth-&gt;h_dest[</span></span></span><span data-slate-object="text" data-key="9489"><span data-slate-leaf="true" data-offset-key="9489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="9490"><span data-slate-leaf="true" data-offset-key="9490:0" data-first-offset="true"><span data-slate-string="true">] = ENDPOINT1_MAC_SUFFIX; </span></span></span><span data-slate-object="text" data-key="9491"><span data-slate-leaf="true" data-offset-key="9491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* Only need to update the last byte */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9492"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9493"><span data-slate-object="text" data-key="9494"><span data-slate-leaf="true" data-offset-key="9494:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9495"><span data-slate-leaf="true" data-offset-key="9495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 模拟从两个 Webserver 随机选择 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9496"><span data-slate-object="text" data-key="9497"><span data-slate-leaf="true" data-offset-key="9497:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9498"><span data-slate-leaf="true" data-offset-key="9498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9499"><span data-slate-leaf="true" data-offset-key="9499:0" data-first-offset="true"><span data-slate-string="true"> ((bpf_ktime_get_ns() &amp; </span></span></span><span data-slate-object="text" data-key="9500"><span data-slate-leaf="true" data-offset-key="9500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1</span></span></span></span><span data-slate-object="text" data-key="9501"><span data-slate-leaf="true" data-offset-key="9501:0" data-first-offset="true"><span data-slate-string="true">) == </span></span></span><span data-slate-object="text" data-key="9502"><span data-slate-leaf="true" data-offset-key="9502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1</span></span></span></span><span data-slate-object="text" data-key="9503"><span data-slate-leaf="true" data-offset-key="9503:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9504"><span data-slate-object="text" data-key="9505"><span data-slate-leaf="true" data-offset-key="9505:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9506"><span data-slate-object="text" data-key="9507"><span data-slate-leaf="true" data-offset-key="9507:0" data-first-offset="true"><span data-slate-string="true">    iph-&gt;daddr = ENDPOINT2_IP;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9508"><span data-slate-object="text" data-key="9509"><span data-slate-leaf="true" data-offset-key="9509:0" data-first-offset="true"><span data-slate-string="true">    eth-&gt;h_dest[</span></span></span><span data-slate-object="text" data-key="9510"><span data-slate-leaf="true" data-offset-key="9510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="9511"><span data-slate-leaf="true" data-offset-key="9511:0" data-first-offset="true"><span data-slate-string="true">] = ENDPOINT2_MAC_SUFFIX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9512"><span data-slate-object="text" data-key="9513"><span data-slate-leaf="true" data-offset-key="9513:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9514"><span data-slate-object="text" data-key="9515"><span data-slate-leaf="true" data-offset-key="9515:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9516"><span data-slate-object="text" data-key="9517"><span data-slate-leaf="true" data-offset-key="9517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="9518"><span data-slate-leaf="true" data-offset-key="9518:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9519"><span data-slate-leaf="true" data-offset-key="9519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 3. 反之，目的地址改为客户端 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9520"><span data-slate-object="text" data-key="9521"><span data-slate-leaf="true" data-offset-key="9521:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9522"><span data-slate-object="text" data-key="9523"><span data-slate-leaf="true" data-offset-key="9523:0" data-first-offset="true"><span data-slate-string="true">  iph-&gt;daddr = </span></span></span><span data-slate-object="text" data-key="9524"><span data-slate-leaf="true" data-offset-key="9524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CLIENT_IP</span></span></span></span><span data-slate-object="text" data-key="9525"><span data-slate-leaf="true" data-offset-key="9525:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9526"><span data-slate-object="text" data-key="9527"><span data-slate-leaf="true" data-offset-key="9527:0" data-first-offset="true"><span data-slate-string="true">  eth-&gt;h_dest[</span></span></span><span data-slate-object="text" data-key="9528"><span data-slate-leaf="true" data-offset-key="9528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="9529"><span data-slate-leaf="true" data-offset-key="9529:0" data-first-offset="true"><span data-slate-string="true">] = </span></span></span><span data-slate-object="text" data-key="9530"><span data-slate-leaf="true" data-offset-key="9530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CLIENT_MAC_SUFFIX</span></span></span></span><span data-slate-object="text" data-key="9531"><span data-slate-leaf="true" data-offset-key="9531:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9532"><span data-slate-object="text" data-key="9533"><span data-slate-leaf="true" data-offset-key="9533:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9534"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9535"><span data-slate-object="text" data-key="9536"><span data-slate-leaf="true" data-offset-key="9536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 4. 修改原地址为 LB 地址 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9537"><span data-slate-object="text" data-key="9538"><span data-slate-leaf="true" data-offset-key="9538:0" data-first-offset="true"><span data-slate-string="true">iph-&gt;saddr = LOADBALANCER_IP;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9539"><span data-slate-object="text" data-key="9540"><span data-slate-leaf="true" data-offset-key="9540:0" data-first-offset="true"><span data-slate-string="true">eth-&gt;h_source[</span></span></span><span data-slate-object="text" data-key="9541"><span data-slate-leaf="true" data-offset-key="9541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="9542"><span data-slate-leaf="true" data-offset-key="9542:0" data-first-offset="true"><span data-slate-string="true">] = LOADBALANCER_MAC_SUFFIX;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9543"><span data-slate-object="text" data-key="9544"><span data-slate-leaf="true" data-offset-key="9544:0" data-first-offset="true"><span data-slate-string="true">这段代码中各部分的含义如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="9545"><div data-slate-type="list-line" data-slate-object="block" data-key="9546"><span data-slate-object="text" data-key="9547"><span data-slate-leaf="true" data-offset-key="9547:0" data-first-offset="true"><span data-slate-string="true">第 1 部分，将容器地址信息定义为常量，方便后续引用和理解。注意，MAC 地址是一个包含 6 个元素的数组，而前 5 个元素的值都是相同的。因而，在更新目的 MAC 地址时，只需要更新最后一个元素即可。所以，常量定义里面也只包含了最后一个字节的值。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9548"><span data-slate-object="text" data-key="9549"><span data-slate-leaf="true" data-offset-key="9549:0" data-first-offset="true"><span data-slate-string="true">第 2 部分，对于从客户端发送过来的请求，将目的地址改为后端 Webserver 的地址。由于只有两个后端 Webserver，这儿使用时间戳最后一位的值模拟它们的随机选择过程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9550"><span data-slate-object="text" data-key="9551"><span data-slate-leaf="true" data-offset-key="9551:0" data-first-offset="true"><span data-slate-string="true">第 3 部分，对于从 Webserver 发送过来的响应，目的地址改为客户端地址。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="9552"><span data-slate-object="text" data-key="9553"><span data-slate-leaf="true" data-offset-key="9553:0" data-first-offset="true"><span data-slate-string="true">第 4 部分，将原地址都改为负载均衡器的地址。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9554"><span data-slate-object="text" data-key="9555"><span data-slate-leaf="true" data-offset-key="9555:0" data-first-offset="true"><span data-slate-string="true">到这里， eBPF 程序是不是已经开发好了呢？其实，如果你了解过 IP 协议的基本原理，你就知道还有一个步骤也是非常重要的：由于修改了 IP 头的数据，IP 头的校验和（checksum）就需要重新计算，否则网络包会被内核直接丢弃。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9556"><span data-slate-object="text" data-key="9557"><span data-slate-leaf="true" data-offset-key="9557:0" data-first-offset="true"><span data-slate-string="true">如果你不熟悉 IP 头校验和的计算方法也没关系，你可以很容易从成熟的开源项目中查找到相关的计算方法。比如，参考 Facebook 开源的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9558"><span data-slate-object="text" data-key="9559"><span data-slate-leaf="true" data-offset-key="9559:0" data-first-offset="true"><span data-slate-string="true">Katran</span></span></span></a><span data-slate-object="text" data-key="9560"><span data-slate-leaf="true" data-offset-key="9560:0" data-first-offset="true"><span data-slate-string="true">，你可以定义如下的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9561"><span data-slate-object="text" data-key="9562"><span data-slate-leaf="true" data-offset-key="9562:0" data-first-offset="true"><span data-slate-string="true">ipv4_csum()</span></span></span></span><span data-slate-object="text" data-key="9563"><span data-slate-leaf="true" data-offset-key="9563:0" data-first-offset="true"><span data-slate-string="true"> 函数来计算校验和：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9564"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9565"><span data-slate-object="text" data-key="9566"><span data-slate-leaf="true" data-offset-key="9566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="9567"><span data-slate-leaf="true" data-offset-key="9567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline __u16 </span></span></span></span><span data-slate-object="text" data-key="9568"><span data-slate-leaf="true" data-offset-key="9568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">csum_fold_helper</span></span></span></span></span><span data-slate-object="text" data-key="9569"><span data-slate-leaf="true" data-offset-key="9569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(__u64 csum)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9570"><span data-slate-object="text" data-key="9571"><span data-slate-leaf="true" data-offset-key="9571:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9572"><span data-slate-object="text" data-key="9573"><span data-slate-leaf="true" data-offset-key="9573:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9574"><span data-slate-leaf="true" data-offset-key="9574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9575"><span data-slate-leaf="true" data-offset-key="9575:0" data-first-offset="true"><span data-slate-string="true"> i;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9576"><span data-slate-object="text" data-key="9577"><span data-slate-leaf="true" data-offset-key="9577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9578"><span data-slate-leaf="true" data-offset-key="9578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pragma</span></span></span></span></span><span data-slate-object="text" data-key="9579"><span data-slate-leaf="true" data-offset-key="9579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> unroll</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9580"><span data-slate-object="text" data-key="9581"><span data-slate-leaf="true" data-offset-key="9581:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9582"><span data-slate-leaf="true" data-offset-key="9582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="9583"><span data-slate-leaf="true" data-offset-key="9583:0" data-first-offset="true"><span data-slate-string="true"> (i = </span></span></span><span data-slate-object="text" data-key="9584"><span data-slate-leaf="true" data-offset-key="9584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9585"><span data-slate-leaf="true" data-offset-key="9585:0" data-first-offset="true"><span data-slate-string="true">; i &lt; </span></span></span><span data-slate-object="text" data-key="9586"><span data-slate-leaf="true" data-offset-key="9586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">4</span></span></span></span><span data-slate-object="text" data-key="9587"><span data-slate-leaf="true" data-offset-key="9587:0" data-first-offset="true"><span data-slate-string="true">; i++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9588"><span data-slate-object="text" data-key="9589"><span data-slate-leaf="true" data-offset-key="9589:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9590"><span data-slate-object="text" data-key="9591"><span data-slate-leaf="true" data-offset-key="9591:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9592"><span data-slate-leaf="true" data-offset-key="9592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9593"><span data-slate-leaf="true" data-offset-key="9593:0" data-first-offset="true"><span data-slate-string="true"> (csum&gt;&gt; </span></span></span><span data-slate-object="text" data-key="9594"><span data-slate-leaf="true" data-offset-key="9594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">16</span></span></span></span><span data-slate-object="text" data-key="9595"><span data-slate-leaf="true" data-offset-key="9595:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9596"><span data-slate-object="text" data-key="9597"><span data-slate-leaf="true" data-offset-key="9597:0" data-first-offset="true"><span data-slate-string="true">    csum = (csum &amp; </span></span></span><span data-slate-object="text" data-key="9598"><span data-slate-leaf="true" data-offset-key="9598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0xffff</span></span></span></span><span data-slate-object="text" data-key="9599"><span data-slate-leaf="true" data-offset-key="9599:0" data-first-offset="true"><span data-slate-string="true">) + (csum&gt;&gt; </span></span></span><span data-slate-object="text" data-key="9600"><span data-slate-leaf="true" data-offset-key="9600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">16</span></span></span></span><span data-slate-object="text" data-key="9601"><span data-slate-leaf="true" data-offset-key="9601:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9602"><span data-slate-object="text" data-key="9603"><span data-slate-leaf="true" data-offset-key="9603:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9604"><span data-slate-object="text" data-key="9605"><span data-slate-leaf="true" data-offset-key="9605:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9606"><span data-slate-leaf="true" data-offset-key="9606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9607"><span data-slate-leaf="true" data-offset-key="9607:0" data-first-offset="true"><span data-slate-string="true"> ~csum;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9608"><span data-slate-object="text" data-key="9609"><span data-slate-leaf="true" data-offset-key="9609:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9610"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9611"><span data-slate-object="text" data-key="9612"><span data-slate-leaf="true" data-offset-key="9612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="9613"><span data-slate-leaf="true" data-offset-key="9613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline __u16 </span></span></span></span><span data-slate-object="text" data-key="9614"><span data-slate-leaf="true" data-offset-key="9614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ipv4_csum</span></span></span></span></span><span data-slate-object="text" data-key="9615"><span data-slate-leaf="true" data-offset-key="9615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="9616"><span data-slate-leaf="true" data-offset-key="9616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="9617"><span data-slate-leaf="true" data-offset-key="9617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> iphdr *iph)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9618"><span data-slate-object="text" data-key="9619"><span data-slate-leaf="true" data-offset-key="9619:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9620"><span data-slate-object="text" data-key="9621"><span data-slate-leaf="true" data-offset-key="9621:0" data-first-offset="true"><span data-slate-string="true">  iph-&gt;check = </span></span></span><span data-slate-object="text" data-key="9622"><span data-slate-leaf="true" data-offset-key="9622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9623"><span data-slate-leaf="true" data-offset-key="9623:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9624"><span data-slate-object="text" data-key="9625"><span data-slate-leaf="true" data-offset-key="9625:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9626"><span data-slate-leaf="true" data-offset-key="9626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="9627"><span data-slate-leaf="true" data-offset-key="9627:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9628"><span data-slate-leaf="true" data-offset-key="9628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="9629"><span data-slate-leaf="true" data-offset-key="9629:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9630"><span data-slate-leaf="true" data-offset-key="9630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="9631"><span data-slate-leaf="true" data-offset-key="9631:0" data-first-offset="true"><span data-slate-string="true"> csum = </span></span></span><span data-slate-object="text" data-key="9632"><span data-slate-leaf="true" data-offset-key="9632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bpf_csum_diff</span></span></span></span><span data-slate-object="text" data-key="9633"><span data-slate-leaf="true" data-offset-key="9633:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9634"><span data-slate-leaf="true" data-offset-key="9634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9635"><span data-slate-leaf="true" data-offset-key="9635:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9636"><span data-slate-leaf="true" data-offset-key="9636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9637"><span data-slate-leaf="true" data-offset-key="9637:0" data-first-offset="true"><span data-slate-string="true">, (</span></span></span><span data-slate-object="text" data-key="9638"><span data-slate-leaf="true" data-offset-key="9638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="9639"><span data-slate-leaf="true" data-offset-key="9639:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9640"><span data-slate-leaf="true" data-offset-key="9640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9641"><span data-slate-leaf="true" data-offset-key="9641:0" data-first-offset="true"><span data-slate-string="true"> *)iph, </span></span></span><span data-slate-object="text" data-key="9642"><span data-slate-leaf="true" data-offset-key="9642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="9643"><span data-slate-leaf="true" data-offset-key="9643:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9644"><span data-slate-leaf="true" data-offset-key="9644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9645"><span data-slate-leaf="true" data-offset-key="9645:0" data-first-offset="true"><span data-slate-string="true"> iphdr), </span></span></span><span data-slate-object="text" data-key="9646"><span data-slate-leaf="true" data-offset-key="9646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9647"><span data-slate-leaf="true" data-offset-key="9647:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9648"><span data-slate-object="text" data-key="9649"><span data-slate-leaf="true" data-offset-key="9649:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9650"><span data-slate-leaf="true" data-offset-key="9650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9651"><span data-slate-leaf="true" data-offset-key="9651:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9652"><span data-slate-leaf="true" data-offset-key="9652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">csum_fold_helper</span></span></span></span><span data-slate-object="text" data-key="9653"><span data-slate-leaf="true" data-offset-key="9653:0" data-first-offset="true"><span data-slate-string="true">(csum);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9654"><span data-slate-object="text" data-key="9655"><span data-slate-leaf="true" data-offset-key="9655:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9656"><span data-slate-object="text" data-key="9657"><span data-slate-leaf="true" data-offset-key="9657:0" data-first-offset="true"><span data-slate-string="true">关于校验和的具体算法，你可以参考 TCP/IP 协议相关的原理书籍（如《TCP/IP 详解》）来理解，这里我就不详细展开了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9658"><span data-slate-object="text" data-key="9659"><span data-slate-leaf="true" data-offset-key="9659:0" data-first-offset="true"><span data-slate-string="true">有了校验和的计算方法之后，最后更新 IP 头的 checksum，再返回 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9660"><span data-slate-object="text" data-key="9661"><span data-slate-leaf="true" data-offset-key="9661:0" data-first-offset="true"><span data-slate-string="true">XDP_TX</span></span></span></span><span data-slate-object="text" data-key="9662"><span data-slate-leaf="true" data-offset-key="9662:0" data-first-offset="true"><span data-slate-string="true"> 把数据包从原网卡发送出去，交给内核去转发就可以了。下面展示的就是更新校验和的实现方法：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9663"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9664"><span data-slate-object="text" data-key="9665"><span data-slate-leaf="true" data-offset-key="9665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SEC</span></span></span></span><span data-slate-object="text" data-key="9666"><span data-slate-leaf="true" data-offset-key="9666:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="9667"><span data-slate-leaf="true" data-offset-key="9667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"xdp"</span></span></span></span><span data-slate-object="text" data-key="9668"><span data-slate-leaf="true" data-offset-key="9668:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9669"><span data-slate-object="text" data-key="9670"><span data-slate-leaf="true" data-offset-key="9670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="9671"><span data-slate-leaf="true" data-offset-key="9671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9672"><span data-slate-leaf="true" data-offset-key="9672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xdp_proxy</span></span></span></span></span><span data-slate-object="text" data-key="9673"><span data-slate-leaf="true" data-offset-key="9673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="9674"><span data-slate-leaf="true" data-offset-key="9674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="9675"><span data-slate-leaf="true" data-offset-key="9675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> xdp_md *ctx)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9676"><span data-slate-object="text" data-key="9677"><span data-slate-leaf="true" data-offset-key="9677:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9678"><span data-slate-object="text" data-key="9679"><span data-slate-leaf="true" data-offset-key="9679:0" data-first-offset="true"><span data-slate-string="true">  ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9680"><span data-slate-object="text" data-key="9681"><span data-slate-leaf="true" data-offset-key="9681:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9682"><span data-slate-leaf="true" data-offset-key="9682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 重新计算校验和 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9683"><span data-slate-object="text" data-key="9684"><span data-slate-leaf="true" data-offset-key="9684:0" data-first-offset="true"><span data-slate-string="true">  iph-&gt;check = </span></span></span><span data-slate-object="text" data-key="9685"><span data-slate-leaf="true" data-offset-key="9685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ipv4_csum</span></span></span></span><span data-slate-object="text" data-key="9686"><span data-slate-leaf="true" data-offset-key="9686:0" data-first-offset="true"><span data-slate-string="true">(iph);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9687"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9688"><span data-slate-object="text" data-key="9689"><span data-slate-leaf="true" data-offset-key="9689:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9690"><span data-slate-leaf="true" data-offset-key="9690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 把数据包从原网卡发送出去 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9691"><span data-slate-object="text" data-key="9692"><span data-slate-leaf="true" data-offset-key="9692:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9693"><span data-slate-leaf="true" data-offset-key="9693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9694"><span data-slate-leaf="true" data-offset-key="9694:0" data-first-offset="true"><span data-slate-string="true"> XDP_TX;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9695"><span data-slate-object="text" data-key="9696"><span data-slate-leaf="true" data-offset-key="9696:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9697"><span data-slate-object="text" data-key="9698"><span data-slate-leaf="true" data-offset-key="9698:0" data-first-offset="true"><span data-slate-string="true">把上述代码保存到一个文件 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9699"><span data-slate-object="text" data-key="9700"><span data-slate-leaf="true" data-offset-key="9700:0" data-first-offset="true"><span data-slate-string="true">xdp-proxy.bpf.c</span></span></span></span><span data-slate-object="text" data-key="9701"><span data-slate-leaf="true" data-offset-key="9701:0" data-first-offset="true"><span data-slate-string="true"> 中，就完成了 XDP eBPF 程序的开发（你还可以在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9702"><span data-slate-object="text" data-key="9703"><span data-slate-leaf="true" data-offset-key="9703:0" data-first-offset="true"><span data-slate-string="true">GitHub</span></span></span></a><span data-slate-object="text" data-key="9704"><span data-slate-leaf="true" data-offset-key="9704:0" data-first-offset="true"><span data-slate-string="true"> 中找到完整的代码）。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9705" id="sr-toc-4"><span data-slate-object="text" data-key="9706"><span data-slate-leaf="true" data-offset-key="9706:0" data-first-offset="true"><span data-slate-string="true">编译并生成脚手架头文件</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9707"><span data-slate-object="text" data-key="9708"><span data-slate-leaf="true" data-offset-key="9708:0" data-first-offset="true"><span data-slate-string="true">有了 XDP 程序之后，接下来的第二步就比较简单了。我们只需要执行下面的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9709"><span data-slate-object="text" data-key="9710"><span data-slate-leaf="true" data-offset-key="9710:0" data-first-offset="true"><span data-slate-string="true">clang</span></span></span></span><span data-slate-object="text" data-key="9711"><span data-slate-leaf="true" data-offset-key="9711:0" data-first-offset="true"><span data-slate-string="true"> 命令，把 XDP 程序编译成字节码，再执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9712"><span data-slate-object="text" data-key="9713"><span data-slate-leaf="true" data-offset-key="9713:0" data-first-offset="true"><span data-slate-string="true">bpftool gen skeleton</span></span></span></span><span data-slate-object="text" data-key="9714"><span data-slate-leaf="true" data-offset-key="9714:0" data-first-offset="true"><span data-slate-string="true"> 命令生成脚手架头文件即可：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9715"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9716"><span data-slate-object="text" data-key="9717"><span data-slate-leaf="true" data-offset-key="9717:0" data-first-offset="true"><span data-slate-string="true">clang -g -O2 -target bpf -D__TARGET_ARCH_x86 -I/usr/include/x86_64-linux-gnu -I. -c xdp-proxy.bpf.c -o xdp-proxy.bpf.o</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9718"><span data-slate-object="text" data-key="9719"><span data-slate-leaf="true" data-offset-key="9719:0" data-first-offset="true"><span data-slate-string="true">bpftool gen skeleton xdp-proxy.bpf.o &gt; xdp-proxy.skel.h</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9720" id="sr-toc-5"><span data-slate-object="text" data-key="9721"><span data-slate-leaf="true" data-offset-key="9721:0" data-first-offset="true"><span data-slate-string="true">开发用户态程序</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9722"><span data-slate-object="text" data-key="9723"><span data-slate-leaf="true" data-offset-key="9723:0" data-first-offset="true"><span data-slate-string="true">对于第三步用户态程序的开发，它的基本流程跟 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9724"><span data-slate-object="text" data-key="9725"><span data-slate-leaf="true" data-offset-key="9725:0" data-first-offset="true"><span data-slate-string="true">08 讲</span></span></span></a><span data-slate-object="text" data-key="9726"><span data-slate-leaf="true" data-offset-key="9726:0" data-first-offset="true"><span data-slate-string="true"> 中的内核跟踪案例是类似的，也是需要引入脚手架头文件、增大 RLIMIT_MEMLOCK、初始化并加载 BPF 字节码，最后再挂载 XDP 程序这几个步骤。忽略错误处理步骤，最核心的实现步骤如下所示：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9727"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9728"><span data-slate-object="text" data-key="9729"><span data-slate-leaf="true" data-offset-key="9729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 1. 引入脚手架头文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9730"><span data-slate-object="text" data-key="9731"><span data-slate-leaf="true" data-offset-key="9731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="9732"><span data-slate-leaf="true" data-offset-key="9732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="9733"><span data-slate-leaf="true" data-offset-key="9733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9734"><span data-slate-leaf="true" data-offset-key="9734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"xdp-proxy.skel.h"</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9735"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9736"><span data-slate-object="text" data-key="9737"><span data-slate-leaf="true" data-offset-key="9737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// C 语言主函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9738"><span data-slate-object="text" data-key="9739"><span data-slate-leaf="true" data-offset-key="9739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="9740"><span data-slate-leaf="true" data-offset-key="9740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9741"><span data-slate-leaf="true" data-offset-key="9741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="9742"><span data-slate-leaf="true" data-offset-key="9742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="9743"><span data-slate-leaf="true" data-offset-key="9743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="9744"><span data-slate-leaf="true" data-offset-key="9744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> argc, </span></span></span></span></span><span data-slate-object="text" data-key="9745"><span data-slate-leaf="true" data-offset-key="9745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span></span></span><span data-slate-object="text" data-key="9746"><span data-slate-leaf="true" data-offset-key="9746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> **argv)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9747"><span data-slate-object="text" data-key="9748"><span data-slate-leaf="true" data-offset-key="9748:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9749"><span data-slate-object="text" data-key="9750"><span data-slate-leaf="true" data-offset-key="9750:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9751"><span data-slate-leaf="true" data-offset-key="9751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 2. 增大 RLIMIT_MEMLOCK（默认值通常太小，不足以存入 BPF 映射的内容）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9752"><span data-slate-object="text" data-key="9753"><span data-slate-leaf="true" data-offset-key="9753:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9754"><span data-slate-leaf="true" data-offset-key="9754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9755"><span data-slate-leaf="true" data-offset-key="9755:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9756"><span data-slate-leaf="true" data-offset-key="9756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rlimit</span></span></span></span><span data-slate-object="text" data-key="9757"><span data-slate-leaf="true" data-offset-key="9757:0" data-first-offset="true"><span data-slate-string="true"> rlim_new = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9758"><span data-slate-object="text" data-key="9759"><span data-slate-leaf="true" data-offset-key="9759:0" data-first-offset="true"><span data-slate-string="true">      .rlim_cur = RLIM_INFINITY,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9760"><span data-slate-object="text" data-key="9761"><span data-slate-leaf="true" data-offset-key="9761:0" data-first-offset="true"><span data-slate-string="true">      .rlim_max = RLIM_INFINITY,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9762"><span data-slate-object="text" data-key="9763"><span data-slate-leaf="true" data-offset-key="9763:0" data-first-offset="true"><span data-slate-string="true">    };</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9764"><span data-slate-object="text" data-key="9765"><span data-slate-leaf="true" data-offset-key="9765:0" data-first-offset="true"><span data-slate-string="true">    err = </span></span></span><span data-slate-object="text" data-key="9766"><span data-slate-leaf="true" data-offset-key="9766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">setrlimit</span></span></span></span><span data-slate-object="text" data-key="9767"><span data-slate-leaf="true" data-offset-key="9767:0" data-first-offset="true"><span data-slate-string="true">(RLIMIT_MEMLOCK, &amp;rlim_new);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9768"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9769"><span data-slate-object="text" data-key="9770"><span data-slate-leaf="true" data-offset-key="9770:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9771"><span data-slate-leaf="true" data-offset-key="9771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 3. 初始化 BPF 程序</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9772"><span data-slate-object="text" data-key="9773"><span data-slate-leaf="true" data-offset-key="9773:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9774"><span data-slate-leaf="true" data-offset-key="9774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="9775"><span data-slate-leaf="true" data-offset-key="9775:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9776"><span data-slate-leaf="true" data-offset-key="9776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xdp_proxy_bpf</span></span></span></span><span data-slate-object="text" data-key="9777"><span data-slate-leaf="true" data-offset-key="9777:0" data-first-offset="true"><span data-slate-string="true"> *obj = </span></span></span><span data-slate-object="text" data-key="9778"><span data-slate-leaf="true" data-offset-key="9778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xdp_proxy_bpf__open</span></span></span></span><span data-slate-object="text" data-key="9779"><span data-slate-leaf="true" data-offset-key="9779:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9780"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9781"><span data-slate-object="text" data-key="9782"><span data-slate-leaf="true" data-offset-key="9782:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9783"><span data-slate-leaf="true" data-offset-key="9783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 4. 加载 BPF 字节码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9784"><span data-slate-object="text" data-key="9785"><span data-slate-leaf="true" data-offset-key="9785:0" data-first-offset="true"><span data-slate-string="true">    err = </span></span></span><span data-slate-object="text" data-key="9786"><span data-slate-leaf="true" data-offset-key="9786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">xdp_proxy_bpf__load</span></span></span></span><span data-slate-object="text" data-key="9787"><span data-slate-leaf="true" data-offset-key="9787:0" data-first-offset="true"><span data-slate-string="true">(obj);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9788"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9789"><span data-slate-object="text" data-key="9790"><span data-slate-leaf="true" data-offset-key="9790:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9791"><span data-slate-leaf="true" data-offset-key="9791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 5. </span></span></span></span><span data-slate-object="text" data-key="9792"><span data-slate-leaf="true" data-offset-key="9792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TODO:</span></span></span></span></span><span data-slate-object="text" data-key="9793"><span data-slate-leaf="true" data-offset-key="9793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> 挂载 XDP 程序到 eth0 网卡</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9794"><span data-slate-object="text" data-key="9795"><span data-slate-leaf="true" data-offset-key="9795:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9796"><span data-slate-object="text" data-key="9797"><span data-slate-leaf="true" data-offset-key="9797:0" data-first-offset="true"><span data-slate-string="true">这段代码中，前面 4 个步骤跟</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9798"><span data-slate-object="text" data-key="9799"><span data-slate-leaf="true" data-offset-key="9799:0" data-first-offset="true"><span data-slate-string="true"> 08 讲</span></span></span></a><span data-slate-object="text" data-key="9800"><span data-slate-leaf="true" data-offset-key="9800:0" data-first-offset="true"><span data-slate-string="true"> 中的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9801"><span data-slate-object="text" data-key="9802"><span data-slate-leaf="true" data-offset-key="9802:0" data-first-offset="true"><span data-slate-string="true">内核跟踪案例</span></span></span></a><span data-slate-object="text" data-key="9803"><span data-slate-leaf="true" data-offset-key="9803:0" data-first-offset="true"><span data-slate-string="true">是一样的，这儿不再详细展开。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9804"><span data-slate-object="text" data-key="9805"><span data-slate-leaf="true" data-offset-key="9805:0" data-first-offset="true"><span data-slate-string="true">而对于第 5 步的挂载过程，我在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9806"><span data-slate-object="text" data-key="9807"><span data-slate-leaf="true" data-offset-key="9807:0" data-first-offset="true"><span data-slate-string="true"> 06 讲</span></span></span></a><span data-slate-object="text" data-key="9808"><span data-slate-leaf="true" data-offset-key="9808:0" data-first-offset="true"><span data-slate-string="true"> 中曾经提到，你可以使用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9809"><span data-slate-object="text" data-key="9810"><span data-slate-leaf="true" data-offset-key="9810:0" data-first-offset="true"><span data-slate-string="true">ip link</span></span></span></span><span data-slate-object="text" data-key="9811"><span data-slate-leaf="true" data-offset-key="9811:0" data-first-offset="true"><span data-slate-string="true"> 命令来挂载 XDP 程序。当时讲到的是在主机中挂载 XDP 的步骤，而在容器中的步骤其实也是一样的（注意，在容器中的虚拟网卡上，只支持以通用模式挂载）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9812"><span data-slate-object="text" data-key="9813"><span data-slate-leaf="true" data-offset-key="9813:0" data-first-offset="true"><span data-slate-string="true">下面的代码展示的就是把 XDP 字节码复制到负载均衡容器并挂载到 eth0 网卡的过程：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9814"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9815"><span data-slate-object="text" data-key="9816"><span data-slate-leaf="true" data-offset-key="9816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 复制字节码到容器中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9817"><span data-slate-object="text" data-key="9818"><span data-slate-leaf="true" data-offset-key="9818:0" data-first-offset="true"><span data-slate-string="true">docker </span></span></span><span data-slate-object="text" data-key="9819"><span data-slate-leaf="true" data-offset-key="9819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cp</span></span></span></span><span data-slate-object="text" data-key="9820"><span data-slate-leaf="true" data-offset-key="9820:0" data-first-offset="true"><span data-slate-string="true"> xdp-proxy.bpf.o lb:/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9821"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9822"><span data-slate-object="text" data-key="9823"><span data-slate-leaf="true" data-offset-key="9823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 在容器中安装 iproute2 命令行工具</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9824"><span data-slate-object="text" data-key="9825"><span data-slate-leaf="true" data-offset-key="9825:0" data-first-offset="true"><span data-slate-string="true">docker </span></span></span><span data-slate-object="text" data-key="9826"><span data-slate-leaf="true" data-offset-key="9826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exec</span></span></span></span><span data-slate-object="text" data-key="9827"><span data-slate-leaf="true" data-offset-key="9827:0" data-first-offset="true"><span data-slate-string="true"> -it lb apk add iproute2 --update</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9828"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9829"><span data-slate-object="text" data-key="9830"><span data-slate-leaf="true" data-offset-key="9830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 在容器中挂载 XDP 程序到 eth0 网卡</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9831"><span data-slate-object="text" data-key="9832"><span data-slate-leaf="true" data-offset-key="9832:0" data-first-offset="true"><span data-slate-string="true">docker </span></span></span><span data-slate-object="text" data-key="9833"><span data-slate-leaf="true" data-offset-key="9833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exec</span></span></span></span><span data-slate-object="text" data-key="9834"><span data-slate-leaf="true" data-offset-key="9834:0" data-first-offset="true"><span data-slate-string="true"> -it lb ip </span></span></span><span data-slate-object="text" data-key="9835"><span data-slate-leaf="true" data-offset-key="9835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">link</span></span></span></span><span data-slate-object="text" data-key="9836"><span data-slate-leaf="true" data-offset-key="9836:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9837"><span data-slate-leaf="true" data-offset-key="9837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set</span></span></span></span><span data-slate-object="text" data-key="9838"><span data-slate-leaf="true" data-offset-key="9838:0" data-first-offset="true"><span data-slate-string="true"> dev eth0 xdpgeneric object xdp-proxy.bpf.o sec xdp</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9839"><span data-slate-object="text" data-key="9840"><span data-slate-leaf="true" data-offset-key="9840:0" data-first-offset="true"><span data-slate-string="true">除了使用命令行工具之外，你还可以在用户态程序中调用库函数来挂载 XDP 程序，从而避免引入额外的命令行工具依赖（比如，不再需要安装 iproute2 系统工具）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9841"><span data-slate-object="text" data-key="9842"><span data-slate-leaf="true" data-offset-key="9842:0" data-first-offset="true"><span data-slate-string="true">libbpf 提供了一个 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9843"><span data-slate-object="text" data-key="9844"><span data-slate-leaf="true" data-offset-key="9844:0" data-first-offset="true"><span data-slate-string="true">bpf_set_link_xdp_fd(int ifindex, int fd, __u32 flags)</span></span></span></span><span data-slate-object="text" data-key="9845"><span data-slate-leaf="true" data-offset-key="9845:0" data-first-offset="true"><span data-slate-string="true"> 函数，可用于把 XDP 程序挂载到网卡。这个函数需要网卡序号和 XDP 程序文件描述符作为参数，查询这些参数并挂载 XDP 的过程如下所示：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="9846"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9847"><span data-slate-object="text" data-key="9848"><span data-slate-leaf="true" data-offset-key="9848:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9849"><span data-slate-leaf="true" data-offset-key="9849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="9850"><span data-slate-leaf="true" data-offset-key="9850:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9851"><span data-slate-leaf="true" data-offset-key="9851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9852"><span data-slate-leaf="true" data-offset-key="9852:0" data-first-offset="true"><span data-slate-string="true"> ifindex = if_nametoindex(</span></span></span><span data-slate-object="text" data-key="9853"><span data-slate-leaf="true" data-offset-key="9853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"eth0"</span></span></span></span><span data-slate-object="text" data-key="9854"><span data-slate-leaf="true" data-offset-key="9854:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9855"><span data-slate-object="text" data-key="9856"><span data-slate-leaf="true" data-offset-key="9856:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9857"><span data-slate-leaf="true" data-offset-key="9857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="9858"><span data-slate-leaf="true" data-offset-key="9858:0" data-first-offset="true"><span data-slate-string="true"> prog_id = </span></span></span><span data-slate-object="text" data-key="9859"><span data-slate-leaf="true" data-offset-key="9859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bpf_program__fd</span></span></span></span><span data-slate-object="text" data-key="9860"><span data-slate-leaf="true" data-offset-key="9860:0" data-first-offset="true"><span data-slate-string="true">(obj-&gt;progs.xdp_proxy);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9861"><span data-slate-object="text" data-key="9862"><span data-slate-leaf="true" data-offset-key="9862:0" data-first-offset="true"><span data-slate-string="true">    err = </span></span></span><span data-slate-object="text" data-key="9863"><span data-slate-leaf="true" data-offset-key="9863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bpf_set_link_xdp_fd</span></span></span></span><span data-slate-object="text" data-key="9864"><span data-slate-leaf="true" data-offset-key="9864:0" data-first-offset="true"><span data-slate-string="true">(ifindex, prog_id, XDP_FLAGS_UPDATE_IF_NOEXIST|XDP_FLAGS_SKB_MODE);</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9865"><span data-slate-object="text" data-key="9866"><span data-slate-leaf="true" data-offset-key="9866:0" data-first-offset="true"><span data-slate-string="true">这段代码中，挂载参数标志 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9867"><span data-slate-object="text" data-key="9868"><span data-slate-leaf="true" data-offset-key="9868:0" data-first-offset="true"><span data-slate-string="true">XDP_FLAGS_SKB_MODE</span></span></span></span><span data-slate-object="text" data-key="9869"><span data-slate-leaf="true" data-offset-key="9869:0" data-first-offset="true"><span data-slate-string="true"> 等同于 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9870"><span data-slate-object="text" data-key="9871"><span data-slate-leaf="true" data-offset-key="9871:0" data-first-offset="true"><span data-slate-string="true">ip link</span></span></span></span><span data-slate-object="text" data-key="9872"><span data-slate-leaf="true" data-offset-key="9872:0" data-first-offset="true"><span data-slate-string="true"> 命令中的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9873"><span data-slate-object="text" data-key="9874"><span data-slate-leaf="true" data-offset-key="9874:0" data-first-offset="true"><span data-slate-string="true">xdpgeneric</span></span></span></span><span data-slate-object="text" data-key="9875"><span data-slate-leaf="true" data-offset-key="9875:0" data-first-offset="true"><span data-slate-string="true">，表示以通用模式挂载。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9876"><span data-slate-object="text" data-key="9877"><span data-slate-leaf="true" data-offset-key="9877:0" data-first-offset="true"><span data-slate-string="true">把上述代码保存到 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9878"><span data-slate-object="text" data-key="9879"><span data-slate-leaf="true" data-offset-key="9879:0" data-first-offset="true"><span data-slate-string="true">xdp-proxy.c</span></span></span></span><span data-slate-object="text" data-key="9880"><span data-slate-leaf="true" data-offset-key="9880:0" data-first-offset="true"><span data-slate-string="true"> 文件中（你还可以在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9881"><span data-slate-object="text" data-key="9882"><span data-slate-leaf="true" data-offset-key="9882:0" data-first-offset="true"><span data-slate-string="true">GitHub</span></span></span></a><span data-slate-object="text" data-key="9883"><span data-slate-leaf="true" data-offset-key="9883:0" data-first-offset="true"><span data-slate-string="true"> 中找到完整的代码），再执行下面的编译命令，就可以将其编译为静态链接的可执行文件。采用静态链接的一个好处是容易在容器中分发，只需要把最终的二进制文件放入容器中即可运行，不再需要安装额外的依赖环境。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9884"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9885"><span data-slate-object="text" data-key="9886"><span data-slate-leaf="true" data-offset-key="9886:0" data-first-offset="true"><span data-slate-string="true">clang -g -O2 -Wall -I. -c xdp-proxy.c -o xdp-proxy.o</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9887"><span data-slate-object="text" data-key="9888"><span data-slate-leaf="true" data-offset-key="9888:0" data-first-offset="true"><span data-slate-string="true">clang -Wall -O2 -g xdp-proxy.o -static -lbpf -lelf -lz -o xdp-proxy</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9889"><span data-slate-object="text" data-key="9890"><span data-slate-leaf="true" data-offset-key="9890:0" data-first-offset="true"><span data-slate-string="true">到这里，完整的 eBPF 程序就开发好了。它是不是可以正常工作呢？如果可以正常工作，性能又会怎么样？接下来，我们把它放到容器中测试一下看看。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9891" id="sr-toc-6"><span data-slate-object="text" data-key="9892"><span data-slate-leaf="true" data-offset-key="9892:0" data-first-offset="true"><span data-slate-string="true">性能测试</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9893"><span data-slate-object="text" data-key="9894"><span data-slate-leaf="true" data-offset-key="9894:0" data-first-offset="true"><span data-slate-string="true">在终端中执行下面的 docker 命令，把 XDP 程序复制到负载均衡容器中，并执行 XDP 程序：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9895"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9896"><span data-slate-object="text" data-key="9897"><span data-slate-leaf="true" data-offset-key="9897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 复制 XDP 程序到容器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9898"><span data-slate-object="text" data-key="9899"><span data-slate-leaf="true" data-offset-key="9899:0" data-first-offset="true"><span data-slate-string="true">docker </span></span></span><span data-slate-object="text" data-key="9900"><span data-slate-leaf="true" data-offset-key="9900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cp</span></span></span></span><span data-slate-object="text" data-key="9901"><span data-slate-leaf="true" data-offset-key="9901:0" data-first-offset="true"><span data-slate-string="true"> xdp-proxy lb:/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9902"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9903"><span data-slate-object="text" data-key="9904"><span data-slate-leaf="true" data-offset-key="9904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 在容器中加载 XDP 程序</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9905"><span data-slate-object="text" data-key="9906"><span data-slate-leaf="true" data-offset-key="9906:0" data-first-offset="true"><span data-slate-string="true">docker </span></span></span><span data-slate-object="text" data-key="9907"><span data-slate-leaf="true" data-offset-key="9907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exec</span></span></span></span><span data-slate-object="text" data-key="9908"><span data-slate-leaf="true" data-offset-key="9908:0" data-first-offset="true"><span data-slate-string="true"> -it lb /xdp-proxy</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9909"><span data-slate-object="text" data-key="9910"><span data-slate-leaf="true" data-offset-key="9910:0" data-first-offset="true"><span data-slate-string="true">然后，进入客户端容器终端中，执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9911"><span data-slate-object="text" data-key="9912"><span data-slate-leaf="true" data-offset-key="9912:0" data-first-offset="true"><span data-slate-string="true">apk</span></span></span></span><span data-slate-object="text" data-key="9913"><span data-slate-leaf="true" data-offset-key="9913:0" data-first-offset="true"><span data-slate-string="true"> 命令安装 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9914"><span data-slate-object="text" data-key="9915"><span data-slate-leaf="true" data-offset-key="9915:0" data-first-offset="true"><span data-slate-string="true">curl</span></span></span></span><span data-slate-object="text" data-key="9916"><span data-slate-leaf="true" data-offset-key="9916:0" data-first-offset="true"><span data-slate-string="true"> 和 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9917"><span data-slate-object="text" data-key="9918"><span data-slate-leaf="true" data-offset-key="9918:0" data-first-offset="true"><span data-slate-string="true">wrk</span></span></span></span><span data-slate-object="text" data-key="9919"><span data-slate-leaf="true" data-offset-key="9919:0" data-first-offset="true"><span data-slate-string="true"> 工具，接着再使用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9920"><span data-slate-object="text" data-key="9921"><span data-slate-leaf="true" data-offset-key="9921:0" data-first-offset="true"><span data-slate-string="true">curl</span></span></span></span><span data-slate-object="text" data-key="9922"><span data-slate-leaf="true" data-offset-key="9922:0" data-first-offset="true"><span data-slate-string="true"> 访问负载均衡器：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9923"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9924"><span data-slate-object="text" data-key="9925"><span data-slate-leaf="true" data-offset-key="9925:0" data-first-offset="true"><span data-slate-string="true">docker </span></span></span><span data-slate-object="text" data-key="9926"><span data-slate-leaf="true" data-offset-key="9926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exec</span></span></span></span><span data-slate-object="text" data-key="9927"><span data-slate-leaf="true" data-offset-key="9927:0" data-first-offset="true"><span data-slate-string="true"> -it client sh</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9928"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9929"><span data-slate-object="text" data-key="9930"><span data-slate-leaf="true" data-offset-key="9930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># (以下命令运行在 client 容器中)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9931"><span data-slate-object="text" data-key="9932"><span data-slate-leaf="true" data-offset-key="9932:0" data-first-offset="true"><span data-slate-string="true">/ </span></span></span><span data-slate-object="text" data-key="9933"><span data-slate-leaf="true" data-offset-key="9933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># curl "http://172.17.0.5"</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9934"><span data-slate-object="text" data-key="9935"><span data-slate-leaf="true" data-offset-key="9935:0" data-first-offset="true"><span data-slate-string="true">如果你看到 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9936"><span data-slate-object="text" data-key="9937"><span data-slate-leaf="true" data-offset-key="9937:0" data-first-offset="true"><span data-slate-string="true">Hostname: http1</span></span></span></span><span data-slate-object="text" data-key="9938"><span data-slate-leaf="true" data-offset-key="9938:0" data-first-offset="true"><span data-slate-string="true"> 或者 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9939"><span data-slate-object="text" data-key="9940"><span data-slate-leaf="true" data-offset-key="9940:0" data-first-offset="true"><span data-slate-string="true">Hostname: http12</span></span></span></span><span data-slate-object="text" data-key="9941"><span data-slate-leaf="true" data-offset-key="9941:0" data-first-offset="true"><span data-slate-string="true"> 的输出，说明 XDP 已经成功运行，并且它的负载均衡功能也是正常的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9942"><span data-slate-object="text" data-key="9943"><span data-slate-leaf="true" data-offset-key="9943:0" data-first-offset="true"><span data-slate-string="true">接下来，继续在客户端容器终端中执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9944"><span data-slate-object="text" data-key="9945"><span data-slate-leaf="true" data-offset-key="9945:0" data-first-offset="true"><span data-slate-string="true">wrk</span></span></span></span><span data-slate-object="text" data-key="9946"><span data-slate-leaf="true" data-offset-key="9946:0" data-first-offset="true"><span data-slate-string="true"> 命令，给负载均衡器做个性能测试：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9947"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9948"><span data-slate-object="text" data-key="9949"><span data-slate-leaf="true" data-offset-key="9949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># (以下命令运行在 client 容器中)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9950"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9951"><span data-slate-object="text" data-key="9952"><span data-slate-leaf="true" data-offset-key="9952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 安装 wrk 工具</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9953"><span data-slate-object="text" data-key="9954"><span data-slate-leaf="true" data-offset-key="9954:0" data-first-offset="true"><span data-slate-string="true">/ </span></span></span><span data-slate-object="text" data-key="9955"><span data-slate-leaf="true" data-offset-key="9955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># apk add curl wrk --update</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9956"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9957"><span data-slate-object="text" data-key="9958"><span data-slate-leaf="true" data-offset-key="9958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 执行性能测试</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9959"><span data-slate-object="text" data-key="9960"><span data-slate-leaf="true" data-offset-key="9960:0" data-first-offset="true"><span data-slate-string="true">/ </span></span></span><span data-slate-object="text" data-key="9961"><span data-slate-leaf="true" data-offset-key="9961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># wrk -c100 "http://172.17.0.5"</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9962"><span data-slate-object="text" data-key="9963"><span data-slate-leaf="true" data-offset-key="9963:0" data-first-offset="true"><span data-slate-string="true">稍等一会，你会看到如下的输出（在你的环境下可能看到不同数值，具体的性能指标取决于运行环境和配置）：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9964"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9965"><span data-slate-object="text" data-key="9966"><span data-slate-leaf="true" data-offset-key="9966:0" data-first-offset="true"><span data-slate-string="true">Running 10s </span></span></span><span data-slate-object="text" data-key="9967"><span data-slate-leaf="true" data-offset-key="9967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="9968"><span data-slate-leaf="true" data-offset-key="9968:0" data-first-offset="true"><span data-slate-string="true"> @ http://172.17.0.5</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9969"><span data-slate-object="text" data-key="9970"><span data-slate-leaf="true" data-offset-key="9970:0" data-first-offset="true"><span data-slate-string="true">  2 threads and 100 connections</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9971"><span data-slate-object="text" data-key="9972"><span data-slate-leaf="true" data-offset-key="9972:0" data-first-offset="true"><span data-slate-string="true">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9973"><span data-slate-object="text" data-key="9974"><span data-slate-leaf="true" data-offset-key="9974:0" data-first-offset="true"><span data-slate-string="true">    Latency     6.37ms   11.17ms 295.43ms   98.97%</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9975"><span data-slate-object="text" data-key="9976"><span data-slate-leaf="true" data-offset-key="9976:0" data-first-offset="true"><span data-slate-string="true">    Req/Sec     9.09k   422.06    10.09k    75.00%</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9977"><span data-slate-object="text" data-key="9978"><span data-slate-leaf="true" data-offset-key="9978:0" data-first-offset="true"><span data-slate-string="true">  180889 requests </span></span></span><span data-slate-object="text" data-key="9979"><span data-slate-leaf="true" data-offset-key="9979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">in</span></span></span></span><span data-slate-object="text" data-key="9980"><span data-slate-leaf="true" data-offset-key="9980:0" data-first-offset="true"><span data-slate-string="true"> 10.02s, 31.39MB </span></span></span><span data-slate-object="text" data-key="9981"><span data-slate-leaf="true" data-offset-key="9981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">read</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9982"><span data-slate-object="text" data-key="9983"><span data-slate-leaf="true" data-offset-key="9983:0" data-first-offset="true"><span data-slate-string="true">Requests/sec:  18048.65</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9984"><span data-slate-object="text" data-key="9985"><span data-slate-leaf="true" data-offset-key="9985:0" data-first-offset="true"><span data-slate-string="true">Transfer/sec:      3.13MB</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9986"><span data-slate-object="text" data-key="9987"><span data-slate-leaf="true" data-offset-key="9987:0" data-first-offset="true"><span data-slate-string="true">从输出中你可以看到，平均每秒请求数是 18048，每个线程的平均延迟是 6.37ms。回顾一下 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9988"><span data-slate-object="text" data-key="9989"><span data-slate-leaf="true" data-offset-key="9989:0" data-first-offset="true"><span data-slate-string="true">12 讲</span></span></span></a><span data-slate-object="text" data-key="9990"><span data-slate-leaf="true" data-offset-key="9990:0" data-first-offset="true"><span data-slate-string="true"> 中的套接字 eBPF 程序的性能测试结果，它的平均每秒请求数是 15300，而每个线程的平均延迟是 6.88ms。这说明，相比套接字程序，XDP 程序在平均每秒请求数上提升了 18%。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9991"><span data-slate-object="text" data-key="9992"><span data-slate-leaf="true" data-offset-key="9992:0" data-first-offset="true"><span data-slate-string="true">最后，不要忘记清理今天的案例环境。由于所有服务都运行在容器中，我们只需要执行下面的命令，删除今天创建的所有容器，即可完成清理工作：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="9993"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9994"><span data-slate-object="text" data-key="9995"><span data-slate-leaf="true" data-offset-key="9995:0" data-first-offset="true"><span data-slate-string="true">docker </span></span></span><span data-slate-object="text" data-key="9996"><span data-slate-leaf="true" data-offset-key="9996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">rm</span></span></span></span><span data-slate-object="text" data-key="9997"><span data-slate-leaf="true" data-offset-key="9997:0" data-first-offset="true"><span data-slate-string="true"> -f lb client http1 http2</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9998" id="sr-toc-7"><span data-slate-object="text" data-key="9999"><span data-slate-leaf="true" data-offset-key="9999:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10000"><span data-slate-object="text" data-key="10001"><span data-slate-leaf="true" data-offset-key="10001:0" data-first-offset="true"><span data-slate-string="true">今天，我带你使用 libbpf 开发了一个基于 XDP 的负载均衡服务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10002"><span data-slate-object="text" data-key="10003"><span data-slate-leaf="true" data-offset-key="10003:0" data-first-offset="true"><span data-slate-string="true">XDP 程序在网络驱动程序刚刚收到数据包的时候触发执行。由于还未分配内核 SKB 数据结构，XDP 程序只能根据 TCP/IP 协议的封包格式，从原始网络包中提取所需协议层的数据，进而再按照需要进行改写或转发。XDP 程序修改过的数据包可以转发给相同或不同的网卡，再交给内核协议栈继续处理；或者，跟处理逻辑无关的包不做任何处理，直接交给内核协议栈进行处理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10004"><span data-slate-object="text" data-key="10005"><span data-slate-leaf="true" data-offset-key="10005:0" data-first-offset="true"><span data-slate-string="true">今天的案例把 XDP 程序挂载到了容器的虚拟网卡上，由于采用了通用模式挂载，它的执行过程其实还是在内核中运行的。在实际生产环境中，你可以以原生模式或卸载模式把 XDP 程序挂载到支持 XDP 的网卡上，从而获得最优的网络性能。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10006" id="sr-toc-8"><span data-slate-object="text" data-key="10007"><span data-slate-leaf="true" data-offset-key="10007:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10008"><span data-slate-object="text" data-key="10009"><span data-slate-leaf="true" data-offset-key="10009:0" data-first-offset="true"><span data-slate-string="true">最后，我想邀请你来聊一聊：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10010"><div data-slate-type="list-line" data-slate-object="block" data-key="10011"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="10012"><span data-slate-leaf="true" data-offset-key="10012:0" data-first-offset="true"><span data-slate-string="true">在今天的案例中，我们把 XDP 程序挂载到了负载均衡容器中的网卡上。如果把它直接挂载到主机的 eth0 网卡，会有什么样的现象？</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="10013"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="10014"><span data-slate-leaf="true" data-offset-key="10014:0" data-first-offset="true"><span data-slate-string="true">针对今天的负载均衡场景，还有哪些方法可以进一步优化 XDP 程序的性能？</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10015"><span data-slate-object="text" data-key="10016"><span data-slate-leaf="true" data-offset-key="10016:0" data-first-offset="true"><span data-slate-string="true">期待你在留言区和我讨论，也欢迎把这节课分享给你的同事、朋友。让我们一起在实战中演练，在交流中进步。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/94/c1/9415076c60e63fc6303d9a3bc900b5c1.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-9">精选留言 (11)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>莫名</span></div></div><div>1. 挂在宿主机的 eth0 网卡，会导致宿主机网络受影响，最直接的影响是来自外部的 ssh 连接异常，之后再执行 ssh 也登不进宿主机。（原因是源 IP 不是 CLIENT_IP 时将目的 IP 直接修改为 CLIENT_IP，源 IP 无论如何均修改为 LOADBALANCER_IP，进来的数据包无法正常被接收与响应）

2. 目前的实现有些 hardcode，不利于扩展，负载均衡器通常运行配置多个 vip，每个 vip 对应若干真正的后端服务。觉得改进措施可以用 BPF map 类型存储，最好有个文本格式的配置文件，程序加载前解析这个配置文件，填充 BPF map。xdp 程序中根据 key（比如 vip 或者 UUID）查找真正的后端服务，如果能够找到则从中读取 IP、Mac 等信息。</div><div><p>作者回复：非常赞的答案👍 如果能把这些思路再都实现了就更好了😊</p></div><div><div>2022-02-15</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/f6/2f/d3f1dae6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>L33K</span></div></div><div>如果一个上层的大包被拆成一个多个包发过来，目前这种负载均衡方式是不是可能就有问题了？</div><div><p>作者回复：嗯 XDP 是有一些限制的，具体可以参考这个 PPT： https://lpc.events/event/11/contributions/939/attachments/771/1551/xdp-multi-buff.pdf</p></div><div><div>2022-02-27</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83erBT5LK5f0w6MHCyX7Tuc1aytDlSazDkFPibwZ113Luz8qLviccotz4k3oIePQzrZhHEBWSDKUIjw7A/132"></div></div><div><div><div><span>aith</span></div></div><div>XDP 程序把数据包随机调度到某个 Webserver，没有会话保持，会不会导致同一次请求的数据包，发送到不同的后端 Webserver 上面，从而不能正常相应？</div><div><div>2022-05-24</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/6d/5f/a937f7f1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 乌拉呆 zyb</span></div></div><div>倪老师，还想请教您一个问题： 加载 XDP eBPF 程序后，curl "http://172.17.0.5" 测试正常，有负载均衡能力；但 wrk -c 100 "http://172.17.0.5" 的测试结果中有 Socker errors 的连接超时的报错如下：
/ # wrk -c 100 "http://172.17.0.5"
Running 10s test @ http://172.17.0.5
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   274.75ms  384.76ms   1.70s    86.88%
    Req/Sec   127.44     86.42   530.00     69.19%
  2640 requests in 10.09s, 469.22KB read
  Socket errors: connect 0, read 0, write 0, timeout 56
Requests/sec:    261.64
Transfer/sec:     46.50KB
/ # </div><div><div>2022-05-04</div><div><div><i></i><span>1</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/6d/5f/a937f7f1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 乌拉呆 zyb</span></div></div><div>倪老师，请问为什么将 XDP eBPF 程序挂载上去之后，优化效果反而大大地下降了？优化前 Requests/sec 是 7500 左右；XDP 优化后 Requests/sec 是 250 左右；代码都是 github 上的代码；两个版本的都试过了，都是反向优化，不知道为啥 ^~^</div><div><div>2022-05-04</div><div><div><i></i><span>1</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/55/54/97419b60.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>codejw</span></div></div><div>老师，如果有多个 xdp 程序如何挂载呢，我有多个. o 都挂载到 xdp</div><div><p>作者回复：如果是不同的网卡，多次调用挂载和加载的函数或者用 ip link set 命令都可以。但如果想挂载多个 XDP 程序到相同的网卡，那就需要 5.10 新增的 freplace 类型，具体细节可以参考 https://lpc.events/event/7/contributions/671/attachments/561/992/xdp-multiprog.pdf</p></div><div><div>2022-02-16</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/27/c5/d4d00da2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 为了维护世界和平</span></div></div><div>倪老师你好，使用 XDP 速度慢了，这大概什么原因呢
/ # wrk -c100 "http://172.17.0.5"
Running 10s test @ http://172.17.0.5
  2 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   272.26ms  386.46ms   1.70s    86.32%
    Req/Sec   122.51     90.04   580.00     73.65%
  2483 requests in 10.06s, 441.31KB read
  Socket errors: connect 0, read 0, write 0, timeout 53
Requests/sec:    246.73
Transfer/sec:     43.85KB
</div><div><div>2022-07-20</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/pNKoOAa1QXibrykHNXibW4tyaIIhicocPGXtcVnEianCyOQY9bl0P2JQ3wSialUaolcLVEWycCEBz1Oe4Tj4yghH9yw/132"></div></div><div><div><div><span>Geek_5aa343</span></div></div><div>libbpf 中的 section_defs 链接更新下：https://github.com/libbpf/libbpf/blob/master/src/libbpf.c#L9003-L9080</div><div><div>2022-05-15</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/ce/b4/bb5d7f90.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>林靖</span></div></div><div>我知道了 应该是我 iproute2 有问题</div><div><div>2022-03-30</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/ce/b4/bb5d7f90.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>林靖</span></div></div><div>倪都你好，我参考 tc-bpf 手册编译了一个 tc 程序，源码如下：
#include &lt;linux/bpf.h&gt;

           #ifndef __section
           # define __section (x)  __attribute__((section (x), used))
           #endif

           __section ("classifier") int cls_main (struct __sk_buff *skb)
           {
                   return -1;
           }

           char __license [] __section ("license") = "GPL";
编译完用 tc 加载的时候报如下错误：
tc filter add dev eth0 parent 1: bpf obj bcc.o verbose flowid 1:1 skip_sw
libbpf: loading bcc.o
libbpf: elf: section (3) classifier, size 24, link 0, flags 6, type=1
libbpf: elf: section (4) license, size 4, link 0, flags 3, type=1
libbpf: license of bcc.o is GPL
libbpf: elf: section (5) .eh_frame, size 48, link 0, flags 2, type=1
libbpf: elf: skipping unrecognized data section (5) .eh_frame
libbpf: elf: section (6) .rel.eh_frame, size 16, link 7, flags 0, type=9
libbpf: elf: skipping relo section (6) .rel.eh_frame for section (5) .eh_frame
libbpf: elf: section (7) .symtab, size 96, link 1, flags 0, type=2
libbpf: looking for externs among 4 symbols...
libbpf: collected 0 externs total
object file doesn't contain sec classifier
Unable to load program

这个问题是怎么回事，找了一下午都没有发现问题出在哪
</div><div><div>2022-03-30</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/e8/f8/2c1958b6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>yuan</span></div></div><div>老师好，我用如下命令编译静态链接的可执行文件时报错了，代码用的是 github 中的代码，请问有啥思路吗？
命令：clang -Wall -O2 -g xdp-proxy-v2.o -static -lbpf -lelf -lz -o xdp-proxy-v2
结果：/usr/bin/ld: cannot find -lbpf
/usr/bin/ld: cannot find -lelf
/usr/bin/ld: cannot find -lz
/usr/bin/ld: cannot find -lc
clang-13: error: linker command failed with exit code 1 (use -v to see invocation)

另外用 ip link 挂载也不行
命令：sudo ip link set dev eth0 xdpgeneric object xdp-proxy-v2.bpf.o sec xdp
结果：
BTF debug data section '.BTF' rejected: Invalid argument (22)!
 - Length:       1817
Verifier analysis:
... ...
Prog section 'xdp' rejected: Permission denied (13)!
 - Type:         6
 - Instructions: 151 (0 over limit)
 - License:      GPL

Verifier analysis:
... ...
processed 25 insns (limit 1000000) max_states_per_insn 0 total_states 1 peak_states 1 mark_read 1

Error fetching program/map!

内核版本信息如下：
5.14.10-300.fc35.x86_64
Fedora release 35 (Thirty Five)</div><div><p>作者回复：缺少依赖库，参考根目录的 Readme 把依赖库安装一下</p></div><div><div>2022-03-01</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".15"><outline class="toc-level-h1" data-reactid=".15.0" style="width: 175px;"><active data-reactid=".15.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".15.0.1"><span data-reactid=".15.0.1.0">13｜高性能网络实战（下）：如何完善负载均衡器？</span></a></outline><outline class="toc-level-h2" data-reactid=".15.1" style="width: 165px;"><active data-reactid=".15.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".15.1.1"><span data-reactid=".15.1.1.0">案例准备</span></a></outline><outline class="toc-level-h2" data-reactid=".15.2" style="width: 165px;"><active data-reactid=".15.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".15.2.1"><span data-reactid=".15.2.1.0">如何用 XDP 开发一个负载均衡器？</span></a></outline><outline class="toc-level-h3" data-reactid=".15.3" style="width: 155px;"><active data-reactid=".15.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".15.3.1"><span data-reactid=".15.3.1.0">开发 XDP eBPF 程序</span></a></outline><outline class="toc-level-h3" data-reactid=".15.4" style="width: 155px;"><active data-reactid=".15.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".15.4.1"><span data-reactid=".15.4.1.0">编译并生成脚手架头文件</span></a></outline><outline class="toc-level-h3" data-reactid=".15.5" style="width: 155px;"><active data-reactid=".15.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".15.5.1"><span data-reactid=".15.5.1.0">开发用户态程序</span></a></outline><outline class="toc-level-h3" data-reactid=".15.6" style="width: 155px;"><active data-reactid=".15.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".15.6.1"><span data-reactid=".15.6.1.0">性能测试</span></a></outline><outline class="toc-level-h2" data-reactid=".15.7" style="width: 165px;"><active data-reactid=".15.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".15.7.1"><span data-reactid=".15.7.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".15.8" style="width: 165px;"><active data-reactid=".15.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".15.8.1"><span data-reactid=".15.8.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".15.9" style="width: 165px;"><active data-reactid=".15.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".15.9.1"><span data-reactid=".15.9.1.0">精选留言 (11)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/486353" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>