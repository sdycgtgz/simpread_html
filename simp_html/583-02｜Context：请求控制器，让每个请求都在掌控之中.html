
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 02｜Context：请求控制器，让每个请求都在掌控之中</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>02｜Context：请求控制器，让每个请求都在掌控之中</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0"> 02｜Context：请求控制器，让每个请求都在掌控之中</h1><div><span>叶剑峰</span> <span> 2021-09-15</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/93/1f/93b4ce77a021847d9c6ea8141186ef1f.jpeg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：叶剑峰</span><span>大小：17.61M</span><span> 时长：19:17</span></div></div><audio title="02｜Context：请求控制器，让每个请求都在掌控之中" src="https://res001.geekbang.org/media/audio/75/4f/755292d97f341be62c0258d71efe4d4f/ld/ld.m3u8" __idm_id__="696323"></audio></div><div><div><div><div data-slate-editor="true" data-key="1024" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="1025"><span data-slate-object="text" data-key="1026"><span data-slate-leaf="true" data-offset-key="1026:0" data-first-offset="true"><span data-slate-string="true">你好，我是轩脉刃。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1027"><span data-slate-object="text" data-key="1028"><span data-slate-leaf="true" data-offset-key="1028:0" data-first-offset="true"><span data-slate-string="true">上一讲我们使用 net/http 搭建了一个最简单的 HTTP 服务，为了帮你理解服务启动逻辑，我用思维导图梳理了主流程，如果你还有不熟悉，可以再回顾一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1029"><span data-slate-object="text" data-key="1030"><span data-slate-leaf="true" data-offset-key="1030:0" data-first-offset="true"><span data-slate-string="true">今天我将带你进一步丰富我们的框架，添加上下文 Context 为请求设置超时时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1031"><span data-slate-object="text" data-key="1032"><span data-slate-leaf="true" data-offset-key="1032:0" data-first-offset="true"><span data-slate-string="true">从主流程中我们知道（第三层关键结论），HTTP 服务会为每个请求创建一个 Goroutine 进行服务处理。在服务处理的过程中，有可能就在本地执行业务逻辑，也有可能再去下游服务获取数据。如下图，本地处理逻辑 A，下游服务 a/b/c/d， 会形成一个标准的树形逻辑链条。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1033"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/33/71/33361f90298865f98e3038f11f02e671.jpg?wh=1920x1080"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1034"><span data-slate-object="text" data-key="1035"><span data-slate-leaf="true" data-offset-key="1035:0" data-first-offset="true"><span data-slate-string="true">在这个逻辑链条中，每个本地处理逻辑，或者下游服务请求节点，都有可能存在超时问题。</span></span></span><span data-slate-object="text" data-key="1036"><span data-slate-leaf="true" data-offset-key="1036:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">而对于 HTTP 服务而言，超时往往是造成服务不可用、甚至系统瘫痪的罪魁祸首</span></span></span></span><span data-slate-object="text" data-key="1037"><span data-slate-leaf="true" data-offset-key="1037:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1038"><span data-slate-object="text" data-key="1039"><span data-slate-leaf="true" data-offset-key="1039:0" data-first-offset="true"><span data-slate-string="true">系统瘫痪也就是我们俗称的雪崩，某个服务的不可用引发了其他服务的不可用。比如上图中，如果服务 d 超时，导致请求处理缓慢甚至不可用，加剧了 Goroutine 堆积，</span></span><span data-slate-leaf="true" data-offset-key="1039:1"><span data-slate-object="annotation" data-annotation-key="gkann_6d1088c7" data-attr-id="27364" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">同时也造成了服务 a/b/c 的请求堆积，Goroutine 堆积，瞬时请求数加大，</span></span></span><span data-slate-leaf="true" data-offset-key="1039:2"><span data-slate-string="true">导致 a/b/c 的服务都不可用，整个系统瘫痪，怎么办？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1040"><span data-slate-object="text" data-key="1041"><span data-slate-leaf="true" data-offset-key="1041:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_33fbd579" data-attr-id="27876" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">最有效的方法就是从源头上控制一个请求的 “最大处理时长”，所以，对于一个 Web 框架而言，“超时控制” 能力是必备的。今天我们就用 Context 为框架增加这个能力。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1042" id="sr-toc-1"><span data-slate-object="text" data-key="1043"><span data-slate-leaf="true" data-offset-key="1043:0" data-first-offset="true"><span data-slate-string="true">context 标准库设计思路</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1044"><span data-slate-object="text" data-key="1045"><span data-slate-leaf="true" data-offset-key="1045:0" data-first-offset="true"><span data-slate-string="true">如何控制超时，官方是有提供 context 标准库作为解决方案的，但是由于标准库的功能并不够完善，一会我们会基于标准库，来根据需求自定义框架的 Context。所以理解其背后的设计思路就可以了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1046"><span data-slate-object="text" data-key="1047"><span data-slate-leaf="true" data-offset-key="1047:0" data-first-offset="true"><span data-slate-string="true">为了防止雪崩，</span></span><span data-slate-leaf="true" data-offset-key="1047:1"><span data-slate-object="annotation" data-annotation-key="gkann_4b15793c" data-attr-id="41657" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">context 标准库的解决思路是：</span></span></span></span><span data-slate-object="text" data-key="1048"><span data-slate-leaf="true" data-offset-key="1048:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4b15793c" data-attr-id="41657" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在整个树形逻辑链条中，用上下文控制器 Context，实现每个节点的信息传递和共享</span></span></span></span></span><span data-slate-object="text" data-key="1049"><span data-slate-leaf="true" data-offset-key="1049:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4b15793c" data-attr-id="41657" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1050"><span data-slate-object="text" data-key="1051"><span data-slate-leaf="true" data-offset-key="1051:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6593b171" data-attr-id="41300" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">具体操作是：用 Context 定时器为整个链条设置超时时间，时间一到，结束事件被触发，链条中正在处理的服务逻辑会监听到，从而结束整个逻辑链条，让后续操作不再进行。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1052"><span data-slate-object="text" data-key="1053"><span data-slate-leaf="true" data-offset-key="1053:0" data-first-offset="true"><span data-slate-string="true">明白操作思路之后，我们深入 context 标准库看看要对应具备哪些功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1054"><span data-slate-object="text" data-key="1055"><span data-slate-leaf="true" data-offset-key="1055:0" data-first-offset="true"><span data-slate-string="true">按照上一讲介绍的了解标准库的方法，我们先通过  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="1056"><span data-slate-object="text" data-key="1057"><span data-slate-leaf="true" data-offset-key="1057:0" data-first-offset="true"><span data-slate-string="true">go doc context | grep "^func"</span></span></span></span><span data-slate-object="text" data-key="1058"><span data-slate-leaf="true" data-offset-key="1058:0" data-first-offset="true"><span data-slate-string="true"> 看提供了哪些库函数（function）：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1059"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1060"><span data-slate-object="text" data-key="1061"><span data-slate-leaf="true" data-offset-key="1061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建退出 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1062"><span data-slate-object="text" data-key="1063"><span data-slate-leaf="true" data-offset-key="1063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1064"><span data-slate-leaf="true" data-offset-key="1064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1065"><span data-slate-leaf="true" data-offset-key="1065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WithCancel</span></span></span></span></span><span data-slate-object="text" data-key="1066"><span data-slate-leaf="true" data-offset-key="1066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(parent Context)</span></span></span></span></span><span data-slate-object="text" data-key="1067"><span data-slate-leaf="true" data-offset-key="1067:0" data-first-offset="true"><span data-slate-string="true"> (ctx Context, cancel CancelFunc){}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1068"><span data-slate-object="text" data-key="1069"><span data-slate-leaf="true" data-offset-key="1069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建有超时时间的 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1070"><span data-slate-object="text" data-key="1071"><span data-slate-leaf="true" data-offset-key="1071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1072"><span data-slate-leaf="true" data-offset-key="1072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1073"><span data-slate-leaf="true" data-offset-key="1073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WithTimeout</span></span></span></span></span><span data-slate-object="text" data-key="1074"><span data-slate-leaf="true" data-offset-key="1074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(parent Context, timeout time.Duration)</span></span></span></span></span><span data-slate-object="text" data-key="1075"><span data-slate-leaf="true" data-offset-key="1075:0" data-first-offset="true"><span data-slate-string="true"> (Context, CancelFunc){}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1076"><span data-slate-object="text" data-key="1077"><span data-slate-leaf="true" data-offset-key="1077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建有截止时间的 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1078"><span data-slate-object="text" data-key="1079"><span data-slate-leaf="true" data-offset-key="1079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1080"><span data-slate-leaf="true" data-offset-key="1080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1081"><span data-slate-leaf="true" data-offset-key="1081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WithDeadline</span></span></span></span></span><span data-slate-object="text" data-key="1082"><span data-slate-leaf="true" data-offset-key="1082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(parent Context, d time.Time)</span></span></span></span></span><span data-slate-object="text" data-key="1083"><span data-slate-leaf="true" data-offset-key="1083:0" data-first-offset="true"><span data-slate-string="true"> (Context, CancelFunc){}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1084"><span data-slate-object="text" data-key="1085"><span data-slate-leaf="true" data-offset-key="1085:0" data-first-offset="true"><span data-slate-string="true">其中，WithCancel 直接创建可以操作退出的子节点，WithTimeout 为子节点设置了超时时间（还有多少时间结束），WithDeadline 为子节点设置了结束时间线（在什么时间结束）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1086"><span data-slate-object="text" data-key="1087"><span data-slate-leaf="true" data-offset-key="1087:0" data-first-offset="true"><span data-slate-string="true">但是这只是表层功能的不同，其实这三个库函数的</span></span></span><span data-slate-object="text" data-key="1088"><span data-slate-leaf="true" data-offset-key="1088:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">本质是一致的</span></span></span></span><span data-slate-object="text" data-key="1089"><span data-slate-leaf="true" data-offset-key="1089:0" data-first-offset="true"><span data-slate-string="true">。怎么理解呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1090"><span data-slate-object="text" data-key="1091"><span data-slate-leaf="true" data-offset-key="1091:0" data-first-offset="true"><span data-slate-string="true">我们先通过  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="1092"><span data-slate-object="text" data-key="1093"><span data-slate-leaf="true" data-offset-key="1093:0" data-first-offset="true"><span data-slate-string="true">go doc context | grep "^type"</span></span></span></span><span data-slate-object="text" data-key="1094"><span data-slate-leaf="true" data-offset-key="1094:0" data-first-offset="true"><span data-slate-string="true"> ，搞清楚 Context 的结构定义和函数句柄，再来解答这个问题。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1095"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1096"><span data-slate-object="text" data-key="1097"><span data-slate-leaf="true" data-offset-key="1097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="1098"><span data-slate-leaf="true" data-offset-key="1098:0" data-first-offset="true"><span data-slate-string="true"> Context </span></span></span><span data-slate-object="text" data-key="1099"><span data-slate-leaf="true" data-offset-key="1099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1100"><span data-slate-leaf="true" data-offset-key="1100:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1101"><span data-slate-object="text" data-key="1102"><span data-slate-leaf="true" data-offset-key="1102:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1103"><span data-slate-leaf="true" data-offset-key="1103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当 Context 被取消或者到了 deadline，返回一个被关闭的 channel</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1104"><span data-slate-object="text" data-key="1105"><span data-slate-leaf="true" data-offset-key="1105:0" data-first-offset="true"><span data-slate-string="true">    Done() &lt;-</span></span></span><span data-slate-object="text" data-key="1106"><span data-slate-leaf="true" data-offset-key="1106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="1107"><span data-slate-leaf="true" data-offset-key="1107:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1108"><span data-slate-leaf="true" data-offset-key="1108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1109"><span data-slate-leaf="true" data-offset-key="1109:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1110"><span data-slate-object="text" data-key="1111"><span data-slate-leaf="true" data-offset-key="1111:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1112"><span data-slate-object="text" data-key="1113"><span data-slate-leaf="true" data-offset-key="1113:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1114"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1115"><span data-slate-object="text" data-key="1116"><span data-slate-leaf="true" data-offset-key="1116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 函数句柄</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1117"><span data-slate-object="text" data-key="1118"><span data-slate-leaf="true" data-offset-key="1118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="1119"><span data-slate-leaf="true" data-offset-key="1119:0" data-first-offset="true"><span data-slate-string="true"> CancelFunc </span></span></span><span data-slate-object="text" data-key="1120"><span data-slate-leaf="true" data-offset-key="1120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1121"><span data-slate-leaf="true" data-offset-key="1121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="1122"><span data-slate-leaf="true" data-offset-key="1122:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1123"><span data-slate-object="text" data-key="1124"><span data-slate-leaf="true" data-offset-key="1124:0" data-first-offset="true"><span data-slate-string="true">这个库虽然不大，但是设计感强，比较抽象，并不是很好理解。所以这里，我把 Context 的其他字段省略了。现在，我们只理解核心的 Done () 方法和 CancelFunc 这两个函数就可以了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1125"><span data-slate-object="text" data-key="1126"><span data-slate-leaf="true" data-offset-key="1126:0" data-first-offset="true"><span data-slate-string="true">在树形逻辑链条上，</span></span></span><span data-slate-object="text" data-key="1127"><span data-slate-leaf="true" data-offset-key="1127:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">一个节点其实有两个角色：一是下游树的管理者；二是上游树的被管理者</span></span></span></span><span data-slate-object="text" data-key="1128"><span data-slate-leaf="true" data-offset-key="1128:0" data-first-offset="true"><span data-slate-string="true">，那么就对应需要有两个能力：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1129"><div data-slate-type="list-line" data-slate-object="block" data-key="1130"><span data-slate-object="text" data-key="1131"><span data-slate-leaf="true" data-offset-key="1131:0" data-first-offset="true"><span data-slate-string="true">一个是能让整个下游树结束的能力，也就是函数句柄 CancelFunc；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1132"><span data-slate-object="text" data-key="1133"><span data-slate-leaf="true" data-offset-key="1133:0" data-first-offset="true"><span data-slate-string="true">另外一个是在上游树结束的时候被通知的能力，也就是 Done () 方法。同时因为通知是需要不断监听的，所以 Done () 方法需要通过 channel 作为返回值让使用方进行监听。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1134"><span data-slate-object="text" data-key="1135"><span data-slate-leaf="true" data-offset-key="1135:0" data-first-offset="true"><span data-slate-string="true">看</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="1136"><span data-slate-object="text" data-key="1137"><span data-slate-leaf="true" data-offset-key="1137:0" data-first-offset="true"><span data-slate-string="true">官方代码</span></span></span></a><span data-slate-object="text" data-key="1138"><span data-slate-leaf="true" data-offset-key="1138:0" data-first-offset="true"><span data-slate-string="true">示例：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1139"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1140"><span data-slate-object="text" data-key="1141"><span data-slate-leaf="true" data-offset-key="1141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="1142"><span data-slate-leaf="true" data-offset-key="1142:0" data-first-offset="true"><span data-slate-string="true"> main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1143"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1144"><span data-slate-object="text" data-key="1145"><span data-slate-leaf="true" data-offset-key="1145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="1146"><span data-slate-leaf="true" data-offset-key="1146:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1147"><span data-slate-object="text" data-key="1148"><span data-slate-leaf="true" data-offset-key="1148:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1149"><span data-slate-leaf="true" data-offset-key="1149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"context"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1150"><span data-slate-object="text" data-key="1151"><span data-slate-leaf="true" data-offset-key="1151:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1152"><span data-slate-leaf="true" data-offset-key="1152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fmt"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1153"><span data-slate-object="text" data-key="1154"><span data-slate-leaf="true" data-offset-key="1154:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1155"><span data-slate-leaf="true" data-offset-key="1155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"time"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1156"><span data-slate-object="text" data-key="1157"><span data-slate-leaf="true" data-offset-key="1157:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1158"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1159"><span data-slate-object="text" data-key="1160"><span data-slate-leaf="true" data-offset-key="1160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="1161"><span data-slate-leaf="true" data-offset-key="1161:0" data-first-offset="true"><span data-slate-string="true"> shortDuration = </span></span></span><span data-slate-object="text" data-key="1162"><span data-slate-leaf="true" data-offset-key="1162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1163"><span data-slate-leaf="true" data-offset-key="1163:0" data-first-offset="true"><span data-slate-string="true"> * time.Millisecond</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1164"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1165"><span data-slate-object="text" data-key="1166"><span data-slate-leaf="true" data-offset-key="1166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1167"><span data-slate-leaf="true" data-offset-key="1167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1168"><span data-slate-leaf="true" data-offset-key="1168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="1169"><span data-slate-leaf="true" data-offset-key="1169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="1170"><span data-slate-leaf="true" data-offset-key="1170:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1171"><span data-slate-object="text" data-key="1172"><span data-slate-leaf="true" data-offset-key="1172:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1173"><span data-slate-leaf="true" data-offset-key="1173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建截止时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1174"><span data-slate-object="text" data-key="1175"><span data-slate-leaf="true" data-offset-key="1175:0" data-first-offset="true"><span data-slate-string="true">  d := time.Now().Add(shortDuration)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1176"><span data-slate-object="text" data-key="1177"><span data-slate-leaf="true" data-offset-key="1177:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1178"><span data-slate-leaf="true" data-offset-key="1178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建有截止时间的 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1179"><span data-slate-object="text" data-key="1180"><span data-slate-leaf="true" data-offset-key="1180:0" data-first-offset="true"><span data-slate-string="true">  ctx, cancel := context.WithDeadline(context.Background(), d)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1181"><span data-slate-object="text" data-key="1182"><span data-slate-leaf="true" data-offset-key="1182:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1183"><span data-slate-leaf="true" data-offset-key="1183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="1184"><span data-slate-leaf="true" data-offset-key="1184:0" data-first-offset="true"><span data-slate-string="true"> cancel()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1185"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1186"><span data-slate-object="text" data-key="1187"><span data-slate-leaf="true" data-offset-key="1187:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1188"><span data-slate-leaf="true" data-offset-key="1188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 使用 select 监听 1s 和有截止时间的 Context 哪个先结束</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1189"><span data-slate-object="text" data-key="1190"><span data-slate-leaf="true" data-offset-key="1190:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1191"><span data-slate-leaf="true" data-offset-key="1191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="1192"><span data-slate-leaf="true" data-offset-key="1192:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1193"><span data-slate-object="text" data-key="1194"><span data-slate-leaf="true" data-offset-key="1194:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1195"><span data-slate-leaf="true" data-offset-key="1195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1196"><span data-slate-leaf="true" data-offset-key="1196:0" data-first-offset="true"><span data-slate-string="true"> &lt;-time.After(</span></span></span><span data-slate-object="text" data-key="1197"><span data-slate-leaf="true" data-offset-key="1197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1198"><span data-slate-leaf="true" data-offset-key="1198:0" data-first-offset="true"><span data-slate-string="true"> * time.Second):</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1199"><span data-slate-object="text" data-key="1200"><span data-slate-leaf="true" data-offset-key="1200:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="1201"><span data-slate-leaf="true" data-offset-key="1201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"overslept"</span></span></span></span><span data-slate-object="text" data-key="1202"><span data-slate-leaf="true" data-offset-key="1202:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1203"><span data-slate-object="text" data-key="1204"><span data-slate-leaf="true" data-offset-key="1204:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1205"><span data-slate-leaf="true" data-offset-key="1205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1206"><span data-slate-leaf="true" data-offset-key="1206:0" data-first-offset="true"><span data-slate-string="true"> &lt;-ctx.Done():</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1207"><span data-slate-object="text" data-key="1208"><span data-slate-leaf="true" data-offset-key="1208:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(ctx.Err())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1209"><span data-slate-object="text" data-key="1210"><span data-slate-leaf="true" data-offset-key="1210:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1211"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1212"><span data-slate-object="text" data-key="1213"><span data-slate-leaf="true" data-offset-key="1213:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1214"><span data-slate-object="text" data-key="1215"><span data-slate-leaf="true" data-offset-key="1215:0" data-first-offset="true"><span data-slate-string="true">主线程创建了一个 1 毫秒结束的定时器 Context，在定时器结束的时候，主线程会通过 Done () 函数收到事件结束通知，</span></span><span data-slate-leaf="true" data-offset-key="1215:1"><span data-slate-object="annotation" data-annotation-key="gkann_261252b0" data-attr-id="41198" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">然后主动调用函数句柄 cancelFunc 来通知所有子 Context 结束（这个例子比较简单没有子 Context）。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1216"><span data-slate-object="text" data-key="1217"><span data-slate-leaf="true" data-offset-key="1217:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_09a5523f" data-attr-id="41683" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我打个更形象的比喻，CancelFunc 和 Done 方法就像是电话的话筒和听筒，话筒 CancelFunc，用来告诉管辖范围内的所有 Context 要进行自我终结，而通过监听听筒 Done 方法，我们就能听到上游父级管理者的终结命令。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1218"><span data-slate-object="text" data-key="1219"><span data-slate-leaf="true" data-offset-key="1219:0" data-first-offset="true"><span data-slate-string="true">总之，</span></span></span><span data-slate-object="text" data-key="1220"><span data-slate-leaf="true" data-offset-key="1220:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">CancelFunc 是主动让下游结束，而 Done 是被上游通知结束</span></span></span></span><span data-slate-object="text" data-key="1221"><span data-slate-leaf="true" data-offset-key="1221:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1222"><span data-slate-object="text" data-key="1223"><span data-slate-leaf="true" data-offset-key="1223:0" data-first-offset="true"><span data-slate-string="true">搞懂了具体实现方法，我们回过头来看这三个库函数 WithCancel / WithDeadline / WithTimeout 就很好理解了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1224"><span data-slate-object="text" data-key="1225"><span data-slate-leaf="true" data-offset-key="1225:0" data-first-offset="true"><span data-slate-string="true">它们的本质就是 “通过定时器来自动触发终结通知”，WithTimeout 设置若干秒后通知触发终结，WithDeadline 设置未来某个时间点触发终结。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1226"><span data-slate-object="text" data-key="1227"><span data-slate-leaf="true" data-offset-key="1227:0" data-first-offset="true"><span data-slate-string="true">对应到 Context 代码中，它们的功能就是：</span></span></span><span data-slate-object="text" data-key="1228"><span data-slate-leaf="true" data-offset-key="1228:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">为一个父节点生成一个带有 Done 方法的子节点，并且返回子节点的 CancelFunc 函数句柄</span></span></span></span><span data-slate-object="text" data-key="1229"><span data-slate-leaf="true" data-offset-key="1229:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1230"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/90/c5/900361486571bb703261d2cfd56e87c5.jpg?wh=1920x1080"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1231"><span data-slate-object="text" data-key="1232"><span data-slate-leaf="true" data-offset-key="1232:0" data-first-offset="true"><span data-slate-string="true">我们用一张图来辅助解释一下，Context 的使用会形成一个树形结构，下游指的是树形结构中的子节点及所有子节点的子树，而上游指的是当前节点的父节点。比如图中圈起来的部分，当 WithTimeout 调用 CancelFunc 的时候，所有下游的 With 系列产生的 Context 都会从 Done 中收到消息。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1233" id="sr-toc-2"><span data-slate-object="text" data-key="1234"><span data-slate-leaf="true" data-offset-key="1234:0" data-first-offset="true"><span data-slate-string="true">Context 是怎么产生的</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1235"><span data-slate-object="text" data-key="1236"><span data-slate-leaf="true" data-offset-key="1236:0" data-first-offset="true"><span data-slate-string="true">现在我们已经了解标准库 context 的设计思路了，在开始写代码之前，我们还要把 Context 放到 net/http 的主流程逻辑中，其中有两个问题要搞清楚：</span></span></span><span data-slate-object="text" data-key="1237"><span data-slate-leaf="true" data-offset-key="1237:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Context 在哪里产生？它的上下游逻辑是什么？</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1238"><span data-slate-object="text" data-key="1239"><span data-slate-leaf="true" data-offset-key="1239:0" data-first-offset="true"><span data-slate-string="true">要回答这两个问题，可以用我们在上一讲介绍的思维导图方法，因为主流程已经拎清楚了，现在你只需要把其中 Context 有关的代码再详细过一遍，然后在思维导图上标记出来就可以了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1240"><span data-slate-object="text" data-key="1241"><span data-slate-leaf="true" data-offset-key="1241:0" data-first-offset="true"><span data-slate-string="true">这里，我已经把 Context 的关键代码都用蓝色背景做了标记，你可以检查一下自己有没有标漏。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1242"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/79/a4/79a3c7eafc3ccfbe1b162e646902c5a4.png?wh=1413x906"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1243"><span data-slate-object="text" data-key="1244"><span data-slate-leaf="true" data-offset-key="1244:0" data-first-offset="true"><span data-slate-string="true">照旧看图梳理代码流程，来看蓝色部分，从前到后的层级梳理就不再重复讲了，我们看关键位置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1245"><span data-slate-object="text" data-key="1246"><span data-slate-leaf="true" data-offset-key="1246:0" data-first-offset="true"><span data-slate-string="true">从图中最后一层的代码 req.ctx = ctx 中看到，每个连接的 Context 最终是放在 request 结构体中的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1247"><span data-slate-object="text" data-key="1248"><span data-slate-leaf="true" data-offset-key="1248:0" data-first-offset="true"><span data-slate-string="true">而且这个时候， Context 已经有多层父节点。因为，在代码中，</span></span><span data-slate-leaf="true" data-offset-key="1248:1"><span data-slate-object="annotation" data-annotation-key="gkann_0db851f6" data-attr-id="42208" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">每执行一次 WithCancel、WithValue，就封装了一层 Context，</span></span></span><span data-slate-leaf="true" data-offset-key="1248:2"><span data-slate-string="true">我们通过这一张流程图能清晰看到最终 Context 的生成层次。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1249"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/dd/22/ddbca0e4d1c66ed417b9de97c338ae22.jpg?wh=1920x1080"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1250"><span data-slate-object="text" data-key="1251"><span data-slate-leaf="true" data-offset-key="1251:0" data-first-offset="true"><span data-slate-string="true">你发现了吗，</span></span></span><span data-slate-object="text" data-key="1252"><span data-slate-leaf="true" data-offset-key="1252:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">其实每个连接的 Context 都是基于 baseContext 复制来的</span></span></span></span><span data-slate-object="text" data-key="1253"><span data-slate-leaf="true" data-offset-key="1253:0" data-first-offset="true"><span data-slate-string="true">。对应到代码中就是，</span></span><span data-slate-leaf="true" data-offset-key="1253:1"><span data-slate-object="annotation" data-annotation-key="gkann_1d41dd84" data-attr-id="31487" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在为某个连接开启 Goroutine 的时候，为当前连接创建了一个 connContext，这个 connContext 是基于 server 中的 Context 而来，而 server 中 Context 的基础就是 baseContext。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1254"><span data-slate-object="text" data-key="1255"><span data-slate-leaf="true" data-offset-key="1255:0" data-first-offset="true"><span data-slate-string="true">所以，Context 从哪里产生这个问题，我们就解决了，但是如果我们想要对 Context 进行必要的修改，还要从上下游逻辑中，找到它的修改点在哪里。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1256"><span data-slate-object="text" data-key="1257"><span data-slate-leaf="true" data-offset-key="1257:0" data-first-offset="true"><span data-slate-string="true">生成最终的 Context 的流程中，net/http 设计了</span></span></span><span data-slate-object="text" data-key="1258"><span data-slate-leaf="true" data-offset-key="1258:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">两处可以注入修改</span></span></span></span><span data-slate-object="text" data-key="1259"><span data-slate-leaf="true" data-offset-key="1259:0" data-first-offset="true"><span data-slate-string="true">的地方，都在 Server 结构里面，一处是 BaseContext，另一处是 ConnContext。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1260"><div data-slate-type="list-line" data-slate-object="block" data-key="1261"><span data-slate-object="text" data-key="1262"><span data-slate-leaf="true" data-offset-key="1262:0" data-first-offset="true"><span data-slate-string="true">BaseContext 是整个 Context 生成的源头，如果我们不希望使用默认的 context.Backgroud ()，可以替换这个源头。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1263"><span data-slate-object="text" data-key="1264"><span data-slate-leaf="true" data-offset-key="1264:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a46e383f" data-attr-id="41316" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">而在每个连接生成自己要使用的 Context 时，会调用 ConnContext ，它的第二个参数是 net.Conn，能让我们对某些特定连接进行设置，比如要针对性设置某个调用 IP。</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1265"><span data-slate-object="text" data-key="1266"><span data-slate-leaf="true" data-offset-key="1266:0" data-first-offset="true"><span data-slate-string="true">这两个函数的定义我写在下面的代码里了，展示一下，你可以看看。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1267"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1268"><span data-slate-object="text" data-key="1269"><span data-slate-leaf="true" data-offset-key="1269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="1270"><span data-slate-leaf="true" data-offset-key="1270:0" data-first-offset="true"><span data-slate-string="true"> Server </span></span></span><span data-slate-object="text" data-key="1271"><span data-slate-leaf="true" data-offset-key="1271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1272"><span data-slate-leaf="true" data-offset-key="1272:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1273"><span data-slate-object="text" data-key="1274"><span data-slate-leaf="true" data-offset-key="1274:0" data-first-offset="true"><span data-slate-string="true">  ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1275"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1276"><span data-slate-object="text" data-key="1277"><span data-slate-leaf="true" data-offset-key="1277:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1278"><span data-slate-leaf="true" data-offset-key="1278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// BaseContext 用来为整个链条创建初始化 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1279"><span data-slate-object="text" data-key="1280"><span data-slate-leaf="true" data-offset-key="1280:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1281"><span data-slate-leaf="true" data-offset-key="1281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果没有设置的话，默认使用 context.Background ()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1282"><span data-slate-object="text" data-key="1283"><span data-slate-leaf="true" data-offset-key="1283:0" data-first-offset="true"><span data-slate-string="true">  BaseContext </span></span></span><span data-slate-object="text" data-key="1284"><span data-slate-leaf="true" data-offset-key="1284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1285"><span data-slate-leaf="true" data-offset-key="1285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(net.Listener)</span></span></span></span></span><span data-slate-object="text" data-key="1286"><span data-slate-leaf="true" data-offset-key="1286:0" data-first-offset="true"><span data-slate-string="true"> context.Context{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1287"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1288"><span data-slate-object="text" data-key="1289"><span data-slate-leaf="true" data-offset-key="1289:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1290"><span data-slate-leaf="true" data-offset-key="1290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ConnContext 用来为每个连接封装 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1291"><span data-slate-object="text" data-key="1292"><span data-slate-leaf="true" data-offset-key="1292:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1293"><span data-slate-leaf="true" data-offset-key="1293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 参数中的 context.Context 是从 BaseContext 继承来的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1294"><span data-slate-object="text" data-key="1295"><span data-slate-leaf="true" data-offset-key="1295:0" data-first-offset="true"><span data-slate-string="true">  ConnContext </span></span></span><span data-slate-object="text" data-key="1296"><span data-slate-leaf="true" data-offset-key="1296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1297"><span data-slate-leaf="true" data-offset-key="1297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx context.Context, c net.Conn)</span></span></span></span></span><span data-slate-object="text" data-key="1298"><span data-slate-leaf="true" data-offset-key="1298:0" data-first-offset="true"><span data-slate-string="true"> context.Context{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1299"><span data-slate-object="text" data-key="1300"><span data-slate-leaf="true" data-offset-key="1300:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1301"><span data-slate-object="text" data-key="1302"><span data-slate-leaf="true" data-offset-key="1302:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1303"><span data-slate-object="text" data-key="1304"><span data-slate-leaf="true" data-offset-key="1304:0" data-first-offset="true"><span data-slate-string="true">最后，我们回看一下 req.ctx 是否能感知连接异常。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1305"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a1/fc/a1d0ece41997ac873a5292301ee988fc.jpg?wh=1920x1080"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1306"><span data-slate-object="text" data-key="1307"><span data-slate-leaf="true" data-offset-key="1307:0" data-first-offset="true"><span data-slate-string="true">是可以的，</span></span><span data-slate-leaf="true" data-offset-key="1307:1"><span data-slate-object="annotation" data-annotation-key="gkann_4b5dfbf2" data-attr-id="41304" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">因为链条中一个父节点为 CancelContext，其 cancelFunc 存储在代表连接的 conn 结构中，连接异常的时候，会触发这个函数句柄。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1308"><span data-slate-object="text" data-key="1309"><span data-slate-leaf="true" data-offset-key="1309:0" data-first-offset="true"><span data-slate-string="true">好，讲完 context 库的核心设计思想，以及在 net/http 的主流程逻辑中嵌入 context 库的关键实现，我们现在心中有图了，就可以撸起袖子开始写框架代码了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1310"><span data-slate-object="text" data-key="1311"><span data-slate-leaf="true" data-offset-key="1311:0" data-first-offset="true"><span data-slate-string="true">你是不是有点疑惑，为啥要自己先理解一遍 context 标准库的生成流程，咱们直接动手干不是更快？有句老话说得好，磨刀不误砍柴功。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1312"><span data-slate-object="text" data-key="1313"><span data-slate-leaf="true" data-offset-key="1313:0" data-first-offset="true"><span data-slate-string="true">我们确实是要自定义，不是想直接使用标准库的 Context，因为它完全是标准库 Context 接口的实现，只能控制链条结束，封装性并不够。但是只有先搞清楚了 context 标准库的设计思路，才能精准确定自己能怎么改、改到什么程度合适，下手的时候才不容易懵。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1314"><span data-slate-object="text" data-key="1315"><span data-slate-leaf="true" data-offset-key="1315:0" data-first-offset="true"><span data-slate-string="true">下面我们就基于刚才讲的设计思路，从封装自己的 Context 开始，写今天的核心逻辑，也就是为单个请求设置超时，最后考虑一些边界场景，并且进行优化。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1316"><span data-slate-object="text" data-key="1317"><span data-slate-leaf="true" data-offset-key="1317:0" data-first-offset="true"><span data-slate-string="true">我们还是再拉一个分支 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="1318"><span data-slate-object="text" data-key="1319"><span data-slate-leaf="true" data-offset-key="1319:0" data-first-offset="true"><span data-slate-string="true">geekbang/02</span></span></span></a><span data-slate-object="text" data-key="1320"><span data-slate-leaf="true" data-offset-key="1320:0" data-first-offset="true"><span data-slate-string="true">，接着上一节课的代码结构，在框架文件夹中封装一个自己的 Context。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1321" id="sr-toc-3"><span data-slate-object="text" data-key="1322"><span data-slate-leaf="true" data-offset-key="1322:0" data-first-offset="true"><span data-slate-string="true">封装一个自己的 Context</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1323"><span data-slate-object="text" data-key="1324"><span data-slate-leaf="true" data-offset-key="1324:0" data-first-offset="true"><span data-slate-string="true">在框架里，我们需要有更强大的 Context，除了可以控制超时之外，常用的功能比如获取请求、返回结果、实现标准库的 Context 接口，也都要有。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1325"><span data-slate-object="text" data-key="1326"><span data-slate-leaf="true" data-offset-key="1326:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">我们首先来设计提供获取请求、返回结果功能</span></span></span></span><span data-slate-object="text" data-key="1327"><span data-slate-leaf="true" data-offset-key="1327:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1328"><span data-slate-object="text" data-key="1329"><span data-slate-leaf="true" data-offset-key="1329:0" data-first-offset="true"><span data-slate-string="true">先看一段未封装自定义 Context 的控制器代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1330"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1331"><span data-slate-object="text" data-key="1332"><span data-slate-leaf="true" data-offset-key="1332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 控制器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1333"><span data-slate-object="text" data-key="1334"><span data-slate-leaf="true" data-offset-key="1334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1335"><span data-slate-leaf="true" data-offset-key="1335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1336"><span data-slate-leaf="true" data-offset-key="1336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Foo1</span></span></span></span></span><span data-slate-object="text" data-key="1337"><span data-slate-leaf="true" data-offset-key="1337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(request *http.Request, response http.ResponseWriter)</span></span></span></span></span><span data-slate-object="text" data-key="1338"><span data-slate-leaf="true" data-offset-key="1338:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1339"><span data-slate-object="text" data-key="1340"><span data-slate-leaf="true" data-offset-key="1340:0" data-first-offset="true"><span data-slate-string="true">  obj := </span></span></span><span data-slate-object="text" data-key="1341"><span data-slate-leaf="true" data-offset-key="1341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1342"><span data-slate-leaf="true" data-offset-key="1342:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1343"><span data-slate-leaf="true" data-offset-key="1343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1344"><span data-slate-leaf="true" data-offset-key="1344:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1345"><span data-slate-leaf="true" data-offset-key="1345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1346"><span data-slate-leaf="true" data-offset-key="1346:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1347"><span data-slate-object="text" data-key="1348"><span data-slate-leaf="true" data-offset-key="1348:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1349"><span data-slate-leaf="true" data-offset-key="1349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"data"</span></span></span></span><span data-slate-object="text" data-key="1350"><span data-slate-leaf="true" data-offset-key="1350:0" data-first-offset="true"><span data-slate-string="true">:   </span></span></span><span data-slate-object="text" data-key="1351"><span data-slate-leaf="true" data-offset-key="1351:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1352"><span data-slate-leaf="true" data-offset-key="1352:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1353"><span data-slate-object="text" data-key="1354"><span data-slate-leaf="true" data-offset-key="1354:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1355"><span data-slate-object="text" data-key="1356"><span data-slate-leaf="true" data-offset-key="1356:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1357"><span data-slate-leaf="true" data-offset-key="1357:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置控制器 response 的 header 部分</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1358"><span data-slate-object="text" data-key="1359"><span data-slate-leaf="true" data-offset-key="1359:0" data-first-offset="true"><span data-slate-string="true">  response.Header().Set(</span></span></span><span data-slate-object="text" data-key="1360"><span data-slate-leaf="true" data-offset-key="1360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Content-Type"</span></span></span></span><span data-slate-object="text" data-key="1361"><span data-slate-leaf="true" data-offset-key="1361:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1362"><span data-slate-leaf="true" data-offset-key="1362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"application/json"</span></span></span></span><span data-slate-object="text" data-key="1363"><span data-slate-leaf="true" data-offset-key="1363:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1364"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1365"><span data-slate-object="text" data-key="1366"><span data-slate-leaf="true" data-offset-key="1366:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1367"><span data-slate-leaf="true" data-offset-key="1367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从请求体中获取参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1368"><span data-slate-object="text" data-key="1369"><span data-slate-leaf="true" data-offset-key="1369:0" data-first-offset="true"><span data-slate-string="true">  foo := request.PostFormValue(</span></span></span><span data-slate-object="text" data-key="1370"><span data-slate-leaf="true" data-offset-key="1370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo"</span></span></span></span><span data-slate-object="text" data-key="1371"><span data-slate-leaf="true" data-offset-key="1371:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1372"><span data-slate-object="text" data-key="1373"><span data-slate-leaf="true" data-offset-key="1373:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1374"><span data-slate-leaf="true" data-offset-key="1374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1375"><span data-slate-leaf="true" data-offset-key="1375:0" data-first-offset="true"><span data-slate-string="true"> foo == </span></span></span><span data-slate-object="text" data-key="1376"><span data-slate-leaf="true" data-offset-key="1376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="1377"><span data-slate-leaf="true" data-offset-key="1377:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1378"><span data-slate-object="text" data-key="1379"><span data-slate-leaf="true" data-offset-key="1379:0" data-first-offset="true"><span data-slate-string="true">    foo = </span></span></span><span data-slate-object="text" data-key="1380"><span data-slate-leaf="true" data-offset-key="1380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"10"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1381"><span data-slate-object="text" data-key="1382"><span data-slate-leaf="true" data-offset-key="1382:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1383"><span data-slate-object="text" data-key="1384"><span data-slate-leaf="true" data-offset-key="1384:0" data-first-offset="true"><span data-slate-string="true">  fooInt, err := strconv.Atoi(foo)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1385"><span data-slate-object="text" data-key="1386"><span data-slate-leaf="true" data-offset-key="1386:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1387"><span data-slate-leaf="true" data-offset-key="1387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1388"><span data-slate-leaf="true" data-offset-key="1388:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1389"><span data-slate-leaf="true" data-offset-key="1389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1390"><span data-slate-leaf="true" data-offset-key="1390:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1391"><span data-slate-object="text" data-key="1392"><span data-slate-leaf="true" data-offset-key="1392:0" data-first-offset="true"><span data-slate-string="true">    response.WriteHeader(</span></span></span><span data-slate-object="text" data-key="1393"><span data-slate-leaf="true" data-offset-key="1393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="1394"><span data-slate-leaf="true" data-offset-key="1394:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1395"><span data-slate-object="text" data-key="1396"><span data-slate-leaf="true" data-offset-key="1396:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1397"><span data-slate-leaf="true" data-offset-key="1397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1398"><span data-slate-object="text" data-key="1399"><span data-slate-leaf="true" data-offset-key="1399:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1400"><span data-slate-object="text" data-key="1401"><span data-slate-leaf="true" data-offset-key="1401:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1402"><span data-slate-leaf="true" data-offset-key="1402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构建返回结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1403"><span data-slate-object="text" data-key="1404"><span data-slate-leaf="true" data-offset-key="1404:0" data-first-offset="true"><span data-slate-string="true">  obj[</span></span></span><span data-slate-object="text" data-key="1405"><span data-slate-leaf="true" data-offset-key="1405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"data"</span></span></span></span><span data-slate-object="text" data-key="1406"><span data-slate-leaf="true" data-offset-key="1406:0" data-first-offset="true"><span data-slate-string="true">] = fooInt </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1407"><span data-slate-object="text" data-key="1408"><span data-slate-leaf="true" data-offset-key="1408:0" data-first-offset="true"><span data-slate-string="true">  byt, err := json.Marshal(obj)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1409"><span data-slate-object="text" data-key="1410"><span data-slate-leaf="true" data-offset-key="1410:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1411"><span data-slate-leaf="true" data-offset-key="1411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1412"><span data-slate-leaf="true" data-offset-key="1412:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1413"><span data-slate-leaf="true" data-offset-key="1413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1414"><span data-slate-leaf="true" data-offset-key="1414:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1415"><span data-slate-object="text" data-key="1416"><span data-slate-leaf="true" data-offset-key="1416:0" data-first-offset="true"><span data-slate-string="true">    response.WriteHeader(</span></span></span><span data-slate-object="text" data-key="1417"><span data-slate-leaf="true" data-offset-key="1417:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="1418"><span data-slate-leaf="true" data-offset-key="1418:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1419"><span data-slate-object="text" data-key="1420"><span data-slate-leaf="true" data-offset-key="1420:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1421"><span data-slate-leaf="true" data-offset-key="1421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1422"><span data-slate-object="text" data-key="1423"><span data-slate-leaf="true" data-offset-key="1423:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1424"><span data-slate-object="text" data-key="1425"><span data-slate-leaf="true" data-offset-key="1425:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1426"><span data-slate-leaf="true" data-offset-key="1426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构建返回状态，输出返回结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1427"><span data-slate-object="text" data-key="1428"><span data-slate-leaf="true" data-offset-key="1428:0" data-first-offset="true"><span data-slate-string="true">  response.WriteHeader(</span></span></span><span data-slate-object="text" data-key="1429"><span data-slate-leaf="true" data-offset-key="1429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">200</span></span></span></span><span data-slate-object="text" data-key="1430"><span data-slate-leaf="true" data-offset-key="1430:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1431"><span data-slate-object="text" data-key="1432"><span data-slate-leaf="true" data-offset-key="1432:0" data-first-offset="true"><span data-slate-string="true">  response.Write(byt)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1433"><span data-slate-object="text" data-key="1434"><span data-slate-leaf="true" data-offset-key="1434:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1435"><span data-slate-leaf="true" data-offset-key="1435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1436"><span data-slate-object="text" data-key="1437"><span data-slate-leaf="true" data-offset-key="1437:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1438"><span data-slate-object="text" data-key="1439"><span data-slate-leaf="true" data-offset-key="1439:0" data-first-offset="true"><span data-slate-string="true">这段代码重点是操作调用了 http.Request 和 http.ResponseWriter ，实现 WebService 接收和处理协议文本的功能。但这两个结构提供的接口粒度太细了，需要使用者非常熟悉这两个结构的内部字段，比如 response 里设置 Header 和设置 Body 的函数，用起来肯定体验不好。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1440"><span data-slate-object="text" data-key="1441"><span data-slate-leaf="true" data-offset-key="1441:0" data-first-offset="true"><span data-slate-string="true">如果我们能</span></span></span><span data-slate-object="text" data-key="1442"><span data-slate-leaf="true" data-offset-key="1442:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">将这些内部实现封装起来，对外暴露语义化高的接口函数</span></span></span></span><span data-slate-object="text" data-key="1443"><span data-slate-leaf="true" data-offset-key="1443:0" data-first-offset="true"><span data-slate-string="true">，那么我们这个框架的易用性肯定会明显提升。什么是好的封装呢？再看这段有封装的代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1444"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1445"><span data-slate-object="text" data-key="1446"><span data-slate-leaf="true" data-offset-key="1446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 控制器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1447"><span data-slate-object="text" data-key="1448"><span data-slate-leaf="true" data-offset-key="1448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1449"><span data-slate-leaf="true" data-offset-key="1449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1450"><span data-slate-leaf="true" data-offset-key="1450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Foo2</span></span></span></span></span><span data-slate-object="text" data-key="1451"><span data-slate-leaf="true" data-offset-key="1451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx *framework.Context)</span></span></span></span></span><span data-slate-object="text" data-key="1452"><span data-slate-leaf="true" data-offset-key="1452:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1453"><span data-slate-leaf="true" data-offset-key="1453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="1454"><span data-slate-leaf="true" data-offset-key="1454:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1455"><span data-slate-object="text" data-key="1456"><span data-slate-leaf="true" data-offset-key="1456:0" data-first-offset="true"><span data-slate-string="true">  obj := </span></span></span><span data-slate-object="text" data-key="1457"><span data-slate-leaf="true" data-offset-key="1457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1458"><span data-slate-leaf="true" data-offset-key="1458:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1459"><span data-slate-leaf="true" data-offset-key="1459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1460"><span data-slate-leaf="true" data-offset-key="1460:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1461"><span data-slate-leaf="true" data-offset-key="1461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1462"><span data-slate-leaf="true" data-offset-key="1462:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1463"><span data-slate-object="text" data-key="1464"><span data-slate-leaf="true" data-offset-key="1464:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1465"><span data-slate-leaf="true" data-offset-key="1465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"data"</span></span></span></span><span data-slate-object="text" data-key="1466"><span data-slate-leaf="true" data-offset-key="1466:0" data-first-offset="true"><span data-slate-string="true">:   </span></span></span><span data-slate-object="text" data-key="1467"><span data-slate-leaf="true" data-offset-key="1467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1468"><span data-slate-leaf="true" data-offset-key="1468:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1469"><span data-slate-object="text" data-key="1470"><span data-slate-leaf="true" data-offset-key="1470:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1471"><span data-slate-object="text" data-key="1472"><span data-slate-leaf="true" data-offset-key="1472:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1473"><span data-slate-leaf="true" data-offset-key="1473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从请求体中获取参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1474"><span data-slate-object="text" data-key="1475"><span data-slate-leaf="true" data-offset-key="1475:0" data-first-offset="true"><span data-slate-string="true">   fooInt := ctx.FormInt(</span></span></span><span data-slate-object="text" data-key="1476"><span data-slate-leaf="true" data-offset-key="1476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo"</span></span></span></span><span data-slate-object="text" data-key="1477"><span data-slate-leaf="true" data-offset-key="1477:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1478"><span data-slate-leaf="true" data-offset-key="1478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="1479"><span data-slate-leaf="true" data-offset-key="1479:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1480"><span data-slate-object="text" data-key="1481"><span data-slate-leaf="true" data-offset-key="1481:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1482"><span data-slate-leaf="true" data-offset-key="1482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 构建返回结构  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1483"><span data-slate-object="text" data-key="1484"><span data-slate-leaf="true" data-offset-key="1484:0" data-first-offset="true"><span data-slate-string="true">  obj[</span></span></span><span data-slate-object="text" data-key="1485"><span data-slate-leaf="true" data-offset-key="1485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"data"</span></span></span></span><span data-slate-object="text" data-key="1486"><span data-slate-leaf="true" data-offset-key="1486:0" data-first-offset="true"><span data-slate-string="true">] = fooInt</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1487"><span data-slate-object="text" data-key="1488"><span data-slate-leaf="true" data-offset-key="1488:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1489"><span data-slate-leaf="true" data-offset-key="1489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 输出返回结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1490"><span data-slate-object="text" data-key="1491"><span data-slate-leaf="true" data-offset-key="1491:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1492"><span data-slate-leaf="true" data-offset-key="1492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1493"><span data-slate-leaf="true" data-offset-key="1493:0" data-first-offset="true"><span data-slate-string="true"> ctx.Json(http.StatusOK, obj)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1494"><span data-slate-object="text" data-key="1495"><span data-slate-leaf="true" data-offset-key="1495:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1496"><span data-slate-object="text" data-key="1497"><span data-slate-leaf="true" data-offset-key="1497:0" data-first-offset="true"><span data-slate-string="true">你可以明显感受到封装性高的 Foo2 函数，更优雅更易读了。首先它的代码量更少，而且语义性也更好，近似对业务的描述：从请求体中获取 foo 参数，并且封装为 Map，最后 JSON 输出。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1498"><span data-slate-object="text" data-key="1499"><span data-slate-leaf="true" data-offset-key="1499:0" data-first-offset="true"><span data-slate-string="true">思路清晰了，所以这里可以将 request 和 response 封装到我们自定义的 Context 中，对外提供请求和结果的方法，我们把这个 Context 结构写在框架文件夹的 context.go 文件中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1500"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1501"><span data-slate-object="text" data-key="1502"><span data-slate-leaf="true" data-offset-key="1502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 自定义 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1503"><span data-slate-object="text" data-key="1504"><span data-slate-leaf="true" data-offset-key="1504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="1505"><span data-slate-leaf="true" data-offset-key="1505:0" data-first-offset="true"><span data-slate-string="true"> Context </span></span></span><span data-slate-object="text" data-key="1506"><span data-slate-leaf="true" data-offset-key="1506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1507"><span data-slate-leaf="true" data-offset-key="1507:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1508"><span data-slate-object="text" data-key="1509"><span data-slate-leaf="true" data-offset-key="1509:0" data-first-offset="true"><span data-slate-string="true">  request        *http.Request</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1510"><span data-slate-object="text" data-key="1511"><span data-slate-leaf="true" data-offset-key="1511:0" data-first-offset="true"><span data-slate-string="true">  responseWriter http.ResponseWriter</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1512"><span data-slate-object="text" data-key="1513"><span data-slate-leaf="true" data-offset-key="1513:0" data-first-offset="true"><span data-slate-string="true">  ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1514"><span data-slate-object="text" data-key="1515"><span data-slate-leaf="true" data-offset-key="1515:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1516"><span data-slate-object="text" data-key="1517"><span data-slate-leaf="true" data-offset-key="1517:0" data-first-offset="true"><span data-slate-string="true">对 request 和 response 封装的具体实现，我们到第五节课封装的时候再仔细说。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1518"><span data-slate-object="text" data-key="1519"><span data-slate-leaf="true" data-offset-key="1519:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">然后是第二个功能，标准库的 Context 接口</span></span></span></span><span data-slate-object="text" data-key="1520"><span data-slate-leaf="true" data-offset-key="1520:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1521"><span data-slate-object="text" data-key="1522"><span data-slate-leaf="true" data-offset-key="1522:0" data-first-offset="true"><span data-slate-string="true">标准库的 Context 通用性非常高，基本现在所有第三方库函数，都会根据官方的建议，将第一个参数设置为标准 Context 接口。所以我们封装的结构只有实现了标准库的 Context，才能方便直接地调用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1523"><span data-slate-object="text" data-key="1524"><span data-slate-leaf="true" data-offset-key="1524:0" data-first-offset="true"><span data-slate-string="true">到底有多方便，我们看使用示例：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1525"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1526"><span data-slate-object="text" data-key="1527"><span data-slate-leaf="true" data-offset-key="1527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1528"><span data-slate-leaf="true" data-offset-key="1528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1529"><span data-slate-leaf="true" data-offset-key="1529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Foo3</span></span></span></span></span><span data-slate-object="text" data-key="1530"><span data-slate-leaf="true" data-offset-key="1530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx *framework.Context)</span></span></span></span></span><span data-slate-object="text" data-key="1531"><span data-slate-leaf="true" data-offset-key="1531:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1532"><span data-slate-leaf="true" data-offset-key="1532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="1533"><span data-slate-leaf="true" data-offset-key="1533:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1534"><span data-slate-object="text" data-key="1535"><span data-slate-leaf="true" data-offset-key="1535:0" data-first-offset="true"><span data-slate-string="true">  rdb := redis.NewClient(&amp;redis.Options{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1536"><span data-slate-object="text" data-key="1537"><span data-slate-leaf="true" data-offset-key="1537:0" data-first-offset="true"><span data-slate-string="true">    Addr:     </span></span></span><span data-slate-object="text" data-key="1538"><span data-slate-leaf="true" data-offset-key="1538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"localhost:6379"</span></span></span></span><span data-slate-object="text" data-key="1539"><span data-slate-leaf="true" data-offset-key="1539:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1540"><span data-slate-object="text" data-key="1541"><span data-slate-leaf="true" data-offset-key="1541:0" data-first-offset="true"><span data-slate-string="true">    Password: </span></span></span><span data-slate-object="text" data-key="1542"><span data-slate-leaf="true" data-offset-key="1542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="1543"><span data-slate-leaf="true" data-offset-key="1543:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1544"><span data-slate-leaf="true" data-offset-key="1544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// no password set</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1545"><span data-slate-object="text" data-key="1546"><span data-slate-leaf="true" data-offset-key="1546:0" data-first-offset="true"><span data-slate-string="true">    DB:       </span></span></span><span data-slate-object="text" data-key="1547"><span data-slate-leaf="true" data-offset-key="1547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="1548"><span data-slate-leaf="true" data-offset-key="1548:0" data-first-offset="true"><span data-slate-string="true">,  </span></span></span><span data-slate-object="text" data-key="1549"><span data-slate-leaf="true" data-offset-key="1549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// use default DB</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1550"><span data-slate-object="text" data-key="1551"><span data-slate-leaf="true" data-offset-key="1551:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1552"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1553"><span data-slate-object="text" data-key="1554"><span data-slate-leaf="true" data-offset-key="1554:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1555"><span data-slate-leaf="true" data-offset-key="1555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1556"><span data-slate-leaf="true" data-offset-key="1556:0" data-first-offset="true"><span data-slate-string="true"> rdb.Set(ctx, </span></span></span><span data-slate-object="text" data-key="1557"><span data-slate-leaf="true" data-offset-key="1557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"key"</span></span></span></span><span data-slate-object="text" data-key="1558"><span data-slate-leaf="true" data-offset-key="1558:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1559"><span data-slate-leaf="true" data-offset-key="1559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"value"</span></span></span></span><span data-slate-object="text" data-key="1560"><span data-slate-leaf="true" data-offset-key="1560:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1561"><span data-slate-leaf="true" data-offset-key="1561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="1562"><span data-slate-leaf="true" data-offset-key="1562:0" data-first-offset="true"><span data-slate-string="true">).Err()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1563"><span data-slate-object="text" data-key="1564"><span data-slate-leaf="true" data-offset-key="1564:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1565"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1566"><span data-slate-object="text" data-key="1567"><span data-slate-leaf="true" data-offset-key="1567:0" data-first-offset="true"><span data-slate-string="true">这里使用了 go-redis 库，它每个方法的参数中都有一个标准 Context 接口，这让我们能将自定义的 Context 直接传递给 rdb.Set。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1568"><span data-slate-object="text" data-key="1569"><span data-slate-leaf="true" data-offset-key="1569:0" data-first-offset="true"><span data-slate-string="true">所以在我们的框架上实现这一步，只需要调用刚才封装的 request 中的 Context 的标准接口就行了，很简单，我们继续在 context.go 中进行补充：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1570"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1571"><span data-slate-object="text" data-key="1572"><span data-slate-leaf="true" data-offset-key="1572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1573"><span data-slate-leaf="true" data-offset-key="1573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1574"><span data-slate-leaf="true" data-offset-key="1574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx *Context)</span></span></span></span></span><span data-slate-object="text" data-key="1575"><span data-slate-leaf="true" data-offset-key="1575:0" data-first-offset="true"><span data-slate-string="true"> BaseContext() context.Context {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1576"><span data-slate-object="text" data-key="1577"><span data-slate-leaf="true" data-offset-key="1577:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1578"><span data-slate-leaf="true" data-offset-key="1578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1579"><span data-slate-leaf="true" data-offset-key="1579:0" data-first-offset="true"><span data-slate-string="true"> ctx.request.Context()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1580"><span data-slate-object="text" data-key="1581"><span data-slate-leaf="true" data-offset-key="1581:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1582"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1583"><span data-slate-object="text" data-key="1584"><span data-slate-leaf="true" data-offset-key="1584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1585"><span data-slate-leaf="true" data-offset-key="1585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1586"><span data-slate-leaf="true" data-offset-key="1586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx *Context)</span></span></span></span></span><span data-slate-object="text" data-key="1587"><span data-slate-leaf="true" data-offset-key="1587:0" data-first-offset="true"><span data-slate-string="true"> Done() &lt;-</span></span></span><span data-slate-object="text" data-key="1588"><span data-slate-leaf="true" data-offset-key="1588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="1589"><span data-slate-leaf="true" data-offset-key="1589:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1590"><span data-slate-leaf="true" data-offset-key="1590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1591"><span data-slate-leaf="true" data-offset-key="1591:0" data-first-offset="true"><span data-slate-string="true">{} {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1592"><span data-slate-object="text" data-key="1593"><span data-slate-leaf="true" data-offset-key="1593:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1594"><span data-slate-leaf="true" data-offset-key="1594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1595"><span data-slate-leaf="true" data-offset-key="1595:0" data-first-offset="true"><span data-slate-string="true"> ctx.BaseContext().Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1596"><span data-slate-object="text" data-key="1597"><span data-slate-leaf="true" data-offset-key="1597:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1598"><span data-slate-object="text" data-key="1599"><span data-slate-leaf="true" data-offset-key="1599:0" data-first-offset="true"><span data-slate-string="true">这里举例了两个 method 的实现，其他的都大同小异就不在文稿里展示，你可以先自己写，然后对照我放在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="1600"><span data-slate-object="text" data-key="1601"><span data-slate-leaf="true" data-offset-key="1601:0" data-first-offset="true"><span data-slate-string="true">GitHub</span></span></span></a><span data-slate-object="text" data-key="1602"><span data-slate-leaf="true" data-offset-key="1602:0" data-first-offset="true"><span data-slate-string="true"> 上的完整代码检查一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1603"><span data-slate-object="text" data-key="1604"><span data-slate-leaf="true" data-offset-key="1604:0" data-first-offset="true"><span data-slate-string="true">自己封装的 Context 最终需要提供四类功能函数：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1605"><div data-slate-type="list-line" data-slate-object="block" data-key="1606"><span data-slate-object="text" data-key="1607"><span data-slate-leaf="true" data-offset-key="1607:0" data-first-offset="true"><span data-slate-string="true">base 封装基本的函数功能，比如获取 http.Request 结构</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1608"><span data-slate-object="text" data-key="1609"><span data-slate-leaf="true" data-offset-key="1609:0" data-first-offset="true"><span data-slate-string="true">context 实现标准 Context 接口</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1610"><span data-slate-object="text" data-key="1611"><span data-slate-leaf="true" data-offset-key="1611:0" data-first-offset="true"><span data-slate-string="true">request 封装了 http.Request 的对外接口</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1612"><span data-slate-object="text" data-key="1613"><span data-slate-leaf="true" data-offset-key="1613:0" data-first-offset="true"><span data-slate-string="true">response 封装了 http.ResponseWriter 对外接口</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1614"><span data-slate-object="text" data-key="1615"><span data-slate-leaf="true" data-offset-key="1615:0" data-first-offset="true"><span data-slate-string="true">完成之后，使用我们的 IDE 里面的结构查看器（每个 IDE 显示都不同），就能查看到如下的函数列表：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1616"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/3c/cc/3c0c98741275beb7bdf5d6333b0c91cc.jpg?wh=1248x1456"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1617"><span data-slate-object="text" data-key="1618"><span data-slate-leaf="true" data-offset-key="1618:0" data-first-offset="true"><span data-slate-string="true">有了我们自己封装的 Context 之后，控制器就非常简化了。把框架定义的 ControllerHandler 放在框架目录下的 controller.go 文件中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1619"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1620"><span data-slate-object="text" data-key="1621"><span data-slate-leaf="true" data-offset-key="1621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="1622"><span data-slate-leaf="true" data-offset-key="1622:0" data-first-offset="true"><span data-slate-string="true"> ControllerHandler </span></span></span><span data-slate-object="text" data-key="1623"><span data-slate-leaf="true" data-offset-key="1623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1624"><span data-slate-leaf="true" data-offset-key="1624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *Context)</span></span></span></span></span><span data-slate-object="text" data-key="1625"><span data-slate-leaf="true" data-offset-key="1625:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1626"><span data-slate-leaf="true" data-offset-key="1626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1627"><span data-slate-object="text" data-key="1628"><span data-slate-leaf="true" data-offset-key="1628:0" data-first-offset="true"><span data-slate-string="true">把处理业务的控制器放在业务目录下的 controller.go 文件中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1629"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1630"><span data-slate-object="text" data-key="1631"><span data-slate-leaf="true" data-offset-key="1631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1632"><span data-slate-leaf="true" data-offset-key="1632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1633"><span data-slate-leaf="true" data-offset-key="1633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">FooControllerHandler</span></span></span></span></span><span data-slate-object="text" data-key="1634"><span data-slate-leaf="true" data-offset-key="1634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx *framework.Context)</span></span></span></span></span><span data-slate-object="text" data-key="1635"><span data-slate-leaf="true" data-offset-key="1635:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1636"><span data-slate-leaf="true" data-offset-key="1636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="1637"><span data-slate-leaf="true" data-offset-key="1637:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1638"><span data-slate-object="text" data-key="1639"><span data-slate-leaf="true" data-offset-key="1639:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1640"><span data-slate-leaf="true" data-offset-key="1640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1641"><span data-slate-leaf="true" data-offset-key="1641:0" data-first-offset="true"><span data-slate-string="true"> ctx.Json(</span></span></span><span data-slate-object="text" data-key="1642"><span data-slate-leaf="true" data-offset-key="1642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">200</span></span></span></span><span data-slate-object="text" data-key="1643"><span data-slate-leaf="true" data-offset-key="1643:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1644"><span data-slate-leaf="true" data-offset-key="1644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1645"><span data-slate-leaf="true" data-offset-key="1645:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1646"><span data-slate-leaf="true" data-offset-key="1646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1647"><span data-slate-leaf="true" data-offset-key="1647:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1648"><span data-slate-leaf="true" data-offset-key="1648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1649"><span data-slate-leaf="true" data-offset-key="1649:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1650"><span data-slate-object="text" data-key="1651"><span data-slate-leaf="true" data-offset-key="1651:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1652"><span data-slate-leaf="true" data-offset-key="1652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"code"</span></span></span></span><span data-slate-object="text" data-key="1653"><span data-slate-leaf="true" data-offset-key="1653:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="1654"><span data-slate-leaf="true" data-offset-key="1654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="1655"><span data-slate-leaf="true" data-offset-key="1655:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1656"><span data-slate-object="text" data-key="1657"><span data-slate-leaf="true" data-offset-key="1657:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1658"><span data-slate-object="text" data-key="1659"><span data-slate-leaf="true" data-offset-key="1659:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1660"><span data-slate-object="text" data-key="1661"><span data-slate-leaf="true" data-offset-key="1661:0" data-first-offset="true"><span data-slate-string="true">参数只有一个 framework.Context，是不是清爽很多，这都归功于刚完成的自定义 Context。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1662" id="sr-toc-4"><span data-slate-object="text" data-key="1663"><span data-slate-leaf="true" data-offset-key="1663:0" data-first-offset="true"><span data-slate-string="true">为单个请求设置超时</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1664"><span data-slate-object="text" data-key="1665"><span data-slate-leaf="true" data-offset-key="1665:0" data-first-offset="true"><span data-slate-string="true">上面我们封装了自定义的 Context，从设计层面实现了标准库的 Context。下面回到我们这节课核心要解决的问题，为单个请求设置超时。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1666"><span data-slate-object="text" data-key="1667"><span data-slate-leaf="true" data-offset-key="1667:0" data-first-offset="true"><span data-slate-string="true">如何使用自定义 Context 设置超时呢？结合前面分析的标准库思路，我们三步走完成：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1668"><div data-slate-type="list-line" data-slate-object="block" data-key="1669"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="1670"><span data-slate-leaf="true" data-offset-key="1670:0" data-first-offset="true"><span data-slate-string="true">继承 request 的 Context，创建出一个设置超时时间的 Context；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="1671"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="1672"><span data-slate-leaf="true" data-offset-key="1672:0" data-first-offset="true"><span data-slate-string="true">创建一个新的 Goroutine 来处理具体的业务逻辑；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="1673"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="1674"><span data-slate-leaf="true" data-offset-key="1674:0" data-first-offset="true"><span data-slate-string="true">设计事件处理顺序，当前 Goroutine 监听超时时间 Contex 的 Done () 事件，和具体的业务处理结束事件，哪个先到就先处理哪个。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1675"><span data-slate-object="text" data-key="1676"><span data-slate-leaf="true" data-offset-key="1676:0" data-first-offset="true"><span data-slate-string="true">理清步骤，我们就可以在业务的 controller.go 文件中完成业务逻辑了。</span></span></span><span data-slate-object="text" data-key="1677"><span data-slate-leaf="true" data-offset-key="1677:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第一步生成一个超时的 Context</span></span></span></span><span data-slate-object="text" data-key="1678"><span data-slate-leaf="true" data-offset-key="1678:0" data-first-offset="true"><span data-slate-string="true">：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1679"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1680"><span data-slate-object="text" data-key="1681"><span data-slate-leaf="true" data-offset-key="1681:0" data-first-offset="true"><span data-slate-string="true">durationCtx, cancel := context.WithTimeout(c.BaseContext(), time.Duration(</span></span></span><span data-slate-object="text" data-key="1682"><span data-slate-leaf="true" data-offset-key="1682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1683"><span data-slate-leaf="true" data-offset-key="1683:0" data-first-offset="true"><span data-slate-string="true">*time.Second))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1684"><span data-slate-object="text" data-key="1685"><span data-slate-leaf="true" data-offset-key="1685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这里记得当所有事情处理结束后调用 cancel，告知 durationCtx 的后续 Context 结束</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1686"><span data-slate-object="text" data-key="1687"><span data-slate-leaf="true" data-offset-key="1687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="1688"><span data-slate-leaf="true" data-offset-key="1688:0" data-first-offset="true"><span data-slate-string="true"> cancel()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1689"><span data-slate-object="text" data-key="1690"><span data-slate-leaf="true" data-offset-key="1690:0" data-first-offset="true"><span data-slate-string="true">这里为了最终在浏览器做验证，我设置超时事件为 1s，这样最终验证的时候，最长等待 1s 就可以知道超时是否生效。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1691"><span data-slate-object="text" data-key="1692"><span data-slate-leaf="true" data-offset-key="1692:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第二步创建一个新的 Goroutine 来处理业务逻辑</span></span></span></span><span data-slate-object="text" data-key="1693"><span data-slate-leaf="true" data-offset-key="1693:0" data-first-offset="true"><span data-slate-string="true">：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1694"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1695"><span data-slate-object="text" data-key="1696"><span data-slate-leaf="true" data-offset-key="1696:0" data-first-offset="true"><span data-slate-string="true">finish := </span></span></span><span data-slate-object="text" data-key="1697"><span data-slate-leaf="true" data-offset-key="1697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="1698"><span data-slate-leaf="true" data-offset-key="1698:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1699"><span data-slate-leaf="true" data-offset-key="1699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="1700"><span data-slate-leaf="true" data-offset-key="1700:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1701"><span data-slate-leaf="true" data-offset-key="1701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1702"><span data-slate-leaf="true" data-offset-key="1702:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="1703"><span data-slate-leaf="true" data-offset-key="1703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1704"><span data-slate-leaf="true" data-offset-key="1704:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1705"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1706"><span data-slate-object="text" data-key="1707"><span data-slate-leaf="true" data-offset-key="1707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="1708"><span data-slate-leaf="true" data-offset-key="1708:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1709"><span data-slate-leaf="true" data-offset-key="1709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1710"><span data-slate-leaf="true" data-offset-key="1710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="1711"><span data-slate-leaf="true" data-offset-key="1711:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1712"><span data-slate-object="text" data-key="1713"><span data-slate-leaf="true" data-offset-key="1713:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1714"><span data-slate-object="text" data-key="1715"><span data-slate-leaf="true" data-offset-key="1715:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1716"><span data-slate-leaf="true" data-offset-key="1716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这里做具体的业务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1717"><span data-slate-object="text" data-key="1718"><span data-slate-leaf="true" data-offset-key="1718:0" data-first-offset="true"><span data-slate-string="true">    time.Sleep(</span></span></span><span data-slate-object="text" data-key="1719"><span data-slate-leaf="true" data-offset-key="1719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="1720"><span data-slate-leaf="true" data-offset-key="1720:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1721"><span data-slate-object="text" data-key="1722"><span data-slate-leaf="true" data-offset-key="1722:0" data-first-offset="true"><span data-slate-string="true">        c.Json(</span></span></span><span data-slate-object="text" data-key="1723"><span data-slate-leaf="true" data-offset-key="1723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">200</span></span></span></span><span data-slate-object="text" data-key="1724"><span data-slate-leaf="true" data-offset-key="1724:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1725"><span data-slate-leaf="true" data-offset-key="1725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"ok"</span></span></span></span><span data-slate-object="text" data-key="1726"><span data-slate-leaf="true" data-offset-key="1726:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1727"><span data-slate-object="text" data-key="1728"><span data-slate-leaf="true" data-offset-key="1728:0" data-first-offset="true"><span data-slate-string="true">        ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1729"><span data-slate-object="text" data-key="1730"><span data-slate-leaf="true" data-offset-key="1730:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1731"><span data-slate-leaf="true" data-offset-key="1731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 新的 goroutine 结束的时候通过一个 finish 通道告知父 goroutine</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1732"><span data-slate-object="text" data-key="1733"><span data-slate-leaf="true" data-offset-key="1733:0" data-first-offset="true"><span data-slate-string="true">    finish &lt;- </span></span></span><span data-slate-object="text" data-key="1734"><span data-slate-leaf="true" data-offset-key="1734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1735"><span data-slate-leaf="true" data-offset-key="1735:0" data-first-offset="true"><span data-slate-string="true">{}{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1736"><span data-slate-object="text" data-key="1737"><span data-slate-leaf="true" data-offset-key="1737:0" data-first-offset="true"><span data-slate-string="true">}()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1738"><span data-slate-object="text" data-key="1739"><span data-slate-leaf="true" data-offset-key="1739:0" data-first-offset="true"><span data-slate-string="true">为了最终的验证效果，我们使用 time.Sleep 将新 Goroutine 的业务逻辑事件人为往后延迟了 10s，再输出 “ok”，这样最终验证的时候，效果比较明显，因为前面的超时设置会在 1s 生效了，浏览器就有表现了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1740"><span data-slate-object="text" data-key="1741"><span data-slate-leaf="true" data-offset-key="1741:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">到这里我们这里先不急着进入第三步，还有错误处理情况没有考虑到位</span></span></span></span><span data-slate-object="text" data-key="1742"><span data-slate-leaf="true" data-offset-key="1742:0" data-first-offset="true"><span data-slate-string="true">。这个新创建的 Goroutine 如果出现未知异常怎么办？需要我们额外捕获吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1743"><span data-slate-object="text" data-key="1744"><span data-slate-leaf="true" data-offset-key="1744:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_9abf47df" data-attr-id="27516" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_26744fe3" data-attr-id="27521" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">其实在 Golang 的设计中，每个 Goroutine 都是独立存在的，父 Goroutine 一旦使用 Go 关键字开启了一个子 Goroutine，父子 Goroutine 就是平等存在的，他们互相不能干扰。而在异常面前，所有 Goroutine 的异常都需要自己管理，</span></span></span></span><span data-slate-leaf="true" data-offset-key="1744:1"><span data-slate-object="annotation" data-annotation-key="gkann_26744fe3" data-attr-id="27521" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">不会存在父 Goroutine 捕获子 Goroutine 异常的操作。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1745"><span data-slate-object="text" data-key="1746"><span data-slate-leaf="true" data-offset-key="1746:0" data-first-offset="true"><span data-slate-string="true">所以切记：在 Golang 中，每个 Goroutine 创建的时候，我们要使用 defer 和 recover 关键字为当前 Goroutine 捕获 panic 异常，并进行处理，否则，任意一处 panic 就会导致整个进程崩溃！</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1747"><span data-slate-object="text" data-key="1748"><span data-slate-leaf="true" data-offset-key="1748:0" data-first-offset="true"><span data-slate-string="true">这里你可以标个重点，面试会经常被问到。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1749"><span data-slate-object="text" data-key="1750"><span data-slate-leaf="true" data-offset-key="1750:0" data-first-offset="true"><span data-slate-string="true">搞清楚这一点，</span></span></span><span data-slate-object="text" data-key="1751"><span data-slate-leaf="true" data-offset-key="1751:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">我们回看第二步，做完具体业务逻辑就结束是不行的，还需要处理 panic</span></span></span></span><span data-slate-object="text" data-key="1752"><span data-slate-leaf="true" data-offset-key="1752:0" data-first-offset="true"><span data-slate-string="true">。所以这个 Goroutine 应该要有两个 channel 对外传递事件：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1753"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1754"><span data-slate-object="text" data-key="1755"><span data-slate-leaf="true" data-offset-key="1755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个 channal 负责通知结束</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1756"><span data-slate-object="text" data-key="1757"><span data-slate-leaf="true" data-offset-key="1757:0" data-first-offset="true"><span data-slate-string="true">finish := </span></span></span><span data-slate-object="text" data-key="1758"><span data-slate-leaf="true" data-offset-key="1758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="1759"><span data-slate-leaf="true" data-offset-key="1759:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1760"><span data-slate-leaf="true" data-offset-key="1760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="1761"><span data-slate-leaf="true" data-offset-key="1761:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1762"><span data-slate-leaf="true" data-offset-key="1762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1763"><span data-slate-leaf="true" data-offset-key="1763:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="1764"><span data-slate-leaf="true" data-offset-key="1764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1765"><span data-slate-leaf="true" data-offset-key="1765:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1766"><span data-slate-object="text" data-key="1767"><span data-slate-leaf="true" data-offset-key="1767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这个 channel 负责通知 panic 异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1768"><span data-slate-object="text" data-key="1769"><span data-slate-leaf="true" data-offset-key="1769:0" data-first-offset="true"><span data-slate-string="true">panicChan := </span></span></span><span data-slate-object="text" data-key="1770"><span data-slate-leaf="true" data-offset-key="1770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="1771"><span data-slate-leaf="true" data-offset-key="1771:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1772"><span data-slate-leaf="true" data-offset-key="1772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="1773"><span data-slate-leaf="true" data-offset-key="1773:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1774"><span data-slate-leaf="true" data-offset-key="1774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1775"><span data-slate-leaf="true" data-offset-key="1775:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="1776"><span data-slate-leaf="true" data-offset-key="1776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1777"><span data-slate-leaf="true" data-offset-key="1777:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1778"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1779"><span data-slate-object="text" data-key="1780"><span data-slate-leaf="true" data-offset-key="1780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="1781"><span data-slate-leaf="true" data-offset-key="1781:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1782"><span data-slate-leaf="true" data-offset-key="1782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1783"><span data-slate-leaf="true" data-offset-key="1783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="1784"><span data-slate-leaf="true" data-offset-key="1784:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1785"><span data-slate-object="text" data-key="1786"><span data-slate-leaf="true" data-offset-key="1786:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1787"><span data-slate-leaf="true" data-offset-key="1787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这里增加异常处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1788"><span data-slate-object="text" data-key="1789"><span data-slate-leaf="true" data-offset-key="1789:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1790"><span data-slate-leaf="true" data-offset-key="1790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="1791"><span data-slate-leaf="true" data-offset-key="1791:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1792"><span data-slate-leaf="true" data-offset-key="1792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1793"><span data-slate-leaf="true" data-offset-key="1793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="1794"><span data-slate-leaf="true" data-offset-key="1794:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1795"><span data-slate-object="text" data-key="1796"><span data-slate-leaf="true" data-offset-key="1796:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1797"><span data-slate-leaf="true" data-offset-key="1797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1798"><span data-slate-leaf="true" data-offset-key="1798:0" data-first-offset="true"><span data-slate-string="true"> p := </span></span></span><span data-slate-object="text" data-key="1799"><span data-slate-leaf="true" data-offset-key="1799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">recover</span></span></span></span><span data-slate-object="text" data-key="1800"><span data-slate-leaf="true" data-offset-key="1800:0" data-first-offset="true"><span data-slate-string="true">(); p != </span></span></span><span data-slate-object="text" data-key="1801"><span data-slate-leaf="true" data-offset-key="1801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1802"><span data-slate-leaf="true" data-offset-key="1802:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1803"><span data-slate-object="text" data-key="1804"><span data-slate-leaf="true" data-offset-key="1804:0" data-first-offset="true"><span data-slate-string="true">        panicChan &lt;- p</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1805"><span data-slate-object="text" data-key="1806"><span data-slate-leaf="true" data-offset-key="1806:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1807"><span data-slate-object="text" data-key="1808"><span data-slate-leaf="true" data-offset-key="1808:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1809"><span data-slate-object="text" data-key="1810"><span data-slate-leaf="true" data-offset-key="1810:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1811"><span data-slate-leaf="true" data-offset-key="1811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这里做具体的业务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1812"><span data-slate-object="text" data-key="1813"><span data-slate-leaf="true" data-offset-key="1813:0" data-first-offset="true"><span data-slate-string="true">    time.Sleep(</span></span></span><span data-slate-object="text" data-key="1814"><span data-slate-leaf="true" data-offset-key="1814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="1815"><span data-slate-leaf="true" data-offset-key="1815:0" data-first-offset="true"><span data-slate-string="true"> * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1816"><span data-slate-object="text" data-key="1817"><span data-slate-leaf="true" data-offset-key="1817:0" data-first-offset="true"><span data-slate-string="true">        c.Json(</span></span></span><span data-slate-object="text" data-key="1818"><span data-slate-leaf="true" data-offset-key="1818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">200</span></span></span></span><span data-slate-object="text" data-key="1819"><span data-slate-leaf="true" data-offset-key="1819:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1820"><span data-slate-leaf="true" data-offset-key="1820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"ok"</span></span></span></span><span data-slate-object="text" data-key="1821"><span data-slate-leaf="true" data-offset-key="1821:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1822"><span data-slate-object="text" data-key="1823"><span data-slate-leaf="true" data-offset-key="1823:0" data-first-offset="true"><span data-slate-string="true">        ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1824"><span data-slate-object="text" data-key="1825"><span data-slate-leaf="true" data-offset-key="1825:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1826"><span data-slate-leaf="true" data-offset-key="1826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 新的 goroutine 结束的时候通过一个 finish 通道告知父 goroutine</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1827"><span data-slate-object="text" data-key="1828"><span data-slate-leaf="true" data-offset-key="1828:0" data-first-offset="true"><span data-slate-string="true">    finish &lt;- </span></span></span><span data-slate-object="text" data-key="1829"><span data-slate-leaf="true" data-offset-key="1829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1830"><span data-slate-leaf="true" data-offset-key="1830:0" data-first-offset="true"><span data-slate-string="true">{}{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1831"><span data-slate-object="text" data-key="1832"><span data-slate-leaf="true" data-offset-key="1832:0" data-first-offset="true"><span data-slate-string="true">}(）</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1833"><span data-slate-object="text" data-key="1834"><span data-slate-leaf="true" data-offset-key="1834:0" data-first-offset="true"><span data-slate-string="true">现在第二步才算完成了，我们继续写第三步监听。使用 select 关键字来监听三个事件：异常事件、结束事件、超时事件。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1835"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1836"><span data-slate-object="text" data-key="1837"><span data-slate-leaf="true" data-offset-key="1837:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1838"><span data-slate-leaf="true" data-offset-key="1838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="1839"><span data-slate-leaf="true" data-offset-key="1839:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1840"><span data-slate-object="text" data-key="1841"><span data-slate-leaf="true" data-offset-key="1841:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1842"><span data-slate-leaf="true" data-offset-key="1842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 监听 panic</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1843"><span data-slate-object="text" data-key="1844"><span data-slate-leaf="true" data-offset-key="1844:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1845"><span data-slate-leaf="true" data-offset-key="1845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1846"><span data-slate-leaf="true" data-offset-key="1846:0" data-first-offset="true"><span data-slate-string="true"> p := &lt;-panicChan:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1847"><span data-slate-object="text" data-key="1848"><span data-slate-leaf="true" data-offset-key="1848:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1849"><span data-slate-object="text" data-key="1850"><span data-slate-leaf="true" data-offset-key="1850:0" data-first-offset="true"><span data-slate-string="true">        c.Json(</span></span></span><span data-slate-object="text" data-key="1851"><span data-slate-leaf="true" data-offset-key="1851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="1852"><span data-slate-leaf="true" data-offset-key="1852:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1853"><span data-slate-leaf="true" data-offset-key="1853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"panic"</span></span></span></span><span data-slate-object="text" data-key="1854"><span data-slate-leaf="true" data-offset-key="1854:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1855"><span data-slate-object="text" data-key="1856"><span data-slate-leaf="true" data-offset-key="1856:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1857"><span data-slate-leaf="true" data-offset-key="1857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 监听结束事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1858"><span data-slate-object="text" data-key="1859"><span data-slate-leaf="true" data-offset-key="1859:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1860"><span data-slate-leaf="true" data-offset-key="1860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1861"><span data-slate-leaf="true" data-offset-key="1861:0" data-first-offset="true"><span data-slate-string="true"> &lt;-finish:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1862"><span data-slate-object="text" data-key="1863"><span data-slate-leaf="true" data-offset-key="1863:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1864"><span data-slate-object="text" data-key="1865"><span data-slate-leaf="true" data-offset-key="1865:0" data-first-offset="true"><span data-slate-string="true">        fmt.Println(</span></span></span><span data-slate-object="text" data-key="1866"><span data-slate-leaf="true" data-offset-key="1866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"finish"</span></span></span></span><span data-slate-object="text" data-key="1867"><span data-slate-leaf="true" data-offset-key="1867:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1868"><span data-slate-object="text" data-key="1869"><span data-slate-leaf="true" data-offset-key="1869:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1870"><span data-slate-leaf="true" data-offset-key="1870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 监听超时事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1871"><span data-slate-object="text" data-key="1872"><span data-slate-leaf="true" data-offset-key="1872:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1873"><span data-slate-leaf="true" data-offset-key="1873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1874"><span data-slate-leaf="true" data-offset-key="1874:0" data-first-offset="true"><span data-slate-string="true"> &lt;-durationCtx.Done():</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1875"><span data-slate-object="text" data-key="1876"><span data-slate-leaf="true" data-offset-key="1876:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1877"><span data-slate-object="text" data-key="1878"><span data-slate-leaf="true" data-offset-key="1878:0" data-first-offset="true"><span data-slate-string="true">        c.Json(</span></span></span><span data-slate-object="text" data-key="1879"><span data-slate-leaf="true" data-offset-key="1879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="1880"><span data-slate-leaf="true" data-offset-key="1880:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1881"><span data-slate-leaf="true" data-offset-key="1881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"time out"</span></span></span></span><span data-slate-object="text" data-key="1882"><span data-slate-leaf="true" data-offset-key="1882:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1883"><span data-slate-object="text" data-key="1884"><span data-slate-leaf="true" data-offset-key="1884:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1885"><span data-slate-object="text" data-key="1886"><span data-slate-leaf="true" data-offset-key="1886:0" data-first-offset="true"><span data-slate-string="true">接收到结束事件，只需要打印日志，但是，在接收到异常事件和超时事件的时候，我们希望告知浏览器前端 “异常或者超时了”，所以会使用 c.Json 来返回一个字符串信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1887"><span data-slate-object="text" data-key="1888"><span data-slate-leaf="true" data-offset-key="1888:0" data-first-offset="true"><span data-slate-string="true">三步走到这里就完成了对某个请求的超时设置，你可以通过 go build、go run 尝试启动下这个服务。如果你在浏览器开启一个请求之后，浏览器不会等候事件处理 10s，而在等待我们设置的超时事件 1s 后，页面显示 “time out” 就结束这个请求了，就说明我们为某个事件设置的超时生效了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1889" id="sr-toc-5"><span data-slate-object="text" data-key="1890"><span data-slate-leaf="true" data-offset-key="1890:0" data-first-offset="true"><span data-slate-string="true">边界场景</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1891"><span data-slate-object="text" data-key="1892"><span data-slate-leaf="true" data-offset-key="1892:0" data-first-offset="true"><span data-slate-string="true">到这里，我们的超时逻辑设置就结束且生效了。但是，这样的代码逻辑只能算是及格，为什么这么说呢？因为它并没有覆盖所有的场景。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1893"><span data-slate-object="text" data-key="1894"><span data-slate-leaf="true" data-offset-key="1894:0" data-first-offset="true"><span data-slate-string="true">我们的代码逻辑要再严谨一些，</span></span></span><span data-slate-object="text" data-key="1895"><span data-slate-leaf="true" data-offset-key="1895:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">把边界场景也考虑进来</span></span></span></span><span data-slate-object="text" data-key="1896"><span data-slate-leaf="true" data-offset-key="1896:0" data-first-offset="true"><span data-slate-string="true">。这里有两种可能：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1897"><div data-slate-type="list-line" data-slate-object="block" data-key="1898"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="1899"><span data-slate-leaf="true" data-offset-key="1899:0" data-first-offset="true"><span data-slate-string="true">异常事件、超时事件触发时，需要往 responseWriter 中写入信息，这个时候如果有其他 Goroutine 也要操作 responseWriter，会不会导致 responseWriter 中的信息出现乱序？</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="1900"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="1901"><span data-slate-leaf="true" data-offset-key="1901:0" data-first-offset="true"><span data-slate-string="true">超时事件触发结束之后，已经往 responseWriter 中写入信息了，这个时候如果有其他 Goroutine 也要操作 responseWriter， 会不会导致 responseWriter 中的信息重复写入？</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1902"><span data-slate-object="text" data-key="1903"><span data-slate-leaf="true" data-offset-key="1903:0" data-first-offset="true"><span data-slate-string="true">你先分析第一个问题，是很有可能出现的。方案不难想到，我们要保证在事件处理结束之前，不允许任何其他 Goroutine 操作 responseWriter，这里可以使用一个锁（sync.Mutex）对 responseWriter 进行写保护。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1904"><span data-slate-object="text" data-key="1905"><span data-slate-leaf="true" data-offset-key="1905:0" data-first-offset="true"><span data-slate-string="true">在框架文件夹的 context.go 中对 Context 结构进行一些设置：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1906"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1907"><span data-slate-object="text" data-key="1908"><span data-slate-leaf="true" data-offset-key="1908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="1909"><span data-slate-leaf="true" data-offset-key="1909:0" data-first-offset="true"><span data-slate-string="true"> Context </span></span></span><span data-slate-object="text" data-key="1910"><span data-slate-leaf="true" data-offset-key="1910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1911"><span data-slate-leaf="true" data-offset-key="1911:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1912"><span data-slate-object="text" data-key="1913"><span data-slate-leaf="true" data-offset-key="1913:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1914"><span data-slate-leaf="true" data-offset-key="1914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 写保护机制</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1915"><span data-slate-object="text" data-key="1916"><span data-slate-leaf="true" data-offset-key="1916:0" data-first-offset="true"><span data-slate-string="true">  writerMux  *sync.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1917"><span data-slate-object="text" data-key="1918"><span data-slate-leaf="true" data-offset-key="1918:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1919"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1920"><span data-slate-object="text" data-key="1921"><span data-slate-leaf="true" data-offset-key="1921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对外暴露锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1922"><span data-slate-object="text" data-key="1923"><span data-slate-leaf="true" data-offset-key="1923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1924"><span data-slate-leaf="true" data-offset-key="1924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1925"><span data-slate-leaf="true" data-offset-key="1925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx *Context)</span></span></span></span></span><span data-slate-object="text" data-key="1926"><span data-slate-leaf="true" data-offset-key="1926:0" data-first-offset="true"><span data-slate-string="true"> WriterMux() *sync.Mutex {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1927"><span data-slate-object="text" data-key="1928"><span data-slate-leaf="true" data-offset-key="1928:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1929"><span data-slate-leaf="true" data-offset-key="1929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1930"><span data-slate-leaf="true" data-offset-key="1930:0" data-first-offset="true"><span data-slate-string="true"> ctx.writerMux</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1931"><span data-slate-object="text" data-key="1932"><span data-slate-leaf="true" data-offset-key="1932:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1933"><span data-slate-object="text" data-key="1934"><span data-slate-leaf="true" data-offset-key="1934:0" data-first-offset="true"><span data-slate-string="true">在刚才写的业务文件夹 controller.go 中也进行对应的修改：</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="1935"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1936"><span data-slate-object="text" data-key="1937"><span data-slate-leaf="true" data-offset-key="1937:0" data-first-offset="true"><span data-slate-string="true">func FooControllerHandler(c *framework</span></span></span><span data-slate-object="text" data-key="1938"><span data-slate-leaf="true" data-offset-key="1938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">.Context</span></span></span></span><span data-slate-object="text" data-key="1939"><span data-slate-leaf="true" data-offset-key="1939:0" data-first-offset="true"><span data-slate-string="true">) error {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1940"><span data-slate-object="text" data-key="1941"><span data-slate-leaf="true" data-offset-key="1941:0" data-first-offset="true"><span data-slate-string="true">  ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1942"><span data-slate-object="text" data-key="1943"><span data-slate-leaf="true" data-offset-key="1943:0" data-first-offset="true"><span data-slate-string="true">    // 请求监听的时候增加锁机制</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1944"><span data-slate-object="text" data-key="1945"><span data-slate-leaf="true" data-offset-key="1945:0" data-first-offset="true"><span data-slate-string="true">  select {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1946"><span data-slate-object="text" data-key="1947"><span data-slate-leaf="true" data-offset-key="1947:0" data-first-offset="true"><span data-slate-string="true">  case </span></span></span><span data-slate-object="text" data-key="1948"><span data-slate-leaf="true" data-offset-key="1948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">p</span></span></span></span><span data-slate-object="text" data-key="1949"><span data-slate-leaf="true" data-offset-key="1949:0" data-first-offset="true"><span data-slate-string="true"> := &lt;-panicChan:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1950"><span data-slate-object="text" data-key="1951"><span data-slate-leaf="true" data-offset-key="1951:0" data-first-offset="true"><span data-slate-string="true">    c.</span></span></span><span data-slate-object="text" data-key="1952"><span data-slate-leaf="true" data-offset-key="1952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WriterMux</span></span></span></span><span data-slate-object="text" data-key="1953"><span data-slate-leaf="true" data-offset-key="1953:0" data-first-offset="true"><span data-slate-string="true">().</span></span></span><span data-slate-object="text" data-key="1954"><span data-slate-leaf="true" data-offset-key="1954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Lock</span></span></span></span><span data-slate-object="text" data-key="1955"><span data-slate-leaf="true" data-offset-key="1955:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1956"><span data-slate-object="text" data-key="1957"><span data-slate-leaf="true" data-offset-key="1957:0" data-first-offset="true"><span data-slate-string="true">    defer c.</span></span></span><span data-slate-object="text" data-key="1958"><span data-slate-leaf="true" data-offset-key="1958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WriterMux</span></span></span></span><span data-slate-object="text" data-key="1959"><span data-slate-leaf="true" data-offset-key="1959:0" data-first-offset="true"><span data-slate-string="true">().</span></span></span><span data-slate-object="text" data-key="1960"><span data-slate-leaf="true" data-offset-key="1960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Unlock</span></span></span></span><span data-slate-object="text" data-key="1961"><span data-slate-leaf="true" data-offset-key="1961:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1962"><span data-slate-object="text" data-key="1963"><span data-slate-leaf="true" data-offset-key="1963:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1964"><span data-slate-object="text" data-key="1965"><span data-slate-leaf="true" data-offset-key="1965:0" data-first-offset="true"><span data-slate-string="true">    c.</span></span></span><span data-slate-object="text" data-key="1966"><span data-slate-leaf="true" data-offset-key="1966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Json</span></span></span></span><span data-slate-object="text" data-key="1967"><span data-slate-leaf="true" data-offset-key="1967:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1968"><span data-slate-leaf="true" data-offset-key="1968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="1969"><span data-slate-leaf="true" data-offset-key="1969:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1970"><span data-slate-leaf="true" data-offset-key="1970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"panic"</span></span></span></span><span data-slate-object="text" data-key="1971"><span data-slate-leaf="true" data-offset-key="1971:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1972"><span data-slate-object="text" data-key="1973"><span data-slate-leaf="true" data-offset-key="1973:0" data-first-offset="true"><span data-slate-string="true">  case &lt;-finish:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1974"><span data-slate-object="text" data-key="1975"><span data-slate-leaf="true" data-offset-key="1975:0" data-first-offset="true"><span data-slate-string="true">        ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1976"><span data-slate-object="text" data-key="1977"><span data-slate-leaf="true" data-offset-key="1977:0" data-first-offset="true"><span data-slate-string="true">    fmt.</span></span></span><span data-slate-object="text" data-key="1978"><span data-slate-leaf="true" data-offset-key="1978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Println</span></span></span></span><span data-slate-object="text" data-key="1979"><span data-slate-leaf="true" data-offset-key="1979:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1980"><span data-slate-leaf="true" data-offset-key="1980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"finish"</span></span></span></span><span data-slate-object="text" data-key="1981"><span data-slate-leaf="true" data-offset-key="1981:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1982"><span data-slate-object="text" data-key="1983"><span data-slate-leaf="true" data-offset-key="1983:0" data-first-offset="true"><span data-slate-string="true">  case &lt;-durationCtx.</span></span></span><span data-slate-object="text" data-key="1984"><span data-slate-leaf="true" data-offset-key="1984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Done</span></span></span></span><span data-slate-object="text" data-key="1985"><span data-slate-leaf="true" data-offset-key="1985:0" data-first-offset="true"><span data-slate-string="true">():</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1986"><span data-slate-object="text" data-key="1987"><span data-slate-leaf="true" data-offset-key="1987:0" data-first-offset="true"><span data-slate-string="true">    c.</span></span></span><span data-slate-object="text" data-key="1988"><span data-slate-leaf="true" data-offset-key="1988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WriterMux</span></span></span></span><span data-slate-object="text" data-key="1989"><span data-slate-leaf="true" data-offset-key="1989:0" data-first-offset="true"><span data-slate-string="true">().</span></span></span><span data-slate-object="text" data-key="1990"><span data-slate-leaf="true" data-offset-key="1990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Lock</span></span></span></span><span data-slate-object="text" data-key="1991"><span data-slate-leaf="true" data-offset-key="1991:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1992"><span data-slate-object="text" data-key="1993"><span data-slate-leaf="true" data-offset-key="1993:0" data-first-offset="true"><span data-slate-string="true">    defer c.</span></span></span><span data-slate-object="text" data-key="1994"><span data-slate-leaf="true" data-offset-key="1994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WriterMux</span></span></span></span><span data-slate-object="text" data-key="1995"><span data-slate-leaf="true" data-offset-key="1995:0" data-first-offset="true"><span data-slate-string="true">().</span></span></span><span data-slate-object="text" data-key="1996"><span data-slate-leaf="true" data-offset-key="1996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Unlock</span></span></span></span><span data-slate-object="text" data-key="1997"><span data-slate-leaf="true" data-offset-key="1997:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1998"><span data-slate-object="text" data-key="1999"><span data-slate-leaf="true" data-offset-key="1999:0" data-first-offset="true"><span data-slate-string="true">    c.</span></span></span><span data-slate-object="text" data-key="2000"><span data-slate-leaf="true" data-offset-key="2000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Json</span></span></span></span><span data-slate-object="text" data-key="2001"><span data-slate-leaf="true" data-offset-key="2001:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="2002"><span data-slate-leaf="true" data-offset-key="2002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="2003"><span data-slate-leaf="true" data-offset-key="2003:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="2004"><span data-slate-leaf="true" data-offset-key="2004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"time out"</span></span></span></span><span data-slate-object="text" data-key="2005"><span data-slate-leaf="true" data-offset-key="2005:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2006"><span data-slate-object="text" data-key="2007"><span data-slate-leaf="true" data-offset-key="2007:0" data-first-offset="true"><span data-slate-string="true">    c.</span></span></span><span data-slate-object="text" data-key="2008"><span data-slate-leaf="true" data-offset-key="2008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SetTimeout</span></span></span></span><span data-slate-object="text" data-key="2009"><span data-slate-leaf="true" data-offset-key="2009:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2010"><span data-slate-object="text" data-key="2011"><span data-slate-leaf="true" data-offset-key="2011:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2012"><span data-slate-object="text" data-key="2013"><span data-slate-leaf="true" data-offset-key="2013:0" data-first-offset="true"><span data-slate-string="true">  return nil</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2014"><span data-slate-object="text" data-key="2015"><span data-slate-leaf="true" data-offset-key="2015:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2016"><span data-slate-object="text" data-key="2017"><span data-slate-leaf="true" data-offset-key="2017:0" data-first-offset="true"><span data-slate-string="true">那第二个问题怎么处理，我提供一个方案。我们可以</span></span></span><span data-slate-object="text" data-key="2018"><span data-slate-leaf="true" data-offset-key="2018:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">设计一个标记</span></span></span></span><span data-slate-object="text" data-key="2019"><span data-slate-leaf="true" data-offset-key="2019:0" data-first-offset="true"><span data-slate-string="true">，当发生超时的时候，设置标记位为 true，在 Context 提供的 response 输出函数中，先读取标记位；当标记位为 true，表示已经有输出了，不需要再进行任何的 response 设置了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2020"><span data-slate-object="text" data-key="2021"><span data-slate-leaf="true" data-offset-key="2021:0" data-first-offset="true"><span data-slate-string="true">同样在框架文件夹中修改 context.go：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="2022"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2023"><span data-slate-object="text" data-key="2024"><span data-slate-leaf="true" data-offset-key="2024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="2025"><span data-slate-leaf="true" data-offset-key="2025:0" data-first-offset="true"><span data-slate-string="true"> Context </span></span></span><span data-slate-object="text" data-key="2026"><span data-slate-leaf="true" data-offset-key="2026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="2027"><span data-slate-leaf="true" data-offset-key="2027:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2028"><span data-slate-object="text" data-key="2029"><span data-slate-leaf="true" data-offset-key="2029:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2030"><span data-slate-object="text" data-key="2031"><span data-slate-leaf="true" data-offset-key="2031:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2032"><span data-slate-leaf="true" data-offset-key="2032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 是否超时标记位</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2033"><span data-slate-object="text" data-key="2034"><span data-slate-leaf="true" data-offset-key="2034:0" data-first-offset="true"><span data-slate-string="true">  hasTimeout </span></span></span><span data-slate-object="text" data-key="2035"><span data-slate-leaf="true" data-offset-key="2035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2036"><span data-slate-object="text" data-key="2037"><span data-slate-leaf="true" data-offset-key="2037:0" data-first-offset="true"><span data-slate-string="true">  ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2038"><span data-slate-object="text" data-key="2039"><span data-slate-leaf="true" data-offset-key="2039:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2040"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2041"><span data-slate-object="text" data-key="2042"><span data-slate-leaf="true" data-offset-key="2042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="2043"><span data-slate-leaf="true" data-offset-key="2043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="2044"><span data-slate-leaf="true" data-offset-key="2044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx *Context)</span></span></span></span></span><span data-slate-object="text" data-key="2045"><span data-slate-leaf="true" data-offset-key="2045:0" data-first-offset="true"><span data-slate-string="true"> SetHasTimeout() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2046"><span data-slate-object="text" data-key="2047"><span data-slate-leaf="true" data-offset-key="2047:0" data-first-offset="true"><span data-slate-string="true">  ctx.hasTimeout = </span></span></span><span data-slate-object="text" data-key="2048"><span data-slate-leaf="true" data-offset-key="2048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2049"><span data-slate-object="text" data-key="2050"><span data-slate-leaf="true" data-offset-key="2050:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2051"></div><div data-slate-type="code-line" data-slate-object="block" data-key="2052"><span data-slate-object="text" data-key="2053"><span data-slate-leaf="true" data-offset-key="2053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="2054"><span data-slate-leaf="true" data-offset-key="2054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="2055"><span data-slate-leaf="true" data-offset-key="2055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ctx *Context)</span></span></span></span></span><span data-slate-object="text" data-key="2056"><span data-slate-leaf="true" data-offset-key="2056:0" data-first-offset="true"><span data-slate-string="true"> Json(status </span></span></span><span data-slate-object="text" data-key="2057"><span data-slate-leaf="true" data-offset-key="2057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="2058"><span data-slate-leaf="true" data-offset-key="2058:0" data-first-offset="true"><span data-slate-string="true">, obj </span></span></span><span data-slate-object="text" data-key="2059"><span data-slate-leaf="true" data-offset-key="2059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="2060"><span data-slate-leaf="true" data-offset-key="2060:0" data-first-offset="true"><span data-slate-string="true">{}) </span></span></span><span data-slate-object="text" data-key="2061"><span data-slate-leaf="true" data-offset-key="2061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="2062"><span data-slate-leaf="true" data-offset-key="2062:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2063"><span data-slate-object="text" data-key="2064"><span data-slate-leaf="true" data-offset-key="2064:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2065"><span data-slate-leaf="true" data-offset-key="2065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2066"><span data-slate-leaf="true" data-offset-key="2066:0" data-first-offset="true"><span data-slate-string="true"> ctx.HasTimeout() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2067"><span data-slate-object="text" data-key="2068"><span data-slate-leaf="true" data-offset-key="2068:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2069"><span data-slate-leaf="true" data-offset-key="2069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="2070"><span data-slate-leaf="true" data-offset-key="2070:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2071"><span data-slate-leaf="true" data-offset-key="2071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2072"><span data-slate-object="text" data-key="2073"><span data-slate-leaf="true" data-offset-key="2073:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2074"><span data-slate-object="text" data-key="2075"><span data-slate-leaf="true" data-offset-key="2075:0" data-first-offset="true"><span data-slate-string="true">  ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2076"><span data-slate-object="text" data-key="2077"><span data-slate-leaf="true" data-offset-key="2077:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2078"><span data-slate-object="text" data-key="2079"><span data-slate-leaf="true" data-offset-key="2079:0" data-first-offset="true"><span data-slate-string="true">在业务文件夹中修改 controller.go：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="2080"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2081"><span data-slate-object="text" data-key="2082"><span data-slate-leaf="true" data-offset-key="2082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="2083"><span data-slate-leaf="true" data-offset-key="2083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="2084"><span data-slate-leaf="true" data-offset-key="2084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">FooControllerHandler</span></span></span></span></span><span data-slate-object="text" data-key="2085"><span data-slate-leaf="true" data-offset-key="2085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *framework.Context)</span></span></span></span></span><span data-slate-object="text" data-key="2086"><span data-slate-leaf="true" data-offset-key="2086:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2087"><span data-slate-leaf="true" data-offset-key="2087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="2088"><span data-slate-leaf="true" data-offset-key="2088:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2089"><span data-slate-object="text" data-key="2090"><span data-slate-leaf="true" data-offset-key="2090:0" data-first-offset="true"><span data-slate-string="true">  ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2091"><span data-slate-object="text" data-key="2092"><span data-slate-leaf="true" data-offset-key="2092:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2093"><span data-slate-leaf="true" data-offset-key="2093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="2094"><span data-slate-leaf="true" data-offset-key="2094:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2095"><span data-slate-object="text" data-key="2096"><span data-slate-leaf="true" data-offset-key="2096:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2097"><span data-slate-leaf="true" data-offset-key="2097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="2098"><span data-slate-leaf="true" data-offset-key="2098:0" data-first-offset="true"><span data-slate-string="true"> p := &lt;-panicChan:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2099"><span data-slate-object="text" data-key="2100"><span data-slate-leaf="true" data-offset-key="2100:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2101"><span data-slate-object="text" data-key="2102"><span data-slate-leaf="true" data-offset-key="2102:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2103"><span data-slate-leaf="true" data-offset-key="2103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="2104"><span data-slate-leaf="true" data-offset-key="2104:0" data-first-offset="true"><span data-slate-string="true"> &lt;-finish:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2105"><span data-slate-object="text" data-key="2106"><span data-slate-leaf="true" data-offset-key="2106:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="2107"><span data-slate-leaf="true" data-offset-key="2107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"finish"</span></span></span></span><span data-slate-object="text" data-key="2108"><span data-slate-leaf="true" data-offset-key="2108:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2109"><span data-slate-object="text" data-key="2110"><span data-slate-leaf="true" data-offset-key="2110:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2111"><span data-slate-leaf="true" data-offset-key="2111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="2112"><span data-slate-leaf="true" data-offset-key="2112:0" data-first-offset="true"><span data-slate-string="true"> &lt;-durationCtx.Done():</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2113"><span data-slate-object="text" data-key="2114"><span data-slate-leaf="true" data-offset-key="2114:0" data-first-offset="true"><span data-slate-string="true">    c.WriterMux().Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2115"><span data-slate-object="text" data-key="2116"><span data-slate-leaf="true" data-offset-key="2116:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2117"><span data-slate-leaf="true" data-offset-key="2117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="2118"><span data-slate-leaf="true" data-offset-key="2118:0" data-first-offset="true"><span data-slate-string="true"> c.WriterMux().Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2119"><span data-slate-object="text" data-key="2120"><span data-slate-leaf="true" data-offset-key="2120:0" data-first-offset="true"><span data-slate-string="true">    c.Json(</span></span></span><span data-slate-object="text" data-key="2121"><span data-slate-leaf="true" data-offset-key="2121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="2122"><span data-slate-leaf="true" data-offset-key="2122:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="2123"><span data-slate-leaf="true" data-offset-key="2123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"time out"</span></span></span></span><span data-slate-object="text" data-key="2124"><span data-slate-leaf="true" data-offset-key="2124:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2125"><span data-slate-object="text" data-key="2126"><span data-slate-leaf="true" data-offset-key="2126:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="2127"><span data-slate-leaf="true" data-offset-key="2127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这里记得设置标记为</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2128"><span data-slate-object="text" data-key="2129"><span data-slate-leaf="true" data-offset-key="2129:0" data-first-offset="true"><span data-slate-string="true">    c.SetHasTimeout()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2130"><span data-slate-object="text" data-key="2131"><span data-slate-leaf="true" data-offset-key="2131:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2132"><span data-slate-object="text" data-key="2133"><span data-slate-leaf="true" data-offset-key="2133:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2134"><span data-slate-leaf="true" data-offset-key="2134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="2135"><span data-slate-leaf="true" data-offset-key="2135:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2136"><span data-slate-leaf="true" data-offset-key="2136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2137"><span data-slate-object="text" data-key="2138"><span data-slate-leaf="true" data-offset-key="2138:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2139"><span data-slate-object="text" data-key="2140"><span data-slate-leaf="true" data-offset-key="2140:0" data-first-offset="true"><span data-slate-string="true">好了，到了这里，我们就完成了请求超时设置，并且考虑了边界场景。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2141"><span data-slate-object="text" data-key="2142"><span data-slate-leaf="true" data-offset-key="2142:0" data-first-offset="true"><span data-slate-string="true">剩下的验证部分，我们写一个简单的路由函数，将这个控制器路由在业务文件夹中创建一个 route.go:</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="2143"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2144"><span data-slate-object="text" data-key="2145"><span data-slate-leaf="true" data-offset-key="2145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="2146"><span data-slate-leaf="true" data-offset-key="2146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="2147"><span data-slate-leaf="true" data-offset-key="2147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">registerRouter</span></span></span></span></span><span data-slate-object="text" data-key="2148"><span data-slate-leaf="true" data-offset-key="2148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(core *framework.Core)</span></span></span></span></span><span data-slate-object="text" data-key="2149"><span data-slate-leaf="true" data-offset-key="2149:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2150"><span data-slate-object="text" data-key="2151"><span data-slate-leaf="true" data-offset-key="2151:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2152"><span data-slate-leaf="true" data-offset-key="2152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置控制器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2153"><span data-slate-object="text" data-key="2154"><span data-slate-leaf="true" data-offset-key="2154:0" data-first-offset="true"><span data-slate-string="true">   core.Get(</span></span></span><span data-slate-object="text" data-key="2155"><span data-slate-leaf="true" data-offset-key="2155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo"</span></span></span></span><span data-slate-object="text" data-key="2156"><span data-slate-leaf="true" data-offset-key="2156:0" data-first-offset="true"><span data-slate-string="true">, FooControllerHandler)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2157"><span data-slate-object="text" data-key="2158"><span data-slate-leaf="true" data-offset-key="2158:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2159"><span data-slate-object="text" data-key="2160"><span data-slate-leaf="true" data-offset-key="2160:0" data-first-offset="true"><span data-slate-string="true">并修改 main.go：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="2161"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2162"><span data-slate-object="text" data-key="2163"><span data-slate-leaf="true" data-offset-key="2163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="2164"><span data-slate-leaf="true" data-offset-key="2164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="2165"><span data-slate-leaf="true" data-offset-key="2165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="2166"><span data-slate-leaf="true" data-offset-key="2166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="2167"><span data-slate-leaf="true" data-offset-key="2167:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2168"><span data-slate-object="text" data-key="2169"><span data-slate-leaf="true" data-offset-key="2169:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2170"><span data-slate-object="text" data-key="2171"><span data-slate-leaf="true" data-offset-key="2171:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="2172"><span data-slate-leaf="true" data-offset-key="2172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置路由</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2173"><span data-slate-object="text" data-key="2174"><span data-slate-leaf="true" data-offset-key="2174:0" data-first-offset="true"><span data-slate-string="true">   registerRouter(core)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2175"><span data-slate-object="text" data-key="2176"><span data-slate-leaf="true" data-offset-key="2176:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2177"><span data-slate-object="text" data-key="2178"><span data-slate-leaf="true" data-offset-key="2178:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2179"><span data-slate-object="text" data-key="2180"><span data-slate-leaf="true" data-offset-key="2180:0" data-first-offset="true"><span data-slate-string="true">就可以运行了。完整代码照旧放在 GitHub 的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="2181"><span data-slate-object="text" data-key="2182"><span data-slate-leaf="true" data-offset-key="2182:0" data-first-offset="true"><span data-slate-string="true">geekbang/02 分支</span></span></span></a><span data-slate-object="text" data-key="2183"><span data-slate-leaf="true" data-offset-key="2183:0" data-first-offset="true"><span data-slate-string="true">上了。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2184"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/72/e4/7277357c506bc95b9155d6a35cdee3e4.png?wh=714x656" style="width: auto;"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2185" id="sr-toc-6"><span data-slate-object="text" data-key="2186"><span data-slate-leaf="true" data-offset-key="2186:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2187"><span data-slate-object="text" data-key="2188"><span data-slate-leaf="true" data-offset-key="2188:0" data-first-offset="true"><span data-slate-string="true">今天，我们定义了一个属于自己框架的 Context，它有两个功能：在各个 Goroutine 间传递数据；控制各个 Goroutine，也就是是超时控制。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2189"><span data-slate-object="text" data-key="2190"><span data-slate-leaf="true" data-offset-key="2190:0" data-first-offset="true"><span data-slate-string="true">这个自定义 Context 结构封装了 net/http 标准库主逻辑流程产生的 Context，与主逻辑流程完美对接。它除了实现了标准库的 Context 接口，还封装了 request 和 response 的请求。你实现好了 Context 之后，就会发现它跟百宝箱一样，在处理具体的业务逻辑的时候，如果需要获取参数、设置返回值等，都可以通过 Context 获取。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2191"><span data-slate-object="text" data-key="2192"><span data-slate-leaf="true" data-offset-key="2192:0" data-first-offset="true"><span data-slate-string="true">封装后，我们通过三步走为请求设置超时，并且完美地考虑了各种边界场景。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2193"><span data-slate-object="text" data-key="2194"><span data-slate-leaf="true" data-offset-key="2194:0" data-first-offset="true"><span data-slate-string="true">你是不是觉得我们这一路要思考的点太多了，又是异常，又是边界场景。但是这里我要特别说明，其实真正要衡量框架的优劣，要看什么？就是看细节。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2195"><span data-slate-object="text" data-key="2196"><span data-slate-leaf="true" data-offset-key="2196:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">所有框架的基本原理和基本思路都差不多，但是在细节方面，各个框架思考的程度是不一样的，才导致使用感天差地别</span></span></span></span><span data-slate-object="text" data-key="2197"><span data-slate-leaf="true" data-offset-key="2197:0" data-first-offset="true"><span data-slate-string="true">。所以如果你想完成一个真正生产能用得上的框架，这些边界场景、异常分支，都要充分考虑清楚。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2198" id="sr-toc-7"><span data-slate-object="text" data-key="2199"><span data-slate-leaf="true" data-offset-key="2199:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2200"><span data-slate-object="text" data-key="2201"><span data-slate-leaf="true" data-offset-key="2201:0" data-first-offset="true"><span data-slate-string="true">在 context 库的官方文档中有这么一句话：</span></span></span></div><div data-slate-type="block-quote" data-slate-object="block" data-key="2202"><div data-slate-type="quote-line" data-slate-object="block" data-key="2203"><span data-slate-object="text" data-key="2204"><span data-slate-leaf="true" data-offset-key="2204:0" data-first-offset="true"><span data-slate-string="true">Do not store Contexts inside a struct type;</span></span></span></div><div data-slate-type="quote-line" data-slate-object="block" data-key="2205"><span data-slate-object="text" data-key="2206"><span data-slate-leaf="true" data-offset-key="2206:0" data-first-offset="true"><span data-slate-string="true">instead, pass a Context explicitly to each function that needs it.</span></span></span></div><div data-slate-type="quote-line" data-slate-object="block" data-key="2207"><span data-slate-object="text" data-key="2208"><span data-slate-leaf="true" data-offset-key="2208:0" data-first-offset="true"><span data-slate-string="true">The Context should be the first parameter.</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2209"><span data-slate-object="text" data-key="2210"><span data-slate-leaf="true" data-offset-key="2210:0" data-first-offset="true"><span data-slate-string="true">大意是说建议我们设计函数的时候，将 Context 作为函数的第一个参数。你能理解官方为什么如此建议，有哪些好处？可以结合你的工作经验，说说自己的看法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2211"><span data-slate-object="text" data-key="2212"><span data-slate-leaf="true" data-offset-key="2212:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区分享你的思考，畅所欲言。如果你觉得今天的内容有所帮助，也欢迎你分享给你身边的朋友，邀他一起学习。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>27</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-8">精选留言 (31)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>qinsi</span></div><span>置顶</span></div><div>“context 作为函数的第一个参数” 大概有两层意思。一是作为函数的参数传入。这个应该是针对在一个 struct 的多个方法中共享一个 context 的情况说的。因为每个方法都有可能需要创建子 context，所以不应该共享而是应该显式传递。二是作为第一个参数。这个多半是一种约定。在支持可变长参数的语言中，固定参数只能出现在可变参数的前面。而作为与业务逻辑关系不大的 context，出现在第一个的位置也方便也其他参数作区分。

说到与业务逻辑关系不大，个人以为显式传递 context 是对业务逻辑的侵入，更别提单元测试的时候还需要适当地 mock 掉。目前代码里请求控制和请求实现混在一起的情况后面应该会改掉吧？</div><div><p>作者回复: context 作为第一个参数在实际工作中是非常有用的一个实践。不管我们是设计一个函数，或者设计一个结构体的方法，或者服务的时候，我们一旦养成了将第一个参数作为 context 的习惯，那么这个 context 在相互调用的时候，就会传递下去。这里会带来几个好处：

1 链路通用内容传递。context 中是可以通过 WithValue 方法将某些字段封装在 context 里面，并且传递的。最常见的字段是 traceId, spanId。而在日志中带上这些 ID，再将日志收集起来，我们就能进行分析了。这也是我们现在比较流行的全链路分析的原理。

2 链路统一设置超时。我们在定义一个服务的时候，将第一个参数固定设置为 context，则可以通过这个 context 进行超时设置，而这个超时设置，是由上游调用方进行设置，这样就形成了一个统一的超时设置机制。比如 A 设置了 5s 超时，自己使用了 1s，传递到下游 B 服务的时候，设置 B 的 context 超时时长为 4s。这样全链路超时传递下去，就能保持统一设置了。

是的，请求控制和请求实现混在一起的情况，后面引入 middleware 会改掉的。</p></div><div><div>2021-09-15</div><div><div><i></i><span></span></div><div><i></i><span>20</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/c3/3f/d96c1b97.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>zhao</span></div></div><div>代码里面 context 的封装跟 gin 的源代码真是像极了，对照来看，对框架的理解又加深了一些。</div><div><p>作者回复：你好，是的 context 的封装和 gin 的代码很像，本质就是通过自己开发对开源的 gin 会有进一步理解。</p></div><div><div>2021-09-17</div><div><div><i></i><span>2</span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/af/fd/a1708649.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> ゝ骑着小车去兜风。</span></div></div><div>老师这个课程真的全是干货，感觉看了前两章都已经值回票价了</div><div><div>2022-02-23</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_cbab11</span></div></div><div>异常事件、超时事件触发时，需要往 responseWriter 中写入信息，这个时候如果有其他 Goroutine 也要操作 responseWriter，会不会导致 responseWriter 中的信息出现乱序？
超时事件触发结束之后，已经往 responseWriter 中写入信息了，这个时候如果有其他 Goroutine 也要操作 responseWriter， 会不会导致 responseWriter 中的信息重复写入？

问题 1：这两个问题说的其他 goroutine 是哪些 goroutine？
问题 2：为什么 controller 中的 goroutine 没有进行 Lock 操作？
问题 3：在 Unlock 之前已经进行了调用了 Write 方法，难道此次请求还没有结束吗？如果结束了为什么还允许继续写入呢？

还望老师解答一下。感谢！</div><div><div>2022-02-08</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/65/df/11406608.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 轻剑切重剑</span></div></div><div>老师好，请教下，为什么在超时之后 case &lt;-durationCtx.Done ()，不添加 c.Abort () ？</div><div><div>2022-05-08</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/21/41/37/b89f3d67.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 我在睡觉</span></div></div><div>你好老师，这个代码运行之后，一次 HTTP 请求过来，ServeHTTP 函数会被调用两次，请问是为什么？
</div><div><p>作者回复：有例子么？一个请求应该只会运行一次的，有更多信息没</p></div><div><div>2021-11-26</div><div><div><i></i><span>4</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/30/3c/0668d6ae.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 盘胧</span></div></div><div>return rdb.Set (ctx, "key", "value", 0).Err ()  老师 这个方法报错了欸：
源码： func (c *cmdable) Set (key string, value interface {}, expiration time.Duration) *StatusCmd {...}
好像多了一个参数啊</div><div><div>2021-10-25</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/57/2a/3369dbfe.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Nio</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>不错不错 有深度</div><div><div>2021-09-26</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>2345</span></div></div><div>文章写得很好，赞一个，比较有深度</div><div><p>作者回复：感谢支持，欢迎继续参与。</p></div><div><div>2021-09-22</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>0mfg</span></div></div><div>叶老师您好，把分支 2 git 下来尝试运行，报错如下，求指教，谢谢
# command-line-arguments
.\main.go:10:2: undefined: registerRouter
</div><div><p>作者回复: https://github.com/gohade/coredemo/blob/geekbang/02/route.go 确认下你的目录下有 route.go 文件么</p></div><div><div>2021-09-22</div><div><div><i></i><span>11</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Qn1PDx7xA7jKFZr4vHibmsvoZ7bwUCzHTg3uywiaESCgFTTMibPpKdZOfrqTXtdQXxUJqFqmLAj5NoIFMJpYibbcOQ/132"></div></div><div><div><div><span>happy learn</span></div></div><div>到底是一个请求一个 goroutine 还是一个连接一个 goroutine，前后两篇文章说的不一致</div><div><p>作者回复: 01 梳理思维导图的时候说，接受一个新的请求连接时，会创建一个新结构，开启一个 goroutine 来服务。所以这两种说法其实是一致的</p></div><div><div>2021-09-21</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/f1/39/b0960780.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 恶魔果实</span></div></div><div>为什么会导致服务 b 和服务 c 的瞬时请求加大？这里不是很理解。
a 请求失败，但是 b，c 请求是成功的呀。</div><div><p>作者回复：这个例子举的确实不好。我的本意是如果 a 请求失败，整个上游可能有重试机制，导致其他的请求连接增加。

我这里可能换一个方式举例更好，下游超时导致上游连接数增加。已经联系编辑进行更新了。

谢谢提醒。</p></div><div><div>2021-09-18</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2a/39/93/bcafe00f.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 静且慢且远</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/8a/95/8ac15yy848f71919ef784a1c9065e495.png"></div></span></div></div><div>真的很好，我读了四遍，才读懂老师代码的强大。</div><div><p>作者回复：感谢</p></div><div><div>2022-06-29</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/99U6LEL8nPN8VjibdSDTp5xTqwwHOSKmOvpBo4J8wvsjbHwYhHJGlmnIgNAt3EnIs1VPZVvQ0QxPwmogKD1XbMw/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_0a631a</span></div></div><div>老师，我有点疑惑，既然我们是想实现更好的 context，为什么现有的 context 要包装 request 和 responseWriter 呢？</div><div><div>2022-05-16</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/c4/91/a017bf72.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>coconut</span></div></div><div>context 不能设计成 “全局的协程私有数据” 吗？这样就不用作为第一个参数显式传递了。

我最近在看 python 的 flask 框架，它似乎就是这么干的。</div><div><div>2022-04-06</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/ed/0a/18201290.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Juniper</span></div></div><div>
// #region application/json post

func (ctx *Context) BindJson (obj interface {}) error {
	if ctx.request != nil {
		body, err := ioutil.ReadAll (ctx.request.Body)
		if err != nil {
			return err
		}
		ctx.request.Body = ioutil.NopCloser (bytes.NewBuffer (body))

		err = json.Unmarshal (body, obj)
		if err != nil {
			return err
		}
	} else {
		return errors.New ("ctx.request empty")
	}
	return nil
}

// #endregion

这段代码中 ctx.request.Body = ioutil.NopCloser (bytes.NewBuffer (body)) 这行干嘛用的。ctx.request.Body 本身就是个 io.ReadCloser 类型，为什么读取了值之后，又重新赋值了</div><div><div>2022-02-07</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/25/65/f04c6cfa.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>yesterday</span></div></div><div>设置路由的函数名为什么是 core.Get 不是 core.Set 啊，
这一步不是给 c.route 这个 map 添加新值吗。</div><div><div>2022-01-25</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>helloworld</span></div></div><div>在发出取消信号的时候，是不是所有子 goroutine 中都得有监听 ctx.Done () 并主动结束 goroutine 的代码逻辑，才能让所有 gourutine 都结束，还是说，不需要这样的逻辑所有就可以实现呢</div><div><p>作者回复：是需要有的，如果你的子 goroutine 没有监听 ctx.Done 主动结束自己的逻辑，是无法主动停止的</p></div><div><div>2021-11-24</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_260922</span></div></div><div>framework\core.go 里的
func (c *Core) Get (url string, handler ControllerHandler) {
	c.router [url] = handler
}
方法名是不是改为 SET 更为贴切。</div><div><div>2021-11-06</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/6b/23/ddad5282.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Aaron</span></div></div><div>我在写的时候， 有一点不明白，想老师解答一下。
这个 QueryAll 方法：
func (ctx *Context) QueryAll () map [string][] string {
	if ctx.request != nil {
		return map [string][] string (ctx.request.URL.Query ()) // 就是这里不明白， 为什么返回是【map [string][] string (ctx.request.URL.Query ())】 这个写法，这个写法不太明白。我返回的时候，直接返回【c.Request.URL.Query ()】， 我试过了， 效果应该是一样的。
	}
	return map [string][] string {}
}









</div><div><div>2021-10-28</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".7"><outline class="toc-level-h1" data-reactid=".7.0" style="width: 175px;"><active data-reactid=".7.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".7.0.1"><span data-reactid=".7.0.1.0"> 02｜Context：请求控制器，让每个请求都在掌控之中</span></a></outline><outline class="toc-level-h2" data-reactid=".7.1" style="width: 165px;"><active data-reactid=".7.1.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".7.1.1"><span data-reactid=".7.1.1.0">context 标准库设计思路</span></a></outline><outline class="toc-level-h2" data-reactid=".7.2" style="width: 165px;"><active data-reactid=".7.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".7.2.1"><span data-reactid=".7.2.1.0">Context 是怎么产生的</span></a></outline><outline class="toc-level-h2" data-reactid=".7.3" style="width: 165px;"><active data-reactid=".7.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".7.3.1"><span data-reactid=".7.3.1.0">封装一个自己的 Context</span></a></outline><outline class="toc-level-h2" data-reactid=".7.4" style="width: 165px;"><active data-reactid=".7.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".7.4.1"><span data-reactid=".7.4.1.0">为单个请求设置超时</span></a></outline><outline class="toc-level-h2" data-reactid=".7.5" style="width: 165px;"><active data-reactid=".7.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".7.5.1"><span data-reactid=".7.5.1.0">边界场景</span></a></outline><outline class="toc-level-h2" data-reactid=".7.6" style="width: 165px;"><active data-reactid=".7.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".7.6.1"><span data-reactid=".7.6.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".7.7" style="width: 165px;"><active data-reactid=".7.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".7.7.1"><span data-reactid=".7.7.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".7.8" style="width: 165px;"><active data-reactid=".7.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".7.8.1"><span data-reactid=".7.8.1.0">精选留言 (31)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/418283" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>