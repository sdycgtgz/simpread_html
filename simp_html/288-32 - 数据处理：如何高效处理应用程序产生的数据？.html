
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAMAAAANIilAAAAA7VBMVEUAAAD///8ZGRnw8PBWVlb4+PgeHh719fVEREQlJSUODg6Ojo7Ly8v9/f1NTU2VlZUFBQV6enrCwsLy8vLh4eE0NDQLCwu8vLyXl5dxcXHa2trAwMCFhYVDQ0OysrKampo7OzssLCwICAioqKjJyckhISHu7u4/Pz9TU1NQUFBLS0tAQED6+vrS0tKRkZFISEgvLy+goKB+fn5vb29nZ2fm5uYbGxvk5OTX19d2dnZaWlre3t5hYWEyMjK5ubkoKCgVFRXQ0NDMzMzFxcW0tLSsrKykpKSMjIzq6urU1NSAgICvr6+cnJyHh4dsbGyfc25QAAAFkElEQVRIx4WXB3faMBCA74wHxgMMGAOh1MyyVyBAmtVmd/3/n1OdDtWstt/Li5JD35MtnU4CMnCIlkLEOpSKuMPhuI4FE444L9+dyv3zciad/rAjfU/yOPpGcjWS1NKSGsk29WTSD1IeYsIPkvsAJF+C5BIZkieYMNjJnsF4+JHk61wOSlVDyOIPqKBgZIxYTrqy/AmNtC1ps7yqlgE6dgYa1WqD5aV9SbKDbe6ZNnCq5A5ILlhGjEASIoawJdmHHo98AZLOnmxzKM9yK9Aht63FoAWBBmEgsEHnkfMgsZU8PJbpbXJd3MIep/Lg/MjbRqMRRuNtQ4Tthga5RiNzfmSWD97ZExQ64HhtgLb3CmbBGyj54vixjyeMsKjnV4AvOAHTwsHphKnH9toXki7Li3jLsgswizskv+c3PHKXe7ZHu5E/YMKcM2yqZIJkAclZTPClbJezivI1yTr4f+TeMib5qXxHsr7XtUFJDIc8pLAHA7Su4JXkd8ySnKZddQXH2NohswIutRu0Qu0jyS46JPugU+gISB1R8NBKWegVUsahTKEjAP9Bm5bKAc3DPlzjKaDvscE7PeEJu63WUg9a82tdA1O/ESupL9Cr6C1cXetjIe9zgQ4kvKLgHi6xC5LcGq9hhmiK0AYgUvLQtzm3n/x0jnum/Vo9j1jxg/pL3/f9W8isMOsv6/Ubf47rvl+u17nnZ1xQ+4iIXa6IpRVeimEEE3pnxO8kIz4CbFDyidVSpooBCCLLsj5noFlqUg2rwK0l+Anmm+VhCzKfrRHtqjGOLANxUKIUiYvFEcuaaZpXANniD5ZzpiBDTSRkuDJfWM6awxGuikUArp7fIOE7RlB6OygGTyhfsMyrtwDNIAkcp1YRhKC9Oh2IHUFQ6UPupnLL3icODaD5zVlUto7zhm1n7kmZ5kDSQBxykfZhD66eaQBoWriEGPcA182C4Crst90Z9NwvHgahDTALw/Ae4D500Pjq3oj/4sjtwcwVrCkkgB01HB8cdM0iIlWSr6IpNqFO+1mDHQFWORtO5EIi08b4jxy6giBsgKDnRnEYYdd9nIYvaLmuhS/h9DF5bEFr/7HTKAjUqWY1oUUBKgYEZdgIP6gJE2xQIWVvLhZBcAWx843kz87PDDi4cgR92s8/1FLpAGNeKiUbGtRQEIPkGb9TM1EF8MpCVEni7pIkkUdDs1ZcI/ZUer6YZg4WxTtqMmYsZJWebbOzEekZV4sCKaNhBaXQQ0NtjL71ZooNE1vWLfyyyFUbw7MsD0fWOFMSqAnbwj1Kuk0Aqp4aJ91MZhhvyS7+oQoMy5v63Jfoz/UYfPSiep2KQb5e4/gt1Ycdc7Se6jNyVbpuQNI08FrICQ6ccKnSXddrKCnqkqWFupJFAewKudSTBVAyBEjrLSXjCYnc5rrdQVl6VaiKqOTToi/kaSrlcW5fpGpgrlJTLvoGVxKDOg7PHzc6NLXOmuUHTZQhTWvS4T7T5ixPqGPz/EHXp/azkMeQoGOqBBOSq1gD4vwRe1culz8W8HlZKQt6Sjbm5XeS9eWizJw73HcsOW8mSpa0eT8zfK1w85LdtWKTf5dWfCPzMg5J+MBdsvvy6Q2QD/d91sfzouRz9zAdBp6HCcUzskccyBdKzjTC9ZE8HT8+JHLxtiE4d33Ud0uleOObvpXZk4E4/9h2sKD9t6oxgaCFxs9AHiI3wYJCndMbIMs9lLi7vEHFLxAUURyciOnTyzrLH6qSJwo+8CWuQIFL2wSoVyvQea/qtk2yvPtb4mekZMhJQkPwyvIzBbJGJD+jX3eGcfIFhWVmxsVAG5FMgSzm9y4wKL8aJdzvyctoTqEgep6K5lckWGM3uuuA5DadFvIhiTzBL1xzVtT0UDEDxd9ldeutcJLoyvUaoPgNdiqckZLamd0AAAAASUVORK5CYII=")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,R0lGODlhMAAwAPcAAAAAABMTExUVFRsbGx0dHSYmJikpKS8vLzAwMDc3Nz4+PkJCQkRERElJSVBQUFdXV1hYWFxcXGNjY2RkZGhoaGxsbHFxcXZ2dnl5eX9/f4GBgYaGhoiIiI6OjpKSkpaWlpubm56enqKioqWlpampqa6urrCwsLe3t7q6ur6+vsHBwcfHx8vLy8zMzNLS0tXV1dnZ2dzc3OHh4eXl5erq6u7u7vLy8vf39/n5+f///wEBAQQEBA4ODhkZGSEhIS0tLTk5OUNDQ0pKSk1NTV9fX2lpaXBwcHd3d35+foKCgoSEhIuLi4yMjJGRkZWVlZ2dnaSkpKysrLOzs7u7u7y8vMPDw8bGxsnJydvb293d3eLi4ubm5uvr6+zs7Pb29gYGBg8PDyAgICcnJzU1NTs7O0ZGRkxMTFRUVFpaWmFhYWVlZWtra21tbXNzc3V1dXh4eIeHh4qKipCQkJSUlJiYmJycnKampqqqqrW1tcTExMrKys7OztPT09fX19jY2Ojo6PPz8/r6+hwcHCUlJTQ0NDg4OEFBQU9PT11dXWBgYGZmZm9vb3Jycnp6en19fYCAgIWFhaurq8DAwMjIyM3NzdHR0dTU1ODg4OTk5Onp6fDw8PX19fv7+xgYGB8fHz8/P0VFRVZWVl5eXmpqanR0dImJiaCgoKenp6+vr9/f3+fn5+3t7fHx8QUFBQgICBYWFioqKlVVVWJiYo+Pj5eXl6ioqLa2trm5udbW1vT09C4uLkdHR1FRUVtbW3x8fJmZmcXFxc/Pz42Njb+/v+/v7/j4+EtLS5qamri4uL29vdDQ0N7e3jIyMpOTk6Ojo7GxscLCwisrK1NTU1lZWW5ubkhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/i1NYWRlIGJ5IEtyYXNpbWlyYSBOZWpjaGV2YSAod3d3LmxvYWRpbmZvLm5ldCkAIfkEAAoA/wAsAAAAADAAMAAABv/AnHBILBqPyKRySXyNSC+mdFqEAAARqpaIux0dVwduq2VJLN7iI3ys0cZkosogIJSKODBAXLzJYjJpcTkuCAIBDTRceg5GNDGAcIM5GwKWHkWMkjk2kDI1k0MzCwEBCTBEeg9cM5AzoUQjAwECF5KaQzWQMYKwNhClBStDjEM4fzGKZCxRRioFpRA2OXlsQrqAvUM300gsCgofr0UWhwMjQhgHBxhjfpCgeDMtLtpCOBYG+g4lvS8JAQZoEHKjRg042GZsylHjBYuHMY7gyHBAn4EDE1ZI8tCAhL1tNLoJsQGDxYoVEJHcOPHAooEEGSLmKKjlWIuHKF/ES0IjxAL/lwxCfFRCwwVKlC4UTomxIYFFaVtKomzBi8yKCetMkKnxEIZIMjdKdBi6ZIYyWAthSZGUVu0RGRsyyJ07V0SoGC3yutCrN40KcIADK6hAlgmLE4hNIF58QlmKBYIDV2g75bBixouVydCAAUOGzp87h6AsBQa9vfTy0uuFA86Y1m5jyyaDQwUJ0kpexMC95AWHBw9YkJlBYoSKs1RmhJDgoIGDDIWN1BZBvUSLr0psmKDgoLuDCSZ4G4FhgrqIESZeFMbBAsOD7g0ifJBxT7wkGyxImB+Bgr7EEA8418ADGrhARAodtKCEDNYRQYNt+wl3RAfNOWBBCr3MkMEEFZxg3YwkLXjQQQg7URPDCSNQN8wRMEggwQjICUECBRNQoIIQKYAAQgpCvOABBx2ksNANLpRQQolFuCBTETBYQOMHaYxwwQV2UVMCkPO1MY4WN3wwwQQWNJPDCJ2hI4QMH3TQQXixsVDBlyNIIiUGZuKopgdihmLDBjVisOWYGFxQJ0MhADkCdnGcQCMFHsZyAQZVDhEikCtOIsMFNXKAHZmQ9kFCBxyAEGNUmFYgIREiTDmoEDCICMKfccQAgghpiRDoqtSkcAKsk7RlK51IiAcLCZ2RMJsWRbkw6rHMFhEEACH5BAAKAP8ALAAAAAAwADAAAAf/gDmCg4SFhoeIiYqLhFhRUViMkpOFEwICE5SahDg4hjgSAQJEh16em4ctRklehkQBAaSFXhMPVaiFVwoGPyeFOK+xp4MkOzoCVLiDL7sGEF2cwbKDW0A6Oj0tyoNOBt5PhUQCwoRL1zpI29QO3gxZhNLDLz7XP1rqg1E/3kmDwLDTcBS5tgMcPkG0vCW4MkjaICoBrgmxgcrFO0NWEnib0OofORtDrvGYcqhTIhcOHIjgYgiJtx9RcuBQEiSIEkFPjOnIZMiGFi3DCiVRQFTClFaDsDDg1UQQDhs2kB4x1uPFrC1ZsrL8tCQIUQVBMLgY9uSBFKSGvEABwoSQFy5Z/7NqgVZqygSvRIU0uSeTrqIuSHF00RI3yxa0iLqIePBVwYMoQSX5LKyF4qQsTIR8NYJYEla5XSIzwnHFSBAGtzZ5IcylsyYvJ564lmz5oO3buAttabKEie/fS5bE3LYFi/Hjx7MgtZKyefMhQzCIpvTiipUr2LNjp8vcuXck0ydVt649O90tTIIrUbKEfXsS4T0jn6+ck0x/8XPr34/Dyon8iRimDhZOFFGBC6hwMcUULfhFCRckGFHEBEUwAeAvLUhxwglUYDFbXRgUMeEEGExxYSFaULHhhlUApQgOLSwh4gQTGCECXyYtMowNL6i44hVcTIcDCRXQOEEFTVg1SPAVT0SSyBZVKClIFy1MIYWGUzhpyBM0FpGEFYhxscQRSKTmiTwkiCBFbTJt4d+GCB6CxRFHROGgTFLQiYQ2OVxBAgkM5ZAFFCKIECgnWVBBBZuFvMBXIVkkcQQGIpwiRXBSOFVFoSRsVYgNd0qCwxMYHJHERTlcykSmgkBYaBUnStICEhhgIMUwly7BqiBXFAoFqurY0ASdS3iaam+75mCDFIWe8KEmVJSKQWqD5JpsDi8QCoWUymwxJgZOMGrtL1QUaqc6WShBJreCjItimlEYi4sWUNxqiLu5WCHvNtPhu98iJ/hG0r+MdGFcqAQTHAgAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDALHjxZGEqcWNCNAQNvKGokGCjQQTYX2Ry84XHjQT4a5JQk2CakwRtu1OQxWXCPAwVlqhQMBNJAm5UCoxAIcEAnTYF+bipYU4NjSwNsgP5pEIAon6MD6yjYeqdgzzYF5QgIIAAO1oF/0mxFI4NgT5ED/YypuqDtWYFSFmyVMzDQ06gCA7kZO8DO3YGA2mw1c1Xg24FVxIxFA8hkH7sF9TTY+uZGDr8XweYAhKaqGCoH96BG2CeNmihNOTLZugCFQCYOHDARaGcAWdEEZ2QYIMCoQTlmcrep4nlgljM4RQQGBKi5Bt9j+hAEVAcBgO9ngAb/pnMmt4MzcLQPtMOmiviBN6KU4RuYSoMv3wF8UdN8ZxU35jkQAR0zCHRDZQvVUFIfaoCRHwBk3PEeQTVEoUaAa+AxYUI3xEHAg2HE8cdEM8yBRm5mZNCfRDWQkR8Ya6inEUoOoKGHSXZ88UUDVGzI0A0oSGgSIG/UseJhG/k4kZJIolUHHXQ8CeWUGmIFyB9YZvlHDVuWpMcaa6ihRphgihkHkwr9kcWabLbZ3B5hihnnmGowgWZCM7SpZxYIzkDHHHP8CeigUpzFpZaIirfSnU026ihHexi30QyxHZVFHW9k4IdJNeyhhx8IalSDFHC8YWodjA7Uhx6s7iEDozdU/8HEG26YGoekE/3hKat68FGgQoHwMYeptGogxYiBaXRDFp7mwSqoCAUiRQbEZiBCRAPtIQW2CP2hB2aj+cErq+ASZAexcuwBVA11MJFuXytlgQIezBX0x6qscltQFnDEQUWoA1HBhLvq8YECCurNMC8Km+40wx57HNnQrwXJMMfAUngUSBUiiGBUIHs8REWl2wG8pBRMxDEHZhx7XFINVOCBgrpN9iHHwJK2LGkfD6FA8Vk32DFwHSTrTNANMeOhR6oJ6THwuwQZ3VDP+tL0Bx0D33Gk1H3p8VAVJm8kA9ZyVJ0DFR3jmoPCUox81x94rFYQx3WonYMffIR91IRcPxHKUB522DGT3xIBsqbehCceEAAh+QQACgD/ACwAAAAAMAAwAAAI/wBzCBxIsKDBgwgTKlxI8BIVSZcYSpxIkNMjBQo4UNxYkNNBRxgfHdzkkeNBLB3qlBzIqRFGRwY5OVpEyWRBS4kcPJjU0aUCmAXxIDCggKdNgVkQOXDgSFNFn0AHdkFjgKilowOhLHUgpaBPkQTrVDUwB+vATIuWrsHE8itBLAyqOmBrViCVpYfqEITK8lHVH13rCtz0aCmiqzlahhy4olBVRU45YqFbsBKapZA8KlYAdtOaqoRWHKwkaWVBLG7c4IlMcI6DQw8kCQSxaI0IgSV+VI06EBOHHz9EHwShqDikSaYvKYIdSSAnkiU76GaAheAmKIYECAigyLRzKGuKK/9aMwfLyhKOkCPcJOWBXueS0AgKEECAIEbenU+CFL44IyiZOLcJQ5oMmAMWjAxCn3YMSGEgQprg0Yh4azQyRX4KceIBIdvVR4gHAUqECRSMiNcBhgl1IUSHgzBSHUeWeLAGTSZFIoggaKyAIkObSCLFjgkRJgJrghVpJEeaJaakaV1EIgIUUD4JhQgiUIFVS4dspaUDaCBWSSNugNnImGG6AQKQCnWBgA5stulmczl8KWaYYjZy5lFquqmnDnA2KSWUU05p5VFY4rVllxkeyUlJSaJ5ZF2cWEKJowcVaBYmUngwRxYmbXLJJZk8SJEmVMzBQQcclEApQZlk4eolXVD/tMkkdXRgqwd11MSRJp++egmRCGURiQeocjCHJLEmtqpzXVziahagiloQFR5wcKoHUkQ0EBZUUFbpZBVh8iy0yRqEx6kdQIHYQJpIIUIk6yopECaUTFKJtJuI62q5BWECAgiTAJsDJYBymkMWK6xgcBf1UqJtRbxesiOoB2XipAilCUQJHnjoeuAk9krr3LIsSUJlJCHGybHHmtQ7yYtFXjKlCB6r3HFDIFPCL1ab4EGlFERujEcl1lUCcrxYWRIo0pWs3C/Ik3hrUxclUHlhZU5XhEW995qVSdWRPDyQ0EQX1AXIlQjMUSYrGFUQ2Qc5KzKho3Fc9qMTNY0H0ngrCrRJJqH2LXhCAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSFBVlTyqGEqcSJBTBwdmPFDcWJDTwVIOHHQ4yMkjx4Op6pwySXBDyFIGvZTS8OJkQRikFFXY0xGkA5gFpxj6ZIaPzYGXcioqxaqiS5EFVyn6ZCgUjKMDTShSNGpKQZ9AB5r6RLYO1oGrNGx1FFEgJ58jB6ZyQFYRjbMDq4zaGokgSDMdTFokC8orXoFePGy1cDUHp6dxc7BoQPZNU46p2hZ8YWHrBy8C4SK2QLYBT4MvWLAsmGpDqRSXB3IytXcUC4GR3rzpm8OEoaEaC9L4QPb2wVO633jYs1rVG50m3HopKbAOqE+hUhFkhcqBge8VVrv/NeEouSNTqVie6MBHvOwqFXg7zqPowHcDCRy5d8znQ/I3GqByl2OgLTSdQKloUMh9BoRyQoEIsVJFB/+Vksd+CXFShyEMGlLHKhPRYIIGydWBIUKriHJfAhpoh5kpjtB0EioHHKCIakd5sceFJ7HSASoQHibkkBx5ZKRjSKJ1gglLMumkCcbZ5MUGolRppZWKNAZDBx2UUkqXXX4ZyYkLsQJKAGimKQCaAqAi0JZfesllmPKdtIoha66ZJptu5rDKFCYw2WSgJ+SB1WNXJpqlQmRuZOSjbhEpqUGcpFJTj2/UEdtJNFRxyimaUWTKF1+YkUKjBrGyRySmtJoCR6t8/wLArAGMcilDXrxgwimtnmLCrRPJ5Mmss3pSyoAIcXLJFLzyGgkLsaFK0AuK8EAsAIVEEiRBe/DaaxXI5pAKC+HGpEq0KTTwBbFfKLKtQFX0ekJ626VwwhQupnpJKpesxkodBxAbyn40oIIKH+++cMK9bV3ywgttsZLKxCAWdIkGnXRSRUI0VCycvSeclgMMeeSRryoTX/JuDnucehILC6fg8bgsNJaDF/umUu5ZqgB6gs0js1AzQaukvPJJXuSxcBWbwsCCyRXtC4Mq0i6UysInXHKT0PkKVPTEm9rEir1Qiud0HkALhDK/VaNYhQlT7Oz00AVJzO/RFK3CR9pvPhndNVo0tG0TyXRPKhHNfxue4Sqr4K244QEBACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwBgsWNBhKnFjwiRo1pihqLMjpIK2LdA7m6rjxoJYRJkgS/KgmZMFctGZhKVkwy4Y3jnBxZOmS4IpYh2TppClwxs03dDQV/Eihp8BVRxw4UKOF6MAUb7KuIMiJliw1TwqikuqgltWBmjxknRVRYFeQBLXIknpk1dmBlBxlNbHyYtiBtKTGUnF3ICdTR45oyAL4a08XaKRuyFVyRtuaGrI+6fgWrMBcGqRGGFoQF6WEM2jRWUFZbFZHp3OYWLKEb44UQB04FUiDjlQXCG3RnjUCl8ocNJbgJJyDk/OBtWI5oFB1YC4TsgwpULABYQoPS2aF/0dVXaCKJzMRcmLhyJZhFm20bzfk4bhhLLXEi6eVwm5z+yKRlMUSQmyngCEUqAAgQblQ8oR44dFByYIJcTKCAwYqgEYtSkm0Sgq0hDcLKhQilMsi8h3iQXkUzWDCLB4wtpEKZRjyBnBEcWJaiRWacktrhQUpZEmcNefWcwJpsoIKS6rApJMqkEbkLItUaWUbbSxyhIwnmWLKCF6G6aNVmjgAy5kFoHkmLO7l0KWXYIp5C5lmrmnnmW0qCeWTT+JIEydUWiloG1sOuRCSziFp6KKGzSDjRppoMAKQJa1CyS23XEYRKoIIgoaCkGKRgi2ksgCpEAGkWsARUirESRYqkP9KqgosSgQTAq+kGkACHmhqECcOyXpLClgAyeNTrWHRRgG6viKECZQShMUtwlLiH2+4XGtQLiMksIRhKqAhiK6CtLGgC6TessIMxzXIAiUzIPRGKwD44GcOmoxgSK4ByLLgKk5mAaAWD7Hg3yozzODfE/QCoIZ9Rh1wwFYIrdJhQZaysEJ6yGWRRVuaHAIAAGCkcJALzG2ExUOUXEyDx5elAMbIQlx81yoas8Diyx8bpsbIrfx1FycurMCCC5TyrCkuPoyMQK00zWA0RAU52jNBS4wMgCN35eKCxsYVpHTVQIzcQ2xEaULJQ9ryBrNBtbgCwCsmn5VLFlB3fDWDFAwUxihBY297bGGB/31oLiMZrnhBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDCTCxeZGEqcWPDOmzd3KGosyOmgnQtv7Bzk1HHjQVW2qJQk+PGCyII3RPxKZbKgql9MmtAsaOeiCIMs2Ci64KfmwEw4mdy5UVDExZcDWUFSNFSV0YEsmGhlQZDTxzc/CdqiusbW1ah2tIqowfIpQVVvqEJidXbgiyZaqbAEKaIkJxFU2QCrO5CTCa1OLg38CvWFBapOVlLMxNbgJSdaTXT06jYHpyZULbw4mMpFwkwlSrhgWpCK1iajc1D59UtvDhVrqEIdWEOEBAlFDwITIcKOrVSSe+cMVnilCaG+rA68QYUNrwa8miBkYYd4cRURBwb/K7FzZDAmtgW60PCA1/UHvyQTvISiO/E7LOh6ln+QdY7LETSA3QNvsMBfVy+Y4J0dJvhxYEKclCCBe+4pYoJ+DLESzB3epTfRDb5gx0sEv0inUSYq2HGHYhux0B4TsdXESSoxahShCv4RpuOOJpHk2Y+S3eBCMEMGY2SR5dUUAkhv+HKRk29owGImKJhggi1YYnklMA8ydAMbCoQp5gJhLmAbSlnacqWatgxm1JdixlmmbUIaeeSdSW70ly++aNCnn3wywSKPhBZaVyYmanQDEyVgaBIrfgTDQmUamaCLLooYuNENqUjKAjDBUVRDLwaUmoAGeUKoigufAsMCRJuG/7BLqaXuEkJ4CdXwAgutBnNJlwfVwJofGiRAqwEPoJAjQanw6ioLqTjKiirLEnTDHbtoJxAnwCiiC60I+HJgs66+UINknFySSrQC3cDKuQJpMEAACdR4gwkN0GrBgaw8pAp/mazLLidvXHqBQHbMK4AFBqniRJhcIcRKtTncoG4q4XHCCwAA8CIQK70EEIAYKhy0K7AIBZzKrwNt3HFJKoghci+OnsXKupdQqjHHHg9kgQABDLDbWar4sfJKO3dMkB8JiLxAokbVILCjSfc8UBNAB8BEXemm4gfUVUuWSQMi68LcVRavvGzYBZVAgAC6lHwWJ5Qd5LLV01kggZuGehZ2d38oE9YLxxH0LdELdthRo+GM5xAQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEiQGAwYxBhKnFgQhTBhKChqLFjsoIklwkwc7LgRYSZgVw7iuSiSowk7l0oWzFRCBEyDJlga5JMBg5IsMgcSMyFCBAqSA3OGLGjjiRufM4IO5GPHJq6CSvEUlISh6zCpA3OhKGrCBsGcS1oKzLSkqxyzYAVeqiqCEkE8ILUmdeMmg924AotJKloi08CVS/TmyKKk6xOkFInBnRmpqCSSaFsWE9E1CVCDl2AkJCZpWBbIAq8UtfP5SqRIKXNQyvBUrVATfD/vxMMb2AzINohGuhoYqaSeSwwPFJxEkfPHB2Gg4I0HBaWIA2FIioqwGIwnkgji/5JTxLmiIpESZroynfcwXLmWM0Q6t4L5IksooeZ4SRJ1FJLEtBEKbtyHwTCTLZQLDMO0d8V+ChUjjHmM2KGcRsRQggIKF1JESQUVOKGbTJmMSFExeAADIWAstjgRSTBCVkwWD2VBIww3cidTMZEoscQSPgL5oxzcEXPFkUgmSdyOGTgwhANQRvkkMAIZmeSVS5ZUDAZRSjnEEKFQmcOMONqIY406yhQJSBe1CRKRLkq0Ypx0DmRDgic+YUJ8QeWSySWX8KmRJAww4IZ+GxVDzCU2ZpGmRLm4ocCkQixhYkLF2DBDo47iOV8koUw6aSgiYJdQLps2egkxJOXiqUE28P95iRxDiBqEIigIWtCiqmYCmTCFiKArQcWYEMoTBFGCQRC2LgFhiTbOMCwuPejQihsCuWoDScL8YAADI4olgahJdDfDJZ4Wo4gO1iKbgxJBBKGEQCV4a0ASqBEjApRZcgQhCjywOwRcRAQQABHZKmKAAQmIWVAWf2lkgxDsBvBVDrkUfDBJVySwsCLDSvVEK+wWAaPGRCCVxMI/lMDiJT+w60OWKBOUBQMLO/CoTBmwq8MSxBb8CsIEPbGwAU7ERckr7BbSYQ4oQ0YMEQsr0O9GwzDdSnpBG0z0WQgYoEBsUkkSiiKeRl1QLhkwQjZYxYRcDBGvHDzSnC0qUrcieNcLmV0JJYjm9+AGBQQAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSBCQlmWAGEqcWHAFFBErKGqUKEmECEkHA21MCEhZn4OSLoI0mOzElpEFa7RE9rJgx48Gl8lZcqwmzByAJJ04sUIkwZsrB3qpxYTnn58Dlw09scymx4wEW8hhwuQK1IGBVpyQIsnLUY9Jc9R4whWK2a8C/yAbenIgUoLJuMqpCzdHoBZDkdUYuALtQC20mpYwqhHQ24KAWp5oYfQm1kBSuNLScnBLVYQllW1hPLDP1JrKkCFTJrDPTibJDEbesIHzwWVXcisbTNCLUGSfDV5J/IS3wL9yMCiHglBL7ucQCTp/mlBLiRYEl4lAohwDEimkCdb/gPH8SotljyUy/iMliRs3ymkpC2/wj7Lyyv7QXyhpSXcMS5Q1USBatLBCbjBsFMgTGMCXhBTUNYZbC8ZR1AcSSIgQHEw1RLiRJFfs19eIJKoH1nGkBfLHiiy2WOFIJdAioxwy1vhETV4so+OOPPo0UiBLKCLkkERil4MXD/HYI1RAEulkEUaq2OKUL2oUyAm0HHNMllweI4KHJYYp5k+AMBiRgrUkk56VyRjzxRcijHTFA7wkwdpGfRQBBgB8klGlQl4kwcugEBxjG0N/LOEDn3x6ssSaC12pCC9mUCpBCX8qVQsZjAIAhiJ1eZFpb0ZtcQwElFbqhiT7eaHIF4x+/2EMMozJYUwJkB4nCRvMlbYEnYM+cAx9gTzAKAJPnNnaGAF0ksRxgABilAigKPDAhr4ZQSkvTOwnSSedIOGjX0YIEIAnzAXCxKBMCITMAgoosER4NZQggQQJIpSMkTYVEEAAEJxphAEGsCGQFxjEawxWBS3DF0WAQPBvAQwPbIARRiljRrxG5AoTFJ0IIIAbRgVisREEyRHvAieMuMUCIo+Rr0AnSwdBvBGACdMS/wogR0E1E1RLvAo8AZcyB/xrjIcmE4yxeGzEy8vMMElygACelFBQ0xeHJ0m1vPD70woSdGxQ0AQFIoedIwaSKxsEG2xQICKWiEEBBmAw5kRSSQex4d6ADxQQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwE5ctmxhKnFgQFx48lShqlEjpYkaDxTYm3JQly8FKFymBpGSFi8iCmihdoVTDYEc8KgtqseMMlcuXAjdVunIFV0iCNz8OLIbCWc+aQAVyIXrl58CkBf04taM0ajFcRCtFHIgSJ8Eaz5ziGRtVYA2ZV7Qg9Yh0q8m2BLMQpaSJLF2pkZwOO6qxGGGCMYn6ufq32DCnkawS5CIXYTEtWvoa1LL3p94ri3Nk4eksZ0MrIEBsQcilZJYtmpcOpbRa4GFcgZ/FzvHVTocOHPAgrKHFdRYubHNwwQUV4ZZhuAhuQdWMA/Bmw0ZuMa6lxmGGhGtA/5vDwXqHSFm+G9S03XV3kZSe/Lb+hFJyhcWIu65NsRgq83MM0xxFDmF2n0RZNNPMM/y9tMluGhWlHl4UWmYbb7xN+NKEhOGCBi8ghhhiIwdS9BhPKDpjhx2RCRSJDjDGKCMzAxYGQiMX4Ihjjjl+ZIeMQOpAI1DFgMCjjhfk2MhHHooo4iGNaCgRNE5tpSJkkhmGYYYVdumlSJrYkUSJCxWDBzRkTomGIIJEAt8iozQT3UZ+XDBIAHgKUWOZzUzgZxt2NKgQF80QIgCeAhAyR5oHOdbIKH5O0AgeezaECigCHCrAIG2E9iBDmxzFhR1tRDqKEldweIEgmQYgyAPQEP/2xAPPkFnMFY6gQpAfcywyAaSjONPoBIgaYsdufoACywEd2BbqUZE8wMsEldl2hRKQTgDChFYccAAHguaQBCyDHKBrDs4sssgTAkHzwCGHzPFdDXjkeNdB0HQ1kBWEwALLBGM5ooACUfLGAS+HoKGvQFuEppEmE/hbyBUDCUzwQLhEAOKYXaLCjL9JEJbEwI0Q9ESI2VG4BS/+gnJvDhYXzPAEh/CyiGRAzeEvLOwSNPLFBOGBMC924IWLAv4+gLPFjhymSSMgRvCySFYgfYBwBcX83RXSprHwRlcswnHWJIMEQgcOt6WlQTE3+iVCHAwc8tsTaTHMMNXSrbdBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSPDGqlWcGEqcWDDLlStZKGqUaPEKlo0bOWXKdBDLFSsfDWJRZgNkwRtasmi5ofJkSoKZUOBRscrlQE4xs5AsaNJjQU5X8OBJ0dKnQBtZovYkWPSmQC1KUWR0KpDTlqhaIg6s2lCFUis0uT6NmmWqQLJjleLZohYn2LQ54OawkUIKnmBiNaYIdhBoVLpvL95UpjSFW4Krhh5U0amTBi0GV7FNu8WSJcRbdOKxZPCGshIlHv8MBaC1rhBNu37VonpgFp0q8ObglAUPFCjOrBy8oehLawBfGqQIbGOLboOZrmAemEkFcGfOoBAeXqvQcQA8FJH/psj8Si3s2FGEVZiplI/vPko9Z2hJCvYQUKRYCrzQkqIAxyVQm0KcqIBeLVfERlEKDXzxhTMgbVELFCpIBpINIbyhIEWWbKUWf3UlxMmIu0VEYogLYaGIKKKsyOKLkICo0RVS1FgjHjbiMZUUAfTo44+gDDhRLaUU2UGRpRzZQUol/OhkAKBsSF4tRxqJZAdLvuUiixO8KAok802ElI1k3uiWiSWSKCOKbLaJ0A0ldBDmQgUC5pQViugSjRQgWaJBBiF4SBEWGiRgQDTRTCMlgRm+8YYGUljIXghBGHBoNEGEMGdCVpTiqKMdqLDoQDfgMQ2iiCaQwU2bkipWJlJo//DpG07YaRAnGegZjQG6KGJFYLVQo8KauwXTAR4EZRFCBqQ4moEUMnLCCKoNlKAbFtOAkmlXuw2EBzWKvDFdV8E0IesbUCCkDBmFOCFpDk2wGwSfOUDxBinp5mAFuIo4AyJfkEAyrkFWKHNQMA2QAQopaXUgjTQx5nCDE4oowojBBn0F0g1vFFJIA1cMVIoZ0pQyFiMVN9GqRiiA4nETgZUijRkmDwRFxWsIV1cmiigciqAdkByxQJlkULEGQmrkjMug5Cvyw0MLlMIaFdPrVBbSeKyIpA6bAUlBNpRSMSmCgqRMKIWAgoJBI5dsUDBrUMOIVS4po0EpMsoMMYicQB7hRNk+nVhQ11/f6uZBTZDcweETbWGFFQMzLvlAAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSLDYjRvFGEqcWPBPqlR/KGpseOOgRYwbN6oINaFjxYsZDWpJZTLkwGQEALiqZfBjSoJd9kyqBMjlwD2CAAAAclPgR0wGYUyatKelTyRCAXA4CZIgJp2TkPocqAWBUB8wCNpsWGmppYhbBz5pJZQC2hxjuS7d0yUtQUDVhAZINjBujhtYw4bMU+lgMh5Ch/SEi3JgqqWTFhe8URfhpB8/OGgdWIyC0FZPBHbBhKnyH8ipDBZLlUyF5IYTAgR4tcDO60oxWzVCiKlsJadw89gaXlh1GwKyAxCAoOItByC2EwKCUbRLpVvDbd2yhPCGiWqvkg//ciOYssYbMJJlv5V1IaZmhMLPJvTh7UQtKtarSGVfIQw3g4T3SjWVTVTMHtklYwlwDBWjAgQECELTRn/ccgtdWwFihwYMSpQKJv25FKJdCkX01ogkGpSKG9RQ04aLL7Y4S4cTWaLCjTjimMdithjg44+D/CjNaxvdIsKRSCJphxYC9fjjkz6GQiRFxSST5JVLCpRKIy3G2KKMNEpkY4457thQDvahmOKabCp0g5FhJnTgWVtV0sgCDKgQkhbNNGPCZhTxWc0nhLYRp2qozMLBLB8kU+BCgNQCAaGESmOHmgjtccwsis7yRFMlqkDBApRWw0FqaGIq0FtdJPNBp7PU/8LfQcU0wwClC7QxCUEmILFrQjA8oedAmJjQzKIcNMOXahpQGoEtr2lBgTShTGjiQCog0QgHRRVjiQiccnALQpVIM8QTRQl0zBDSSDNuDrZwwIEJAu2hbSP0TpbHMccAWtAe3BlkSQTscqguBRN8sKoIjbihAaoVMbnRDRu0C0FxORwzQcJopaKBG26IcChFI7GrsFoTUHCyQCY00ggSe6TYhRvsyiKxuhsfI9YsbjTSzJQh1WKuNKgUdAzCKwukgsuNLLuVFhOY68ajGW+c9F8f9KxZWpbIMkQowxKkMccFWYKEGxvc7BMMsxwT4thXo2lCliQWM6LGKtPaJkIipA8c2t4T/bHHHv4CbjhBAQEAOw==)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 32 | 数据处理：如何高效处理应用程序产生的数据？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>32 | 数据处理：如何高效处理应用程序产生的数据？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这一讲我们来了解目前业界有哪些优秀的开源日志包，以及手把手教你从 0 编写一个日志包</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 32 | 数据处理：如何高效处理应用程序产生的数据？</h1><div><span>孔令飞</span> <span> 2021-08-07</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/98/a3/989138abbf1f526abf2f57422b6b14a3.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：孔令飞</span><span>大小：20.98M</span><span> 时长：22:58</span></div></div><audio title="32 | 数据处理：如何高效处理应用程序产生的数据？" src="https://res001.geekbang.org/media/audio/a0/3a/a0a645d030cf0060c06690d1bb761b3a/ld/ld.m3u8" __idm_id__="319500"></audio></div><div><div><div><div data-slate-editor="true" data-key="17456" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="17457"><span data-slate-object="text" data-key="17458"><span data-slate-leaf="true" data-offset-key="17458:0" data-first-offset="true"><span data-slate-string="true">你好，我是孔令飞。今天我们来聊聊，如何更好地进行异步数据处理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17459"><span data-slate-object="text" data-key="17460"><span data-slate-leaf="true" data-offset-key="17460:0" data-first-offset="true"><span data-slate-string="true">一个大型应用为了后期的排障、运营等，会将一些请求数据保存在存储系统中，供日后使用。例如：应用将请求日志保存到 Elasticsearch 中，方便排障；网关将 API 请求次数、请求消息体等数据保存在数据库中，供控制台查询展示。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17461"><span data-slate-object="text" data-key="17462"><span data-slate-leaf="true" data-offset-key="17462:0" data-first-offset="true"><span data-slate-string="true">为了满足这些需求，我们需要进行数据采集，数据采集在大型应用中很常见，但我发现不少开发者设计的数据采集服务，通常会存在下面这些问题：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17463"><div data-slate-type="list-line" data-slate-object="block" data-key="17464"><span data-slate-object="text" data-key="17465"><span data-slate-leaf="true" data-offset-key="17465:0" data-first-offset="true"><span data-slate-string="true">采集服务只针对某个采集需求开发，如果采集需求有变，需要修改主代码逻辑，代码改动势必会带来潜在的 Bug，增加开发测试工作量。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17466"><span data-slate-object="text" data-key="17467"><span data-slate-leaf="true" data-offset-key="17467:0" data-first-offset="true"><span data-slate-string="true">数据采集服务会导致已有的服务请求延时变高。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17468"><span data-slate-object="text" data-key="17469"><span data-slate-leaf="true" data-offset-key="17469:0" data-first-offset="true"><span data-slate-string="true">采集数据性能差，需要较长时间才能采集完一批数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17470"><span data-slate-object="text" data-key="17471"><span data-slate-leaf="true" data-offset-key="17471:0" data-first-offset="true"><span data-slate-string="true">启停服务时，会导致采集的数据丢失。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17472"><span data-slate-object="text" data-key="17473"><span data-slate-leaf="true" data-offset-key="17473:0" data-first-offset="true"><span data-slate-string="true">这一讲，我就来详细教你如何设计和落地一个数据采集服务，解决上面这些问题。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17474" id="sr-toc-1"><span data-slate-object="text" data-key="17475"><span data-slate-leaf="true" data-offset-key="17475:0" data-first-offset="true"><span data-slate-string="true">数据采集方式的分类</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17476"><span data-slate-object="text" data-key="17477"><span data-slate-leaf="true" data-offset-key="17477:0" data-first-offset="true"><span data-slate-string="true">首先，你需要知道当前数据采集有哪些方式，以便更好地理解异步数据处理方案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17478"><span data-slate-object="text" data-key="17479"><span data-slate-leaf="true" data-offset-key="17479:0" data-first-offset="true"><span data-slate-string="true">目前，数据采集主要有两种方式，分别是同步采集和异步采集。二者的概念和优缺点如下表所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17480"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/d4/b9/d4d4d6547225de5b565f99957106dbb9.jpg?wh=1920x1058"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17481"><span data-slate-object="text" data-key="17482"><span data-slate-leaf="true" data-offset-key="17482:0" data-first-offset="true"><span data-slate-string="true">现代应用对性能的要求越来越高，而异步采集对应用程序的性能影响更小，因此异步采集更受开发者欢迎，得到了大规模的应用。接下来，我要介绍的 IAM Pump Server 服务，采用的就是异步采集的方式。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17483" id="sr-toc-2"><span data-slate-object="text" data-key="17484"><span data-slate-leaf="true" data-offset-key="17484:0" data-first-offset="true"><span data-slate-string="true">数据采集系统设计</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17485"><span data-slate-object="text" data-key="17486"><span data-slate-leaf="true" data-offset-key="17486:0" data-first-offset="true"><span data-slate-string="true">这一讲，我采用理论 + 实战的方式来展示如何设计一个数据采集服务，这里先来介绍下关于数据采集的理论知识，后面会有具体的实战案例。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17487"><span data-slate-object="text" data-key="17488"><span data-slate-leaf="true" data-offset-key="17488:0" data-first-offset="true"><span data-slate-string="true">在过往的项目开发中，我发现很多开发人员添加了数据采集功能后，因为同步上报数据、单线程、上报逻辑不对等原因，让整个应用程序的性能受到了严重影响。那么，如何在采集过程中不影响程序的性能？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17489"><span data-slate-object="text" data-key="17490"><span data-slate-leaf="true" data-offset-key="17490:0" data-first-offset="true"><span data-slate-string="true">答案就是让数据采集模型化。通过模型化，可以使设计出来的采集系统功能更加通用，能够满足未来的很多同类需求，我们也就不需要重复开发相同的系统了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17491"><span data-slate-object="text" data-key="17492"><span data-slate-leaf="true" data-offset-key="17492:0" data-first-offset="true"><span data-slate-string="true">我今天就来给你详细介绍下，如何将数据采集功能模型化，以及该模型是如何解决上面说的的各种问题的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17493" id="sr-toc-3"><span data-slate-object="text" data-key="17494"><span data-slate-leaf="true" data-offset-key="17494:0" data-first-offset="true"><span data-slate-string="true">设计数据采集系统时需要解决的核心问题</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17495"><span data-slate-object="text" data-key="17496"><span data-slate-leaf="true" data-offset-key="17496:0" data-first-offset="true"><span data-slate-string="true">采集系统首先需要一个数据源 Input，Input 可以是一个或者多个，Input 中的数据来自于应用程序上报。采集后的数据通常需要经过处理，比如格式化、增删字段、过滤无用的数据等，然后将处理后的数据存储到下游系统（Output）中，如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17497"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a9/75/a91db8c7818af0898a1774073e9bfe75.jpg?wh=1920x1145"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17498"><span data-slate-object="text" data-key="17499"><span data-slate-leaf="true" data-offset-key="17499:0" data-first-offset="true"><span data-slate-string="true">这里，我们需要解决这 3 个核心问题：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17500"><div data-slate-type="list-line" data-slate-object="block" data-key="17501"><span data-slate-object="text" data-key="17502"><span data-slate-leaf="true" data-offset-key="17502:0" data-first-offset="true"><span data-slate-string="true">进行数据采集，就需要在正常流程中多加一个上报数据环节，这势必会影响程序的性能。那么，如何让程序的性能损失最小化？</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17503"><span data-slate-object="text" data-key="17504"><span data-slate-leaf="true" data-offset-key="17504:0" data-first-offset="true"><span data-slate-string="true">如果 Input 产生数据的速度大于 Output 的消费能力，产生数据堆积怎么办？</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17505"><span data-slate-object="text" data-key="17506"><span data-slate-leaf="true" data-offset-key="17506:0" data-first-offset="true"><span data-slate-string="true">数据采集后需要存储到下游系统。在存储之前，我们需要对数据进行不同的处理，并可能会存储到不同的下游系统，这种可变的需求如何满足？</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17507"><span data-slate-object="text" data-key="17508"><span data-slate-leaf="true" data-offset-key="17508:0" data-first-offset="true"><span data-slate-string="true">对于让程序性能损失最小化这一点，最好的方法是异步上报。如果是异步，我们需要先把数据缓存在内存中，然后再异步上报到目标系统中。当然，为了提高上报的效率，可以采用批量上报的方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17509"><span data-slate-object="text" data-key="17510"><span data-slate-leaf="true" data-offset-key="17510:0" data-first-offset="true"><span data-slate-string="true">对于数据堆积这个问题，比较好的解决方法是，将采集的数据先上报到一些具有高吞吐量、可以存储大量数据的中间组件，比如 Kafka、Redis 中。这种方式也是业界标准的处理方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17511"><span data-slate-object="text" data-key="17512"><span data-slate-leaf="true" data-offset-key="17512:0" data-first-offset="true"><span data-slate-string="true">对于采集需求多样化这个问题，我们可以将采集程序做成插件化、可扩展的，满足可变的需求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17513"><span data-slate-object="text" data-key="17514"><span data-slate-leaf="true" data-offset-key="17514:0" data-first-offset="true"><span data-slate-string="true">要解决这 3 个问题，其实就涉及到了数据采集系统中的两个功能点的设计，它们分别是数据上报功能和数据采集功能。接下来我们就来看下，如何设计这两个功能点。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17515" id="sr-toc-4"><span data-slate-object="text" data-key="17516"><span data-slate-leaf="true" data-offset-key="17516:0" data-first-offset="true"><span data-slate-string="true">数据上报功能设计</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17517"><span data-slate-object="text" data-key="17518"><span data-slate-leaf="true" data-offset-key="17518:0" data-first-offset="true"><span data-slate-string="true">为了提高异步上报的吞吐量，你可以将数据缓存在内存中（Go 中可以使用有缓冲 channel），并使用多个 worker 去消费内存中的数据。使用多个 worker ，可以充分发挥 CPU 的多核能力。另外，上报给下游系统时，你也可以采用批量上报的方式。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17519" id="sr-toc-5"><span data-slate-object="text" data-key="17520"><span data-slate-leaf="true" data-offset-key="17520:0" data-first-offset="true"><span data-slate-string="true">数据采集功能设计</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17521"><span data-slate-object="text" data-key="17522"><span data-slate-leaf="true" data-offset-key="17522:0" data-first-offset="true"><span data-slate-string="true">现代应用程序越来越讲究插件化、扩展性，在设计采集系统时，也应该考虑到未来的需求。比如，未来你可能需要将数据从上报到 MongoDB 切换到 HBase 中，或者同时将数据上报到 MongoDB 和 HBase 中。因此，上报给下游的程序逻辑要具有插件化的能力，并能通过配置选择需要的插件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17523"><span data-slate-object="text" data-key="17524"><span data-slate-leaf="true" data-offset-key="17524:0" data-first-offset="true"><span data-slate-string="true">为了提高程序性能，会先把数据缓存在内存中。但是这样有个缺点：在关停程序时，内存中的数据就会丢失。所以，在程序结束之前，我们需要确保内存中的数据能够上报成功，也就是说采集程序需要实现优雅关停功能。优雅关停不仅要确保缓存中的数据被成功上报，还要确保正在处理的数据被成功上报。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17525"><span data-slate-object="text" data-key="17526"><span data-slate-leaf="true" data-offset-key="17526:0" data-first-offset="true"><span data-slate-string="true">当然了，既然是数据采集，还要能够配置采集的频率。最后，因为采集程序通常是非 API 类型的，所以还需要对外暴露一个特殊的 API，用来返回采集程序的健康状态。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17527" id="sr-toc-6"><span data-slate-object="text" data-key="17528"><span data-slate-leaf="true" data-offset-key="17528:0" data-first-offset="true"><span data-slate-string="true">数据采集应用模型</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17529"><span data-slate-object="text" data-key="17530"><span data-slate-leaf="true" data-offset-key="17530:0" data-first-offset="true"><span data-slate-string="true">通过上面的分析和设计，可以绘制出下面这个采集模型：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17531"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/2e/34/2ecccdb3c851577f9cd5a56bb7197c34.jpg?wh=1920x910"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17532"><span data-slate-object="text" data-key="17533"><span data-slate-leaf="true" data-offset-key="17533:0" data-first-offset="true"><span data-slate-string="true">异步上报需要额外的异步逻辑，会增加开发工作量和程序复杂度，所以，对于一些 Input 数据生产速度小于 Output 消费速度，并且 Output 具有高吞吐量、低延时特性的场景，也可以采用同步上报，例如同步上报给 Redis。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17534" id="sr-toc-7"><span data-slate-object="text" data-key="17535"><span data-slate-leaf="true" data-offset-key="17535:0" data-first-offset="true"><span data-slate-string="true">数据采集系统落地项目：iam-authz-server + iam-pump</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17536"><span data-slate-object="text" data-key="17537"><span data-slate-leaf="true" data-offset-key="17537:0" data-first-offset="true"><span data-slate-string="true">上面，我介绍了数据采集系统的架构，但是只有模型和理论，肯定还不足以解决你对数据采集程序的开发需求。所以，接下来我来介绍下如何落地上面的数据采集架构。整个架构包括两个部分，分别由不同的服务实现：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17538"><div data-slate-type="list-line" data-slate-object="block" data-key="17539"><span data-slate-object="text" data-key="17540"><span data-slate-leaf="true" data-offset-key="17540:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server：实现数据上报功能。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17541"><span data-slate-object="text" data-key="17542"><span data-slate-leaf="true" data-offset-key="17542:0" data-first-offset="true"><span data-slate-string="true">iam-pump：实现数据采集功能。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17543"><span data-slate-object="text" data-key="17544"><span data-slate-leaf="true" data-offset-key="17544:0" data-first-offset="true"><span data-slate-string="true">整个采集系统的架构，跟上面描述的数据采集架构完全一致，这里就不重复说明了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17545" id="sr-toc-8"><span data-slate-object="text" data-key="17546"><span data-slate-leaf="true" data-offset-key="17546:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server：数据上报</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17547"><span data-slate-object="text" data-key="17548"><span data-slate-leaf="true" data-offset-key="17548:0" data-first-offset="true"><span data-slate-string="true">数据上报的最大难点，就是如何减少上报逻辑对应用性能的影响。对此，我们主要的解决思路就是异步上报数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17549"><span data-slate-object="text" data-key="17550"><span data-slate-leaf="true" data-offset-key="17550:0" data-first-offset="true"><span data-slate-string="true">接下来我会介绍 iam-authz-server 的数据上报设计。这是一个非常成熟的设计，在我所开发和了解的项目中被大量采用，有些项目可以承载十亿级 / 天的请求量。通过介绍这个设计，我们来看看异步上报的具体方法，以及上报过程中要考虑的因素。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17551"><span data-slate-object="text" data-key="17552"><span data-slate-leaf="true" data-offset-key="17552:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的数据上报架构如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17553"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/4d/3f/4d288a15fa6ebaae5ef25df8af5ac13f.jpg?wh=1920x764"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17554"><span data-slate-object="text" data-key="17555"><span data-slate-leaf="true" data-offset-key="17555:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 服务中的数据上报功能可以选择性开启，开启代码见 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17556"><span data-slate-object="text" data-key="17557"><span data-slate-leaf="true" data-offset-key="17557:0" data-first-offset="true"><span data-slate-string="true">internal/authzserver/server.go</span></span></span></a><span data-slate-object="text" data-key="17558"><span data-slate-leaf="true" data-offset-key="17558:0" data-first-offset="true"><span data-slate-string="true"> ，代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17559"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17560"><span data-slate-object="text" data-key="17561"><span data-slate-leaf="true" data-offset-key="17561:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17562"><span data-slate-leaf="true" data-offset-key="17562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17563"><span data-slate-leaf="true" data-offset-key="17563:0" data-first-offset="true"><span data-slate-string="true"> s.analyticsOptions.Enable {                                           </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17564"><span data-slate-object="text" data-key="17565"><span data-slate-leaf="true" data-offset-key="17565:0" data-first-offset="true"><span data-slate-string="true">        analyticsStore := storage.RedisCluster{KeyPrefix: RedisKeyPrefix}              </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17566"><span data-slate-object="text" data-key="17567"><span data-slate-leaf="true" data-offset-key="17567:0" data-first-offset="true"><span data-slate-string="true">        analyticsIns := analytics.NewAnalytics(s.analyticsOptions, &amp;analyticsStore)    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17568"><span data-slate-object="text" data-key="17569"><span data-slate-leaf="true" data-offset-key="17569:0" data-first-offset="true"><span data-slate-string="true">        analyticsIns.Start()                                                   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17570"><span data-slate-object="text" data-key="17571"><span data-slate-leaf="true" data-offset-key="17571:0" data-first-offset="true"><span data-slate-string="true">        s.gs.AddShutdownCallback(shutdown.ShutdownFunc(</span></span></span><span data-slate-object="text" data-key="17572"><span data-slate-leaf="true" data-offset-key="17572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17573"><span data-slate-leaf="true" data-offset-key="17573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="17574"><span data-slate-leaf="true" data-offset-key="17574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="17575"><span data-slate-leaf="true" data-offset-key="17575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17576"><span data-slate-leaf="true" data-offset-key="17576:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17577"><span data-slate-leaf="true" data-offset-key="17577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="17578"><span data-slate-leaf="true" data-offset-key="17578:0" data-first-offset="true"><span data-slate-string="true"> {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17579"><span data-slate-object="text" data-key="17580"><span data-slate-leaf="true" data-offset-key="17580:0" data-first-offset="true"><span data-slate-string="true">            analyticsIns.Stop()    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17581"><span data-slate-object="text" data-key="17582"><span data-slate-leaf="true" data-offset-key="17582:0" data-first-offset="true"><span data-slate-string="true">                          </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17583"><span data-slate-object="text" data-key="17584"><span data-slate-leaf="true" data-offset-key="17584:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17585"><span data-slate-leaf="true" data-offset-key="17585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17586"><span data-slate-leaf="true" data-offset-key="17586:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17587"><span data-slate-leaf="true" data-offset-key="17587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17588"><span data-slate-leaf="true" data-offset-key="17588:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17589"><span data-slate-object="text" data-key="17590"><span data-slate-leaf="true" data-offset-key="17590:0" data-first-offset="true"><span data-slate-string="true">        }))    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17591"><span data-slate-object="text" data-key="17592"><span data-slate-leaf="true" data-offset-key="17592:0" data-first-offset="true"><span data-slate-string="true">    }     </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17593"><span data-slate-object="text" data-key="17594"><span data-slate-leaf="true" data-offset-key="17594:0" data-first-offset="true"><span data-slate-string="true">上面的代码中，当 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17595"><span data-slate-object="text" data-key="17596"><span data-slate-leaf="true" data-offset-key="17596:0" data-first-offset="true"><span data-slate-string="true">s.analyticsOptions.Enable</span></span></span></span><span data-slate-object="text" data-key="17597"><span data-slate-leaf="true" data-offset-key="17597:0" data-first-offset="true"><span data-slate-string="true"> 为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17598"><span data-slate-object="text" data-key="17599"><span data-slate-leaf="true" data-offset-key="17599:0" data-first-offset="true"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="17600"><span data-slate-leaf="true" data-offset-key="17600:0" data-first-offset="true"><span data-slate-string="true"> 时，开启数据上报功能。因为数据上报会影响程序的性能，而且在未来可能会存在禁掉数据上报功能的场景，所以在设计 iam-authz-server 时，就把数据上报功能做成了可配置的，也就是说可以通过配置文件来启用 / 禁用数据上报功能。配置方式也很简单：将 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17601"><span data-slate-object="text" data-key="17602"><span data-slate-leaf="true" data-offset-key="17602:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server.yaml</span></span></span></a><span data-slate-object="text" data-key="17603"><span data-slate-leaf="true" data-offset-key="17603:0" data-first-offset="true"><span data-slate-string="true"> 的 analytics.enable 设置为 true，代表开启数据上报功能；设置为 false ，则代表关闭数据上报功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17604"><span data-slate-object="text" data-key="17605"><span data-slate-leaf="true" data-offset-key="17605:0" data-first-offset="true"><span data-slate-string="true">这里，我建议你在设计程序时，将未来的可能变量考虑进去，并将这些变量做成可配置的。这样，如果哪天需求变化，我们就能通过修改配置文件，而不是修改代码的方式来满足需求。这种方式可以将应用程序的变动局限在配置文件中，从而大大减小现网服务出现故障的概率，做到只变更配置文件就可以缩短发布变更的周期。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17606"><span data-slate-object="text" data-key="17607"><span data-slate-leaf="true" data-offset-key="17607:0" data-first-offset="true"><span data-slate-string="true">在上面的代码中，通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17608"><span data-slate-object="text" data-key="17609"><span data-slate-leaf="true" data-offset-key="17609:0" data-first-offset="true"><span data-slate-string="true">NewAnalytics</span></span></span></a><span data-slate-object="text" data-key="17610"><span data-slate-leaf="true" data-offset-key="17610:0" data-first-offset="true"><span data-slate-string="true"> 创建一个数据上报服务，代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17611"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17612"><span data-slate-object="text" data-key="17613"><span data-slate-leaf="true" data-offset-key="17613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17614"><span data-slate-leaf="true" data-offset-key="17614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17615"><span data-slate-leaf="true" data-offset-key="17615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NewAnalytics</span></span></span></span></span><span data-slate-object="text" data-key="17616"><span data-slate-leaf="true" data-offset-key="17616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(options *AnalyticsOptions, store storage.AnalyticsHandler)</span></span></span></span></span><span data-slate-object="text" data-key="17617"><span data-slate-leaf="true" data-offset-key="17617:0" data-first-offset="true"><span data-slate-string="true"> *Analytics {                              </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17618"><span data-slate-object="text" data-key="17619"><span data-slate-leaf="true" data-offset-key="17619:0" data-first-offset="true"><span data-slate-string="true">    ps := options.PoolSize                                                                                             </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17620"><span data-slate-object="text" data-key="17621"><span data-slate-leaf="true" data-offset-key="17621:0" data-first-offset="true"><span data-slate-string="true">    recordsBufferSize := options.RecordsBufferSize                                                                     </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17622"><span data-slate-object="text" data-key="17623"><span data-slate-leaf="true" data-offset-key="17623:0" data-first-offset="true"><span data-slate-string="true">    workerBufferSize := recordsBufferSize / </span></span></span><span data-slate-object="text" data-key="17624"><span data-slate-leaf="true" data-offset-key="17624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span><span data-slate-object="text" data-key="17625"><span data-slate-leaf="true" data-offset-key="17625:0" data-first-offset="true"><span data-slate-string="true">(ps)                                                                 </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17626"><span data-slate-object="text" data-key="17627"><span data-slate-leaf="true" data-offset-key="17627:0" data-first-offset="true"><span data-slate-string="true">    log.Debug(</span></span></span><span data-slate-object="text" data-key="17628"><span data-slate-leaf="true" data-offset-key="17628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Analytics pool worker buffer size"</span></span></span></span><span data-slate-object="text" data-key="17629"><span data-slate-leaf="true" data-offset-key="17629:0" data-first-offset="true"><span data-slate-string="true">, log.Uint64(</span></span></span><span data-slate-object="text" data-key="17630"><span data-slate-leaf="true" data-offset-key="17630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"workerBufferSize"</span></span></span></span><span data-slate-object="text" data-key="17631"><span data-slate-leaf="true" data-offset-key="17631:0" data-first-offset="true"><span data-slate-string="true">, workerBufferSize))                   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17632"><span data-slate-object="text" data-key="17633"><span data-slate-leaf="true" data-offset-key="17633:0" data-first-offset="true"><span data-slate-string="true">                                                                                                                       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17634"><span data-slate-object="text" data-key="17635"><span data-slate-leaf="true" data-offset-key="17635:0" data-first-offset="true"><span data-slate-string="true">    recordsChan := </span></span></span><span data-slate-object="text" data-key="17636"><span data-slate-leaf="true" data-offset-key="17636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17637"><span data-slate-leaf="true" data-offset-key="17637:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17638"><span data-slate-leaf="true" data-offset-key="17638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17639"><span data-slate-leaf="true" data-offset-key="17639:0" data-first-offset="true"><span data-slate-string="true"> *AnalyticsRecord, recordsBufferSize)                                                      </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17640"><span data-slate-object="text" data-key="17641"><span data-slate-leaf="true" data-offset-key="17641:0" data-first-offset="true"><span data-slate-string="true">                                                                                                                       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17642"><span data-slate-object="text" data-key="17643"><span data-slate-leaf="true" data-offset-key="17643:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17644"><span data-slate-leaf="true" data-offset-key="17644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17645"><span data-slate-leaf="true" data-offset-key="17645:0" data-first-offset="true"><span data-slate-string="true"> &amp;Analytics{                                                                                                 </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17646"><span data-slate-object="text" data-key="17647"><span data-slate-leaf="true" data-offset-key="17647:0" data-first-offset="true"><span data-slate-string="true">        store:                      store,                                                                             </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17648"><span data-slate-object="text" data-key="17649"><span data-slate-leaf="true" data-offset-key="17649:0" data-first-offset="true"><span data-slate-string="true">        poolSize:                   ps,                                                                                </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17650"><span data-slate-object="text" data-key="17651"><span data-slate-leaf="true" data-offset-key="17651:0" data-first-offset="true"><span data-slate-string="true">        recordsChan:                recordsChan,                                                                       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17652"><span data-slate-object="text" data-key="17653"><span data-slate-leaf="true" data-offset-key="17653:0" data-first-offset="true"><span data-slate-string="true">        workerBufferSize:           workerBufferSize,                                                                  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17654"><span data-slate-object="text" data-key="17655"><span data-slate-leaf="true" data-offset-key="17655:0" data-first-offset="true"><span data-slate-string="true">        recordsBufferFlushInterval: options.FlushInterval,                                                             </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17656"><span data-slate-object="text" data-key="17657"><span data-slate-leaf="true" data-offset-key="17657:0" data-first-offset="true"><span data-slate-string="true">    }                                                                                                                  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17658"><span data-slate-object="text" data-key="17659"><span data-slate-leaf="true" data-offset-key="17659:0" data-first-offset="true"><span data-slate-string="true">}      </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17660"><span data-slate-object="text" data-key="17661"><span data-slate-leaf="true" data-offset-key="17661:0" data-first-offset="true"><span data-slate-string="true">这里的代码根据传入的参数，创建 Analytics 类型的变量并返回，变量中有 5 个字段需要你关注：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17662"><div data-slate-type="list-line" data-slate-object="block" data-key="17663"><span data-slate-object="text" data-key="17664"><span data-slate-leaf="true" data-offset-key="17664:0" data-first-offset="true"><span data-slate-string="true">store： </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17665"><span data-slate-object="text" data-key="17666"><span data-slate-leaf="true" data-offset-key="17666:0" data-first-offset="true"><span data-slate-string="true">storage.AnalyticsHandler</span></span></span></a><span data-slate-object="text" data-key="17667"><span data-slate-leaf="true" data-offset-key="17667:0" data-first-offset="true"><span data-slate-string="true"> 接口类型，提供了 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17668"><span data-slate-object="text" data-key="17669"><span data-slate-leaf="true" data-offset-key="17669:0" data-first-offset="true"><span data-slate-string="true">Connect() bool</span></span></span></span><span data-slate-object="text" data-key="17670"><span data-slate-leaf="true" data-offset-key="17670:0" data-first-offset="true"><span data-slate-string="true"> 和 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17671"><span data-slate-object="text" data-key="17672"><span data-slate-leaf="true" data-offset-key="17672:0" data-first-offset="true"><span data-slate-string="true">AppendToSetPipelined(string, byte)</span></span></span></span><span data-slate-object="text" data-key="17673"><span data-slate-leaf="true" data-offset-key="17673:0" data-first-offset="true"><span data-slate-string="true"> 函数，分别用来连接 storage 和上报数据给 storage。iam-authz-server 用了 redis storage。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17674"><span data-slate-object="text" data-key="17675"><span data-slate-leaf="true" data-offset-key="17675:0" data-first-offset="true"><span data-slate-string="true">recordsChan：授权日志会缓存在 recordsChan 带缓冲 channel 中，其长度可以通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17676"><span data-slate-object="text" data-key="17677"><span data-slate-leaf="true" data-offset-key="17677:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server.yaml</span></span></span></a><span data-slate-object="text" data-key="17678"><span data-slate-leaf="true" data-offset-key="17678:0" data-first-offset="true"><span data-slate-string="true"> 配置文件中的  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17679"><span data-slate-object="text" data-key="17680"><span data-slate-leaf="true" data-offset-key="17680:0" data-first-offset="true"><span data-slate-string="true">analytics.records-buffer-size</span></span></span></span><span data-slate-object="text" data-key="17681"><span data-slate-leaf="true" data-offset-key="17681:0" data-first-offset="true"><span data-slate-string="true">  配置。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17682"><span data-slate-object="text" data-key="17683"><span data-slate-leaf="true" data-offset-key="17683:0" data-first-offset="true"><span data-slate-string="true">poolSize：指定开启 worker 的个数，也就是开启多少个 Go 协程来消费 recordsChan 中的消息。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17684"><span data-slate-object="text" data-key="17685"><span data-slate-leaf="true" data-offset-key="17685:0" data-first-offset="true"><span data-slate-string="true">workerBufferSize：批量投递给下游系统的的消息数。通过批量投递，可以进一步提高消费能力、减少 CPU 消耗。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17686"><span data-slate-object="text" data-key="17687"><span data-slate-leaf="true" data-offset-key="17687:0" data-first-offset="true"><span data-slate-string="true">recordsBufferFlushInterval：设置最迟多久投递一次，也就是投递数据的超时时间。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17688"><span data-slate-object="text" data-key="17689"><span data-slate-leaf="true" data-offset-key="17689:0" data-first-offset="true"><span data-slate-string="true">analytics.ecords-buffer-size 和 analytics.pool-size 建议根据部署机器的 CPU 和内存来配置。在应用真正上线前，我建议你通过压力和负载测试，来配置一个合适的值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17690"><span data-slate-object="text" data-key="17691"><span data-slate-leaf="true" data-offset-key="17691:0" data-first-offset="true"><span data-slate-string="true">Analytics 提供了 3 种方法：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17692"><div data-slate-type="list-line" data-slate-object="block" data-key="17693"><span data-slate-object="text" data-key="17694"><span data-slate-leaf="true" data-offset-key="17694:0" data-first-offset="true"><span data-slate-string="true">Start ()，用来启动数据上报服务。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17695"><span data-slate-object="text" data-key="17696"><span data-slate-leaf="true" data-offset-key="17696:0" data-first-offset="true"><span data-slate-string="true">Stop ()，用来关停数据上报服务。主程序在收到系统的终止命令后，调用 Stop 方法优雅关停数据上报服务，确保缓存中的数据都上报成功。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17697"><span data-slate-object="text" data-key="17698"><span data-slate-leaf="true" data-offset-key="17698:0" data-first-offset="true"><span data-slate-string="true">RecordHit (record *AnalyticsRecord) error，用来记录 AnalyticsRecord 的数据。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17699"><span data-slate-object="text" data-key="17700"><span data-slate-leaf="true" data-offset-key="17700:0" data-first-offset="true"><span data-slate-string="true">通过 NewXxx （NewAnalytics）返回一个 Xxx （Analytics）类型的结构体，Xxx（Analytics） 类型带有一些方法，如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17701"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17702"><span data-slate-object="text" data-key="17703"><span data-slate-leaf="true" data-offset-key="17703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17704"><span data-slate-leaf="true" data-offset-key="17704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17705"><span data-slate-leaf="true" data-offset-key="17705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NewAnalytics</span></span></span></span></span><span data-slate-object="text" data-key="17706"><span data-slate-leaf="true" data-offset-key="17706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(options)</span></span></span></span></span><span data-slate-object="text" data-key="17707"><span data-slate-leaf="true" data-offset-key="17707:0" data-first-offset="true"><span data-slate-string="true"> *Analytics {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17708"><span data-slate-object="text" data-key="17709"><span data-slate-leaf="true" data-offset-key="17709:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17710"><span data-slate-object="text" data-key="17711"><span data-slate-leaf="true" data-offset-key="17711:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17712"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17713"><span data-slate-object="text" data-key="17714"><span data-slate-leaf="true" data-offset-key="17714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17715"><span data-slate-leaf="true" data-offset-key="17715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17716"><span data-slate-leaf="true" data-offset-key="17716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(r *Analytics)</span></span></span></span></span><span data-slate-object="text" data-key="17717"><span data-slate-leaf="true" data-offset-key="17717:0" data-first-offset="true"><span data-slate-string="true"> Start() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17718"><span data-slate-object="text" data-key="17719"><span data-slate-leaf="true" data-offset-key="17719:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17720"><span data-slate-object="text" data-key="17721"><span data-slate-leaf="true" data-offset-key="17721:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17722"><span data-slate-object="text" data-key="17723"><span data-slate-leaf="true" data-offset-key="17723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17724"><span data-slate-leaf="true" data-offset-key="17724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17725"><span data-slate-leaf="true" data-offset-key="17725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(r *Analytics)</span></span></span></span></span><span data-slate-object="text" data-key="17726"><span data-slate-leaf="true" data-offset-key="17726:0" data-first-offset="true"><span data-slate-string="true"> Stop() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17727"><span data-slate-object="text" data-key="17728"><span data-slate-leaf="true" data-offset-key="17728:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17729"><span data-slate-object="text" data-key="17730"><span data-slate-leaf="true" data-offset-key="17730:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17731"><span data-slate-object="text" data-key="17732"><span data-slate-leaf="true" data-offset-key="17732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17733"><span data-slate-leaf="true" data-offset-key="17733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17734"><span data-slate-leaf="true" data-offset-key="17734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(r *Analytics)</span></span></span></span></span><span data-slate-object="text" data-key="17735"><span data-slate-leaf="true" data-offset-key="17735:0" data-first-offset="true"><span data-slate-string="true"> RecordHit(record *AnalyticsRecord) </span></span></span><span data-slate-object="text" data-key="17736"><span data-slate-leaf="true" data-offset-key="17736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="17737"><span data-slate-leaf="true" data-offset-key="17737:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17738"><span data-slate-object="text" data-key="17739"><span data-slate-leaf="true" data-offset-key="17739:0" data-first-offset="true"><span data-slate-string="true">    ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17740"><span data-slate-object="text" data-key="17741"><span data-slate-leaf="true" data-offset-key="17741:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17742"><span data-slate-object="text" data-key="17743"><span data-slate-leaf="true" data-offset-key="17743:0" data-first-offset="true"><span data-slate-string="true">其实，上述代码段是一种常见的 Go 代码编写方式 / 设计模式。你在以后的开发生涯中，会经常遇到这种设计方式。使用上述代码设计方式有下面两个好处。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17744"><div data-slate-type="list-line" data-slate-object="block" data-key="17745"><span data-slate-object="text" data-key="17746"><span data-slate-leaf="true" data-offset-key="17746:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">功能模块化：</span></span></span></span><span data-slate-object="text" data-key="17747"><span data-slate-leaf="true" data-offset-key="17747:0" data-first-offset="true"><span data-slate-string="true">将数据上报的功能封装成一个服务模块，数据和方法都围绕着 Xxx 结构体来展开。这和 C++、Java、Python 的类有相似的地方，你可以这么理解：Xxx 相当于类，NewXxx 相当于初始化一个类实例，Start、Stop、RecordHit 是这个类提供的方法。功能模块化可以使程序逻辑更加清晰，功能更独立、更好维护，也可以供其他应用使用。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17748"><span data-slate-object="text" data-key="17749"><span data-slate-leaf="true" data-offset-key="17749:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">方便数据传递：</span></span></span></span><span data-slate-object="text" data-key="17750"><span data-slate-leaf="true" data-offset-key="17750:0" data-first-offset="true"><span data-slate-string="true">可以将数据存放在 Xxx 结构体字段中，供不同的方法共享使用，如果有并发，数据共享时，注意要给非并发安全的类型加锁，例如 recordsChan。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17751"><span data-slate-object="text" data-key="17752"><span data-slate-leaf="true" data-offset-key="17752:0" data-first-offset="true"><span data-slate-string="true">接下来，我会介绍 iam-authz-server 服务中跟数据上报相关的 3 部分核心代码，分别是启动数据上报服务、异步上报授权日志和优雅关停数据上报。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17753" id="sr-toc-9"><span data-slate-object="text" data-key="17754"><span data-slate-leaf="true" data-offset-key="17754:0" data-first-offset="true"><span data-slate-string="true">启动服务：启动数据上报服务</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17755"><span data-slate-object="text" data-key="17756"><span data-slate-leaf="true" data-offset-key="17756:0" data-first-offset="true"><span data-slate-string="true">在服务启动时，首先要启动数据上报功能模块。我们通过调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17757"><span data-slate-object="text" data-key="17758"><span data-slate-leaf="true" data-offset-key="17758:0" data-first-offset="true"><span data-slate-string="true">analyticsIns.Start()</span></span></span></a><span data-slate-object="text" data-key="17759"><span data-slate-leaf="true" data-offset-key="17759:0" data-first-offset="true"><span data-slate-string="true"> 启动数据上报服务。Start 代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17760"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17761"><span data-slate-object="text" data-key="17762"><span data-slate-leaf="true" data-offset-key="17762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17763"><span data-slate-leaf="true" data-offset-key="17763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17764"><span data-slate-leaf="true" data-offset-key="17764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(r *Analytics)</span></span></span></span></span><span data-slate-object="text" data-key="17765"><span data-slate-leaf="true" data-offset-key="17765:0" data-first-offset="true"><span data-slate-string="true"> Start() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17766"><span data-slate-object="text" data-key="17767"><span data-slate-leaf="true" data-offset-key="17767:0" data-first-offset="true"><span data-slate-string="true">    analytics = r</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17768"><span data-slate-object="text" data-key="17769"><span data-slate-leaf="true" data-offset-key="17769:0" data-first-offset="true"><span data-slate-string="true">    r.store.Connect()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17770"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17771"><span data-slate-object="text" data-key="17772"><span data-slate-leaf="true" data-offset-key="17772:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17773"><span data-slate-leaf="true" data-offset-key="17773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// start worker pool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17774"><span data-slate-object="text" data-key="17775"><span data-slate-leaf="true" data-offset-key="17775:0" data-first-offset="true"><span data-slate-string="true">    atomic.SwapUint32(&amp;r.shouldStop, </span></span></span><span data-slate-object="text" data-key="17776"><span data-slate-leaf="true" data-offset-key="17776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17777"><span data-slate-leaf="true" data-offset-key="17777:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17778"><span data-slate-object="text" data-key="17779"><span data-slate-leaf="true" data-offset-key="17779:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17780"><span data-slate-leaf="true" data-offset-key="17780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="17781"><span data-slate-leaf="true" data-offset-key="17781:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="17782"><span data-slate-leaf="true" data-offset-key="17782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17783"><span data-slate-leaf="true" data-offset-key="17783:0" data-first-offset="true"><span data-slate-string="true">; i &lt; r.poolSize; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17784"><span data-slate-object="text" data-key="17785"><span data-slate-leaf="true" data-offset-key="17785:0" data-first-offset="true"><span data-slate-string="true">        r.poolWg.Add(</span></span></span><span data-slate-object="text" data-key="17786"><span data-slate-leaf="true" data-offset-key="17786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17787"><span data-slate-leaf="true" data-offset-key="17787:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17788"><span data-slate-object="text" data-key="17789"><span data-slate-leaf="true" data-offset-key="17789:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17790"><span data-slate-leaf="true" data-offset-key="17790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17791"><span data-slate-leaf="true" data-offset-key="17791:0" data-first-offset="true"><span data-slate-string="true"> r.recordWorker()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17792"><span data-slate-object="text" data-key="17793"><span data-slate-leaf="true" data-offset-key="17793:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17794"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17795"><span data-slate-object="text" data-key="17796"><span data-slate-leaf="true" data-offset-key="17796:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17797"><span data-slate-leaf="true" data-offset-key="17797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// stop analytics workers</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17798"><span data-slate-object="text" data-key="17799"><span data-slate-leaf="true" data-offset-key="17799:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17800"><span data-slate-leaf="true" data-offset-key="17800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17801"><span data-slate-leaf="true" data-offset-key="17801:0" data-first-offset="true"><span data-slate-string="true"> r.Stop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17802"><span data-slate-object="text" data-key="17803"><span data-slate-leaf="true" data-offset-key="17803:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17804"><span data-slate-object="text" data-key="17805"><span data-slate-leaf="true" data-offset-key="17805:0" data-first-offset="true"><span data-slate-string="true">这里有一点需要你注意，数据上报和数据采集都大量应用了 Go 协程来并发地执行操作，为了防止潜在的并发读写引起的 Bug，建议你的测试程序编译时加上 -race，例如 go build -race cmd/iam-authz-server/authzserver.go。然后，在测试过程中，观察程序日志，看有无并发问题出现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17806"><span data-slate-object="text" data-key="17807"><span data-slate-leaf="true" data-offset-key="17807:0" data-first-offset="true"><span data-slate-string="true">Start 中会开启 poolSize 个数的 worker 协程，这些协程共同消费 recordsChan 中的消息，消费逻辑见 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17808"><span data-slate-object="text" data-key="17809"><span data-slate-leaf="true" data-offset-key="17809:0" data-first-offset="true"><span data-slate-string="true">recordWorker()</span></span></span></a><span data-slate-object="text" data-key="17810"><span data-slate-leaf="true" data-offset-key="17810:0" data-first-offset="true"><span data-slate-string="true"> ，代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17811"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17812"><span data-slate-object="text" data-key="17813"><span data-slate-leaf="true" data-offset-key="17813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17814"><span data-slate-leaf="true" data-offset-key="17814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17815"><span data-slate-leaf="true" data-offset-key="17815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(r *Analytics)</span></span></span></span></span><span data-slate-object="text" data-key="17816"><span data-slate-leaf="true" data-offset-key="17816:0" data-first-offset="true"><span data-slate-string="true"> recordWorker() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17817"><span data-slate-object="text" data-key="17818"><span data-slate-leaf="true" data-offset-key="17818:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17819"><span data-slate-leaf="true" data-offset-key="17819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="17820"><span data-slate-leaf="true" data-offset-key="17820:0" data-first-offset="true"><span data-slate-string="true"> r.poolWg.Done()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17821"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17822"><span data-slate-object="text" data-key="17823"><span data-slate-leaf="true" data-offset-key="17823:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17824"><span data-slate-leaf="true" data-offset-key="17824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// this is buffer to send one pipelined command to redis</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17825"><span data-slate-object="text" data-key="17826"><span data-slate-leaf="true" data-offset-key="17826:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17827"><span data-slate-leaf="true" data-offset-key="17827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// use r.recordsBufferSize as cap to reduce slice re-allocations</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17828"><span data-slate-object="text" data-key="17829"><span data-slate-leaf="true" data-offset-key="17829:0" data-first-offset="true"><span data-slate-string="true">  recordsBuffer := </span></span></span><span data-slate-object="text" data-key="17830"><span data-slate-leaf="true" data-offset-key="17830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17831"><span data-slate-leaf="true" data-offset-key="17831:0" data-first-offset="true"><span data-slate-string="true">([][]</span></span></span><span data-slate-object="text" data-key="17832"><span data-slate-leaf="true" data-offset-key="17832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="17833"><span data-slate-leaf="true" data-offset-key="17833:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="17834"><span data-slate-leaf="true" data-offset-key="17834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17835"><span data-slate-leaf="true" data-offset-key="17835:0" data-first-offset="true"><span data-slate-string="true">, r.workerBufferSize)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17836"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17837"><span data-slate-object="text" data-key="17838"><span data-slate-leaf="true" data-offset-key="17838:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17839"><span data-slate-leaf="true" data-offset-key="17839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// read records from channel and process</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17840"><span data-slate-object="text" data-key="17841"><span data-slate-leaf="true" data-offset-key="17841:0" data-first-offset="true"><span data-slate-string="true">  lastSentTS := time.Now()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17842"><span data-slate-object="text" data-key="17843"><span data-slate-leaf="true" data-offset-key="17843:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="17844"><span data-slate-leaf="true" data-offset-key="17844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="17845"><span data-slate-leaf="true" data-offset-key="17845:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17846"><span data-slate-object="text" data-key="17847"><span data-slate-leaf="true" data-offset-key="17847:0" data-first-offset="true"><span data-slate-string="true">    readyToSend := </span></span></span><span data-slate-object="text" data-key="17848"><span data-slate-leaf="true" data-offset-key="17848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17849"><span data-slate-object="text" data-key="17850"><span data-slate-leaf="true" data-offset-key="17850:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17851"><span data-slate-leaf="true" data-offset-key="17851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="17852"><span data-slate-leaf="true" data-offset-key="17852:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17853"><span data-slate-object="text" data-key="17854"><span data-slate-leaf="true" data-offset-key="17854:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17855"><span data-slate-leaf="true" data-offset-key="17855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="17856"><span data-slate-leaf="true" data-offset-key="17856:0" data-first-offset="true"><span data-slate-string="true"> record, ok := &lt;-r.recordsChan:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17857"><span data-slate-object="text" data-key="17858"><span data-slate-leaf="true" data-offset-key="17858:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17859"><span data-slate-leaf="true" data-offset-key="17859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// check if channel was closed and it is time to exit from worker</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17860"><span data-slate-object="text" data-key="17861"><span data-slate-leaf="true" data-offset-key="17861:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17862"><span data-slate-leaf="true" data-offset-key="17862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17863"><span data-slate-leaf="true" data-offset-key="17863:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17864"><span data-slate-object="text" data-key="17865"><span data-slate-leaf="true" data-offset-key="17865:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17866"><span data-slate-leaf="true" data-offset-key="17866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// send what is left in buffer</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17867"><span data-slate-object="text" data-key="17868"><span data-slate-leaf="true" data-offset-key="17868:0" data-first-offset="true"><span data-slate-string="true">        r.store.AppendToSetPipelined(analyticsKeyName, recordsBuffer)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17869"><span data-slate-object="text" data-key="17870"><span data-slate-leaf="true" data-offset-key="17870:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17871"><span data-slate-leaf="true" data-offset-key="17871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17872"><span data-slate-object="text" data-key="17873"><span data-slate-leaf="true" data-offset-key="17873:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17874"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17875"><span data-slate-object="text" data-key="17876"><span data-slate-leaf="true" data-offset-key="17876:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17877"><span data-slate-leaf="true" data-offset-key="17877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// we have new record - prepare it and add to buffer</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17878"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17879"><span data-slate-object="text" data-key="17880"><span data-slate-leaf="true" data-offset-key="17880:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17881"><span data-slate-leaf="true" data-offset-key="17881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17882"><span data-slate-leaf="true" data-offset-key="17882:0" data-first-offset="true"><span data-slate-string="true"> encoded, err := msgpack.Marshal(record); err != </span></span></span><span data-slate-object="text" data-key="17883"><span data-slate-leaf="true" data-offset-key="17883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17884"><span data-slate-leaf="true" data-offset-key="17884:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17885"><span data-slate-object="text" data-key="17886"><span data-slate-leaf="true" data-offset-key="17886:0" data-first-offset="true"><span data-slate-string="true">        log.Errorf(</span></span></span><span data-slate-object="text" data-key="17887"><span data-slate-leaf="true" data-offset-key="17887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Error encoding analytics data: %s"</span></span></span></span><span data-slate-object="text" data-key="17888"><span data-slate-leaf="true" data-offset-key="17888:0" data-first-offset="true"><span data-slate-string="true">, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17889"><span data-slate-object="text" data-key="17890"><span data-slate-leaf="true" data-offset-key="17890:0" data-first-offset="true"><span data-slate-string="true">      } </span></span></span><span data-slate-object="text" data-key="17891"><span data-slate-leaf="true" data-offset-key="17891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="17892"><span data-slate-leaf="true" data-offset-key="17892:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17893"><span data-slate-object="text" data-key="17894"><span data-slate-leaf="true" data-offset-key="17894:0" data-first-offset="true"><span data-slate-string="true">        recordsBuffer = </span></span></span><span data-slate-object="text" data-key="17895"><span data-slate-leaf="true" data-offset-key="17895:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="17896"><span data-slate-leaf="true" data-offset-key="17896:0" data-first-offset="true"><span data-slate-string="true">(recordsBuffer, encoded)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17897"><span data-slate-object="text" data-key="17898"><span data-slate-leaf="true" data-offset-key="17898:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17899"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17900"><span data-slate-object="text" data-key="17901"><span data-slate-leaf="true" data-offset-key="17901:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17902"><span data-slate-leaf="true" data-offset-key="17902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// identify that buffer is ready to be sent</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17903"><span data-slate-object="text" data-key="17904"><span data-slate-leaf="true" data-offset-key="17904:0" data-first-offset="true"><span data-slate-string="true">      readyToSend = </span></span></span><span data-slate-object="text" data-key="17905"><span data-slate-leaf="true" data-offset-key="17905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span><span data-slate-object="text" data-key="17906"><span data-slate-leaf="true" data-offset-key="17906:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17907"><span data-slate-leaf="true" data-offset-key="17907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17908"><span data-slate-leaf="true" data-offset-key="17908:0" data-first-offset="true"><span data-slate-string="true">(recordsBuffer)) == r.workerBufferSize</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17909"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17910"><span data-slate-object="text" data-key="17911"><span data-slate-leaf="true" data-offset-key="17911:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17912"><span data-slate-leaf="true" data-offset-key="17912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="17913"><span data-slate-leaf="true" data-offset-key="17913:0" data-first-offset="true"><span data-slate-string="true"> &lt;-time.After(r.recordsBufferFlushInterval):</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17914"><span data-slate-object="text" data-key="17915"><span data-slate-leaf="true" data-offset-key="17915:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17916"><span data-slate-leaf="true" data-offset-key="17916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// nothing was received for that period of time</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17917"><span data-slate-object="text" data-key="17918"><span data-slate-leaf="true" data-offset-key="17918:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17919"><span data-slate-leaf="true" data-offset-key="17919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// anyways send whatever we have, don't hold data too long in buffer</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17920"><span data-slate-object="text" data-key="17921"><span data-slate-leaf="true" data-offset-key="17921:0" data-first-offset="true"><span data-slate-string="true">      readyToSend = </span></span></span><span data-slate-object="text" data-key="17922"><span data-slate-leaf="true" data-offset-key="17922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17923"><span data-slate-object="text" data-key="17924"><span data-slate-leaf="true" data-offset-key="17924:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17925"></div><div data-slate-type="code-line" data-slate-object="block" data-key="17926"><span data-slate-object="text" data-key="17927"><span data-slate-leaf="true" data-offset-key="17927:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17928"><span data-slate-leaf="true" data-offset-key="17928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// send data to Redis and reset buffer</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17929"><span data-slate-object="text" data-key="17930"><span data-slate-leaf="true" data-offset-key="17930:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17931"><span data-slate-leaf="true" data-offset-key="17931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17932"><span data-slate-leaf="true" data-offset-key="17932:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17933"><span data-slate-leaf="true" data-offset-key="17933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="17934"><span data-slate-leaf="true" data-offset-key="17934:0" data-first-offset="true"><span data-slate-string="true">(recordsBuffer) &gt; </span></span></span><span data-slate-object="text" data-key="17935"><span data-slate-leaf="true" data-offset-key="17935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17936"><span data-slate-leaf="true" data-offset-key="17936:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; (readyToSend || time.Since(lastSentTS) &gt;= recordsBufferForcedFlushInterval) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17937"><span data-slate-object="text" data-key="17938"><span data-slate-leaf="true" data-offset-key="17938:0" data-first-offset="true"><span data-slate-string="true">      r.store.AppendToSetPipelined(analyticsKeyName, recordsBuffer)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17939"><span data-slate-object="text" data-key="17940"><span data-slate-leaf="true" data-offset-key="17940:0" data-first-offset="true"><span data-slate-string="true">      recordsBuffer = recordsBuffer[:</span></span></span><span data-slate-object="text" data-key="17941"><span data-slate-leaf="true" data-offset-key="17941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17942"><span data-slate-leaf="true" data-offset-key="17942:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17943"><span data-slate-object="text" data-key="17944"><span data-slate-leaf="true" data-offset-key="17944:0" data-first-offset="true"><span data-slate-string="true">      lastSentTS = time.Now()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17945"><span data-slate-object="text" data-key="17946"><span data-slate-leaf="true" data-offset-key="17946:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17947"><span data-slate-object="text" data-key="17948"><span data-slate-leaf="true" data-offset-key="17948:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17949"><span data-slate-object="text" data-key="17950"><span data-slate-leaf="true" data-offset-key="17950:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17951"><span data-slate-object="text" data-key="17952"><span data-slate-leaf="true" data-offset-key="17952:0" data-first-offset="true"><span data-slate-string="true">recordWorker 函数会将接收到的授权日志保存在 recordsBuffer 切片中，当数组内元素个数为 workerBufferSize ，或者距离上一次投递时间间隔为 recordsBufferFlushInterval 时，就会将 recordsBuffer 数组中的数据上报给目标系统（Input）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17953"><span data-slate-object="text" data-key="17954"><span data-slate-leaf="true" data-offset-key="17954:0" data-first-offset="true"><span data-slate-string="true">recordWorker () 中有些设计技巧，很值得你参考。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17955"><div data-slate-type="list-line" data-slate-object="block" data-key="17956"><span data-slate-object="text" data-key="17957"><span data-slate-leaf="true" data-offset-key="17957:0" data-first-offset="true"><span data-slate-string="true">使用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17958"><span data-slate-object="text" data-key="17959"><span data-slate-leaf="true" data-offset-key="17959:0" data-first-offset="true"><span data-slate-string="true">msgpack</span></span></span></a><span data-slate-object="text" data-key="17960"><span data-slate-leaf="true" data-offset-key="17960:0" data-first-offset="true"><span data-slate-string="true"> 序列化消息：msgpack 是一个高效的二进制序列化格式。它像 JSON 一样，让你可以在各种语言之间交换数据。但是它比 JSON 更快、更小。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17961"><span data-slate-object="text" data-key="17962"><span data-slate-leaf="true" data-offset-key="17962:0" data-first-offset="true"><span data-slate-string="true">支持 Batch Windows：当 worker 的消息数达到指定阈值时，会批量投递消息给 Redis，阈值判断代码为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17963"><span data-slate-object="text" data-key="17964"><span data-slate-leaf="true" data-offset-key="17964:0" data-first-offset="true"><span data-slate-string="true"> readyToSend = uint64(len(recordsBuffer)) == r.workerBufferSize</span></span></span></span><span data-slate-object="text" data-key="17965"><span data-slate-leaf="true" data-offset-key="17965:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17966"><span data-slate-object="text" data-key="17967"><span data-slate-leaf="true" data-offset-key="17967:0" data-first-offset="true"><span data-slate-string="true">超时投递：为了避免因为产生消息太慢，一直达不到 Batch Windows，无法投递消息这种情况，投递逻辑也支持超时投递，通过 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17968"><span data-slate-object="text" data-key="17969"><span data-slate-leaf="true" data-offset-key="17969:0" data-first-offset="true"><span data-slate-string="true">case &lt;-time.After(r.recordsBufferFlushInterval)</span></span></span></span><span data-slate-object="text" data-key="17970"><span data-slate-leaf="true" data-offset-key="17970:0" data-first-offset="true"><span data-slate-string="true"> 代码段实现。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="17971"><span data-slate-object="text" data-key="17972"><span data-slate-leaf="true" data-offset-key="17972:0" data-first-offset="true"><span data-slate-string="true">支持优雅关停：当 recordsChan 关闭时，将 recordsBuffer 中的消息批量投递给 Redis，之后退出 worker 协程。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17973"><span data-slate-object="text" data-key="17974"><span data-slate-leaf="true" data-offset-key="17974:0" data-first-offset="true"><span data-slate-string="true">这里有个注意事项：投递完成后，你需要重置 recordsBuffer 和计时器，否则会重复投递数据：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17975"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17976"><span data-slate-object="text" data-key="17977"><span data-slate-leaf="true" data-offset-key="17977:0" data-first-offset="true"><span data-slate-string="true">recordsBuffer = recordsBuffer[:</span></span></span><span data-slate-object="text" data-key="17978"><span data-slate-leaf="true" data-offset-key="17978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17979"><span data-slate-leaf="true" data-offset-key="17979:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17980"><span data-slate-object="text" data-key="17981"><span data-slate-leaf="true" data-offset-key="17981:0" data-first-offset="true"><span data-slate-string="true">lastSentTS = time.Now()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17982"><span data-slate-object="text" data-key="17983"><span data-slate-leaf="true" data-offset-key="17983:0" data-first-offset="true"><span data-slate-string="true">这里还设置了一个最大的超时时间 recordsBufferForcedFlushInterval，确保消息最迟被投递的时间间隔。也就是说， iam-authz-server 强制要求最大投递间隔为 recordsBufferForcedFlushInterval 秒，这是为了防止配置文件将 recordsBufferFlushInterval 设得过大。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17984" id="sr-toc-10"><span data-slate-object="text" data-key="17985"><span data-slate-leaf="true" data-offset-key="17985:0" data-first-offset="true"><span data-slate-string="true">运行服务：异步上报授权日志</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17986"><span data-slate-object="text" data-key="17987"><span data-slate-leaf="true" data-offset-key="17987:0" data-first-offset="true"><span data-slate-string="true">开启了数据上报服务后，当有授权日志产生时，程序就会自动上报数据。接下来，我会详细介绍下如何高效上报数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17988"><span data-slate-object="text" data-key="17989"><span data-slate-leaf="true" data-offset-key="17989:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 会在授权成功时调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17990"><span data-slate-object="text" data-key="17991"><span data-slate-leaf="true" data-offset-key="17991:0" data-first-offset="true"><span data-slate-string="true">LogGrantedAccessRequest</span></span></span></a><span data-slate-object="text" data-key="17992"><span data-slate-leaf="true" data-offset-key="17992:0" data-first-offset="true"><span data-slate-string="true"> 函数，在授权失败时调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17993"><span data-slate-object="text" data-key="17994"><span data-slate-leaf="true" data-offset-key="17994:0" data-first-offset="true"><span data-slate-string="true">LogRejectedAccessRequest</span></span></span></a><span data-slate-object="text" data-key="17995"><span data-slate-leaf="true" data-offset-key="17995:0" data-first-offset="true"><span data-slate-string="true"> 函数。并且，在这两个函数中，调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17996"><span data-slate-object="text" data-key="17997"><span data-slate-leaf="true" data-offset-key="17997:0" data-first-offset="true"><span data-slate-string="true">RecordHit </span></span></span></a><span data-slate-object="text" data-key="17998"><span data-slate-leaf="true" data-offset-key="17998:0" data-first-offset="true"><span data-slate-string="true">函数，记录授权日志。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17999"><span data-slate-object="text" data-key="18000"><span data-slate-leaf="true" data-offset-key="18000:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 通过调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18001"><span data-slate-object="text" data-key="18002"><span data-slate-leaf="true" data-offset-key="18002:0" data-first-offset="true"><span data-slate-string="true">RecordHit(record *AnalyticsRecord) error</span></span></span></a><span data-slate-object="text" data-key="18003"><span data-slate-leaf="true" data-offset-key="18003:0" data-first-offset="true"><span data-slate-string="true"> 函数，异步缓存授权日志。调用 RecordHit 后，会将 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18004"><span data-slate-object="text" data-key="18005"><span data-slate-leaf="true" data-offset-key="18005:0" data-first-offset="true"><span data-slate-string="true">AnalyticsRecord</span></span></span></a><span data-slate-object="text" data-key="18006"><span data-slate-leaf="true" data-offset-key="18006:0" data-first-offset="true"><span data-slate-string="true"> 类型的消息存放到 recordsChan 有缓冲 channel 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18007"><span data-slate-object="text" data-key="18008"><span data-slate-leaf="true" data-offset-key="18008:0" data-first-offset="true"><span data-slate-string="true">这里要注意：在缓存前，需要判断上报服务是否在优雅关停中，如果在关停中，则丢弃该消息：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18009"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18010"><span data-slate-object="text" data-key="18011"><span data-slate-leaf="true" data-offset-key="18011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18012"><span data-slate-leaf="true" data-offset-key="18012:0" data-first-offset="true"><span data-slate-string="true"> atomic.LoadUint32(&amp;r.shouldStop) &gt; </span></span></span><span data-slate-object="text" data-key="18013"><span data-slate-leaf="true" data-offset-key="18013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18014"><span data-slate-leaf="true" data-offset-key="18014:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18015"><span data-slate-object="text" data-key="18016"><span data-slate-leaf="true" data-offset-key="18016:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18017"><span data-slate-leaf="true" data-offset-key="18017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18018"><span data-slate-leaf="true" data-offset-key="18018:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18019"><span data-slate-leaf="true" data-offset-key="18019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18020"><span data-slate-object="text" data-key="18021"><span data-slate-leaf="true" data-offset-key="18021:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18022"><span data-slate-object="text" data-key="18023"><span data-slate-leaf="true" data-offset-key="18023:0" data-first-offset="true"><span data-slate-string="true">通过将授权日志缓写入 recordsChan 有缓冲 channel 中，LogGrantedAccessRequest 和 LogRejectedAccessRequest 函数可以不用等待授权日志上报成功就返回，这样就使得整个授权请求的性能损耗几乎为零。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18024" id="sr-toc-11"><span data-slate-object="text" data-key="18025"><span data-slate-leaf="true" data-offset-key="18025:0" data-first-offset="true"><span data-slate-string="true">关停服务：优雅关停数据上报</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18026"><span data-slate-object="text" data-key="18027"><span data-slate-leaf="true" data-offset-key="18027:0" data-first-offset="true"><span data-slate-string="true">完成数据上报之后的下一步，就是要优雅地将数据上报关停。为了确保在应用关停时，缓存中的数据和正在投递中的数据都能够投递到 Redis，iam-authz-server 实现了数据上报关停功能，代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18028"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18029"><span data-slate-object="text" data-key="18030"><span data-slate-leaf="true" data-offset-key="18030:0" data-first-offset="true"><span data-slate-string="true">gs.AddShutdownCallback(shutdown.ShutdownFunc(</span></span></span><span data-slate-object="text" data-key="18031"><span data-slate-leaf="true" data-offset-key="18031:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18032"><span data-slate-leaf="true" data-offset-key="18032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="18033"><span data-slate-leaf="true" data-offset-key="18033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="18034"><span data-slate-leaf="true" data-offset-key="18034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="18035"><span data-slate-leaf="true" data-offset-key="18035:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18036"><span data-slate-leaf="true" data-offset-key="18036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="18037"><span data-slate-leaf="true" data-offset-key="18037:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18038"><span data-slate-object="text" data-key="18039"><span data-slate-leaf="true" data-offset-key="18039:0" data-first-offset="true"><span data-slate-string="true">    analyticsIns.Stop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18040"><span data-slate-object="text" data-key="18041"><span data-slate-leaf="true" data-offset-key="18041:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18042"><span data-slate-leaf="true" data-offset-key="18042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18043"><span data-slate-leaf="true" data-offset-key="18043:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18044"><span data-slate-leaf="true" data-offset-key="18044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18045"><span data-slate-object="text" data-key="18046"><span data-slate-leaf="true" data-offset-key="18046:0" data-first-offset="true"><span data-slate-string="true">}))</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18047"><span data-slate-object="text" data-key="18048"><span data-slate-leaf="true" data-offset-key="18048:0" data-first-offset="true"><span data-slate-string="true">当收到 os.Interrupt 和 syscall.SIGTERM 系统信号后，调用 analyticsIns.Stop () 函数，关停数据上报服务， </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18049"><span data-slate-object="text" data-key="18050"><span data-slate-leaf="true" data-offset-key="18050:0" data-first-offset="true"><span data-slate-string="true">Stop</span></span></span></a><span data-slate-object="text" data-key="18051"><span data-slate-leaf="true" data-offset-key="18051:0" data-first-offset="true"><span data-slate-string="true"> 函数会停止接收新的授权日志，并等待正在上报的数据上报完成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18052"><span data-slate-object="text" data-key="18053"><span data-slate-leaf="true" data-offset-key="18053:0" data-first-offset="true"><span data-slate-string="true">上面我介绍了数据上报部分的功能设计，接下来，我来介绍下数据采集部分的功能设计。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18054" id="sr-toc-12"><span data-slate-object="text" data-key="18055"><span data-slate-leaf="true" data-offset-key="18055:0" data-first-offset="true"><span data-slate-string="true">iam-pump：数据采集</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18056"><span data-slate-object="text" data-key="18057"><span data-slate-leaf="true" data-offset-key="18057:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 将数据上报到 Redis，iam-pump 消费 Redis 中的数据，并保存在 MongoDB 中做持久化存储。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18058"><span data-slate-object="text" data-key="18059"><span data-slate-leaf="true" data-offset-key="18059:0" data-first-offset="true"><span data-slate-string="true">iam-pump 的设计要点是：插件化、可配置地将 Redis 中的数据处理后存储到下游系统中，并且实现优雅关停功能，这些也是设计数据采集程序的要点和难点所在。下面，我们就来看下 iam-pump 是如何插件化地实现一个数据采集程序的。这个数据采集程序的设计思路，在我开发的大型企业应用中有实际的落地验证，你可以放心使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18060"><span data-slate-object="text" data-key="18061"><span data-slate-leaf="true" data-offset-key="18061:0" data-first-offset="true"><span data-slate-string="true">iam-pump 数据采集架构如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18062"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/91/ed/913b92d58cfd7cba0dff26612be9e9ed.jpg?wh=1920x1129"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18063"><span data-slate-object="text" data-key="18064"><span data-slate-leaf="true" data-offset-key="18064:0" data-first-offset="true"><span data-slate-string="true">在 iam-pump 服务启动时，要启动数据采集功能，启动代码见 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18065"><span data-slate-object="text" data-key="18066"><span data-slate-leaf="true" data-offset-key="18066:0" data-first-offset="true"><span data-slate-string="true">internal/pump/server.go</span></span></span></a><span data-slate-object="text" data-key="18067"><span data-slate-leaf="true" data-offset-key="18067:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18068"><span data-slate-object="text" data-key="18069"><span data-slate-leaf="true" data-offset-key="18069:0" data-first-offset="true"><span data-slate-string="true">接下来，我会介绍下 iam-pump 服务中的 5 部分核心代码：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18070"><div data-slate-type="list-line" data-slate-object="block" data-key="18071"><span data-slate-object="text" data-key="18072"><span data-slate-leaf="true" data-offset-key="18072:0" data-first-offset="true"><span data-slate-string="true">数据采集插件定义。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18073"><span data-slate-object="text" data-key="18074"><span data-slate-leaf="true" data-offset-key="18074:0" data-first-offset="true"><span data-slate-string="true">初始化数据采集插件。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18075"><span data-slate-object="text" data-key="18076"><span data-slate-leaf="true" data-offset-key="18076:0" data-first-offset="true"><span data-slate-string="true">健康检查。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18077"><span data-slate-object="text" data-key="18078"><span data-slate-leaf="true" data-offset-key="18078:0" data-first-offset="true"><span data-slate-string="true">启动 Loop 周期性消费 Redis 数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18079"><span data-slate-object="text" data-key="18080"><span data-slate-leaf="true" data-offset-key="18080:0" data-first-offset="true"><span data-slate-string="true">优雅关停数据采集服务。</span></span></span></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18081" id="sr-toc-13"><span data-slate-object="text" data-key="18082"><span data-slate-leaf="true" data-offset-key="18082:0" data-first-offset="true"><span data-slate-string="true">初始化服务：数据采集插件定义</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18083"><span data-slate-object="text" data-key="18084"><span data-slate-leaf="true" data-offset-key="18084:0" data-first-offset="true"><span data-slate-string="true">数据采集组件设计的核心是插件化，这里我</span></span></span><span data-slate-object="text" data-key="18085"><span data-slate-leaf="true" data-offset-key="18085:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">将需要上报的系统抽象成一个个的 pump</span></span></span></span><span data-slate-object="text" data-key="18086"><span data-slate-leaf="true" data-offset-key="18086:0" data-first-offset="true"><span data-slate-string="true">，那么如何定义 pump 接口呢？接口定义需要参考实际的采集需求，通常来说，至少需要下面这几个函数。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18087"><div data-slate-type="list-line" data-slate-object="block" data-key="18088"><span data-slate-object="text" data-key="18089"><span data-slate-leaf="true" data-offset-key="18089:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">New：</span></span></span></span><span data-slate-object="text" data-key="18090"><span data-slate-leaf="true" data-offset-key="18090:0" data-first-offset="true"><span data-slate-string="true">创建一个 pump。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18091"><span data-slate-object="text" data-key="18092"><span data-slate-leaf="true" data-offset-key="18092:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Init：</span></span></span></span><span data-slate-object="text" data-key="18093"><span data-slate-leaf="true" data-offset-key="18093:0" data-first-offset="true"><span data-slate-string="true">初始化一个 pump，例如，可以在 Init 中创建下游系统的网络连接。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18094"><span data-slate-object="text" data-key="18095"><span data-slate-leaf="true" data-offset-key="18095:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">WriteData：</span></span></span></span><span data-slate-object="text" data-key="18096"><span data-slate-leaf="true" data-offset-key="18096:0" data-first-offset="true"><span data-slate-string="true">往下游系统写入数据。为了提高性能，最好支持批量写入。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18097"><span data-slate-object="text" data-key="18098"><span data-slate-leaf="true" data-offset-key="18098:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">SetFilters：</span></span></span></span><span data-slate-object="text" data-key="18099"><span data-slate-leaf="true" data-offset-key="18099:0" data-first-offset="true"><span data-slate-string="true">设置是否过滤某条数据，这也是一个非常常见的需求，因为不是所有的数据都是需要的。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18100"><span data-slate-object="text" data-key="18101"><span data-slate-leaf="true" data-offset-key="18101:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">SetTimeout：</span></span></span></span><span data-slate-object="text" data-key="18102"><span data-slate-leaf="true" data-offset-key="18102:0" data-first-offset="true"><span data-slate-string="true">设置超时时间。我就在开发过程中遇到过一个坑，连接 Kafka 超时，导致整个采集程序超时。所以这里需要有超时处理，通过超时处理，可以保证整个采集框架正常运行。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18103"><span data-slate-object="text" data-key="18104"><span data-slate-leaf="true" data-offset-key="18104:0" data-first-offset="true"><span data-slate-string="true">我之前开发过公有云的网关服务，网关服务需要把网关的请求数据转存到 MongoDB 中。我们的网关服务曾经遇到一个比较大的坑：有些用户会通过网关上传非常大的文件（百 M 级别），这些数据转存到 MongoDB 中，快速消耗了 MongoDB 的存储空间（500G 存储空间）。为了避免这个问题，在转存数据时，需要过滤掉一些比较详细的数据，所以 iam-pump 添加了 SetOmitDetailedRecording 来过滤掉详细的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18105"><span data-slate-object="text" data-key="18106"><span data-slate-leaf="true" data-offset-key="18106:0" data-first-offset="true"><span data-slate-string="true">所以，最后 iam-pump 的插件接口定义为 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18107"><span data-slate-object="text" data-key="18108"><span data-slate-leaf="true" data-offset-key="18108:0" data-first-offset="true"><span data-slate-string="true">internal/pump/pumps/pump.go</span></span></span></a><span data-slate-object="text" data-key="18109"><span data-slate-leaf="true" data-offset-key="18109:0" data-first-offset="true"><span data-slate-string="true"> ：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18110"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18111"><span data-slate-object="text" data-key="18112"><span data-slate-leaf="true" data-offset-key="18112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="18113"><span data-slate-leaf="true" data-offset-key="18113:0" data-first-offset="true"><span data-slate-string="true"> Pump </span></span></span><span data-slate-object="text" data-key="18114"><span data-slate-leaf="true" data-offset-key="18114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="18115"><span data-slate-leaf="true" data-offset-key="18115:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18116"><span data-slate-object="text" data-key="18117"><span data-slate-leaf="true" data-offset-key="18117:0" data-first-offset="true"><span data-slate-string="true">  GetName() </span></span></span><span data-slate-object="text" data-key="18118"><span data-slate-leaf="true" data-offset-key="18118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18119"><span data-slate-object="text" data-key="18120"><span data-slate-leaf="true" data-offset-key="18120:0" data-first-offset="true"><span data-slate-string="true">  New() Pump</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18121"><span data-slate-object="text" data-key="18122"><span data-slate-leaf="true" data-offset-key="18122:0" data-first-offset="true"><span data-slate-string="true">  Init(</span></span></span><span data-slate-object="text" data-key="18123"><span data-slate-leaf="true" data-offset-key="18123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="18124"><span data-slate-leaf="true" data-offset-key="18124:0" data-first-offset="true"><span data-slate-string="true">{}) </span></span></span><span data-slate-object="text" data-key="18125"><span data-slate-leaf="true" data-offset-key="18125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18126"><span data-slate-object="text" data-key="18127"><span data-slate-leaf="true" data-offset-key="18127:0" data-first-offset="true"><span data-slate-string="true">  WriteData(context.Context, []</span></span></span><span data-slate-object="text" data-key="18128"><span data-slate-leaf="true" data-offset-key="18128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="18129"><span data-slate-leaf="true" data-offset-key="18129:0" data-first-offset="true"><span data-slate-string="true">{}) </span></span></span><span data-slate-object="text" data-key="18130"><span data-slate-leaf="true" data-offset-key="18130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18131"><span data-slate-object="text" data-key="18132"><span data-slate-leaf="true" data-offset-key="18132:0" data-first-offset="true"><span data-slate-string="true">  SetFilters(analytics.AnalyticsFilters)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18133"><span data-slate-object="text" data-key="18134"><span data-slate-leaf="true" data-offset-key="18134:0" data-first-offset="true"><span data-slate-string="true">  GetFilters() analytics.AnalyticsFilters</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18135"><span data-slate-object="text" data-key="18136"><span data-slate-leaf="true" data-offset-key="18136:0" data-first-offset="true"><span data-slate-string="true">  SetTimeout(timeout </span></span></span><span data-slate-object="text" data-key="18137"><span data-slate-leaf="true" data-offset-key="18137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="18138"><span data-slate-leaf="true" data-offset-key="18138:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18139"><span data-slate-object="text" data-key="18140"><span data-slate-leaf="true" data-offset-key="18140:0" data-first-offset="true"><span data-slate-string="true">  GetTimeout() </span></span></span><span data-slate-object="text" data-key="18141"><span data-slate-leaf="true" data-offset-key="18141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18142"><span data-slate-object="text" data-key="18143"><span data-slate-leaf="true" data-offset-key="18143:0" data-first-offset="true"><span data-slate-string="true">  SetOmitDetailedRecording(</span></span></span><span data-slate-object="text" data-key="18144"><span data-slate-leaf="true" data-offset-key="18144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="18145"><span data-slate-leaf="true" data-offset-key="18145:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18146"><span data-slate-object="text" data-key="18147"><span data-slate-leaf="true" data-offset-key="18147:0" data-first-offset="true"><span data-slate-string="true">  GetOmitDetailedRecording() </span></span></span><span data-slate-object="text" data-key="18148"><span data-slate-leaf="true" data-offset-key="18148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18149"><span data-slate-object="text" data-key="18150"><span data-slate-leaf="true" data-offset-key="18150:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18151"><span data-slate-object="text" data-key="18152"><span data-slate-leaf="true" data-offset-key="18152:0" data-first-offset="true"><span data-slate-string="true">你在实际开发中，如果有更多的需求，可以在 Pump interface 定义中继续添加需要的处理函数。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18153" id="sr-toc-14"><span data-slate-object="text" data-key="18154"><span data-slate-leaf="true" data-offset-key="18154:0" data-first-offset="true"><span data-slate-string="true">初始化服务：初始化数据采集插件</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18155"><span data-slate-object="text" data-key="18156"><span data-slate-leaf="true" data-offset-key="18156:0" data-first-offset="true"><span data-slate-string="true">定义好插件之后，需要初始化插件。在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18157"><span data-slate-object="text" data-key="18158"><span data-slate-leaf="true" data-offset-key="18158:0" data-first-offset="true"><span data-slate-string="true">initialize</span></span></span></a><span data-slate-object="text" data-key="18159"><span data-slate-leaf="true" data-offset-key="18159:0" data-first-offset="true"><span data-slate-string="true"> 函数中初始化 pumps：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18160"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18161"><span data-slate-object="text" data-key="18162"><span data-slate-leaf="true" data-offset-key="18162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18163"><span data-slate-leaf="true" data-offset-key="18163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18164"><span data-slate-leaf="true" data-offset-key="18164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *pumpServer)</span></span></span></span></span><span data-slate-object="text" data-key="18165"><span data-slate-leaf="true" data-offset-key="18165:0" data-first-offset="true"><span data-slate-string="true"> initialize() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18166"><span data-slate-object="text" data-key="18167"><span data-slate-leaf="true" data-offset-key="18167:0" data-first-offset="true"><span data-slate-string="true">  pmps = </span></span></span><span data-slate-object="text" data-key="18168"><span data-slate-leaf="true" data-offset-key="18168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="18169"><span data-slate-leaf="true" data-offset-key="18169:0" data-first-offset="true"><span data-slate-string="true">([]pumps.Pump, </span></span></span><span data-slate-object="text" data-key="18170"><span data-slate-leaf="true" data-offset-key="18170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="18171"><span data-slate-leaf="true" data-offset-key="18171:0" data-first-offset="true"><span data-slate-string="true">(s.pumps))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18172"><span data-slate-object="text" data-key="18173"><span data-slate-leaf="true" data-offset-key="18173:0" data-first-offset="true"><span data-slate-string="true">  i := </span></span></span><span data-slate-object="text" data-key="18174"><span data-slate-leaf="true" data-offset-key="18174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18175"><span data-slate-object="text" data-key="18176"><span data-slate-leaf="true" data-offset-key="18176:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18177"><span data-slate-leaf="true" data-offset-key="18177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18178"><span data-slate-leaf="true" data-offset-key="18178:0" data-first-offset="true"><span data-slate-string="true"> key, pmp := </span></span></span><span data-slate-object="text" data-key="18179"><span data-slate-leaf="true" data-offset-key="18179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="18180"><span data-slate-leaf="true" data-offset-key="18180:0" data-first-offset="true"><span data-slate-string="true"> s.pumps {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18181"><span data-slate-object="text" data-key="18182"><span data-slate-leaf="true" data-offset-key="18182:0" data-first-offset="true"><span data-slate-string="true">    pumpTypeName := pmp.Type</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18183"><span data-slate-object="text" data-key="18184"><span data-slate-leaf="true" data-offset-key="18184:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18185"><span data-slate-leaf="true" data-offset-key="18185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18186"><span data-slate-leaf="true" data-offset-key="18186:0" data-first-offset="true"><span data-slate-string="true"> pumpTypeName == </span></span></span><span data-slate-object="text" data-key="18187"><span data-slate-leaf="true" data-offset-key="18187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="18188"><span data-slate-leaf="true" data-offset-key="18188:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18189"><span data-slate-object="text" data-key="18190"><span data-slate-leaf="true" data-offset-key="18190:0" data-first-offset="true"><span data-slate-string="true">      pumpTypeName = key</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18191"><span data-slate-object="text" data-key="18192"><span data-slate-leaf="true" data-offset-key="18192:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18193"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18194"><span data-slate-object="text" data-key="18195"><span data-slate-leaf="true" data-offset-key="18195:0" data-first-offset="true"><span data-slate-string="true">    pmpType, err := pumps.GetPumpByName(pumpTypeName)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18196"><span data-slate-object="text" data-key="18197"><span data-slate-leaf="true" data-offset-key="18197:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18198"><span data-slate-leaf="true" data-offset-key="18198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18199"><span data-slate-leaf="true" data-offset-key="18199:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="18200"><span data-slate-leaf="true" data-offset-key="18200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18201"><span data-slate-leaf="true" data-offset-key="18201:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18202"><span data-slate-object="text" data-key="18203"><span data-slate-leaf="true" data-offset-key="18203:0" data-first-offset="true"><span data-slate-string="true">      log.Errorf(</span></span></span><span data-slate-object="text" data-key="18204"><span data-slate-leaf="true" data-offset-key="18204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Pump load error (skipping): %s"</span></span></span></span><span data-slate-object="text" data-key="18205"><span data-slate-leaf="true" data-offset-key="18205:0" data-first-offset="true"><span data-slate-string="true">, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18206"><span data-slate-object="text" data-key="18207"><span data-slate-leaf="true" data-offset-key="18207:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="18208"><span data-slate-leaf="true" data-offset-key="18208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="18209"><span data-slate-leaf="true" data-offset-key="18209:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18210"><span data-slate-object="text" data-key="18211"><span data-slate-leaf="true" data-offset-key="18211:0" data-first-offset="true"><span data-slate-string="true">      pmpIns := pmpType.New()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18212"><span data-slate-object="text" data-key="18213"><span data-slate-leaf="true" data-offset-key="18213:0" data-first-offset="true"><span data-slate-string="true">      initErr := pmpIns.Init(pmp.Meta)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18214"><span data-slate-object="text" data-key="18215"><span data-slate-leaf="true" data-offset-key="18215:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18216"><span data-slate-leaf="true" data-offset-key="18216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18217"><span data-slate-leaf="true" data-offset-key="18217:0" data-first-offset="true"><span data-slate-string="true"> initErr != </span></span></span><span data-slate-object="text" data-key="18218"><span data-slate-leaf="true" data-offset-key="18218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18219"><span data-slate-leaf="true" data-offset-key="18219:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18220"><span data-slate-object="text" data-key="18221"><span data-slate-leaf="true" data-offset-key="18221:0" data-first-offset="true"><span data-slate-string="true">        log.Errorf(</span></span></span><span data-slate-object="text" data-key="18222"><span data-slate-leaf="true" data-offset-key="18222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Pump init error (skipping): %s"</span></span></span></span><span data-slate-object="text" data-key="18223"><span data-slate-leaf="true" data-offset-key="18223:0" data-first-offset="true"><span data-slate-string="true">, initErr.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18224"><span data-slate-object="text" data-key="18225"><span data-slate-leaf="true" data-offset-key="18225:0" data-first-offset="true"><span data-slate-string="true">      } </span></span></span><span data-slate-object="text" data-key="18226"><span data-slate-leaf="true" data-offset-key="18226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="18227"><span data-slate-leaf="true" data-offset-key="18227:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18228"><span data-slate-object="text" data-key="18229"><span data-slate-leaf="true" data-offset-key="18229:0" data-first-offset="true"><span data-slate-string="true">        log.Infof(</span></span></span><span data-slate-object="text" data-key="18230"><span data-slate-leaf="true" data-offset-key="18230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Init Pump: %s"</span></span></span></span><span data-slate-object="text" data-key="18231"><span data-slate-leaf="true" data-offset-key="18231:0" data-first-offset="true"><span data-slate-string="true">, pmpIns.GetName())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18232"><span data-slate-object="text" data-key="18233"><span data-slate-leaf="true" data-offset-key="18233:0" data-first-offset="true"><span data-slate-string="true">        pmpIns.SetFilters(pmp.Filters)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18234"><span data-slate-object="text" data-key="18235"><span data-slate-leaf="true" data-offset-key="18235:0" data-first-offset="true"><span data-slate-string="true">        pmpIns.SetTimeout(pmp.Timeout)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18236"><span data-slate-object="text" data-key="18237"><span data-slate-leaf="true" data-offset-key="18237:0" data-first-offset="true"><span data-slate-string="true">        pmpIns.SetOmitDetailedRecording(pmp.OmitDetailedRecording)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18238"><span data-slate-object="text" data-key="18239"><span data-slate-leaf="true" data-offset-key="18239:0" data-first-offset="true"><span data-slate-string="true">        pmps[i] = pmpIns</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18240"><span data-slate-object="text" data-key="18241"><span data-slate-leaf="true" data-offset-key="18241:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18242"><span data-slate-object="text" data-key="18243"><span data-slate-leaf="true" data-offset-key="18243:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18244"><span data-slate-object="text" data-key="18245"><span data-slate-leaf="true" data-offset-key="18245:0" data-first-offset="true"><span data-slate-string="true">    i++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18246"><span data-slate-object="text" data-key="18247"><span data-slate-leaf="true" data-offset-key="18247:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18248"><span data-slate-object="text" data-key="18249"><span data-slate-leaf="true" data-offset-key="18249:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18250"><span data-slate-object="text" data-key="18251"><span data-slate-leaf="true" data-offset-key="18251:0" data-first-offset="true"><span data-slate-string="true">initialize 会创建、初始化，并调用 SetFilters、SetTimeout、SetOmitDetailedRecording 来设置这些 pump。Filters、Timeout、OmitDetailedRecording 等信息在 pump 的配置文件中指定。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18252"><span data-slate-object="text" data-key="18253"><span data-slate-leaf="true" data-offset-key="18253:0" data-first-offset="true"><span data-slate-string="true">这里有个技巧你也可以注意下：pump 配置文件支持通用的配置，也支持自定义的配置，配置结构为 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18254"><span data-slate-object="text" data-key="18255"><span data-slate-leaf="true" data-offset-key="18255:0" data-first-offset="true"><span data-slate-string="true">PumpConfig</span></span></span></a><span data-slate-object="text" data-key="18256"><span data-slate-leaf="true" data-offset-key="18256:0" data-first-offset="true"><span data-slate-string="true"> ：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18257"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18258"><span data-slate-object="text" data-key="18259"><span data-slate-leaf="true" data-offset-key="18259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="18260"><span data-slate-leaf="true" data-offset-key="18260:0" data-first-offset="true"><span data-slate-string="true"> PumpConfig </span></span></span><span data-slate-object="text" data-key="18261"><span data-slate-leaf="true" data-offset-key="18261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="18262"><span data-slate-leaf="true" data-offset-key="18262:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18263"><span data-slate-object="text" data-key="18264"><span data-slate-leaf="true" data-offset-key="18264:0" data-first-offset="true"><span data-slate-string="true">  Type                  </span></span></span><span data-slate-object="text" data-key="18265"><span data-slate-leaf="true" data-offset-key="18265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18266"><span data-slate-object="text" data-key="18267"><span data-slate-leaf="true" data-offset-key="18267:0" data-first-offset="true"><span data-slate-string="true">  Filters               analytics.AnalyticsFilters</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18268"><span data-slate-object="text" data-key="18269"><span data-slate-leaf="true" data-offset-key="18269:0" data-first-offset="true"><span data-slate-string="true">  Timeout               </span></span></span><span data-slate-object="text" data-key="18270"><span data-slate-leaf="true" data-offset-key="18270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18271"><span data-slate-object="text" data-key="18272"><span data-slate-leaf="true" data-offset-key="18272:0" data-first-offset="true"><span data-slate-string="true">  OmitDetailedRecording </span></span></span><span data-slate-object="text" data-key="18273"><span data-slate-leaf="true" data-offset-key="18273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18274"><span data-slate-object="text" data-key="18275"><span data-slate-leaf="true" data-offset-key="18275:0" data-first-offset="true"><span data-slate-string="true">  Meta                  </span></span></span><span data-slate-object="text" data-key="18276"><span data-slate-leaf="true" data-offset-key="18276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="18277"><span data-slate-leaf="true" data-offset-key="18277:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="18278"><span data-slate-leaf="true" data-offset-key="18278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="18279"><span data-slate-leaf="true" data-offset-key="18279:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="18280"><span data-slate-leaf="true" data-offset-key="18280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="18281"><span data-slate-leaf="true" data-offset-key="18281:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18282"><span data-slate-object="text" data-key="18283"><span data-slate-leaf="true" data-offset-key="18283:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18284"><span data-slate-object="text" data-key="18285"><span data-slate-leaf="true" data-offset-key="18285:0" data-first-offset="true"><span data-slate-string="true">pump 自定义的配置可以存放在 map 类型的变量 Meta 中。通用配置可以使配置共享，减少开发和维护工作量，自定义配置可以适配不同 pump 的差异化配置。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18286" id="sr-toc-15"><span data-slate-object="text" data-key="18287"><span data-slate-leaf="true" data-offset-key="18287:0" data-first-offset="true"><span data-slate-string="true">初始化服务：健康检查</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18288"><span data-slate-object="text" data-key="18289"><span data-slate-leaf="true" data-offset-key="18289:0" data-first-offset="true"><span data-slate-string="true">因为 iam-pump 是一个非 API 服务，为了监控其运行状态，这里也设置了一个健康检查接口。iam-pump 组件通过调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18290"><span data-slate-object="text" data-key="18291"><span data-slate-leaf="true" data-offset-key="18291:0" data-first-offset="true"><span data-slate-string="true">server.ServeHealthCheck</span></span></span></a><span data-slate-object="text" data-key="18292"><span data-slate-leaf="true" data-offset-key="18292:0" data-first-offset="true"><span data-slate-string="true"> 函数启动一个 HTTP 服务，ServeHealthCheck 函数代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18293"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18294"><span data-slate-object="text" data-key="18295"><span data-slate-leaf="true" data-offset-key="18295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18296"><span data-slate-leaf="true" data-offset-key="18296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18297"><span data-slate-leaf="true" data-offset-key="18297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ServeHealthCheck</span></span></span></span></span><span data-slate-object="text" data-key="18298"><span data-slate-leaf="true" data-offset-key="18298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(healthPath </span></span></span></span></span><span data-slate-object="text" data-key="18299"><span data-slate-leaf="true" data-offset-key="18299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="18300"><span data-slate-leaf="true" data-offset-key="18300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, healthAddress </span></span></span></span></span><span data-slate-object="text" data-key="18301"><span data-slate-leaf="true" data-offset-key="18301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="18302"><span data-slate-leaf="true" data-offset-key="18302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="18303"><span data-slate-leaf="true" data-offset-key="18303:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18304"><span data-slate-object="text" data-key="18305"><span data-slate-leaf="true" data-offset-key="18305:0" data-first-offset="true"><span data-slate-string="true">  http.HandleFunc(</span></span></span><span data-slate-object="text" data-key="18306"><span data-slate-leaf="true" data-offset-key="18306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/"</span></span></span></span><span data-slate-object="text" data-key="18307"><span data-slate-leaf="true" data-offset-key="18307:0" data-first-offset="true"><span data-slate-string="true">+healthPath, </span></span></span><span data-slate-object="text" data-key="18308"><span data-slate-leaf="true" data-offset-key="18308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18309"><span data-slate-leaf="true" data-offset-key="18309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(w http.ResponseWriter, r *http.Request)</span></span></span></span></span><span data-slate-object="text" data-key="18310"><span data-slate-leaf="true" data-offset-key="18310:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18311"><span data-slate-object="text" data-key="18312"><span data-slate-leaf="true" data-offset-key="18312:0" data-first-offset="true"><span data-slate-string="true">    w.Header().Set(</span></span></span><span data-slate-object="text" data-key="18313"><span data-slate-leaf="true" data-offset-key="18313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Content-type"</span></span></span></span><span data-slate-object="text" data-key="18314"><span data-slate-leaf="true" data-offset-key="18314:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="18315"><span data-slate-leaf="true" data-offset-key="18315:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"application/json"</span></span></span></span><span data-slate-object="text" data-key="18316"><span data-slate-leaf="true" data-offset-key="18316:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18317"><span data-slate-object="text" data-key="18318"><span data-slate-leaf="true" data-offset-key="18318:0" data-first-offset="true"><span data-slate-string="true">    w.WriteHeader(http.StatusOK)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18319"><span data-slate-object="text" data-key="18320"><span data-slate-leaf="true" data-offset-key="18320:0" data-first-offset="true"><span data-slate-string="true">    _, _ = w.Write([]</span></span></span><span data-slate-object="text" data-key="18321"><span data-slate-leaf="true" data-offset-key="18321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="18322"><span data-slate-leaf="true" data-offset-key="18322:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18323"><span data-slate-leaf="true" data-offset-key="18323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`{"status": "ok"}`</span></span></span></span><span data-slate-object="text" data-key="18324"><span data-slate-leaf="true" data-offset-key="18324:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18325"><span data-slate-object="text" data-key="18326"><span data-slate-leaf="true" data-offset-key="18326:0" data-first-offset="true"><span data-slate-string="true">  })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18327"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18328"><span data-slate-object="text" data-key="18329"><span data-slate-leaf="true" data-offset-key="18329:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18330"><span data-slate-leaf="true" data-offset-key="18330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18331"><span data-slate-leaf="true" data-offset-key="18331:0" data-first-offset="true"><span data-slate-string="true"> err := http.ListenAndServe(healthAddress, </span></span></span><span data-slate-object="text" data-key="18332"><span data-slate-leaf="true" data-offset-key="18332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18333"><span data-slate-leaf="true" data-offset-key="18333:0" data-first-offset="true"><span data-slate-string="true">); err != </span></span></span><span data-slate-object="text" data-key="18334"><span data-slate-leaf="true" data-offset-key="18334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18335"><span data-slate-leaf="true" data-offset-key="18335:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18336"><span data-slate-object="text" data-key="18337"><span data-slate-leaf="true" data-offset-key="18337:0" data-first-offset="true"><span data-slate-string="true">    log.Fatalf(</span></span></span><span data-slate-object="text" data-key="18338"><span data-slate-leaf="true" data-offset-key="18338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Error serving health check endpoint: %s"</span></span></span></span><span data-slate-object="text" data-key="18339"><span data-slate-leaf="true" data-offset-key="18339:0" data-first-offset="true"><span data-slate-string="true">, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18340"><span data-slate-object="text" data-key="18341"><span data-slate-leaf="true" data-offset-key="18341:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18342"><span data-slate-object="text" data-key="18343"><span data-slate-leaf="true" data-offset-key="18343:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18344"><span data-slate-object="text" data-key="18345"><span data-slate-leaf="true" data-offset-key="18345:0" data-first-offset="true"><span data-slate-string="true">该函数启动了一个 HTTP 服务，服务监听地址通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18346"><span data-slate-object="text" data-key="18347"><span data-slate-leaf="true" data-offset-key="18347:0" data-first-offset="true"><span data-slate-string="true">health-check-address</span></span></span></a><span data-slate-object="text" data-key="18348"><span data-slate-leaf="true" data-offset-key="18348:0" data-first-offset="true"><span data-slate-string="true"> 配置，健康检查路径通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18349"><span data-slate-object="text" data-key="18350"><span data-slate-leaf="true" data-offset-key="18350:0" data-first-offset="true"><span data-slate-string="true">health-check-path</span></span></span></a><span data-slate-object="text" data-key="18351"><span data-slate-leaf="true" data-offset-key="18351:0" data-first-offset="true"><span data-slate-string="true"> 配置。如果请求 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18352"><span data-slate-object="text" data-key="18353"><span data-slate-leaf="true" data-offset-key="18353:0" data-first-offset="true"><span data-slate-string="true">http://&lt;health-check-address&gt;/&lt;health-check-path&gt;</span></span></span></span><span data-slate-object="text" data-key="18354"><span data-slate-leaf="true" data-offset-key="18354:0" data-first-offset="true"><span data-slate-string="true"> 返回</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18355"><span data-slate-object="text" data-key="18356"><span data-slate-leaf="true" data-offset-key="18356:0" data-first-offset="true"><span data-slate-string="true"> {"status": "ok"}</span></span></span></span><span data-slate-object="text" data-key="18357"><span data-slate-leaf="true" data-offset-key="18357:0" data-first-offset="true"><span data-slate-string="true">，说明 iam-pump 可以正常工作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18358"><span data-slate-object="text" data-key="18359"><span data-slate-leaf="true" data-offset-key="18359:0" data-first-offset="true"><span data-slate-string="true">这里的健康检查只是简单返回了一个字符串，实际开发中，可以封装更复杂的逻辑。比如，检查进程是否可以成功 ping 通数据库，进程内的工作进程是否处于 worker 状态等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18360"><span data-slate-object="text" data-key="18361"><span data-slate-leaf="true" data-offset-key="18361:0" data-first-offset="true"><span data-slate-string="true">iam-pump 默认的健康检查请求地址为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="18362"><span data-slate-object="text" data-key="18363"><span data-slate-leaf="true" data-offset-key="18363:0" data-first-offset="true"><span data-slate-string="true"> http://127.0.0.1:7070/healthz</span></span></span></span><span data-slate-object="text" data-key="18364"><span data-slate-leaf="true" data-offset-key="18364:0" data-first-offset="true"><span data-slate-string="true"> 。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18365" id="sr-toc-16"><span data-slate-object="text" data-key="18366"><span data-slate-leaf="true" data-offset-key="18366:0" data-first-offset="true"><span data-slate-string="true">运行服务：启动 Loop 周期性消费 Redis 数据</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18367"><span data-slate-object="text" data-key="18368"><span data-slate-leaf="true" data-offset-key="18368:0" data-first-offset="true"><span data-slate-string="true">初始化 pumps 之后，就可以通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18369"><span data-slate-object="text" data-key="18370"><span data-slate-leaf="true" data-offset-key="18370:0" data-first-offset="true"><span data-slate-string="true">Run</span></span></span></a><span data-slate-object="text" data-key="18371"><span data-slate-leaf="true" data-offset-key="18371:0" data-first-offset="true"><span data-slate-string="true"> 函数启动消费逻辑了。在 Run 函数中，会定期（通过配置 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18372"><span data-slate-object="text" data-key="18373"><span data-slate-leaf="true" data-offset-key="18373:0" data-first-offset="true"><span data-slate-string="true">purge-delay</span></span></span></a><span data-slate-object="text" data-key="18374"><span data-slate-leaf="true" data-offset-key="18374:0" data-first-offset="true"><span data-slate-string="true"> 设置轮训时间）从 Redis 中获取所有数据，经过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18375"><span data-slate-object="text" data-key="18376"><span data-slate-leaf="true" data-offset-key="18376:0" data-first-offset="true"><span data-slate-string="true">msgpack.Unmarshal</span></span></span></a><span data-slate-object="text" data-key="18377"><span data-slate-leaf="true" data-offset-key="18377:0" data-first-offset="true"><span data-slate-string="true"> 解压后，传给 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18378"><span data-slate-object="text" data-key="18379"><span data-slate-leaf="true" data-offset-key="18379:0" data-first-offset="true"><span data-slate-string="true">writeToPumps</span></span></span></a><span data-slate-object="text" data-key="18380"><span data-slate-leaf="true" data-offset-key="18380:0" data-first-offset="true"><span data-slate-string="true"> 处理：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18381"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18382"><span data-slate-object="text" data-key="18383"><span data-slate-leaf="true" data-offset-key="18383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18384"><span data-slate-leaf="true" data-offset-key="18384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18385"><span data-slate-leaf="true" data-offset-key="18385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s preparedPumpServer)</span></span></span></span></span><span data-slate-object="text" data-key="18386"><span data-slate-leaf="true" data-offset-key="18386:0" data-first-offset="true"><span data-slate-string="true"> Run(stopCh &lt;-</span></span></span><span data-slate-object="text" data-key="18387"><span data-slate-leaf="true" data-offset-key="18387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="18388"><span data-slate-leaf="true" data-offset-key="18388:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18389"><span data-slate-leaf="true" data-offset-key="18389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="18390"><span data-slate-leaf="true" data-offset-key="18390:0" data-first-offset="true"><span data-slate-string="true">{}) </span></span></span><span data-slate-object="text" data-key="18391"><span data-slate-leaf="true" data-offset-key="18391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="18392"><span data-slate-leaf="true" data-offset-key="18392:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18393"><span data-slate-object="text" data-key="18394"><span data-slate-leaf="true" data-offset-key="18394:0" data-first-offset="true"><span data-slate-string="true">  ticker := time.NewTicker(time.Duration(s.secInterval) * time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18395"><span data-slate-object="text" data-key="18396"><span data-slate-leaf="true" data-offset-key="18396:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18397"><span data-slate-leaf="true" data-offset-key="18397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="18398"><span data-slate-leaf="true" data-offset-key="18398:0" data-first-offset="true"><span data-slate-string="true"> ticker.Stop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18399"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18400"><span data-slate-object="text" data-key="18401"><span data-slate-leaf="true" data-offset-key="18401:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="18402"><span data-slate-leaf="true" data-offset-key="18402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18403"><span data-slate-leaf="true" data-offset-key="18403:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18404"><span data-slate-object="text" data-key="18405"><span data-slate-leaf="true" data-offset-key="18405:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18406"><span data-slate-leaf="true" data-offset-key="18406:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18407"><span data-slate-leaf="true" data-offset-key="18407:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18408"><span data-slate-object="text" data-key="18409"><span data-slate-leaf="true" data-offset-key="18409:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18410"><span data-slate-leaf="true" data-offset-key="18410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18411"><span data-slate-leaf="true" data-offset-key="18411:0" data-first-offset="true"><span data-slate-string="true"> &lt;-ticker.C:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18412"><span data-slate-object="text" data-key="18413"><span data-slate-leaf="true" data-offset-key="18413:0" data-first-offset="true"><span data-slate-string="true">      analyticsValues := s.analyticsStore.GetAndDeleteSet(storage.AnalyticsKeyName)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18414"><span data-slate-object="text" data-key="18415"><span data-slate-leaf="true" data-offset-key="18415:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18416"><span data-slate-leaf="true" data-offset-key="18416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18417"><span data-slate-leaf="true" data-offset-key="18417:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18418"><span data-slate-leaf="true" data-offset-key="18418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="18419"><span data-slate-leaf="true" data-offset-key="18419:0" data-first-offset="true"><span data-slate-string="true">(analyticsValues) &gt; </span></span></span><span data-slate-object="text" data-key="18420"><span data-slate-leaf="true" data-offset-key="18420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18421"><span data-slate-leaf="true" data-offset-key="18421:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18422"><span data-slate-object="text" data-key="18423"><span data-slate-leaf="true" data-offset-key="18423:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18424"><span data-slate-leaf="true" data-offset-key="18424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Convert to something clean</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18425"><span data-slate-object="text" data-key="18426"><span data-slate-leaf="true" data-offset-key="18426:0" data-first-offset="true"><span data-slate-string="true">        keys := </span></span></span><span data-slate-object="text" data-key="18427"><span data-slate-leaf="true" data-offset-key="18427:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="18428"><span data-slate-leaf="true" data-offset-key="18428:0" data-first-offset="true"><span data-slate-string="true">([]</span></span></span><span data-slate-object="text" data-key="18429"><span data-slate-leaf="true" data-offset-key="18429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="18430"><span data-slate-leaf="true" data-offset-key="18430:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="18431"><span data-slate-leaf="true" data-offset-key="18431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="18432"><span data-slate-leaf="true" data-offset-key="18432:0" data-first-offset="true"><span data-slate-string="true">(analyticsValues))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18433"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18434"><span data-slate-object="text" data-key="18435"><span data-slate-leaf="true" data-offset-key="18435:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18436"><span data-slate-leaf="true" data-offset-key="18436:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18437"><span data-slate-leaf="true" data-offset-key="18437:0" data-first-offset="true"><span data-slate-string="true"> i, v := </span></span></span><span data-slate-object="text" data-key="18438"><span data-slate-leaf="true" data-offset-key="18438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="18439"><span data-slate-leaf="true" data-offset-key="18439:0" data-first-offset="true"><span data-slate-string="true"> analyticsValues {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18440"><span data-slate-object="text" data-key="18441"><span data-slate-leaf="true" data-offset-key="18441:0" data-first-offset="true"><span data-slate-string="true">          decoded := analytics.AnalyticsRecord{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18442"><span data-slate-object="text" data-key="18443"><span data-slate-leaf="true" data-offset-key="18443:0" data-first-offset="true"><span data-slate-string="true">          err := msgpack.Unmarshal([]</span></span></span><span data-slate-object="text" data-key="18444"><span data-slate-leaf="true" data-offset-key="18444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="18445"><span data-slate-leaf="true" data-offset-key="18445:0" data-first-offset="true"><span data-slate-string="true">(v.(</span></span></span><span data-slate-object="text" data-key="18446"><span data-slate-leaf="true" data-offset-key="18446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="18447"><span data-slate-leaf="true" data-offset-key="18447:0" data-first-offset="true"><span data-slate-string="true">)), &amp;decoded)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18448"><span data-slate-object="text" data-key="18449"><span data-slate-leaf="true" data-offset-key="18449:0" data-first-offset="true"><span data-slate-string="true">          log.Debugf(</span></span></span><span data-slate-object="text" data-key="18450"><span data-slate-leaf="true" data-offset-key="18450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Decoded Record: %v"</span></span></span></span><span data-slate-object="text" data-key="18451"><span data-slate-leaf="true" data-offset-key="18451:0" data-first-offset="true"><span data-slate-string="true">, decoded)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18452"><span data-slate-object="text" data-key="18453"><span data-slate-leaf="true" data-offset-key="18453:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="18454"><span data-slate-leaf="true" data-offset-key="18454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18455"><span data-slate-leaf="true" data-offset-key="18455:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="18456"><span data-slate-leaf="true" data-offset-key="18456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="18457"><span data-slate-leaf="true" data-offset-key="18457:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18458"><span data-slate-object="text" data-key="18459"><span data-slate-leaf="true" data-offset-key="18459:0" data-first-offset="true"><span data-slate-string="true">            log.Errorf(</span></span></span><span data-slate-object="text" data-key="18460"><span data-slate-leaf="true" data-offset-key="18460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Couldn't unmarshal analytics data: %s"</span></span></span></span><span data-slate-object="text" data-key="18461"><span data-slate-leaf="true" data-offset-key="18461:0" data-first-offset="true"><span data-slate-string="true">, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18462"><span data-slate-object="text" data-key="18463"><span data-slate-leaf="true" data-offset-key="18463:0" data-first-offset="true"><span data-slate-string="true">          } </span></span></span><span data-slate-object="text" data-key="18464"><span data-slate-leaf="true" data-offset-key="18464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="18465"><span data-slate-leaf="true" data-offset-key="18465:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18466"><span data-slate-object="text" data-key="18467"><span data-slate-leaf="true" data-offset-key="18467:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18468"><span data-slate-leaf="true" data-offset-key="18468:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18469"><span data-slate-leaf="true" data-offset-key="18469:0" data-first-offset="true"><span data-slate-string="true"> s.omitDetails {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18470"><span data-slate-object="text" data-key="18471"><span data-slate-leaf="true" data-offset-key="18471:0" data-first-offset="true"><span data-slate-string="true">              decoded.Policies = </span></span></span><span data-slate-object="text" data-key="18472"><span data-slate-leaf="true" data-offset-key="18472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18473"><span data-slate-object="text" data-key="18474"><span data-slate-leaf="true" data-offset-key="18474:0" data-first-offset="true"><span data-slate-string="true">              decoded.Deciders = </span></span></span><span data-slate-object="text" data-key="18475"><span data-slate-leaf="true" data-offset-key="18475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18476"><span data-slate-object="text" data-key="18477"><span data-slate-leaf="true" data-offset-key="18477:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18478"><span data-slate-object="text" data-key="18479"><span data-slate-leaf="true" data-offset-key="18479:0" data-first-offset="true"><span data-slate-string="true">            keys[i] = </span></span></span><span data-slate-object="text" data-key="18480"><span data-slate-leaf="true" data-offset-key="18480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="18481"><span data-slate-leaf="true" data-offset-key="18481:0" data-first-offset="true"><span data-slate-string="true">{}(decoded)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18482"><span data-slate-object="text" data-key="18483"><span data-slate-leaf="true" data-offset-key="18483:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18484"><span data-slate-object="text" data-key="18485"><span data-slate-leaf="true" data-offset-key="18485:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18486"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18487"><span data-slate-object="text" data-key="18488"><span data-slate-leaf="true" data-offset-key="18488:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18489"><span data-slate-leaf="true" data-offset-key="18489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Send to pumps</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18490"><span data-slate-object="text" data-key="18491"><span data-slate-leaf="true" data-offset-key="18491:0" data-first-offset="true"><span data-slate-string="true">        writeToPumps(keys, s.secInterval)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18492"><span data-slate-object="text" data-key="18493"><span data-slate-leaf="true" data-offset-key="18493:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18494"><span data-slate-object="text" data-key="18495"><span data-slate-leaf="true" data-offset-key="18495:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18496"><span data-slate-leaf="true" data-offset-key="18496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// exit consumption cycle when receive SIGINT and SIGTERM signal</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18497"><span data-slate-object="text" data-key="18498"><span data-slate-leaf="true" data-offset-key="18498:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18499"><span data-slate-leaf="true" data-offset-key="18499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18500"><span data-slate-leaf="true" data-offset-key="18500:0" data-first-offset="true"><span data-slate-string="true"> &lt;-stopCh:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18501"><span data-slate-object="text" data-key="18502"><span data-slate-leaf="true" data-offset-key="18502:0" data-first-offset="true"><span data-slate-string="true">      log.Info(</span></span></span><span data-slate-object="text" data-key="18503"><span data-slate-leaf="true" data-offset-key="18503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"stop purge loop"</span></span></span></span><span data-slate-object="text" data-key="18504"><span data-slate-leaf="true" data-offset-key="18504:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18505"></div><div data-slate-type="code-line" data-slate-object="block" data-key="18506"><span data-slate-object="text" data-key="18507"><span data-slate-leaf="true" data-offset-key="18507:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="18508"><span data-slate-leaf="true" data-offset-key="18508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18509"><span data-slate-leaf="true" data-offset-key="18509:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18510"><span data-slate-leaf="true" data-offset-key="18510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18511"><span data-slate-object="text" data-key="18512"><span data-slate-leaf="true" data-offset-key="18512:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18513"><span data-slate-object="text" data-key="18514"><span data-slate-leaf="true" data-offset-key="18514:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18515"><span data-slate-object="text" data-key="18516"><span data-slate-leaf="true" data-offset-key="18516:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18517"><span data-slate-object="text" data-key="18518"><span data-slate-leaf="true" data-offset-key="18518:0" data-first-offset="true"><span data-slate-string="true">writeToPumps 函数通过调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18519"><span data-slate-object="text" data-key="18520"><span data-slate-leaf="true" data-offset-key="18520:0" data-first-offset="true"><span data-slate-string="true">execPumpWriting</span></span></span></a><span data-slate-object="text" data-key="18521"><span data-slate-leaf="true" data-offset-key="18521:0" data-first-offset="true"><span data-slate-string="true"> 函数，异步调用 pump 的 WriteData 函数写入数据。execPumpWriting 函数中有一些设计技巧，你可以注意下这两个：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="18522"><div data-slate-type="list-line" data-slate-object="block" data-key="18523"><span data-slate-object="text" data-key="18524"><span data-slate-leaf="true" data-offset-key="18524:0" data-first-offset="true"><span data-slate-string="true">将一些通用的处理，例如 Filters、Timeout、OmitDetailedRecording 放在 pump 之外处理，这样可以减少 pump 中代码的重复性。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="18525"><span data-slate-object="text" data-key="18526"><span data-slate-leaf="true" data-offset-key="18526:0" data-first-offset="true"><span data-slate-string="true">优雅关停。通过如下代码实现优雅关停功能：</span></span></span></div></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18527"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18528"><span data-slate-object="text" data-key="18529"><span data-slate-leaf="true" data-offset-key="18529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18530"><span data-slate-leaf="true" data-offset-key="18530:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18531"><span data-slate-object="text" data-key="18532"><span data-slate-leaf="true" data-offset-key="18532:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18533"><span data-slate-leaf="true" data-offset-key="18533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18534"><span data-slate-leaf="true" data-offset-key="18534:0" data-first-offset="true"><span data-slate-string="true"> &lt;-stopCh:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18535"><span data-slate-object="text" data-key="18536"><span data-slate-leaf="true" data-offset-key="18536:0" data-first-offset="true"><span data-slate-string="true">        log.Info(</span></span></span><span data-slate-object="text" data-key="18537"><span data-slate-leaf="true" data-offset-key="18537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"stop purge loop"</span></span></span></span><span data-slate-object="text" data-key="18538"><span data-slate-leaf="true" data-offset-key="18538:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18539"><span data-slate-object="text" data-key="18540"><span data-slate-leaf="true" data-offset-key="18540:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18541"><span data-slate-leaf="true" data-offset-key="18541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18542"><span data-slate-object="text" data-key="18543"><span data-slate-leaf="true" data-offset-key="18543:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18544"><span data-slate-leaf="true" data-offset-key="18544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="18545"><span data-slate-leaf="true" data-offset-key="18545:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18546"><span data-slate-object="text" data-key="18547"><span data-slate-leaf="true" data-offset-key="18547:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18548"><span data-slate-object="text" data-key="18549"><span data-slate-leaf="true" data-offset-key="18549:0" data-first-offset="true"><span data-slate-string="true">上面的代码需要放在 writeToPumps 之后，这样可以确保所有数据都成功写入 pumps 之后，再停止采集逻辑。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18550" id="sr-toc-17"><span data-slate-object="text" data-key="18551"><span data-slate-leaf="true" data-offset-key="18551:0" data-first-offset="true"><span data-slate-string="true">关停服务：优雅关停数据采集服务</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18552"><span data-slate-object="text" data-key="18553"><span data-slate-leaf="true" data-offset-key="18553:0" data-first-offset="true"><span data-slate-string="true">在关停服务时，为了确保正在处理的数据被成功存储，还需要提供优雅关停功能。iam-pump 通过 channel 传递 SIGINT 和 SIGTERM 信号，当消费逻辑收到这两个信号后，会退出消费循环，见 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18554"><span data-slate-object="text" data-key="18555"><span data-slate-leaf="true" data-offset-key="18555:0" data-first-offset="true"><span data-slate-string="true">Run</span></span></span></a><span data-slate-object="text" data-key="18556"><span data-slate-leaf="true" data-offset-key="18556:0" data-first-offset="true"><span data-slate-string="true"> 函数。代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="18557"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18558"><span data-slate-object="text" data-key="18559"><span data-slate-leaf="true" data-offset-key="18559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="18560"><span data-slate-leaf="true" data-offset-key="18560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18561"><span data-slate-leaf="true" data-offset-key="18561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s preparedPumpServer)</span></span></span></span></span><span data-slate-object="text" data-key="18562"><span data-slate-leaf="true" data-offset-key="18562:0" data-first-offset="true"><span data-slate-string="true"> Run(stopCh &lt;-</span></span></span><span data-slate-object="text" data-key="18563"><span data-slate-leaf="true" data-offset-key="18563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="18564"><span data-slate-leaf="true" data-offset-key="18564:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18565"><span data-slate-leaf="true" data-offset-key="18565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="18566"><span data-slate-leaf="true" data-offset-key="18566:0" data-first-offset="true"><span data-slate-string="true">{}) </span></span></span><span data-slate-object="text" data-key="18567"><span data-slate-leaf="true" data-offset-key="18567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="18568"><span data-slate-leaf="true" data-offset-key="18568:0" data-first-offset="true"><span data-slate-string="true"> {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18569"><span data-slate-object="text" data-key="18570"><span data-slate-leaf="true" data-offset-key="18570:0" data-first-offset="true"><span data-slate-string="true">    ticker := time.NewTicker(time.Duration(s.secInterval) * time.Second)    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18571"><span data-slate-object="text" data-key="18572"><span data-slate-leaf="true" data-offset-key="18572:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18573"><span data-slate-leaf="true" data-offset-key="18573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="18574"><span data-slate-leaf="true" data-offset-key="18574:0" data-first-offset="true"><span data-slate-string="true"> ticker.Stop()                                                     </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18575"><span data-slate-object="text" data-key="18576"><span data-slate-leaf="true" data-offset-key="18576:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18577"><span data-slate-object="text" data-key="18578"><span data-slate-leaf="true" data-offset-key="18578:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18579"><span data-slate-leaf="true" data-offset-key="18579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18580"><span data-slate-leaf="true" data-offset-key="18580:0" data-first-offset="true"><span data-slate-string="true"> {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18581"><span data-slate-object="text" data-key="18582"><span data-slate-leaf="true" data-offset-key="18582:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18583"><span data-slate-leaf="true" data-offset-key="18583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="18584"><span data-slate-leaf="true" data-offset-key="18584:0" data-first-offset="true"><span data-slate-string="true"> {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18585"><span data-slate-object="text" data-key="18586"><span data-slate-leaf="true" data-offset-key="18586:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18587"><span data-slate-leaf="true" data-offset-key="18587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18588"><span data-slate-leaf="true" data-offset-key="18588:0" data-first-offset="true"><span data-slate-string="true"> &lt;-ticker.C:    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18589"><span data-slate-object="text" data-key="18590"><span data-slate-leaf="true" data-offset-key="18590:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="18591"><span data-slate-leaf="true" data-offset-key="18591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 消费逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18592"><span data-slate-object="text" data-key="18593"><span data-slate-leaf="true" data-offset-key="18593:0" data-first-offset="true"><span data-slate-string="true">         ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18594"><span data-slate-object="text" data-key="18595"><span data-slate-leaf="true" data-offset-key="18595:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18596"><span data-slate-leaf="true" data-offset-key="18596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// exit consumption cycle when receive SIGINT and SIGTERM signal</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18597"><span data-slate-object="text" data-key="18598"><span data-slate-leaf="true" data-offset-key="18598:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18599"><span data-slate-leaf="true" data-offset-key="18599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="18600"><span data-slate-leaf="true" data-offset-key="18600:0" data-first-offset="true"><span data-slate-string="true"> &lt;-stopCh:    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18601"><span data-slate-object="text" data-key="18602"><span data-slate-leaf="true" data-offset-key="18602:0" data-first-offset="true"><span data-slate-string="true">            log.Info(</span></span></span><span data-slate-object="text" data-key="18603"><span data-slate-leaf="true" data-offset-key="18603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"stop purge loop"</span></span></span></span><span data-slate-object="text" data-key="18604"><span data-slate-leaf="true" data-offset-key="18604:0" data-first-offset="true"><span data-slate-string="true">)    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18605"><span data-slate-object="text" data-key="18606"><span data-slate-leaf="true" data-offset-key="18606:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18607"><span data-slate-object="text" data-key="18608"><span data-slate-leaf="true" data-offset-key="18608:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18609"><span data-slate-leaf="true" data-offset-key="18609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18610"><span data-slate-leaf="true" data-offset-key="18610:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18611"><span data-slate-leaf="true" data-offset-key="18611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18612"><span data-slate-object="text" data-key="18613"><span data-slate-leaf="true" data-offset-key="18613:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18614"><span data-slate-object="text" data-key="18615"><span data-slate-leaf="true" data-offset-key="18615:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18616"><span data-slate-object="text" data-key="18617"><span data-slate-leaf="true" data-offset-key="18617:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18618"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18619" id="sr-toc-18"><span data-slate-object="text" data-key="18620"><span data-slate-leaf="true" data-offset-key="18620:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18621"><span data-slate-object="text" data-key="18622"><span data-slate-leaf="true" data-offset-key="18622:0" data-first-offset="true"><span data-slate-string="true">这一讲，我主要介绍了如何将数据采集需求转化成一个数据采集模型，并从这个模型出发，设计出一个可扩展、高性能的数据采集服务，并通过 iam-pump 组件来落地该采集模型。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18623"><span data-slate-object="text" data-key="18624"><span data-slate-leaf="true" data-offset-key="18624:0" data-first-offset="true"><span data-slate-string="true">最后，我还想给你一个建议：在开发中，你也可以将一些功能抽象成一些通用的模型，并为该模型实现基本框架（引擎），然后将一些需要定制化的部分插件化。通过这种方式，可以设计出一个高扩展的服务，使得服务不仅能够满足现在的需求，还能够满足未来的需求。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18625" id="sr-toc-19"><span data-slate-object="text" data-key="18626"><span data-slate-leaf="true" data-offset-key="18626:0" data-first-offset="true"><span data-slate-string="true">课后练习</span></span></span></h2><div data-slate-type="list" data-slate-object="block" data-key="18627"><div data-slate-type="list-line" data-slate-object="block" data-key="18628"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="18629"><span data-slate-leaf="true" data-offset-key="18629:0" data-first-offset="true"><span data-slate-string="true">思考下，如何设计一个数据上报和数据采集应用，设计时有哪些点需要注意？</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="18630"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="18631"><span data-slate-leaf="true" data-offset-key="18631:0" data-first-offset="true"><span data-slate-string="true">动手练习下，启动 iam-authz-server 和 iam-pump 服务，验证整个流程。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18632"><span data-slate-object="text" data-key="18633"><span data-slate-leaf="true" data-offset-key="18633:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区与我交流讨论，我们下一讲见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-20">精选留言 (8)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Sch0ng</span></div></div><div>数据采集服务分数据上报和数据采集，先做拆分再有针对性达成目标性能。
把功能抽象成模型，再把实现封装成独立的模块，应用依赖模型的接口，不依赖具体的实现。</div><div><p>作者回复：到位！</p></div><div><div>2021-08-16</div><div><div><i></i><span>2</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/63/84/f45c4af9.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Vackine</span></div></div><div>pump 如果中途退出了，会记录已经消费的位置么？</div><div><p>作者回复：这里暂时不支持。

老哥，可以尝试将 redis 切换成 kafka，kafka 可以记录消费位置</p></div><div><div>2021-08-07</div><div><div><i></i><span>2</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/PiajxSqBRaEKXjfJWVQGDHmDEI73VQO4dgTzaK5LLz2ax9XUF4FCPy1Oib8aQLibFzpcsiavVVbAQlG4pbrfibdwaYA/132"></div></div><div><div><div><span>Geek_63505f</span></div></div><div>老师这句话是什么意思 viper.SetEnvKeyReplacer (strings.NewReplacer (".", "_", "-", "_")) 
    strings.NewReplacer 里面不应该是 ("-","_") 这样吗？前面那两个字符多出来是干嘛用的？</div><div><p>作者回复：将。也转换为_</p></div><div><div>2022-01-22</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>yandongxiao</span></div></div><div>总结：
数据采集服务常见问题：不够通用化；采集服务延迟高、性能差、启停服务时会有数据丢失。
数据采集服务一般需要完成：数据上报 和 数据处理。它们一般不是同一个进程内。
数据上报：对数据压缩、支持批量上报、超时上报、优雅关停（停止接收新请求，完成服务中的请求）
数据处理：数据处理完毕后，还需要进行上报。将上报的模块做成插件化，非常重要。</div><div><div>2021-12-04</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/60/a1/8f003697.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 静心</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/8a/95/8ac15yy848f71919ef784a1c9065e495.png"></div></span></div></div><div>这个插件化的 pump 模型抽象的真好，感觉这个 pump 项目完全可以用到生产了。</div><div><p>作者回复：这个模型就是源自亿级 QPS 的生产项目，完全可以用到生产环境中。</p></div><div><div>2021-10-29</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/53/db/858337e3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Ethan Liu</span></div></div><div>应用产生的数据放到日志中，再由数据上报服务读取至 bufferd channel 吗？
同步上报方式指的是 rpc 吗？</div><div><p>作者回复：同步上报指的是：调用上报接口，并阻塞直到上报接口返回。</p></div><div><div>2021-09-09</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/5f/c2/997e298b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 来咯</span></div></div><div>ensureConnection   redis 重新连接 失败 应该需要 sleep 吧 不然日志写爆  CPU 也占满了</div><div><div>2022-05-27</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/b5/e6/c67f12bd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>左耳朵东</span></div></div><div>
func (r *Analytics) Start () {
    analytics = r
    r.store.Connect ()

    //start worker pool
    atomic.SwapUint32 (&amp;r.shouldStop, 0)
    for i := 0; i &lt; r.poolSize; i++ {
        r.poolWg.Add (1)
        go r.recordWorker ()
    }

    //stop analytics workers
    go r.Stop ()
}

倒数第二行代码 go r.Stop ()，这里把 recordsChan 马上又关闭了？那后面还怎么给这个 channel 发消息？</div><div><p>作者回复：这里是个 bug 哈，master 分支有纠正过来，这里我让编辑改下</p></div><div><div>2022-03-14</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".y"><outline class="toc-level-h1" data-reactid=".y.0" style="width: 175px;"><active data-reactid=".y.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".y.0.1"><span data-reactid=".y.0.1.0"> 32 | 数据处理：如何高效处理应用程序产生的数据？</span></a></outline><outline class="toc-level-h2" data-reactid=".y.1" style="width: 165px;"><active data-reactid=".y.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".y.1.1"><span data-reactid=".y.1.1.0">数据采集方式的分类</span></a></outline><outline class="toc-level-h2" data-reactid=".y.2" style="width: 165px;"><active data-reactid=".y.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".y.2.1"><span data-reactid=".y.2.1.0">数据采集系统设计</span></a></outline><outline class="toc-level-h3" data-reactid=".y.3" style="width: 155px;"><active data-reactid=".y.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".y.3.1"><span data-reactid=".y.3.1.0">设计数据采集系统时需要解决的核心问题</span></a></outline><outline class="toc-level-h3" data-reactid=".y.4" style="width: 155px;"><active data-reactid=".y.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".y.4.1"><span data-reactid=".y.4.1.0">数据上报功能设计</span></a></outline><outline class="toc-level-h3" data-reactid=".y.5" style="width: 155px;"><active data-reactid=".y.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".y.5.1"><span data-reactid=".y.5.1.0">数据采集功能设计</span></a></outline><outline class="toc-level-h3" data-reactid=".y.6" style="width: 155px;"><active data-reactid=".y.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".y.6.1"><span data-reactid=".y.6.1.0">数据采集应用模型</span></a></outline><outline class="toc-level-h2" data-reactid=".y.7" style="width: 165px;"><active data-reactid=".y.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".y.7.1"><span data-reactid=".y.7.1.0">数据采集系统落地项目：iam-authz-server + iam-pump</span></a></outline><outline class="toc-level-h2" data-reactid=".y.8" style="width: 165px;"><active data-reactid=".y.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".y.8.1"><span data-reactid=".y.8.1.0">iam-authz-server：数据上报</span></a></outline><outline class="toc-level-h3" data-reactid=".y.9" style="width: 155px;"><active data-reactid=".y.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".y.9.1"><span data-reactid=".y.9.1.0">启动服务：启动数据上报服务</span></a></outline><outline class="toc-level-h3" data-reactid=".y.a" style="width: 155px;"><active data-reactid=".y.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".y.a.1"><span data-reactid=".y.a.1.0">运行服务：异步上报授权日志</span></a></outline><outline class="toc-level-h3" data-reactid=".y.b" style="width: 155px;"><active data-reactid=".y.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".y.b.1"><span data-reactid=".y.b.1.0">关停服务：优雅关停数据上报</span></a></outline><outline class="toc-level-h2" data-reactid=".y.c" style="width: 165px;"><active data-reactid=".y.c.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".y.c.1"><span data-reactid=".y.c.1.0">iam-pump：数据采集</span></a></outline><outline class="toc-level-h3" data-reactid=".y.d" style="width: 155px;"><active data-reactid=".y.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".y.d.1"><span data-reactid=".y.d.1.0">初始化服务：数据采集插件定义</span></a></outline><outline class="toc-level-h3" data-reactid=".y.e" style="width: 155px;"><active data-reactid=".y.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".y.e.1"><span data-reactid=".y.e.1.0">初始化服务：初始化数据采集插件</span></a></outline><outline class="toc-level-h3" data-reactid=".y.f" style="width: 155px;"><active data-reactid=".y.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".y.f.1"><span data-reactid=".y.f.1.0">初始化服务：健康检查</span></a></outline><outline class="toc-level-h3" data-reactid=".y.g" style="width: 155px;"><active data-reactid=".y.g.0"></active><a class="toc-outline-theme-github" href="#sr-toc-16" data-reactid=".y.g.1"><span data-reactid=".y.g.1.0">运行服务：启动 Loop 周期性消费 Redis 数据</span></a></outline><outline class="toc-level-h3" data-reactid=".y.h" style="width: 155px;"><active data-reactid=".y.h.0"></active><a class="toc-outline-theme-github" href="#sr-toc-17" data-reactid=".y.h.1"><span data-reactid=".y.h.1.0">关停服务：优雅关停数据采集服务</span></a></outline><outline class="toc-level-h2" data-reactid=".y.i" style="width: 165px;"><active data-reactid=".y.i.0"></active><a class="toc-outline-theme-github" href="#sr-toc-18" data-reactid=".y.i.1"><span data-reactid=".y.i.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".y.j" style="width: 165px;"><active data-reactid=".y.j.0"></active><a class="toc-outline-theme-github" href="#sr-toc-19" data-reactid=".y.j.1"><span data-reactid=".y.j.1.0">课后练习</span></a></outline><outline class="toc-level-h2" data-reactid=".y.k" style="width: 165px;"><active data-reactid=".y.k.0"></active><a class="toc-outline-theme-github" href="#sr-toc-20" data-reactid=".y.k.1"><span data-reactid=".y.k.1.0">精选留言 (8)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/405524" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>