
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAMAAAANIilAAAAA7VBMVEUAAAD///8ZGRnw8PBWVlb4+PgeHh719fVEREQlJSUODg6Ojo7Ly8v9/f1NTU2VlZUFBQV6enrCwsLy8vLh4eE0NDQLCwu8vLyXl5dxcXHa2trAwMCFhYVDQ0OysrKampo7OzssLCwICAioqKjJyckhISHu7u4/Pz9TU1NQUFBLS0tAQED6+vrS0tKRkZFISEgvLy+goKB+fn5vb29nZ2fm5uYbGxvk5OTX19d2dnZaWlre3t5hYWEyMjK5ubkoKCgVFRXQ0NDMzMzFxcW0tLSsrKykpKSMjIzq6urU1NSAgICvr6+cnJyHh4dsbGyfc25QAAAFkElEQVRIx4WXB3faMBCA74wHxgMMGAOh1MyyVyBAmtVmd/3/n1OdDtWstt/Li5JD35MtnU4CMnCIlkLEOpSKuMPhuI4FE444L9+dyv3zciad/rAjfU/yOPpGcjWS1NKSGsk29WTSD1IeYsIPkvsAJF+C5BIZkieYMNjJnsF4+JHk61wOSlVDyOIPqKBgZIxYTrqy/AmNtC1ps7yqlgE6dgYa1WqD5aV9SbKDbe6ZNnCq5A5ILlhGjEASIoawJdmHHo98AZLOnmxzKM9yK9Aht63FoAWBBmEgsEHnkfMgsZU8PJbpbXJd3MIep/Lg/MjbRqMRRuNtQ4Tthga5RiNzfmSWD97ZExQ64HhtgLb3CmbBGyj54vixjyeMsKjnV4AvOAHTwsHphKnH9toXki7Li3jLsgswizskv+c3PHKXe7ZHu5E/YMKcM2yqZIJkAclZTPClbJezivI1yTr4f+TeMib5qXxHsr7XtUFJDIc8pLAHA7Su4JXkd8ySnKZddQXH2NohswIutRu0Qu0jyS46JPugU+gISB1R8NBKWegVUsahTKEjAP9Bm5bKAc3DPlzjKaDvscE7PeEJu63WUg9a82tdA1O/ESupL9Cr6C1cXetjIe9zgQ4kvKLgHi6xC5LcGq9hhmiK0AYgUvLQtzm3n/x0jnum/Vo9j1jxg/pL3/f9W8isMOsv6/Ubf47rvl+u17nnZ1xQ+4iIXa6IpRVeimEEE3pnxO8kIz4CbFDyidVSpooBCCLLsj5noFlqUg2rwK0l+Anmm+VhCzKfrRHtqjGOLANxUKIUiYvFEcuaaZpXANniD5ZzpiBDTSRkuDJfWM6awxGuikUArp7fIOE7RlB6OygGTyhfsMyrtwDNIAkcp1YRhKC9Oh2IHUFQ6UPupnLL3icODaD5zVlUto7zhm1n7kmZ5kDSQBxykfZhD66eaQBoWriEGPcA182C4Crst90Z9NwvHgahDTALw/Ae4D500Pjq3oj/4sjtwcwVrCkkgB01HB8cdM0iIlWSr6IpNqFO+1mDHQFWORtO5EIi08b4jxy6giBsgKDnRnEYYdd9nIYvaLmuhS/h9DF5bEFr/7HTKAjUqWY1oUUBKgYEZdgIP6gJE2xQIWVvLhZBcAWx843kz87PDDi4cgR92s8/1FLpAGNeKiUbGtRQEIPkGb9TM1EF8MpCVEni7pIkkUdDs1ZcI/ZUer6YZg4WxTtqMmYsZJWebbOzEekZV4sCKaNhBaXQQ0NtjL71ZooNE1vWLfyyyFUbw7MsD0fWOFMSqAnbwj1Kuk0Aqp4aJ91MZhhvyS7+oQoMy5v63Jfoz/UYfPSiep2KQb5e4/gt1Ycdc7Se6jNyVbpuQNI08FrICQ6ccKnSXddrKCnqkqWFupJFAewKudSTBVAyBEjrLSXjCYnc5rrdQVl6VaiKqOTToi/kaSrlcW5fpGpgrlJTLvoGVxKDOg7PHzc6NLXOmuUHTZQhTWvS4T7T5ixPqGPz/EHXp/azkMeQoGOqBBOSq1gD4vwRe1culz8W8HlZKQt6Sjbm5XeS9eWizJw73HcsOW8mSpa0eT8zfK1w85LdtWKTf5dWfCPzMg5J+MBdsvvy6Q2QD/d91sfzouRz9zAdBp6HCcUzskccyBdKzjTC9ZE8HT8+JHLxtiE4d33Ud0uleOObvpXZk4E4/9h2sKD9t6oxgaCFxs9AHiI3wYJCndMbIMs9lLi7vEHFLxAUURyciOnTyzrLH6qSJwo+8CWuQIFL2wSoVyvQea/qtk2yvPtb4mekZMhJQkPwyvIzBbJGJD+jX3eGcfIFhWVmxsVAG5FMgSzm9y4wKL8aJdzvyctoTqEgep6K5lckWGM3uuuA5DadFvIhiTzBL1xzVtT0UDEDxd9ldeutcJLoyvUaoPgNdiqckZLamd0AAAAASUVORK5CYII=")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 23｜函数：怎么让函数更简洁健壮？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>23｜函数：怎么让函数更简洁健壮？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">今天，我会讲解 Go 语言提供的另一种分支控制结构：switch 语句。和 if 分支语句相比，在一些执行分支较多的场景下，使用 switch 分支控制语</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 23｜函数：怎么让函数更简洁健壮？</h1><div><span>Tony Bai</span> <span>2021-12-06</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f7/3c/f7b1dd8101b6d7ba169d995fffffyy3c.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：Tony Bai</span><span> 大小：23.52M</span><span> 时长：25:45</span></div></div><audio title="23｜函数：怎么让函数更简洁健壮？" src="https://res001.geekbang.org/media/audio/fd/d2/fd046dae789098dc1581e1db1fbeb6d2/ld/ld.m3u8" __idm_id__="253956"></audio></div><div><div><div><div data-slate-editor="true" data-key="3613" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="3614"><span data-slate-object="text" data-key="3615"><span data-slate-leaf="true" data-offset-key="3615:0" data-first-offset="true"><span data-slate-string="true">你好，我是 Tony Bai。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3616"><span data-slate-object="text" data-key="3617"><span data-slate-leaf="true" data-offset-key="3617:0" data-first-offset="true"><span data-slate-string="true">在上一节中，我们开始学习函数设计的相关知识，学习了如何基于 Go 函数的多返回值机制进行函数错误值构造方式的设计，你还记得那几种错误值构造与处理的策略吗？当然，良好的函数设计不仅仅要包含错误设计，函数的健壮性与简洁优雅也是我们在函数设计过程中要考虑的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3618"><span data-slate-object="text" data-key="3619"><span data-slate-leaf="true" data-offset-key="3619:0" data-first-offset="true"><span data-slate-string="true">健壮的函数意味着，无论调用者如何使用你的函数，</span></span><span data-slate-leaf="true" data-offset-key="3619:1"><span data-slate-object="annotation" data-annotation-key="gkann_384dd068" data-attr-id="36043" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">你的函数都能以合理的方式处理调用者的任何输入，并给调用者返回预设的、清晰的错误值。</span></span></span><span data-slate-leaf="true" data-offset-key="3619:2"><span data-slate-string="true">即便你的函数发生内部异常，函数也会尽力从异常中恢复，尽可能地不让异常蔓延到整个程序。而简洁优雅，则意味着函数的实现易读、易理解、更易维护，同时简洁也意味着统计意义上的更少的 bug。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3620"><span data-slate-object="text" data-key="3621"><span data-slate-leaf="true" data-offset-key="3621:0" data-first-offset="true"><span data-slate-string="true">这一节课，我们就将继续我们的函数设计之旅，聚焦在健壮与简洁这两方面，我们需要重点关注的内容。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3622"><span data-slate-object="text" data-key="3623"><span data-slate-leaf="true" data-offset-key="3623:0" data-first-offset="true"><span data-slate-string="true">我们先从健壮性开始。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="3624" id="sr-toc-1"><span data-slate-object="text" data-key="3625"><span data-slate-leaf="true" data-offset-key="3625:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_57384b71" data-attr-id="36044" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">健壮性的 “三不要” 原则</span></span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="3626"><span data-slate-object="text" data-key="3627"><span data-slate-leaf="true" data-offset-key="3627:0" data-first-offset="true"><span data-slate-string="true">函数的健壮性设计包括很多方面，首先就有最基本的 “三不要” 原则，我们简单来分析一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3628"><span data-slate-object="text" data-key="3629"><span data-slate-leaf="true" data-offset-key="3629:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">原则一：不要相信任何外部输入的参数。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3630"><span data-slate-object="text" data-key="3631"><span data-slate-leaf="true" data-offset-key="3631:0" data-first-offset="true"><span data-slate-string="true">函数的使用者可能是任何人，这些人在使用函数之前可能都没有阅读过任何手册或文档，他们会向函数传入你意想不到的参数。因此，为了保证函数的健壮性，</span></span><span data-slate-leaf="true" data-offset-key="3631:1"><span data-slate-object="annotation" data-annotation-key="gkann_0af3a46f" data-attr-id="36045" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">函数需要对所有输入的参数进行合法性的检查。</span></span></span><span data-slate-leaf="true" data-offset-key="3631:2"><span data-slate-string="true">一旦发现问题，立即终止函数的执行，返回预设的错误值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3632"><span data-slate-object="text" data-key="3633"><span data-slate-leaf="true" data-offset-key="3633:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">原则二：不要忽略任何一个错误。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3634"><span data-slate-object="text" data-key="3635"><span data-slate-leaf="true" data-offset-key="3635:0" data-first-offset="true"><span data-slate-string="true">在我们的函数实现中，也会调用标准库或第三方包提供的函数或方法。对于这些调用，</span></span><span data-slate-leaf="true" data-offset-key="3635:1"><span data-slate-object="annotation" data-annotation-key="gkann_b9012ec9" data-attr-id="31882" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们不能假定它一定会成功，我们一定要显式地检查这些调用返回的错误值。一旦发现错误，要及时终止函数执行，防止错误继续传播。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3636"><span data-slate-object="text" data-key="3637"><span data-slate-leaf="true" data-offset-key="3637:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">原则三：不要假定异常不会发生。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3638"><span data-slate-object="text" data-key="3639"><span data-slate-leaf="true" data-offset-key="3639:0" data-first-offset="true"><span data-slate-string="true">这里，我们先要确定一个认知：异常不是错误。错误是可预期的，也是经常会发生的，我们有对应的公开错误码和错误处理预案，但异常却是少见的、意料之外的。</span></span><span data-slate-leaf="true" data-offset-key="3639:1"><span data-slate-object="annotation" data-annotation-key="gkann_4ea8a1c1" data-attr-id="37178" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">通常意义上的异常，指的是硬件异常、操作系统异常、语言运行时异常，还有更大可能是代码中潜在 bug 导致的异常，比如代码中出现了以 0 作为分母，或者是数组越界访问等情况。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3640"><span data-slate-object="text" data-key="3641"><span data-slate-leaf="true" data-offset-key="3641:0" data-first-offset="true"><span data-slate-string="true">虽然异常发生是 “小众事件”，但是我们不能假定异常不会发生。所以，函数设计时，我们就需要根据函数的角色和使用场景，考虑是否要在函数内设置异常捕捉和恢复的环节。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3642"><span data-slate-object="text" data-key="3643"><span data-slate-leaf="true" data-offset-key="3643:0" data-first-offset="true"><span data-slate-string="true">在这三条健壮性设计原则中，做到前两条是相对容易的，也没有太多技巧可言。但对第三条异常的处理，很多初学者拿捏不好。所以在这里，我们就重点说一下 </span></span></span><span data-slate-object="text" data-key="3644"><span data-slate-leaf="true" data-offset-key="3644:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Go 函数的异常处理设计</span></span></span></span><span data-slate-object="text" data-key="3645"><span data-slate-leaf="true" data-offset-key="3645:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="3646" id="sr-toc-2"><span data-slate-object="text" data-key="3647"><span data-slate-leaf="true" data-offset-key="3647:0" data-first-offset="true"><span data-slate-string="true">认识 Go 语言中的异常：panic</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="3648"><span data-slate-object="text" data-key="3649"><span data-slate-leaf="true" data-offset-key="3649:0" data-first-offset="true"><span data-slate-string="true">不同编程语言表示异常（Exception）这个概念的语法都不相同。在 Go 语言中，异常这个概念由 panic 表示。一些教程或文章会把它译为恐慌，我这里依旧选择不译，保留 panic 的原汁原味。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3650"><span data-slate-object="text" data-key="3651"><span data-slate-leaf="true" data-offset-key="3651:0" data-first-offset="true"><span data-slate-string="true">panic 指的是 Go 程序在运行时出现的一个异常情况。如果异常出现了，但没有被捕获并恢复，Go 程序的执行就会被终止，</span></span><span data-slate-leaf="true" data-offset-key="3651:1"><span data-slate-object="annotation" data-annotation-key="gkann_7e5331f8" data-attr-id="33740" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">即便出现异常的位置不在主 Goroutine 中也会这样。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3652"><span data-slate-object="text" data-key="3653"><span data-slate-leaf="true" data-offset-key="3653:0" data-first-offset="true"><span data-slate-string="true">在 Go 中，panic 主要有两类来源，</span></span><span data-slate-leaf="true" data-offset-key="3653:1"><span data-slate-object="annotation" data-annotation-key="gkann_28e0b7bc" data-attr-id="31884" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一类是来自 </span></span></span></span><span data-slate-object="text" data-key="3654"><span data-slate-leaf="true" data-offset-key="3654:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_28e0b7bc" data-attr-id="31884" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Go 运行时</span></span></span></span></span><span data-slate-object="text" data-key="3655"><span data-slate-leaf="true" data-offset-key="3655:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_28e0b7bc" data-attr-id="31884" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">，另一类则是 </span></span></span></span><span data-slate-object="text" data-key="3656"><span data-slate-leaf="true" data-offset-key="3656:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_28e0b7bc" data-attr-id="31884" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Go 开发人员通过 panic 函数主动触发的</span></span></span></span></span><span data-slate-object="text" data-key="3657"><span data-slate-leaf="true" data-offset-key="3657:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_28e0b7bc" data-attr-id="31884" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span><span data-slate-leaf="true" data-offset-key="3657:1"><span data-slate-string="true">无论是哪种，</span></span><span data-slate-leaf="true" data-offset-key="3657:2"><span data-slate-object="annotation" data-annotation-key="gkann_f61d6ef1" data-attr-id="32214" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一旦 panic 被触发，后续 Go 程序的执行过程都是一样的，这个过程被 Go 语言称为 </span></span></span></span><span data-slate-object="text" data-key="3658"><span data-slate-leaf="true" data-offset-key="3658:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f61d6ef1" data-attr-id="32214" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">panicking</span></span></span></span></span><span data-slate-object="text" data-key="3659"><span data-slate-leaf="true" data-offset-key="3659:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f61d6ef1" data-attr-id="32214" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3660"><a data-slate-type="link" data-slate-object="inline" data-key="3661"><span data-slate-object="text" data-key="3662"><span data-slate-leaf="true" data-offset-key="3662:0" data-first-offset="true"><span data-slate-string="true">Go 官方文档</span></span></span></a><span data-slate-object="text" data-key="3663"><span data-slate-leaf="true" data-offset-key="3663:0" data-first-offset="true"><span data-slate-string="true">以手工调用 panic 函数触发 panic 为例，对 panicking 这个过程进行了诠释：当函数 F 调用 panic 函数时，函数 F 的执行将停止。不过，</span></span><span data-slate-leaf="true" data-offset-key="3663:1"><span data-slate-object="annotation" data-annotation-key="gkann_b401bc02" data-attr-id="31820" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">函数 F 中已进行求值的 deferred 函数都会得到正常执行，执行完这些 deferred 函数后，函数 F 才会把控制权返还给其调用者。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3664"><span data-slate-object="text" data-key="3665"><span data-slate-leaf="true" data-offset-key="3665:0" data-first-offset="true"><span data-slate-string="true">对于函数 F 的调用者而言，函数 F 之后的行为就如同调用者调用的函数是 panic 一样，该</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="3666"><span data-slate-object="text" data-key="3667"><span data-slate-leaf="true" data-offset-key="3667:0" data-first-offset="true"><span data-slate-string="true"> panicking</span></span></span></span><span data-slate-object="text" data-key="3668"><span data-slate-leaf="true" data-offset-key="3668:0" data-first-offset="true"><span data-slate-string="true"> 过程将继续在栈上进行下去，直到当前 Goroutine 中的所有函数都返回为止，然后 Go 程序将崩溃退出。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3669"><span data-slate-object="text" data-key="3670"><span data-slate-leaf="true" data-offset-key="3670:0" data-first-offset="true"><span data-slate-string="true">我们用一个例子来更直观地解释一下 panicking 这个过程：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="3671"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="3672"><span data-slate-object="text" data-key="3673"><span data-slate-leaf="true" data-offset-key="3673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="3674"><span data-slate-leaf="true" data-offset-key="3674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="3675"><span data-slate-leaf="true" data-offset-key="3675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo</span></span></span></span></span><span data-slate-object="text" data-key="3676"><span data-slate-leaf="true" data-offset-key="3676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="3677"><span data-slate-leaf="true" data-offset-key="3677:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3678"><span data-slate-object="text" data-key="3679"><span data-slate-leaf="true" data-offset-key="3679:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3680"><span data-slate-leaf="true" data-offset-key="3680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3681"><span data-slate-leaf="true" data-offset-key="3681:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3682"><span data-slate-leaf="true" data-offset-key="3682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"call foo"</span></span></span></span><span data-slate-object="text" data-key="3683"><span data-slate-leaf="true" data-offset-key="3683:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3684"><span data-slate-object="text" data-key="3685"><span data-slate-leaf="true" data-offset-key="3685:0" data-first-offset="true"><span data-slate-string="true">    bar()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3686"><span data-slate-object="text" data-key="3687"><span data-slate-leaf="true" data-offset-key="3687:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3688"><span data-slate-leaf="true" data-offset-key="3688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3689"><span data-slate-leaf="true" data-offset-key="3689:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3690"><span data-slate-leaf="true" data-offset-key="3690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exit foo"</span></span></span></span><span data-slate-object="text" data-key="3691"><span data-slate-leaf="true" data-offset-key="3691:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3692"><span data-slate-object="text" data-key="3693"><span data-slate-leaf="true" data-offset-key="3693:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3694"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3695"><span data-slate-object="text" data-key="3696"><span data-slate-leaf="true" data-offset-key="3696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="3697"><span data-slate-leaf="true" data-offset-key="3697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="3698"><span data-slate-leaf="true" data-offset-key="3698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bar</span></span></span></span></span><span data-slate-object="text" data-key="3699"><span data-slate-leaf="true" data-offset-key="3699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="3700"><span data-slate-leaf="true" data-offset-key="3700:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3701"><span data-slate-object="text" data-key="3702"><span data-slate-leaf="true" data-offset-key="3702:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3703"><span data-slate-leaf="true" data-offset-key="3703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3704"><span data-slate-leaf="true" data-offset-key="3704:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3705"><span data-slate-leaf="true" data-offset-key="3705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"call bar"</span></span></span></span><span data-slate-object="text" data-key="3706"><span data-slate-leaf="true" data-offset-key="3706:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3707"><span data-slate-object="text" data-key="3708"><span data-slate-leaf="true" data-offset-key="3708:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3709"><span data-slate-leaf="true" data-offset-key="3709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="3710"><span data-slate-leaf="true" data-offset-key="3710:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3711"><span data-slate-leaf="true" data-offset-key="3711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"panic occurs in bar"</span></span></span></span><span data-slate-object="text" data-key="3712"><span data-slate-leaf="true" data-offset-key="3712:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3713"><span data-slate-object="text" data-key="3714"><span data-slate-leaf="true" data-offset-key="3714:0" data-first-offset="true"><span data-slate-string="true">    zoo()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3715"><span data-slate-object="text" data-key="3716"><span data-slate-leaf="true" data-offset-key="3716:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3717"><span data-slate-leaf="true" data-offset-key="3717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3718"><span data-slate-leaf="true" data-offset-key="3718:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3719"><span data-slate-leaf="true" data-offset-key="3719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exit bar"</span></span></span></span><span data-slate-object="text" data-key="3720"><span data-slate-leaf="true" data-offset-key="3720:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3721"><span data-slate-object="text" data-key="3722"><span data-slate-leaf="true" data-offset-key="3722:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3723"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3724"><span data-slate-object="text" data-key="3725"><span data-slate-leaf="true" data-offset-key="3725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="3726"><span data-slate-leaf="true" data-offset-key="3726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="3727"><span data-slate-leaf="true" data-offset-key="3727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">zoo</span></span></span></span></span><span data-slate-object="text" data-key="3728"><span data-slate-leaf="true" data-offset-key="3728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="3729"><span data-slate-leaf="true" data-offset-key="3729:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3730"><span data-slate-object="text" data-key="3731"><span data-slate-leaf="true" data-offset-key="3731:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3732"><span data-slate-leaf="true" data-offset-key="3732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3733"><span data-slate-leaf="true" data-offset-key="3733:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3734"><span data-slate-leaf="true" data-offset-key="3734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"call zoo"</span></span></span></span><span data-slate-object="text" data-key="3735"><span data-slate-leaf="true" data-offset-key="3735:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3736"><span data-slate-object="text" data-key="3737"><span data-slate-leaf="true" data-offset-key="3737:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3738"><span data-slate-leaf="true" data-offset-key="3738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3739"><span data-slate-leaf="true" data-offset-key="3739:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3740"><span data-slate-leaf="true" data-offset-key="3740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exit zoo"</span></span></span></span><span data-slate-object="text" data-key="3741"><span data-slate-leaf="true" data-offset-key="3741:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3742"><span data-slate-object="text" data-key="3743"><span data-slate-leaf="true" data-offset-key="3743:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3744"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3745"><span data-slate-object="text" data-key="3746"><span data-slate-leaf="true" data-offset-key="3746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="3747"><span data-slate-leaf="true" data-offset-key="3747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="3748"><span data-slate-leaf="true" data-offset-key="3748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="3749"><span data-slate-leaf="true" data-offset-key="3749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="3750"><span data-slate-leaf="true" data-offset-key="3750:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3751"><span data-slate-object="text" data-key="3752"><span data-slate-leaf="true" data-offset-key="3752:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3753"><span data-slate-leaf="true" data-offset-key="3753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3754"><span data-slate-leaf="true" data-offset-key="3754:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3755"><span data-slate-leaf="true" data-offset-key="3755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"call main"</span></span></span></span><span data-slate-object="text" data-key="3756"><span data-slate-leaf="true" data-offset-key="3756:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3757"><span data-slate-object="text" data-key="3758"><span data-slate-leaf="true" data-offset-key="3758:0" data-first-offset="true"><span data-slate-string="true">    foo()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3759"><span data-slate-object="text" data-key="3760"><span data-slate-leaf="true" data-offset-key="3760:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3761"><span data-slate-leaf="true" data-offset-key="3761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3762"><span data-slate-leaf="true" data-offset-key="3762:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3763"><span data-slate-leaf="true" data-offset-key="3763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exit main"</span></span></span></span><span data-slate-object="text" data-key="3764"><span data-slate-leaf="true" data-offset-key="3764:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3765"><span data-slate-object="text" data-key="3766"><span data-slate-leaf="true" data-offset-key="3766:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3767"><span data-slate-object="text" data-key="3768"><span data-slate-leaf="true" data-offset-key="3768:0" data-first-offset="true"><span data-slate-string="true">上面这个例子中，从 Go 应用入口开始，函数的调用次序依次为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="3769"><span data-slate-object="text" data-key="3770"><span data-slate-leaf="true" data-offset-key="3770:0" data-first-offset="true"><span data-slate-string="true"> main -&gt; foo -&gt; bar -&gt; zoo</span></span></span></span><span data-slate-object="text" data-key="3771"><span data-slate-leaf="true" data-offset-key="3771:0" data-first-offset="true"><span data-slate-string="true">。在 bar 函数中，我们调用 panic 函数手动触发了 panic。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3772"><span data-slate-object="text" data-key="3773"><span data-slate-leaf="true" data-offset-key="3773:0" data-first-offset="true"><span data-slate-string="true">我们执行这个程序的输出结果是这样的：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="3774"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="3775"><span data-slate-object="text" data-key="3776"><span data-slate-leaf="true" data-offset-key="3776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">call</span></span></span></span><span data-slate-object="text" data-key="3777"><span data-slate-leaf="true" data-offset-key="3777:0" data-first-offset="true"><span data-slate-string="true"> main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3778"><span data-slate-object="text" data-key="3779"><span data-slate-leaf="true" data-offset-key="3779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">call</span></span></span></span><span data-slate-object="text" data-key="3780"><span data-slate-leaf="true" data-offset-key="3780:0" data-first-offset="true"><span data-slate-string="true"> foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3781"><span data-slate-object="text" data-key="3782"><span data-slate-leaf="true" data-offset-key="3782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">call</span></span></span></span><span data-slate-object="text" data-key="3783"><span data-slate-leaf="true" data-offset-key="3783:0" data-first-offset="true"><span data-slate-string="true"> bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3784"><span data-slate-object="text" data-key="3785"><span data-slate-leaf="true" data-offset-key="3785:0" data-first-offset="true"><span data-slate-string="true">panic: panic occurs </span></span></span><span data-slate-object="text" data-key="3786"><span data-slate-leaf="true" data-offset-key="3786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">in</span></span></span></span><span data-slate-object="text" data-key="3787"><span data-slate-leaf="true" data-offset-key="3787:0" data-first-offset="true"><span data-slate-string="true"> bar</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3788"><span data-slate-object="text" data-key="3789"><span data-slate-leaf="true" data-offset-key="3789:0" data-first-offset="true"><span data-slate-string="true">我们再根据前面对 panicking 过程的诠释，理解一下这个例子。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3790"><span data-slate-object="text" data-key="3791"><span data-slate-leaf="true" data-offset-key="3791:0" data-first-offset="true"><span data-slate-string="true">这里，程序从入口函数 main 开始依次调用了 foo、bar 函数，在 bar 函数中，代码在调用 zoo 函数之前调用了 panic 函数触发了异常。那示例的 panicking 过程就从这开始了。bar 函数调用 panic 函数之后，它自身的执行就此停止了，所以我们也没有看到代码继续进入 zoo 函数执行。并且，bar 函数没有捕捉这个 panic，这样这个 panic 就会沿着函数调用栈向上走，来到了 bar 函数的调用者 foo 函数中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3792"><span data-slate-object="text" data-key="3793"><span data-slate-leaf="true" data-offset-key="3793:0" data-first-offset="true"><span data-slate-string="true">从 foo 函数的视角来看，这就好比将它对 bar 函数的调用，换成了对 panic 函数的调用一样。这样一来，foo 函数的执行也被停止了。由于 foo 函数也没有捕捉 panic，于是 panic 继续沿着函数调用栈向上走，来到了 foo 函数的调用者 main 函数中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3794"><span data-slate-object="text" data-key="3795"><span data-slate-leaf="true" data-offset-key="3795:0" data-first-offset="true"><span data-slate-string="true">同理，从 main 函数的视角来看，这就好比将它对 foo 函数的调用，换成了对 panic 函数的调用一样。结果就是，main 函数的执行也被终止了，于是整个程序异常退出，日志 "exit main" 也没有得到输出的机会。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3796"><span data-slate-object="text" data-key="3797"><span data-slate-leaf="true" data-offset-key="3797:0" data-first-offset="true"><span data-slate-string="true">不过，Go 也提供了捕捉 panic 并恢复程序正常执行秩序的方法，我们可以通过 </span></span></span><span data-slate-object="text" data-key="3798"><span data-slate-leaf="true" data-offset-key="3798:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">recover 函数</span></span></span></span><span data-slate-object="text" data-key="3799"><span data-slate-leaf="true" data-offset-key="3799:0" data-first-offset="true"><span data-slate-string="true">来实现这一点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3800"><span data-slate-object="text" data-key="3801"><span data-slate-leaf="true" data-offset-key="3801:0" data-first-offset="true"><span data-slate-string="true">我们继续用上面这个例子分析，在触发 panic 的 bar 函数中，对 panic 进行捕捉并恢复，我们直接来看恢复后，整个程序的执行情况是什么样的。这里，我们只列出了变更后的 bar 函数代码，其他函数代码并没有改变：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="3802"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="3803"><span data-slate-object="text" data-key="3804"><span data-slate-leaf="true" data-offset-key="3804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="3805"><span data-slate-leaf="true" data-offset-key="3805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="3806"><span data-slate-leaf="true" data-offset-key="3806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bar</span></span></span></span></span><span data-slate-object="text" data-key="3807"><span data-slate-leaf="true" data-offset-key="3807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="3808"><span data-slate-leaf="true" data-offset-key="3808:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3809"><span data-slate-object="text" data-key="3810"><span data-slate-leaf="true" data-offset-key="3810:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_3cb7f4a3" data-attr-id="33308" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="3811"><span data-slate-leaf="true" data-offset-key="3811:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_3cb7f4a3" data-attr-id="33308" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span></span><span data-slate-object="text" data-key="3812"><span data-slate-leaf="true" data-offset-key="3812:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_3cb7f4a3" data-attr-id="33308" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="3813"><span data-slate-leaf="true" data-offset-key="3813:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_3cb7f4a3" data-attr-id="33308" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span></span><span data-slate-object="text" data-key="3814"><span data-slate-leaf="true" data-offset-key="3814:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_3cb7f4a3" data-attr-id="33308" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></span><span data-slate-object="text" data-key="3815"><span data-slate-leaf="true" data-offset-key="3815:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_3cb7f4a3" data-attr-id="33308" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> {</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3816"><span data-slate-object="text" data-key="3817"><span data-slate-leaf="true" data-offset-key="3817:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f7227d7d" data-attr-id="33309" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">        </span></span></span></span><span data-slate-object="text" data-key="3818"><span data-slate-leaf="true" data-offset-key="3818:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f7227d7d" data-attr-id="33309" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span></span><span data-slate-object="text" data-key="3819"><span data-slate-leaf="true" data-offset-key="3819:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f7227d7d" data-attr-id="33309" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> e := </span></span></span></span><span data-slate-object="text" data-key="3820"><span data-slate-leaf="true" data-offset-key="3820:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f7227d7d" data-attr-id="33309" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">recover</span></span></span></span></span><span data-slate-object="text" data-key="3821"><span data-slate-leaf="true" data-offset-key="3821:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f7227d7d" data-attr-id="33309" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">(); e != </span></span></span></span><span data-slate-object="text" data-key="3822"><span data-slate-leaf="true" data-offset-key="3822:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f7227d7d" data-attr-id="33309" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></span><span data-slate-object="text" data-key="3823"><span data-slate-leaf="true" data-offset-key="3823:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f7227d7d" data-attr-id="33309" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> {</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3824"><span data-slate-object="text" data-key="3825"><span data-slate-leaf="true" data-offset-key="3825:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_35fa3c71" data-attr-id="33310" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">            fmt.Println(</span></span></span></span><span data-slate-object="text" data-key="3826"><span data-slate-leaf="true" data-offset-key="3826:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_35fa3c71" data-attr-id="33310" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"recover the panic:"</span></span></span></span></span><span data-slate-object="text" data-key="3827"><span data-slate-leaf="true" data-offset-key="3827:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_35fa3c71" data-attr-id="33310" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">, e)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3828"><span data-slate-object="text" data-key="3829"><span data-slate-leaf="true" data-offset-key="3829:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3830"><span data-slate-object="text" data-key="3831"><span data-slate-leaf="true" data-offset-key="3831:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3832"></div><div data-slate-type="code-line" data-slate-object="block" data-key="3833"><span data-slate-object="text" data-key="3834"><span data-slate-leaf="true" data-offset-key="3834:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3835"><span data-slate-leaf="true" data-offset-key="3835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3836"><span data-slate-leaf="true" data-offset-key="3836:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3837"><span data-slate-leaf="true" data-offset-key="3837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"call bar"</span></span></span></span><span data-slate-object="text" data-key="3838"><span data-slate-leaf="true" data-offset-key="3838:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3839"><span data-slate-object="text" data-key="3840"><span data-slate-leaf="true" data-offset-key="3840:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3841"><span data-slate-leaf="true" data-offset-key="3841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="3842"><span data-slate-leaf="true" data-offset-key="3842:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3843"><span data-slate-leaf="true" data-offset-key="3843:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"panic occurs in bar"</span></span></span></span><span data-slate-object="text" data-key="3844"><span data-slate-leaf="true" data-offset-key="3844:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3845"><span data-slate-object="text" data-key="3846"><span data-slate-leaf="true" data-offset-key="3846:0" data-first-offset="true"><span data-slate-string="true">    zoo()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3847"><span data-slate-object="text" data-key="3848"><span data-slate-leaf="true" data-offset-key="3848:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3849"><span data-slate-leaf="true" data-offset-key="3849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="3850"><span data-slate-leaf="true" data-offset-key="3850:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="3851"><span data-slate-leaf="true" data-offset-key="3851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exit bar"</span></span></span></span><span data-slate-object="text" data-key="3852"><span data-slate-leaf="true" data-offset-key="3852:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3853"><span data-slate-object="text" data-key="3854"><span data-slate-leaf="true" data-offset-key="3854:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3855"><span data-slate-object="text" data-key="3856"><span data-slate-leaf="true" data-offset-key="3856:0" data-first-offset="true"><span data-slate-string="true">在更新版的 bar 函数中，我们在一个 defer 匿名函数中调用 recover 函数对 panic 进行了捕捉。</span></span><span data-slate-leaf="true" data-offset-key="3856:1"><span data-slate-object="annotation" data-annotation-key="gkann_33659e83" data-attr-id="40149" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">recover 是 Go 内置的专门用于恢复 panic 的函数，它必须被放在一个 defer 函数中才能生效。如果 recover 捕捉到 panic，它就会返回以 panic 的具体内容为错误上下文信息的错误值。如果没有 panic 发生，那么 recover 将返回 nil。而且，如果 panic 被 recover 捕捉到，panic 引发的 panicking 过程就会停止。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3857"><span data-slate-object="text" data-key="3858"><span data-slate-leaf="true" data-offset-key="3858:0" data-first-offset="true"><span data-slate-string="true">关于 defer 函数的内容我们等会还会详细讲。此刻你只需要知道，无论 bar 函数正常执行结束，还是因 panic 异常终止，</span></span><span data-slate-leaf="true" data-offset-key="3858:1"><span data-slate-object="annotation" data-annotation-key="gkann_e126fed2" data-attr-id="38472" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在那之前设置成功的 defer 函数都会得到执行就可以了。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3859"><span data-slate-object="text" data-key="3860"><span data-slate-leaf="true" data-offset-key="3860:0" data-first-offset="true"><span data-slate-string="true">我们执行更新后的程序，得到如下结果：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="3861"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="3862"><span data-slate-object="text" data-key="3863"><span data-slate-leaf="true" data-offset-key="3863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">call</span></span></span></span><span data-slate-object="text" data-key="3864"><span data-slate-leaf="true" data-offset-key="3864:0" data-first-offset="true"><span data-slate-string="true"> main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3865"><span data-slate-object="text" data-key="3866"><span data-slate-leaf="true" data-offset-key="3866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">call</span></span></span></span><span data-slate-object="text" data-key="3867"><span data-slate-leaf="true" data-offset-key="3867:0" data-first-offset="true"><span data-slate-string="true"> foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3868"><span data-slate-object="text" data-key="3869"><span data-slate-leaf="true" data-offset-key="3869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">call</span></span></span></span><span data-slate-object="text" data-key="3870"><span data-slate-leaf="true" data-offset-key="3870:0" data-first-offset="true"><span data-slate-string="true"> bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3871"><span data-slate-object="text" data-key="3872"><span data-slate-leaf="true" data-offset-key="3872:0" data-first-offset="true"><span data-slate-string="true">recover the panic: panic occurs </span></span></span><span data-slate-object="text" data-key="3873"><span data-slate-leaf="true" data-offset-key="3873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">in</span></span></span></span><span data-slate-object="text" data-key="3874"><span data-slate-leaf="true" data-offset-key="3874:0" data-first-offset="true"><span data-slate-string="true"> bar</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3875"><span data-slate-object="text" data-key="3876"><span data-slate-leaf="true" data-offset-key="3876:0" data-first-offset="true"><span data-slate-string="true">exit foo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3877"><span data-slate-object="text" data-key="3878"><span data-slate-leaf="true" data-offset-key="3878:0" data-first-offset="true"><span data-slate-string="true">exit main</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3879"><span data-slate-object="text" data-key="3880"><span data-slate-leaf="true" data-offset-key="3880:0" data-first-offset="true"><span data-slate-string="true">我们可以看到 main 函数终于得以 “善终”。那这个过程中究竟发生了什么呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3881"><span data-slate-object="text" data-key="3882"><span data-slate-leaf="true" data-offset-key="3882:0" data-first-offset="true"><span data-slate-string="true">在更新后的代码中，当 bar 函数调用 panic 函数触发异常后，bar 函数的执行就会被中断。但这一次，在代码执行流回到 bar 函数调用者之前，bar 函数中的、在 panic 之前就已经被设置成功的 derfer 函数就会被执行。这个匿名函数会调用 recover 把刚刚触发的 panic 恢复，这样，panic 还没等沿着函数栈向上走，就被消除了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3883"><span data-slate-object="text" data-key="3884"><span data-slate-leaf="true" data-offset-key="3884:0" data-first-offset="true"><span data-slate-string="true">所以，这个时候，从 foo 函数的视角来看，bar 函数与正常返回没有什么差别。foo 函数依旧继续向下执行，直至 main 函数成功返回。这样，这个程序的 panic “危机” 就解除了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3885"><span data-slate-object="text" data-key="3886"><span data-slate-leaf="true" data-offset-key="3886:0" data-first-offset="true"><span data-slate-string="true">面对有如此行为特点的 panic，我们应该如何应对呢？是不是在所有 Go 函数或方法中，我们都要用 defer 函数来捕捉和恢复 panic 呢？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="3887" id="sr-toc-3"><span data-slate-object="text" data-key="3888"><span data-slate-leaf="true" data-offset-key="3888:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_e504fe29" data-attr-id="42946" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如何应对 panic？</span></span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="3889"><span data-slate-object="text" data-key="3890"><span data-slate-leaf="true" data-offset-key="3890:0" data-first-offset="true"><span data-slate-string="true">其实大可不必。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3891"><span data-slate-object="text" data-key="3892"><span data-slate-leaf="true" data-offset-key="3892:0" data-first-offset="true"><span data-slate-string="true">一来，这样做会徒增开发人员函数实现时的心智负担。二来，很多函数非常简单，根本不会出现 panic 情况，我们增加 panic 捕获和恢复，反倒会增加函数的复杂性。同时，defer 函数也不是 “免费” 的，也有带来性能开销（这个我们后面会讲解）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3893"><span data-slate-object="text" data-key="3894"><span data-slate-leaf="true" data-offset-key="3894:0" data-first-offset="true"><span data-slate-string="true">那么，日常情况下我们应该怎么做呢？我这里提供了三点经验，你可以参考一下。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="3895" id="sr-toc-4"><span data-slate-object="text" data-key="3896"><span data-slate-leaf="true" data-offset-key="3896:0" data-first-offset="true"><span data-slate-string="true">第一点：评估程序对 panic 的忍受度</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="3897"><span data-slate-object="text" data-key="3898"><span data-slate-leaf="true" data-offset-key="3898:0" data-first-offset="true"><span data-slate-string="true">首先，我们应该知道一个事实：</span></span></span><span data-slate-object="text" data-key="3899"><span data-slate-leaf="true" data-offset-key="3899:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不同应用对异常引起的程序崩溃退出的忍受度是不一样的</span></span></span></span><span data-slate-object="text" data-key="3900"><span data-slate-leaf="true" data-offset-key="3900:0" data-first-offset="true"><span data-slate-string="true">。比如，一个单次运行于控制台窗口中的命令行交互类程序（CLI），和一个常驻内存的后端 HTTP 服务器程序，对异常崩溃的忍受度就是不同的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3901"><span data-slate-object="text" data-key="3902"><span data-slate-leaf="true" data-offset-key="3902:0" data-first-offset="true"><span data-slate-string="true">前者即便因异常崩溃，对用户来说也仅仅是再重新运行一次而已。但后者一旦崩溃，就很可能导致整个网站停止服务。所以，</span></span></span><span data-slate-object="text" data-key="3903"><span data-slate-leaf="true" data-offset-key="3903:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">针对各种应用对 panic 忍受度的差异，我们采取的应对 panic 的策略也应该有不同</span></span></span></span><span data-slate-object="text" data-key="3904"><span data-slate-leaf="true" data-offset-key="3904:0" data-first-offset="true"><span data-slate-string="true">。像后端 HTTP 服务器程序这样的任务关键系统，我们就需要在特定位置捕捉并恢复 panic，以保证服务器整体的健壮度。在这方面，Go 标准库中的 http server 就是一个典型的代表。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3905"><span data-slate-object="text" data-key="3906"><span data-slate-leaf="true" data-offset-key="3906:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_53fd8ae9" data-attr-id="36046" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Go 标准库提供的 http server 采用的是，每个客户端连接都使用一个单独的 Goroutine 进行处理的并发处理模型。</span></span></span><span data-slate-leaf="true" data-offset-key="3906:1"><span data-slate-string="true">也就是说，客户端一旦与 http server 连接成功，http server 就会为这个连接新创建一个 Goroutine，并在这 Goroutine 中执行对应连接（conn）的 serve 方法，来处理这条连接上的客户端请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3907"><span data-slate-object="text" data-key="3908"><span data-slate-leaf="true" data-offset-key="3908:0" data-first-offset="true"><span data-slate-string="true">前面提到了 panic 的 “危害” 时，我们说过，</span></span></span><span data-slate-object="text" data-key="3909"><span data-slate-leaf="true" data-offset-key="3909:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_bc4aed60" data-attr-id="44154" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">无论在哪个 Goroutine 中发生未被恢复的 panic，整个程序都将崩溃退出</span></span></span></span></span><span data-slate-object="text" data-key="3910"><span data-slate-leaf="true" data-offset-key="3910:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_bc4aed60" data-attr-id="44154" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span><span data-slate-leaf="true" data-offset-key="3910:1"><span data-slate-string="true">所以，为了保证处理某一个客户端连接的 Goroutine 出现 panic 时，不影响到 http server 主 Goroutine 的运行，Go 标准库在 serve 方法中加入了对 panic 的捕捉与恢复，下面是 serve 方法的部分代码片段：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="3911"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="3912"><span data-slate-object="text" data-key="3913"><span data-slate-leaf="true" data-offset-key="3913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/net/http/server.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3914"><span data-slate-object="text" data-key="3915"><span data-slate-leaf="true" data-offset-key="3915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Serve a new connection.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3916"><span data-slate-object="text" data-key="3917"><span data-slate-leaf="true" data-offset-key="3917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="3918"><span data-slate-leaf="true" data-offset-key="3918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="3919"><span data-slate-leaf="true" data-offset-key="3919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *conn)</span></span></span></span></span><span data-slate-object="text" data-key="3920"><span data-slate-leaf="true" data-offset-key="3920:0" data-first-offset="true"><span data-slate-string="true"> serve(ctx context.Context) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3921"><span data-slate-object="text" data-key="3922"><span data-slate-leaf="true" data-offset-key="3922:0" data-first-offset="true"><span data-slate-string="true">    c.remoteAddr = c.rwc.RemoteAddr().String()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3923"><span data-slate-object="text" data-key="3924"><span data-slate-leaf="true" data-offset-key="3924:0" data-first-offset="true"><span data-slate-string="true">    ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3925"><span data-slate-object="text" data-key="3926"><span data-slate-leaf="true" data-offset-key="3926:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="3927"><span data-slate-leaf="true" data-offset-key="3927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="3928"><span data-slate-leaf="true" data-offset-key="3928:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="3929"><span data-slate-leaf="true" data-offset-key="3929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="3930"><span data-slate-leaf="true" data-offset-key="3930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="3931"><span data-slate-leaf="true" data-offset-key="3931:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3932"><span data-slate-object="text" data-key="3933"><span data-slate-leaf="true" data-offset-key="3933:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="3934"><span data-slate-leaf="true" data-offset-key="3934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="3935"><span data-slate-leaf="true" data-offset-key="3935:0" data-first-offset="true"><span data-slate-string="true"> err := </span></span></span><span data-slate-object="text" data-key="3936"><span data-slate-leaf="true" data-offset-key="3936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">recover</span></span></span></span><span data-slate-object="text" data-key="3937"><span data-slate-leaf="true" data-offset-key="3937:0" data-first-offset="true"><span data-slate-string="true">(); err != </span></span></span><span data-slate-object="text" data-key="3938"><span data-slate-leaf="true" data-offset-key="3938:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="3939"><span data-slate-leaf="true" data-offset-key="3939:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; err != ErrAbortHandler {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3940"><span data-slate-object="text" data-key="3941"><span data-slate-leaf="true" data-offset-key="3941:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="3942"><span data-slate-leaf="true" data-offset-key="3942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="3943"><span data-slate-leaf="true" data-offset-key="3943:0" data-first-offset="true"><span data-slate-string="true"> size = </span></span></span><span data-slate-object="text" data-key="3944"><span data-slate-leaf="true" data-offset-key="3944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">64</span></span></span></span><span data-slate-object="text" data-key="3945"><span data-slate-leaf="true" data-offset-key="3945:0" data-first-offset="true"><span data-slate-string="true"> &lt;&lt; </span></span></span><span data-slate-object="text" data-key="3946"><span data-slate-leaf="true" data-offset-key="3946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3947"><span data-slate-object="text" data-key="3948"><span data-slate-leaf="true" data-offset-key="3948:0" data-first-offset="true"><span data-slate-string="true">            buf := </span></span></span><span data-slate-object="text" data-key="3949"><span data-slate-leaf="true" data-offset-key="3949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="3950"><span data-slate-leaf="true" data-offset-key="3950:0" data-first-offset="true"><span data-slate-string="true">([]</span></span></span><span data-slate-object="text" data-key="3951"><span data-slate-leaf="true" data-offset-key="3951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="3952"><span data-slate-leaf="true" data-offset-key="3952:0" data-first-offset="true"><span data-slate-string="true">, size)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3953"><span data-slate-object="text" data-key="3954"><span data-slate-leaf="true" data-offset-key="3954:0" data-first-offset="true"><span data-slate-string="true">            buf = buf[:runtime.Stack(buf, </span></span></span><span data-slate-object="text" data-key="3955"><span data-slate-leaf="true" data-offset-key="3955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="3956"><span data-slate-leaf="true" data-offset-key="3956:0" data-first-offset="true"><span data-slate-string="true">)]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3957"><span data-slate-object="text" data-key="3958"><span data-slate-leaf="true" data-offset-key="3958:0" data-first-offset="true"><span data-slate-string="true">            c.server.logf(</span></span></span><span data-slate-object="text" data-key="3959"><span data-slate-leaf="true" data-offset-key="3959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"http: panic serving %v: %v\n%s"</span></span></span></span><span data-slate-object="text" data-key="3960"><span data-slate-leaf="true" data-offset-key="3960:0" data-first-offset="true"><span data-slate-string="true">, c.remoteAddr, err, buf)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3961"><span data-slate-object="text" data-key="3962"><span data-slate-leaf="true" data-offset-key="3962:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3963"><span data-slate-object="text" data-key="3964"><span data-slate-leaf="true" data-offset-key="3964:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="3965"><span data-slate-leaf="true" data-offset-key="3965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="3966"><span data-slate-leaf="true" data-offset-key="3966:0" data-first-offset="true"><span data-slate-string="true"> !c.hijacked() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3967"><span data-slate-object="text" data-key="3968"><span data-slate-leaf="true" data-offset-key="3968:0" data-first-offset="true"><span data-slate-string="true">            c.</span></span></span><span data-slate-object="text" data-key="3969"><span data-slate-leaf="true" data-offset-key="3969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="3970"><span data-slate-leaf="true" data-offset-key="3970:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3971"><span data-slate-object="text" data-key="3972"><span data-slate-leaf="true" data-offset-key="3972:0" data-first-offset="true"><span data-slate-string="true">            c.setState(c.rwc, StateClosed, runHooks)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3973"><span data-slate-object="text" data-key="3974"><span data-slate-leaf="true" data-offset-key="3974:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3975"><span data-slate-object="text" data-key="3976"><span data-slate-leaf="true" data-offset-key="3976:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3977"><span data-slate-object="text" data-key="3978"><span data-slate-leaf="true" data-offset-key="3978:0" data-first-offset="true"><span data-slate-string="true">    ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="3979"><span data-slate-object="text" data-key="3980"><span data-slate-leaf="true" data-offset-key="3980:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3981"><span data-slate-object="text" data-key="3982"><span data-slate-leaf="true" data-offset-key="3982:0" data-first-offset="true"><span data-slate-string="true">你可以看到，serve 方法在一开始处就设置了 defer 函数，并在该函数中捕捉并恢复了可能出现的 panic。这样，即便处理某个客户端连接的 Goroutine 出现 panic，处理其他连接 Goroutine 以及 http server 自身都不会受到影响。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3983"><span data-slate-object="text" data-key="3984"><span data-slate-leaf="true" data-offset-key="3984:0" data-first-offset="true"><span data-slate-string="true">这种</span></span></span><span data-slate-object="text" data-key="3985"><span data-slate-leaf="true" data-offset-key="3985:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">局部不要影响整体</span></span></span></span><span data-slate-object="text" data-key="3986"><span data-slate-leaf="true" data-offset-key="3986:0" data-first-offset="true"><span data-slate-string="true">的异常处理策略，在很多并发程序中都有应用。并且，捕捉和恢复 panic 的位置通常都在子 Goroutine 的起始处，这样设置可以捕捉到后面代码中可能出现的所有 panic，就像 serve 方法中那样。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="3987" id="sr-toc-5"><span data-slate-object="text" data-key="3988"><span data-slate-leaf="true" data-offset-key="3988:0" data-first-offset="true"><span data-slate-string="true">第二点：提示潜在 bug</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="3989"><span data-slate-object="text" data-key="3990"><span data-slate-leaf="true" data-offset-key="3990:0" data-first-offset="true"><span data-slate-string="true">有了对 panic 忍受度的评估，panic 是不是也没有那么 “恐怖” 了呢？而且，我们甚至可以借助 panic 来帮助我们快速找到潜在 bug。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3991"><span data-slate-object="text" data-key="3992"><span data-slate-leaf="true" data-offset-key="3992:0" data-first-offset="true"><span data-slate-string="true">C 语言中有个很好用的辅助函数，断言（assert 宏）。在使用 C 编写代码时，我们经常在一些代码执行路径上，使用断言来表达这段执行路径上某种条件一定为真的信心。断言为真，则程序处于正确运行状态，断言为否就是出现了意料之外的问题，而这个问题很可能就是一个潜在的 bug，这时我们可以借助断言信息快速定位到问题所在。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3993"><span data-slate-object="text" data-key="3994"><span data-slate-leaf="true" data-offset-key="3994:0" data-first-offset="true"><span data-slate-string="true">不过，Go 语言标准库中并没有提供断言之类的辅助函数，但我们可以使用 panic，部分模拟断言对潜在 bug 的提示功能。比如，下面就是标准库</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="3995"><span data-slate-object="text" data-key="3996"><span data-slate-leaf="true" data-offset-key="3996:0" data-first-offset="true"><span data-slate-string="true"> encoding/json</span></span></span></span><span data-slate-object="text" data-key="3997"><span data-slate-leaf="true" data-offset-key="3997:0" data-first-offset="true"><span data-slate-string="true"> 包使用 panic 指示潜在 bug 的一个例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="3998"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="3999"><span data-slate-object="text" data-key="4000"><span data-slate-leaf="true" data-offset-key="4000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/encoding/json/decode.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4001"><span data-slate-object="text" data-key="4002"><span data-slate-leaf="true" data-offset-key="4002:0" data-first-offset="true"><span data-slate-string="true">... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4003"><span data-slate-object="text" data-key="4004"><span data-slate-leaf="true" data-offset-key="4004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当一些本不该发生的事情导致我们结束处理时，phasePanicMsg 将被用作 panic 消息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4005"><span data-slate-object="text" data-key="4006"><span data-slate-leaf="true" data-offset-key="4006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 它可以指示 JSON 解码器中的 bug，或者</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4007"><span data-slate-object="text" data-key="4008"><span data-slate-leaf="true" data-offset-key="4008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在解码器执行时还有其他代码正在修改数据切片。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4009"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4010"><span data-slate-object="text" data-key="4011"><span data-slate-leaf="true" data-offset-key="4011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="4012"><span data-slate-leaf="true" data-offset-key="4012:0" data-first-offset="true"><span data-slate-string="true"> phasePanicMsg = </span></span></span><span data-slate-object="text" data-key="4013"><span data-slate-leaf="true" data-offset-key="4013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"JSON decoder out of sync - data changing underfoot?"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4014"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4015"><span data-slate-object="text" data-key="4016"><span data-slate-leaf="true" data-offset-key="4016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4017"><span data-slate-leaf="true" data-offset-key="4017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4018"><span data-slate-leaf="true" data-offset-key="4018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(d *decodeState)</span></span></span></span></span><span data-slate-object="text" data-key="4019"><span data-slate-leaf="true" data-offset-key="4019:0" data-first-offset="true"><span data-slate-string="true"> init(data []</span></span></span><span data-slate-object="text" data-key="4020"><span data-slate-leaf="true" data-offset-key="4020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="4021"><span data-slate-leaf="true" data-offset-key="4021:0" data-first-offset="true"><span data-slate-string="true">) *decodeState {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4022"><span data-slate-object="text" data-key="4023"><span data-slate-leaf="true" data-offset-key="4023:0" data-first-offset="true"><span data-slate-string="true">    d.data = data</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4024"><span data-slate-object="text" data-key="4025"><span data-slate-leaf="true" data-offset-key="4025:0" data-first-offset="true"><span data-slate-string="true">    d.off = </span></span></span><span data-slate-object="text" data-key="4026"><span data-slate-leaf="true" data-offset-key="4026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4027"><span data-slate-object="text" data-key="4028"><span data-slate-leaf="true" data-offset-key="4028:0" data-first-offset="true"><span data-slate-string="true">    d.savedError = </span></span></span><span data-slate-object="text" data-key="4029"><span data-slate-leaf="true" data-offset-key="4029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4030"><span data-slate-object="text" data-key="4031"><span data-slate-leaf="true" data-offset-key="4031:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4032"><span data-slate-leaf="true" data-offset-key="4032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4033"><span data-slate-leaf="true" data-offset-key="4033:0" data-first-offset="true"><span data-slate-string="true"> d.errorContext != </span></span></span><span data-slate-object="text" data-key="4034"><span data-slate-leaf="true" data-offset-key="4034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4035"><span data-slate-leaf="true" data-offset-key="4035:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4036"><span data-slate-object="text" data-key="4037"><span data-slate-leaf="true" data-offset-key="4037:0" data-first-offset="true"><span data-slate-string="true">        d.errorContext.Struct = </span></span></span><span data-slate-object="text" data-key="4038"><span data-slate-leaf="true" data-offset-key="4038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4039"><span data-slate-object="text" data-key="4040"><span data-slate-leaf="true" data-offset-key="4040:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4041"><span data-slate-leaf="true" data-offset-key="4041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Reuse the allocated space for the FieldStack slice.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4042"><span data-slate-object="text" data-key="4043"><span data-slate-leaf="true" data-offset-key="4043:0" data-first-offset="true"><span data-slate-string="true">        d.errorContext.FieldStack = d.errorContext.FieldStack[:</span></span></span><span data-slate-object="text" data-key="4044"><span data-slate-leaf="true" data-offset-key="4044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4045"><span data-slate-leaf="true" data-offset-key="4045:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4046"><span data-slate-object="text" data-key="4047"><span data-slate-leaf="true" data-offset-key="4047:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4048"><span data-slate-object="text" data-key="4049"><span data-slate-leaf="true" data-offset-key="4049:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4050"><span data-slate-leaf="true" data-offset-key="4050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4051"><span data-slate-leaf="true" data-offset-key="4051:0" data-first-offset="true"><span data-slate-string="true"> d</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4052"><span data-slate-object="text" data-key="4053"><span data-slate-leaf="true" data-offset-key="4053:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4054"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4055"><span data-slate-object="text" data-key="4056"><span data-slate-leaf="true" data-offset-key="4056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4057"><span data-slate-leaf="true" data-offset-key="4057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4058"><span data-slate-leaf="true" data-offset-key="4058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(d *decodeState)</span></span></span></span></span><span data-slate-object="text" data-key="4059"><span data-slate-leaf="true" data-offset-key="4059:0" data-first-offset="true"><span data-slate-string="true"> valueQuoted() </span></span></span><span data-slate-object="text" data-key="4060"><span data-slate-leaf="true" data-offset-key="4060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="4061"><span data-slate-leaf="true" data-offset-key="4061:0" data-first-offset="true"><span data-slate-string="true">{} {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4062"><span data-slate-object="text" data-key="4063"><span data-slate-leaf="true" data-offset-key="4063:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4064"><span data-slate-leaf="true" data-offset-key="4064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">switch</span></span></span></span><span data-slate-object="text" data-key="4065"><span data-slate-leaf="true" data-offset-key="4065:0" data-first-offset="true"><span data-slate-string="true"> d.opcode {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4066"><span data-slate-object="text" data-key="4067"><span data-slate-leaf="true" data-offset-key="4067:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4068"><span data-slate-leaf="true" data-offset-key="4068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="4069"><span data-slate-leaf="true" data-offset-key="4069:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4070"><span data-slate-object="text" data-key="4071"><span data-slate-leaf="true" data-offset-key="4071:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4072"><span data-slate-leaf="true" data-offset-key="4072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="4073"><span data-slate-leaf="true" data-offset-key="4073:0" data-first-offset="true"><span data-slate-string="true">(phasePanicMsg)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4074"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4075"><span data-slate-object="text" data-key="4076"><span data-slate-leaf="true" data-offset-key="4076:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4077"><span data-slate-leaf="true" data-offset-key="4077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4078"><span data-slate-leaf="true" data-offset-key="4078:0" data-first-offset="true"><span data-slate-string="true"> scanBeginArray, scanBeginObject:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4079"><span data-slate-object="text" data-key="4080"><span data-slate-leaf="true" data-offset-key="4080:0" data-first-offset="true"><span data-slate-string="true">        d.skip()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4081"><span data-slate-object="text" data-key="4082"><span data-slate-leaf="true" data-offset-key="4082:0" data-first-offset="true"><span data-slate-string="true">        d.scanNext()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4083"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4084"><span data-slate-object="text" data-key="4085"><span data-slate-leaf="true" data-offset-key="4085:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4086"><span data-slate-leaf="true" data-offset-key="4086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4087"><span data-slate-leaf="true" data-offset-key="4087:0" data-first-offset="true"><span data-slate-string="true"> scanBeginLiteral:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4088"><span data-slate-object="text" data-key="4089"><span data-slate-leaf="true" data-offset-key="4089:0" data-first-offset="true"><span data-slate-string="true">        v := d.literalInterface()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4090"><span data-slate-object="text" data-key="4091"><span data-slate-leaf="true" data-offset-key="4091:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4092"><span data-slate-leaf="true" data-offset-key="4092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">switch</span></span></span></span><span data-slate-object="text" data-key="4093"><span data-slate-leaf="true" data-offset-key="4093:0" data-first-offset="true"><span data-slate-string="true"> v.(</span></span></span><span data-slate-object="text" data-key="4094"><span data-slate-leaf="true" data-offset-key="4094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="4095"><span data-slate-leaf="true" data-offset-key="4095:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4096"><span data-slate-object="text" data-key="4097"><span data-slate-leaf="true" data-offset-key="4097:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4098"><span data-slate-leaf="true" data-offset-key="4098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4099"><span data-slate-leaf="true" data-offset-key="4099:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4100"><span data-slate-leaf="true" data-offset-key="4100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4101"><span data-slate-leaf="true" data-offset-key="4101:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4102"><span data-slate-leaf="true" data-offset-key="4102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="4103"><span data-slate-leaf="true" data-offset-key="4103:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4104"><span data-slate-object="text" data-key="4105"><span data-slate-leaf="true" data-offset-key="4105:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="4106"><span data-slate-leaf="true" data-offset-key="4106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4107"><span data-slate-leaf="true" data-offset-key="4107:0" data-first-offset="true"><span data-slate-string="true"> v</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4108"><span data-slate-object="text" data-key="4109"><span data-slate-leaf="true" data-offset-key="4109:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4110"><span data-slate-object="text" data-key="4111"><span data-slate-leaf="true" data-offset-key="4111:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4112"><span data-slate-object="text" data-key="4113"><span data-slate-leaf="true" data-offset-key="4113:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4114"><span data-slate-leaf="true" data-offset-key="4114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4115"><span data-slate-leaf="true" data-offset-key="4115:0" data-first-offset="true"><span data-slate-string="true"> unquotedValue{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4116"><span data-slate-object="text" data-key="4117"><span data-slate-leaf="true" data-offset-key="4117:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4118"><span data-slate-object="text" data-key="4119"><span data-slate-leaf="true" data-offset-key="4119:0" data-first-offset="true"><span data-slate-string="true">我们看到，在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4120"><span data-slate-object="text" data-key="4121"><span data-slate-leaf="true" data-offset-key="4121:0" data-first-offset="true"><span data-slate-string="true"> valueQuoted</span></span></span></span><span data-slate-object="text" data-key="4122"><span data-slate-leaf="true" data-offset-key="4122:0" data-first-offset="true"><span data-slate-string="true"> 这个方法中，如果程序执行流进入了 default 分支，那这个方法就会引发 panic，这个 panic 会提示开发人员：这里很可能是一个 bug。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4123"><span data-slate-object="text" data-key="4124"><span data-slate-leaf="true" data-offset-key="4124:0" data-first-offset="true"><span data-slate-string="true">同样，在 json 包的 encode.go 中也有使用 panic 做潜在 bug 提示的例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="4125"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4126"><span data-slate-object="text" data-key="4127"><span data-slate-leaf="true" data-offset-key="4127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/encoding/json/encode.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4128"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4129"><span data-slate-object="text" data-key="4130"><span data-slate-leaf="true" data-offset-key="4130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4131"><span data-slate-leaf="true" data-offset-key="4131:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4132"><span data-slate-leaf="true" data-offset-key="4132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(w *reflectWithString)</span></span></span></span></span><span data-slate-object="text" data-key="4133"><span data-slate-leaf="true" data-offset-key="4133:0" data-first-offset="true"><span data-slate-string="true"> resolve() </span></span></span><span data-slate-object="text" data-key="4134"><span data-slate-leaf="true" data-offset-key="4134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="4135"><span data-slate-leaf="true" data-offset-key="4135:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4136"><span data-slate-object="text" data-key="4137"><span data-slate-leaf="true" data-offset-key="4137:0" data-first-offset="true"><span data-slate-string="true">    ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4138"><span data-slate-object="text" data-key="4139"><span data-slate-leaf="true" data-offset-key="4139:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4140"><span data-slate-leaf="true" data-offset-key="4140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">switch</span></span></span></span><span data-slate-object="text" data-key="4141"><span data-slate-leaf="true" data-offset-key="4141:0" data-first-offset="true"><span data-slate-string="true"> w.k.Kind() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4142"><span data-slate-object="text" data-key="4143"><span data-slate-leaf="true" data-offset-key="4143:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4144"><span data-slate-leaf="true" data-offset-key="4144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4145"><span data-slate-leaf="true" data-offset-key="4145:0" data-first-offset="true"><span data-slate-string="true"> reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4146"><span data-slate-object="text" data-key="4147"><span data-slate-leaf="true" data-offset-key="4147:0" data-first-offset="true"><span data-slate-string="true">        w.ks = strconv.FormatInt(w.k.Int(), </span></span></span><span data-slate-object="text" data-key="4148"><span data-slate-leaf="true" data-offset-key="4148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="4149"><span data-slate-leaf="true" data-offset-key="4149:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4150"><span data-slate-object="text" data-key="4151"><span data-slate-leaf="true" data-offset-key="4151:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4152"><span data-slate-leaf="true" data-offset-key="4152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4153"><span data-slate-leaf="true" data-offset-key="4153:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4154"><span data-slate-leaf="true" data-offset-key="4154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4155"><span data-slate-object="text" data-key="4156"><span data-slate-leaf="true" data-offset-key="4156:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4157"><span data-slate-leaf="true" data-offset-key="4157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="4158"><span data-slate-leaf="true" data-offset-key="4158:0" data-first-offset="true"><span data-slate-string="true"> reflect.Uint, reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64, reflect.Uintptr:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4159"><span data-slate-object="text" data-key="4160"><span data-slate-leaf="true" data-offset-key="4160:0" data-first-offset="true"><span data-slate-string="true">        w.ks = strconv.FormatUint(w.k.Uint(), </span></span></span><span data-slate-object="text" data-key="4161"><span data-slate-leaf="true" data-offset-key="4161:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="4162"><span data-slate-leaf="true" data-offset-key="4162:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4163"><span data-slate-object="text" data-key="4164"><span data-slate-leaf="true" data-offset-key="4164:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4165"><span data-slate-leaf="true" data-offset-key="4165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4166"><span data-slate-leaf="true" data-offset-key="4166:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4167"><span data-slate-leaf="true" data-offset-key="4167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4168"><span data-slate-object="text" data-key="4169"><span data-slate-leaf="true" data-offset-key="4169:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4170"><span data-slate-object="text" data-key="4171"><span data-slate-leaf="true" data-offset-key="4171:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4172"><span data-slate-leaf="true" data-offset-key="4172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="4173"><span data-slate-leaf="true" data-offset-key="4173:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4174"><span data-slate-leaf="true" data-offset-key="4174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"unexpected map key type"</span></span></span></span><span data-slate-object="text" data-key="4175"><span data-slate-leaf="true" data-offset-key="4175:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4176"><span data-slate-object="text" data-key="4177"><span data-slate-leaf="true" data-offset-key="4177:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4178"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4179"><span data-slate-object="text" data-key="4180"><span data-slate-leaf="true" data-offset-key="4180:0" data-first-offset="true"><span data-slate-string="true">这段代码中，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4181"><span data-slate-object="text" data-key="4182"><span data-slate-leaf="true" data-offset-key="4182:0" data-first-offset="true"><span data-slate-string="true">resolve</span></span></span></span><span data-slate-object="text" data-key="4183"><span data-slate-leaf="true" data-offset-key="4183:0" data-first-offset="true"><span data-slate-string="true"> 方法的最后一行代码就相当于一个 “代码逻辑不会走到这里” 的断言。一旦触发 “断言”，这很可能就是一个潜在 bug。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4184"><span data-slate-object="text" data-key="4185"><span data-slate-leaf="true" data-offset-key="4185:0" data-first-offset="true"><span data-slate-string="true">我们也看到，去掉这行代码并不会对</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4186"><span data-slate-object="text" data-key="4187"><span data-slate-leaf="true" data-offset-key="4187:0" data-first-offset="true"><span data-slate-string="true"> resolve</span></span></span></span><span data-slate-object="text" data-key="4188"><span data-slate-leaf="true" data-offset-key="4188:0" data-first-offset="true"><span data-slate-string="true"> 方法的逻辑造成任何影响，但真正出现问题时，开发人员就缺少了 “断言” 潜在 bug 提醒的辅助支持了。</span></span><span data-slate-leaf="true" data-offset-key="4188:1"><span data-slate-object="annotation" data-annotation-key="gkann_f156d009" data-attr-id="31969" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在 Go 标准库中，</span></span></span></span><span data-slate-object="text" data-key="4189"><span data-slate-leaf="true" data-offset-key="4189:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f156d009" data-attr-id="31969" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">大多数 panic 的使用都是充当类似断言的作用的</span></span></span></span></span><span data-slate-object="text" data-key="4190"><span data-slate-leaf="true" data-offset-key="4190:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f156d009" data-attr-id="31969" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="4191" id="sr-toc-6"><span data-slate-object="text" data-key="4192"><span data-slate-leaf="true" data-offset-key="4192:0" data-first-offset="true"><span data-slate-string="true">第三点：不要混淆异常与错误</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="4193"><span data-slate-object="text" data-key="4194"><span data-slate-leaf="true" data-offset-key="4194:0" data-first-offset="true"><span data-slate-string="true">在日常编码中，我经常会看到一些 Go 语言初学者，尤其是一些有过 Java 语言编程经验的程序员，会因为习惯了 Java 那种基于</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4195"><span data-slate-object="text" data-key="4196"><span data-slate-leaf="true" data-offset-key="4196:0" data-first-offset="true"><span data-slate-string="true"> try-catch-finally</span></span></span></span><span data-slate-object="text" data-key="4197"><span data-slate-leaf="true" data-offset-key="4197:0" data-first-offset="true"><span data-slate-string="true"> 的错误处理思维，而将 Go panic 当成 Java 的 “checked exception” 去用，这显然是混淆了 Go 中的异常与错误，这是 Go 错误处理的一种反模式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4198"><span data-slate-object="text" data-key="4199"><span data-slate-leaf="true" data-offset-key="4199:0" data-first-offset="true"><span data-slate-string="true">查看 Java 标准类库，我们可以看到一些 Java 已预定义好的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4200"><span data-slate-object="text" data-key="4201"><span data-slate-leaf="true" data-offset-key="4201:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4202"><span data-slate-leaf="true" data-offset-key="4202:0" data-first-offset="true"><span data-slate-string="true"> 类，比较常见的有</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4203"><span data-slate-object="text" data-key="4204"><span data-slate-leaf="true" data-offset-key="4204:0" data-first-offset="true"><span data-slate-string="true"> IOException</span></span></span></span><span data-slate-object="text" data-key="4205"><span data-slate-leaf="true" data-offset-key="4205:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4206"><span data-slate-object="text" data-key="4207"><span data-slate-leaf="true" data-offset-key="4207:0" data-first-offset="true"><span data-slate-string="true">TimeoutException</span></span></span></span><span data-slate-object="text" data-key="4208"><span data-slate-leaf="true" data-offset-key="4208:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4209"><span data-slate-object="text" data-key="4210"><span data-slate-leaf="true" data-offset-key="4210:0" data-first-offset="true"><span data-slate-string="true">EOFException</span></span></span></span><span data-slate-object="text" data-key="4211"><span data-slate-leaf="true" data-offset-key="4211:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4212"><span data-slate-object="text" data-key="4213"><span data-slate-leaf="true" data-offset-key="4213:0" data-first-offset="true"><span data-slate-string="true">FileNotFoundException</span></span></span></span><span data-slate-object="text" data-key="4214"><span data-slate-leaf="true" data-offset-key="4214:0" data-first-offset="true"><span data-slate-string="true">，等等。看到这里，你是不是觉得这些 checked exception 和我们上一节讲的 “哨兵错误值” 十分相似呢？。它们都是预定义好的、代表特定场景下的错误状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4215"><span data-slate-object="text" data-key="4216"><span data-slate-leaf="true" data-offset-key="4216:0" data-first-offset="true"><span data-slate-string="true">那 Java 的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4217"><span data-slate-object="text" data-key="4218"><span data-slate-leaf="true" data-offset-key="4218:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4219"><span data-slate-leaf="true" data-offset-key="4219:0" data-first-offset="true"><span data-slate-string="true"> 和 Go 中的 panic 有啥差别呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4220"><span data-slate-object="text" data-key="4221"><span data-slate-leaf="true" data-offset-key="4221:0" data-first-offset="true"><span data-slate-string="true">Java 的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4222"><span data-slate-object="text" data-key="4223"><span data-slate-leaf="true" data-offset-key="4223:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4224"><span data-slate-leaf="true" data-offset-key="4224:0" data-first-offset="true"><span data-slate-string="true"> 用于一些可预见的、常会发生的错误场景，比如，针对</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4225"><span data-slate-object="text" data-key="4226"><span data-slate-leaf="true" data-offset-key="4226:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4227"><span data-slate-leaf="true" data-offset-key="4227:0" data-first-offset="true"><span data-slate-string="true"> 的所谓 “异常处理”，就是针对这些场景的</span></span></span><span data-slate-object="text" data-key="4228"><span data-slate-leaf="true" data-offset-key="4228:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> “错误处理预案”</span></span></span></span><span data-slate-object="text" data-key="4229"><span data-slate-leaf="true" data-offset-key="4229:0" data-first-offset="true"><span data-slate-string="true">。也可以说对</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4230"><span data-slate-object="text" data-key="4231"><span data-slate-leaf="true" data-offset-key="4231:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4232"><span data-slate-leaf="true" data-offset-key="4232:0" data-first-offset="true"><span data-slate-string="true"> 的使用、捕获、自定义等行为都是 “</span></span></span><span data-slate-object="text" data-key="4233"><span data-slate-leaf="true" data-offset-key="4233:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">有意而为之</span></span></span></span><span data-slate-object="text" data-key="4234"><span data-slate-leaf="true" data-offset-key="4234:0" data-first-offset="true"><span data-slate-string="true">” 的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4235"><span data-slate-object="text" data-key="4236"><span data-slate-leaf="true" data-offset-key="4236:0" data-first-offset="true"><span data-slate-string="true">如果它非要和 Go 中的某种语法对应来看，它对应的也是 Go 的错误处理，也就是基于 error 值比较模型的错误处理。所以，Java 中对</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4237"><span data-slate-object="text" data-key="4238"><span data-slate-leaf="true" data-offset-key="4238:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4239"><span data-slate-leaf="true" data-offset-key="4239:0" data-first-offset="true"><span data-slate-string="true"> 处理的本质是</span></span></span><span data-slate-object="text" data-key="4240"><span data-slate-leaf="true" data-offset-key="4240:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">错误处理</span></span></span></span><span data-slate-object="text" data-key="4241"><span data-slate-leaf="true" data-offset-key="4241:0" data-first-offset="true"><span data-slate-string="true">，虽然它的名字用了带有 “异常” 的字样。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4242"><span data-slate-object="text" data-key="4243"><span data-slate-leaf="true" data-offset-key="4243:0" data-first-offset="true"><span data-slate-string="true">而 Go 中的 panic 呢，更接近于 Java 的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4244"><span data-slate-object="text" data-key="4245"><span data-slate-leaf="true" data-offset-key="4245:0" data-first-offset="true"><span data-slate-string="true"> RuntimeException</span></span></span></span><span data-slate-object="text" data-key="4246"><span data-slate-leaf="true" data-offset-key="4246:0" data-first-offset="true"><span data-slate-string="true">+</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4247"><span data-slate-object="text" data-key="4248"><span data-slate-leaf="true" data-offset-key="4248:0" data-first-offset="true"><span data-slate-string="true">Error</span></span></span></span><span data-slate-object="text" data-key="4249"><span data-slate-leaf="true" data-offset-key="4249:0" data-first-offset="true"><span data-slate-string="true">，而不是</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4250"><span data-slate-object="text" data-key="4251"><span data-slate-leaf="true" data-offset-key="4251:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4252"><span data-slate-leaf="true" data-offset-key="4252:0" data-first-offset="true"><span data-slate-string="true">。我们前面提到过 Java 的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4253"><span data-slate-object="text" data-key="4254"><span data-slate-leaf="true" data-offset-key="4254:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4255"><span data-slate-leaf="true" data-offset-key="4255:0" data-first-offset="true"><span data-slate-string="true"> 是必须要被上层代码处理的，也就是要么捕获处理，要么重新抛给更上层。但是在 Go 中，我们通常会导入大量第三方包，而对于这些第三方包 API 中是否会引发</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4256"><span data-slate-object="text" data-key="4257"><span data-slate-leaf="true" data-offset-key="4257:0" data-first-offset="true"><span data-slate-string="true"> panic</span></span></span></span><span data-slate-object="text" data-key="4258"><span data-slate-leaf="true" data-offset-key="4258:0" data-first-offset="true"><span data-slate-string="true">，我们是不知道的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4259"><span data-slate-object="text" data-key="4260"><span data-slate-leaf="true" data-offset-key="4260:0" data-first-offset="true"><span data-slate-string="true">因此上层代码，也就是 API 调用者根本不会去逐一了解 API 是否会引发</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4261"><span data-slate-object="text" data-key="4262"><span data-slate-leaf="true" data-offset-key="4262:0" data-first-offset="true"><span data-slate-string="true"> panic</span></span></span></span><span data-slate-object="text" data-key="4263"><span data-slate-leaf="true" data-offset-key="4263:0" data-first-offset="true"><span data-slate-string="true">，也没有义务去处理引发的 panic。一旦你在编写的 API 中，像</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4264"><span data-slate-object="text" data-key="4265"><span data-slate-leaf="true" data-offset-key="4265:0" data-first-offset="true"><span data-slate-string="true"> checked exception</span></span></span></span><span data-slate-object="text" data-key="4266"><span data-slate-leaf="true" data-offset-key="4266:0" data-first-offset="true"><span data-slate-string="true"> 那样使用 panic 作为正常错误处理的手段，把引发的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="4267"><span data-slate-object="text" data-key="4268"><span data-slate-leaf="true" data-offset-key="4268:0" data-first-offset="true"><span data-slate-string="true"> panic</span></span></span></span><span data-slate-object="text" data-key="4269"><span data-slate-leaf="true" data-offset-key="4269:0" data-first-offset="true"><span data-slate-string="true"> 当作错误，那么你就会给你的 API 使用者带去大麻烦！因此，在 Go 中，作为 API 函数的作者，</span></span><span data-slate-leaf="true" data-offset-key="4269:1"><span data-slate-object="annotation" data-annotation-key="gkann_fc46e01c" data-attr-id="36050" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">你一定</span></span></span></span><span data-slate-object="text" data-key="4270"><span data-slate-leaf="true" data-offset-key="4270:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_fc46e01c" data-attr-id="36050" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不要将 panic 当作错误返回给 API 调用者</span></span></span></span></span><span data-slate-object="text" data-key="4271"><span data-slate-leaf="true" data-offset-key="4271:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_fc46e01c" data-attr-id="36050" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4272"><span data-slate-object="text" data-key="4273"><span data-slate-leaf="true" data-offset-key="4273:0" data-first-offset="true"><span data-slate-string="true">到这里，我们已经基本讲完了函数健壮性设计要注意的各种事项，你一定要注意我前面提到的这几点。接下来，我们进入下一部分，看看函数的简洁性设计。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4274" id="sr-toc-7"><span data-slate-object="text" data-key="4275"><span data-slate-leaf="true" data-offset-key="4275:0" data-first-offset="true"><span data-slate-string="true">使用 defer 简化函数实现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4276"><span data-slate-object="text" data-key="4277"><span data-slate-leaf="true" data-offset-key="4277:0" data-first-offset="true"><span data-slate-string="true">对函数设计来说，如何实现简洁的目标是一个大话题。你可以从通用的设计原则去谈，比如函数要遵守单一职责，职责单一的函数肯定要比担负多种职责的函数更简单。你也可以从函数实现的规模去谈，比如函数体的规模要小，尽量控制在 80 行代码之内等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4278"><span data-slate-object="text" data-key="4279"><span data-slate-leaf="true" data-offset-key="4279:0" data-first-offset="true"><span data-slate-string="true">但我们这个是 Go 语言的课程，所以我们的角度更侧重于 </span></span></span><span data-slate-object="text" data-key="4280"><span data-slate-leaf="true" data-offset-key="4280:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Go 中是否有现成的语法元素，可以帮助我们简化 Go 函数的设计和实现</span></span></span></span><span data-slate-object="text" data-key="4281"><span data-slate-leaf="true" data-offset-key="4281:0" data-first-offset="true"><span data-slate-string="true">。我也把答案剧透给你，有的，它就是 </span></span></span><span data-slate-object="text" data-key="4282"><span data-slate-leaf="true" data-offset-key="4282:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4283"><span data-slate-leaf="true" data-offset-key="4283:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4284"><span data-slate-object="text" data-key="4285"><span data-slate-leaf="true" data-offset-key="4285:0" data-first-offset="true"><span data-slate-string="true">同样地，我们也用一个具体的例子来理解一下。日常开发中，我们经常会编写一些类似下面示例中的伪代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="4286"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4287"><span data-slate-object="text" data-key="4288"><span data-slate-leaf="true" data-offset-key="4288:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4289"><span data-slate-leaf="true" data-offset-key="4289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4290"><span data-slate-leaf="true" data-offset-key="4290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">doSomething</span></span></span></span></span><span data-slate-object="text" data-key="4291"><span data-slate-leaf="true" data-offset-key="4291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4292"><span data-slate-leaf="true" data-offset-key="4292:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4293"><span data-slate-leaf="true" data-offset-key="4293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="4294"><span data-slate-leaf="true" data-offset-key="4294:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4295"><span data-slate-object="text" data-key="4296"><span data-slate-leaf="true" data-offset-key="4296:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4297"><span data-slate-leaf="true" data-offset-key="4297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="4298"><span data-slate-leaf="true" data-offset-key="4298:0" data-first-offset="true"><span data-slate-string="true"> mu sync.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4299"><span data-slate-object="text" data-key="4300"><span data-slate-leaf="true" data-offset-key="4300:0" data-first-offset="true"><span data-slate-string="true">    mu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4301"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4302"><span data-slate-object="text" data-key="4303"><span data-slate-leaf="true" data-offset-key="4303:0" data-first-offset="true"><span data-slate-string="true">    r1, err := OpenResource1()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4304"><span data-slate-object="text" data-key="4305"><span data-slate-leaf="true" data-offset-key="4305:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4306"><span data-slate-leaf="true" data-offset-key="4306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4307"><span data-slate-leaf="true" data-offset-key="4307:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="4308"><span data-slate-leaf="true" data-offset-key="4308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4309"><span data-slate-leaf="true" data-offset-key="4309:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4310"><span data-slate-object="text" data-key="4311"><span data-slate-leaf="true" data-offset-key="4311:0" data-first-offset="true"><span data-slate-string="true">        mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4312"><span data-slate-object="text" data-key="4313"><span data-slate-leaf="true" data-offset-key="4313:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4314"><span data-slate-leaf="true" data-offset-key="4314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4315"><span data-slate-leaf="true" data-offset-key="4315:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4316"><span data-slate-object="text" data-key="4317"><span data-slate-leaf="true" data-offset-key="4317:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4318"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4319"><span data-slate-object="text" data-key="4320"><span data-slate-leaf="true" data-offset-key="4320:0" data-first-offset="true"><span data-slate-string="true">    r2, err := OpenResource2()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4321"><span data-slate-object="text" data-key="4322"><span data-slate-leaf="true" data-offset-key="4322:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4323"><span data-slate-leaf="true" data-offset-key="4323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4324"><span data-slate-leaf="true" data-offset-key="4324:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="4325"><span data-slate-leaf="true" data-offset-key="4325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4326"><span data-slate-leaf="true" data-offset-key="4326:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4327"><span data-slate-object="text" data-key="4328"><span data-slate-leaf="true" data-offset-key="4328:0" data-first-offset="true"><span data-slate-string="true">        r1.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4329"><span data-slate-object="text" data-key="4330"><span data-slate-leaf="true" data-offset-key="4330:0" data-first-offset="true"><span data-slate-string="true">        mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4331"><span data-slate-object="text" data-key="4332"><span data-slate-leaf="true" data-offset-key="4332:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4333"><span data-slate-leaf="true" data-offset-key="4333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4334"><span data-slate-leaf="true" data-offset-key="4334:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4335"><span data-slate-object="text" data-key="4336"><span data-slate-leaf="true" data-offset-key="4336:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4337"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4338"><span data-slate-object="text" data-key="4339"><span data-slate-leaf="true" data-offset-key="4339:0" data-first-offset="true"><span data-slate-string="true">    r3, err := OpenResource3()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4340"><span data-slate-object="text" data-key="4341"><span data-slate-leaf="true" data-offset-key="4341:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4342"><span data-slate-leaf="true" data-offset-key="4342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4343"><span data-slate-leaf="true" data-offset-key="4343:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="4344"><span data-slate-leaf="true" data-offset-key="4344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4345"><span data-slate-leaf="true" data-offset-key="4345:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4346"><span data-slate-object="text" data-key="4347"><span data-slate-leaf="true" data-offset-key="4347:0" data-first-offset="true"><span data-slate-string="true">        r2.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4348"><span data-slate-object="text" data-key="4349"><span data-slate-leaf="true" data-offset-key="4349:0" data-first-offset="true"><span data-slate-string="true">        r1.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4350"><span data-slate-object="text" data-key="4351"><span data-slate-leaf="true" data-offset-key="4351:0" data-first-offset="true"><span data-slate-string="true">        mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4352"><span data-slate-object="text" data-key="4353"><span data-slate-leaf="true" data-offset-key="4353:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4354"><span data-slate-leaf="true" data-offset-key="4354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4355"><span data-slate-leaf="true" data-offset-key="4355:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4356"><span data-slate-object="text" data-key="4357"><span data-slate-leaf="true" data-offset-key="4357:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4358"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4359"><span data-slate-object="text" data-key="4360"><span data-slate-leaf="true" data-offset-key="4360:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4361"><span data-slate-leaf="true" data-offset-key="4361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 使用 r1，r2, r3</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4362"><span data-slate-object="text" data-key="4363"><span data-slate-leaf="true" data-offset-key="4363:0" data-first-offset="true"><span data-slate-string="true">    err = doWithResources() </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4364"><span data-slate-object="text" data-key="4365"><span data-slate-leaf="true" data-offset-key="4365:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4366"><span data-slate-leaf="true" data-offset-key="4366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4367"><span data-slate-leaf="true" data-offset-key="4367:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="4368"><span data-slate-leaf="true" data-offset-key="4368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4369"><span data-slate-leaf="true" data-offset-key="4369:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4370"><span data-slate-object="text" data-key="4371"><span data-slate-leaf="true" data-offset-key="4371:0" data-first-offset="true"><span data-slate-string="true">        r3.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4372"><span data-slate-object="text" data-key="4373"><span data-slate-leaf="true" data-offset-key="4373:0" data-first-offset="true"><span data-slate-string="true">        r2.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4374"><span data-slate-object="text" data-key="4375"><span data-slate-leaf="true" data-offset-key="4375:0" data-first-offset="true"><span data-slate-string="true">        r1.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4376"><span data-slate-object="text" data-key="4377"><span data-slate-leaf="true" data-offset-key="4377:0" data-first-offset="true"><span data-slate-string="true">        mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4378"><span data-slate-object="text" data-key="4379"><span data-slate-leaf="true" data-offset-key="4379:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4380"><span data-slate-leaf="true" data-offset-key="4380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4381"><span data-slate-leaf="true" data-offset-key="4381:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4382"><span data-slate-object="text" data-key="4383"><span data-slate-leaf="true" data-offset-key="4383:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4384"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4385"><span data-slate-object="text" data-key="4386"><span data-slate-leaf="true" data-offset-key="4386:0" data-first-offset="true"><span data-slate-string="true">    r3.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4387"><span data-slate-object="text" data-key="4388"><span data-slate-leaf="true" data-offset-key="4388:0" data-first-offset="true"><span data-slate-string="true">    r2.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4389"><span data-slate-object="text" data-key="4390"><span data-slate-leaf="true" data-offset-key="4390:0" data-first-offset="true"><span data-slate-string="true">    r1.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4391"><span data-slate-object="text" data-key="4392"><span data-slate-leaf="true" data-offset-key="4392:0" data-first-offset="true"><span data-slate-string="true">    mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4393"><span data-slate-object="text" data-key="4394"><span data-slate-leaf="true" data-offset-key="4394:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4395"><span data-slate-leaf="true" data-offset-key="4395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4396"><span data-slate-leaf="true" data-offset-key="4396:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4397"><span data-slate-leaf="true" data-offset-key="4397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4398"><span data-slate-object="text" data-key="4399"><span data-slate-leaf="true" data-offset-key="4399:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4400"><span data-slate-object="text" data-key="4401"><span data-slate-leaf="true" data-offset-key="4401:0" data-first-offset="true"><span data-slate-string="true">我们看到，这类代码的特点就是在函数中会申请一些资源，并在函数退出前释放或关闭这些资源，比如这里的互斥锁 mu 以及资源 r1~r3 就是这样。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4402"><span data-slate-object="text" data-key="4403"><span data-slate-leaf="true" data-offset-key="4403:0" data-first-offset="true"><span data-slate-string="true">函数的实现需要确保，无论函数的执行流是按预期顺利进行，还是出现错误，这些资源在函数退出时都要被及时、正确地释放。为此，我们需要尤为关注函数中的错误处理，在错误处理时不能遗漏对资源的释放。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4404"><span data-slate-object="text" data-key="4405"><span data-slate-leaf="true" data-offset-key="4405:0" data-first-offset="true"><span data-slate-string="true">但这样的要求，就导致我们在进行资源释放，尤其是有多个资源需要释放的时候，比如上面示例那样，会大大增加开发人员的心智负担。同时当待释放的资源个数较多时，整个代码逻辑就会变得十分复杂，程序可读性、健壮性也会随之下降。但即便如此，如果函数实现中的某段代码逻辑抛出 panic，传统的错误处理机制依然没有办法捕获它并尝试从 panic 恢复。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4406"><span data-slate-object="text" data-key="4407"><span data-slate-leaf="true" data-offset-key="4407:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Go 语言引入 defer 的初衷，就是解决这些问题。那么，defer 具体是怎么解决这些问题的呢？或者说，defer 具体的运作机制是怎样的呢？</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4408"><span data-slate-object="text" data-key="4409"><span data-slate-leaf="true" data-offset-key="4409:0" data-first-offset="true"><span data-slate-string="true">defer 是 Go 语言提供的一种延迟调用机制，defer 的运作离不开函数。怎么理解呢？这句话至少有以下两点含义：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4410"><div data-slate-type="list-line" data-slate-object="block" data-key="4411"><span data-slate-object="text" data-key="4412"><span data-slate-leaf="true" data-offset-key="4412:0" data-first-offset="true"><span data-slate-string="true">在 Go 中，只有在函数（和方法）内部才能使用 defer；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4413"><span data-slate-object="text" data-key="4414"><span data-slate-leaf="true" data-offset-key="4414:0" data-first-offset="true"><span data-slate-string="true">defer 关键字后面只能接函数（或方法），这些函数被称为 </span></span></span><span data-slate-object="text" data-key="4415"><span data-slate-leaf="true" data-offset-key="4415:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">deferred 函数</span></span></span></span><span data-slate-object="text" data-key="4416"><span data-slate-leaf="true" data-offset-key="4416:0" data-first-offset="true"><span data-slate-string="true">。</span></span><span data-slate-leaf="true" data-offset-key="4416:1"><span data-slate-object="annotation" data-annotation-key="gkann_cf91f167" data-attr-id="31971" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">defer 将它们注册到其所在 Goroutine 中，用于存放 deferred 函数的栈数据结构中，这些 deferred 函数将在执行 defer 的函数退出前，按后进先出（LIFO）的顺序被程序调度执行（如下图所示）。</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4417"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/89/c0/89d2f5ec28f6c291bf44deb4c5f979c0.jpg?wh=1920x1080"></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4418"><span data-slate-object="text" data-key="4419"><span data-slate-leaf="true" data-offset-key="4419:0" data-first-offset="true"><span data-slate-string="true">而且，无论是执行到函数体尾部返回，还是在某个错误处理分支显式 return，又或是出现 panic，</span></span><span data-slate-leaf="true" data-offset-key="4419:1"><span data-slate-object="annotation" data-annotation-key="gkann_534c1c2f" data-attr-id="33314" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">已经存储到 deferred 函数栈中的函数，</span></span></span><span data-slate-leaf="true" data-offset-key="4419:2"><span data-slate-string="true">都会被调度执行。所以说，</span></span><span data-slate-leaf="true" data-offset-key="4419:3"><span data-slate-object="annotation" data-annotation-key="gkann_14fcf288" data-attr-id="40381" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">deferred 函数是一个可以在任何情况下为函数进行</span></span></span></span><span data-slate-object="text" data-key="4420"><span data-slate-leaf="true" data-offset-key="4420:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_14fcf288" data-attr-id="40381" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">收尾工作</span></span></span></span></span><span data-slate-object="text" data-key="4421"><span data-slate-leaf="true" data-offset-key="4421:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_14fcf288" data-attr-id="40381" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">的好 “伙伴”。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4422"><span data-slate-object="text" data-key="4423"><span data-slate-leaf="true" data-offset-key="4423:0" data-first-offset="true"><span data-slate-string="true">我们回到刚才的那个例子，如果我们把收尾工作挪到 deferred 函数中，那么代码将变成如下这个样子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="4424"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4425"><span data-slate-object="text" data-key="4426"><span data-slate-leaf="true" data-offset-key="4426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4427"><span data-slate-leaf="true" data-offset-key="4427:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4428"><span data-slate-leaf="true" data-offset-key="4428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">doSomething</span></span></span></span></span><span data-slate-object="text" data-key="4429"><span data-slate-leaf="true" data-offset-key="4429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4430"><span data-slate-leaf="true" data-offset-key="4430:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4431"><span data-slate-leaf="true" data-offset-key="4431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="4432"><span data-slate-leaf="true" data-offset-key="4432:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4433"><span data-slate-object="text" data-key="4434"><span data-slate-leaf="true" data-offset-key="4434:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4435"><span data-slate-leaf="true" data-offset-key="4435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="4436"><span data-slate-leaf="true" data-offset-key="4436:0" data-first-offset="true"><span data-slate-string="true"> mu sync.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4437"><span data-slate-object="text" data-key="4438"><span data-slate-leaf="true" data-offset-key="4438:0" data-first-offset="true"><span data-slate-string="true">    mu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4439"><span data-slate-object="text" data-key="4440"><span data-slate-leaf="true" data-offset-key="4440:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4441"><span data-slate-leaf="true" data-offset-key="4441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4442"><span data-slate-leaf="true" data-offset-key="4442:0" data-first-offset="true"><span data-slate-string="true"> mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4443"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4444"><span data-slate-object="text" data-key="4445"><span data-slate-leaf="true" data-offset-key="4445:0" data-first-offset="true"><span data-slate-string="true">    r1, err := OpenResource1()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4446"><span data-slate-object="text" data-key="4447"><span data-slate-leaf="true" data-offset-key="4447:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4448"><span data-slate-leaf="true" data-offset-key="4448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4449"><span data-slate-leaf="true" data-offset-key="4449:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="4450"><span data-slate-leaf="true" data-offset-key="4450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4451"><span data-slate-leaf="true" data-offset-key="4451:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4452"><span data-slate-object="text" data-key="4453"><span data-slate-leaf="true" data-offset-key="4453:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4454"><span data-slate-leaf="true" data-offset-key="4454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4455"><span data-slate-leaf="true" data-offset-key="4455:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4456"><span data-slate-object="text" data-key="4457"><span data-slate-leaf="true" data-offset-key="4457:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4458"><span data-slate-object="text" data-key="4459"><span data-slate-leaf="true" data-offset-key="4459:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4460"><span data-slate-leaf="true" data-offset-key="4460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4461"><span data-slate-leaf="true" data-offset-key="4461:0" data-first-offset="true"><span data-slate-string="true"> r1.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4462"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4463"><span data-slate-object="text" data-key="4464"><span data-slate-leaf="true" data-offset-key="4464:0" data-first-offset="true"><span data-slate-string="true">    r2, err := OpenResource2()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4465"><span data-slate-object="text" data-key="4466"><span data-slate-leaf="true" data-offset-key="4466:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4467"><span data-slate-leaf="true" data-offset-key="4467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4468"><span data-slate-leaf="true" data-offset-key="4468:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="4469"><span data-slate-leaf="true" data-offset-key="4469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4470"><span data-slate-leaf="true" data-offset-key="4470:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4471"><span data-slate-object="text" data-key="4472"><span data-slate-leaf="true" data-offset-key="4472:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4473"><span data-slate-leaf="true" data-offset-key="4473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4474"><span data-slate-leaf="true" data-offset-key="4474:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4475"><span data-slate-object="text" data-key="4476"><span data-slate-leaf="true" data-offset-key="4476:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4477"><span data-slate-object="text" data-key="4478"><span data-slate-leaf="true" data-offset-key="4478:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4479"><span data-slate-leaf="true" data-offset-key="4479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4480"><span data-slate-leaf="true" data-offset-key="4480:0" data-first-offset="true"><span data-slate-string="true"> r2.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4481"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4482"><span data-slate-object="text" data-key="4483"><span data-slate-leaf="true" data-offset-key="4483:0" data-first-offset="true"><span data-slate-string="true">    r3, err := OpenResource3()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4484"><span data-slate-object="text" data-key="4485"><span data-slate-leaf="true" data-offset-key="4485:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4486"><span data-slate-leaf="true" data-offset-key="4486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4487"><span data-slate-leaf="true" data-offset-key="4487:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="4488"><span data-slate-leaf="true" data-offset-key="4488:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="4489"><span data-slate-leaf="true" data-offset-key="4489:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4490"><span data-slate-object="text" data-key="4491"><span data-slate-leaf="true" data-offset-key="4491:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4492"><span data-slate-leaf="true" data-offset-key="4492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4493"><span data-slate-leaf="true" data-offset-key="4493:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4494"><span data-slate-object="text" data-key="4495"><span data-slate-leaf="true" data-offset-key="4495:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4496"><span data-slate-object="text" data-key="4497"><span data-slate-leaf="true" data-offset-key="4497:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4498"><span data-slate-leaf="true" data-offset-key="4498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4499"><span data-slate-leaf="true" data-offset-key="4499:0" data-first-offset="true"><span data-slate-string="true"> r3.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4500"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4501"><span data-slate-object="text" data-key="4502"><span data-slate-leaf="true" data-offset-key="4502:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4503"><span data-slate-leaf="true" data-offset-key="4503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 使用 r1，r2, r3</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4504"><span data-slate-object="text" data-key="4505"><span data-slate-leaf="true" data-offset-key="4505:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4506"><span data-slate-leaf="true" data-offset-key="4506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4507"><span data-slate-leaf="true" data-offset-key="4507:0" data-first-offset="true"><span data-slate-string="true"> doWithResources() </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4508"><span data-slate-object="text" data-key="4509"><span data-slate-leaf="true" data-offset-key="4509:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4510"><span data-slate-object="text" data-key="4511"><span data-slate-leaf="true" data-offset-key="4511:0" data-first-offset="true"><span data-slate-string="true">我们看到，使用 defer 后对函数实现逻辑的简化是显而易见的。而且，这里资源释放函数的 defer 注册动作，紧邻着资源申请成功的动作，这样成对出现的惯例就极大降低了遗漏资源释放的可能性，我们开发人员也不用再小心翼翼地在每个错误处理分支中检查是否遗漏了某个资源的释放动作。同时，代码的简化也意味代码可读性的提高，以及代码健壮度的增强。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4512"><span data-slate-object="text" data-key="4513"><span data-slate-leaf="true" data-offset-key="4513:0" data-first-offset="true"><span data-slate-string="true">那我们日常开发中使用 defer，有没有什么要特别注意的呢？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4514" id="sr-toc-8"><span data-slate-object="text" data-key="4515"><span data-slate-leaf="true" data-offset-key="4515:0" data-first-offset="true"><span data-slate-string="true">defer 使用的几个注意事项</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4516"><span data-slate-object="text" data-key="4517"><span data-slate-leaf="true" data-offset-key="4517:0" data-first-offset="true"><span data-slate-string="true">大多数 Gopher 都喜欢 defer，因为它不仅可以用来捕捉和恢复 panic，还能让函数变得更简洁和健壮。但 “工欲善其事，必先利其器 “，一旦你要用 defer，有几个关于 defer 使用的注意事项是你一定要提前了解清楚的，可以避免掉进一些不必要的 “坑”。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="4518" id="sr-toc-9"><span data-slate-object="text" data-key="4519"><span data-slate-leaf="true" data-offset-key="4519:0" data-first-offset="true"><span data-slate-string="true">第一点：明确哪些函数可以作为 deferred 函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="4520"><span data-slate-object="text" data-key="4521"><span data-slate-leaf="true" data-offset-key="4521:0" data-first-offset="true"><span data-slate-string="true">这里，你要清楚，对于自定义的函数或方法，defer 可以给与无条件的支持，</span></span><span data-slate-leaf="true" data-offset-key="4521:1"><span data-slate-object="annotation" data-annotation-key="gkann_6e2706ef" data-attr-id="31972" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">但是对于有返回值的自定义函数或方法，返回值会在 deferred 函数被调度执行的时候被自动丢弃。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4522"><span data-slate-object="text" data-key="4523"><span data-slate-leaf="true" data-offset-key="4523:0" data-first-offset="true"><span data-slate-string="true">而且，Go 语言中除了自定义函数 / 方法，还有 Go 语言内置的 / 预定义的函数，这里我给出了 Go 语言内置函数的完全列表：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="4524"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4525"><span data-slate-object="text" data-key="4526"><span data-slate-leaf="true" data-offset-key="4526:0" data-first-offset="true"><span data-slate-string="true">Functions:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4527"><span data-slate-object="text" data-key="4528"><span data-slate-leaf="true" data-offset-key="4528:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4529"><span data-slate-leaf="true" data-offset-key="4529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="4530"><span data-slate-leaf="true" data-offset-key="4530:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4531"><span data-slate-leaf="true" data-offset-key="4531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cap</span></span></span></span><span data-slate-object="text" data-key="4532"><span data-slate-leaf="true" data-offset-key="4532:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4533"><span data-slate-leaf="true" data-offset-key="4533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="4534"><span data-slate-leaf="true" data-offset-key="4534:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4535"><span data-slate-leaf="true" data-offset-key="4535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">complex</span></span></span></span><span data-slate-object="text" data-key="4536"><span data-slate-leaf="true" data-offset-key="4536:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4537"><span data-slate-leaf="true" data-offset-key="4537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">copy</span></span></span></span><span data-slate-object="text" data-key="4538"><span data-slate-leaf="true" data-offset-key="4538:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4539"><span data-slate-leaf="true" data-offset-key="4539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">delete</span></span></span></span><span data-slate-object="text" data-key="4540"><span data-slate-leaf="true" data-offset-key="4540:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4541"><span data-slate-leaf="true" data-offset-key="4541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">imag</span></span></span></span><span data-slate-object="text" data-key="4542"><span data-slate-leaf="true" data-offset-key="4542:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4543"><span data-slate-leaf="true" data-offset-key="4543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4544"><span data-slate-object="text" data-key="4545"><span data-slate-leaf="true" data-offset-key="4545:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="4546"><span data-slate-leaf="true" data-offset-key="4546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="4547"><span data-slate-leaf="true" data-offset-key="4547:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4548"><span data-slate-leaf="true" data-offset-key="4548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="4549"><span data-slate-leaf="true" data-offset-key="4549:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4550"><span data-slate-leaf="true" data-offset-key="4550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="4551"><span data-slate-leaf="true" data-offset-key="4551:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4552"><span data-slate-leaf="true" data-offset-key="4552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">print</span></span></span></span><span data-slate-object="text" data-key="4553"><span data-slate-leaf="true" data-offset-key="4553:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4554"><span data-slate-leaf="true" data-offset-key="4554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="4555"><span data-slate-leaf="true" data-offset-key="4555:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4556"><span data-slate-leaf="true" data-offset-key="4556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">real</span></span></span></span><span data-slate-object="text" data-key="4557"><span data-slate-leaf="true" data-offset-key="4557:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4558"><span data-slate-leaf="true" data-offset-key="4558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">recover</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4559"><span data-slate-object="text" data-key="4560"><span data-slate-leaf="true" data-offset-key="4560:0" data-first-offset="true"><span data-slate-string="true">那么，Go 语言中的内置函数是否都能作为 deferred 函数呢？我们看下面的示例：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="4561"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4562"><span data-slate-object="text" data-key="4563"><span data-slate-leaf="true" data-offset-key="4563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// defer1.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4564"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4565"><span data-slate-object="text" data-key="4566"><span data-slate-leaf="true" data-offset-key="4566:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4567"><span data-slate-leaf="true" data-offset-key="4567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4568"><span data-slate-leaf="true" data-offset-key="4568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4569"><span data-slate-leaf="true" data-offset-key="4569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bar</span></span></span></span></span><span data-slate-object="text" data-key="4570"><span data-slate-leaf="true" data-offset-key="4570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4571"><span data-slate-leaf="true" data-offset-key="4571:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="4572"><span data-slate-leaf="true" data-offset-key="4572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4573"><span data-slate-leaf="true" data-offset-key="4573:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4574"><span data-slate-leaf="true" data-offset-key="4574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4575"><span data-slate-leaf="true" data-offset-key="4575:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4576"><span data-slate-object="text" data-key="4577"><span data-slate-leaf="true" data-offset-key="4577:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4578"><span data-slate-leaf="true" data-offset-key="4578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4579"><span data-slate-leaf="true" data-offset-key="4579:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4580"><span data-slate-leaf="true" data-offset-key="4580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="4581"><span data-slate-leaf="true" data-offset-key="4581:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4582"><span data-slate-leaf="true" data-offset-key="4582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4583"><span data-slate-object="text" data-key="4584"><span data-slate-leaf="true" data-offset-key="4584:0" data-first-offset="true"><span data-slate-string="true"> }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4585"><span data-slate-object="text" data-key="4586"><span data-slate-leaf="true" data-offset-key="4586:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4587"><span data-slate-object="text" data-key="4588"><span data-slate-leaf="true" data-offset-key="4588:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4589"><span data-slate-leaf="true" data-offset-key="4589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4590"><span data-slate-leaf="true" data-offset-key="4590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4591"><span data-slate-leaf="true" data-offset-key="4591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo</span></span></span></span></span><span data-slate-object="text" data-key="4592"><span data-slate-leaf="true" data-offset-key="4592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4593"><span data-slate-leaf="true" data-offset-key="4593:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4594"><span data-slate-object="text" data-key="4595"><span data-slate-leaf="true" data-offset-key="4595:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4596"><span data-slate-leaf="true" data-offset-key="4596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="4597"><span data-slate-leaf="true" data-offset-key="4597:0" data-first-offset="true"><span data-slate-string="true"> c </span></span></span><span data-slate-object="text" data-key="4598"><span data-slate-leaf="true" data-offset-key="4598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="4599"><span data-slate-leaf="true" data-offset-key="4599:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4600"><span data-slate-leaf="true" data-offset-key="4600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4601"><span data-slate-object="text" data-key="4602"><span data-slate-leaf="true" data-offset-key="4602:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4603"><span data-slate-leaf="true" data-offset-key="4603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="4604"><span data-slate-leaf="true" data-offset-key="4604:0" data-first-offset="true"><span data-slate-string="true"> sl []</span></span></span><span data-slate-object="text" data-key="4605"><span data-slate-leaf="true" data-offset-key="4605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4606"><span data-slate-object="text" data-key="4607"><span data-slate-leaf="true" data-offset-key="4607:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4608"><span data-slate-leaf="true" data-offset-key="4608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="4609"><span data-slate-leaf="true" data-offset-key="4609:0" data-first-offset="true"><span data-slate-string="true"> m = </span></span></span><span data-slate-object="text" data-key="4610"><span data-slate-leaf="true" data-offset-key="4610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="4611"><span data-slate-leaf="true" data-offset-key="4611:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4612"><span data-slate-leaf="true" data-offset-key="4612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="4613"><span data-slate-leaf="true" data-offset-key="4613:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="4614"><span data-slate-leaf="true" data-offset-key="4614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="4615"><span data-slate-leaf="true" data-offset-key="4615:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="4616"><span data-slate-leaf="true" data-offset-key="4616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4617"><span data-slate-leaf="true" data-offset-key="4617:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4618"><span data-slate-leaf="true" data-offset-key="4618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="4619"><span data-slate-leaf="true" data-offset-key="4619:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4620"><span data-slate-object="text" data-key="4621"><span data-slate-leaf="true" data-offset-key="4621:0" data-first-offset="true"><span data-slate-string="true">     m[</span></span></span><span data-slate-object="text" data-key="4622"><span data-slate-leaf="true" data-offset-key="4622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"item1"</span></span></span></span><span data-slate-object="text" data-key="4623"><span data-slate-leaf="true" data-offset-key="4623:0" data-first-offset="true"><span data-slate-string="true">] = </span></span></span><span data-slate-object="text" data-key="4624"><span data-slate-leaf="true" data-offset-key="4624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4625"><span data-slate-object="text" data-key="4626"><span data-slate-leaf="true" data-offset-key="4626:0" data-first-offset="true"><span data-slate-string="true">     m[</span></span></span><span data-slate-object="text" data-key="4627"><span data-slate-leaf="true" data-offset-key="4627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"item2"</span></span></span></span><span data-slate-object="text" data-key="4628"><span data-slate-leaf="true" data-offset-key="4628:0" data-first-offset="true"><span data-slate-string="true">] = </span></span></span><span data-slate-object="text" data-key="4629"><span data-slate-leaf="true" data-offset-key="4629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4630"><span data-slate-object="text" data-key="4631"><span data-slate-leaf="true" data-offset-key="4631:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4632"><span data-slate-leaf="true" data-offset-key="4632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="4633"><span data-slate-leaf="true" data-offset-key="4633:0" data-first-offset="true"><span data-slate-string="true"> a = </span></span></span><span data-slate-object="text" data-key="4634"><span data-slate-leaf="true" data-offset-key="4634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">complex</span></span></span></span><span data-slate-object="text" data-key="4635"><span data-slate-leaf="true" data-offset-key="4635:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4636"><span data-slate-leaf="true" data-offset-key="4636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1.0</span></span></span></span><span data-slate-object="text" data-key="4637"><span data-slate-leaf="true" data-offset-key="4637:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4638"><span data-slate-leaf="true" data-offset-key="4638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1.4</span></span></span></span><span data-slate-object="text" data-key="4639"><span data-slate-leaf="true" data-offset-key="4639:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4640"><span data-slate-object="text" data-key="4641"><span data-slate-leaf="true" data-offset-key="4641:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4642"><span data-slate-object="text" data-key="4643"><span data-slate-leaf="true" data-offset-key="4643:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4644"><span data-slate-leaf="true" data-offset-key="4644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="4645"><span data-slate-leaf="true" data-offset-key="4645:0" data-first-offset="true"><span data-slate-string="true"> sl1 []</span></span></span><span data-slate-object="text" data-key="4646"><span data-slate-leaf="true" data-offset-key="4646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4647"><span data-slate-object="text" data-key="4648"><span data-slate-leaf="true" data-offset-key="4648:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4649"><span data-slate-leaf="true" data-offset-key="4649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4650"><span data-slate-leaf="true" data-offset-key="4650:0" data-first-offset="true"><span data-slate-string="true"> bar()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4651"><span data-slate-object="text" data-key="4652"><span data-slate-leaf="true" data-offset-key="4652:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4653"><span data-slate-leaf="true" data-offset-key="4653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4654"><span data-slate-leaf="true" data-offset-key="4654:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4655"><span data-slate-leaf="true" data-offset-key="4655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="4656"><span data-slate-leaf="true" data-offset-key="4656:0" data-first-offset="true"><span data-slate-string="true">(sl, </span></span></span><span data-slate-object="text" data-key="4657"><span data-slate-leaf="true" data-offset-key="4657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">11</span></span></span></span><span data-slate-object="text" data-key="4658"><span data-slate-leaf="true" data-offset-key="4658:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4659"><span data-slate-object="text" data-key="4660"><span data-slate-leaf="true" data-offset-key="4660:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4661"><span data-slate-leaf="true" data-offset-key="4661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4662"><span data-slate-leaf="true" data-offset-key="4662:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4663"><span data-slate-leaf="true" data-offset-key="4663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cap</span></span></span></span><span data-slate-object="text" data-key="4664"><span data-slate-leaf="true" data-offset-key="4664:0" data-first-offset="true"><span data-slate-string="true">(sl)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4665"><span data-slate-object="text" data-key="4666"><span data-slate-leaf="true" data-offset-key="4666:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4667"><span data-slate-leaf="true" data-offset-key="4667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4668"><span data-slate-leaf="true" data-offset-key="4668:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4669"><span data-slate-leaf="true" data-offset-key="4669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">close</span></span></span></span><span data-slate-object="text" data-key="4670"><span data-slate-leaf="true" data-offset-key="4670:0" data-first-offset="true"><span data-slate-string="true">(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4671"><span data-slate-object="text" data-key="4672"><span data-slate-leaf="true" data-offset-key="4672:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4673"><span data-slate-leaf="true" data-offset-key="4673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4674"><span data-slate-leaf="true" data-offset-key="4674:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4675"><span data-slate-leaf="true" data-offset-key="4675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">complex</span></span></span></span><span data-slate-object="text" data-key="4676"><span data-slate-leaf="true" data-offset-key="4676:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4677"><span data-slate-leaf="true" data-offset-key="4677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4678"><span data-slate-leaf="true" data-offset-key="4678:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4679"><span data-slate-leaf="true" data-offset-key="4679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-2</span></span></span></span><span data-slate-object="text" data-key="4680"><span data-slate-leaf="true" data-offset-key="4680:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4681"><span data-slate-object="text" data-key="4682"><span data-slate-leaf="true" data-offset-key="4682:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4683"><span data-slate-leaf="true" data-offset-key="4683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4684"><span data-slate-leaf="true" data-offset-key="4684:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4685"><span data-slate-leaf="true" data-offset-key="4685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">copy</span></span></span></span><span data-slate-object="text" data-key="4686"><span data-slate-leaf="true" data-offset-key="4686:0" data-first-offset="true"><span data-slate-string="true">(sl1, sl)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4687"><span data-slate-object="text" data-key="4688"><span data-slate-leaf="true" data-offset-key="4688:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4689"><span data-slate-leaf="true" data-offset-key="4689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4690"><span data-slate-leaf="true" data-offset-key="4690:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4691"><span data-slate-leaf="true" data-offset-key="4691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">delete</span></span></span></span><span data-slate-object="text" data-key="4692"><span data-slate-leaf="true" data-offset-key="4692:0" data-first-offset="true"><span data-slate-string="true">(m, </span></span></span><span data-slate-object="text" data-key="4693"><span data-slate-leaf="true" data-offset-key="4693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"item2"</span></span></span></span><span data-slate-object="text" data-key="4694"><span data-slate-leaf="true" data-offset-key="4694:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4695"><span data-slate-object="text" data-key="4696"><span data-slate-leaf="true" data-offset-key="4696:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4697"><span data-slate-leaf="true" data-offset-key="4697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4698"><span data-slate-leaf="true" data-offset-key="4698:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4699"><span data-slate-leaf="true" data-offset-key="4699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">imag</span></span></span></span><span data-slate-object="text" data-key="4700"><span data-slate-leaf="true" data-offset-key="4700:0" data-first-offset="true"><span data-slate-string="true">(a)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4701"><span data-slate-object="text" data-key="4702"><span data-slate-leaf="true" data-offset-key="4702:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4703"><span data-slate-leaf="true" data-offset-key="4703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4704"><span data-slate-leaf="true" data-offset-key="4704:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4705"><span data-slate-leaf="true" data-offset-key="4705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="4706"><span data-slate-leaf="true" data-offset-key="4706:0" data-first-offset="true"><span data-slate-string="true">(sl)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4707"><span data-slate-object="text" data-key="4708"><span data-slate-leaf="true" data-offset-key="4708:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4709"><span data-slate-leaf="true" data-offset-key="4709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4710"><span data-slate-leaf="true" data-offset-key="4710:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4711"><span data-slate-leaf="true" data-offset-key="4711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="4712"><span data-slate-leaf="true" data-offset-key="4712:0" data-first-offset="true"><span data-slate-string="true">([]</span></span></span><span data-slate-object="text" data-key="4713"><span data-slate-leaf="true" data-offset-key="4713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4714"><span data-slate-leaf="true" data-offset-key="4714:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4715"><span data-slate-leaf="true" data-offset-key="4715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="4716"><span data-slate-leaf="true" data-offset-key="4716:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4717"><span data-slate-object="text" data-key="4718"><span data-slate-leaf="true" data-offset-key="4718:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4719"><span data-slate-leaf="true" data-offset-key="4719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4720"><span data-slate-leaf="true" data-offset-key="4720:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4721"><span data-slate-leaf="true" data-offset-key="4721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="4722"><span data-slate-leaf="true" data-offset-key="4722:0" data-first-offset="true"><span data-slate-string="true">(*</span></span></span><span data-slate-object="text" data-key="4723"><span data-slate-leaf="true" data-offset-key="4723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4724"><span data-slate-leaf="true" data-offset-key="4724:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4725"><span data-slate-object="text" data-key="4726"><span data-slate-leaf="true" data-offset-key="4726:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4727"><span data-slate-leaf="true" data-offset-key="4727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4728"><span data-slate-leaf="true" data-offset-key="4728:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4729"><span data-slate-leaf="true" data-offset-key="4729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">panic</span></span></span></span><span data-slate-object="text" data-key="4730"><span data-slate-leaf="true" data-offset-key="4730:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4731"><span data-slate-leaf="true" data-offset-key="4731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="4732"><span data-slate-leaf="true" data-offset-key="4732:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4733"><span data-slate-object="text" data-key="4734"><span data-slate-leaf="true" data-offset-key="4734:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4735"><span data-slate-leaf="true" data-offset-key="4735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4736"><span data-slate-leaf="true" data-offset-key="4736:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4737"><span data-slate-leaf="true" data-offset-key="4737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">print</span></span></span></span><span data-slate-object="text" data-key="4738"><span data-slate-leaf="true" data-offset-key="4738:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4739"><span data-slate-leaf="true" data-offset-key="4739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hello, defer\n"</span></span></span></span><span data-slate-object="text" data-key="4740"><span data-slate-leaf="true" data-offset-key="4740:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4741"><span data-slate-object="text" data-key="4742"><span data-slate-leaf="true" data-offset-key="4742:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4743"><span data-slate-leaf="true" data-offset-key="4743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4744"><span data-slate-leaf="true" data-offset-key="4744:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4745"><span data-slate-leaf="true" data-offset-key="4745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">println</span></span></span></span><span data-slate-object="text" data-key="4746"><span data-slate-leaf="true" data-offset-key="4746:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4747"><span data-slate-leaf="true" data-offset-key="4747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hello, defer"</span></span></span></span><span data-slate-object="text" data-key="4748"><span data-slate-leaf="true" data-offset-key="4748:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4749"><span data-slate-object="text" data-key="4750"><span data-slate-leaf="true" data-offset-key="4750:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4751"><span data-slate-leaf="true" data-offset-key="4751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4752"><span data-slate-leaf="true" data-offset-key="4752:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4753"><span data-slate-leaf="true" data-offset-key="4753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">real</span></span></span></span><span data-slate-object="text" data-key="4754"><span data-slate-leaf="true" data-offset-key="4754:0" data-first-offset="true"><span data-slate-string="true">(a)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4755"><span data-slate-object="text" data-key="4756"><span data-slate-leaf="true" data-offset-key="4756:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="4757"><span data-slate-leaf="true" data-offset-key="4757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4758"><span data-slate-leaf="true" data-offset-key="4758:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4759"><span data-slate-leaf="true" data-offset-key="4759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">recover</span></span></span></span><span data-slate-object="text" data-key="4760"><span data-slate-leaf="true" data-offset-key="4760:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4761"><span data-slate-object="text" data-key="4762"><span data-slate-leaf="true" data-offset-key="4762:0" data-first-offset="true"><span data-slate-string="true"> }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4763"><span data-slate-object="text" data-key="4764"><span data-slate-leaf="true" data-offset-key="4764:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4765"><span data-slate-object="text" data-key="4766"><span data-slate-leaf="true" data-offset-key="4766:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4767"><span data-slate-leaf="true" data-offset-key="4767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4768"><span data-slate-leaf="true" data-offset-key="4768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4769"><span data-slate-leaf="true" data-offset-key="4769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="4770"><span data-slate-leaf="true" data-offset-key="4770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4771"><span data-slate-leaf="true" data-offset-key="4771:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4772"><span data-slate-object="text" data-key="4773"><span data-slate-leaf="true" data-offset-key="4773:0" data-first-offset="true"><span data-slate-string="true">     foo()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4774"><span data-slate-object="text" data-key="4775"><span data-slate-leaf="true" data-offset-key="4775:0" data-first-offset="true"><span data-slate-string="true"> }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4776"><span data-slate-object="text" data-key="4777"><span data-slate-leaf="true" data-offset-key="4777:0" data-first-offset="true"><span data-slate-string="true">运行这个示例代码，我们可以得到：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="4778"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4779"><span data-slate-object="text" data-key="4780"><span data-slate-leaf="true" data-offset-key="4780:0" data-first-offset="true"><span data-slate-string="true">$</span></span></span><span data-slate-object="text" data-key="4781"><span data-slate-leaf="true" data-offset-key="4781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4782"><span data-slate-leaf="true" data-offset-key="4782:0" data-first-offset="true"><span data-slate-string="true"> run defer1.</span></span></span><span data-slate-object="text" data-key="4783"><span data-slate-leaf="true" data-offset-key="4783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4784"><span data-slate-object="text" data-key="4785"><span data-slate-leaf="true" data-offset-key="4785:0" data-first-offset="true"><span data-slate-string="true"># command-line-arguments</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4786"><span data-slate-object="text" data-key="4787"><span data-slate-leaf="true" data-offset-key="4787:0" data-first-offset="true"><span data-slate-string="true">./defer1.</span></span></span><span data-slate-object="text" data-key="4788"><span data-slate-leaf="true" data-offset-key="4788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4789"><span data-slate-leaf="true" data-offset-key="4789:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4790"><span data-slate-leaf="true" data-offset-key="4790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">17</span></span></span></span><span data-slate-object="text" data-key="4791"><span data-slate-leaf="true" data-offset-key="4791:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4792"><span data-slate-leaf="true" data-offset-key="4792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4793"><span data-slate-leaf="true" data-offset-key="4793:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="4794"><span data-slate-leaf="true" data-offset-key="4794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4795"><span data-slate-leaf="true" data-offset-key="4795:0" data-first-offset="true"><span data-slate-string="true"> discards result of </span></span></span><span data-slate-object="text" data-key="4796"><span data-slate-leaf="true" data-offset-key="4796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="4797"><span data-slate-leaf="true" data-offset-key="4797:0" data-first-offset="true"><span data-slate-string="true">(sl, </span></span></span><span data-slate-object="text" data-key="4798"><span data-slate-leaf="true" data-offset-key="4798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">11</span></span></span></span><span data-slate-object="text" data-key="4799"><span data-slate-leaf="true" data-offset-key="4799:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4800"><span data-slate-object="text" data-key="4801"><span data-slate-leaf="true" data-offset-key="4801:0" data-first-offset="true"><span data-slate-string="true">./defer1.</span></span></span><span data-slate-object="text" data-key="4802"><span data-slate-leaf="true" data-offset-key="4802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4803"><span data-slate-leaf="true" data-offset-key="4803:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4804"><span data-slate-leaf="true" data-offset-key="4804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">18</span></span></span></span><span data-slate-object="text" data-key="4805"><span data-slate-leaf="true" data-offset-key="4805:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4806"><span data-slate-leaf="true" data-offset-key="4806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4807"><span data-slate-leaf="true" data-offset-key="4807:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="4808"><span data-slate-leaf="true" data-offset-key="4808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4809"><span data-slate-leaf="true" data-offset-key="4809:0" data-first-offset="true"><span data-slate-string="true"> discards result of </span></span></span><span data-slate-object="text" data-key="4810"><span data-slate-leaf="true" data-offset-key="4810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cap</span></span></span></span><span data-slate-object="text" data-key="4811"><span data-slate-leaf="true" data-offset-key="4811:0" data-first-offset="true"><span data-slate-string="true">(sl)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4812"><span data-slate-object="text" data-key="4813"><span data-slate-leaf="true" data-offset-key="4813:0" data-first-offset="true"><span data-slate-string="true">./defer1.</span></span></span><span data-slate-object="text" data-key="4814"><span data-slate-leaf="true" data-offset-key="4814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4815"><span data-slate-leaf="true" data-offset-key="4815:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4816"><span data-slate-leaf="true" data-offset-key="4816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20</span></span></span></span><span data-slate-object="text" data-key="4817"><span data-slate-leaf="true" data-offset-key="4817:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4818"><span data-slate-leaf="true" data-offset-key="4818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4819"><span data-slate-leaf="true" data-offset-key="4819:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="4820"><span data-slate-leaf="true" data-offset-key="4820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4821"><span data-slate-leaf="true" data-offset-key="4821:0" data-first-offset="true"><span data-slate-string="true"> discards result of </span></span></span><span data-slate-object="text" data-key="4822"><span data-slate-leaf="true" data-offset-key="4822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">complex</span></span></span></span><span data-slate-object="text" data-key="4823"><span data-slate-leaf="true" data-offset-key="4823:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4824"><span data-slate-leaf="true" data-offset-key="4824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4825"><span data-slate-leaf="true" data-offset-key="4825:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4826"><span data-slate-leaf="true" data-offset-key="4826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-2</span></span></span></span><span data-slate-object="text" data-key="4827"><span data-slate-leaf="true" data-offset-key="4827:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4828"><span data-slate-object="text" data-key="4829"><span data-slate-leaf="true" data-offset-key="4829:0" data-first-offset="true"><span data-slate-string="true">./defer1.</span></span></span><span data-slate-object="text" data-key="4830"><span data-slate-leaf="true" data-offset-key="4830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4831"><span data-slate-leaf="true" data-offset-key="4831:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4832"><span data-slate-leaf="true" data-offset-key="4832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">23</span></span></span></span><span data-slate-object="text" data-key="4833"><span data-slate-leaf="true" data-offset-key="4833:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4834"><span data-slate-leaf="true" data-offset-key="4834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4835"><span data-slate-leaf="true" data-offset-key="4835:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="4836"><span data-slate-leaf="true" data-offset-key="4836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4837"><span data-slate-leaf="true" data-offset-key="4837:0" data-first-offset="true"><span data-slate-string="true"> discards result of </span></span></span><span data-slate-object="text" data-key="4838"><span data-slate-leaf="true" data-offset-key="4838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">imag</span></span></span></span><span data-slate-object="text" data-key="4839"><span data-slate-leaf="true" data-offset-key="4839:0" data-first-offset="true"><span data-slate-string="true">(a)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4840"><span data-slate-object="text" data-key="4841"><span data-slate-leaf="true" data-offset-key="4841:0" data-first-offset="true"><span data-slate-string="true">./defer1.</span></span></span><span data-slate-object="text" data-key="4842"><span data-slate-leaf="true" data-offset-key="4842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4843"><span data-slate-leaf="true" data-offset-key="4843:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4844"><span data-slate-leaf="true" data-offset-key="4844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">24</span></span></span></span><span data-slate-object="text" data-key="4845"><span data-slate-leaf="true" data-offset-key="4845:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4846"><span data-slate-leaf="true" data-offset-key="4846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4847"><span data-slate-leaf="true" data-offset-key="4847:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="4848"><span data-slate-leaf="true" data-offset-key="4848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4849"><span data-slate-leaf="true" data-offset-key="4849:0" data-first-offset="true"><span data-slate-string="true"> discards result of </span></span></span><span data-slate-object="text" data-key="4850"><span data-slate-leaf="true" data-offset-key="4850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="4851"><span data-slate-leaf="true" data-offset-key="4851:0" data-first-offset="true"><span data-slate-string="true">(sl)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4852"><span data-slate-object="text" data-key="4853"><span data-slate-leaf="true" data-offset-key="4853:0" data-first-offset="true"><span data-slate-string="true">./defer1.</span></span></span><span data-slate-object="text" data-key="4854"><span data-slate-leaf="true" data-offset-key="4854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4855"><span data-slate-leaf="true" data-offset-key="4855:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4856"><span data-slate-leaf="true" data-offset-key="4856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">25</span></span></span></span><span data-slate-object="text" data-key="4857"><span data-slate-leaf="true" data-offset-key="4857:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4858"><span data-slate-leaf="true" data-offset-key="4858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4859"><span data-slate-leaf="true" data-offset-key="4859:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="4860"><span data-slate-leaf="true" data-offset-key="4860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4861"><span data-slate-leaf="true" data-offset-key="4861:0" data-first-offset="true"><span data-slate-string="true"> discards result of </span></span></span><span data-slate-object="text" data-key="4862"><span data-slate-leaf="true" data-offset-key="4862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="4863"><span data-slate-leaf="true" data-offset-key="4863:0" data-first-offset="true"><span data-slate-string="true">([]</span></span></span><span data-slate-object="text" data-key="4864"><span data-slate-leaf="true" data-offset-key="4864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4865"><span data-slate-leaf="true" data-offset-key="4865:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4866"><span data-slate-leaf="true" data-offset-key="4866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="4867"><span data-slate-leaf="true" data-offset-key="4867:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4868"><span data-slate-object="text" data-key="4869"><span data-slate-leaf="true" data-offset-key="4869:0" data-first-offset="true"><span data-slate-string="true">./defer1.</span></span></span><span data-slate-object="text" data-key="4870"><span data-slate-leaf="true" data-offset-key="4870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4871"><span data-slate-leaf="true" data-offset-key="4871:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4872"><span data-slate-leaf="true" data-offset-key="4872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">26</span></span></span></span><span data-slate-object="text" data-key="4873"><span data-slate-leaf="true" data-offset-key="4873:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4874"><span data-slate-leaf="true" data-offset-key="4874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4875"><span data-slate-leaf="true" data-offset-key="4875:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="4876"><span data-slate-leaf="true" data-offset-key="4876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4877"><span data-slate-leaf="true" data-offset-key="4877:0" data-first-offset="true"><span data-slate-string="true"> discards result of </span></span></span><span data-slate-object="text" data-key="4878"><span data-slate-leaf="true" data-offset-key="4878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="4879"><span data-slate-leaf="true" data-offset-key="4879:0" data-first-offset="true"><span data-slate-string="true">(*</span></span></span><span data-slate-object="text" data-key="4880"><span data-slate-leaf="true" data-offset-key="4880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4881"><span data-slate-leaf="true" data-offset-key="4881:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4882"><span data-slate-object="text" data-key="4883"><span data-slate-leaf="true" data-offset-key="4883:0" data-first-offset="true"><span data-slate-string="true">./defer1.</span></span></span><span data-slate-object="text" data-key="4884"><span data-slate-leaf="true" data-offset-key="4884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="4885"><span data-slate-leaf="true" data-offset-key="4885:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4886"><span data-slate-leaf="true" data-offset-key="4886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">30</span></span></span></span><span data-slate-object="text" data-key="4887"><span data-slate-leaf="true" data-offset-key="4887:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4888"><span data-slate-leaf="true" data-offset-key="4888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="4889"><span data-slate-leaf="true" data-offset-key="4889:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="4890"><span data-slate-leaf="true" data-offset-key="4890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4891"><span data-slate-leaf="true" data-offset-key="4891:0" data-first-offset="true"><span data-slate-string="true"> discards result of </span></span></span><span data-slate-object="text" data-key="4892"><span data-slate-leaf="true" data-offset-key="4892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">real</span></span></span></span><span data-slate-object="text" data-key="4893"><span data-slate-leaf="true" data-offset-key="4893:0" data-first-offset="true"><span data-slate-string="true">(a)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4894"><span data-slate-object="text" data-key="4895"><span data-slate-leaf="true" data-offset-key="4895:0" data-first-offset="true"><span data-slate-string="true">我们看到，Go 编译器居然给出一组错误提示！</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4896"><span data-slate-object="text" data-key="4897"><span data-slate-leaf="true" data-offset-key="4897:0" data-first-offset="true"><span data-slate-string="true">从这组错误提示中我们可以看到，</span></span><span data-slate-leaf="true" data-offset-key="4897:1"><span data-slate-object="annotation" data-annotation-key="gkann_42a4c822" data-attr-id="44155" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">append、cap、len、make、new、imag 等内置函数都是不能直接作为 deferred 函数的，</span></span></span><span data-slate-leaf="true" data-offset-key="4897:2"><span data-slate-object="annotation" data-annotation-key="gkann_bda35f71" data-attr-id="44156" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">而 close、copy、delete、print、recover 等内置函数则可以直接被 defer 设置为 deferred 函数。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4898"><span data-slate-object="text" data-key="4899"><span data-slate-leaf="true" data-offset-key="4899:0" data-first-offset="true"><span data-slate-string="true">不过，</span></span><span data-slate-leaf="true" data-offset-key="4899:1"><span data-slate-object="annotation" data-annotation-key="gkann_9087258d" data-attr-id="39632" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">对于那些不能直接作为 deferred 函数的内置函数，我们可以使用一个包裹它的匿名函数来间接满足要求，</span></span></span><span data-slate-leaf="true" data-offset-key="4899:2"><span data-slate-string="true">以 append 为例是这样的：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="4900"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4901"><span data-slate-object="text" data-key="4902"><span data-slate-leaf="true" data-offset-key="4902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4903"><span data-slate-leaf="true" data-offset-key="4903:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4904"><span data-slate-leaf="true" data-offset-key="4904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4905"><span data-slate-leaf="true" data-offset-key="4905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4906"><span data-slate-leaf="true" data-offset-key="4906:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4907"><span data-slate-object="text" data-key="4908"><span data-slate-leaf="true" data-offset-key="4908:0" data-first-offset="true"><span data-slate-string="true">  _ = </span></span></span><span data-slate-object="text" data-key="4909"><span data-slate-leaf="true" data-offset-key="4909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="4910"><span data-slate-leaf="true" data-offset-key="4910:0" data-first-offset="true"><span data-slate-string="true">(sl, </span></span></span><span data-slate-object="text" data-key="4911"><span data-slate-leaf="true" data-offset-key="4911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">11</span></span></span></span><span data-slate-object="text" data-key="4912"><span data-slate-leaf="true" data-offset-key="4912:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4913"><span data-slate-object="text" data-key="4914"><span data-slate-leaf="true" data-offset-key="4914:0" data-first-offset="true"><span data-slate-string="true">}()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="4915" id="sr-toc-10"><span data-slate-object="text" data-key="4916"><span data-slate-leaf="true" data-offset-key="4916:0" data-first-offset="true"><span data-slate-string="true">第二点：注意 defer 关键字后面表达式的求值时机</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="4917"><span data-slate-object="text" data-key="4918"><span data-slate-leaf="true" data-offset-key="4918:0" data-first-offset="true"><span data-slate-string="true">这里，</span></span><span data-slate-leaf="true" data-offset-key="4918:1"><span data-slate-object="annotation" data-annotation-key="gkann_f858e08a" data-attr-id="36051" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">你一定要牢记一点：</span></span></span></span><span data-slate-object="text" data-key="4919"><span data-slate-leaf="true" data-offset-key="4919:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f858e08a" data-attr-id="36051" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">defer 关键字后面的表达式，是在将 deferred 函数注册到 deferred 函数栈的时候进行求值的</span></span></span></span></span><span data-slate-object="text" data-key="4920"><span data-slate-leaf="true" data-offset-key="4920:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f858e08a" data-attr-id="36051" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4921"><span data-slate-object="text" data-key="4922"><span data-slate-leaf="true" data-offset-key="4922:0" data-first-offset="true"><span data-slate-string="true">我们同样用一个典型的例子来说明一下 defer 后表达式的求值时机：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="4923"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4924"><span data-slate-object="text" data-key="4925"><span data-slate-leaf="true" data-offset-key="4925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4926"><span data-slate-leaf="true" data-offset-key="4926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4927"><span data-slate-leaf="true" data-offset-key="4927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo1</span></span></span></span></span><span data-slate-object="text" data-key="4928"><span data-slate-leaf="true" data-offset-key="4928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4929"><span data-slate-leaf="true" data-offset-key="4929:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4930"><span data-slate-object="text" data-key="4931"><span data-slate-leaf="true" data-offset-key="4931:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4932"><span data-slate-leaf="true" data-offset-key="4932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="4933"><span data-slate-leaf="true" data-offset-key="4933:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="4934"><span data-slate-leaf="true" data-offset-key="4934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4935"><span data-slate-leaf="true" data-offset-key="4935:0" data-first-offset="true"><span data-slate-string="true">; i &lt;= </span></span></span><span data-slate-object="text" data-key="4936"><span data-slate-leaf="true" data-offset-key="4936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="4937"><span data-slate-leaf="true" data-offset-key="4937:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4938"><span data-slate-object="text" data-key="4939"><span data-slate-leaf="true" data-offset-key="4939:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4940"><span data-slate-leaf="true" data-offset-key="4940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4941"><span data-slate-leaf="true" data-offset-key="4941:0" data-first-offset="true"><span data-slate-string="true"> fmt.Println(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4942"><span data-slate-object="text" data-key="4943"><span data-slate-leaf="true" data-offset-key="4943:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4944"><span data-slate-object="text" data-key="4945"><span data-slate-leaf="true" data-offset-key="4945:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4946"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4947"><span data-slate-object="text" data-key="4948"><span data-slate-leaf="true" data-offset-key="4948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4949"><span data-slate-leaf="true" data-offset-key="4949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4950"><span data-slate-leaf="true" data-offset-key="4950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo2</span></span></span></span></span><span data-slate-object="text" data-key="4951"><span data-slate-leaf="true" data-offset-key="4951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4952"><span data-slate-leaf="true" data-offset-key="4952:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4953"><span data-slate-object="text" data-key="4954"><span data-slate-leaf="true" data-offset-key="4954:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4955"><span data-slate-leaf="true" data-offset-key="4955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="4956"><span data-slate-leaf="true" data-offset-key="4956:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="4957"><span data-slate-leaf="true" data-offset-key="4957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4958"><span data-slate-leaf="true" data-offset-key="4958:0" data-first-offset="true"><span data-slate-string="true">; i &lt;= </span></span></span><span data-slate-object="text" data-key="4959"><span data-slate-leaf="true" data-offset-key="4959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="4960"><span data-slate-leaf="true" data-offset-key="4960:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4961"><span data-slate-object="text" data-key="4962"><span data-slate-leaf="true" data-offset-key="4962:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4963"><span data-slate-leaf="true" data-offset-key="4963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4964"><span data-slate-leaf="true" data-offset-key="4964:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4965"><span data-slate-leaf="true" data-offset-key="4965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4966"><span data-slate-leaf="true" data-offset-key="4966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(n </span></span></span></span></span><span data-slate-object="text" data-key="4967"><span data-slate-leaf="true" data-offset-key="4967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="4968"><span data-slate-leaf="true" data-offset-key="4968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4969"><span data-slate-leaf="true" data-offset-key="4969:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4970"><span data-slate-object="text" data-key="4971"><span data-slate-leaf="true" data-offset-key="4971:0" data-first-offset="true"><span data-slate-string="true">            fmt.Println(n)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4972"><span data-slate-object="text" data-key="4973"><span data-slate-leaf="true" data-offset-key="4973:0" data-first-offset="true"><span data-slate-string="true">        }(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4974"><span data-slate-object="text" data-key="4975"><span data-slate-leaf="true" data-offset-key="4975:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4976"><span data-slate-object="text" data-key="4977"><span data-slate-leaf="true" data-offset-key="4977:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4978"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4979"><span data-slate-object="text" data-key="4980"><span data-slate-leaf="true" data-offset-key="4980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4981"><span data-slate-leaf="true" data-offset-key="4981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4982"><span data-slate-leaf="true" data-offset-key="4982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">foo3</span></span></span></span></span><span data-slate-object="text" data-key="4983"><span data-slate-leaf="true" data-offset-key="4983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4984"><span data-slate-leaf="true" data-offset-key="4984:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4985"><span data-slate-object="text" data-key="4986"><span data-slate-leaf="true" data-offset-key="4986:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4987"><span data-slate-leaf="true" data-offset-key="4987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="4988"><span data-slate-leaf="true" data-offset-key="4988:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="4989"><span data-slate-leaf="true" data-offset-key="4989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4990"><span data-slate-leaf="true" data-offset-key="4990:0" data-first-offset="true"><span data-slate-string="true">; i &lt;= </span></span></span><span data-slate-object="text" data-key="4991"><span data-slate-leaf="true" data-offset-key="4991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="4992"><span data-slate-leaf="true" data-offset-key="4992:0" data-first-offset="true"><span data-slate-string="true">; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4993"><span data-slate-object="text" data-key="4994"><span data-slate-leaf="true" data-offset-key="4994:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="4995"><span data-slate-leaf="true" data-offset-key="4995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="4996"><span data-slate-leaf="true" data-offset-key="4996:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4997"><span data-slate-leaf="true" data-offset-key="4997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="4998"><span data-slate-leaf="true" data-offset-key="4998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4999"><span data-slate-leaf="true" data-offset-key="4999:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5000"><span data-slate-object="text" data-key="5001"><span data-slate-leaf="true" data-offset-key="5001:0" data-first-offset="true"><span data-slate-string="true">            fmt.Println(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5002"><span data-slate-object="text" data-key="5003"><span data-slate-leaf="true" data-offset-key="5003:0" data-first-offset="true"><span data-slate-string="true">        }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5004"><span data-slate-object="text" data-key="5005"><span data-slate-leaf="true" data-offset-key="5005:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5006"><span data-slate-object="text" data-key="5007"><span data-slate-leaf="true" data-offset-key="5007:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5008"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5009"><span data-slate-object="text" data-key="5010"><span data-slate-leaf="true" data-offset-key="5010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5011"><span data-slate-leaf="true" data-offset-key="5011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5012"><span data-slate-leaf="true" data-offset-key="5012:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="5013"><span data-slate-leaf="true" data-offset-key="5013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5014"><span data-slate-leaf="true" data-offset-key="5014:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5015"><span data-slate-object="text" data-key="5016"><span data-slate-leaf="true" data-offset-key="5016:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="5017"><span data-slate-leaf="true" data-offset-key="5017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo1 result:"</span></span></span></span><span data-slate-object="text" data-key="5018"><span data-slate-leaf="true" data-offset-key="5018:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5019"><span data-slate-object="text" data-key="5020"><span data-slate-leaf="true" data-offset-key="5020:0" data-first-offset="true"><span data-slate-string="true">    foo1()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5021"><span data-slate-object="text" data-key="5022"><span data-slate-leaf="true" data-offset-key="5022:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="5023"><span data-slate-leaf="true" data-offset-key="5023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"\nfoo2 result:"</span></span></span></span><span data-slate-object="text" data-key="5024"><span data-slate-leaf="true" data-offset-key="5024:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5025"><span data-slate-object="text" data-key="5026"><span data-slate-leaf="true" data-offset-key="5026:0" data-first-offset="true"><span data-slate-string="true">    foo2()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5027"><span data-slate-object="text" data-key="5028"><span data-slate-leaf="true" data-offset-key="5028:0" data-first-offset="true"><span data-slate-string="true">    fmt.Println(</span></span></span><span data-slate-object="text" data-key="5029"><span data-slate-leaf="true" data-offset-key="5029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"\nfoo3 result:"</span></span></span></span><span data-slate-object="text" data-key="5030"><span data-slate-leaf="true" data-offset-key="5030:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5031"><span data-slate-object="text" data-key="5032"><span data-slate-leaf="true" data-offset-key="5032:0" data-first-offset="true"><span data-slate-string="true">    foo3()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5033"><span data-slate-object="text" data-key="5034"><span data-slate-leaf="true" data-offset-key="5034:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5035"><span data-slate-object="text" data-key="5036"><span data-slate-leaf="true" data-offset-key="5036:0" data-first-offset="true"><span data-slate-string="true">这里，我们一个个分析 foo1、foo2 和 foo3 中 defer 后的表达式的求值时机。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5037"><span data-slate-object="text" data-key="5038"><span data-slate-leaf="true" data-offset-key="5038:0" data-first-offset="true"><span data-slate-string="true">首先是 foo1。foo1 中 defer 后面直接用的是 fmt.Println 函数，每当 defer 将 fmt.Println 注册到 deferred 函数栈的时候，都会对 Println 后面的参数进行求值。根据上述代码逻辑，依次压入 deferred 函数栈的函数是：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="5039"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5040"><span data-slate-object="text" data-key="5041"><span data-slate-leaf="true" data-offset-key="5041:0" data-first-offset="true"><span data-slate-string="true">fmt.Println(0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5042"><span data-slate-object="text" data-key="5043"><span data-slate-leaf="true" data-offset-key="5043:0" data-first-offset="true"><span data-slate-string="true">fmt.Println(1)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5044"><span data-slate-object="text" data-key="5045"><span data-slate-leaf="true" data-offset-key="5045:0" data-first-offset="true"><span data-slate-string="true">fmt.Println(2)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5046"><span data-slate-object="text" data-key="5047"><span data-slate-leaf="true" data-offset-key="5047:0" data-first-offset="true"><span data-slate-string="true">fmt.Println(3)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5048"><span data-slate-object="text" data-key="5049"><span data-slate-leaf="true" data-offset-key="5049:0" data-first-offset="true"><span data-slate-string="true">因此，当 foo1 返回后，deferred 函数被调度执行时，上述压入栈的 deferred 函数将以 LIFO 次序出栈执行，这时的输出的结果为：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="5050"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5051"><span data-slate-object="text" data-key="5052"><span data-slate-leaf="true" data-offset-key="5052:0" data-first-offset="true"><span data-slate-string="true">3</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5053"><span data-slate-object="text" data-key="5054"><span data-slate-leaf="true" data-offset-key="5054:0" data-first-offset="true"><span data-slate-string="true">2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5055"><span data-slate-object="text" data-key="5056"><span data-slate-leaf="true" data-offset-key="5056:0" data-first-offset="true"><span data-slate-string="true">1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5057"><span data-slate-object="text" data-key="5058"><span data-slate-leaf="true" data-offset-key="5058:0" data-first-offset="true"><span data-slate-string="true">0</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5059"><span data-slate-object="text" data-key="5060"><span data-slate-leaf="true" data-offset-key="5060:0" data-first-offset="true"><span data-slate-string="true">然后我们再看 foo2。foo2 中 defer 后面接的是一个带有一个参数的匿名函数。每当 defer 将匿名函数注册到 deferred 函数栈的时候，都会对该匿名函数的参数进行求值。根据上述代码逻辑，依次压入 deferred 函数栈的函数是：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5061"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5062"><span data-slate-object="text" data-key="5063"><span data-slate-leaf="true" data-offset-key="5063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5064"><span data-slate-leaf="true" data-offset-key="5064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(0)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5065"><span data-slate-object="text" data-key="5066"><span data-slate-leaf="true" data-offset-key="5066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5067"><span data-slate-leaf="true" data-offset-key="5067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(1)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5068"><span data-slate-object="text" data-key="5069"><span data-slate-leaf="true" data-offset-key="5069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5070"><span data-slate-leaf="true" data-offset-key="5070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(2)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5071"><span data-slate-object="text" data-key="5072"><span data-slate-leaf="true" data-offset-key="5072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5073"><span data-slate-leaf="true" data-offset-key="5073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(3)</span></span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5074"><span data-slate-object="text" data-key="5075"><span data-slate-leaf="true" data-offset-key="5075:0" data-first-offset="true"><span data-slate-string="true">因此，当 foo2 返回后，deferred 函数被调度执行时，上述压入栈的 deferred 函数将以 LIFO 次序出栈执行，因此输出的结果为：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="5076"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5077"><span data-slate-object="text" data-key="5078"><span data-slate-leaf="true" data-offset-key="5078:0" data-first-offset="true"><span data-slate-string="true">3</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5079"><span data-slate-object="text" data-key="5080"><span data-slate-leaf="true" data-offset-key="5080:0" data-first-offset="true"><span data-slate-string="true">2</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5081"><span data-slate-object="text" data-key="5082"><span data-slate-leaf="true" data-offset-key="5082:0" data-first-offset="true"><span data-slate-string="true">1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5083"><span data-slate-object="text" data-key="5084"><span data-slate-leaf="true" data-offset-key="5084:0" data-first-offset="true"><span data-slate-string="true">0</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5085"><span data-slate-object="text" data-key="5086"><span data-slate-leaf="true" data-offset-key="5086:0" data-first-offset="true"><span data-slate-string="true">最后我们来看 foo3。foo3 中 defer 后面接的是一个不带参数的匿名函数。根据上述代码逻辑，依次压入 deferred 函数栈的函数是：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5087"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5088"><span data-slate-object="text" data-key="5089"><span data-slate-leaf="true" data-offset-key="5089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5090"><span data-slate-leaf="true" data-offset-key="5090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5091"><span data-slate-object="text" data-key="5092"><span data-slate-leaf="true" data-offset-key="5092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5093"><span data-slate-leaf="true" data-offset-key="5093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5094"><span data-slate-object="text" data-key="5095"><span data-slate-leaf="true" data-offset-key="5095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5096"><span data-slate-leaf="true" data-offset-key="5096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5097"><span data-slate-object="text" data-key="5098"><span data-slate-leaf="true" data-offset-key="5098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5099"><span data-slate-leaf="true" data-offset-key="5099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5100"><span data-slate-object="text" data-key="5101"><span data-slate-leaf="true" data-offset-key="5101:0" data-first-offset="true"><span data-slate-string="true">所以，当 foo3 返回后，deferred 函数被调度执行时，上述压入栈的 deferred 函数将以 LIFO 次序出栈执行。</span></span><span data-slate-leaf="true" data-offset-key="5101:1"><span data-slate-object="annotation" data-annotation-key="gkann_b48031c6" data-attr-id="39491" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">匿名函数会以闭包的方式访问外围函数的变量 i，</span></span></span><span data-slate-leaf="true" data-offset-key="5101:2"><span data-slate-string="true">并通过 Println 输出 i 的值，此时 i 的值为 4，因此 foo3 的输出结果为：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="5102"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5103"><span data-slate-object="text" data-key="5104"><span data-slate-leaf="true" data-offset-key="5104:0" data-first-offset="true"><span data-slate-string="true">4</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5105"><span data-slate-object="text" data-key="5106"><span data-slate-leaf="true" data-offset-key="5106:0" data-first-offset="true"><span data-slate-string="true">4</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5107"><span data-slate-object="text" data-key="5108"><span data-slate-leaf="true" data-offset-key="5108:0" data-first-offset="true"><span data-slate-string="true">4</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5109"><span data-slate-object="text" data-key="5110"><span data-slate-leaf="true" data-offset-key="5110:0" data-first-offset="true"><span data-slate-string="true">4</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5111"><span data-slate-object="text" data-key="5112"><span data-slate-leaf="true" data-offset-key="5112:0" data-first-offset="true"><span data-slate-string="true">通过这些例子，我们可以看到，无论以何种形式将函数注册到 defer 中，</span></span><span data-slate-leaf="true" data-offset-key="5112:1"><span data-slate-object="annotation" data-annotation-key="gkann_10318235" data-attr-id="39578" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">deferred 函数的参数值都是在注册的时候进行求值的。</span></span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="5113" id="sr-toc-11"><span data-slate-object="text" data-key="5114"><span data-slate-leaf="true" data-offset-key="5114:0" data-first-offset="true"><span data-slate-string="true">第三点：知晓 defer 带来的性能损耗</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="5115"><span data-slate-object="text" data-key="5116"><span data-slate-leaf="true" data-offset-key="5116:0" data-first-offset="true"><span data-slate-string="true">通过前面的分析，我们可以看到，defer 让我们进行资源释放（如文件描述符、锁）的过程变得优雅很多，也不易出错。但在性能敏感的应用中，defer 带来的性能负担也是我们必须要知晓和权衡的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5117"><span data-slate-object="text" data-key="5118"><span data-slate-leaf="true" data-offset-key="5118:0" data-first-offset="true"><span data-slate-string="true">这里，我们用一个性能基准测试（Benchmark），直观地看看 defer 究竟会带来多少性能损耗。基于 Go 工具链，我们可以很方便地为 Go 源码写一个性能基准测试，只需将代码放在以 “_test.go” 为后缀的源文件中，然后利用 testing 包提供的 “框架” 就可以了，我们看下面代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5119"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5120"><span data-slate-object="text" data-key="5121"><span data-slate-leaf="true" data-offset-key="5121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// defer_test.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5122"><span data-slate-object="text" data-key="5123"><span data-slate-leaf="true" data-offset-key="5123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="5124"><span data-slate-leaf="true" data-offset-key="5124:0" data-first-offset="true"><span data-slate-string="true"> main</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5125"><span data-slate-object="text" data-key="5126"><span data-slate-leaf="true" data-offset-key="5126:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5127"><span data-slate-object="text" data-key="5128"><span data-slate-leaf="true" data-offset-key="5128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="5129"><span data-slate-leaf="true" data-offset-key="5129:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5130"><span data-slate-leaf="true" data-offset-key="5130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"testing"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5131"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5132"><span data-slate-object="text" data-key="5133"><span data-slate-leaf="true" data-offset-key="5133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5134"><span data-slate-leaf="true" data-offset-key="5134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5135"><span data-slate-leaf="true" data-offset-key="5135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sum</span></span></span></span></span><span data-slate-object="text" data-key="5136"><span data-slate-leaf="true" data-offset-key="5136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(max </span></span></span></span></span><span data-slate-object="text" data-key="5137"><span data-slate-leaf="true" data-offset-key="5137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="5138"><span data-slate-leaf="true" data-offset-key="5138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="5139"><span data-slate-leaf="true" data-offset-key="5139:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5140"><span data-slate-leaf="true" data-offset-key="5140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5141"><span data-slate-leaf="true" data-offset-key="5141:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5142"><span data-slate-object="text" data-key="5143"><span data-slate-leaf="true" data-offset-key="5143:0" data-first-offset="true"><span data-slate-string="true">    total := </span></span></span><span data-slate-object="text" data-key="5144"><span data-slate-leaf="true" data-offset-key="5144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5145"><span data-slate-object="text" data-key="5146"><span data-slate-leaf="true" data-offset-key="5146:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5147"><span data-slate-leaf="true" data-offset-key="5147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5148"><span data-slate-leaf="true" data-offset-key="5148:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="5149"><span data-slate-leaf="true" data-offset-key="5149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5150"><span data-slate-leaf="true" data-offset-key="5150:0" data-first-offset="true"><span data-slate-string="true">; i &lt; max; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5151"><span data-slate-object="text" data-key="5152"><span data-slate-leaf="true" data-offset-key="5152:0" data-first-offset="true"><span data-slate-string="true">        total += i</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5153"><span data-slate-object="text" data-key="5154"><span data-slate-leaf="true" data-offset-key="5154:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5155"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5156"><span data-slate-object="text" data-key="5157"><span data-slate-leaf="true" data-offset-key="5157:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5158"><span data-slate-leaf="true" data-offset-key="5158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5159"><span data-slate-leaf="true" data-offset-key="5159:0" data-first-offset="true"><span data-slate-string="true"> total</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5160"><span data-slate-object="text" data-key="5161"><span data-slate-leaf="true" data-offset-key="5161:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5162"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5163"><span data-slate-object="text" data-key="5164"><span data-slate-leaf="true" data-offset-key="5164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5165"><span data-slate-leaf="true" data-offset-key="5165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5166"><span data-slate-leaf="true" data-offset-key="5166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fooWithDefer</span></span></span></span></span><span data-slate-object="text" data-key="5167"><span data-slate-leaf="true" data-offset-key="5167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5168"><span data-slate-leaf="true" data-offset-key="5168:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5169"><span data-slate-object="text" data-key="5170"><span data-slate-leaf="true" data-offset-key="5170:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5171"><span data-slate-leaf="true" data-offset-key="5171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="5172"><span data-slate-leaf="true" data-offset-key="5172:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5173"><span data-slate-leaf="true" data-offset-key="5173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5174"><span data-slate-leaf="true" data-offset-key="5174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5175"><span data-slate-leaf="true" data-offset-key="5175:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5176"><span data-slate-object="text" data-key="5177"><span data-slate-leaf="true" data-offset-key="5177:0" data-first-offset="true"><span data-slate-string="true">        sum(</span></span></span><span data-slate-object="text" data-key="5178"><span data-slate-leaf="true" data-offset-key="5178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="5179"><span data-slate-leaf="true" data-offset-key="5179:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5180"><span data-slate-object="text" data-key="5181"><span data-slate-leaf="true" data-offset-key="5181:0" data-first-offset="true"><span data-slate-string="true">    }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5182"><span data-slate-object="text" data-key="5183"><span data-slate-leaf="true" data-offset-key="5183:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5184"><span data-slate-object="text" data-key="5185"><span data-slate-leaf="true" data-offset-key="5185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5186"><span data-slate-leaf="true" data-offset-key="5186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5187"><span data-slate-leaf="true" data-offset-key="5187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">fooWithoutDefer</span></span></span></span></span><span data-slate-object="text" data-key="5188"><span data-slate-leaf="true" data-offset-key="5188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5189"><span data-slate-leaf="true" data-offset-key="5189:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5190"><span data-slate-object="text" data-key="5191"><span data-slate-leaf="true" data-offset-key="5191:0" data-first-offset="true"><span data-slate-string="true">    sum(</span></span></span><span data-slate-object="text" data-key="5192"><span data-slate-leaf="true" data-offset-key="5192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="5193"><span data-slate-leaf="true" data-offset-key="5193:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5194"><span data-slate-object="text" data-key="5195"><span data-slate-leaf="true" data-offset-key="5195:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5196"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5197"><span data-slate-object="text" data-key="5198"><span data-slate-leaf="true" data-offset-key="5198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5199"><span data-slate-leaf="true" data-offset-key="5199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5200"><span data-slate-leaf="true" data-offset-key="5200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkFooWithDefer</span></span></span></span></span><span data-slate-object="text" data-key="5201"><span data-slate-leaf="true" data-offset-key="5201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="5202"><span data-slate-leaf="true" data-offset-key="5202:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5203"><span data-slate-object="text" data-key="5204"><span data-slate-leaf="true" data-offset-key="5204:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5205"><span data-slate-leaf="true" data-offset-key="5205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5206"><span data-slate-leaf="true" data-offset-key="5206:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="5207"><span data-slate-leaf="true" data-offset-key="5207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5208"><span data-slate-leaf="true" data-offset-key="5208:0" data-first-offset="true"><span data-slate-string="true">; i &lt; b.N; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5209"><span data-slate-object="text" data-key="5210"><span data-slate-leaf="true" data-offset-key="5210:0" data-first-offset="true"><span data-slate-string="true">        fooWithDefer()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5211"><span data-slate-object="text" data-key="5212"><span data-slate-leaf="true" data-offset-key="5212:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5213"><span data-slate-object="text" data-key="5214"><span data-slate-leaf="true" data-offset-key="5214:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5215"><span data-slate-object="text" data-key="5216"><span data-slate-leaf="true" data-offset-key="5216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5217"><span data-slate-leaf="true" data-offset-key="5217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5218"><span data-slate-leaf="true" data-offset-key="5218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BenchmarkFooWithoutDefer</span></span></span></span></span><span data-slate-object="text" data-key="5219"><span data-slate-leaf="true" data-offset-key="5219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(b *testing.B)</span></span></span></span></span><span data-slate-object="text" data-key="5220"><span data-slate-leaf="true" data-offset-key="5220:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5221"><span data-slate-object="text" data-key="5222"><span data-slate-leaf="true" data-offset-key="5222:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5223"><span data-slate-leaf="true" data-offset-key="5223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5224"><span data-slate-leaf="true" data-offset-key="5224:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="5225"><span data-slate-leaf="true" data-offset-key="5225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5226"><span data-slate-leaf="true" data-offset-key="5226:0" data-first-offset="true"><span data-slate-string="true">; i &lt; b.N; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5227"><span data-slate-object="text" data-key="5228"><span data-slate-leaf="true" data-offset-key="5228:0" data-first-offset="true"><span data-slate-string="true">        fooWithoutDefer()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5229"><span data-slate-object="text" data-key="5230"><span data-slate-leaf="true" data-offset-key="5230:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5231"><span data-slate-object="text" data-key="5232"><span data-slate-leaf="true" data-offset-key="5232:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5233"><span data-slate-object="text" data-key="5234"><span data-slate-leaf="true" data-offset-key="5234:0" data-first-offset="true"><span data-slate-string="true">这个基准测试包含了两个测试用例，分别是 BenchmarkFooWithDefer 和 BenchmarkFooWithoutDefer。前者测量的是带有 defer 的函数执行的性能，后者测量的是不带有 defer 的函数的执行的性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5235"><span data-slate-object="text" data-key="5236"><span data-slate-leaf="true" data-offset-key="5236:0" data-first-offset="true"><span data-slate-string="true">在 Go 1.13 前的版本中，defer 带来的开销还是很大的。我们先用 Go 1.12.7 版本来运行一下上述基准测试，我们会得到如下结果：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5237"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5238"><span data-slate-object="text" data-key="5239"><span data-slate-leaf="true" data-offset-key="5239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="5240"><span data-slate-leaf="true" data-offset-key="5240:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5241"><span data-slate-leaf="true" data-offset-key="5241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="5242"><span data-slate-leaf="true" data-offset-key="5242:0" data-first-offset="true"><span data-slate-string="true"> -bench . defer_test.go</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5243"><span data-slate-object="text" data-key="5244"><span data-slate-leaf="true" data-offset-key="5244:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5245"><span data-slate-object="text" data-key="5246"><span data-slate-leaf="true" data-offset-key="5246:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5247"><span data-slate-object="text" data-key="5248"><span data-slate-leaf="true" data-offset-key="5248:0" data-first-offset="true"><span data-slate-string="true">BenchmarkFooWithDefer-8        30000000          42.6 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5249"><span data-slate-object="text" data-key="5250"><span data-slate-leaf="true" data-offset-key="5250:0" data-first-offset="true"><span data-slate-string="true">BenchmarkFooWithoutDefer-8     300000000           5.44 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5251"><span data-slate-object="text" data-key="5252"><span data-slate-leaf="true" data-offset-key="5252:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5253"><span data-slate-object="text" data-key="5254"><span data-slate-leaf="true" data-offset-key="5254:0" data-first-offset="true"><span data-slate-string="true">ok    command-line-arguments  3.511s</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5255"><span data-slate-object="text" data-key="5256"><span data-slate-leaf="true" data-offset-key="5256:0" data-first-offset="true"><span data-slate-string="true">从这个基准测试结果中，我们可以清晰地看到：</span></span></span><span data-slate-object="text" data-key="5257"><span data-slate-leaf="true" data-offset-key="5257:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">使用 defer 的函数的执行时间是没有使用 defer 函数的 8 倍左右</span></span></span></span><span data-slate-object="text" data-key="5258"><span data-slate-leaf="true" data-offset-key="5258:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5259"><span data-slate-object="text" data-key="5260"><span data-slate-leaf="true" data-offset-key="5260:0" data-first-offset="true"><span data-slate-string="true">但从 Go 1.13 版本开始，Go 核心团队对 defer 性能进行了多次优化，到现在的 Go 1.17 版本，defer 的开销已经足够小了。我们看看使用 Go 1.17 版本运行上述基准测试的结果：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5261"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5262"><span data-slate-object="text" data-key="5263"><span data-slate-leaf="true" data-offset-key="5263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$go</span></span></span></span><span data-slate-object="text" data-key="5264"><span data-slate-leaf="true" data-offset-key="5264:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5265"><span data-slate-leaf="true" data-offset-key="5265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">test</span></span></span></span><span data-slate-object="text" data-key="5266"><span data-slate-leaf="true" data-offset-key="5266:0" data-first-offset="true"><span data-slate-string="true"> -bench . defer_test.go</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5267"><span data-slate-object="text" data-key="5268"><span data-slate-leaf="true" data-offset-key="5268:0" data-first-offset="true"><span data-slate-string="true">goos: darwin</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5269"><span data-slate-object="text" data-key="5270"><span data-slate-leaf="true" data-offset-key="5270:0" data-first-offset="true"><span data-slate-string="true">goarch: amd64</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5271"><span data-slate-object="text" data-key="5272"><span data-slate-leaf="true" data-offset-key="5272:0" data-first-offset="true"><span data-slate-string="true">BenchmarkFooWithDefer-8        194593353           6.183 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5273"><span data-slate-object="text" data-key="5274"><span data-slate-leaf="true" data-offset-key="5274:0" data-first-offset="true"><span data-slate-string="true">BenchmarkFooWithoutDefer-8     284272650           4.259 ns/op</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5275"><span data-slate-object="text" data-key="5276"><span data-slate-leaf="true" data-offset-key="5276:0" data-first-offset="true"><span data-slate-string="true">PASS</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5277"><span data-slate-object="text" data-key="5278"><span data-slate-leaf="true" data-offset-key="5278:0" data-first-offset="true"><span data-slate-string="true">ok    command-line-arguments  3.472s</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5279"><span data-slate-object="text" data-key="5280"><span data-slate-leaf="true" data-offset-key="5280:0" data-first-offset="true"><span data-slate-string="true">我们看到，带有 defer 的函数执行开销，仅是不带有 defer 的函数的执行开销的 1.45 倍左右，已经达到了几乎可以忽略不计的程度，我们可以放心使用。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5281" id="sr-toc-12"><span data-slate-object="text" data-key="5282"><span data-slate-leaf="true" data-offset-key="5282:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5283"><span data-slate-object="text" data-key="5284"><span data-slate-leaf="true" data-offset-key="5284:0" data-first-offset="true"><span data-slate-string="true">好了，今天的课讲到这里就结束了。在这一讲中，我们延续上一节的脉络，讲解了函数设计过程中应该考虑的、健壮性与简洁性方面的内容。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5285"><span data-slate-object="text" data-key="5286"><span data-slate-leaf="true" data-offset-key="5286:0" data-first-offset="true"><span data-slate-string="true">在函数健壮性方面，我给出了 “三不要” 原则，这三个原则你一定要记住。这里我们重点讲解了第三个原则：</span></span></span><span data-slate-object="text" data-key="5287"><span data-slate-leaf="true" data-offset-key="5287:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不要假定异常不会发生</span></span></span></span><span data-slate-object="text" data-key="5288"><span data-slate-leaf="true" data-offset-key="5288:0" data-first-offset="true"><span data-slate-string="true">。借此，我们认识了 Go 语言中表示异常的 panic，也学习了 panic 发生后的代码执行流程。基于 panic 的行为特征，我们给出了 Go 函数设计过程中应对 panic 的三点经验，这里你要注意，“评估程序对 panic 的忍受度” 是我们选取应对 panic 措施的前提。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5289"><span data-slate-object="text" data-key="5290"><span data-slate-leaf="true" data-offset-key="5290:0" data-first-offset="true"><span data-slate-string="true">另外，对于来自像 Java 这样的、基于 Exception 进行错误处理的编程语言的 Go 初学者们，切记不要将 panic 与错误处理混淆。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5291"><span data-slate-object="text" data-key="5292"><span data-slate-leaf="true" data-offset-key="5292:0" data-first-offset="true"><span data-slate-string="true">接下来，我们又讲解了如何让函数实现更加简洁。简洁性对于函数来说意味着可读性更好，更易于理解，也有利于我们代码健壮性的提升。Go 语言层面提供的 defer 机制可用于简化函数实现，尤其是在函数申请和释放资源个数较多的情况下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5293"><span data-slate-object="text" data-key="5294"><span data-slate-leaf="true" data-offset-key="5294:0" data-first-offset="true"><span data-slate-string="true">如果我们要用好 defer，前提就是要了解 defer 的运作机制，这里你要把握住两点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5295"><div data-slate-type="list-line" data-slate-object="block" data-key="5296"><span data-slate-object="text" data-key="5297"><span data-slate-leaf="true" data-offset-key="5297:0" data-first-offset="true"><span data-slate-string="true">函数返回前，deferred 函数是按照后入先出（LIFO）的顺序执行的；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5298"><span data-slate-object="text" data-key="5299"><span data-slate-leaf="true" data-offset-key="5299:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4cb4384b" data-attr-id="36558" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">defer 关键字是在注册函数时对函数的参数进行求值的。</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5300"><span data-slate-object="text" data-key="5301"><span data-slate-leaf="true" data-offset-key="5301:0" data-first-offset="true"><span data-slate-string="true">最后，在最新 Go 版本 Go1.17 中，使用 defer 带来的开销几乎可以忽略不计了，你可以放心使用。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5302" id="sr-toc-13"><span data-slate-object="text" data-key="5303"><span data-slate-leaf="true" data-offset-key="5303:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5304"><span data-slate-object="text" data-key="5305"><span data-slate-leaf="true" data-offset-key="5305:0" data-first-offset="true"><span data-slate-string="true">defer 是 Gopher 们都喜欢的语言机制，那么我想请你思考一下，除了捕捉 panic、延迟释放资源外，我们日常编码中还有哪些使用 defer 的小技巧呢？一个小提示：你可以阅读一下 Go 标准库中关于 defer 的使用方法，看看是否能总结出一些小 tips。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5306"><span data-slate-object="text" data-key="5307"><span data-slate-leaf="true" data-offset-key="5307:0" data-first-offset="true"><span data-slate-string="true">欢迎你把这节课分享给更多对 Go 语言函数感兴趣的朋友。我是 Tony Bai，我们下节课见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>23</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-14">精选留言 (25)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/53/a8/abc96f70.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>return</span></div></div><div>老师讲的太好了，
再请教一下老师， panic 应该在什么场景下使用，
感觉平时 业务代码 使用 err 足够，没有使用 panic 的场景，
文中举例的 http server 比较合适， 但是 json encode，虽然官方用了 panic，但是个人感觉 使用 err 也没毛病， 传入的 json 串 有问题嘛，就是 入参校验 err 呗。 
所以 get 不到 什么情况下用 panic。</div><div><p>作者回复：如果在平时 panic 用的，那么就说明你走在了正确的道路上：)。panic 本身就是异常，异常本身就是很少发生的。目前看 panic 最常使用的就是充当 “断言”，提示潜在 bug 时用的最多。</p></div><div><div>2021-12-06</div><div><div><i></i><span>3</span></div><div><i></i><span>13</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/7b/bd/ccb37425.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 进化菌</span></div></div><div>panic 恐慌，慌慌张张的抛出异常；recover 恢复，淡定还有事情要做，先别退出；defer 延迟，晚点要做的事情不能忘……</div><div><p>作者回复: 👍</p></div><div><div>2021-12-06</div><div><div><i></i><span>2</span></div><div><i></i><span>12</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/1d/dd/95cdb4d8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>helloxiaomin</span></div></div><div>defer 的使用技巧：1）defer 要在 panic 之前，才能执行；2）defer 内部的 recover 只能捕获当前协程的 Panic，不能跨协程执行；3）recover 只能在 defer 中调用才能生效。暂时想到这些</div><div><p>作者回复: 👍</p></div><div><div>2021-12-07</div><div><div><i></i></div><div><i></i><span>9</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 一步</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>请教一个非课程的问题：
v := [...] int {1: 2, 3: 4}
fmt.Println (len (v)) 

这里为什么打印出来的 长度是 4 呢？</div><div><p>作者回复：这是一种通过数组下标方式对数组进行初始化的方式。我记得我在第 15 讲中提到过吧。这里数组字面值中最大的下标值为 3，go 编译器就认为数组长度是 4.（下标值范围 0~3）</p></div><div><div>2021-12-07</div><div><div><i></i><span>5</span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/20/1e/18/9d1f1439.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>liaomars</span></div></div><div>看了官方标准库的 defer 说明，发现一个 tips 是：可以跟踪函数的执行过程</div><div><p>作者回复：可以的。在后面的一个实战项目中，我们就会应用到这一点。</p></div><div><div>2021-12-06</div><div><div><i></i><span>3</span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/91/28/f2dcbbfe.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 宋世杰</span></div></div><div>Defer 函数被放在一个不同于主函数的函数栈中吗？ 是用 slice 实现的吗？</div><div><p>作者回复：是 go runtime 层实现的。</p></div><div><div>2021-12-06</div><div><div><i></i><span>3</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>lesserror</span></div></div><div>感谢 Tony Bai 老师关于 defer 的深入讲解，不过我想问一下，在 for 中使用 defer 函数，编辑器会提示可能造成资源泄露，能大致说明一下这块儿的知识吗？</div><div><p>作者回复: defer 是在函数退出时调用的。如果在 for 语句的每个迭代都使用 defer 设置 deferred 函数，这些 deferred 函数会压入 runtime 实现的 defer 列表中。会占用内存资源，并且如果 for 的 loop 次数很多，这个消耗将很可观。文中在 for 中使用 defer 仅是为了举例而已。生产代码这块的确要谨慎，通常是没有必要这么做的。</p></div><div><div>2021-12-07</div><div><div><i></i><span>2</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/af/fd/a1708649.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> ゝ骑着小车去兜风。</span></div></div><div>老师你好，没太明白闭包的原理，想不明白为什么输出的是 4，请帮忙解答下</div><div><p>作者回复：循环结束后，i 的值为 4. defer 输出的是 i 的值，于是就都是 4.</p></div><div><div>2022-01-06</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1b/2b/80/2535381c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 莫鸣之名</span></div></div><div>老师，在 “注意 defer 关键字后面表达式的求值时机” 这个知识点，
 func foo3 (){
	 for i :=0; i &lt;=3; i++{
		 defer func (){  
			 fmt.Println (i)

		 }()
	 }
 }
输出结果为啥是 4？ i 最大应该只能取到 3 吧？没看明白，希望老师进一步解答下！</div><div><p>作者回复: i=3 后，循环体执行，然后执行循环后置语句 i++，这样 i 就为 4 了啊。之后 deferred 函数被执行，输出的 i 为 4。</p></div><div><div>2021-12-29</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/bb/e0/c7cd5170.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Bynow</span></div></div><div>我用的 goland ，文中更新后的 bar 代码：我的编辑器终端输出是
call main
call foo
call bar
exit foo
exit main
recover the panic: panic occurs in bar

但是我打断点调试的确是按照老师的那样去执行和输出的，这是怎么回事？</div><div><p>作者回复：你换成直接在命令行执行这个程序呢？</p></div><div><div>2021-12-07</div><div><div><i></i><span>6</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/26/27/eba94899.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 罗杰</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>关于 defer 我还要好好看看，一直都没怎么理解透彻</div><div><p>作者回复：嗯嗯，如有问题，随时交流。</p></div><div><div>2021-12-06</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/LN7qpRLUGO2IHMnbDuF4YEsd9PxdFHAumWsHE8AhibeQUryIfgsQZ3JIZswVcCRkVSaelhFiatCZ6wpQFoLBLVFA/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 宥晓</span></div></div><div>go 的版本 1.18.3, defer 的性能下降了，这是有什么大的变动吗？

go test -bench . defer_test.go

goos: darwin
goarch: amd64
cpu: Intel (R) Core (TM) i5-1038NG7 CPU @ 2.00GHz
BenchmarkFooWithDefer-8         191820978                6.144 ns/op
BenchmarkFooWithoutDefer-8      527924869                2.245 ns/op
PASS
ok      command-line-arguments  3.643s
</div><div><p>作者回复：我在自己机器上用 go 1.18.3 跑了一下：

$go test -bench . defer_test.go
goos: darwin
goarch: amd64
cpu: Intel (R) Core (TM) i5-8257U CPU @ 1.40GHz
BenchmarkFooWithDefer-8      	196703528	         6.086 ns/op
BenchmarkFooWithoutDefer-8   	309812937	         3.840 ns/op
PASS
ok  	command-line-arguments	3.408s

相对于文中的 go 1.17 的结果的确有些差异。但考虑到测试执行的环境并非独占，有很多影响因素，因此，不能断定是 go 1.18.3 带来的性能回退。

从 go 1.18.3 的 milestone 中的 issue list 来看，似乎没有哪个与 defer 有关。

https://github.com/golang/go/issues?q=milestone%3AGo1.18.3+label%3ACherryPickApproved

</p></div><div><div>2022-06-19</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/0a/da/dcf8f2b1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>qiutian</span></div></div><div>我的 vscode 静态检查出：func zoo is unused (U1000) go-staticcheck
但是通过 build 构建和 运行是可以得到和目标相同的结果的</div><div><p>作者回复：严格来说 zoo 是执行不到的，因为 panic 发生在 zoo 前面。不过，这里只是为了演示而故意编写的例子。不用太过计较：)。</p></div><div><div>2022-06-03</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/tVrFvKWxQAuL7DE911OmlcqnfEkBnx14dBmCdI8eOx6ziaQB4Pgml65tcIDO4ePfW5yPTyAxGovYQmXLZHAPe2Q/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>9 月</span></div></div><div>老师您好，对于 defer 参数求值时机有一点疑惑，func foo1 () { for i := 0; i &lt;= 3; i++ { defer fmt.Println (i) }} 这个 i 参数，传入到 fmt.Printlin 中不是应该是 1 开始的吗，然后根据 defer 执行时先进后出原则，应该是 4,3,2,1, 但是我在本地运行的是 3,2,1,0，也就是说 defer 参数传入的时机，还没有执行 i++，这个是什么原因呢？</div><div><p>作者回复：重新温习一下第 19 讲中关于 for 循环语句的执行过程，你就能明白了：)。</p></div><div><div>2022-05-17</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/9c/85/d9614715.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Felix</span></div></div><div>defer benchmark 的例子中，函数 sum 有返回值，所有 defer 的时候放在闭包里面，如果函数 sum 没有返回值，可以直接放在 defer 后面 defer sum ()，我做了一下 benchmark，发现还是放闭包里面比较快，go 语言对闭包有什么优化吗，感觉用闭包会多压一次栈，但是反而更快，老师能解答一下吗？
//defer_test.go
package main

import "testing"

func sum (max int) {
    total := 0
    for i := 0; i &lt; max; i++ {
        total += i
    }
}

func fooWithDeferNoClosure () {
	defer sum (10)
}

func fooWithDefer () {
    defer func () {
        sum (10)
    }()
}
func fooWithoutDefer () {
    sum (10)
}

func BenchmarkFooWithDeferNoClosure (b *testing.B) {
    for i := 0; i &lt; b.N; i++ {
        fooWithDeferNoClosure ()
    }
}

func BenchmarkFooWithDefer (b *testing.B) {
    for i := 0; i &lt; b.N; i++ {
        fooWithDefer ()
    }
}
func BenchmarkFooWithoutDefer (b *testing.B) {
    for i := 0; i &lt; b.N; i++ {
        fooWithoutDefer ()
    }
}

benchmark 结果：
$ go test -bench . defer_test.go
goos: linux
goarch: amd64
cpu: Intel Core Processor (Broadwell, IBRS)
BenchmarkFooWithDeferNoClosure-2   	67386957	        18.59 ns/op
BenchmarkFooWithDefer-2                  	80693001	        15.45 ns/op
BenchmarkFooWithoutDefer-2             	100000000	11.03 ns/op
PASS
ok  	command-line-arguments	3.665s</div><div><p>作者回复: func fooWithDefer () {defer func () {
        sum (10)
    }()
}

这个函数算不上闭包啊。defer 只是注册了一个匿名函数，该函数并没有捕捉 fooWithDefer 函数的本地变量。

我怀疑 func fooWithDefer () {
    defer func () {
        sum (10)
    }()
}
中的 sum (10) 调用被直接内联优化了 (inline)，而不是做函数调用了。

同理 fooWithoutDefer 对 sum 的调用也很大可能被 inline 了。

我在 macos 上关闭 inline 和优化的结果：

$go test -gcflags "-N -l" -v -bench .
goos: darwin
goarch: amd64
pkg: demo
cpu: Intel (R) Core (TM) i5-8257U CPU @ 1.40GHz
BenchmarkFooWithDeferNoClosure
BenchmarkFooWithDeferNoClosure-8   	37973526	        27.60 ns/op
BenchmarkFooWithDefer
BenchmarkFooWithDefer-8            	43756006	        27.57 ns/op
BenchmarkFooWithoutDefer
BenchmarkFooWithoutDefer-8         	71541520	        17.22 ns/op
PASS
ok  	demo	3.576s

两个带 defer 的几乎没区别了。
</p></div><div><div>2022-05-15</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/f3/95/77628ed0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>van</span></div></div><div>panic 作为断言使用，上一层的调用者还是需要自己 recover 回来吧，不然这个调用链会最终传到 main 函数</div><div><p>作者回复：把 panic 当做断言使用的目的是及早发现 bug，一旦断言发生，意味着整个程序出现了不可恢复的状态。对于这类 panic，不要 recover。尽早失败并解决 bug。所以在什么位置进行断言，对哪些条件进行断言是需要考量的。在 C 语言中使用 assert 也是同样的道理。一旦 assert 失败，便会 dump core 文件。程序终止。</p></div><div><div>2022-04-28</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/12/a8/8aaf13e0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>mikewoo</span></div></div><div>老师，这篇文章给了我很多新的理解，收获满满。课程中 “当 foo3 返回后，deferred 函数被调度执行时，上述压入栈的 deferred 函数将以 LIFO 次序出栈执行。匿名函数会以闭包的方式访问外围函数的变量 i，并通过 Println 输出 i 的值，此时 i 的值为 4。” 为什么输出的结果都是 4，这个不是很理解，能否帮忙再解释一下，谢谢。</div><div><p>作者回复：首先确认一下对 for 语义的理解。针对 for i := 0; i &lt;= 3; i++ {} 循环， 当 i=3 时，for 进入循环体，然后执行后置语句 i++，之后 i 的值为 4. 然后再判断循环条件 i&lt;=3，不满足，for 循环结束。于是 i 的最终值就是 4。

defer 执行时，i 是 4，闭包引用的是同一个 i，所以都输出 4。</p></div><div><div>2022-04-27</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/4b/d7/f46c6dfd.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>William Ning</span></div></div><div>大卡，继续学习，思考中～～</div><div><p>作者回复: 💪</p></div><div><div>2022-03-24</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/87/5f/6bf8b74a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Kepler</span></div></div><div>defer 的常用用途：
1. 接口统一上报；
2. 打印耗时，不过这点也可以归到 1 中；</div><div><div>2022-03-20</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/4c/12/f0c145d4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Rayjun</span></div></div><div>老师，咨询一个问题，panic 无法跨 goroutine 捕获，这个是为什么呢？</div><div><p>作者回复：好问题！panic 是一个 stack unwinding 的过程，而每个 goroutine 都有自己的执行栈。一个 goroutine 执行栈上发生的 panic，另外一个 goroutine 肯定是不知晓的。</p></div><div><div>2022-03-14</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".a"><outline class="toc-level-h1" data-reactid=".a.0" style="width: 175px;"><active data-reactid=".a.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".a.0.1"><span data-reactid=".a.0.1.0"> 23｜函数：怎么让函数更简洁健壮？</span></a></outline><outline class="toc-level-h2" data-reactid=".a.1" style="width: 165px;"><active data-reactid=".a.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".a.1.1"><span data-reactid=".a.1.1.0">健壮性的 “三不要” 原则</span></a></outline><outline class="toc-level-h2" data-reactid=".a.2" style="width: 165px;"><active data-reactid=".a.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".a.2.1"><span data-reactid=".a.2.1.0">认识 Go 语言中的异常：panic</span></a></outline><outline class="toc-level-h2" data-reactid=".a.3" style="width: 165px;"><active data-reactid=".a.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".a.3.1"><span data-reactid=".a.3.1.0">如何应对 panic？</span></a></outline><outline class="toc-level-h3" data-reactid=".a.4" style="width: 155px;"><active data-reactid=".a.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".a.4.1"><span data-reactid=".a.4.1.0">第一点：评估程序对 panic 的忍受度</span></a></outline><outline class="toc-level-h3" data-reactid=".a.5" style="width: 155px;"><active data-reactid=".a.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".a.5.1"><span data-reactid=".a.5.1.0">第二点：提示潜在 bug</span></a></outline><outline class="toc-level-h3" data-reactid=".a.6" style="width: 155px;"><active data-reactid=".a.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".a.6.1"><span data-reactid=".a.6.1.0">第三点：不要混淆异常与错误</span></a></outline><outline class="toc-level-h2" data-reactid=".a.7" style="width: 165px;"><active data-reactid=".a.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".a.7.1"><span data-reactid=".a.7.1.0">使用 defer 简化函数实现</span></a></outline><outline class="toc-level-h2" data-reactid=".a.8" style="width: 165px;"><active data-reactid=".a.8.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".a.8.1"><span data-reactid=".a.8.1.0">defer 使用的几个注意事项</span></a></outline><outline class="toc-level-h3" data-reactid=".a.9" style="width: 155px;"><active data-reactid=".a.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".a.9.1"><span data-reactid=".a.9.1.0">第一点：明确哪些函数可以作为 deferred 函数</span></a></outline><outline class="toc-level-h3" data-reactid=".a.a" style="width: 155px;"><active data-reactid=".a.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".a.a.1"><span data-reactid=".a.a.1.0">第二点：注意 defer 关键字后面表达式的求值时机</span></a></outline><outline class="toc-level-h3" data-reactid=".a.b" style="width: 155px;"><active data-reactid=".a.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".a.b.1"><span data-reactid=".a.b.1.0">第三点：知晓 defer 带来的性能损耗</span></a></outline><outline class="toc-level-h2" data-reactid=".a.c" style="width: 165px;"><active data-reactid=".a.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".a.c.1"><span data-reactid=".a.c.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".a.d" style="width: 165px;"><active data-reactid=".a.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".a.d.1"><span data-reactid=".a.d.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".a.e" style="width: 165px;"><active data-reactid=".a.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".a.e.1"><span data-reactid=".a.e.1.0">精选留言 (25)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/464273" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>