
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 11 | “万金油” 的 String，为什么不好用了？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>11 | “万金油” 的 String，为什么不好用了？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">11 | “万金油” 的 String，为什么不好用了？</h1><div><span>蒋德钧</span> <span> 2020-08-31</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/bc/19/bc59bcd53d01013fe4eb3e793c5ee119.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：蒋德钧</span><span>大小：14.97M</span><span> 时长：16:21</span></div></div><audio title="11 | “万金油”的String，为什么不好用了？" src="https://res001.geekbang.org/media/audio/9a/3b/9a7e6698a3d102e66ac5fd92f3f4b33b/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="1989" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="1990"><span data-slate-object="text" data-key="1991"><span data-slate-leaf="true" data-offset-key="1991:0" data-first-offset="true"><span data-slate-string="true">你好，我是蒋德钧。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1992"><span data-slate-object="text" data-key="1993"><span data-slate-leaf="true" data-offset-key="1993:0" data-first-offset="true"><span data-slate-string="true">从今天开始，我们就要进入 “实践篇” 了。接下来，我们会用 5 节课的时间学习 “数据结构”。我会介绍节省内存开销以及保存和统计海量数据的数据类型及其底层数据结构，还会围绕典型的应用场景（例如地址位置查询、时间序列数据库读写和消息队列存取），</span></span><span data-slate-leaf="true" data-offset-key="1993:1"><span data-slate-object="annotation" data-annotation-key="gkann_a8dbb714" data-attr-id="41802" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">跟你分享使用 Redis 的数据类型和 module 扩展功能来满足需求的具体方案。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1994"><span data-slate-object="text" data-key="1995"><span data-slate-leaf="true" data-offset-key="1995:0" data-first-offset="true"><span data-slate-string="true">今天，我们先了解下 String 类型的内存空间消耗问题，以及选择节省内存开销的数据类型的解决方案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1996"><span data-slate-object="text" data-key="1997"><span data-slate-leaf="true" data-offset-key="1997:0" data-first-offset="true"><span data-slate-string="true">先跟你分享一个我曾经遇到的需求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1998"><span data-slate-object="text" data-key="1999"><span data-slate-leaf="true" data-offset-key="1999:0" data-first-offset="true"><span data-slate-string="true">当时，我们要开发一个图片存储系统，要求这个系统能快速地记录图片 ID 和图片在存储系统中保存时的 ID（可以直接叫作图片存储对象 ID）。同时，还要能够根据图片 ID 快速查找到图片存储对象 ID。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2000"><span data-slate-object="text" data-key="2001"><span data-slate-leaf="true" data-offset-key="2001:0" data-first-offset="true"><span data-slate-string="true">因为图片数量巨大，所以我们就用 10 位数来表示图片 ID 和图片存储对象 ID，例如，图片 ID 为 1101000051，它在存储系统中对应的 ID 号是 3301000051。</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="2002"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2003"><span data-slate-object="text" data-key="2004"><span data-slate-leaf="true" data-offset-key="2004:0" data-first-offset="true"><span data-slate-string="true">photo_id: 1101000051</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2005"><span data-slate-object="text" data-key="2006"><span data-slate-leaf="true" data-offset-key="2006:0" data-first-offset="true"><span data-slate-string="true">photo_obj_id: 3301000051</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2007"><span data-slate-object="text" data-key="2008"><span data-slate-leaf="true" data-offset-key="2008:0" data-first-offset="true"><span data-slate-string="true">可以看到，图片 ID 和图片存储对象 ID 正好一一对应，是典型的 “键 - 单值” 模式。所谓的 “单值”，就是指键值对中的值就是一个值，而不是一个集合，</span></span><span data-slate-leaf="true" data-offset-key="2008:1"><span data-slate-object="annotation" data-annotation-key="gkann_38833c19" data-attr-id="14920" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">这和 String 类型提供的 “一个键对应一个值的数据” 的保存形式刚好契合。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2009"><span data-slate-object="text" data-key="2010"><span data-slate-leaf="true" data-offset-key="2010:0" data-first-offset="true"><span data-slate-string="true">而且，String 类型可以保存二进制字节流，就像 “万金油” 一样，</span></span><span data-slate-leaf="true" data-offset-key="2010:1"><span data-slate-object="annotation" data-annotation-key="gkann_1da3011e" data-attr-id="28793" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">只要把数据转成二进制字节数组，就可以保存了。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2011"><span data-slate-object="text" data-key="2012"><span data-slate-leaf="true" data-offset-key="2012:0" data-first-offset="true"><span data-slate-string="true">所以，我们的第一个方案就是用 String 保存数据。我们把图片 ID 和图片存储对象 ID 分别作为键值对的 key 和 value 来保存，其中，图片存储对象 ID 用了 String 类型。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2013"><span data-slate-object="text" data-key="2014"><span data-slate-leaf="true" data-offset-key="2014:0" data-first-offset="true"><span data-slate-string="true">刚开始，</span></span><span data-slate-leaf="true" data-offset-key="2014:1"><span data-slate-object="annotation" data-annotation-key="gkann_8d9ab5fe" data-attr-id="41339" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们保存了 1 亿张图片，大约用了 6.4GB 的内存。但是，随着图片数据量的不断增加，我们的 Redis 内存使用量也在增加，结果就遇到了大内存 Redis 实例因为生成 RDB 而响应变慢的问题。</span></span></span><span data-slate-leaf="true" data-offset-key="2014:2"><span data-slate-string="true">很显然，String 类型并不是一种好的选择，我们还需要进一步寻找能节省内存开销的数据类型方案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2015"><span data-slate-object="text" data-key="2016"><span data-slate-leaf="true" data-offset-key="2016:0" data-first-offset="true"><span data-slate-string="true">在这个过程中，我深入地研究了 String 类型的底层结构，找到了它内存开销大的原因，对 “万金油” 的 String 类型有了全新的认知：String 类型并不是适用于所有场合的，它有一个明显的短板，</span></span><span data-slate-leaf="true" data-offset-key="2016:1"><span data-slate-object="annotation" data-annotation-key="gkann_5b00aadb" data-attr-id="2065" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">就是它保存数据时所消耗的内存空间较多。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2017"><span data-slate-object="text" data-key="2018"><span data-slate-leaf="true" data-offset-key="2018:0" data-first-offset="true"><span data-slate-string="true">同时，我还仔细研究了集合类型的数据结构。我发现，</span></span><span data-slate-leaf="true" data-offset-key="2018:1"><span data-slate-object="annotation" data-annotation-key="gkann_17de5747" data-attr-id="28684" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">集合类型有非常节省内存空间的底层实现结构，但是，集合类型保存的数据模式，是一个键对应一系列值，并不适合直接保存单值的键值对。所以，我们就使用二级编码的方法，实现了用集合类型保存单值键值对，Redis 实例的内存空间消耗明显下降了。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2019"><span data-slate-object="text" data-key="2020"><span data-slate-leaf="true" data-offset-key="2020:0" data-first-offset="true"><span data-slate-string="true">这节课，我就把在解决这个问题时学到的经验和方法分享给你，包括 String 类型的内存空间消耗在哪儿了、用什么数据结构可以节省内存，以及如何用集合类型保存单值键值对。如果你在使用 String 类型时也遇到了内存空间消耗较多的问题，就可以尝试下今天的解决方案了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2021"><span data-slate-object="text" data-key="2022"><span data-slate-leaf="true" data-offset-key="2022:0" data-first-offset="true"><span data-slate-string="true">接下来，我们先来看看 String 类型的内存都消耗在哪里了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2023" id="sr-toc-1"><span data-slate-object="text" data-key="2024"><span data-slate-leaf="true" data-offset-key="2024:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a2317e54" data-attr-id="30349" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">为什么 String 类型内存开销大？</span></span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2025"><span data-slate-object="text" data-key="2026"><span data-slate-leaf="true" data-offset-key="2026:0" data-first-offset="true"><span data-slate-string="true">在刚才的案例中，我们保存了 1 亿张图片的信息，用了约 6.4GB 的内存，</span></span><span data-slate-leaf="true" data-offset-key="2026:1"><span data-slate-object="annotation" data-annotation-key="gkann_785440e4" data-attr-id="39567" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一个图片 ID 和图片存储对象 ID 的记录平均用了 64 字节。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2027"><span data-slate-object="text" data-key="2028"><span data-slate-leaf="true" data-offset-key="2028:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_87cc74df" data-attr-id="39141" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">但问题是，一组图片 ID 及其存储对象 ID 的记录，实际只需要 16 字节就可以了。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2029"><span data-slate-object="text" data-key="2030"><span data-slate-leaf="true" data-offset-key="2030:0" data-first-offset="true"><span data-slate-string="true">我们来分析一下。图片 ID 和图片存储对象 ID 都是 10 位数，我们可以用两个 8 字节的 Long 类型表示这两个 ID。</span></span><span data-slate-leaf="true" data-offset-key="2030:1"><span data-slate-object="annotation" data-annotation-key="gkann_c29de9dd" data-attr-id="20790" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">因为 8 字节的 Long 类型最大可以表示 2 的 64 次方的数值，</span></span></span><span data-slate-leaf="true" data-offset-key="2030:2"><span data-slate-string="true">所以肯定可以表示 10 位数。但是，为什么 String 类型却用了 64 字节呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2031"><span data-slate-object="text" data-key="2032"><span data-slate-leaf="true" data-offset-key="2032:0" data-first-offset="true"><span data-slate-string="true">其实，除了记录实际数据，</span></span><span data-slate-leaf="true" data-offset-key="2032:1"><span data-slate-object="annotation" data-annotation-key="gkann_3a2f1631" data-attr-id="3047" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">String 类型还需要额外的内存空间记录数据长度、空间使用等信息，这些信息也叫作元数据。</span></span></span><span data-slate-leaf="true" data-offset-key="2032:2"><span data-slate-string="true">当实际保存的数据较小时，元数据的空间开销就显得比较大了，有点 “喧宾夺主” 的意思。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2033"><span data-slate-object="text" data-key="2034"><span data-slate-leaf="true" data-offset-key="2034:0" data-first-offset="true"><span data-slate-string="true">那么，</span></span><span data-slate-leaf="true" data-offset-key="2034:1"><span data-slate-object="annotation" data-annotation-key="gkann_8d73074c" data-attr-id="40386" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">String 类型具体是怎么保存数据的呢？我来解释一下。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2035"><span data-slate-object="text" data-key="2036"><span data-slate-leaf="true" data-offset-key="2036:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_297ba270" data-attr-id="20791" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">当你保存 64 位有符号整数时，String 类型会把它保存为一个 8 字节的 Long 类型整数，这种保存方式通常也叫作 int 编码方式。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2037"><span data-slate-object="text" data-key="2038"><span data-slate-leaf="true" data-offset-key="2038:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_2e828225" data-attr-id="14750" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">但是，当你保存的数据中包含字符时，String 类型就会用简单动态字符串（Simple Dynamic String，SDS）结构体来保存，</span></span></span><span data-slate-leaf="true" data-offset-key="2038:1"><span data-slate-string="true">如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2039"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/37/57/37c6a8d5abd65906368e7c4a6b938657.jpg?wh=1926*1400"></div></div><div data-slate-type="list" data-slate-object="block" data-key="2040"><div data-slate-type="list-line" data-slate-object="block" data-key="2041"><span data-slate-object="text" data-key="2042"><span data-slate-leaf="true" data-offset-key="2042:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">buf</span></span></span></span><span data-slate-object="text" data-key="2043"><span data-slate-leaf="true" data-offset-key="2043:0" data-first-offset="true"><span data-slate-string="true">：字节数组，保存实际数据。为了表示字节数组的结束，</span></span><span data-slate-leaf="true" data-offset-key="2043:1"><span data-slate-object="annotation" data-annotation-key="gkann_5ae53beb" data-attr-id="7556" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Redis 会自动在数组最后加一个 “\0”，这就会额外占用 1 个字节的开销。</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2044"><span data-slate-object="text" data-key="2045"><span data-slate-leaf="true" data-offset-key="2045:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_8df2408a" data-attr-id="30705" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span></span><span data-slate-object="text" data-key="2046"><span data-slate-leaf="true" data-offset-key="2046:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_8df2408a" data-attr-id="30705" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">：占 4 个字节，表示 buf 的已用长度。</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2047"><span data-slate-object="text" data-key="2048"><span data-slate-leaf="true" data-offset-key="2048:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_9e3ed9af" data-attr-id="30706" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">alloc</span></span></span></span></span><span data-slate-object="text" data-key="2049"><span data-slate-leaf="true" data-offset-key="2049:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_9e3ed9af" data-attr-id="30706" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">：也占个 4 字节，表示 buf 的实际分配长度，一般大于 len。</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2050"><span data-slate-object="text" data-key="2051"><span data-slate-leaf="true" data-offset-key="2051:0" data-first-offset="true"><span data-slate-string="true">可以看到，在 SDS 中，buf 保存实际数据，</span></span><span data-slate-leaf="true" data-offset-key="2051:1"><span data-slate-object="annotation" data-annotation-key="gkann_32611ca9" data-attr-id="7557" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">而 len 和 alloc 本身其实是 SDS 结构体的额外开销。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2052"><span data-slate-object="text" data-key="2053"><span data-slate-leaf="true" data-offset-key="2053:0" data-first-offset="true"><span data-slate-string="true">另外，对于 String 类型来说，</span></span><span data-slate-leaf="true" data-offset-key="2053:1"><span data-slate-object="annotation" data-annotation-key="gkann_716aa60d" data-attr-id="7566" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">除了 SDS 的额外开销，还有一个来自于 RedisObject 结构体的开销。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2054"><span data-slate-object="text" data-key="2055"><span data-slate-leaf="true" data-offset-key="2055:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a17c7d89" data-attr-id="11515" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">因为 Redis 的数据类型有很多，而且，不同数据类型都有些相同的元数据要记录（比如最后一次访问的时间、被引用的次数等），所以，Redis 会用一个 RedisObject 结构体来统一记录这些元数据，同时指向实际数据。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2056"><span data-slate-object="text" data-key="2057"><span data-slate-leaf="true" data-offset-key="2057:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_73fd673d" data-attr-id="21431" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一个 RedisObject 包含了 8 字节的元数据和一个 8 字节指针，这个指针再进一步指向具体数据类型的实际数据所在，</span></span></span><span data-slate-leaf="true" data-offset-key="2057:1"><span data-slate-string="true">例如指向 String 类型的 SDS 结构所在的内存地址，可以看一下下面的示意图。关于 RedisObject 的具体结构细节，我会在后面的课程中详细介绍，现在你只要了解它的基本结构和元数据开销就行了。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2058"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/34/57/3409948e9d3e8aa5cd7cafb9b66c2857.jpg?wh=2214*1656"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2059"><span data-slate-object="text" data-key="2060"><span data-slate-leaf="true" data-offset-key="2060:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_9428269f" data-attr-id="16017" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">为了节省内存空间，Redis 还对 Long 类型整数和 SDS 的内存布局做了专门的设计。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2061"><span data-slate-object="text" data-key="2062"><span data-slate-leaf="true" data-offset-key="2062:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_e99f0e12" data-attr-id="2086" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一方面，当保存的是 Long 类型整数时，RedisObject 中的指针就直接赋值为整数数据了，这样就不用额外的指针再指向整数了，节省了指针的空间开销。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2063"><span data-slate-object="text" data-key="2064"><span data-slate-leaf="true" data-offset-key="2064:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_787e15a6" data-attr-id="1947" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">另一方面，当保存的是字符串数据，并且字符串小于等于 44 字节时，RedisObject 中的元数据、指针和 SDS 是一块连续的内存区域，这样就可以避免内存碎片。</span></span></span><span data-slate-leaf="true" data-offset-key="2064:1"><span data-slate-string="true">这种布局方式也被称为 embstr 编码方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2065"><span data-slate-object="text" data-key="2066"><span data-slate-leaf="true" data-offset-key="2066:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_cbe30ee0" data-attr-id="1948" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">当然，当字符串大于 44 字节时，SDS 的数据量就开始变多了，Redis 就不再把 SDS 和 RedisObject 布局在一起了，而是会给 SDS 分配独立的空间，并用指针指向 SDS 结构。</span></span></span><span data-slate-leaf="true" data-offset-key="2066:1"><span data-slate-string="true">这种布局方式被称为 raw 编码模式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2067"><span data-slate-object="text" data-key="2068"><span data-slate-leaf="true" data-offset-key="2068:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_42d6dbdb" data-attr-id="37280" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">为了帮助你理解 int、embstr 和 raw 这三种编码模式，</span></span></span><span data-slate-leaf="true" data-offset-key="2068:1"><span data-slate-string="true">我画了一张示意图，如下所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2069"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/ce/e3/ce83d1346c9642fdbbf5ffbe701bfbe3.jpg?wh=3072*1938"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2070"><span data-slate-object="text" data-key="2071"><span data-slate-leaf="true" data-offset-key="2071:0" data-first-offset="true"><span data-slate-string="true">好了，知道了 RedisObject 所包含的额外元数据开销，现在，我们就可以计算 String 类型的内存使用量了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2072"><span data-slate-object="text" data-key="2073"><span data-slate-leaf="true" data-offset-key="2073:0" data-first-offset="true"><span data-slate-string="true">因为 10 位数的图片 ID 和图片存储对象 ID 是 Long 类型整数，所以可以直接用 int 编码的 RedisObject 保存。每个 int 编码的 RedisObject 元数据部分占 8 字节，指针部分被直接赋值为 8 字节的整数了。</span></span><span data-slate-leaf="true" data-offset-key="2073:1"><span data-slate-object="annotation" data-annotation-key="gkann_ae30646f" data-attr-id="4587" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">此时，每个 ID 会使用 16 字节，加起来一共是 32 字节。</span></span></span><span data-slate-leaf="true" data-offset-key="2073:2"><span data-slate-string="true">但是，另外的 32 字节去哪儿了呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2074"><span data-slate-object="text" data-key="2075"><span data-slate-leaf="true" data-offset-key="2075:0" data-first-offset="true"><span data-slate-string="true">我在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="2076"><span data-slate-object="text" data-key="2077"><span data-slate-leaf="true" data-offset-key="2077:0" data-first-offset="true"><span data-slate-string="true">第 2 讲</span></span></span></a><span data-slate-object="text" data-key="2078"><span data-slate-leaf="true" data-offset-key="2078:0" data-first-offset="true"><span data-slate-string="true">中说过，Redis 会使用一个全局哈希表保存所有键值对，哈希表的每一项是一个 dictEntry 的结构体，用来指向一个键值对。dictEntry 结构中有三个 8 字节的指针，</span></span><span data-slate-leaf="true" data-offset-key="2078:1"><span data-slate-object="annotation" data-annotation-key="gkann_6f7d1b82" data-attr-id="4753" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">分别指向 key、value 以及下一个 dictEntry，</span></span></span><span data-slate-leaf="true" data-offset-key="2078:2"><span data-slate-string="true">三个指针共 24 字节，如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2079"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/b6/e7/b6cbc5161388fdf4c9b49f3802ef53e7.jpg?wh=2219*1371"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2080"><span data-slate-object="text" data-key="2081"><span data-slate-leaf="true" data-offset-key="2081:0" data-first-offset="true"><span data-slate-string="true">但是，这三个指针只有 24 字节，为什么会占用了 32 字节呢？这就要提到 Redis 使用的内存分配库 jemalloc 了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2082"><span data-slate-object="text" data-key="2083"><span data-slate-leaf="true" data-offset-key="2083:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_79b83717" data-attr-id="3028" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">jemalloc 在分配内存时，会根据我们申请的字节数 N，找一个比 N 大，但是最接近 N 的 2 的幂次数作为分配的空间，这样可以减少频繁分配的次数。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2084"><span data-slate-object="text" data-key="2085"><span data-slate-leaf="true" data-offset-key="2085:0" data-first-offset="true"><span data-slate-string="true">举个例子。如果你申请 6 字节空间，jemalloc 实际会分配 8 字节空间；如果你申请 24 字节空间，</span></span><span data-slate-leaf="true" data-offset-key="2085:1"><span data-slate-object="annotation" data-annotation-key="gkann_1fd3efc4" data-attr-id="28417" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">jemalloc 则会分配 32 字节。</span></span></span><span data-slate-leaf="true" data-offset-key="2085:2"><span data-slate-object="annotation" data-annotation-key="gkann_90a86315" data-attr-id="40193" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">所以，在我们刚刚说的场景里，dictEntry 结构就占用了 32 字节。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2086"><span data-slate-object="text" data-key="2087"><span data-slate-leaf="true" data-offset-key="2087:0" data-first-offset="true"><span data-slate-string="true">好了，到这儿，你应该就能理解，</span></span><span data-slate-leaf="true" data-offset-key="2087:1"><span data-slate-object="annotation" data-annotation-key="gkann_781c6afc" data-attr-id="13464" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_ce30d739" data-attr-id="41638" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">为什么用 String 类型保存图片 ID 和图片存储对象 ID 时需要用 64 个字节了。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2088"><span data-slate-object="text" data-key="2089"><span data-slate-leaf="true" data-offset-key="2089:0" data-first-offset="true"><span data-slate-string="true">你看，明明有效信息只有 16 字节，使用 String 类型保存时，却需要 64 字节的内存空间，有 48 字节都没有用于保存实际的数据。我们来换算下，如果要保存的图片有 1 亿张，那么 1 亿条的图片 ID 记录就需要 6.4GB 内存空间，</span></span><span data-slate-leaf="true" data-offset-key="2089:1"><span data-slate-object="annotation" data-annotation-key="gkann_cbd92864" data-attr-id="30980" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_c8a71837" data-attr-id="3430" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">其中有 4.8GB 的内存空间都用来保存元数据了，额外的内存空间开销很大。</span></span></span></span><span data-slate-leaf="true" data-offset-key="2089:2"><span data-slate-string="true">那么，有没有更加节省内存的方法呢？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2090" id="sr-toc-2"><span data-slate-object="text" data-key="2091"><span data-slate-leaf="true" data-offset-key="2091:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f2df6d7e" data-attr-id="30355" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">用什么数据结构可以节省内存？</span></span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2092"><span data-slate-object="text" data-key="2093"><span data-slate-leaf="true" data-offset-key="2093:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_616bc9b9" data-attr-id="28537" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Redis 有一种底层数据结构，叫压缩列表（ziplist），这是一种非常节省内存的结构。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2094"><span data-slate-object="text" data-key="2095"><span data-slate-leaf="true" data-offset-key="2095:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_2fe98a4c" data-attr-id="7568" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们先回顾下压缩列表的构成。表头有三个字段 zlbytes、zltail 和 zllen，分别表示列表长度、列表尾的偏移量，以及列表中的 entry 个数。压缩列表尾还有一个 zlend，表示列表结束。</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2096"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f6/9f/f6d4df5f7d6e80de29e2c6446b02429f.jpg?wh=3457*972"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2097"><span data-slate-object="text" data-key="2098"><span data-slate-leaf="true" data-offset-key="2098:0" data-first-offset="true"><span data-slate-string="true">压缩列表之所以能节省内存，</span></span><span data-slate-leaf="true" data-offset-key="2098:1"><span data-slate-object="annotation" data-annotation-key="gkann_ab8f5b64" data-attr-id="2052" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">就在于它是用一系列连续的 entry 保存数据。</span></span></span><span data-slate-leaf="true" data-offset-key="2098:2"><span data-slate-string="true">每个 entry 的元数据包括下面几部分。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2099"><div data-slate-type="list-line" data-slate-object="block" data-key="2100"><span data-slate-object="text" data-key="2101"><span data-slate-leaf="true" data-offset-key="2101:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_cb6232e3" data-attr-id="29822" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">prev_len</span></span></span></span></span><span data-slate-object="text" data-key="2102"><span data-slate-leaf="true" data-offset-key="2102:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_cb6232e3" data-attr-id="29822" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">，表示前一个 entry 的长度。prev_len 有两种取值情况：1 字节或 5 字节。取值 1 字节时，表示上一个 entry 的长度小于 254 字节。虽然 1 字节的值能表示的数值范围是 0 到 255，但是压缩列表中 zlend 的取值默认是 255，因此，就默认用 255 表示整个压缩列表的结束，其他表示长度的地方就不能再用 255 这个值了。所以，当上一个 entry 长度小于 254 字节时，prev_len 取值为 1 字节，否则，就取值为 5 字节。</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2103"><span data-slate-object="text" data-key="2104"><span data-slate-leaf="true" data-offset-key="2104:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6cf292bc" data-attr-id="27662" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span></span><span data-slate-object="text" data-key="2105"><span data-slate-leaf="true" data-offset-key="2105:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6cf292bc" data-attr-id="27662" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">：表示自身长度，4 字节；</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2106"><span data-slate-object="text" data-key="2107"><span data-slate-leaf="true" data-offset-key="2107:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6750bdec" data-attr-id="27663" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">encoding</span></span></span></span></span><span data-slate-object="text" data-key="2108"><span data-slate-leaf="true" data-offset-key="2108:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6750bdec" data-attr-id="27663" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">：表示编码方式，1 字节；</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2109"><span data-slate-object="text" data-key="2110"><span data-slate-leaf="true" data-offset-key="2110:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_c229671f" data-attr-id="27664" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">content</span></span></span></span></span><span data-slate-object="text" data-key="2111"><span data-slate-leaf="true" data-offset-key="2111:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_c229671f" data-attr-id="27664" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">：保存实际数据。</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2112"><span data-slate-object="text" data-key="2113"><span data-slate-leaf="true" data-offset-key="2113:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_253cf8db" data-attr-id="23688" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">这些 entry 会挨个儿放置在内存中，不需要再用额外的指针进行连接，这样就可以节省指针所占用的空间。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2114"><span data-slate-object="text" data-key="2115"><span data-slate-leaf="true" data-offset-key="2115:0" data-first-offset="true"><span data-slate-string="true">我们以保存图片存储对象 ID 为例，来分析一下压缩列表是如何节省内存空间的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2116"><span data-slate-object="text" data-key="2117"><span data-slate-leaf="true" data-offset-key="2117:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6f7e826a" data-attr-id="28719" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">每个 entry 保存一个图片存储对象 ID（8 字节），此时，每个 entry 的 prev_len 只需要 1 个字节就行，因为每个 entry 的前一个 entry 长度都只有 8 字节，小于 254 字节。这样一来，一个图片的存储对象 ID 所占用的内存大小是 14 字节（1+4+1+8=14），实际分配 16 字节。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2118"><span data-slate-object="text" data-key="2119"><span data-slate-leaf="true" data-offset-key="2119:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_477bbbb0" data-attr-id="11142" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Redis 基于压缩列表实现了 List、Hash 和 Sorted Set 这样的集合类型，这样做的最大好处就是节省了 dictEntry 的开销。当你用 String 类型时，一个键值对就有一个 dictEntry，要用 32 字节空间。但采用集合类型时，一个 key 就对应一个集合的数据，能保存的数据多了很多，但也只用了一个 dictEntry，</span></span></span><span data-slate-leaf="true" data-offset-key="2119:1"><span data-slate-string="true">这样就节省了内存。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2120"><span data-slate-object="text" data-key="2121"><span data-slate-leaf="true" data-offset-key="2121:0" data-first-offset="true"><span data-slate-string="true">这个方案听起来很好，但还存在一个问题：在用集合类型保存键值对时，一个键对应了一个集合的数据，但是在我们的场景中，一个图片 ID 只对应一个图片的存储对象 ID，我们该怎么用集合类型呢？换句话说，在一个键对应一个值（也就是单值键值对）的情况下，我们该怎么用集合类型来保存这种单值键值对呢？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2122" id="sr-toc-3"><span data-slate-object="text" data-key="2123"><span data-slate-leaf="true" data-offset-key="2123:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_42fceac2" data-attr-id="30356" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如何用集合类型保存单值的键值对？</span></span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2124"><span data-slate-object="text" data-key="2125"><span data-slate-leaf="true" data-offset-key="2125:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_c987619e" data-attr-id="9902" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在保存单值的键值对时，可以采用基于 Hash 类型的二级编码方法。</span></span></span><span data-slate-leaf="true" data-offset-key="2125:1"><span data-slate-string="true">这里说的二级编码，就是把一个单值的数据拆分成两部分，前一部分作为 Hash 集合的 key，后一部分作为 Hash 集合的 value，这样一来，我们就可以把单值数据保存到 Hash 集合中了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2126"><span data-slate-object="text" data-key="2127"><span data-slate-leaf="true" data-offset-key="2127:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6ebed652" data-attr-id="22076" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">以图片 ID 1101000060 和图片存储对象 ID 3302000080 为例，我们可以把图片 ID 的前 7 位（1101000）作为 Hash 类型的键，把图片 ID 的最后 3 位（060）和图片存储对象 ID 分别作为 Hash 类型值中的 key 和 value。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2128"><span data-slate-object="text" data-key="2129"><span data-slate-leaf="true" data-offset-key="2129:0" data-first-offset="true"><span data-slate-string="true">按照这种设计方法，我在 Redis 中插入了一组图片 ID 及其存储对象 ID 的记录，并且用 info 命令查看了内存开销，我发现，增加一条记录后，</span></span><span data-slate-leaf="true" data-offset-key="2129:1"><span data-slate-object="annotation" data-annotation-key="gkann_2b56c199" data-attr-id="13505" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">内存占用只增加了 16 字节，</span></span></span><span data-slate-leaf="true" data-offset-key="2129:2"><span data-slate-string="true">如下所示：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="2130"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2131"><span data-slate-object="text" data-key="2132"><span data-slate-leaf="true" data-offset-key="2132:0" data-first-offset="true"><span data-slate-string="true">127.0.0.1:6379&gt; info memory</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2133"><span data-slate-object="text" data-key="2134"><span data-slate-leaf="true" data-offset-key="2134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># Memory</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2135"><span data-slate-object="text" data-key="2136"><span data-slate-leaf="true" data-offset-key="2136:0" data-first-offset="true"><span data-slate-string="true">used_memory:1039120</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2137"><span data-slate-object="text" data-key="2138"><span data-slate-leaf="true" data-offset-key="2138:0" data-first-offset="true"><span data-slate-string="true">127.0.0.1:6379&gt; hset 1101000 060 3302000080</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2139"><span data-slate-object="text" data-key="2140"><span data-slate-leaf="true" data-offset-key="2140:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="2141"><span data-slate-leaf="true" data-offset-key="2141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">integer</span></span></span></span><span data-slate-object="text" data-key="2142"><span data-slate-leaf="true" data-offset-key="2142:0" data-first-offset="true"><span data-slate-string="true">) 1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2143"><span data-slate-object="text" data-key="2144"><span data-slate-leaf="true" data-offset-key="2144:0" data-first-offset="true"><span data-slate-string="true">127.0.0.1:6379&gt; info memory</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2145"><span data-slate-object="text" data-key="2146"><span data-slate-leaf="true" data-offset-key="2146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># Memory</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2147"><span data-slate-object="text" data-key="2148"><span data-slate-leaf="true" data-offset-key="2148:0" data-first-offset="true"><span data-slate-string="true">used_memory:1039136</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2149"><span data-slate-object="text" data-key="2150"><span data-slate-leaf="true" data-offset-key="2150:0" data-first-offset="true"><span data-slate-string="true">在使用 String 类型时，每个记录需要消耗 64 字节，</span></span><span data-slate-leaf="true" data-offset-key="2150:1"><span data-slate-object="annotation" data-annotation-key="gkann_9841c62c" data-attr-id="44039" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">这种方式却只用了 16 字节，</span></span></span><span data-slate-leaf="true" data-offset-key="2150:2"><span data-slate-string="true">所使用的内存空间是原来的 1/4，满足了我们节省内存空间的需求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2151"><span data-slate-object="text" data-key="2152"><span data-slate-leaf="true" data-offset-key="2152:0" data-first-offset="true"><span data-slate-string="true">不过，你可能也会有疑惑：“二级编码一定要把图片 ID 的前 7 位作为 Hash 类型的键，把最后 3 位作为 Hash 类型值中的 key 吗？”</span></span></span><span data-slate-object="text" data-key="2153"><span data-slate-leaf="true" data-offset-key="2153:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 其实，</span></span></span><span data-slate-leaf="true" data-offset-key="2153:1"><span data-slate-object="annotation" data-annotation-key="gkann_f528751d" data-attr-id="33125" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">二级编码方法中采用的 ID 长度是有讲究的</span></span></span></span></span><span data-slate-object="text" data-key="2154"><span data-slate-leaf="true" data-offset-key="2154:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f528751d" data-attr-id="33125" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2155"><span data-slate-object="text" data-key="2156"><span data-slate-leaf="true" data-offset-key="2156:0" data-first-offset="true"><span data-slate-string="true">在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="2157"><span data-slate-object="text" data-key="2158"><span data-slate-leaf="true" data-offset-key="2158:0" data-first-offset="true"><span data-slate-string="true">第 2 讲</span></span></span></a><span data-slate-object="text" data-key="2159"><span data-slate-leaf="true" data-offset-key="2159:0" data-first-offset="true"><span data-slate-string="true">中，我介绍过 Redis Hash 类型的两种底层实现结构，分别是压缩列表和哈希表。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2160"><span data-slate-object="text" data-key="2161"><span data-slate-leaf="true" data-offset-key="2161:0" data-first-offset="true"><span data-slate-string="true">那么，Hash 类型底层结构什么时候使用压缩列表，</span></span><span data-slate-leaf="true" data-offset-key="2161:1"><span data-slate-object="annotation" data-annotation-key="gkann_363d4672" data-attr-id="17756" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">什么时候使用哈希表呢？其实，Hash 类型设置了用压缩列表保存数据时的两个阈值，一旦超过了阈值，Hash 类型就会用哈希表来保存数据了。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2162"><span data-slate-object="text" data-key="2163"><span data-slate-leaf="true" data-offset-key="2163:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_3dea4194" data-attr-id="9903" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">这两个阈值分别对应以下两个配置项：</span></span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2164"><div data-slate-type="list-line" data-slate-object="block" data-key="2165"><span data-slate-object="text" data-key="2166"><span data-slate-leaf="true" data-offset-key="2166:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_59d73b8f" data-attr-id="7293" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">hash-max-ziplist-entries：表示用压缩列表保存时哈希集合中的最大元素个数。</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2167"><span data-slate-object="text" data-key="2168"><span data-slate-leaf="true" data-offset-key="2168:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_234e8f2d" data-attr-id="9904" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">hash-max-ziplist-value：表示用压缩列表保存时哈希集合中单个元素的最大长度。</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2169"><span data-slate-object="text" data-key="2170"><span data-slate-leaf="true" data-offset-key="2170:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_755fe28a" data-attr-id="34229" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果我们往 Hash 集合中写入的元素个数超过了 hash-max-ziplist-entries，或者写入的单个元素大小超过了 hash-max-ziplist-value，Redis 就会自动把 Hash 类型的实现结构由压缩列表转为哈希表。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2171"><span data-slate-object="text" data-key="2172"><span data-slate-leaf="true" data-offset-key="2172:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1b5f71e5" data-attr-id="33820" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一旦从压缩列表转为了哈希表，Hash 类型就会一直用哈希表进行保存，而不会再转回压缩列表了。</span></span></span><span data-slate-leaf="true" data-offset-key="2172:1"><span data-slate-string="true">在节省内存空间方面，哈希表就没有压缩列表那么高效了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2173"><span data-slate-object="text" data-key="2174"><span data-slate-leaf="true" data-offset-key="2174:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_9eff3f2c" data-attr-id="16112" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">为了能充分使用压缩列表的精简内存布局，我们一般要控制保存在 Hash 集合中的元素个数</span></span></span></span></span><span data-slate-object="text" data-key="2175"><span data-slate-leaf="true" data-offset-key="2175:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_9eff3f2c" data-attr-id="16112" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。所以，在刚才的二级编码中，我们只用图片 ID 最后 3 位作为 Hash 集合的 key，也就保证了 Hash 集合的元素个数不超过 1000，同时，我们把 hash-max-ziplist-entries 设置为 1000，这样一来，Hash 集合就可以一直使用压缩列表来节省内存空间了。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2176" id="sr-toc-4"><span data-slate-object="text" data-key="2177"><span data-slate-leaf="true" data-offset-key="2177:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2178"><span data-slate-object="text" data-key="2179"><span data-slate-leaf="true" data-offset-key="2179:0" data-first-offset="true"><span data-slate-string="true">这节课，我们打破了对 String 的认知误区，</span></span><span data-slate-leaf="true" data-offset-key="2179:1"><span data-slate-object="annotation" data-annotation-key="gkann_c71c60c2" data-attr-id="24437" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">以前，我们认为 String 是 “万金油”，什么场合都适用，但是，在保存的键值对本身占用的内存空间不大时（例如这节课里提到的的图片 ID 和图片存储对象 ID），String 类型的元数据开销就占据主导了，这里面包括了 RedisObject 结构、SDS 结构、dictEntry 结构的内存开销。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2180"><span data-slate-object="text" data-key="2181"><span data-slate-leaf="true" data-offset-key="2181:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_26994dcf" data-attr-id="40904" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">针对这种情况，我们可以使用压缩列表保存数据。当然，使用 Hash 这种集合类型保存单值键值对的数据时，我们需要将单值数据拆分成两部分，分别作为 Hash 集合的键和值，就像刚才案例中用二级编码来表示图片 ID，希望你能把这个方法用到自己的场景中。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2182"><span data-slate-object="text" data-key="2183"><span data-slate-leaf="true" data-offset-key="2183:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_64a98afa" data-attr-id="8179" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">最后，我还想再给你提供一个小方法：如果你想知道键值对采用不同类型保存时的内存开销，可以在</span></span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="2184"><span data-slate-object="text" data-key="2185"><span data-slate-leaf="true" data-offset-key="2185:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_64a98afa" data-attr-id="8179" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">这个网址</span></span></span></span></a><span data-slate-object="text" data-key="2186"><span data-slate-leaf="true" data-offset-key="2186:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_64a98afa" data-attr-id="8179" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">里输入你的键值对长度和使用的数据类型，这样就能知道实际消耗的内存大小了。</span></span></span><span data-slate-leaf="true" data-offset-key="2186:1"><span data-slate-string="true">建议你把这个小工具用起来，它可以帮助你充分地节省内存。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2187" id="sr-toc-5"><span data-slate-object="text" data-key="2188"><span data-slate-leaf="true" data-offset-key="2188:0" data-first-offset="true"><span data-slate-string="true">每课一问</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2189"><span data-slate-object="text" data-key="2190"><span data-slate-leaf="true" data-offset-key="2190:0" data-first-offset="true"><span data-slate-string="true">按照惯例，给你提个小问题：除了 String 类型和 Hash 类型，你觉得，还有其他合适的类型可以应用在这节课所说的保存图片的例子吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2191"><span data-slate-object="text" data-key="2192"><span data-slate-leaf="true" data-offset-key="2192:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区写下你的思考和答案，我们一起交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>145</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-6">精选留言 (136)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Kaito</span></div></div><div>保存图片的例子，除了用 String 和 Hash 存储之外，还可以用 Sorted Set 存储（勉强）。

Sorted Set 与 Hash 类似，当元素数量少于 zset-max-ziplist-entries，并且每个元素内存占用小于 zset-max-ziplist-value 时，默认也采用 ziplist 结构存储。我们可以把 zset-max-ziplist-entries 参数设置为 1000，这样 Sorted Set 默认就会使用 ziplist 存储了，member 和 score 也会紧凑排列存储，可以节省内存空间。

使用 zadd 1101000 3302000080 060 命令存储图片 ID 和对象 ID 的映射关系，查询时使用 zscore 1101000 060 获取结果。

但是 Sorted Set 使用 ziplist 存储时的缺点是，这个 ziplist 是需要按照 score 排序的（为了方便 zrange 和 zrevrange 命令的使用），所以在插入一个元素时，需要先根据 score 找到对应的位置，然后把 member 和 score 插入进去，这也意味着 Sorted Set 插入元素的性能没有 Hash 高（这也是前面说勉强能用 Sorte Set 存储的原因）。而 Hash 在插入元素时，只需要将新的元素插入到 ziplist 的尾部即可，不需要定位到指定位置。

不管是使用 Hash 还是 Sorted Set，当采用 ziplist 方式存储时，虽然可以节省内存空间，但是在查询指定元素时，都要遍历整个 ziplist，找到指定的元素。所以使用 ziplist 方式存储时，虽然可以利用 CPU 高速缓存，但也不适合存储过多的数据（hash-max-ziplist-entries 和 zset-max-ziplist-entries 不宜设置过大），否则查询性能就会下降比较厉害。整体来说，这样的方案就是时间换空间，我们需要权衡使用。

当使用 ziplist 存储时，我们尽量存储 int 数据，ziplist 在设计时每个 entry 都进行了优化，针对要存储的数据，会尽量选择占用内存小的方式存储（整数比字符串在存储时占用内存更小），这也有利于我们节省 Redis 的内存。还有，因为 ziplist 是每个元素紧凑排列，而且每个元素存储了上一个元素的长度，所以当修改其中一个元素超过一定大小时，会引发多个元素的级联调整（前面一个元素发生大的变动，后面的元素都要重新排列位置，重新分配内存），这也会引发性能问题，需要注意。

另外，使用 Hash 和 Sorted Set 存储时，虽然节省了内存空间，但是设置过期变得困难（无法控制每个元素的过期，只能整个 key 设置过期，或者业务层单独维护每个元素过期删除的逻辑，但比较复杂）。而使用 String 虽然占用内存多，但是每个 key 都可以单独设置过期时间，还可以设置 maxmemory 和淘汰策略，以这种方式控制整个实例的内存上限。

所以在选用 Hash 和 Sorted Set 存储时，意味着把 Redis 当做数据库使用，这样就需要务必保证 Redis 的可靠性（做好备份、主从副本），防止实例宕机引发数据丢失的风险。而采用 String 存储时，可以把 Redis 当做缓存使用，每个 key 设置过期时间，同时设置 maxmemory 和淘汰策略，控制整个实例的内存上限，这种方案需要在数据库层（例如 MySQL）也存储一份映射关系，当 Redis 中的缓存过期或被淘汰时，需要从数据库中重新查询重建缓存，同时需要保证数据库和缓存的一致性，这些逻辑也需要编写业务代码实现。

总之，各有利弊，我们需要根据实际场景进行选择。</div><div><div>2020-08-31</div><div><div><i></i><span>43</span></div><div><i></i><span>462</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/7d/8e/bb16d414.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Wangxi</span></div></div><div>实测老师的例子，长度 7 位数，共 100 万条数据。使用 string 占用 70mb，使用 hash ziplist 只占用 9mb。效果非常明显。redis 版本 6.0.6</div><div><p>作者回复：赞 实践的态度！</p></div><div><div>2020-08-31</div><div><div><i></i><span>11</span></div><div><i></i><span>143</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/fd/fd/326be9bb.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 注定非凡</span></div></div><div>一，作者讲了什么？
    Redis 的 String 类型数据结构，及其底层实现
二，作者是怎么把这事给说明白的？
    1，通过一个图片存储的案例，讲通过合理利用 Redis 的数据结构，降低资源消耗

三，为了讲明白，作者讲了哪些要点？有哪些亮点？
1，亮点 1：String 类型的数据占用内存，分别是被谁占用了
2，亮点 2：可以巧妙的利用 Redis 的底层数据结构特性，降低资源消耗
3，要点 1： Simple Dynamic String 结构体（
                  buf：字节数组，为了表示字节结束，会在结尾增加 “\0”
                  len： 占 4 个字节，表示 buf 的已用长度
                  alloc：占 4 个字节，表示 buf 实际分配的长度，一般大于 len）

4，要点 2： RedisObject 结构体（
                   元数据：8 字节（用于记录最后一次访问时间，被引用次数。。。）
                   指针：8 字节，指向具体数据类型的实际数据所在 ）

5，要点 3：dicEntry 结构体（    
                  key：8 个字节指针，指向 key
                  value：8 个字节指针，指向 value
                  next：指向下一个 dicEntry）
6，要点 4：ziplist (压缩列表)（
                 zlbytes：在表头，表示列表长度
                 zltail：在表头，表示列尾偏移量
                 zllen：在表头，表示列表中
                 entry：保存数据对象模型
                 zlend：在表尾，表示列表结束）
entry：（
              prev_len：表示一个 entry 的长度，有两种取值方式：1 字节或 5 字节。
                     1 字节表示一个 entry 小于 254 字节，255 是 zlend 的默认值，所以不使用。
              len：表示自身长度，4 字节
              encodeing：表示编码方式，1 字节
              content：保存实际数据）

5，要点 4：String 类型的内存空间消耗
①，保存 Long 类型时，指针直接保存整数数据值，可以节省空间开销（被称为：int 编码）
②，保存字符串，且不大于 44 字节时，RedisObject 的元数据，指针和 SDS 是连续的，可以避免内存碎片（被称为：embstr 编码）
③，当保存的字符串大于 44 字节时，SDS 的数据量变多，Redis 会给 SDS 分配独立的空间，并用指针指向 SDS 结构（被称为：raw 编码）
④，Redis 使用一个全局哈希表保存所以键值对，哈希表的每一项都是一个 dicEntry，每个 dicEntry 占用 32 字节空间
⑤，dicEntry 自身 24 字节，但会占用 32 字节空间，是因为 Redis 使用了内存分配库 jemalloc。
                    jemalloc 在分配内存时，会根据申请的字节数 N，找一个比 N 大，但最接近 N 的 2 的幂次数作为分配空间，这样可以减少频繁分配内存的次数

4，要点 5：使用什么数据结构可以节省内存？
①， 压缩列表，是一种非常节省内存的数据结构，因为他使用连续的内存空间保存数据，不需要额外的指针进行连接
②，Redis 基于压缩列表实现 List，Hash，Sorted Set 集合类型，最大的好处是节省了 dicEntry 开销

5，要点 6：如何使用集合类型保存键值对？
①，Hash 类型设置了用压缩列表保存数据时的两个阀值，一旦超过就会将压缩列表转为哈希表，且不可回退
②，hash-max-ziplist-entries：表示用压缩列表保存哈希集合中的最大元素个数 
③，hash-max-ziplist-value：表示用压缩列表保存时，哈希集合中单个元素的最大长度

四，对于作者所讲，我有哪些发散性思考？
    看了老师讲解，做了笔记，又看了黄建宏写的《Redis 设计与实现》
有这样的讲解： 
        当哈希对象可以同时满足以下两个条件时， 哈希对象使用 ziplist 编码：
	1. 哈希对象保存的所有键值对的键和值的字符串长度都小于 64 字节；
	2. 哈希对象保存的键值对数量小于 512 个；

五，在将来的哪些场景中，我能够使用它？
    这次学习 Redis 数据结构特性有了更多了解，在以后可以更加有信心根据业务需要，选取特定的数据结构
</div><div><div>2020-09-09</div><div><div><i></i><span>4</span></div><div><i></i><span>87</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/08/22/ac1b8a34.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>super BB💨🐷</span></div></div><div>老师，我之前看到《redis 设计与实现》中提出 SDS 的结构体的中没有 alloc 字段，书中的提到的是 free, 用来表示 buf 数组未使用的字节长度</div><div><p>作者回复：学习的很仔细！

《Redis 设计与实现》这本书分析的代码是 Redis3.0 的源码，在 Redis3.0.4 源码中，SDS 结构体里还是用的 free 表示未使用空间。

但是应该差不多是 Redis3.2.0 开始，SDS 结构体开始使用 alloc 字段了。</p></div><div><div>2020-09-11</div><div><div><i></i><span>4</span></div><div><i></i><span>60</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/7a/0a/0ce5c232.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 吕</span></div></div><div>我有一个疑惑，老师，文中的案例，这么大的数据量，为什么采用 redis 这种内存数据库来存储数据么呢，感觉它的业务场景还是不很清楚？直接采用 mysql 存储会有什么问题么？</div><div><p>作者回复：这是个好问题。

其实这个图片 ID 和存储对象 ID 对应关系的存储，就是用在分布式存储系统中的一个小的元数据服务，访问模式也比较简单，key-value 的 PUT、GET 就行，但是要求请求响应快。Redis 很轻量级，而且速度也快，所以用的 Redis。

MySQL 用在这个场景中显得有些太重了，这个场景里面没有关系模型，也没有事务需求和复杂查询，上 MySQL 不太需要。图片数量再增加时，MySQL 的表就太大了，插入效率会降低。</p></div><div><div>2020-09-01</div><div><div><i></i><span>5</span></div><div><i></i><span>41</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/d8/17/367943f4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 吴永祺</span></div></div><div>hset 1101000 060 3302000080 操作为何只占用 16 字节？哈希键（060）、值（3302000080）两者各占用一个 entry，按文中介绍，应该至少占用 28 字节。

其中原因，我认为很可能是文中对 ziplist entry 的介绍有误，参考下面 GitHub 文章，entry 中并没有 len 字段，entry 长度由 encoding 表示。所以例子中虽然创建两个 entry，但总长度是小于 16 的。

参考：https://github.com/zpoint/Redis-Internals/blob/5.0/Object/hash/hash_cn.md</div><div><div>2020-10-14</div><div><div><i></i><span>8</span></div><div><i></i><span>27</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/41/5e/9d2953a3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>zhou</span></div></div><div>hset 1101000 060 3302000080
这条记录只消耗 16 字节没明白，压缩列表保存一个对象需要 14 字节，060、3302000080 都需要保存，那应该至少大于 28 字节</div><div><div>2020-09-01</div><div><div><i></i><span>36</span></div><div><i></i><span>18</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/9b/6e/edd2da0c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 蓝魔丶</span></div></div><div>老师，测试环境：redis5.0.4
1. 实践采用 String 方案：set 1101000052 3301000051，查看内存增加的 72，而不是 64，是为什么？
2. 实践采用 Hash 方案：hset 1101000 060 3302000080 查看内存增加 88，再次添加 key-value，才是满足增加 16</div><div><div>2020-09-02</div><div><div><i></i><span>6</span></div><div><i></i><span>12</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/28/8f/f4d14c03.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Hm_</span></div></div><div>老师有个地方不是很理解，文中讲到 String 需要 dictEntry 来保存键值关系，那么 hash 结构最外层的那个 key 没有 dictEntry 来维护吗？因为我记得之前讲得 Redis 是用一个大的 hash 来维护所有的键值对的，所以感觉这和 dictEntry 所占用的内存是一样的吧</div><div><p>作者回复: dictEntry 是 Redis 全局哈希表中的表项，包含了 key 和 value 的指针，这里的 value 可以是 String，List，Hash 等数据类型。

你说的 hash 结构最外层的 key，如果是指全局哈希表中的 key 的话，指向 key 的指针是已经包含在 dictEntry 这个结构中了，同时 key 本身的数据结构是 RedisObject。</p></div><div><div>2020-12-14</div><div><div><i></i><span>3</span></div><div><i></i><span>11</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/dd/9b/0bc44a78.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>yyl</span></div></div><div>“在节省内存空间方面，哈希表就没有压缩列表那么高效了”
在内存空间的开销上，也许哈希表没有压缩列表高效
但是哈希表的查询效率，要比压缩列表高。
在对查询效率高的场景中，可以考虑空间换时间

</div><div><p>作者回复：其实，在 Redis 的设计和使用上，是一个典型的 “系统” 思维，也就是权衡（trade-off），根据自己的业务场景、数据量、访问特征，来进行选择。
我们自己做系统研发，这是个核心思想 ：）</p></div><div><div>2020-09-03</div><div><div><i></i><span>3</span></div><div><i></i><span>10</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/36/2c/8bd4be3a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 小喵喵</span></div></div><div>老师，请教下，这样拆分的话，如何重复了咋办呢？
以图片 ID 1101000060 和图片存储对象 ID 3302000080 为例，我们可以把图片 ID 的前 7 位（1101000）作为 Hash 类型的键，把图片 ID 的最后 3 位（060）和图片存储对象 ID 分别作为 Hash 类型值中的 key 和 value。
比如：两张图片分别为：图片 ID 1101000060 图片存储对象 ID 3302000080；
                                     图片 ID 1101001060 图片存储对象 ID 3302000081
这个时候最后 3 位（060）的 key 是冲突的的，但是它的图片存储对象 ID 不同。</div><div><p>作者回复：我们是会把图片 ID 的前 7 位作为键值对的 key，Hash 集合是键值对的 value，在你举的例子中，图片 ID 1101000060 和 1101001060。它们的前 7 位分别是 1101000 和 1101001，对应了两个键值对。所以，它们图片 ID 的后 3 位虽然相同，都是 060，也是在两个 Hash 集合中的，不会冲突的。

你看看是不是呢？</p></div><div><div>2020-09-01</div><div><div><i></i><span>10</span></div><div><i></i><span>10</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 一步</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>使用 http://www.redis.cn/redis_memory/ 这个网站来计算 文章中 一亿张图片 ID 消耗的内存， 为什么得出来 9269.71M,  9 点多个 G 呢？ 1 亿个 string , string 的 key 和 value 分别是 8 个 字节
</div><div><div>2020-09-01</div><div><div><i></i><span></span></div><div><i></i><span>9</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJZBe7lmwPf33yS7btnXuwv2bvfC7zfKibcZfPUQKTlbJgZeKY0wX70LUsej8EX14rYcCZ5Gk02YTQ/132"></div></div><div><div><div><span>aworker</span></div></div><div>看好多小伙伴里面对 embstr 的临界点是 44 字节的算法有疑问，给大家解释下：

首先说下 redisObject 的数据结构包含如下字段：
type：表明 redisobjct 的类型如果 string，hash，set 等，占 4 字节。
encoding：编码类型，占 4 字节。
lru: 记录此 object 最近被访问的时间数据和过期逻辑有关，4 字节。
refcount: 记录指向此 object 的指针数量，用来表示不同指针相同数据的情况，4 个字节。
ptr：真正指向具体数据的指针，8 字节。

在 3.2 版本以前的 sds 结构如下：
len：表示 sds 中 buf 已经使用的长度，4 个字节。
free：表示 sds 中 buf 没有使用的长度，4 个字节。
buf：数组，真正存储数据的地方，会有 1 字节的‘\0’，表示数据的结尾。

如果想让 string 类型用 embstr 编码那么需要满足如下条件：

64-16（redisObjct 除去 ptr 后最小使用的内存）-（4+4+1）（sds 最小内存需求）=39 。

redis 3.2 及其以后的版本 sds 会根据实际使用的 buf 长度，采用不同的 sds 对象表示，这里只说下小于等 64 字节的 sds 对象结构：
len：表示 buf 的使用长度，1 字节。
alloc：表示分配给 buf 的总长度，1 字节。
flag：表示具体的 sds 类型，1 个字节。
buf：真正存储数据的地方，肯定有 1 字节的‘\0’表示结束符。

如果想让 redis3.2 以后的版本使用 embstr 编码的 string 需要 buf 满足的最大值为：
64-16（redisObject 最小值）-（1+1+1+1）（sds 最小用的内存）= 44 字节。

这里需要澄清一点：相较于 raw 编码，当 redis 采用 embstr 编码的时候，redis 会吧 redisObjct 的元数据和 sds 连续存在，这就节约了 ptr 指针的内存使用，这也是 redis 要分 embstr 和 raw 的原因。老师的图中 embstr 编码也有 8 字节的指针，这个应该是不准确的。

随着版本升级也能看出 redis 开发者对高效数据结构的极致追求：在 3.2 版本以前的 sds 中用 4 个字节表示 buf 的已用长度和未使用长度，但对于 embstr 编码的 sds 是有些浪费的，因为 buf 最大值是 39 字节，1 字节就可以表示 255 的长度了，所以 3.2 以后的 embstr 编码的 sds 的 len 和 alloc 都是一个字节。



</div><div><div>2021-05-06</div><div><div><i></i><span>3</span></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>test</span></div></div><div>虽然压缩列表可以节约内存，但是 set 和 get 的时间复杂度为 O (N)，一个时间换空间的方法。</div><div><div>2020-09-02</div><div><div><i></i><span>3</span></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/e8/55/92f82281.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>MClink</span></div></div><div>老师，底层数据结构的转换是怎么实现的呢？是单纯的开一个新的数据结构再把数据复制过去吗？再释放之前的数据结构的内存，复制过程中有修改值的话要怎么处理，复制过程中不就两倍内存消耗了</div><div><div>2020-08-31</div><div><div><i></i><span></span></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/fe/83/df562574.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 慎独明强</span></div></div><div>看了 Redis 设计与实现，有讲 SDS 这一块，对于老师分析的内容，自己心里有印象，再结合老师今天的实践案例，前面的知识还没有吃透
😂😂</div><div><div>2020-08-31</div><div><div><i></i><span></span></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2c/6b/6c/3e80afaf.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>HappyHasson</span></div></div><div>hset 1101000 060 3302000080  为什么这条语句执行之后内存增加了 16B？

老师的前提是执行命令之前已经有了 hash key 1101000。然后插入 fieldkey:060   fieldvalue:3302000080
fieldkey 和 fieldvalue 各分配一个 ziplist entry，hset 时，会调用 ziplistPush 函数先把 fieldkey 放到 ziplist 表尾，然后再放 fieldvalue。之所以是 16 字节，是老师讲解的有点问题。ziplist entry 包含三个字段 previous_entry_length、encoding、content。没有老师说的 len 这个固定 4 字节的字段
previous_entry_length 取值规则：https://github.com/zpoint/Redis-Internals/blob/5.0/Object/hash/prevlen.png
encoding 取值规则：https://github.com/zpoint/Redis-Internals/blob/5.0/Object/hash/encoding.png
所以这个命令的 fieldkey 占用字节：1+1+1=3、fieldvalue 占用字节：1+1+8 (64 位整数表示 3302000080)</div><div><div>2022-03-03</div><div><div><i></i><span>1</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLzvaL724GwtzZ5mcldUnlicicSlI8BXL9icRZbUOB10qjRMlmog7UTvwxSBHXagnPGGR1BYdjWcGGSg/132"></div></div><div><div><div><span>wwj</span></div></div><div>这样是不是有点本位倒置了，缓存本来就是以空间换时间的，这样节省了空间，但是时间复杂度也上去了</div><div><div>2020-09-27</div><div><div><i></i><span>3</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/45/ab/7dec2448.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 我不用网名</span></div></div><div>看了很久，一直没有静下心来仔细品味，今天又重新将课程内容梳理了一遍，有几个问题，希望老师能解答一下:
1.  redis 把 sds 使用 raw 编码还是 embstr 编码的临界值是 44, 这个 44 是如何计算出来的呢？按文档中 sds len (4) + alloc (4) + 1 (\0)  + redisObject (元素数据 8 + 指针 8) = 25, jemalloc 将超过 64 字节的使用 raw 编码，这样的话，buff 的最大值 64-25=39.    这也是我看网上其它资料时写的 reids.3.2 版本之前使用的值. 3.2 及以后使用 44.  老师文档中 sds 各字段的大小是不是标错了？
2.  hash 类型使用 ziplist 存储数据时，key/value 的映射关系是发何保持的呢？
     我自己有如下猜想，存储结构是不是这样？
     zlbytes zltail zllen key1 value1 key2 value2 ...  zlend
     如果是这样存储的话，又有以下两个问题困绕着我:
     在 hash 中通过某个 key 获取对应 value 时，需要遍历整个压缩列表吧。这会不会有性能影响？
     key 与 value 都紧挨着存储，entry 里面并没有字段用于标记该 entry 是 key 还是 value, 假如 key 与 value 是相同的字段串时，即有两个相同的 entry, reids 如何识别哪个是 key, 哪个是 value 呢？
     对于后面一个问题，我自己可以猜想一下的，就是 key 与 value 是成对出现的，key 永远是在寄数位 value 永远是在偶数位。这样也可以分辨，如果是我来实现的话，可能会这样。但我不懂 c, 没看过源码，请老师专业解答我才放心.
    感谢！
     </div><div><div>2020-09-19</div><div><div><i></i><span>1</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/4a/a7/ab7998b1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>zachary</span></div></div><div>通过查看 redis 的源码，sds 数据结构这块老师讲的不是很对。可能跟 redis 的版本有关吧。redis 在高版本对 sds 做了优化，sds 将不再直接使用结构体。sds 底层通过 sdshdr_5, sdshdr_8, sdshdr_16, sdshdr_32, sdshdr_64 来实现。这么做的目的明显是为了更加节省空间。以下是源码，版本 4.0.9， 文件 sds.h。

typedef char *sds;

/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */
struct __attribute__ ((__packed__)) sdshdr5 {
    unsigned char flags; /* 3 lsb of type, and 5 msb of string length */
    char buf [];
};
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf [];
};
struct __attribute__ ((__packed__)) sdshdr16 {
    uint16_t len; /* used */
    uint16_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf [];
};
struct __attribute__ ((__packed__)) sdshdr32 {
    uint32_t len; /* used */
    uint32_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf [];
};
struct __attribute__ ((__packed__)) sdshdr64 {
    uint64_t len; /* used */
    uint64_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf [];
};
</div><div><div>2021-06-25</div><div><div><i></i><span>2</span></div><div><i></i><span>4</span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".y"><outline class="toc-level-h1" data-reactid=".y.0" style="width: 175px;"><active data-reactid=".y.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".y.0.1"><span data-reactid=".y.0.1.0">11 | “万金油” 的 String，为什么不好用了？</span></a></outline><outline class="toc-level-h2" data-reactid=".y.1" style="width: 165px;"><active data-reactid=".y.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".y.1.1"><span data-reactid=".y.1.1.0">为什么 String 类型内存开销大？</span></a></outline><outline class="toc-level-h2" data-reactid=".y.2" style="width: 165px;"><active data-reactid=".y.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".y.2.1"><span data-reactid=".y.2.1.0">用什么数据结构可以节省内存？</span></a></outline><outline class="toc-level-h2" data-reactid=".y.3" style="width: 165px;"><active data-reactid=".y.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".y.3.1"><span data-reactid=".y.3.1.0">如何用集合类型保存单值的键值对？</span></a></outline><outline class="toc-level-h2" data-reactid=".y.4" style="width: 165px;"><active data-reactid=".y.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".y.4.1"><span data-reactid=".y.4.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".y.5" style="width: 165px;"><active data-reactid=".y.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".y.5.1"><span data-reactid=".y.5.1.0">每课一问</span></a></outline><outline class="toc-level-h2" data-reactid=".y.6" style="width: 165px;"><active data-reactid=".y.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".y.6.1"><span data-reactid=".y.6.1.0">精选留言 (136)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/279649" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>