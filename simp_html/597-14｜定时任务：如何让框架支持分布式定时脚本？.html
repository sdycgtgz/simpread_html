
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 14｜定时任务：如何让框架支持分布式定时脚本？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>14｜定时任务：如何让框架支持分布式定时脚本？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">细节和生态是 Gin 如此成功核心原因。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">14｜定时任务：如何让框架支持分布式定时脚本？</h1><div><span>叶剑峰</span> <span> 2021-10-18</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/dc/e0/dce0a74986cc3f4ba120c3b26f2015e0.jpeg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：叶剑峰</span><span>大小：20.61M</span><span> 时长：22:34</span></div></div><audio title="14｜定时任务：如何让框架支持分布式定时脚本？" src="https://res001.geekbang.org/media/audio/9c/8c/9cf5fbd00200fb6c5f65912f9f60a88c/ld/ld.m3u8" __idm_id__="704521"></audio></div><div><div><div><div data-slate-editor="true" data-key="5727" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="5728"><span data-slate-object="text" data-key="5729"><span data-slate-leaf="true" data-offset-key="5729:0" data-first-offset="true"><span data-slate-string="true">你好，我是轩脉刃。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5730"><span data-slate-object="text" data-key="5731"><span data-slate-leaf="true" data-offset-key="5731:0" data-first-offset="true"><span data-slate-string="true">上一节课，我们改造框架让它支持命令行工具了。这样业务开发者可以使用框架定义好的命令行工具来执行框架预设的一些行为，比如启动一个 Web 服务，也可以自己定义业务需要的命令行工具来执行业务行为，非常方便。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5732"><span data-slate-object="text" data-key="5733"><span data-slate-leaf="true" data-offset-key="5733:0" data-first-offset="true"><span data-slate-string="true">今天继续思考如何优化，因为业务在开发过程中，不可能每个命令都要手动操作，定时执行某个命令的需求应该是非常普遍的。比如设计一个定时扫描数据命令来发送统计报告，或者设计一个定时删除某些过期数据的命令。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5734"><span data-slate-object="text" data-key="5735"><span data-slate-leaf="true" data-offset-key="5735:0" data-first-offset="true"><span data-slate-string="true">那我们的框架是否能支持这个需求，如果要开发一个定时命令，能不能做到在业务中增加一行代码就行了？这节课我们就来挑战这个目标。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5736" id="sr-toc-1"><span data-slate-object="text" data-key="5737"><span data-slate-leaf="true" data-offset-key="5737:0" data-first-offset="true"><span data-slate-string="true">使用 timer 定时执行命令</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5738"><span data-slate-object="text" data-key="5739"><span data-slate-leaf="true" data-offset-key="5739:0" data-first-offset="true"><span data-slate-string="true">怎么做到计时执行这个事情呢？Golang 有个标准库 time，里面提供一个计时器 timer 的结构，是否可以使用这个 timer 来执行呢？我们先来看看 timer 是怎么使用的：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5740"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5741"><span data-slate-object="text" data-key="5742"><span data-slate-leaf="true" data-offset-key="5742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5743"><span data-slate-leaf="true" data-offset-key="5743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5744"><span data-slate-leaf="true" data-offset-key="5744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="5745"><span data-slate-leaf="true" data-offset-key="5745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5746"><span data-slate-leaf="true" data-offset-key="5746:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5747"><span data-slate-object="text" data-key="5748"><span data-slate-leaf="true" data-offset-key="5748:0" data-first-offset="true"><span data-slate-string="true">  timer := time.NewTimer(</span></span></span><span data-slate-object="text" data-key="5749"><span data-slate-leaf="true" data-offset-key="5749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="5750"><span data-slate-leaf="true" data-offset-key="5750:0" data-first-offset="true"><span data-slate-string="true"> * time.Second) </span></span></span><span data-slate-object="text" data-key="5751"><span data-slate-leaf="true" data-offset-key="5751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 定一个计时器，3s 后触发</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5752"><span data-slate-object="text" data-key="5753"><span data-slate-leaf="true" data-offset-key="5753:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5754"><span data-slate-leaf="true" data-offset-key="5754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="5755"><span data-slate-leaf="true" data-offset-key="5755:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5756"><span data-slate-object="text" data-key="5757"><span data-slate-leaf="true" data-offset-key="5757:0" data-first-offset="true"><span data-slate-string="true">    now &lt;-timer.C:  </span></span></span><span data-slate-object="text" data-key="5758"><span data-slate-leaf="true" data-offset-key="5758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 监听计时器中的事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5759"><span data-slate-object="text" data-key="5760"><span data-slate-leaf="true" data-offset-key="5760:0" data-first-offset="true"><span data-slate-string="true">      fmt.Println(</span></span></span><span data-slate-object="text" data-key="5761"><span data-slate-leaf="true" data-offset-key="5761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"3 秒执行任务，现在时间"</span></span></span></span><span data-slate-object="text" data-key="5762"><span data-slate-leaf="true" data-offset-key="5762:0" data-first-offset="true"><span data-slate-string="true">, now)  </span></span></span><span data-slate-object="text" data-key="5763"><span data-slate-leaf="true" data-offset-key="5763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//3s 后执行</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5764"><span data-slate-object="text" data-key="5765"><span data-slate-leaf="true" data-offset-key="5765:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5766"><span data-slate-object="text" data-key="5767"><span data-slate-leaf="true" data-offset-key="5767:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5768"><span data-slate-object="text" data-key="5769"><span data-slate-leaf="true" data-offset-key="5769:0" data-first-offset="true"><span data-slate-string="true">首先 time.NewTimer 会初始化一个计时器，这个计时器到定时时间后，就从 C 这个 channel 中返回一个时间 Time。逻辑很简单。所以我们的 main 函数只需要监听 timer.C 这个 channel，一旦有时间从这个 channel 中出来，就说明到计时器时间了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5770"><span data-slate-object="text" data-key="5771"><span data-slate-leaf="true" data-offset-key="5771:0" data-first-offset="true"><span data-slate-string="true">知道如何定时执行了，接下来得结合实际业务场景考虑会存在什么问题了：</span></span></span><span data-slate-object="text" data-key="5772"><span data-slate-leaf="true" data-offset-key="5772:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如果有一堆定时任务，要怎么定时执行呢</span></span></span></span><span data-slate-object="text" data-key="5773"><span data-slate-leaf="true" data-offset-key="5773:0" data-first-offset="true"><span data-slate-string="true">？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5774"><span data-slate-object="text" data-key="5775"><span data-slate-leaf="true" data-offset-key="5775:0" data-first-offset="true"><span data-slate-string="true">这个也难不倒我们：遍历所有的定时任务，计算出这些定时任务下一次要执行的时间，然后按照从近到远排序，用 timer 来设置一个定时器到最近的时间触发，然后等计时一到，开启一个 Goroutine 触发执行。触发之后再进行一轮计算，计算出所有定时任务下一次要执行的时间，再初始化一个定时器。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5776"><span data-slate-object="text" data-key="5777"><span data-slate-leaf="true" data-offset-key="5777:0" data-first-offset="true"><span data-slate-string="true">写一下大致的伪代码如下。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5778"><div data-slate-type="list-line" data-slate-object="block" data-key="5779"><span data-slate-object="text" data-key="5780"><span data-slate-leaf="true" data-offset-key="5780:0" data-first-offset="true"><span data-slate-string="true">假设定义每个定时任务结构为 Entry，先计算每个 Entry 的下一次运行的时间，接着进入循环；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5781"><span data-slate-object="text" data-key="5782"><span data-slate-leaf="true" data-offset-key="5782:0" data-first-offset="true"><span data-slate-string="true">在循环中，根据 Next 排序，然后根据最近的 Entry 实例化一个计时器，进入阻塞等待；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5783"><span data-slate-object="text" data-key="5784"><span data-slate-leaf="true" data-offset-key="5784:0" data-first-offset="true"><span data-slate-string="true">等计时器时间到了，通过 timer.C 获取到时间，再进行遍历，把到了时间的任务进行一次执行，并且更新所有任务的下次执行时间。</span></span></span></div></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5785"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5786"><span data-slate-object="text" data-key="5787"><span data-slate-leaf="true" data-offset-key="5787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Entity 代表每个定时任务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5788"><span data-slate-object="text" data-key="5789"><span data-slate-leaf="true" data-offset-key="5789:0" data-first-offset="true"><span data-slate-string="true">entries := []Entry  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5790"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5791"><span data-slate-object="text" data-key="5792"><span data-slate-leaf="true" data-offset-key="5792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 计算每个定时任务时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5793"><span data-slate-object="text" data-key="5794"><span data-slate-leaf="true" data-offset-key="5794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5795"><span data-slate-leaf="true" data-offset-key="5795:0" data-first-offset="true"><span data-slate-string="true"> _, entry := </span></span></span><span data-slate-object="text" data-key="5796"><span data-slate-leaf="true" data-offset-key="5796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="5797"><span data-slate-leaf="true" data-offset-key="5797:0" data-first-offset="true"><span data-slate-string="true"> entries {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5798"><span data-slate-object="text" data-key="5799"><span data-slate-leaf="true" data-offset-key="5799:0" data-first-offset="true"><span data-slate-string="true">  entry.Next = next(entry)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5800"><span data-slate-object="text" data-key="5801"><span data-slate-leaf="true" data-offset-key="5801:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5802"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5803"><span data-slate-object="text" data-key="5804"><span data-slate-leaf="true" data-offset-key="5804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5805"><span data-slate-leaf="true" data-offset-key="5805:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5806"><span data-slate-object="text" data-key="5807"><span data-slate-leaf="true" data-offset-key="5807:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5808"><span data-slate-leaf="true" data-offset-key="5808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据 Next 时间排序</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5809"><span data-slate-object="text" data-key="5810"><span data-slate-leaf="true" data-offset-key="5810:0" data-first-offset="true"><span data-slate-string="true">    sortByTime(entries)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5811"><span data-slate-object="text" data-key="5812"><span data-slate-leaf="true" data-offset-key="5812:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5813"><span data-slate-object="text" data-key="5814"><span data-slate-leaf="true" data-offset-key="5814:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5815"><span data-slate-leaf="true" data-offset-key="5815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建计时器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5816"><span data-slate-object="text" data-key="5817"><span data-slate-leaf="true" data-offset-key="5817:0" data-first-offset="true"><span data-slate-string="true">    timer = time.NewTimer(entries.Early.Sub(time.Now())) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5818"><span data-slate-object="text" data-key="5819"><span data-slate-leaf="true" data-offset-key="5819:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5820"><span data-slate-object="text" data-key="5821"><span data-slate-leaf="true" data-offset-key="5821:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5822"><span data-slate-leaf="true" data-offset-key="5822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="5823"><span data-slate-leaf="true" data-offset-key="5823:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5824"><span data-slate-object="text" data-key="5825"><span data-slate-leaf="true" data-offset-key="5825:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="5826"><span data-slate-leaf="true" data-offset-key="5826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="5827"><span data-slate-leaf="true" data-offset-key="5827:0" data-first-offset="true"><span data-slate-string="true"> now = &lt;-timer.C:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5828"><span data-slate-object="text" data-key="5829"><span data-slate-leaf="true" data-offset-key="5829:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5830"><span data-slate-leaf="true" data-offset-key="5830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5831"><span data-slate-leaf="true" data-offset-key="5831:0" data-first-offset="true"><span data-slate-string="true"> _, entry := entries {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5832"><span data-slate-object="text" data-key="5833"><span data-slate-leaf="true" data-offset-key="5833:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="5834"><span data-slate-leaf="true" data-offset-key="5834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对已经到了时间的任务，执行</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5835"><span data-slate-object="text" data-key="5836"><span data-slate-leaf="true" data-offset-key="5836:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="5837"><span data-slate-leaf="true" data-offset-key="5837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5838"><span data-slate-leaf="true" data-offset-key="5838:0" data-first-offset="true"><span data-slate-string="true"> entry.Next.Ok() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5839"><span data-slate-object="text" data-key="5840"><span data-slate-leaf="true" data-offset-key="5840:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="5841"><span data-slate-leaf="true" data-offset-key="5841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="5842"><span data-slate-leaf="true" data-offset-key="5842:0" data-first-offset="true"><span data-slate-string="true"> startJob(entry)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5843"><span data-slate-object="text" data-key="5844"><span data-slate-leaf="true" data-offset-key="5844:0" data-first-offset="true"><span data-slate-string="true">          }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5845"><span data-slate-object="text" data-key="5846"><span data-slate-leaf="true" data-offset-key="5846:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5847"><span data-slate-object="text" data-key="5848"><span data-slate-leaf="true" data-offset-key="5848:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="5849"><span data-slate-leaf="true" data-offset-key="5849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 所有任务重新计算下个 timer</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5850"><span data-slate-object="text" data-key="5851"><span data-slate-leaf="true" data-offset-key="5851:0" data-first-offset="true"><span data-slate-string="true">          entry.Next = next(entry)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5852"><span data-slate-object="text" data-key="5853"><span data-slate-leaf="true" data-offset-key="5853:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5854"><span data-slate-object="text" data-key="5855"><span data-slate-leaf="true" data-offset-key="5855:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5856"><span data-slate-object="text" data-key="5857"><span data-slate-leaf="true" data-offset-key="5857:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5858" id="sr-toc-2"><span data-slate-object="text" data-key="5859"><span data-slate-leaf="true" data-offset-key="5859:0" data-first-offset="true"><span data-slate-string="true">使用 cron 包定时执行命令</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5860"><span data-slate-object="text" data-key="5861"><span data-slate-leaf="true" data-offset-key="5861:0" data-first-offset="true"><span data-slate-string="true">其实我们刚才对定时执行任务的分析，就是开源定时执行库</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5862"><span data-slate-object="text" data-key="5863"><span data-slate-leaf="true" data-offset-key="5863:0" data-first-offset="true"><span data-slate-string="true"> cron </span></span></span></a><span data-slate-object="text" data-key="5864"><span data-slate-leaf="true" data-offset-key="5864:0" data-first-offset="true"><span data-slate-string="true">的核心实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5865"><span data-slate-object="text" data-key="5866"><span data-slate-leaf="true" data-offset-key="5866:0" data-first-offset="true"><span data-slate-string="true">cron 库的作者 robfig 是一名资深的 Golang 开源贡献者，他最出名的两个作品 cron 库和 Revel 框架目前已经分别有了 8.4k 和 12.4k 的 star 数。cron 库的 Licence 是基于 MIT 的，允许商用、允许私有化，目前最新的稳定版本为 v3。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5867"><span data-slate-object="text" data-key="5868"><span data-slate-leaf="true" data-offset-key="5868:0" data-first-offset="true"><span data-slate-string="true">cron 库可以实现多个定时任务的执行功能，核心原理正如刚才讲的那样，底层也是使用 timer 来进行每个定时任务的计算，但是细节实现远不止这些。我们看它的用法就能感受出来：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5869"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5870"><span data-slate-object="text" data-key="5871"><span data-slate-leaf="true" data-offset-key="5871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建一个 cron 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5872"><span data-slate-object="text" data-key="5873"><span data-slate-leaf="true" data-offset-key="5873:0" data-first-offset="true"><span data-slate-string="true">c := cron.New()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5874"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5875"><span data-slate-object="text" data-key="5876"><span data-slate-leaf="true" data-offset-key="5876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每整点 30 分钟执行一次</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5877"><span data-slate-object="text" data-key="5878"><span data-slate-leaf="true" data-offset-key="5878:0" data-first-offset="true"><span data-slate-string="true">c.AddFunc(</span></span></span><span data-slate-object="text" data-key="5879"><span data-slate-leaf="true" data-offset-key="5879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"30 * * * *"</span></span></span></span><span data-slate-object="text" data-key="5880"><span data-slate-leaf="true" data-offset-key="5880:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="5881"><span data-slate-leaf="true" data-offset-key="5881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5882"><span data-slate-leaf="true" data-offset-key="5882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5883"><span data-slate-leaf="true" data-offset-key="5883:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5884"><span data-slate-object="text" data-key="5885"><span data-slate-leaf="true" data-offset-key="5885:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="5886"><span data-slate-leaf="true" data-offset-key="5886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Every hour on the half hour"</span></span></span></span><span data-slate-object="text" data-key="5887"><span data-slate-leaf="true" data-offset-key="5887:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5888"><span data-slate-object="text" data-key="5889"><span data-slate-leaf="true" data-offset-key="5889:0" data-first-offset="true"><span data-slate-string="true">})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5890"><span data-slate-object="text" data-key="5891"><span data-slate-leaf="true" data-offset-key="5891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 上午 3-6 点，下午 8-11 点的 30 分钟执行</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5892"><span data-slate-object="text" data-key="5893"><span data-slate-leaf="true" data-offset-key="5893:0" data-first-offset="true"><span data-slate-string="true">c.AddFunc(</span></span></span><span data-slate-object="text" data-key="5894"><span data-slate-leaf="true" data-offset-key="5894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"30 3-6,20-23 * * *"</span></span></span></span><span data-slate-object="text" data-key="5895"><span data-slate-leaf="true" data-offset-key="5895:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="5896"><span data-slate-leaf="true" data-offset-key="5896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5897"><span data-slate-leaf="true" data-offset-key="5897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5898"><span data-slate-leaf="true" data-offset-key="5898:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5899"><span data-slate-object="text" data-key="5900"><span data-slate-leaf="true" data-offset-key="5900:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="5901"><span data-slate-leaf="true" data-offset-key="5901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">".. in the range 3-6am, 8-11pm"</span></span></span></span><span data-slate-object="text" data-key="5902"><span data-slate-leaf="true" data-offset-key="5902:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5903"><span data-slate-object="text" data-key="5904"><span data-slate-leaf="true" data-offset-key="5904:0" data-first-offset="true"><span data-slate-string="true">})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5905"><span data-slate-object="text" data-key="5906"><span data-slate-leaf="true" data-offset-key="5906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 东京时间 4:30 执行一次</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5907"><span data-slate-object="text" data-key="5908"><span data-slate-leaf="true" data-offset-key="5908:0" data-first-offset="true"><span data-slate-string="true">c.AddFunc(</span></span></span><span data-slate-object="text" data-key="5909"><span data-slate-leaf="true" data-offset-key="5909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"CRON_TZ=Asia/Tokyo 30 04 * * *"</span></span></span></span><span data-slate-object="text" data-key="5910"><span data-slate-leaf="true" data-offset-key="5910:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="5911"><span data-slate-leaf="true" data-offset-key="5911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5912"><span data-slate-leaf="true" data-offset-key="5912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5913"><span data-slate-leaf="true" data-offset-key="5913:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5914"><span data-slate-object="text" data-key="5915"><span data-slate-leaf="true" data-offset-key="5915:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="5916"><span data-slate-leaf="true" data-offset-key="5916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Runs at 04:30 Tokyo time every day"</span></span></span></span><span data-slate-object="text" data-key="5917"><span data-slate-leaf="true" data-offset-key="5917:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5918"><span data-slate-object="text" data-key="5919"><span data-slate-leaf="true" data-offset-key="5919:0" data-first-offset="true"><span data-slate-string="true">})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5920"><span data-slate-object="text" data-key="5921"><span data-slate-leaf="true" data-offset-key="5921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从现在开始每小时执行一次</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5922"><span data-slate-object="text" data-key="5923"><span data-slate-leaf="true" data-offset-key="5923:0" data-first-offset="true"><span data-slate-string="true">c.AddFunc(</span></span></span><span data-slate-object="text" data-key="5924"><span data-slate-leaf="true" data-offset-key="5924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"@hourly"</span></span></span></span><span data-slate-object="text" data-key="5925"><span data-slate-leaf="true" data-offset-key="5925:0" data-first-offset="true"><span data-slate-string="true">,      </span></span></span><span data-slate-object="text" data-key="5926"><span data-slate-leaf="true" data-offset-key="5926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5927"><span data-slate-leaf="true" data-offset-key="5927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5928"><span data-slate-leaf="true" data-offset-key="5928:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5929"><span data-slate-object="text" data-key="5930"><span data-slate-leaf="true" data-offset-key="5930:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="5931"><span data-slate-leaf="true" data-offset-key="5931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Every hour, starting an hour from now"</span></span></span></span><span data-slate-object="text" data-key="5932"><span data-slate-leaf="true" data-offset-key="5932:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5933"><span data-slate-object="text" data-key="5934"><span data-slate-leaf="true" data-offset-key="5934:0" data-first-offset="true"><span data-slate-string="true">})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5935"><span data-slate-object="text" data-key="5936"><span data-slate-leaf="true" data-offset-key="5936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从现在开始，每一个半小时执行一次</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5937"><span data-slate-object="text" data-key="5938"><span data-slate-leaf="true" data-offset-key="5938:0" data-first-offset="true"><span data-slate-string="true">c.AddFunc(</span></span></span><span data-slate-object="text" data-key="5939"><span data-slate-leaf="true" data-offset-key="5939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"@every 1h30m"</span></span></span></span><span data-slate-object="text" data-key="5940"><span data-slate-leaf="true" data-offset-key="5940:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="5941"><span data-slate-leaf="true" data-offset-key="5941:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5942"><span data-slate-leaf="true" data-offset-key="5942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5943"><span data-slate-leaf="true" data-offset-key="5943:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5944"><span data-slate-object="text" data-key="5945"><span data-slate-leaf="true" data-offset-key="5945:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="5946"><span data-slate-leaf="true" data-offset-key="5946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Every hour thirty, starting an hour thirty from now"</span></span></span></span><span data-slate-object="text" data-key="5947"><span data-slate-leaf="true" data-offset-key="5947:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5948"><span data-slate-object="text" data-key="5949"><span data-slate-leaf="true" data-offset-key="5949:0" data-first-offset="true"><span data-slate-string="true">})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5950"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5951"><span data-slate-object="text" data-key="5952"><span data-slate-leaf="true" data-offset-key="5952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动 cron</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5953"><span data-slate-object="text" data-key="5954"><span data-slate-leaf="true" data-offset-key="5954:0" data-first-offset="true"><span data-slate-string="true">c.Start()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5955"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5956"><span data-slate-object="text" data-key="5957"><span data-slate-leaf="true" data-offset-key="5957:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5958"><span data-slate-object="text" data-key="5959"><span data-slate-leaf="true" data-offset-key="5959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在 cron 运行过程中增加任务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5960"><span data-slate-object="text" data-key="5961"><span data-slate-leaf="true" data-offset-key="5961:0" data-first-offset="true"><span data-slate-string="true">c.AddFunc(</span></span></span><span data-slate-object="text" data-key="5962"><span data-slate-leaf="true" data-offset-key="5962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"@daily"</span></span></span></span><span data-slate-object="text" data-key="5963"><span data-slate-leaf="true" data-offset-key="5963:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="5964"><span data-slate-leaf="true" data-offset-key="5964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="5965"><span data-slate-leaf="true" data-offset-key="5965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="5966"><span data-slate-leaf="true" data-offset-key="5966:0" data-first-offset="true"><span data-slate-string="true"> { fmt.Println(</span></span></span><span data-slate-object="text" data-key="5967"><span data-slate-leaf="true" data-offset-key="5967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Every day"</span></span></span></span><span data-slate-object="text" data-key="5968"><span data-slate-leaf="true" data-offset-key="5968:0" data-first-offset="true"><span data-slate-string="true">) })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5969"><span data-slate-object="text" data-key="5970"><span data-slate-leaf="true" data-offset-key="5970:0" data-first-offset="true"><span data-slate-string="true">..</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5971"><span data-slate-object="text" data-key="5972"><span data-slate-leaf="true" data-offset-key="5972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 查看运行中的任务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5973"><span data-slate-object="text" data-key="5974"><span data-slate-leaf="true" data-offset-key="5974:0" data-first-offset="true"><span data-slate-string="true">inspect(c.Entries())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5975"><span data-slate-object="text" data-key="5976"><span data-slate-leaf="true" data-offset-key="5976:0" data-first-offset="true"><span data-slate-string="true">..</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5977"><span data-slate-object="text" data-key="5978"><span data-slate-leaf="true" data-offset-key="5978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 停止 cron 的运行，优雅停止，所有正在运行中的任务不会停止。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5979"><span data-slate-object="text" data-key="5980"><span data-slate-leaf="true" data-offset-key="5980:0" data-first-offset="true"><span data-slate-string="true">c.Stop() </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5981"><span data-slate-object="text" data-key="5982"><span data-slate-leaf="true" data-offset-key="5982:0" data-first-offset="true"><span data-slate-string="true">这个例子充分展示了这个库的能力。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5983"><span data-slate-object="text" data-key="5984"><span data-slate-leaf="true" data-offset-key="5984:0" data-first-offset="true"><span data-slate-string="true">首先，它具有</span></span></span><span data-slate-object="text" data-key="5985"><span data-slate-leaf="true" data-offset-key="5985:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">极其丰富的 “时间描述语言”</span></span></span></span><span data-slate-object="text" data-key="5986"><span data-slate-leaf="true" data-offset-key="5986:0" data-first-offset="true"><span data-slate-string="true">。我们可以通过和 Linux 的 crontab 一样的语法，定义五个星号来表示在一天中的某个时间点，时间点的维度可以是分钟、小时、日、月、星期，也可以将这五个星号替换为不同维度的值或者范围。前两个例子就很好地展示了在每小时 30 分的时候，和在上午 3-6 点、下午 8-11 点的每 30 分钟的时候执行的方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5987"><span data-slate-object="text" data-key="5988"><span data-slate-leaf="true" data-offset-key="5988:0" data-first-offset="true"><span data-slate-string="true">而第三个例子，它定义了日本东京时区的某个时间点来执行，这个已经超出了 Linux 的 crontab 能力了。看第四、五个例子，它还能通过符号 @ 和非常语义化的 hourly、every 1h30m 的描述语句，来表示从现在开始的时间计算。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5989"><span data-slate-object="text" data-key="5990"><span data-slate-leaf="true" data-offset-key="5990:0" data-first-offset="true"><span data-slate-string="true">或许你会好奇这种神奇的时间描述语言是怎么实现的？可以看 cron 源码的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5991"><span data-slate-object="text" data-key="5992"><span data-slate-leaf="true" data-offset-key="5992:0" data-first-offset="true"><span data-slate-string="true">parser.go</span></span></span></a><span data-slate-object="text" data-key="5993"><span data-slate-leaf="true" data-offset-key="5993:0" data-first-offset="true"><span data-slate-string="true"> 文件。它的本质就是将字符串解析成为一个包含秒、分、小时等时间数据的结构 SpecSchedule。看下面的部分源码：（不是今天的重点，就不解释具体的字符串解析步骤了，有兴趣的同学可以自行查看完整源码）</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5994"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5995"><span data-slate-object="text" data-key="5996"><span data-slate-leaf="true" data-offset-key="5996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用来表示调度时间的一个结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5997"><span data-slate-object="text" data-key="5998"><span data-slate-leaf="true" data-offset-key="5998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="5999"><span data-slate-leaf="true" data-offset-key="5999:0" data-first-offset="true"><span data-slate-string="true"> SpecSchedule </span></span></span><span data-slate-object="text" data-key="6000"><span data-slate-leaf="true" data-offset-key="6000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="6001"><span data-slate-leaf="true" data-offset-key="6001:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6002"><span data-slate-object="text" data-key="6003"><span data-slate-leaf="true" data-offset-key="6003:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6004"><span data-slate-leaf="true" data-offset-key="6004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Dom 表示 dayOfMonth, 每个月的第几天</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6005"><span data-slate-object="text" data-key="6006"><span data-slate-leaf="true" data-offset-key="6006:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6007"><span data-slate-leaf="true" data-offset-key="6007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Dow 表示 dayOfWeek, 每个星期的第几天</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6008"><span data-slate-object="text" data-key="6009"><span data-slate-leaf="true" data-offset-key="6009:0" data-first-offset="true"><span data-slate-string="true">  Second, Minute, Hour, Dom, Month, Dow </span></span></span><span data-slate-object="text" data-key="6010"><span data-slate-leaf="true" data-offset-key="6010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6011"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6012"><span data-slate-object="text" data-key="6013"><span data-slate-leaf="true" data-offset-key="6013:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6014"><span data-slate-leaf="true" data-offset-key="6014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 时区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6015"><span data-slate-object="text" data-key="6016"><span data-slate-leaf="true" data-offset-key="6016:0" data-first-offset="true"><span data-slate-string="true">  Location *time.Location</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6017"><span data-slate-object="text" data-key="6018"><span data-slate-leaf="true" data-offset-key="6018:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6019"><span data-slate-object="text" data-key="6020"><span data-slate-leaf="true" data-offset-key="6020:0" data-first-offset="true"><span data-slate-string="true">你会发现 SpecSchedule 中有秒的时间字段，是的，这是我想介绍这个库的第二个强大能力：</span></span></span><span data-slate-object="text" data-key="6021"><span data-slate-leaf="true" data-offset-key="6021:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">支持秒级别的定时</span></span></span></span><span data-slate-object="text" data-key="6022"><span data-slate-leaf="true" data-offset-key="6022:0" data-first-offset="true"><span data-slate-string="true">。看下面的例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6023"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6024"><span data-slate-object="text" data-key="6025"><span data-slate-leaf="true" data-offset-key="6025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建一个 cron 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6026"><span data-slate-object="text" data-key="6027"><span data-slate-leaf="true" data-offset-key="6027:0" data-first-offset="true"><span data-slate-string="true">c := cron.New(cron.WithParser(cron.NewParser(cron.SecondOptional | cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow | cron.Descriptor)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6028"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6029"><span data-slate-object="text" data-key="6030"><span data-slate-leaf="true" data-offset-key="6030:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每秒执行一次</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6031"><span data-slate-object="text" data-key="6032"><span data-slate-leaf="true" data-offset-key="6032:0" data-first-offset="true"><span data-slate-string="true">c.AddFunc(</span></span></span><span data-slate-object="text" data-key="6033"><span data-slate-leaf="true" data-offset-key="6033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"* * * * * *"</span></span></span></span><span data-slate-object="text" data-key="6034"><span data-slate-leaf="true" data-offset-key="6034:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6035"><span data-slate-leaf="true" data-offset-key="6035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6036"><span data-slate-leaf="true" data-offset-key="6036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="6037"><span data-slate-leaf="true" data-offset-key="6037:0" data-first-offset="true"><span data-slate-string="true"> { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6038"><span data-slate-object="text" data-key="6039"><span data-slate-leaf="true" data-offset-key="6039:0" data-first-offset="true"><span data-slate-string="true">  fmt.Println(</span></span></span><span data-slate-object="text" data-key="6040"><span data-slate-leaf="true" data-offset-key="6040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Every hour on the half hour"</span></span></span></span><span data-slate-object="text" data-key="6041"><span data-slate-leaf="true" data-offset-key="6041:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6042"><span data-slate-object="text" data-key="6043"><span data-slate-leaf="true" data-offset-key="6043:0" data-first-offset="true"><span data-slate-string="true">})</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6044"><span data-slate-object="text" data-key="6045"><span data-slate-leaf="true" data-offset-key="6045:0" data-first-offset="true"><span data-slate-string="true">在初始化实例的时候使用 NewParser，设置了允许定时字符串支持秒级别的选项 cron.SecondOptional。这样，我们可以使用 6 个星号来表示在秒级别的时候调用一次。这个功能是很多第三方库，甚至 Linux 的 crontab 都做不到的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6046"><span data-slate-object="text" data-key="6047"><span data-slate-leaf="true" data-offset-key="6047:0" data-first-offset="true"><span data-slate-string="true">除了这两个强大的能力之外，cron 还支持动态增加定时任务、任务调用链等功能。不过这些功能暂时用不到，就不在这里介绍了。有兴趣的同学可以自己课后研究 cron 库的源码。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6048" id="sr-toc-3"><span data-slate-object="text" data-key="6049"><span data-slate-leaf="true" data-offset-key="6049:0" data-first-offset="true"><span data-slate-string="true">定时命令的思路与实现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6050"><span data-slate-object="text" data-key="6051"><span data-slate-leaf="true" data-offset-key="6051:0" data-first-offset="true"><span data-slate-string="true">我们下一步就是要考虑如何将 cron 库应用在 hade 框架中了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6052"><span data-slate-object="text" data-key="6053"><span data-slate-leaf="true" data-offset-key="6053:0" data-first-offset="true"><span data-slate-string="true">从使用角度开始思考，今天一开始我们说了，挑战只增加一行代码就能定时执行某个命令。那这个代码应该有两个参数，一是设置定时时间，二是定制执行的命令。就像这样：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6054"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6055"><span data-slate-object="text" data-key="6056"><span data-slate-leaf="true" data-offset-key="6056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每秒调用一次 Foo 命令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6057"><span data-slate-object="text" data-key="6058"><span data-slate-leaf="true" data-offset-key="6058:0" data-first-offset="true"><span data-slate-string="true">rootCmd.AddCronCommand(</span></span></span><span data-slate-object="text" data-key="6059"><span data-slate-leaf="true" data-offset-key="6059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"* * * * * *"</span></span></span></span><span data-slate-object="text" data-key="6060"><span data-slate-leaf="true" data-offset-key="6060:0" data-first-offset="true"><span data-slate-string="true">, demo.FooCommand)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6061"><span data-slate-object="text" data-key="6062"><span data-slate-leaf="true" data-offset-key="6062:0" data-first-offset="true"><span data-slate-string="true">第一个参数对应 cron 库中的 “时间描述语言”，第二个参数对应我们的 Command 结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6063"><span data-slate-object="text" data-key="6064"><span data-slate-leaf="true" data-offset-key="6064:0" data-first-offset="true"><span data-slate-string="true">从刚才的两个使用小例子能看到，在 cron 库中，增加一个定时任务的 AddFunc 方法，有两个参数：时间描述语言、匿名函数。那么明显，</span></span></span><span data-slate-object="text" data-key="6065"><span data-slate-leaf="true" data-offset-key="6065:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">AddCronCommand 函数中核心要做的，就是将 Command 结构的执行封装成一个匿名函数，再调用 cron 的 AddFunc 方法就可以了</span></span></span></span><span data-slate-object="text" data-key="6066"><span data-slate-leaf="true" data-offset-key="6066:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6067"><span data-slate-object="text" data-key="6068"><span data-slate-leaf="true" data-offset-key="6068:0" data-first-offset="true"><span data-slate-string="true">这里还有一个需要先解决的问题，cron 库需要初始化一个 Cron 对象，就是上面库例子中的 cron.New 方法创建的对象，这个 Cron 对象存放在哪里呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6069"><span data-slate-object="text" data-key="6070"><span data-slate-leaf="true" data-offset-key="6070:0" data-first-offset="true"><span data-slate-string="true">记得上一节课，我们将服务容器 container 存放在根 Command 中么，让所有的命令都可以通过 Root () 方法获取到根 Command，再获取到 container。那这里也可以如法炮制，将初始化的 Cron 对象放在根 Command 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6071"><span data-slate-object="text" data-key="6072"><span data-slate-leaf="true" data-offset-key="6072:0" data-first-offset="true"><span data-slate-string="true">所以，在框架目录的 framework/cobra/Command.go 中，我们对 Command 结构进行修改：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6073"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6074"><span data-slate-object="text" data-key="6075"><span data-slate-leaf="true" data-offset-key="6075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="6076"><span data-slate-leaf="true" data-offset-key="6076:0" data-first-offset="true"><span data-slate-string="true"> Command </span></span></span><span data-slate-object="text" data-key="6077"><span data-slate-leaf="true" data-offset-key="6077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="6078"><span data-slate-leaf="true" data-offset-key="6078:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6079"><span data-slate-object="text" data-key="6080"><span data-slate-leaf="true" data-offset-key="6080:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6081"><span data-slate-leaf="true" data-offset-key="6081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Command 支持 cron，只在 RootCommand 中有这个值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6082"><span data-slate-object="text" data-key="6083"><span data-slate-leaf="true" data-offset-key="6083:0" data-first-offset="true"><span data-slate-string="true">   Cron *cron.Cron</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6084"><span data-slate-object="text" data-key="6085"><span data-slate-leaf="true" data-offset-key="6085:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6086"><span data-slate-leaf="true" data-offset-key="6086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应 Cron 命令的信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6087"><span data-slate-object="text" data-key="6088"><span data-slate-leaf="true" data-offset-key="6088:0" data-first-offset="true"><span data-slate-string="true">   CronSpecs []CronSpec</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6089"><span data-slate-object="text" data-key="6090"><span data-slate-leaf="true" data-offset-key="6090:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6091"><span data-slate-object="text" data-key="6092"><span data-slate-leaf="true" data-offset-key="6092:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6093"><span data-slate-object="text" data-key="6094"><span data-slate-leaf="true" data-offset-key="6094:0" data-first-offset="true"><span data-slate-string="true">除了在根 Command 结构中放入 Cron 实例，我还放入了一个 CronSpecs 的数组，这个数组用来保存所有 Cron 命令的信息，为后续查看所有定时任务而准备。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6095"><span data-slate-object="text" data-key="6096"><span data-slate-leaf="true" data-offset-key="6096:0" data-first-offset="true"><span data-slate-string="true">思考清楚了这些，我们就能开始动手写 AddCronCommand 这个函数了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6097" id="sr-toc-4"><span data-slate-object="text" data-key="6098"><span data-slate-leaf="true" data-offset-key="6098:0" data-first-offset="true"><span data-slate-string="true">cron 的初始化和回调</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6099"><span data-slate-object="text" data-key="6100"><span data-slate-leaf="true" data-offset-key="6100:0" data-first-offset="true"><span data-slate-string="true">先获取根 Command，判断是否已经初始化了 Cron 实例，如果没有，就要初始化。接着，补充 Cron 命令的信息到 CronSpecs 数组中。最后封装一个匿名函数，在这个匿名函数中，我们将要执行的 Command 进行封装。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6101"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6102"><span data-slate-object="text" data-key="6103"><span data-slate-leaf="true" data-offset-key="6103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// AddCronCommand 是用来创建一个 Cron 任务的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6104"><span data-slate-object="text" data-key="6105"><span data-slate-leaf="true" data-offset-key="6105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6106"><span data-slate-leaf="true" data-offset-key="6106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6107"><span data-slate-leaf="true" data-offset-key="6107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *Command)</span></span></span></span></span><span data-slate-object="text" data-key="6108"><span data-slate-leaf="true" data-offset-key="6108:0" data-first-offset="true"><span data-slate-string="true"> AddCronCommand(spec </span></span></span><span data-slate-object="text" data-key="6109"><span data-slate-leaf="true" data-offset-key="6109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6110"><span data-slate-leaf="true" data-offset-key="6110:0" data-first-offset="true"><span data-slate-string="true">, cmd *Command) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6111"><span data-slate-object="text" data-key="6112"><span data-slate-leaf="true" data-offset-key="6112:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6113"><span data-slate-leaf="true" data-offset-key="6113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cron 结构是挂载在根 Command 上的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6114"><span data-slate-object="text" data-key="6115"><span data-slate-leaf="true" data-offset-key="6115:0" data-first-offset="true"><span data-slate-string="true">   root := c.Root()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6116"><span data-slate-object="text" data-key="6117"><span data-slate-leaf="true" data-offset-key="6117:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6118"><span data-slate-leaf="true" data-offset-key="6118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6119"><span data-slate-leaf="true" data-offset-key="6119:0" data-first-offset="true"><span data-slate-string="true"> root.Cron == </span></span></span><span data-slate-object="text" data-key="6120"><span data-slate-leaf="true" data-offset-key="6120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6121"><span data-slate-leaf="true" data-offset-key="6121:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6122"><span data-slate-object="text" data-key="6123"><span data-slate-leaf="true" data-offset-key="6123:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6124"><span data-slate-leaf="true" data-offset-key="6124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 cron</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6125"><span data-slate-object="text" data-key="6126"><span data-slate-leaf="true" data-offset-key="6126:0" data-first-offset="true"><span data-slate-string="true">      root.Cron = cron.New(cron.WithParser(cron.NewParser(cron.SecondOptional | cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow | cron.Descriptor)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6127"><span data-slate-object="text" data-key="6128"><span data-slate-leaf="true" data-offset-key="6128:0" data-first-offset="true"><span data-slate-string="true">      root.CronSpecs = []CronSpec{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6129"><span data-slate-object="text" data-key="6130"><span data-slate-leaf="true" data-offset-key="6130:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6131"><span data-slate-object="text" data-key="6132"><span data-slate-leaf="true" data-offset-key="6132:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6133"><span data-slate-leaf="true" data-offset-key="6133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 增加说明信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6134"><span data-slate-object="text" data-key="6135"><span data-slate-leaf="true" data-offset-key="6135:0" data-first-offset="true"><span data-slate-string="true">   root.CronSpecs = </span></span></span><span data-slate-object="text" data-key="6136"><span data-slate-leaf="true" data-offset-key="6136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="6137"><span data-slate-leaf="true" data-offset-key="6137:0" data-first-offset="true"><span data-slate-string="true">(root.CronSpecs, CronSpec{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6138"><span data-slate-object="text" data-key="6139"><span data-slate-leaf="true" data-offset-key="6139:0" data-first-offset="true"><span data-slate-string="true">      Type: </span></span></span><span data-slate-object="text" data-key="6140"><span data-slate-leaf="true" data-offset-key="6140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"normal-cron"</span></span></span></span><span data-slate-object="text" data-key="6141"><span data-slate-leaf="true" data-offset-key="6141:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6142"><span data-slate-object="text" data-key="6143"><span data-slate-leaf="true" data-offset-key="6143:0" data-first-offset="true"><span data-slate-string="true">      Cmd:  cmd,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6144"><span data-slate-object="text" data-key="6145"><span data-slate-leaf="true" data-offset-key="6145:0" data-first-offset="true"><span data-slate-string="true">      Spec: spec,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6146"><span data-slate-object="text" data-key="6147"><span data-slate-leaf="true" data-offset-key="6147:0" data-first-offset="true"><span data-slate-string="true">   })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6148"><span data-slate-object="text" data-key="6149"><span data-slate-leaf="true" data-offset-key="6149:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6150"><span data-slate-leaf="true" data-offset-key="6150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 制作一个 rootCommand</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6151"><span data-slate-object="text" data-key="6152"><span data-slate-leaf="true" data-offset-key="6152:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6153"><span data-slate-leaf="true" data-offset-key="6153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="6154"><span data-slate-leaf="true" data-offset-key="6154:0" data-first-offset="true"><span data-slate-string="true"> cronCmd Command</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6155"><span data-slate-object="text" data-key="6156"><span data-slate-leaf="true" data-offset-key="6156:0" data-first-offset="true"><span data-slate-string="true">   ctx := root.Context()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6157"><span data-slate-object="text" data-key="6158"><span data-slate-leaf="true" data-offset-key="6158:0" data-first-offset="true"><span data-slate-string="true">   cronCmd = *cmd</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6159"><span data-slate-object="text" data-key="6160"><span data-slate-leaf="true" data-offset-key="6160:0" data-first-offset="true"><span data-slate-string="true">   cronCmd.args = []</span></span></span><span data-slate-object="text" data-key="6161"><span data-slate-leaf="true" data-offset-key="6161:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6162"><span data-slate-leaf="true" data-offset-key="6162:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6163"><span data-slate-object="text" data-key="6164"><span data-slate-leaf="true" data-offset-key="6164:0" data-first-offset="true"><span data-slate-string="true">   cronCmd.SetParentNull()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6165"><span data-slate-object="text" data-key="6166"><span data-slate-leaf="true" data-offset-key="6166:0" data-first-offset="true"><span data-slate-string="true">   cronCmd.SetContainer(root.GetContainer())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6167"><span data-slate-object="text" data-key="6168"><span data-slate-leaf="true" data-offset-key="6168:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6169"><span data-slate-leaf="true" data-offset-key="6169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 增加调用函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6170"><span data-slate-object="text" data-key="6171"><span data-slate-leaf="true" data-offset-key="6171:0" data-first-offset="true"><span data-slate-string="true">   root.Cron.AddFunc(spec, </span></span></span><span data-slate-object="text" data-key="6172"><span data-slate-leaf="true" data-offset-key="6172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6173"><span data-slate-leaf="true" data-offset-key="6173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="6174"><span data-slate-leaf="true" data-offset-key="6174:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6175"><span data-slate-object="text" data-key="6176"><span data-slate-leaf="true" data-offset-key="6176:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6177"><span data-slate-leaf="true" data-offset-key="6177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果后续的 command 出现 panic，这里要捕获</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6178"><span data-slate-object="text" data-key="6179"><span data-slate-leaf="true" data-offset-key="6179:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6180"><span data-slate-leaf="true" data-offset-key="6180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="6181"><span data-slate-leaf="true" data-offset-key="6181:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6182"><span data-slate-leaf="true" data-offset-key="6182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6183"><span data-slate-leaf="true" data-offset-key="6183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="6184"><span data-slate-leaf="true" data-offset-key="6184:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6185"><span data-slate-object="text" data-key="6186"><span data-slate-leaf="true" data-offset-key="6186:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="6187"><span data-slate-leaf="true" data-offset-key="6187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6188"><span data-slate-leaf="true" data-offset-key="6188:0" data-first-offset="true"><span data-slate-string="true"> err := </span></span></span><span data-slate-object="text" data-key="6189"><span data-slate-leaf="true" data-offset-key="6189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">recover</span></span></span></span><span data-slate-object="text" data-key="6190"><span data-slate-leaf="true" data-offset-key="6190:0" data-first-offset="true"><span data-slate-string="true">(); err != </span></span></span><span data-slate-object="text" data-key="6191"><span data-slate-leaf="true" data-offset-key="6191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6192"><span data-slate-leaf="true" data-offset-key="6192:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6193"><span data-slate-object="text" data-key="6194"><span data-slate-leaf="true" data-offset-key="6194:0" data-first-offset="true"><span data-slate-string="true">            log.Println(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6195"><span data-slate-object="text" data-key="6196"><span data-slate-leaf="true" data-offset-key="6196:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6197"><span data-slate-object="text" data-key="6198"><span data-slate-leaf="true" data-offset-key="6198:0" data-first-offset="true"><span data-slate-string="true">      }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6199"><span data-slate-object="text" data-key="6200"><span data-slate-leaf="true" data-offset-key="6200:0" data-first-offset="true"><span data-slate-string="true">      err := cronCmd.ExecuteContext(ctx)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6201"><span data-slate-object="text" data-key="6202"><span data-slate-leaf="true" data-offset-key="6202:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6203"><span data-slate-leaf="true" data-offset-key="6203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6204"><span data-slate-leaf="true" data-offset-key="6204:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="6205"><span data-slate-leaf="true" data-offset-key="6205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6206"><span data-slate-leaf="true" data-offset-key="6206:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6207"><span data-slate-object="text" data-key="6208"><span data-slate-leaf="true" data-offset-key="6208:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="6209"><span data-slate-leaf="true" data-offset-key="6209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 打印出 err 信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6210"><span data-slate-object="text" data-key="6211"><span data-slate-leaf="true" data-offset-key="6211:0" data-first-offset="true"><span data-slate-string="true">         log.Println(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6212"><span data-slate-object="text" data-key="6213"><span data-slate-leaf="true" data-offset-key="6213:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6214"><span data-slate-object="text" data-key="6215"><span data-slate-leaf="true" data-offset-key="6215:0" data-first-offset="true"><span data-slate-string="true">   })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6216"><span data-slate-object="text" data-key="6217"><span data-slate-leaf="true" data-offset-key="6217:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6218"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6219"><span data-slate-object="text" data-key="6220"><span data-slate-leaf="true" data-offset-key="6220:0" data-first-offset="true"><span data-slate-string="true">这里有几个细节需要注意一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6221"><span data-slate-object="text" data-key="6222"><span data-slate-leaf="true" data-offset-key="6222:0" data-first-offset="true"><span data-slate-string="true">封装匿名函数的时候，要记得保证这个匿名函数不会抛出异常，因为在 cron 中，匿名函数是开启一个 Goroutine 来执行的，而在 Golang 中，每个 Goroutine 都是平等的，任何一个 Goroutine 出现 panic，都会导致整个进程中止。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6223"><span data-slate-object="text" data-key="6224"><span data-slate-leaf="true" data-offset-key="6224:0" data-first-offset="true"><span data-slate-string="true">另外在匿名函数中，封装的并不是传递进来的 Command，而是</span></span></span><span data-slate-object="text" data-key="6225"><span data-slate-leaf="true" data-offset-key="6225:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">把这个 Command 做了一个副本，并且将其父节点设置为空，让它自身就是一个新的根节点；然后调用这个 Command 的 Execute 方法</span></span></span></span><span data-slate-object="text" data-key="6226"><span data-slate-leaf="true" data-offset-key="6226:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6227"><span data-slate-object="text" data-key="6228"><span data-slate-leaf="true" data-offset-key="6228:0" data-first-offset="true"><span data-slate-string="true">这么做主要是因为我在调试过程中发现，cobra 库在执行任意一个 Command 的 Execute 系列方法时，都会从根 Command 开始，根据参数进行遍历查询。这是因为我们是通过定时器进行调用的，这个定时器调用并没有真正的控制台，如果希望找到这个 cronCmd，直接调用其 Execute 命令就行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6229"><span data-slate-object="text" data-key="6230"><span data-slate-leaf="true" data-offset-key="6230:0" data-first-offset="true"><span data-slate-string="true">所以在上面的代码里，复制了一个当前 Command 结构的 cronCmd，并且将其设置为根 Command，就是 SetParentNull () 函数，将其上游设置为空，就可以直接在定时器启动的时候调用这个 cronCmd 的 ExecuteCrontext 了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6231" id="sr-toc-5"><span data-slate-object="text" data-key="6232"><span data-slate-leaf="true" data-offset-key="6232:0" data-first-offset="true"><span data-slate-string="true">启动 cron 的思路与实现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6233"><span data-slate-object="text" data-key="6234"><span data-slate-leaf="true" data-offset-key="6234:0" data-first-offset="true"><span data-slate-string="true">好了，现在完成了 cron 的初始化和回调，下面要解决启动 cron 的时机了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6235"><span data-slate-object="text" data-key="6236"><span data-slate-leaf="true" data-offset-key="6236:0" data-first-offset="true"><span data-slate-string="true">上一节课我们将 main 函数修改为一个命令行调用，还将启动 Web 服务设计为一个子命令。那么类比到这里，启动 cron 服务也应该改造成为一个子命令。所以定义一个二级命令 cron，五个三级命令 start、stop、restart、list、state。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6237"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6238"><span data-slate-object="text" data-key="6239"><span data-slate-leaf="true" data-offset-key="6239:0" data-first-offset="true"><span data-slate-string="true"> ～: ./hade cron</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6240"><span data-slate-object="text" data-key="6241"><span data-slate-leaf="true" data-offset-key="6241:0" data-first-offset="true"><span data-slate-string="true">定时任务相关命令</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6242"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6243"><span data-slate-object="text" data-key="6244"><span data-slate-leaf="true" data-offset-key="6244:0" data-first-offset="true"><span data-slate-string="true">Usage:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6245"><span data-slate-object="text" data-key="6246"><span data-slate-leaf="true" data-offset-key="6246:0" data-first-offset="true"><span data-slate-string="true">  hade cron [flags]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6247"><span data-slate-object="text" data-key="6248"><span data-slate-leaf="true" data-offset-key="6248:0" data-first-offset="true"><span data-slate-string="true">  hade cron [command]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6249"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6250"><span data-slate-object="text" data-key="6251"><span data-slate-leaf="true" data-offset-key="6251:0" data-first-offset="true"><span data-slate-string="true">Available Commands:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6252"><span data-slate-object="text" data-key="6253"><span data-slate-leaf="true" data-offset-key="6253:0" data-first-offset="true"><span data-slate-string="true">  list        列出所有的定时任务</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6254"><span data-slate-object="text" data-key="6255"><span data-slate-leaf="true" data-offset-key="6255:0" data-first-offset="true"><span data-slate-string="true">  restart     重启 cron 常驻进程</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6256"><span data-slate-object="text" data-key="6257"><span data-slate-leaf="true" data-offset-key="6257:0" data-first-offset="true"><span data-slate-string="true">  start       启动 cron 常驻进程</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6258"><span data-slate-object="text" data-key="6259"><span data-slate-leaf="true" data-offset-key="6259:0" data-first-offset="true"><span data-slate-string="true">  state       cron 常驻进程状态</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6260"><span data-slate-object="text" data-key="6261"><span data-slate-leaf="true" data-offset-key="6261:0" data-first-offset="true"><span data-slate-string="true">  stop        停止 cron 常驻进程</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6262"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6263"><span data-slate-object="text" data-key="6264"><span data-slate-leaf="true" data-offset-key="6264:0" data-first-offset="true"><span data-slate-string="true">Flags:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6265"><span data-slate-object="text" data-key="6266"><span data-slate-leaf="true" data-offset-key="6266:0" data-first-offset="true"><span data-slate-string="true">  -h, --help   help </span></span></span><span data-slate-object="text" data-key="6267"><span data-slate-leaf="true" data-offset-key="6267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="6268"><span data-slate-leaf="true" data-offset-key="6268:0" data-first-offset="true"><span data-slate-string="true"> cron</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6269"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6270"><span data-slate-object="text" data-key="6271"><span data-slate-leaf="true" data-offset-key="6271:0" data-first-offset="true"><span data-slate-string="true">Use </span></span></span><span data-slate-object="text" data-key="6272"><span data-slate-leaf="true" data-offset-key="6272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hade cron [command] --help"</span></span></span></span><span data-slate-object="text" data-key="6273"><span data-slate-leaf="true" data-offset-key="6273:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6274"><span data-slate-leaf="true" data-offset-key="6274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="6275"><span data-slate-leaf="true" data-offset-key="6275:0" data-first-offset="true"><span data-slate-string="true"> more information about a command.</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6276"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6277"><span data-slate-object="text" data-key="6278"><span data-slate-leaf="true" data-offset-key="6278:0" data-first-offset="true"><span data-slate-string="true">这五个三级命令中最核心的就是启动 cron 的命令，我们就详细讲解这个命令，其他的大同小异，你可以课后对照 GitHub 补充。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6279"><span data-slate-object="text" data-key="6280"><span data-slate-leaf="true" data-offset-key="6280:0" data-first-offset="true"><span data-slate-string="true">在</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6281"><span data-slate-object="text" data-key="6282"><span data-slate-leaf="true" data-offset-key="6282:0" data-first-offset="true"><span data-slate-string="true">./hade cron start</span></span></span></span><span data-slate-object="text" data-key="6283"><span data-slate-leaf="true" data-offset-key="6283:0" data-first-offset="true"><span data-slate-string="true"> 这个命令中，必须要考虑的有两个问题：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6284"><span data-slate-object="text" data-key="6285"><span data-slate-leaf="true" data-offset-key="6285:0" data-first-offset="true"><span data-slate-string="true">首先，</span></span></span><span data-slate-object="text" data-key="6286"><span data-slate-leaf="true" data-offset-key="6286:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">我们希望使用 cron 的三级命令对某个进程进行管理</span></span></span></span><span data-slate-object="text" data-key="6287"><span data-slate-leaf="true" data-offset-key="6287:0" data-first-offset="true"><span data-slate-string="true">。想达到这个目的，获取这个被管理进程的 PID，并放入指定文件中非常重要，只有这样，才能在不同命令之间，通过获取这个 PID，来查询或者停止这个进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6288"><span data-slate-object="text" data-key="6289"><span data-slate-leaf="true" data-offset-key="6289:0" data-first-offset="true"><span data-slate-string="true">解决方案倒不难。获取当前进程，我们可以使用标准库 os</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6290"><span data-slate-object="text" data-key="6291"><span data-slate-leaf="true" data-offset-key="6291:0" data-first-offset="true"><span data-slate-string="true">os.GetPid()</span></span></span></span><span data-slate-object="text" data-key="6292"><span data-slate-leaf="true" data-offset-key="6292:0" data-first-offset="true"><span data-slate-string="true"> 。而 PID 的存放目录，之前在第 12 节课中定义服务目录的时候，有一个 runtimeFolder 是存放当前运行状态文件的，可以把 cron 进程的 PID 存放在这个目录中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6293"><span data-slate-object="text" data-key="6294"><span data-slate-leaf="true" data-offset-key="6294:0" data-first-offset="true"><span data-slate-string="true">其次，在启动常驻进程的时候，</span></span><span data-slate-leaf="true" data-offset-key="6294:1"><span data-slate-object="annotation" data-annotation-key="gkann_349b0f9d" data-attr-id="41720" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们可能以直接挂起进程的方式启动，也可能以后台 deamon 的方式启动，</span></span></span><span data-slate-leaf="true" data-offset-key="6294:2"><span data-slate-string="true">所以对于 </span></span></span><span data-slate-object="text" data-key="6295"><span data-slate-leaf="true" data-offset-key="6295:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">start 的命令最好能支持两种形态</span></span></span></span><span data-slate-object="text" data-key="6296"><span data-slate-leaf="true" data-offset-key="6296:0" data-first-offset="true"><span data-slate-string="true">。这两种形态可以通过一个参数进行区分，在文件 framework/command/cron.go 中增加 deamon 参数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6297"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6298"><span data-slate-object="text" data-key="6299"><span data-slate-leaf="true" data-offset-key="6299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//start 命令有一个 deamon 参数，简写为 d</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6300"><span data-slate-object="text" data-key="6301"><span data-slate-leaf="true" data-offset-key="6301:0" data-first-offset="true"><span data-slate-string="true">cronStartCommand.Flags().BoolVarP(&amp;cronDeamon, </span></span></span><span data-slate-object="text" data-key="6302"><span data-slate-leaf="true" data-offset-key="6302:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"deamon"</span></span></span></span><span data-slate-object="text" data-key="6303"><span data-slate-leaf="true" data-offset-key="6303:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6304"><span data-slate-leaf="true" data-offset-key="6304:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"d"</span></span></span></span><span data-slate-object="text" data-key="6305"><span data-slate-leaf="true" data-offset-key="6305:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6306"><span data-slate-leaf="true" data-offset-key="6306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="6307"><span data-slate-leaf="true" data-offset-key="6307:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6308"><span data-slate-leaf="true" data-offset-key="6308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"start serve deamon"</span></span></span></span><span data-slate-object="text" data-key="6309"><span data-slate-leaf="true" data-offset-key="6309:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6310"><span data-slate-object="text" data-key="6311"><span data-slate-leaf="true" data-offset-key="6311:0" data-first-offset="true"><span data-slate-string="true">直接挂起的逻辑比较简单，就是直接调用 cron 的 Run 函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6312"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6313"><span data-slate-object="text" data-key="6314"><span data-slate-leaf="true" data-offset-key="6314:0" data-first-offset="true"><span data-slate-string="true">c.Root().Cron.Run()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6315"><span data-slate-object="text" data-key="6316"><span data-slate-leaf="true" data-offset-key="6316:0" data-first-offset="true"><span data-slate-string="true">那么如何以 deamon 方式后台运行一个命令呢？或许你的第一反应是直接进行系统调用 fork 行不行？但是要告诉你，不行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6317"><span data-slate-object="text" data-key="6318"><span data-slate-leaf="true" data-offset-key="6318:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_85448a32" data-attr-id="32935" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">因为在 Golang 中，fork 可以启动一个子进程，但是这个子进程是无法继承父进程的调度模型的。</span></span></span></span><span data-slate-object="text" data-key="6319"><span data-slate-leaf="true" data-offset-key="6319:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_85448a32" data-attr-id="32935" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Golang 的调度模型是在用户态的 runtime 中自己进行调度的，而系统调用 fork 出来的子进程默认只会有单线程</span></span></span></span></span><span data-slate-object="text" data-key="6320"><span data-slate-leaf="true" data-offset-key="6320:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_85448a32" data-attr-id="32935" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。所以在 Golang 中尽量不要使用 fork 的方式来复制启动当前进程。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6321"><span data-slate-object="text" data-key="6322"><span data-slate-leaf="true" data-offset-key="6322:0" data-first-offset="true"><span data-slate-string="true">这里，实际上希望能 fork 出一个同样有运行到当前代码 Go 环境的进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6323"><span data-slate-object="text" data-key="6324"><span data-slate-leaf="true" data-offset-key="6324:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">另一个办法是使用 os.StartProcess 来启动一个进程，执行当前进程相同的二进制文件以及当前进程相同的参数</span></span></span></span><span data-slate-object="text" data-key="6325"><span data-slate-leaf="true" data-offset-key="6325:0" data-first-offset="true"><span data-slate-string="true">。同时，由于二进制文件相同，还要为启动的子进程单独配置一个环境变量，这样在生成二进制文件的代码中，就能根据环境变量区分是主进程还是子进程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6326"><span data-slate-object="text" data-key="6327"><span data-slate-leaf="true" data-offset-key="6327:0" data-first-offset="true"><span data-slate-string="true">这里整个启动子进程的方法在开源社区已经有封装好的了 —— 开源库 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6328"><span data-slate-object="text" data-key="6329"><span data-slate-leaf="true" data-offset-key="6329:0" data-first-offset="true"><span data-slate-string="true">go-daemon</span></span></span></a><span data-slate-object="text" data-key="6330"><span data-slate-leaf="true" data-offset-key="6330:0" data-first-offset="true"><span data-slate-string="true">。这个开源库目前 star 数有 1.5k，采用 MIT 的 licence，是现在比较流行的将进程 deamon 化的库了。它的原理和上面分析的是一样的，我们看下使用思路。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6331"><span data-slate-object="text" data-key="6332"><span data-slate-leaf="true" data-offset-key="6332:0" data-first-offset="true"><span data-slate-string="true">这个库会初始化一个 daemon.Context 结构，在这个结构中可以设置子进程的参数、环境变量、PID 生成的文件、输出日志生成的文件、权限等。然后调用一个 Reborn 方法启动一个子进程，这个 Reborn 除了 error 之外，还有一个返回值 os.Process，如果非空，代表当前为父进程，能从这个方法获取子进程信息，如果为空，代表当前为子进程。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6333" id="sr-toc-6"><span data-slate-object="text" data-key="6334"><span data-slate-leaf="true" data-offset-key="6334:0" data-first-offset="true"><span data-slate-string="true">启动 cron 的实现</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6335"><span data-slate-object="text" data-key="6336"><span data-slate-leaf="true" data-offset-key="6336:0" data-first-offset="true"><span data-slate-string="true">现在启动 cron 命令的两个实现关键点都考虑清楚了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6337"><span data-slate-object="text" data-key="6338"><span data-slate-leaf="true" data-offset-key="6338:0" data-first-offset="true"><span data-slate-string="true">结合我们当前的需求，要启动一个子进程，命令为：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6339"><span data-slate-object="text" data-key="6340"><span data-slate-leaf="true" data-offset-key="6340:0" data-first-offset="true"><span data-slate-string="true">./hade cron start --deamon=true</span></span></span></span><span data-slate-object="text" data-key="6341"><span data-slate-leaf="true" data-offset-key="6341:0" data-first-offset="true"><span data-slate-string="true">，这个子进程会运行 cron.Run，子进程 PID 写入 runtimeFolder 目录下，子进程日志打印在 logFolder 目录下。而父进程打印成功信息，直接返回，不做任何操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6342"><span data-slate-object="text" data-key="6343"><span data-slate-leaf="true" data-offset-key="6343:0" data-first-offset="true"><span data-slate-string="true">代码 framework/command/cron.go 中的 cronStartCommand 核心逻辑如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6344"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6345"><span data-slate-object="text" data-key="6346"><span data-slate-leaf="true" data-offset-key="6346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//deamon 模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6347"><span data-slate-object="text" data-key="6348"><span data-slate-leaf="true" data-offset-key="6348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6349"><span data-slate-leaf="true" data-offset-key="6349:0" data-first-offset="true"><span data-slate-string="true"> cronDeamon {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6350"><span data-slate-object="text" data-key="6351"><span data-slate-leaf="true" data-offset-key="6351:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6352"><span data-slate-leaf="true" data-offset-key="6352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建一个 Context</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6353"><span data-slate-object="text" data-key="6354"><span data-slate-leaf="true" data-offset-key="6354:0" data-first-offset="true"><span data-slate-string="true">   cntxt := &amp;daemon.Context{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6355"><span data-slate-object="text" data-key="6356"><span data-slate-leaf="true" data-offset-key="6356:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6357"><span data-slate-leaf="true" data-offset-key="6357:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置 pid 文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6358"><span data-slate-object="text" data-key="6359"><span data-slate-leaf="true" data-offset-key="6359:0" data-first-offset="true"><span data-slate-string="true">      PidFileName: serverPidFile,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6360"><span data-slate-object="text" data-key="6361"><span data-slate-leaf="true" data-offset-key="6361:0" data-first-offset="true"><span data-slate-string="true">      PidFilePerm: </span></span></span><span data-slate-object="text" data-key="6362"><span data-slate-leaf="true" data-offset-key="6362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0664</span></span></span></span><span data-slate-object="text" data-key="6363"><span data-slate-leaf="true" data-offset-key="6363:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6364"><span data-slate-object="text" data-key="6365"><span data-slate-leaf="true" data-offset-key="6365:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6366"><span data-slate-leaf="true" data-offset-key="6366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置日志文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6367"><span data-slate-object="text" data-key="6368"><span data-slate-leaf="true" data-offset-key="6368:0" data-first-offset="true"><span data-slate-string="true">      LogFileName: serverLogFile,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6369"><span data-slate-object="text" data-key="6370"><span data-slate-leaf="true" data-offset-key="6370:0" data-first-offset="true"><span data-slate-string="true">      LogFilePerm: </span></span></span><span data-slate-object="text" data-key="6371"><span data-slate-leaf="true" data-offset-key="6371:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0640</span></span></span></span><span data-slate-object="text" data-key="6372"><span data-slate-leaf="true" data-offset-key="6372:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6373"><span data-slate-object="text" data-key="6374"><span data-slate-leaf="true" data-offset-key="6374:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6375"><span data-slate-leaf="true" data-offset-key="6375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置工作路径</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6376"><span data-slate-object="text" data-key="6377"><span data-slate-leaf="true" data-offset-key="6377:0" data-first-offset="true"><span data-slate-string="true">      WorkDir: currentFolder,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6378"><span data-slate-object="text" data-key="6379"><span data-slate-leaf="true" data-offset-key="6379:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6380"><span data-slate-leaf="true" data-offset-key="6380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置所有设置文件的 mask，默认为 750</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6381"><span data-slate-object="text" data-key="6382"><span data-slate-leaf="true" data-offset-key="6382:0" data-first-offset="true"><span data-slate-string="true">      Umask: </span></span></span><span data-slate-object="text" data-key="6383"><span data-slate-leaf="true" data-offset-key="6383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">027</span></span></span></span><span data-slate-object="text" data-key="6384"><span data-slate-leaf="true" data-offset-key="6384:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6385"><span data-slate-object="text" data-key="6386"><span data-slate-leaf="true" data-offset-key="6386:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6387"><span data-slate-leaf="true" data-offset-key="6387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 子进程的参数，按照这个参数设置，子进程的命令为 ./hade cron start --deamon=true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6388"><span data-slate-object="text" data-key="6389"><span data-slate-leaf="true" data-offset-key="6389:0" data-first-offset="true"><span data-slate-string="true">      Args: []</span></span></span><span data-slate-object="text" data-key="6390"><span data-slate-leaf="true" data-offset-key="6390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6391"><span data-slate-leaf="true" data-offset-key="6391:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="6392"><span data-slate-leaf="true" data-offset-key="6392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="6393"><span data-slate-leaf="true" data-offset-key="6393:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6394"><span data-slate-leaf="true" data-offset-key="6394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cron"</span></span></span></span><span data-slate-object="text" data-key="6395"><span data-slate-leaf="true" data-offset-key="6395:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6396"><span data-slate-leaf="true" data-offset-key="6396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"start"</span></span></span></span><span data-slate-object="text" data-key="6397"><span data-slate-leaf="true" data-offset-key="6397:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6398"><span data-slate-leaf="true" data-offset-key="6398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"--deamon=true"</span></span></span></span><span data-slate-object="text" data-key="6399"><span data-slate-leaf="true" data-offset-key="6399:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6400"><span data-slate-object="text" data-key="6401"><span data-slate-leaf="true" data-offset-key="6401:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6402"><span data-slate-object="text" data-key="6403"><span data-slate-leaf="true" data-offset-key="6403:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6404"><span data-slate-leaf="true" data-offset-key="6404:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动子进程，d 不为空表示当前是父进程，d 为空表示当前是子进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6405"><span data-slate-object="text" data-key="6406"><span data-slate-leaf="true" data-offset-key="6406:0" data-first-offset="true"><span data-slate-string="true">   d, err := cntxt.Reborn()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6407"><span data-slate-object="text" data-key="6408"><span data-slate-leaf="true" data-offset-key="6408:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6409"><span data-slate-leaf="true" data-offset-key="6409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6410"><span data-slate-leaf="true" data-offset-key="6410:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="6411"><span data-slate-leaf="true" data-offset-key="6411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6412"><span data-slate-leaf="true" data-offset-key="6412:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6413"><span data-slate-object="text" data-key="6414"><span data-slate-leaf="true" data-offset-key="6414:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6415"><span data-slate-leaf="true" data-offset-key="6415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6416"><span data-slate-leaf="true" data-offset-key="6416:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6417"><span data-slate-object="text" data-key="6418"><span data-slate-leaf="true" data-offset-key="6418:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6419"><span data-slate-object="text" data-key="6420"><span data-slate-leaf="true" data-offset-key="6420:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6421"><span data-slate-leaf="true" data-offset-key="6421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6422"><span data-slate-leaf="true" data-offset-key="6422:0" data-first-offset="true"><span data-slate-string="true"> d != </span></span></span><span data-slate-object="text" data-key="6423"><span data-slate-leaf="true" data-offset-key="6423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6424"><span data-slate-leaf="true" data-offset-key="6424:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6425"><span data-slate-object="text" data-key="6426"><span data-slate-leaf="true" data-offset-key="6426:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6427"><span data-slate-leaf="true" data-offset-key="6427:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 父进程直接打印启动成功信息，不做任何操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6428"><span data-slate-object="text" data-key="6429"><span data-slate-leaf="true" data-offset-key="6429:0" data-first-offset="true"><span data-slate-string="true">      fmt.Println(</span></span></span><span data-slate-object="text" data-key="6430"><span data-slate-leaf="true" data-offset-key="6430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cron serve started, pid:"</span></span></span></span><span data-slate-object="text" data-key="6431"><span data-slate-leaf="true" data-offset-key="6431:0" data-first-offset="true"><span data-slate-string="true">, d.Pid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6432"><span data-slate-object="text" data-key="6433"><span data-slate-leaf="true" data-offset-key="6433:0" data-first-offset="true"><span data-slate-string="true">      fmt.Println(</span></span></span><span data-slate-object="text" data-key="6434"><span data-slate-leaf="true" data-offset-key="6434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"log file:"</span></span></span></span><span data-slate-object="text" data-key="6435"><span data-slate-leaf="true" data-offset-key="6435:0" data-first-offset="true"><span data-slate-string="true">, serverLogFile)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6436"><span data-slate-object="text" data-key="6437"><span data-slate-leaf="true" data-offset-key="6437:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6438"><span data-slate-leaf="true" data-offset-key="6438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6439"><span data-slate-leaf="true" data-offset-key="6439:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6440"><span data-slate-leaf="true" data-offset-key="6440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6441"><span data-slate-object="text" data-key="6442"><span data-slate-leaf="true" data-offset-key="6442:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6443"><span data-slate-object="text" data-key="6444"><span data-slate-leaf="true" data-offset-key="6444:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6445"><span data-slate-leaf="true" data-offset-key="6445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 子进程执行 Cron.Run</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6446"><span data-slate-object="text" data-key="6447"><span data-slate-leaf="true" data-offset-key="6447:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6448"><span data-slate-leaf="true" data-offset-key="6448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="6449"><span data-slate-leaf="true" data-offset-key="6449:0" data-first-offset="true"><span data-slate-string="true"> cntxt.Release()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6450"><span data-slate-object="text" data-key="6451"><span data-slate-leaf="true" data-offset-key="6451:0" data-first-offset="true"><span data-slate-string="true">   fmt.Println(</span></span></span><span data-slate-object="text" data-key="6452"><span data-slate-leaf="true" data-offset-key="6452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"deamon started"</span></span></span></span><span data-slate-object="text" data-key="6453"><span data-slate-leaf="true" data-offset-key="6453:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6454"><span data-slate-object="text" data-key="6455"><span data-slate-leaf="true" data-offset-key="6455:0" data-first-offset="true"><span data-slate-string="true">   gspt.SetProcTitle(</span></span></span><span data-slate-object="text" data-key="6456"><span data-slate-leaf="true" data-offset-key="6456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hade cron"</span></span></span></span><span data-slate-object="text" data-key="6457"><span data-slate-leaf="true" data-offset-key="6457:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6458"><span data-slate-object="text" data-key="6459"><span data-slate-leaf="true" data-offset-key="6459:0" data-first-offset="true"><span data-slate-string="true">   c.Root().Cron.Run()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6460"><span data-slate-object="text" data-key="6461"><span data-slate-leaf="true" data-offset-key="6461:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6462"><span data-slate-leaf="true" data-offset-key="6462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6463"><span data-slate-leaf="true" data-offset-key="6463:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6464"><span data-slate-leaf="true" data-offset-key="6464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6465"><span data-slate-object="text" data-key="6466"><span data-slate-leaf="true" data-offset-key="6466:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6467"><span data-slate-object="text" data-key="6468"><span data-slate-leaf="true" data-offset-key="6468:0" data-first-offset="true"><span data-slate-string="true">整体实现可以参考 GitHub 中当前章节的分支。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6469"><span data-slate-object="text" data-key="6470"><span data-slate-leaf="true" data-offset-key="6470:0" data-first-offset="true"><span data-slate-string="true">下面验证一下前面对定时任务的改造是否成功。先在业务 app/console/command/demo/foo.go 中创建一个 Foo 命令，它的执行行为就是打印一行字符 “execute foo command”：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6471"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6472"><span data-slate-object="text" data-key="6473"><span data-slate-leaf="true" data-offset-key="6473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// FooCommand 代表 Foo 命令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6474"><span data-slate-object="text" data-key="6475"><span data-slate-leaf="true" data-offset-key="6475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="6476"><span data-slate-leaf="true" data-offset-key="6476:0" data-first-offset="true"><span data-slate-string="true"> FooCommand = &amp;cobra.Command{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6477"><span data-slate-object="text" data-key="6478"><span data-slate-leaf="true" data-offset-key="6478:0" data-first-offset="true"><span data-slate-string="true">   Use:     </span></span></span><span data-slate-object="text" data-key="6479"><span data-slate-leaf="true" data-offset-key="6479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo"</span></span></span></span><span data-slate-object="text" data-key="6480"><span data-slate-leaf="true" data-offset-key="6480:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6481"><span data-slate-object="text" data-key="6482"><span data-slate-leaf="true" data-offset-key="6482:0" data-first-offset="true"><span data-slate-string="true">   Short:   </span></span></span><span data-slate-object="text" data-key="6483"><span data-slate-leaf="true" data-offset-key="6483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo 的简要说明"</span></span></span></span><span data-slate-object="text" data-key="6484"><span data-slate-leaf="true" data-offset-key="6484:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6485"><span data-slate-object="text" data-key="6486"><span data-slate-leaf="true" data-offset-key="6486:0" data-first-offset="true"><span data-slate-string="true">   Long:    </span></span></span><span data-slate-object="text" data-key="6487"><span data-slate-leaf="true" data-offset-key="6487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo 的长说明"</span></span></span></span><span data-slate-object="text" data-key="6488"><span data-slate-leaf="true" data-offset-key="6488:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6489"><span data-slate-object="text" data-key="6490"><span data-slate-leaf="true" data-offset-key="6490:0" data-first-offset="true"><span data-slate-string="true">   Aliases: []</span></span></span><span data-slate-object="text" data-key="6491"><span data-slate-leaf="true" data-offset-key="6491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6492"><span data-slate-leaf="true" data-offset-key="6492:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="6493"><span data-slate-leaf="true" data-offset-key="6493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fo"</span></span></span></span><span data-slate-object="text" data-key="6494"><span data-slate-leaf="true" data-offset-key="6494:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6495"><span data-slate-leaf="true" data-offset-key="6495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"f"</span></span></span></span><span data-slate-object="text" data-key="6496"><span data-slate-leaf="true" data-offset-key="6496:0" data-first-offset="true"><span data-slate-string="true">},</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6497"><span data-slate-object="text" data-key="6498"><span data-slate-leaf="true" data-offset-key="6498:0" data-first-offset="true"><span data-slate-string="true">   Example: </span></span></span><span data-slate-object="text" data-key="6499"><span data-slate-leaf="true" data-offset-key="6499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo 命令的例子"</span></span></span></span><span data-slate-object="text" data-key="6500"><span data-slate-leaf="true" data-offset-key="6500:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6501"><span data-slate-object="text" data-key="6502"><span data-slate-leaf="true" data-offset-key="6502:0" data-first-offset="true"><span data-slate-string="true">   RunE: </span></span></span><span data-slate-object="text" data-key="6503"><span data-slate-leaf="true" data-offset-key="6503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6504"><span data-slate-leaf="true" data-offset-key="6504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *cobra.Command, args []</span></span></span></span></span><span data-slate-object="text" data-key="6505"><span data-slate-leaf="true" data-offset-key="6505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="6506"><span data-slate-leaf="true" data-offset-key="6506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="6507"><span data-slate-leaf="true" data-offset-key="6507:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6508"><span data-slate-leaf="true" data-offset-key="6508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="6509"><span data-slate-leaf="true" data-offset-key="6509:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6510"><span data-slate-object="text" data-key="6511"><span data-slate-leaf="true" data-offset-key="6511:0" data-first-offset="true"><span data-slate-string="true">      log.Println(</span></span></span><span data-slate-object="text" data-key="6512"><span data-slate-leaf="true" data-offset-key="6512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"execute foo command"</span></span></span></span><span data-slate-object="text" data-key="6513"><span data-slate-leaf="true" data-offset-key="6513:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6514"><span data-slate-object="text" data-key="6515"><span data-slate-leaf="true" data-offset-key="6515:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6516"><span data-slate-leaf="true" data-offset-key="6516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6517"><span data-slate-leaf="true" data-offset-key="6517:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6518"><span data-slate-leaf="true" data-offset-key="6518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6519"><span data-slate-object="text" data-key="6520"><span data-slate-leaf="true" data-offset-key="6520:0" data-first-offset="true"><span data-slate-string="true">   },</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6521"><span data-slate-object="text" data-key="6522"><span data-slate-leaf="true" data-offset-key="6522:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6523"><span data-slate-object="text" data-key="6524"><span data-slate-leaf="true" data-offset-key="6524:0" data-first-offset="true"><span data-slate-string="true">然后将这个 FooCommand，通过 AddCronCommand 绑定到根 Command 中，并且设置其调用时间为每秒调用一次。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6525"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6526"><span data-slate-object="text" data-key="6527"><span data-slate-leaf="true" data-offset-key="6527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 绑定业务的命令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6528"><span data-slate-object="text" data-key="6529"><span data-slate-leaf="true" data-offset-key="6529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6530"><span data-slate-leaf="true" data-offset-key="6530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6531"><span data-slate-leaf="true" data-offset-key="6531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AddAppCommand</span></span></span></span></span><span data-slate-object="text" data-key="6532"><span data-slate-leaf="true" data-offset-key="6532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(rootCmd *cobra.Command)</span></span></span></span></span><span data-slate-object="text" data-key="6533"><span data-slate-leaf="true" data-offset-key="6533:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6534"><span data-slate-object="text" data-key="6535"><span data-slate-leaf="true" data-offset-key="6535:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6536"><span data-slate-leaf="true" data-offset-key="6536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每秒调用一次 Foo 命令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6537"><span data-slate-object="text" data-key="6538"><span data-slate-leaf="true" data-offset-key="6538:0" data-first-offset="true"><span data-slate-string="true">   rootCmd.AddCronCommand(</span></span></span><span data-slate-object="text" data-key="6539"><span data-slate-leaf="true" data-offset-key="6539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"* * * * * *"</span></span></span></span><span data-slate-object="text" data-key="6540"><span data-slate-leaf="true" data-offset-key="6540:0" data-first-offset="true"><span data-slate-string="true">, demo.FooCommand)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6541"><span data-slate-object="text" data-key="6542"><span data-slate-leaf="true" data-offset-key="6542:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6543"><span data-slate-object="text" data-key="6544"><span data-slate-leaf="true" data-offset-key="6544:0" data-first-offset="true"><span data-slate-string="true">启动三级命令行工具</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6545"><span data-slate-object="text" data-key="6546"><span data-slate-leaf="true" data-offset-key="6546:0" data-first-offset="true"><span data-slate-string="true">./hade cron start -d</span></span></span></span><span data-slate-object="text" data-key="6547"><span data-slate-leaf="true" data-offset-key="6547:0" data-first-offset="true"><span data-slate-string="true">，看到控制台打印出了子进程 PID 信息，和日志存储地址。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6548"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/86/44/869bc53899f491456ed408c5519b9544.png?wh=520x73"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6549"><span data-slate-object="text" data-key="6550"><span data-slate-leaf="true" data-offset-key="6550:0" data-first-offset="true"><span data-slate-string="true">使用 tail 命令查看日志，可以看到确实是每秒执行打印一次字符串：execute foo command</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6551"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/fd/41/fd8a17e32yy2e296f0ae2fde92760d41.png?wh=871x169"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6552"><span data-slate-object="text" data-key="6553"><span data-slate-leaf="true" data-offset-key="6553:0" data-first-offset="true"><span data-slate-string="true">到这里，我们对框架的定时命令改造就完成了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6554" id="sr-toc-7"><span data-slate-object="text" data-key="6555"><span data-slate-leaf="true" data-offset-key="6555:0" data-first-offset="true"><span data-slate-string="true">如何实现分布式定时器</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6556"><span data-slate-object="text" data-key="6557"><span data-slate-leaf="true" data-offset-key="6557:0" data-first-offset="true"><span data-slate-string="true">但现在的定时器还是单机版本的定时器，容灾性很低，如果有很多定时任务都挂载在一个进程中，一旦这个进程或者这个机器出现灾难性不可恢复，那么定时任务就直接无法运行了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6558"><span data-slate-object="text" data-key="6559"><span data-slate-leaf="true" data-offset-key="6559:0" data-first-offset="true"><span data-slate-string="true">容灾性更高的是分布式定时器。也就是很多机器都同时挂载定时任务，在同一时间都启动任务，只有一台机器能抢占到这个定时任务并且执行，其他机器由于抢占不到定时任务，不执行任何操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6560"><span data-slate-object="text" data-key="6561"><span data-slate-leaf="true" data-offset-key="6561:0" data-first-offset="true"><span data-slate-string="true">我们的框架也能做到这个分布式定时器的功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6562"><span data-slate-object="text" data-key="6563"><span data-slate-leaf="true" data-offset-key="6563:0" data-first-offset="true"><span data-slate-string="true">这种分布式定时器如何实现呢？你第一个想到的是不是使用 Redis？我们用 Redis 做一个分布式锁，然后所有进程去抢占这个锁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6564"><span data-slate-object="text" data-key="6565"><span data-slate-leaf="true" data-offset-key="6565:0" data-first-offset="true"><span data-slate-string="true">还是这样思考问题就比较低层次了。在第十、十一章，我们花了大量的篇幅讲了面向接口编程的思想，这里就可以用到这个思想。</span></span></span><span data-slate-object="text" data-key="6566"><span data-slate-leaf="true" data-offset-key="6566:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">先定义接口，这个接口的功能是一个分布式的选择器，当有很多节点要执行某个服务的时候，只选择出其中一个节点</span></span></span></span><span data-slate-object="text" data-key="6567"><span data-slate-leaf="true" data-offset-key="6567:0" data-first-offset="true"><span data-slate-string="true">。这样不管底层是否用 Redis 实现分布式选择器，在业务层我们都可以不用关心。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6568"><span data-slate-object="text" data-key="6569"><span data-slate-leaf="true" data-offset-key="6569:0" data-first-offset="true"><span data-slate-string="true">在文件 framework/contract/distributed.go 文件中。我们先定义接口 Distributed。其中有一个分布式选举方法 Select。它的参数有三个，serviceName 代表服务名字、appID 代表节点的 ID、holdTime 表示这个选择结果持续多久，也就是在选举出来之后多久内有效。它返回两个值，selectAppID 表示选举的结果，即最终哪个节点被选举出来了，另一个返回值 error 表示异常。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6570"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6571"><span data-slate-object="text" data-key="6572"><span data-slate-leaf="true" data-offset-key="6572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="6573"><span data-slate-leaf="true" data-offset-key="6573:0" data-first-offset="true"><span data-slate-string="true"> contract</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6574"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6575"><span data-slate-object="text" data-key="6576"><span data-slate-leaf="true" data-offset-key="6576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="6577"><span data-slate-leaf="true" data-offset-key="6577:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6578"><span data-slate-leaf="true" data-offset-key="6578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"time"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6579"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6580"><span data-slate-object="text" data-key="6581"><span data-slate-leaf="true" data-offset-key="6581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// DistributedKey 定义字符串凭证</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6582"><span data-slate-object="text" data-key="6583"><span data-slate-leaf="true" data-offset-key="6583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="6584"><span data-slate-leaf="true" data-offset-key="6584:0" data-first-offset="true"><span data-slate-string="true"> DistributedKey = </span></span></span><span data-slate-object="text" data-key="6585"><span data-slate-leaf="true" data-offset-key="6585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hade:distributed"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6586"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6587"><span data-slate-object="text" data-key="6588"><span data-slate-leaf="true" data-offset-key="6588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Distributed 分布式服务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6589"><span data-slate-object="text" data-key="6590"><span data-slate-leaf="true" data-offset-key="6590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="6591"><span data-slate-leaf="true" data-offset-key="6591:0" data-first-offset="true"><span data-slate-string="true"> Distributed </span></span></span><span data-slate-object="text" data-key="6592"><span data-slate-leaf="true" data-offset-key="6592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="6593"><span data-slate-leaf="true" data-offset-key="6593:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6594"><span data-slate-object="text" data-key="6595"><span data-slate-leaf="true" data-offset-key="6595:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6596"><span data-slate-leaf="true" data-offset-key="6596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Select 分布式选择器，所有节点对某个服务进行抢占，只选择其中一个节点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6597"><span data-slate-object="text" data-key="6598"><span data-slate-leaf="true" data-offset-key="6598:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6599"><span data-slate-leaf="true" data-offset-key="6599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ServiceName 服务名字</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6600"><span data-slate-object="text" data-key="6601"><span data-slate-leaf="true" data-offset-key="6601:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6602"><span data-slate-leaf="true" data-offset-key="6602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//appID 当前的 AppID</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6603"><span data-slate-object="text" data-key="6604"><span data-slate-leaf="true" data-offset-key="6604:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6605"><span data-slate-leaf="true" data-offset-key="6605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//holdTime 分布式选择器 hold 住的时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6606"><span data-slate-object="text" data-key="6607"><span data-slate-leaf="true" data-offset-key="6607:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6608"><span data-slate-leaf="true" data-offset-key="6608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6609"><span data-slate-object="text" data-key="6610"><span data-slate-leaf="true" data-offset-key="6610:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6611"><span data-slate-leaf="true" data-offset-key="6611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//selectAppID 分布式选择器最终选择的 App</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6612"><span data-slate-object="text" data-key="6613"><span data-slate-leaf="true" data-offset-key="6613:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6614"><span data-slate-leaf="true" data-offset-key="6614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//err 异常才返回，如果没有被选择，不返回 err</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6615"><span data-slate-object="text" data-key="6616"><span data-slate-leaf="true" data-offset-key="6616:0" data-first-offset="true"><span data-slate-string="true">   Select(serviceName </span></span></span><span data-slate-object="text" data-key="6617"><span data-slate-leaf="true" data-offset-key="6617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6618"><span data-slate-leaf="true" data-offset-key="6618:0" data-first-offset="true"><span data-slate-string="true">, appID </span></span></span><span data-slate-object="text" data-key="6619"><span data-slate-leaf="true" data-offset-key="6619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6620"><span data-slate-leaf="true" data-offset-key="6620:0" data-first-offset="true"><span data-slate-string="true">, holdTime time.Duration) (selectAppID </span></span></span><span data-slate-object="text" data-key="6621"><span data-slate-leaf="true" data-offset-key="6621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6622"><span data-slate-leaf="true" data-offset-key="6622:0" data-first-offset="true"><span data-slate-string="true">, err </span></span></span><span data-slate-object="text" data-key="6623"><span data-slate-leaf="true" data-offset-key="6623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="6624"><span data-slate-leaf="true" data-offset-key="6624:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6625"><span data-slate-object="text" data-key="6626"><span data-slate-leaf="true" data-offset-key="6626:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6627"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6628"><span data-slate-object="text" data-key="6629"><span data-slate-leaf="true" data-offset-key="6629:0" data-first-offset="true"><span data-slate-string="true">这里提到了一个 appID 是我们之前没有见过的，简单说明一下。appID 是为每个当前应用起的唯一标识，它用 Google 的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6630"><span data-slate-object="text" data-key="6631"><span data-slate-leaf="true" data-offset-key="6631:0" data-first-offset="true"><span data-slate-string="true">uuid 生成库</span></span></span></a><span data-slate-object="text" data-key="6632"><span data-slate-leaf="true" data-offset-key="6632:0" data-first-offset="true"><span data-slate-string="true"> 就可以很方便生成。它怎么通过服务容器获取呢？我们可以将 appID 作为服务容器中 App 服务的一个方法，这样就能从服务容器中获取 App 服务，再获取到 appID 了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6633"><span data-slate-object="text" data-key="6634"><span data-slate-leaf="true" data-offset-key="6634:0" data-first-offset="true"><span data-slate-string="true">所以这里插一步来修改对应的 App 接口和其对应实现 HadeApp，详细的修改点都以注释的形式写在下面代码中了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6635"><span data-slate-object="text" data-key="6636"><span data-slate-leaf="true" data-offset-key="6636:0" data-first-offset="true"><span data-slate-string="true">在 framework/contract/framework/contract/app.go 中增加 AppID 的接口函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6637"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6638"><span data-slate-object="text" data-key="6639"><span data-slate-leaf="true" data-offset-key="6639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// App 定义接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6640"><span data-slate-object="text" data-key="6641"><span data-slate-leaf="true" data-offset-key="6641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="6642"><span data-slate-leaf="true" data-offset-key="6642:0" data-first-offset="true"><span data-slate-string="true"> App </span></span></span><span data-slate-object="text" data-key="6643"><span data-slate-leaf="true" data-offset-key="6643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="6644"><span data-slate-leaf="true" data-offset-key="6644:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6645"><span data-slate-object="text" data-key="6646"><span data-slate-leaf="true" data-offset-key="6646:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6647"><span data-slate-leaf="true" data-offset-key="6647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// AppID 表示当前这个 app 的唯一 id, 可以用于分布式锁等</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6648"><span data-slate-object="text" data-key="6649"><span data-slate-leaf="true" data-offset-key="6649:0" data-first-offset="true"><span data-slate-string="true">   AppID() </span></span></span><span data-slate-object="text" data-key="6650"><span data-slate-leaf="true" data-offset-key="6650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6651"><span data-slate-object="text" data-key="6652"><span data-slate-leaf="true" data-offset-key="6652:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6653"><span data-slate-object="text" data-key="6654"><span data-slate-leaf="true" data-offset-key="6654:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6655"><span data-slate-object="text" data-key="6656"><span data-slate-leaf="true" data-offset-key="6656:0" data-first-offset="true"><span data-slate-string="true">在 framework/provider/app/service.go 中也增加对 AppID 的实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6657"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6658"><span data-slate-object="text" data-key="6659"><span data-slate-leaf="true" data-offset-key="6659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// HadeApp 代表 hade 框架的 App 实现</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6660"><span data-slate-object="text" data-key="6661"><span data-slate-leaf="true" data-offset-key="6661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="6662"><span data-slate-leaf="true" data-offset-key="6662:0" data-first-offset="true"><span data-slate-string="true"> HadeApp </span></span></span><span data-slate-object="text" data-key="6663"><span data-slate-leaf="true" data-offset-key="6663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="6664"><span data-slate-leaf="true" data-offset-key="6664:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6665"><span data-slate-object="text" data-key="6666"><span data-slate-leaf="true" data-offset-key="6666:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6667"><span data-slate-object="text" data-key="6668"><span data-slate-leaf="true" data-offset-key="6668:0" data-first-offset="true"><span data-slate-string="true">   appId      </span></span></span><span data-slate-object="text" data-key="6669"><span data-slate-leaf="true" data-offset-key="6669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6670"><span data-slate-leaf="true" data-offset-key="6670:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="6671"><span data-slate-leaf="true" data-offset-key="6671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 表示当前这个 app 的唯一 id, 可以用于分布式锁等</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6672"><span data-slate-object="text" data-key="6673"><span data-slate-leaf="true" data-offset-key="6673:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6674"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6675"><span data-slate-object="text" data-key="6676"><span data-slate-leaf="true" data-offset-key="6676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// NewHadeApp 初始化 HadeApp</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6677"><span data-slate-object="text" data-key="6678"><span data-slate-leaf="true" data-offset-key="6678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6679"><span data-slate-leaf="true" data-offset-key="6679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6680"><span data-slate-leaf="true" data-offset-key="6680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NewHadeApp</span></span></span></span></span><span data-slate-object="text" data-key="6681"><span data-slate-leaf="true" data-offset-key="6681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(params ...</span></span></span></span></span><span data-slate-object="text" data-key="6682"><span data-slate-leaf="true" data-offset-key="6682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span></span></span><span data-slate-object="text" data-key="6683"><span data-slate-leaf="true" data-offset-key="6683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">{})</span></span></span></span></span><span data-slate-object="text" data-key="6684"><span data-slate-leaf="true" data-offset-key="6684:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="6685"><span data-slate-leaf="true" data-offset-key="6685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="6686"><span data-slate-leaf="true" data-offset-key="6686:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="6687"><span data-slate-leaf="true" data-offset-key="6687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="6688"><span data-slate-leaf="true" data-offset-key="6688:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6689"><span data-slate-object="text" data-key="6690"><span data-slate-leaf="true" data-offset-key="6690:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6691"><span data-slate-object="text" data-key="6692"><span data-slate-leaf="true" data-offset-key="6692:0" data-first-offset="true"><span data-slate-string="true">   appId := uuid.New().String()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6693"><span data-slate-object="text" data-key="6694"><span data-slate-leaf="true" data-offset-key="6694:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6695"><span data-slate-leaf="true" data-offset-key="6695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6696"><span data-slate-leaf="true" data-offset-key="6696:0" data-first-offset="true"><span data-slate-string="true"> &amp;HadeApp{baseFolder: baseFolder, container: container, appId: appId}, </span></span></span><span data-slate-object="text" data-key="6697"><span data-slate-leaf="true" data-offset-key="6697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6698"><span data-slate-object="text" data-key="6699"><span data-slate-leaf="true" data-offset-key="6699:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6700"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6701"><span data-slate-object="text" data-key="6702"><span data-slate-leaf="true" data-offset-key="6702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// AppID 表示这个 App 的唯一 ID</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6703"><span data-slate-object="text" data-key="6704"><span data-slate-leaf="true" data-offset-key="6704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6705"><span data-slate-leaf="true" data-offset-key="6705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6706"><span data-slate-leaf="true" data-offset-key="6706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(h HadeApp)</span></span></span></span></span><span data-slate-object="text" data-key="6707"><span data-slate-leaf="true" data-offset-key="6707:0" data-first-offset="true"><span data-slate-string="true"> AppID() </span></span></span><span data-slate-object="text" data-key="6708"><span data-slate-leaf="true" data-offset-key="6708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6709"><span data-slate-leaf="true" data-offset-key="6709:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6710"><span data-slate-object="text" data-key="6711"><span data-slate-leaf="true" data-offset-key="6711:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6712"><span data-slate-leaf="true" data-offset-key="6712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6713"><span data-slate-leaf="true" data-offset-key="6713:0" data-first-offset="true"><span data-slate-string="true"> h.appId</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6714"><span data-slate-object="text" data-key="6715"><span data-slate-leaf="true" data-offset-key="6715:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6716"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6717"><span data-slate-object="text" data-key="6718"><span data-slate-leaf="true" data-offset-key="6718:0" data-first-offset="true"><span data-slate-string="true">分布式服务 Distributed 的接口定义好，我们再回到它的具体实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6719"><span data-slate-object="text" data-key="6720"><span data-slate-leaf="true" data-offset-key="6720:0" data-first-offset="true"><span data-slate-string="true">这个具体实现就有很多方式了，Redis 只是其中一种而已，而且 Redis 要到后面章节才能引入。这里就实现一个本地文件锁。当一个服务器上有多个进程需要进行抢锁操作，文件锁是一种单机多进程抢占的很简易的实现方式。在 Golang 中，其使用方法也比较简单。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6721"><span data-slate-object="text" data-key="6722"><span data-slate-leaf="true" data-offset-key="6722:0" data-first-offset="true"><span data-slate-string="true">多个进程同时使用 os.OpenFile 打开一个文件，并使用 syscall.Flock 带上 syscall.LOCK_EX 参数来对这个文件加文件锁，这里只会有一个进程抢占到文件锁，而其他抢占不到的进程从 syscall.Flock 函数中获取到的就是 error。</span></span></span><span data-slate-object="text" data-key="6723"><span data-slate-leaf="true" data-offset-key="6723:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">根据这个 error 是否为空，我们就能判断是否抢占到了文件锁</span></span></span></span><span data-slate-object="text" data-key="6724"><span data-slate-leaf="true" data-offset-key="6724:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6725"><span data-slate-object="text" data-key="6726"><span data-slate-leaf="true" data-offset-key="6726:0" data-first-offset="true"><span data-slate-string="true">释放文件锁有两种方式，一种方式是调用 syscall.Flock 带上 syscall.LOCK_UN 的参数，另外一种方式是抢占到锁的进程结束，也会自动释放文件锁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6727"><span data-slate-object="text" data-key="6728"><span data-slate-leaf="true" data-offset-key="6728:0" data-first-offset="true"><span data-slate-string="true">来看分布式选择器的本地文件锁的具体实现，在代码 framework/provider/distributed/service_local.go 文件中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6729"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6730"><span data-slate-object="text" data-key="6731"><span data-slate-leaf="true" data-offset-key="6731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Select 为分布式选择器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6732"><span data-slate-object="text" data-key="6733"><span data-slate-leaf="true" data-offset-key="6733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6734"><span data-slate-leaf="true" data-offset-key="6734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6735"><span data-slate-leaf="true" data-offset-key="6735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s LocalDistributedService)</span></span></span></span></span><span data-slate-object="text" data-key="6736"><span data-slate-leaf="true" data-offset-key="6736:0" data-first-offset="true"><span data-slate-string="true"> Select(serviceName </span></span></span><span data-slate-object="text" data-key="6737"><span data-slate-leaf="true" data-offset-key="6737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6738"><span data-slate-leaf="true" data-offset-key="6738:0" data-first-offset="true"><span data-slate-string="true">, appID </span></span></span><span data-slate-object="text" data-key="6739"><span data-slate-leaf="true" data-offset-key="6739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6740"><span data-slate-leaf="true" data-offset-key="6740:0" data-first-offset="true"><span data-slate-string="true">, holdTime time.Duration) (selectAppID </span></span></span><span data-slate-object="text" data-key="6741"><span data-slate-leaf="true" data-offset-key="6741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6742"><span data-slate-leaf="true" data-offset-key="6742:0" data-first-offset="true"><span data-slate-string="true">, err </span></span></span><span data-slate-object="text" data-key="6743"><span data-slate-leaf="true" data-offset-key="6743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="6744"><span data-slate-leaf="true" data-offset-key="6744:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6745"><span data-slate-object="text" data-key="6746"><span data-slate-leaf="true" data-offset-key="6746:0" data-first-offset="true"><span data-slate-string="true">   appService := s.container.MustMake(contract.AppKey).(contract.App)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6747"><span data-slate-object="text" data-key="6748"><span data-slate-leaf="true" data-offset-key="6748:0" data-first-offset="true"><span data-slate-string="true">   runtimeFolder := appService.RuntimeFolder()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6749"><span data-slate-object="text" data-key="6750"><span data-slate-leaf="true" data-offset-key="6750:0" data-first-offset="true"><span data-slate-string="true">   lockFile := filepath.Join(runtimeFolder, </span></span></span><span data-slate-object="text" data-key="6751"><span data-slate-leaf="true" data-offset-key="6751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"disribute_"</span></span></span></span><span data-slate-object="text" data-key="6752"><span data-slate-leaf="true" data-offset-key="6752:0" data-first-offset="true"><span data-slate-string="true">+serviceName)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6753"><span data-slate-object="text" data-key="6754"><span data-slate-leaf="true" data-offset-key="6754:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6755"><span data-slate-leaf="true" data-offset-key="6755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 打开文件锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6756"><span data-slate-object="text" data-key="6757"><span data-slate-leaf="true" data-offset-key="6757:0" data-first-offset="true"><span data-slate-string="true">   lock, err := os.OpenFile(lockFile, os.O_RDWR|os.O_CREATE, </span></span></span><span data-slate-object="text" data-key="6758"><span data-slate-leaf="true" data-offset-key="6758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0666</span></span></span></span><span data-slate-object="text" data-key="6759"><span data-slate-leaf="true" data-offset-key="6759:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6760"><span data-slate-object="text" data-key="6761"><span data-slate-leaf="true" data-offset-key="6761:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6762"><span data-slate-leaf="true" data-offset-key="6762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6763"><span data-slate-leaf="true" data-offset-key="6763:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="6764"><span data-slate-leaf="true" data-offset-key="6764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6765"><span data-slate-leaf="true" data-offset-key="6765:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6766"><span data-slate-object="text" data-key="6767"><span data-slate-leaf="true" data-offset-key="6767:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6768"><span data-slate-leaf="true" data-offset-key="6768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6769"><span data-slate-leaf="true" data-offset-key="6769:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6770"><span data-slate-leaf="true" data-offset-key="6770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="6771"><span data-slate-leaf="true" data-offset-key="6771:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6772"><span data-slate-object="text" data-key="6773"><span data-slate-leaf="true" data-offset-key="6773:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6774"><span data-slate-object="text" data-key="6775"><span data-slate-leaf="true" data-offset-key="6775:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6776"><span data-slate-leaf="true" data-offset-key="6776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 尝试独占文件锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6777"><span data-slate-object="text" data-key="6778"><span data-slate-leaf="true" data-offset-key="6778:0" data-first-offset="true"><span data-slate-string="true">   err = syscall.Flock(</span></span></span><span data-slate-object="text" data-key="6779"><span data-slate-leaf="true" data-offset-key="6779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="6780"><span data-slate-leaf="true" data-offset-key="6780:0" data-first-offset="true"><span data-slate-string="true">(lock.Fd()), syscall.LOCK_EX|syscall.LOCK_NB)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6781"><span data-slate-object="text" data-key="6782"><span data-slate-leaf="true" data-offset-key="6782:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6783"><span data-slate-leaf="true" data-offset-key="6783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 抢不到文件锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6784"><span data-slate-object="text" data-key="6785"><span data-slate-leaf="true" data-offset-key="6785:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6786"><span data-slate-leaf="true" data-offset-key="6786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6787"><span data-slate-leaf="true" data-offset-key="6787:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="6788"><span data-slate-leaf="true" data-offset-key="6788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6789"><span data-slate-leaf="true" data-offset-key="6789:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6790"><span data-slate-object="text" data-key="6791"><span data-slate-leaf="true" data-offset-key="6791:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6792"><span data-slate-leaf="true" data-offset-key="6792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读取被选择的 appid</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6793"><span data-slate-object="text" data-key="6794"><span data-slate-leaf="true" data-offset-key="6794:0" data-first-offset="true"><span data-slate-string="true">      selectAppIDByt, err := ioutil.ReadAll(lock)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6795"><span data-slate-object="text" data-key="6796"><span data-slate-leaf="true" data-offset-key="6796:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6797"><span data-slate-leaf="true" data-offset-key="6797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6798"><span data-slate-leaf="true" data-offset-key="6798:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="6799"><span data-slate-leaf="true" data-offset-key="6799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6800"><span data-slate-leaf="true" data-offset-key="6800:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6801"><span data-slate-object="text" data-key="6802"><span data-slate-leaf="true" data-offset-key="6802:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="6803"><span data-slate-leaf="true" data-offset-key="6803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6804"><span data-slate-leaf="true" data-offset-key="6804:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6805"><span data-slate-leaf="true" data-offset-key="6805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="6806"><span data-slate-leaf="true" data-offset-key="6806:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6807"><span data-slate-object="text" data-key="6808"><span data-slate-leaf="true" data-offset-key="6808:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6809"><span data-slate-object="text" data-key="6810"><span data-slate-leaf="true" data-offset-key="6810:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6811"><span data-slate-leaf="true" data-offset-key="6811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6812"><span data-slate-leaf="true" data-offset-key="6812:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6813"><span data-slate-leaf="true" data-offset-key="6813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6814"><span data-slate-leaf="true" data-offset-key="6814:0" data-first-offset="true"><span data-slate-string="true">(selectAppIDByt), err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6815"><span data-slate-object="text" data-key="6816"><span data-slate-leaf="true" data-offset-key="6816:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6817"><span data-slate-object="text" data-key="6818"><span data-slate-leaf="true" data-offset-key="6818:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6819"><span data-slate-leaf="true" data-offset-key="6819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在一段时间内，选举有效，其他节点在这段时间不能再进行抢占</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6820"><span data-slate-object="text" data-key="6821"><span data-slate-leaf="true" data-offset-key="6821:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6822"><span data-slate-leaf="true" data-offset-key="6822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="6823"><span data-slate-leaf="true" data-offset-key="6823:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6824"><span data-slate-leaf="true" data-offset-key="6824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6825"><span data-slate-leaf="true" data-offset-key="6825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="6826"><span data-slate-leaf="true" data-offset-key="6826:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6827"><span data-slate-object="text" data-key="6828"><span data-slate-leaf="true" data-offset-key="6828:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6829"><span data-slate-leaf="true" data-offset-key="6829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="6830"><span data-slate-leaf="true" data-offset-key="6830:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6831"><span data-slate-leaf="true" data-offset-key="6831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6832"><span data-slate-leaf="true" data-offset-key="6832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="6833"><span data-slate-leaf="true" data-offset-key="6833:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6834"><span data-slate-object="text" data-key="6835"><span data-slate-leaf="true" data-offset-key="6835:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="6836"><span data-slate-leaf="true" data-offset-key="6836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放文件锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6837"><span data-slate-object="text" data-key="6838"><span data-slate-leaf="true" data-offset-key="6838:0" data-first-offset="true"><span data-slate-string="true">         syscall.Flock(</span></span></span><span data-slate-object="text" data-key="6839"><span data-slate-leaf="true" data-offset-key="6839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="6840"><span data-slate-leaf="true" data-offset-key="6840:0" data-first-offset="true"><span data-slate-string="true">(lock.Fd()), syscall.LOCK_UN)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6841"><span data-slate-object="text" data-key="6842"><span data-slate-leaf="true" data-offset-key="6842:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="6843"><span data-slate-leaf="true" data-offset-key="6843:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6844"><span data-slate-object="text" data-key="6845"><span data-slate-leaf="true" data-offset-key="6845:0" data-first-offset="true"><span data-slate-string="true">         lock.Close()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6846"><span data-slate-object="text" data-key="6847"><span data-slate-leaf="true" data-offset-key="6847:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="6848"><span data-slate-leaf="true" data-offset-key="6848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除文件锁对应的文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6849"><span data-slate-object="text" data-key="6850"><span data-slate-leaf="true" data-offset-key="6850:0" data-first-offset="true"><span data-slate-string="true">         os.Remove(lockFile)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6851"><span data-slate-object="text" data-key="6852"><span data-slate-leaf="true" data-offset-key="6852:0" data-first-offset="true"><span data-slate-string="true">      }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6853"><span data-slate-object="text" data-key="6854"><span data-slate-leaf="true" data-offset-key="6854:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6855"><span data-slate-leaf="true" data-offset-key="6855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建选举结果有效的计时器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6856"><span data-slate-object="text" data-key="6857"><span data-slate-leaf="true" data-offset-key="6857:0" data-first-offset="true"><span data-slate-string="true">      timer := time.NewTimer(holdTime)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6858"><span data-slate-object="text" data-key="6859"><span data-slate-leaf="true" data-offset-key="6859:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6860"><span data-slate-leaf="true" data-offset-key="6860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等待计时器结束</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6861"><span data-slate-object="text" data-key="6862"><span data-slate-leaf="true" data-offset-key="6862:0" data-first-offset="true"><span data-slate-string="true">      &lt;-timer.C</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6863"><span data-slate-object="text" data-key="6864"><span data-slate-leaf="true" data-offset-key="6864:0" data-first-offset="true"><span data-slate-string="true">   }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6865"><span data-slate-object="text" data-key="6866"><span data-slate-leaf="true" data-offset-key="6866:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6867"><span data-slate-leaf="true" data-offset-key="6867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 这里已经是抢占到了，将抢占到的 appID 写入文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6868"><span data-slate-object="text" data-key="6869"><span data-slate-leaf="true" data-offset-key="6869:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6870"><span data-slate-leaf="true" data-offset-key="6870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6871"><span data-slate-leaf="true" data-offset-key="6871:0" data-first-offset="true"><span data-slate-string="true"> _, err := lock.WriteString(appID); err != </span></span></span><span data-slate-object="text" data-key="6872"><span data-slate-leaf="true" data-offset-key="6872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6873"><span data-slate-leaf="true" data-offset-key="6873:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6874"><span data-slate-object="text" data-key="6875"><span data-slate-leaf="true" data-offset-key="6875:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6876"><span data-slate-leaf="true" data-offset-key="6876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6877"><span data-slate-leaf="true" data-offset-key="6877:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6878"><span data-slate-leaf="true" data-offset-key="6878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="6879"><span data-slate-leaf="true" data-offset-key="6879:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6880"><span data-slate-object="text" data-key="6881"><span data-slate-leaf="true" data-offset-key="6881:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6882"><span data-slate-object="text" data-key="6883"><span data-slate-leaf="true" data-offset-key="6883:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6884"><span data-slate-leaf="true" data-offset-key="6884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6885"><span data-slate-leaf="true" data-offset-key="6885:0" data-first-offset="true"><span data-slate-string="true"> appID, </span></span></span><span data-slate-object="text" data-key="6886"><span data-slate-leaf="true" data-offset-key="6886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6887"><span data-slate-object="text" data-key="6888"><span data-slate-leaf="true" data-offset-key="6888:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6889"><span data-slate-object="text" data-key="6890"><span data-slate-leaf="true" data-offset-key="6890:0" data-first-offset="true"><span data-slate-string="true">大概逻辑是先打开或者创建文件锁对应的文件，然后在这个文件上加上文件锁，加上锁的过程就是抢占的过程。对于没有抢占到的，文件中内容为抢占到的那个应用的 ID，将应用 ID 返回；抢占到的，就写入自己的应用 ID 到文件中，并且通过一个新的 Goroutine 开启计时器，等待计时器结束后解开文件锁，并且删除文件锁对应的文件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6891"><span data-slate-object="text" data-key="6892"><span data-slate-leaf="true" data-offset-key="6892:0" data-first-offset="true"><span data-slate-string="true">而这个分布式服务 Distributed 的服务提供者 framework/provider/distributed/provider_local.go 的逻辑就比较简单了，就是正常的实现 serviceProvider 的 5 个方法，这里就不赘述了，可以参考 GitHub 上的代码分支。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6893"><span data-slate-object="text" data-key="6894"><span data-slate-leaf="true" data-offset-key="6894:0" data-first-offset="true"><span data-slate-string="true">现在有了分布式选择器，就可以实现分布式调度了。</span></span></span><span data-slate-object="text" data-key="6895"><span data-slate-leaf="true" data-offset-key="6895:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">我们为 Command 结构增加一个方法 AddDistributedCronCommand，这个方法有四个参数</span></span></span></span><span data-slate-object="text" data-key="6896"><span data-slate-leaf="true" data-offset-key="6896:0" data-first-offset="true"><span data-slate-string="true">：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6897"><div data-slate-type="list-line" data-slate-object="block" data-key="6898"><span data-slate-object="text" data-key="6899"><span data-slate-leaf="true" data-offset-key="6899:0" data-first-offset="true"><span data-slate-string="true">serviceName 这个服务的唯一名字，不允许带有空格</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6900"><span data-slate-object="text" data-key="6901"><span data-slate-leaf="true" data-offset-key="6901:0" data-first-offset="true"><span data-slate-string="true">spec 具体的执行时间</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6902"><span data-slate-object="text" data-key="6903"><span data-slate-leaf="true" data-offset-key="6903:0" data-first-offset="true"><span data-slate-string="true">cmd 具体的执行命令</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6904"><span data-slate-object="text" data-key="6905"><span data-slate-leaf="true" data-offset-key="6905:0" data-first-offset="true"><span data-slate-string="true">holdTime 表示如果我选择上了，这次选择持续的时间也就是锁释放的时间</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6906"><span data-slate-object="text" data-key="6907"><span data-slate-leaf="true" data-offset-key="6907:0" data-first-offset="true"><span data-slate-string="true">它的实现和 AddCronCommand 差不多，唯一的区别就是在封装 cron.AddFunc 的匿名函数中，运行目标命令之前，要做一次分布式选举，如果被选举上了，才执行目标命令。所以来增加一个文件，在 framework/cobra/hade_command_distributed.go 中，定义 AddDistributedCronCommand 方法：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6908"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6909"><span data-slate-object="text" data-key="6910"><span data-slate-leaf="true" data-offset-key="6910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// AddDistributedCronCommand 实现一个分布式定时器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6911"><span data-slate-object="text" data-key="6912"><span data-slate-leaf="true" data-offset-key="6912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//serviceName 这个服务的唯一名字，不允许带有空格</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6913"><span data-slate-object="text" data-key="6914"><span data-slate-leaf="true" data-offset-key="6914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//spec 具体的执行时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6915"><span data-slate-object="text" data-key="6916"><span data-slate-leaf="true" data-offset-key="6916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cmd 具体的执行命令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6917"><span data-slate-object="text" data-key="6918"><span data-slate-leaf="true" data-offset-key="6918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//holdTime 表示如果我选择上了，这次选择持续的时间，也就是锁释放的时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6919"><span data-slate-object="text" data-key="6920"><span data-slate-leaf="true" data-offset-key="6920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6921"><span data-slate-leaf="true" data-offset-key="6921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6922"><span data-slate-leaf="true" data-offset-key="6922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *Command)</span></span></span></span></span><span data-slate-object="text" data-key="6923"><span data-slate-leaf="true" data-offset-key="6923:0" data-first-offset="true"><span data-slate-string="true"> AddDistributedCronCommand(serviceName </span></span></span><span data-slate-object="text" data-key="6924"><span data-slate-leaf="true" data-offset-key="6924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6925"><span data-slate-leaf="true" data-offset-key="6925:0" data-first-offset="true"><span data-slate-string="true">, spec </span></span></span><span data-slate-object="text" data-key="6926"><span data-slate-leaf="true" data-offset-key="6926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6927"><span data-slate-leaf="true" data-offset-key="6927:0" data-first-offset="true"><span data-slate-string="true">, cmd *Command, holdTime time.Duration) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6928"><span data-slate-object="text" data-key="6929"><span data-slate-leaf="true" data-offset-key="6929:0" data-first-offset="true"><span data-slate-string="true">   root := c.Root()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6930"><span data-slate-object="text" data-key="6931"><span data-slate-leaf="true" data-offset-key="6931:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6932"><span data-slate-leaf="true" data-offset-key="6932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 cron</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6933"><span data-slate-object="text" data-key="6934"><span data-slate-leaf="true" data-offset-key="6934:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6935"><span data-slate-leaf="true" data-offset-key="6935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6936"><span data-slate-leaf="true" data-offset-key="6936:0" data-first-offset="true"><span data-slate-string="true"> root.Cron == </span></span></span><span data-slate-object="text" data-key="6937"><span data-slate-leaf="true" data-offset-key="6937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6938"><span data-slate-leaf="true" data-offset-key="6938:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6939"><span data-slate-object="text" data-key="6940"><span data-slate-leaf="true" data-offset-key="6940:0" data-first-offset="true"><span data-slate-string="true">      root.Cron = cron.New(cron.WithParser(cron.NewParser(cron.SecondOptional | cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow | cron.Descriptor)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6941"><span data-slate-object="text" data-key="6942"><span data-slate-leaf="true" data-offset-key="6942:0" data-first-offset="true"><span data-slate-string="true">      root.CronSpecs = []CronSpec{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6943"><span data-slate-object="text" data-key="6944"><span data-slate-leaf="true" data-offset-key="6944:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6945"><span data-slate-object="text" data-key="6946"><span data-slate-leaf="true" data-offset-key="6946:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6947"><span data-slate-leaf="true" data-offset-key="6947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cron 命令的注释，这里注意 Type 为 distributed-cron，ServiceName 需要填写</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6948"><span data-slate-object="text" data-key="6949"><span data-slate-leaf="true" data-offset-key="6949:0" data-first-offset="true"><span data-slate-string="true">   root.CronSpecs = </span></span></span><span data-slate-object="text" data-key="6950"><span data-slate-leaf="true" data-offset-key="6950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="6951"><span data-slate-leaf="true" data-offset-key="6951:0" data-first-offset="true"><span data-slate-string="true">(root.CronSpecs, CronSpec{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6952"><span data-slate-object="text" data-key="6953"><span data-slate-leaf="true" data-offset-key="6953:0" data-first-offset="true"><span data-slate-string="true">      Type:        </span></span></span><span data-slate-object="text" data-key="6954"><span data-slate-leaf="true" data-offset-key="6954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"distributed-cron"</span></span></span></span><span data-slate-object="text" data-key="6955"><span data-slate-leaf="true" data-offset-key="6955:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6956"><span data-slate-object="text" data-key="6957"><span data-slate-leaf="true" data-offset-key="6957:0" data-first-offset="true"><span data-slate-string="true">      Cmd:         cmd,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6958"><span data-slate-object="text" data-key="6959"><span data-slate-leaf="true" data-offset-key="6959:0" data-first-offset="true"><span data-slate-string="true">      Spec:        spec,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6960"><span data-slate-object="text" data-key="6961"><span data-slate-leaf="true" data-offset-key="6961:0" data-first-offset="true"><span data-slate-string="true">      ServiceName: serviceName,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6962"><span data-slate-object="text" data-key="6963"><span data-slate-leaf="true" data-offset-key="6963:0" data-first-offset="true"><span data-slate-string="true">   })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6964"><span data-slate-object="text" data-key="6965"><span data-slate-leaf="true" data-offset-key="6965:0" data-first-offset="true"><span data-slate-string="true">   appService := root.GetContainer().MustMake(contract.AppKey).(contract.App)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6966"><span data-slate-object="text" data-key="6967"><span data-slate-leaf="true" data-offset-key="6967:0" data-first-offset="true"><span data-slate-string="true">   distributeServce := root.GetContainer().MustMake(contract.DistributedKey).(contract.Distributed)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6968"><span data-slate-object="text" data-key="6969"><span data-slate-leaf="true" data-offset-key="6969:0" data-first-offset="true"><span data-slate-string="true">   appID := appService.AppID()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6970"><span data-slate-object="text" data-key="6971"><span data-slate-leaf="true" data-offset-key="6971:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6972"><span data-slate-leaf="true" data-offset-key="6972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 复制要执行的 command 为 cronCmd，并且设置为 rootCmd</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6973"><span data-slate-object="text" data-key="6974"><span data-slate-leaf="true" data-offset-key="6974:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6975"><span data-slate-leaf="true" data-offset-key="6975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="6976"><span data-slate-leaf="true" data-offset-key="6976:0" data-first-offset="true"><span data-slate-string="true"> cronCmd Command</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6977"><span data-slate-object="text" data-key="6978"><span data-slate-leaf="true" data-offset-key="6978:0" data-first-offset="true"><span data-slate-string="true">   ctx := root.Context()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6979"><span data-slate-object="text" data-key="6980"><span data-slate-leaf="true" data-offset-key="6980:0" data-first-offset="true"><span data-slate-string="true">   cronCmd = *cmd</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6981"><span data-slate-object="text" data-key="6982"><span data-slate-leaf="true" data-offset-key="6982:0" data-first-offset="true"><span data-slate-string="true">   cronCmd.args = []</span></span></span><span data-slate-object="text" data-key="6983"><span data-slate-leaf="true" data-offset-key="6983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6984"><span data-slate-leaf="true" data-offset-key="6984:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6985"><span data-slate-object="text" data-key="6986"><span data-slate-leaf="true" data-offset-key="6986:0" data-first-offset="true"><span data-slate-string="true">   cronCmd.SetParentNull()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6987"><span data-slate-object="text" data-key="6988"><span data-slate-leaf="true" data-offset-key="6988:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6989"><span data-slate-leaf="true" data-offset-key="6989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cron 增加匿名函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6990"><span data-slate-object="text" data-key="6991"><span data-slate-leaf="true" data-offset-key="6991:0" data-first-offset="true"><span data-slate-string="true">   root.Cron.AddFunc(spec, </span></span></span><span data-slate-object="text" data-key="6992"><span data-slate-leaf="true" data-offset-key="6992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="6993"><span data-slate-leaf="true" data-offset-key="6993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="6994"><span data-slate-leaf="true" data-offset-key="6994:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6995"><span data-slate-object="text" data-key="6996"><span data-slate-leaf="true" data-offset-key="6996:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="6997"><span data-slate-leaf="true" data-offset-key="6997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 防止 panic</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6998"><span data-slate-object="text" data-key="6999"><span data-slate-leaf="true" data-offset-key="6999:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7000"><span data-slate-leaf="true" data-offset-key="7000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="7001"><span data-slate-leaf="true" data-offset-key="7001:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7002"><span data-slate-leaf="true" data-offset-key="7002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7003"><span data-slate-leaf="true" data-offset-key="7003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="7004"><span data-slate-leaf="true" data-offset-key="7004:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7005"><span data-slate-object="text" data-key="7006"><span data-slate-leaf="true" data-offset-key="7006:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="7007"><span data-slate-leaf="true" data-offset-key="7007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7008"><span data-slate-leaf="true" data-offset-key="7008:0" data-first-offset="true"><span data-slate-string="true"> err := </span></span></span><span data-slate-object="text" data-key="7009"><span data-slate-leaf="true" data-offset-key="7009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">recover</span></span></span></span><span data-slate-object="text" data-key="7010"><span data-slate-leaf="true" data-offset-key="7010:0" data-first-offset="true"><span data-slate-string="true">(); err != </span></span></span><span data-slate-object="text" data-key="7011"><span data-slate-leaf="true" data-offset-key="7011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7012"><span data-slate-leaf="true" data-offset-key="7012:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7013"><span data-slate-object="text" data-key="7014"><span data-slate-leaf="true" data-offset-key="7014:0" data-first-offset="true"><span data-slate-string="true">            log.Println(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7015"><span data-slate-object="text" data-key="7016"><span data-slate-leaf="true" data-offset-key="7016:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7017"><span data-slate-object="text" data-key="7018"><span data-slate-leaf="true" data-offset-key="7018:0" data-first-offset="true"><span data-slate-string="true">      }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7019"><span data-slate-object="text" data-key="7020"><span data-slate-leaf="true" data-offset-key="7020:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7021"><span data-slate-leaf="true" data-offset-key="7021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 节点进行选举，返回选举结果</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7022"><span data-slate-object="text" data-key="7023"><span data-slate-leaf="true" data-offset-key="7023:0" data-first-offset="true"><span data-slate-string="true">      selectedAppID, err := distributeServce.Select(serviceName, appID, holdTime)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7024"><span data-slate-object="text" data-key="7025"><span data-slate-leaf="true" data-offset-key="7025:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7026"><span data-slate-leaf="true" data-offset-key="7026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7027"><span data-slate-leaf="true" data-offset-key="7027:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7028"><span data-slate-leaf="true" data-offset-key="7028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7029"><span data-slate-leaf="true" data-offset-key="7029:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7030"><span data-slate-object="text" data-key="7031"><span data-slate-leaf="true" data-offset-key="7031:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="7032"><span data-slate-leaf="true" data-offset-key="7032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7033"><span data-slate-object="text" data-key="7034"><span data-slate-leaf="true" data-offset-key="7034:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7035"><span data-slate-object="text" data-key="7036"><span data-slate-leaf="true" data-offset-key="7036:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7037"><span data-slate-leaf="true" data-offset-key="7037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果自己没有被选择到，直接返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7038"><span data-slate-object="text" data-key="7039"><span data-slate-leaf="true" data-offset-key="7039:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7040"><span data-slate-leaf="true" data-offset-key="7040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7041"><span data-slate-leaf="true" data-offset-key="7041:0" data-first-offset="true"><span data-slate-string="true"> selectedAppID != appID {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7042"><span data-slate-object="text" data-key="7043"><span data-slate-leaf="true" data-offset-key="7043:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="7044"><span data-slate-leaf="true" data-offset-key="7044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7045"><span data-slate-object="text" data-key="7046"><span data-slate-leaf="true" data-offset-key="7046:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7047"><span data-slate-object="text" data-key="7048"><span data-slate-leaf="true" data-offset-key="7048:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7049"><span data-slate-leaf="true" data-offset-key="7049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果自己被选择到了，执行这个定时任务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7050"><span data-slate-object="text" data-key="7051"><span data-slate-leaf="true" data-offset-key="7051:0" data-first-offset="true"><span data-slate-string="true">      err = cronCmd.ExecuteContext(ctx)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7052"><span data-slate-object="text" data-key="7053"><span data-slate-leaf="true" data-offset-key="7053:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7054"><span data-slate-leaf="true" data-offset-key="7054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7055"><span data-slate-leaf="true" data-offset-key="7055:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7056"><span data-slate-leaf="true" data-offset-key="7056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7057"><span data-slate-leaf="true" data-offset-key="7057:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7058"><span data-slate-object="text" data-key="7059"><span data-slate-leaf="true" data-offset-key="7059:0" data-first-offset="true"><span data-slate-string="true">         log.Println(err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7060"><span data-slate-object="text" data-key="7061"><span data-slate-leaf="true" data-offset-key="7061:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7062"><span data-slate-object="text" data-key="7063"><span data-slate-leaf="true" data-offset-key="7063:0" data-first-offset="true"><span data-slate-string="true">   })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7064"><span data-slate-object="text" data-key="7065"><span data-slate-leaf="true" data-offset-key="7065:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7066"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7067"><span data-slate-object="text" data-key="7068"><span data-slate-leaf="true" data-offset-key="7068:0" data-first-offset="true"><span data-slate-string="true">完成了实现逻辑，下面照例做验证。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7069"><span data-slate-object="text" data-key="7070"><span data-slate-leaf="true" data-offset-key="7070:0" data-first-offset="true"><span data-slate-string="true">我们将打印字符 “execute foo command” 的 FooCommand 命令执行的服务名设置为 “foo_func_for_test”。设置为每 5 秒进行一次选举并产生结果，每次选举结果保留 2 秒钟：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7071"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7072"><span data-slate-object="text" data-key="7073"><span data-slate-leaf="true" data-offset-key="7073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 绑定业务的命令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7074"><span data-slate-object="text" data-key="7075"><span data-slate-leaf="true" data-offset-key="7075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7076"><span data-slate-leaf="true" data-offset-key="7076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="7077"><span data-slate-leaf="true" data-offset-key="7077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AddAppCommand</span></span></span></span></span><span data-slate-object="text" data-key="7078"><span data-slate-leaf="true" data-offset-key="7078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(rootCmd *cobra.Command)</span></span></span></span></span><span data-slate-object="text" data-key="7079"><span data-slate-leaf="true" data-offset-key="7079:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7080"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7081"><span data-slate-object="text" data-key="7082"><span data-slate-leaf="true" data-offset-key="7082:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7083"><span data-slate-leaf="true" data-offset-key="7083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动一个分布式任务调度，调度的服务名称为 init_func_for_test，每个节点每 5s 调用一次 Foo 命令，抢占到了调度任务的节点将抢占锁持续挂载 2s 才释放</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7084"><span data-slate-object="text" data-key="7085"><span data-slate-leaf="true" data-offset-key="7085:0" data-first-offset="true"><span data-slate-string="true">   rootCmd.AddDistributedCronCommand(</span></span></span><span data-slate-object="text" data-key="7086"><span data-slate-leaf="true" data-offset-key="7086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo_func_for_test"</span></span></span></span><span data-slate-object="text" data-key="7087"><span data-slate-leaf="true" data-offset-key="7087:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7088"><span data-slate-leaf="true" data-offset-key="7088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"*/5 * * * * *"</span></span></span></span><span data-slate-object="text" data-key="7089"><span data-slate-leaf="true" data-offset-key="7089:0" data-first-offset="true"><span data-slate-string="true">, demo.FooCommand, </span></span></span><span data-slate-object="text" data-key="7090"><span data-slate-leaf="true" data-offset-key="7090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="7091"><span data-slate-leaf="true" data-offset-key="7091:0" data-first-offset="true"><span data-slate-string="true">*time.Second)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7092"><span data-slate-object="text" data-key="7093"><span data-slate-leaf="true" data-offset-key="7093:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7094"><span data-slate-object="text" data-key="7095"><span data-slate-leaf="true" data-offset-key="7095:0" data-first-offset="true"><span data-slate-string="true">开启两个控制台，启动两个进程  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7096"><span data-slate-object="text" data-key="7097"><span data-slate-leaf="true" data-offset-key="7097:0" data-first-offset="true"><span data-slate-string="true">./hade cron start</span></span></span></span><span data-slate-object="text" data-key="7098"><span data-slate-leaf="true" data-offset-key="7098:0" data-first-offset="true"><span data-slate-string="true"> 。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="7099"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/17/fe/174d0df274f5ab7197b533d3f05ee7fe.png?wh=464x207"></div></div><div data-slate-type="image" data-slate-object="block" data-key="7100"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/27/d5/276276b1cbe3a9ba12bfdaaeb47e25d5.png?wh=491x142"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7101"><span data-slate-object="text" data-key="7102"><span data-slate-leaf="true" data-offset-key="7102:0" data-first-offset="true"><span data-slate-string="true">能看到 36 分 00 秒的任务是在 PID 为 40425 的进程执行，而 36 分 05 秒的任务是在 PID 为 40653 的进程执行。而且仿造容灾演练，关闭掉其中任何一个进程，剩余每 5 秒钟执行的任务，都会落在存活的那个进程中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7103"><span data-slate-object="text" data-key="7104"><span data-slate-leaf="true" data-offset-key="7104:0" data-first-offset="true"><span data-slate-string="true">到这里，我们就为 hade 框架提供了分布式定时器的功能。这节课的所有代码都在 GitHub 上的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7105"><span data-slate-object="text" data-key="7106"><span data-slate-leaf="true" data-offset-key="7106:0" data-first-offset="true"><span data-slate-string="true">geekbang/14</span></span></span></a><span data-slate-object="text" data-key="7107"><span data-slate-leaf="true" data-offset-key="7107:0" data-first-offset="true"><span data-slate-string="true"> 分支。对应的目录结构截图如下：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="7108"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/2f/73/2fdda7d387012e4d6fdf3c6c89c2e073.png?wh=362x1228" style="width: auto;"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7109" id="sr-toc-8"><span data-slate-object="text" data-key="7110"><span data-slate-leaf="true" data-offset-key="7110:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7111"><span data-slate-object="text" data-key="7112"><span data-slate-leaf="true" data-offset-key="7112:0" data-first-offset="true"><span data-slate-string="true">今天内容有点多，对不太清楚的地方，你可以多看几遍慢慢理解。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7113"><span data-slate-object="text" data-key="7114"><span data-slate-leaf="true" data-offset-key="7114:0" data-first-offset="true"><span data-slate-string="true">我们先使用 cron 包来为框架增加了定时执行命令的功能。在实现过程中，介绍了在 Golang 中，如何启动一个当前二进制文件的子进程。这个启动子进程的方式非常重要，后续在多个命令行工具中还会使用到，得熟练掌握。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7115"><span data-slate-object="text" data-key="7116"><span data-slate-leaf="true" data-offset-key="7116:0" data-first-offset="true"><span data-slate-string="true">接着一起实现了分布式定时器的功能。在实现分布式定时器的功能中，你也能更深一步感受到前几节课说的</span></span></span><span data-slate-object="text" data-key="7117"><span data-slate-leaf="true" data-offset-key="7117:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">面向接口编程和服务容器设计的好处</span></span></span></span><span data-slate-object="text" data-key="7118"><span data-slate-leaf="true" data-offset-key="7118:0" data-first-offset="true"><span data-slate-string="true">。比如说我们实现分布式定时器需要 appID，就去 app 服务中增加一个获取 AppID 的接口；需要分布式选举服务，就创建了一个分布式服务接口。非常方便。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7119" id="sr-toc-9"><span data-slate-object="text" data-key="7120"><span data-slate-leaf="true" data-offset-key="7120:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7121"><span data-slate-object="text" data-key="7122"><span data-slate-leaf="true" data-offset-key="7122:0" data-first-offset="true"><span data-slate-string="true">本节课实现了 cron 的五个三级命令其中最重要的一个 cron start。你可以思考并尝试写一下其他几个命令：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7123"><div data-slate-type="list-line" data-slate-object="block" data-key="7124"><span data-slate-object="text" data-key="7125"><span data-slate-leaf="true" data-offset-key="7125:0" data-first-offset="true"><span data-slate-string="true">cron stop 停止启动的进程</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7126"><span data-slate-object="text" data-key="7127"><span data-slate-leaf="true" data-offset-key="7127:0" data-first-offset="true"><span data-slate-string="true">cron state 判断当前 cron 进程是否已经启动，返回 PID</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7128"><span data-slate-object="text" data-key="7129"><span data-slate-leaf="true" data-offset-key="7129:0" data-first-offset="true"><span data-slate-string="true">cron restart 重新启动 cron 进程</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7130"><span data-slate-object="text" data-key="7131"><span data-slate-leaf="true" data-offset-key="7131:0" data-first-offset="true"><span data-slate-string="true">cron list 列出挂载的所有 cron 任务</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7132"><span data-slate-object="text" data-key="7133"><span data-slate-leaf="true" data-offset-key="7133:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区分享你的思考。如果你觉得有收获，也欢迎把今天的内容分享给身边的朋友，邀他一起学习。我们下节课见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-10">精选留言 (13)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1c/f7/62/947004d0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>www</span></div><span>置顶</span></div><div>跟到现在冒个泡，写得很详细，心都掏出来了，大赞</div><div><div>2021-11-02</div><div><div><i></i><span></span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/70/67/0c1359c2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>qinsi</span></div></div><div>疑问：linux cron 命令会把任务写入 crontab 文件，而这里的代码似乎没有存储 cron 任务，所以 cron 任务其实是写死在 app 里并从命令行启动的？这样似乎会带来一些额外的开发和运维工作，比如需要新增和修改 cron 任务时就需要升级 app 并重新部署。

在分布式调度 cron 任务时还会有个问题，在同一个环境中启动多个 app 实例去抢占执行 cron 任务的话就只会记下最后一个 pid，那么那些管理 cron 任务的子命令就都失效了。所以分布式调度必然意味着需要分布式部署？</div><div><p>作者回复：第一个问题，是的，cron 是写在 app 里面运行的，每次升级 cron 需要升级 app。第二个问题是存在这样问题，这个之前没考虑到，同一个目录启动多个实例。标准办法应该是每个实例启动一个 runtimefolder，把 runtimefolder 从环境变量中传递进去才行</p></div><div><div>2021-10-18</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>woJA1wCgAAxrBgpYJOnLFfx5VBLZeS...</span></div></div><div>分布式文件锁不是存在多个独立运行环境上吗，为何是通过抢占文件来做 select 呢？这似乎是单机多进程。</div><div><div>2022-04-16</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 宙斯</span></div></div><div>fork 和 os.StartProcess 没看出来，选择哪个更好，也就是意味着选择这二者其一都可以。</div><div><div>2021-10-26</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1c/57/7b/b31da1b2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 清睿夕</span></div></div><div>一个节点是一台服务器还是运行一次程序就是一个节点，多个节点怎么</div><div><p>作者回复：多个节点即可以是一个服务器一个，也可以是多个进程。不过一般现在容器化这么普遍的情况，基本上一个节点在实际上上一个 pod 的概念</p></div><div><div>2021-10-20</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/jS4DD0hyIwnpNpMOicHrGs0nM2p9dewbew0TB1N4dib8GrsFMsKIspcJBZD69ZI2mibicnvibq6PWk9ODI2HCgUrrDA/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_b6655a</span></div></div><div>for _, entry := entries {entry.Next = next (entry)
}
这段代码， entries 前面少了一个 range 进行遍历吧吧</div><div><p>作者回复：是的，感谢留言。已联系小编修改中</p></div><div><div>2022-08-05</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_bda8af</span></div></div><div>学了两天 可算搞明白了 感谢～！</div><div><div>2022-06-03</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/cb/07/482b7155.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>牛玉富</span></div></div><div>一如既往的干货
分布式任务下应该注意，时间保持一致，不然应该会有重复任务执行情况。</div><div><div>2022-01-13</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/26/b5/74/cd80b9f4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>友</span></div></div><div>这篇太干货了 看了半天</div><div><p>作者回复：感谢</p></div><div><div>2021-12-09</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/7a/55/2f4055f6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>void</span></div></div><div>LocalDistributedService 方法中尝试加文件锁失败后，没有关闭 lockFile，这里可能会造成资源泄露吧？</div><div><div>2021-11-17</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/7a/55/2f4055f6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>void</span></div></div><div>framework/container.go:: Bind 方法中，为什么把原来的 defer h.lock.Unlock () 改成了 66 行的 h.lock.Unlock () ？这样 80 行对 h.instances 的写入是没有锁保护的啊</div><div><div>2021-11-17</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>宙斯</span></div></div><div>查看 cobra 源码时发现 HasParent 函数是通过 c.parent != nil 判定是否有父级 command，所以在 SetParentNull 里面主动将 c.parent=nil。</div><div><div>2021-10-26</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/26/34/891dd45b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>宙斯</span></div></div><div>咨询个问题：之所以讨论进程的创建过程中（fork 方式，os.StartProcess 方式），是需要讨论环境对进程的影响吗？</div><div><div>2021-10-26</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".p"><outline class="toc-level-h1" data-reactid=".p.0" style="width: 175px;"><active data-reactid=".p.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".p.0.1"><span data-reactid=".p.0.1.0">14｜定时任务：如何让框架支持分布式定时脚本？</span></a></outline><outline class="toc-level-h2" data-reactid=".p.1" style="width: 165px;"><active data-reactid=".p.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".p.1.1"><span data-reactid=".p.1.1.0">使用 timer 定时执行命令</span></a></outline><outline class="toc-level-h2" data-reactid=".p.2" style="width: 165px;"><active data-reactid=".p.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".p.2.1"><span data-reactid=".p.2.1.0">使用 cron 包定时执行命令</span></a></outline><outline class="toc-level-h2" data-reactid=".p.3" style="width: 165px;"><active data-reactid=".p.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".p.3.1"><span data-reactid=".p.3.1.0">定时命令的思路与实现</span></a></outline><outline class="toc-level-h3" data-reactid=".p.4" style="width: 155px;"><active data-reactid=".p.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".p.4.1"><span data-reactid=".p.4.1.0">cron 的初始化和回调</span></a></outline><outline class="toc-level-h2" data-reactid=".p.5" style="width: 165px;"><active data-reactid=".p.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".p.5.1"><span data-reactid=".p.5.1.0">启动 cron 的思路与实现</span></a></outline><outline class="toc-level-h3" data-reactid=".p.6" style="width: 155px;"><active data-reactid=".p.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".p.6.1"><span data-reactid=".p.6.1.0">启动 cron 的实现</span></a></outline><outline class="toc-level-h2" data-reactid=".p.7" style="width: 165px;"><active data-reactid=".p.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".p.7.1"><span data-reactid=".p.7.1.0">如何实现分布式定时器</span></a></outline><outline class="toc-level-h2" data-reactid=".p.8" style="width: 165px;"><active data-reactid=".p.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".p.8.1"><span data-reactid=".p.8.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".p.9" style="width: 165px;"><active data-reactid=".p.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".p.9.1"><span data-reactid=".p.9.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".p.a" style="width: 165px;"><active data-reactid=".p.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".p.a.1"><span data-reactid=".p.a.1.0">精选留言 (13)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/427090" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>