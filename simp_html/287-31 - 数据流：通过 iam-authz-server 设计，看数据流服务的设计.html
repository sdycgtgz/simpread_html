
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAMAAAANIilAAAAA7VBMVEUAAAD///8ZGRnw8PBWVlb4+PgeHh719fVEREQlJSUODg6Ojo7Ly8v9/f1NTU2VlZUFBQV6enrCwsLy8vLh4eE0NDQLCwu8vLyXl5dxcXHa2trAwMCFhYVDQ0OysrKampo7OzssLCwICAioqKjJyckhISHu7u4/Pz9TU1NQUFBLS0tAQED6+vrS0tKRkZFISEgvLy+goKB+fn5vb29nZ2fm5uYbGxvk5OTX19d2dnZaWlre3t5hYWEyMjK5ubkoKCgVFRXQ0NDMzMzFxcW0tLSsrKykpKSMjIzq6urU1NSAgICvr6+cnJyHh4dsbGyfc25QAAAFkElEQVRIx4WXB3faMBCA74wHxgMMGAOh1MyyVyBAmtVmd/3/n1OdDtWstt/Li5JD35MtnU4CMnCIlkLEOpSKuMPhuI4FE444L9+dyv3zciad/rAjfU/yOPpGcjWS1NKSGsk29WTSD1IeYsIPkvsAJF+C5BIZkieYMNjJnsF4+JHk61wOSlVDyOIPqKBgZIxYTrqy/AmNtC1ps7yqlgE6dgYa1WqD5aV9SbKDbe6ZNnCq5A5ILlhGjEASIoawJdmHHo98AZLOnmxzKM9yK9Aht63FoAWBBmEgsEHnkfMgsZU8PJbpbXJd3MIep/Lg/MjbRqMRRuNtQ4Tthga5RiNzfmSWD97ZExQ64HhtgLb3CmbBGyj54vixjyeMsKjnV4AvOAHTwsHphKnH9toXki7Li3jLsgswizskv+c3PHKXe7ZHu5E/YMKcM2yqZIJkAclZTPClbJezivI1yTr4f+TeMib5qXxHsr7XtUFJDIc8pLAHA7Su4JXkd8ySnKZddQXH2NohswIutRu0Qu0jyS46JPugU+gISB1R8NBKWegVUsahTKEjAP9Bm5bKAc3DPlzjKaDvscE7PeEJu63WUg9a82tdA1O/ESupL9Cr6C1cXetjIe9zgQ4kvKLgHi6xC5LcGq9hhmiK0AYgUvLQtzm3n/x0jnum/Vo9j1jxg/pL3/f9W8isMOsv6/Ubf47rvl+u17nnZ1xQ+4iIXa6IpRVeimEEE3pnxO8kIz4CbFDyidVSpooBCCLLsj5noFlqUg2rwK0l+Anmm+VhCzKfrRHtqjGOLANxUKIUiYvFEcuaaZpXANniD5ZzpiBDTSRkuDJfWM6awxGuikUArp7fIOE7RlB6OygGTyhfsMyrtwDNIAkcp1YRhKC9Oh2IHUFQ6UPupnLL3icODaD5zVlUto7zhm1n7kmZ5kDSQBxykfZhD66eaQBoWriEGPcA182C4Crst90Z9NwvHgahDTALw/Ae4D500Pjq3oj/4sjtwcwVrCkkgB01HB8cdM0iIlWSr6IpNqFO+1mDHQFWORtO5EIi08b4jxy6giBsgKDnRnEYYdd9nIYvaLmuhS/h9DF5bEFr/7HTKAjUqWY1oUUBKgYEZdgIP6gJE2xQIWVvLhZBcAWx843kz87PDDi4cgR92s8/1FLpAGNeKiUbGtRQEIPkGb9TM1EF8MpCVEni7pIkkUdDs1ZcI/ZUer6YZg4WxTtqMmYsZJWebbOzEekZV4sCKaNhBaXQQ0NtjL71ZooNE1vWLfyyyFUbw7MsD0fWOFMSqAnbwj1Kuk0Aqp4aJ91MZhhvyS7+oQoMy5v63Jfoz/UYfPSiep2KQb5e4/gt1Ycdc7Se6jNyVbpuQNI08FrICQ6ccKnSXddrKCnqkqWFupJFAewKudSTBVAyBEjrLSXjCYnc5rrdQVl6VaiKqOTToi/kaSrlcW5fpGpgrlJTLvoGVxKDOg7PHzc6NLXOmuUHTZQhTWvS4T7T5ixPqGPz/EHXp/azkMeQoGOqBBOSq1gD4vwRe1culz8W8HlZKQt6Sjbm5XeS9eWizJw73HcsOW8mSpa0eT8zfK1w85LdtWKTf5dWfCPzMg5J+MBdsvvy6Q2QD/d91sfzouRz9zAdBp6HCcUzskccyBdKzjTC9ZE8HT8+JHLxtiE4d33Ud0uleOObvpXZk4E4/9h2sKD9t6oxgaCFxs9AHiI3wYJCndMbIMs9lLi7vEHFLxAUURyciOnTyzrLH6qSJwo+8CWuQIFL2wSoVyvQea/qtk2yvPtb4mekZMhJQkPwyvIzBbJGJD+jX3eGcfIFhWVmxsVAG5FMgSzm9y4wKL8aJdzvyctoTqEgep6K5lckWGM3uuuA5DadFvIhiTzBL1xzVtT0UDEDxd9ldeutcJLoyvUaoPgNdiqckZLamd0AAAAASUVORK5CYII=")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,R0lGODlhMAAwAPcAAAAAABMTExUVFRsbGx0dHSYmJikpKS8vLzAwMDc3Nz4+PkJCQkRERElJSVBQUFdXV1hYWFxcXGNjY2RkZGhoaGxsbHFxcXZ2dnl5eX9/f4GBgYaGhoiIiI6OjpKSkpaWlpubm56enqKioqWlpampqa6urrCwsLe3t7q6ur6+vsHBwcfHx8vLy8zMzNLS0tXV1dnZ2dzc3OHh4eXl5erq6u7u7vLy8vf39/n5+f///wEBAQQEBA4ODhkZGSEhIS0tLTk5OUNDQ0pKSk1NTV9fX2lpaXBwcHd3d35+foKCgoSEhIuLi4yMjJGRkZWVlZ2dnaSkpKysrLOzs7u7u7y8vMPDw8bGxsnJydvb293d3eLi4ubm5uvr6+zs7Pb29gYGBg8PDyAgICcnJzU1NTs7O0ZGRkxMTFRUVFpaWmFhYWVlZWtra21tbXNzc3V1dXh4eIeHh4qKipCQkJSUlJiYmJycnKampqqqqrW1tcTExMrKys7OztPT09fX19jY2Ojo6PPz8/r6+hwcHCUlJTQ0NDg4OEFBQU9PT11dXWBgYGZmZm9vb3Jycnp6en19fYCAgIWFhaurq8DAwMjIyM3NzdHR0dTU1ODg4OTk5Onp6fDw8PX19fv7+xgYGB8fHz8/P0VFRVZWVl5eXmpqanR0dImJiaCgoKenp6+vr9/f3+fn5+3t7fHx8QUFBQgICBYWFioqKlVVVWJiYo+Pj5eXl6ioqLa2trm5udbW1vT09C4uLkdHR1FRUVtbW3x8fJmZmcXFxc/Pz42Njb+/v+/v7/j4+EtLS5qamri4uL29vdDQ0N7e3jIyMpOTk6Ojo7GxscLCwisrK1NTU1lZWW5ubkhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/i1NYWRlIGJ5IEtyYXNpbWlyYSBOZWpjaGV2YSAod3d3LmxvYWRpbmZvLm5ldCkAIfkEAAoA/wAsAAAAADAAMAAABv/AnHBILBqPyKRySXyNSC+mdFqEAAARqpaIux0dVwduq2VJLN7iI3ys0cZkosogIJSKODBAXLzJYjJpcTkuCAIBDTRceg5GNDGAcIM5GwKWHkWMkjk2kDI1k0MzCwEBCTBEeg9cM5AzoUQjAwECF5KaQzWQMYKwNhClBStDjEM4fzGKZCxRRioFpRA2OXlsQrqAvUM300gsCgofr0UWhwMjQhgHBxhjfpCgeDMtLtpCOBYG+g4lvS8JAQZoEHKjRg042GZsylHjBYuHMY7gyHBAn4EDE1ZI8tCAhL1tNLoJsQGDxYoVEJHcOPHAooEEGSLmKKjlWIuHKF/ES0IjxAL/lwxCfFRCwwVKlC4UTomxIYFFaVtKomzBi8yKCetMkKnxEIZIMjdKdBi6ZIYyWAthSZGUVu0RGRsyyJ07V0SoGC3yutCrN40KcIADK6hAlgmLE4hNIF58QlmKBYIDV2g75bBixouVydCAAUOGzp87h6AsBQa9vfTy0uuFA86Y1m5jyyaDQwUJ0kpexMC95AWHBw9YkJlBYoSKs1RmhJDgoIGDDIWN1BZBvUSLr0psmKDgoLuDCSZ4G4FhgrqIESZeFMbBAsOD7g0ifJBxT7wkGyxImB+Bgr7EEA8418ADGrhARAodtKCEDNYRQYNt+wl3RAfNOWBBCr3MkMEEFZxg3YwkLXjQQQg7URPDCSNQN8wRMEggwQjICUECBRNQoIIQKYAAQgpCvOABBx2ksNANLpRQQolFuCBTETBYQOMHaYxwwQV2UVMCkPO1MY4WN3wwwQQWNJPDCJ2hI4QMH3TQQXixsVDBlyNIIiUGZuKopgdihmLDBjVisOWYGFxQJ0MhADkCdnGcQCMFHsZyAQZVDhEikCtOIsMFNXKAHZmQ9kFCBxyAEGNUmFYgIREiTDmoEDCICMKfccQAgghpiRDoqtSkcAKsk7RlK51IiAcLCZ2RMJsWRbkw6rHMFhEEACH5BAAKAP8ALAAAAAAwADAAAAf/gDmCg4SFhoeIiYqLhFhRUViMkpOFEwICE5SahDg4hjgSAQJEh16em4ctRklehkQBAaSFXhMPVaiFVwoGPyeFOK+xp4MkOzoCVLiDL7sGEF2cwbKDW0A6Oj0tyoNOBt5PhUQCwoRL1zpI29QO3gxZhNLDLz7XP1rqg1E/3kmDwLDTcBS5tgMcPkG0vCW4MkjaICoBrgmxgcrFO0NWEnib0OofORtDrvGYcqhTIhcOHIjgYgiJtx9RcuBQEiSIEkFPjOnIZMiGFi3DCiVRQFTClFaDsDDg1UQQDhs2kB4x1uPFrC1ZsrL8tCQIUQVBMLgY9uSBFKSGvEABwoSQFy5Z/7NqgVZqygSvRIU0uSeTrqIuSHF00RI3yxa0iLqIePBVwYMoQSX5LKyF4qQsTIR8NYJYEla5XSIzwnHFSBAGtzZ5IcylsyYvJ564lmz5oO3buAttabKEie/fS5bE3LYFi/Hjx7MgtZKyefMhQzCIpvTiipUr2LNjp8vcuXck0ydVt649O90tTIIrUbKEfXsS4T0jn6+ck0x/8XPr34/Dyon8iRimDhZOFFGBC6hwMcUULfhFCRckGFHEBEUwAeAvLUhxwglUYDFbXRgUMeEEGExxYSFaULHhhlUApQgOLSwh4gQTGCECXyYtMowNL6i44hVcTIcDCRXQOEEFTVg1SPAVT0SSyBZVKClIFy1MIYWGUzhpyBM0FpGEFYhxscQRSKTmiTwkiCBFbTJt4d+GCB6CxRFHROGgTFLQiYQ2OVxBAgkM5ZAFFCKIECgnWVBBBZuFvMBXIVkkcQQGIpwiRXBSOFVFoSRsVYgNd0qCwxMYHJHERTlcykSmgkBYaBUnStICEhhgIMUwly7BqiBXFAoFqurY0ASdS3iaam+75mCDFIWe8KEmVJSKQWqD5JpsDi8QCoWUymwxJgZOMGrtL1QUaqc6WShBJreCjItimlEYi4sWUNxqiLu5WCHvNtPhu98iJ/hG0r+MdGFcqAQTHAgAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDALHjxZGEqcWNCNAQNvKGokGCjQQTYX2Ry84XHjQT4a5JQk2CakwRtu1OQxWXCPAwVlqhQMBNJAm5UCoxAIcEAnTYF+bipYU4NjSwNsgP5pEIAon6MD6yjYeqdgzzYF5QgIIAAO1oF/0mxFI4NgT5ED/YypuqDtWYFSFmyVMzDQ06gCA7kZO8DO3YGA2mw1c1Xg24FVxIxFA8hkH7sF9TTY+uZGDr8XweYAhKaqGCoH96BG2CeNmihNOTLZugCFQCYOHDARaGcAWdEEZ2QYIMCoQTlmcrep4nlgljM4RQQGBKi5Bt9j+hAEVAcBgO9ngAb/pnMmt4MzcLQPtMOmiviBN6KU4RuYSoMv3wF8UdN8ZxU35jkQAR0zCHRDZQvVUFIfaoCRHwBk3PEeQTVEoUaAa+AxYUI3xEHAg2HE8cdEM8yBRm5mZNCfRDWQkR8Ya6inEUoOoKGHSXZ88UUDVGzI0A0oSGgSIG/UseJhG/k4kZJIolUHHXQ8CeWUGmIFyB9YZvlHDVuWpMcaa6ihRphgihkHkwr9kcWabLbZ3B5hihnnmGowgWZCM7SpZxYIzkDHHHP8CeigUpzFpZaIirfSnU026ihHexi30QyxHZVFHW9k4IdJNeyhhx8IalSDFHC8YWodjA7Uhx6s7iEDozdU/8HEG26YGoekE/3hKat68FGgQoHwMYeptGogxYiBaXRDFp7mwSqoCAUiRQbEZiBCRAPtIQW2CP2hB2aj+cErq+ASZAexcuwBVA11MJFuXytlgQIezBX0x6qscltQFnDEQUWoA1HBhLvq8YECCurNMC8Km+40wx57HNnQrwXJMMfAUngUSBUiiGBUIHs8REWl2wG8pBRMxDEHZhx7XFINVOCBgrpN9iHHwJK2LGkfD6FA8Vk32DFwHSTrTNANMeOhR6oJ6THwuwQZ3VDP+tL0Bx0D33Gk1H3p8VAVJm8kA9ZyVJ0DFR3jmoPCUox81x94rFYQx3WonYMffIR91IRcPxHKUB522DGT3xIBsqbehCceEAAh+QQACgD/ACwAAAAAMAAwAAAI/wBzCBxIsKDBgwgTKlxI8BIVSZcYSpxIkNMjBQo4UNxYkNNBRxgfHdzkkeNBLB3qlBzIqRFGRwY5OVpEyWRBS4kcPJjU0aUCmAXxIDCggKdNgVkQOXDgSFNFn0AHdkFjgKilowOhLHUgpaBPkQTrVDUwB+vATIuWrsHE8itBLAyqOmBrViCVpYfqEITK8lHVH13rCtz0aCmiqzlahhy4olBVRU45YqFbsBKapZA8KlYAdtOaqoRWHKwkaWVBLG7c4IlMcI6DQw8kCQSxaI0IgSV+VI06EBOHHz9EHwShqDikSaYvKYIdSSAnkiU76GaAheAmKIYECAigyLRzKGuKK/9aMwfLyhKOkCPcJOWBXueS0AgKEECAIEbenU+CFL44IyiZOLcJQ5oMmAMWjAxCn3YMSGEgQprg0Yh4azQyRX4KceIBIdvVR4gHAUqECRSMiNcBhgl1IUSHgzBSHUeWeLAGTSZFIoggaKyAIkObSCLFjgkRJgJrghVpJEeaJaakaV1EIgIUUD4JhQgiUIFVS4dspaUDaCBWSSNugNnImGG6AQKQCnWBgA5stulmczl8KWaYYjZy5lFquqmnDnA2KSWUU05p5VFY4rVllxkeyUlJSaJ5ZF2cWEKJowcVaBYmUngwRxYmbXLJJZk8SJEmVMzBQQcclEApQZlk4eolXVD/tMkkdXRgqwd11MSRJp++egmRCGURiQeocjCHJLEmtqpzXVziahagiloQFR5wcKoHUkQ0EBZUUFbpZBVh8iy0yRqEx6kdQIHYQJpIIUIk6yopECaUTFKJtJuI62q5BWECAgiTAJsDJYBymkMWK6xgcBf1UqJtRbxesiOoB2XipAilCUQJHnjoeuAk9krr3LIsSUJlJCHGybHHmtQ7yYtFXjKlCB6r3HFDIFPCL1ab4EGlFERujEcl1lUCcrxYWRIo0pWs3C/Ik3hrUxclUHlhZU5XhEW995qVSdWRPDyQ0EQX1AXIlQjMUSYrGFUQ2Qc5KzKho3Fc9qMTNY0H0ngrCrRJJqH2LXhCAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSFBVlTyqGEqcSJBTBwdmPFDcWJDTwVIOHHQ4yMkjx4Op6pwySXBDyFIGvZTS8OJkQRikFFXY0xGkA5gFpxj6ZIaPzYGXcioqxaqiS5EFVyn6ZCgUjKMDTShSNGpKQZ9AB5r6RLYO1oGrNGx1FFEgJ58jB6ZyQFYRjbMDq4zaGokgSDMdTFokC8orXoFePGy1cDUHp6dxc7BoQPZNU46p2hZ8YWHrBy8C4SK2QLYBT4MvWLAsmGpDqRSXB3IytXcUC4GR3rzpm8OEoaEaC9L4QPb2wVO633jYs1rVG50m3HopKbAOqE+hUhFkhcqBge8VVrv/NeEouSNTqVie6MBHvOwqFXg7zqPowHcDCRy5d8znQ/I3GqByl2OgLTSdQKloUMh9BoRyQoEIsVJFB/+Vksd+CXFShyEMGlLHKhPRYIIGydWBIUKriHJfAhpoh5kpjtB0EioHHKCIakd5sceFJ7HSASoQHibkkBx5ZKRjSKJ1gglLMumkCcbZ5MUGolRppZWKNAZDBx2UUkqXXX4ZyYkLsQJKAGimKQCaAqAi0JZfesllmPKdtIoha66ZJptu5rDKFCYw2WSgJ+SB1WNXJpqlQmRuZOSjbhEpqUGcpFJTj2/UEdtJNFRxyimaUWTKF1+YkUKjBrGyRySmtJoCR6t8/wLArAGMcilDXrxgwimtnmLCrRPJ5Mmss3pSyoAIcXLJFLzyGgkLsaFK0AuK8EAsAIVEEiRBe/DaaxXI5pAKC+HGpEq0KTTwBbFfKLKtQFX0ekJ626VwwhQupnpJKpesxkodBxAbyn40oIIKH+++cMK9bV3ywgttsZLKxCAWdIkGnXRSRUI0VCycvSeclgMMeeSRryoTX/JuDnucehILC6fg8bgsNJaDF/umUu5ZqgB6gs0js1AzQaukvPJJXuSxcBWbwsCCyRXtC4Mq0i6UysInXHKT0PkKVPTEm9rEir1Qiud0HkALhDK/VaNYhQlT7Oz00AVJzO/RFK3CR9pvPhndNVo0tG0TyXRPKhHNfxue4Sqr4K244QEBACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwBgsWNBhKnFjwiRo1pihqLMjpIK2LdA7m6rjxoJYRJkgS/KgmZMFctGZhKVkwy4Y3jnBxZOmS4IpYh2TppClwxs03dDQV/Eihp8BVRxw4UKOF6MAUb7KuIMiJliw1TwqikuqgltWBmjxknRVRYFeQBLXIknpk1dmBlBxlNbHyYtiBtKTGUnF3ICdTR45oyAL4a08XaKRuyFVyRtuaGrI+6fgWrMBcGqRGGFoQF6WEM2jRWUFZbFZHp3OYWLKEb44UQB04FUiDjlQXCG3RnjUCl8ocNJbgJJyDk/OBtWI5oFB1YC4TsgwpULABYQoPS2aF/0dVXaCKJzMRcmLhyJZhFm20bzfk4bhhLLXEi6eVwm5z+yKRlMUSQmyngCEUqAAgQblQ8oR44dFByYIJcTKCAwYqgEYtSkm0Sgq0hDcLKhQilMsi8h3iQXkUzWDCLB4wtpEKZRjyBnBEcWJaiRWacktrhQUpZEmcNefWcwJpsoIKS6rApJMqkEbkLItUaWUbbSxyhIwnmWLKCF6G6aNVmjgAy5kFoHkmLO7l0KWXYIp5C5lmrmnnmW0qCeWTT+JIEydUWiloG1sOuRCSziFp6KKGzSDjRppoMAKQJa1CyS23XEYRKoIIgoaCkGKRgi2ksgCpEAGkWsARUirESRYqkP9KqgosSgQTAq+kGkACHmhqECcOyXpLClgAyeNTrWHRRgG6viKECZQShMUtwlLiH2+4XGtQLiMksIRhKqAhiK6CtLGgC6TessIMxzXIAiUzIPRGKwD44GcOmoxgSK4ByLLgKk5mAaAWD7Hg3yozzODfE/QCoIZ9Rh1wwFYIrdJhQZaysEJ6yGWRRVuaHAIAAGCkcJALzG2ExUOUXEyDx5elAMbIQlx81yoas8Diyx8bpsbIrfx1FycurMCCC5TyrCkuPoyMQK00zWA0RAU52jNBS4wMgCN35eKCxsYVpHTVQIzcQ2xEaULJQ9ryBrNBtbgCwCsmn5VLFlB3fDWDFAwUxihBY297bGGB/31oLiMZrnhBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDCTCxeZGEqcWPDOmzd3KGosyOmgnQtv7Bzk1HHjQVW2qJQk+PGCyII3RPxKZbKgql9MmtAsaOeiCIMs2Ci64KfmwEw4mdy5UVDExZcDWUFSNFSV0YEsmGhlQZDTxzc/CdqiusbW1ah2tIqowfIpQVVvqEJidXbgiyZaqbAEKaIkJxFU2QCrO5CTCa1OLg38CvWFBapOVlLMxNbgJSdaTXT06jYHpyZULbw4mMpFwkwlSrhgWpCK1iajc1D59UtvDhVrqEIdWEOEBAlFDwITIcKOrVSSe+cMVnilCaG+rA68QYUNrwa8miBkYYd4cRURBwb/K7FzZDAmtgW60PCA1/UHvyQTvISiO/E7LOh6ln+QdY7LETSA3QNvsMBfVy+Y4J0dJvhxYEKclCCBe+4pYoJ+DLESzB3epTfRDb5gx0sEv0inUSYq2HGHYhux0B4TsdXESSoxahShCv4RpuOOJpHk2Y+S3eBCMEMGY2SR5dUUAkhv+HKRk29owGImKJhggi1YYnklMA8ydAMbCoQp5gJhLmAbSlnacqWatgxm1JdixlmmbUIaeeSdSW70ly++aNCnn3wywSKPhBZaVyYmanQDEyVgaBIrfgTDQmUamaCLLooYuNENqUjKAjDBUVRDLwaUmoAGeUKoigufAsMCRJuG/7BLqaXuEkJ4CdXwAgutBnNJlwfVwJofGiRAqwEPoJAjQanw6ioLqTjKiirLEnTDHbtoJxAnwCiiC60I+HJgs66+UINknFySSrQC3cDKuQJpMEAACdR4gwkN0GrBgaw8pAp/mazLLidvXHqBQHbMK4AFBqniRJhcIcRKtTncoG4q4XHCCwAA8CIQK70EEIAYKhy0K7AIBZzKrwNt3HFJKoghci+OnsXKupdQqjHHHg9kgQABDLDbWar4sfJKO3dMkB8JiLxAokbVILCjSfc8UBNAB8BEXemm4gfUVUuWSQMi68LcVRavvGzYBZVAgAC6lHwWJ5Qd5LLV01kggZuGehZ2d38oE9YLxxH0LdELdthRo+GM5xAQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEiQGAwYxBhKnFgQhTBhKChqLFjsoIklwkwc7LgRYSZgVw7iuSiSowk7l0oWzFRCBEyDJlga5JMBg5IsMgcSMyFCBAqSA3OGLGjjiRufM4IO5GPHJq6CSvEUlISh6zCpA3OhKGrCBsGcS1oKzLSkqxyzYAVeqiqCEkE8ILUmdeMmg924AotJKloi08CVS/TmyKKk6xOkFInBnRmpqCSSaFsWE9E1CVCDl2AkJCZpWBbIAq8UtfP5SqRIKXNQyvBUrVATfD/vxMMb2AzINohGuhoYqaSeSwwPFJxEkfPHB2Gg4I0HBaWIA2FIioqwGIwnkgji/5JTxLmiIpESZroynfcwXLmWM0Q6t4L5IksooeZ4SRJ1FJLEtBEKbtyHwTCTLZQLDMO0d8V+ChUjjHmM2KGcRsRQggIKF1JESQUVOKGbTJmMSFExeAADIWAstjgRSTBCVkwWD2VBIww3cidTMZEoscQSPgL5oxzcEXPFkUgmSdyOGTgwhANQRvkkMAIZmeSVS5ZUDAZRSjnEEKFQmcOMONqIY406yhQJSBe1CRKRLkq0Ypx0DmRDgic+YUJ8QeWSySWX8KmRJAww4IZ+GxVDzCU2ZpGmRLm4ocCkQixhYkLF2DBDo47iOV8koUw6aSgiYJdQLps2egkxJOXiqUE28P95iRxDiBqEIigIWtCiqmYCmTCFiKArQcWYEMoTBFGCQRC2LgFhiTbOMCwuPejQihsCuWoDScL8YAADI4olgahJdDfDJZ4Wo4gO1iKbgxJBBKGEQCV4a0ASqBEjApRZcgQhCjywOwRcRAQQABHZKmKAAQmIWVAWf2lkgxDsBvBVDrkUfDBJVySwsCLDSvVEK+wWAaPGRCCVxMI/lMDiJT+w60OWKBOUBQMLO/CoTBmwq8MSxBb8CsIEPbGwAU7ERckr7BbSYQ4oQ0YMEQsr0O9GwzDdSnpBG0z0WQgYoEBsUkkSiiKeRl1QLhkwQjZYxYRcDBGvHDzSnC0qUrcieNcLmV0JJYjm9+AGBQQAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSBCQlmWAGEqcWHAFFBErKGqUKEmECEkHA21MCEhZn4OSLoI0mOzElpEFa7RE9rJgx48Gl8lZcqwmzByAJJ04sUIkwZsrB3qpxYTnn58Dlw09scymx4wEW8hhwuQK1IGBVpyQIsnLUY9Jc9R4whWK2a8C/yAbenIgUoLJuMqpCzdHoBZDkdUYuALtQC20mpYwqhHQ24KAWp5oYfQm1kBSuNLScnBLVYQllW1hPLDP1JrKkCFTJrDPTibJDEbesIHzwWVXcisbTNCLUGSfDV5J/IS3wL9yMCiHglBL7ucQCTp/mlBLiRYEl4lAohwDEimkCdb/gPH8SotljyUy/iMliRs3ymkpC2/wj7Lyyv7QXyhpSXcMS5Q1USBatLBCbjBsFMgTGMCXhBTUNYZbC8ZR1AcSSIgQHEw1RLiRJFfs19eIJKoH1nGkBfLHiiy2WOFIJdAioxwy1vhETV4so+OOPPo0UiBLKCLkkERil4MXD/HYI1RAEulkEUaq2OKUL2oUyAm0HHNMllweI4KHJYYp5k+AMBiRgrUkk56VyRjzxRcijHTFA7wkwdpGfRQBBgB8klGlQl4kwcugEBxjG0N/LOEDn3x6ssSaC12pCC9mUCpBCX8qVQsZjAIAhiJ1eZFpb0ZtcQwElFbqhiT7eaHIF4x+/2EMMozJYUwJkB4nCRvMlbYEnYM+cAx9gTzAKAJPnNnaGAF0ksRxgABilAigKPDAhr4ZQSkvTOwnSSedIOGjX0YIEIAnzAXCxKBMCITMAgoosER4NZQggQQJIpSMkTYVEEAAEJxphAEGsCGQFxjEawxWBS3DF0WAQPBvAQwPbIARRiljRrxG5AoTFJ0IIIAbRgVisREEyRHvAieMuMUCIo+Rr0AnSwdBvBGACdMS/wogR0E1E1RLvAo8AZcyB/xrjIcmE4yxeGzEy8vMMElygACelFBQ0xeHJ0m1vPD70woSdGxQ0AQFIoedIwaSKxsEG2xQICKWiEEBBmAw5kRSSQex4d6ADxQQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwE5ctmxhKnFgQFx48lShqlEjpYkaDxTYm3JQly8FKFymBpGSFi8iCmihdoVTDYEc8KgtqseMMlcuXAjdVunIFV0iCNz8OLIbCWc+aQAVyIXrl58CkBf04taM0ajFcRCtFHIgSJ8Eaz5ziGRtVYA2ZV7Qg9Yh0q8m2BLMQpaSJLF2pkZwOO6qxGGGCMYn6ufq32DCnkawS5CIXYTEtWvoa1LL3p94ri3Nk4eksZ0MrIEBsQcilZJYtmpcOpbRa4GFcgZ/FzvHVTocOHPAgrKHFdRYubHNwwQUV4ZZhuAhuQdWMA/Bmw0ZuMa6lxmGGhGtA/5vDwXqHSFm+G9S03XV3kZSe/Lb+hFJyhcWIu65NsRgq83MM0xxFDmF2n0RZNNPMM/y9tMluGhWlHl4UWmYbb7xN+NKEhOGCBi8ghhhiIwdS9BhPKDpjhx2RCRSJDjDGKCMzAxYGQiMX4Ihjjjl+ZIeMQOpAI1DFgMCjjhfk2MhHHooo4iGNaCgRNE5tpSJkkhmGYYYVdumlSJrYkUSJCxWDBzRkTomGIIJEAt8iozQT3UZ+XDBIAHgKUWOZzUzgZxt2NKgQF80QIgCeAhAyR5oHOdbIKH5O0AgeezaECigCHCrAIG2E9iBDmxzFhR1tRDqKEldweIEgmQYgyAPQEP/2xAPPkFnMFY6gQpAfcywyAaSjONPoBIgaYsdufoACywEd2BbqUZE8wMsEldl2hRKQTgDChFYccAAHguaQBCyDHKBrDs4sssgTAkHzwCGHzPFdDXjkeNdB0HQ1kBWEwALLBGM5ooACUfLGAS+HoKGvQFuEppEmE/hbyBUDCUzwQLhEAOKYXaLCjL9JEJbEwI0Q9ESI2VG4BS/+gnJvDhYXzPAEh/CyiGRAzeEvLOwSNPLFBOGBMC924IWLAv4+gLPFjhymSSMgRvCySFYgfYBwBcX83RXSprHwRlcswnHWJIMEQgcOt6WlQTE3+iVCHAwc8tsTaTHMMNXSrbdBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSPDGqlWcGEqcWDDLlStZKGqUaPEKlo0bOWXKdBDLFSsfDWJRZgNkwRtasmi5ofJkSoKZUOBRscrlQE4xs5AsaNJjQU5X8OBJ0dKnQBtZovYkWPSmQC1KUWR0KpDTlqhaIg6s2lCFUis0uT6NmmWqQLJjleLZohYn2LQ54OawkUIKnmBiNaYIdhBoVLpvL95UpjSFW4Krhh5U0amTBi0GV7FNu8WSJcRbdOKxZPCGshIlHv8MBaC1rhBNu37VonpgFp0q8ObglAUPFCjOrBy8oehLawBfGqQIbGOLboOZrmAemEkFcGfOoBAeXqvQcQA8FJH/psj8Si3s2FGEVZiplI/vPko9Z2hJCvYQUKRYCrzQkqIAxyVQm0KcqIBeLVfERlEKDXzxhTMgbVELFCpIBpINIbyhIEWWbKUWf3UlxMmIu0VEYogLYaGIKKKsyOKLkICo0RVS1FgjHjbiMZUUAfTo44+gDDhRLaUU2UGRpRzZQUol/OhkAKBsSF4tRxqJZAdLvuUiixO8KAok802ElI1k3uiWiSWSKCOKbLaJ0A0ldBDmQgUC5pQViugSjRQgWaJBBiF4SBEWGiRgQDTRTCMlgRm+8YYGUljIXghBGHBoNEGEMGdCVpTiqKMdqLDoQDfgMQ2iiCaQwU2bkipWJlJo//DpG07YaRAnGegZjQG6KGJFYLVQo8KauwXTAR4EZRFCBqQ4moEUMnLCCKoNlKAbFtOAkmlXuw2EBzWKvDFdV8E0IesbUCCkDBmFOCFpDk2wGwSfOUDxBinp5mAFuIo4AyJfkEAyrkFWKHNQMA2QAQopaXUgjTQx5nCDE4oowojBBn0F0g1vFFJIA1cMVIoZ0pQyFiMVN9GqRiiA4nETgZUijRkmDwRFxWsIV1cmiigciqAdkByxQJlkULEGQmrkjMug5Cvyw0MLlMIaFdPrVBbSeKyIpA6bAUlBNpRSMSmCgqRMKIWAgoJBI5dsUDBrUMOIVS4po0EpMsoMMYicQB7hRNk+nVhQ11/f6uZBTZDcweETbWGFFQMzLvlAAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSLDYjRvFGEqcWPBPqlR/KGpseOOgRYwbN6oINaFjxYsZDWpJZTLkwGQEALiqZfBjSoJd9kyqBMjlwD2CAAAAclPgR0wGYUyatKelTyRCAXA4CZIgJp2TkPocqAWBUB8wCNpsWGmppYhbBz5pJZQC2hxjuS7d0yUtQUDVhAZINjBujhtYw4bMU+lgMh5Ch/SEi3JgqqWTFhe8URfhpB8/OGgdWIyC0FZPBHbBhKnyH8ipDBZLlUyF5IYTAgR4tcDO60oxWzVCiKlsJadw89gaXlh1GwKyAxCAoOItByC2EwKCUbRLpVvDbd2yhPCGiWqvkg//ciOYssYbMJJlv5V1IaZmhMLPJvTh7UQtKtarSGVfIQw3g4T3SjWVTVTMHtklYwlwDBWjAgQECELTRn/ccgtdWwFihwYMSpQKJv25FKJdCkX01ogkGpSKG9RQ04aLL7Y4S4cTWaLCjTjimMdithjg44+D/CjNaxvdIsKRSCJphxYC9fjjkz6GQiRFxSST5JVLCpRKIy3G2KKMNEpkY4457thQDvahmOKabCp0g5FhJnTgWVtV0sgCDKgQkhbNNGPCZhTxWc0nhLYRp2qozMLBLB8kU+BCgNQCAaGESmOHmgjtccwsis7yRFMlqkDBApRWw0FqaGIq0FtdJPNBp7PU/8LfQcU0wwClC7QxCUEmILFrQjA8oedAmJjQzKIcNMOXahpQGoEtr2lBgTShTGjiQCog0QgHRRVjiQiccnALQpVIM8QTRQl0zBDSSDNuDrZwwIEJAu2hbSP0TpbHMccAWtAe3BlkSQTscqguBRN8sKoIjbihAaoVMbnRDRu0C0FxORwzQcJopaKBG26IcChFI7GrsFoTUHCyQCY00ggSe6TYhRvsyiKxuhsfI9YsbjTSzJQh1WKuNKgUdAzCKwukgsuNLLuVFhOY68ajGW+c9F8f9KxZWpbIMkQowxKkMccFWYKEGxvc7BMMsxwT4thXo2lCliQWM6LGKtPaJkIipA8c2t4T/bHHHv4CbjhBAQEAOw==)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 31 | 数据流：通过 iam-authz-server 设计，看数据流服务的设计</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>31 | 数据流：通过 iam-authz-server 设计，看数据流服务的设计</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这一讲我们来了解目前业界有哪些优秀的开源日志包，以及手把手教你从 0 编写一个日志包</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 31 | 数据流：通过 iam-authz-server 设计，看数据流服务的设计</h1><div><span>孔令飞</span> <span> 2021-08-05</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/b4/79/b4efa59f9a6065da72715a635f51e279.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：孔令飞</span><span>大小：18.29M</span><span> 时长：20:01</span></div></div><audio title="31 | 数据流：通过iam-authz-server设计，看数据流服务的设计" src="https://res001.geekbang.org/media/audio/15/54/1527955e262a2f78eb7f7a4629f92c54/ld/ld.m3u8" __idm_id__="319499"></audio></div><div><div><div><div data-slate-editor="true" data-key="15850" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="15851"><span data-slate-object="text" data-key="15852"><span data-slate-leaf="true" data-offset-key="15852:0" data-first-offset="true"><span data-slate-string="true">你好，我是孔令飞。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15853"><span data-slate-object="text" data-key="15854"><span data-slate-leaf="true" data-offset-key="15854:0" data-first-offset="true"><span data-slate-string="true">在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15855"><span data-slate-object="text" data-key="15856"><span data-slate-leaf="true" data-offset-key="15856:0" data-first-offset="true"><span data-slate-string="true">28 讲</span></span></span></a><span data-slate-object="text" data-key="15857"><span data-slate-leaf="true" data-offset-key="15857:0" data-first-offset="true"><span data-slate-string="true"> 和 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15858"><span data-slate-object="text" data-key="15859"><span data-slate-leaf="true" data-offset-key="15859:0" data-first-offset="true"><span data-slate-string="true">29 讲</span></span></span></a><span data-slate-object="text" data-key="15860"><span data-slate-leaf="true" data-offset-key="15860:0" data-first-offset="true"><span data-slate-string="true"> ，我介绍了 IAM 的控制流服务 iam-apiserver 的设计和实现。这一讲，我们再来看下 IAM 数据流服务 iam-authz-server 的设计和实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15861"><span data-slate-object="text" data-key="15862"><span data-slate-leaf="true" data-offset-key="15862:0" data-first-offset="true"><span data-slate-string="true">因为 iam-authz-server 是数据流服务，对性能要求较高，所以采用了一些机制来最大化 API 接口的性能。另外，为了提高开发效率，避免重复造轮子，iam-authz-server 和 iam-apiserver 共享了大部分的功能代码。接下来，我们就来看下，iam-authz-server 是如何跟 iam-apiserver 共享代码的，以及 iam-authz-server 是如何保证 API 接口性能的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15863" id="sr-toc-1"><span data-slate-object="text" data-key="15864"><span data-slate-leaf="true" data-offset-key="15864:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的功能介绍</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15865"><span data-slate-object="text" data-key="15866"><span data-slate-leaf="true" data-offset-key="15866:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 目前的唯一功能，是通过提供 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15867"><span data-slate-object="text" data-key="15868"><span data-slate-leaf="true" data-offset-key="15868:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="15869"><span data-slate-leaf="true" data-offset-key="15869:0" data-first-offset="true"><span data-slate-string="true"> RESTful API 接口完成资源授权。 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15870"><span data-slate-object="text" data-key="15871"><span data-slate-leaf="true" data-offset-key="15871:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="15872"><span data-slate-leaf="true" data-offset-key="15872:0" data-first-offset="true"><span data-slate-string="true"> 接口是通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15873"><span data-slate-object="text" data-key="15874"><span data-slate-leaf="true" data-offset-key="15874:0" data-first-offset="true"><span data-slate-string="true">github.com/ory/ladon</span></span></span></a><span data-slate-object="text" data-key="15875"><span data-slate-leaf="true" data-offset-key="15875:0" data-first-offset="true"><span data-slate-string="true"> 来完成资源授权的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15876"><span data-slate-object="text" data-key="15877"><span data-slate-leaf="true" data-offset-key="15877:0" data-first-offset="true"><span data-slate-string="true">因为 iam-authz-server 承载了数据流的请求，需要确保 API 接口具有较高的性能。为了保证 API 接口的性能，iam-authz-server 在设计上使用了大量的缓存技术。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15878" id="sr-toc-2"><span data-slate-object="text" data-key="15879"><span data-slate-leaf="true" data-offset-key="15879:0" data-first-offset="true"><span data-slate-string="true">github.com/ory/ladon 包介绍</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15880"><span data-slate-object="text" data-key="15881"><span data-slate-leaf="true" data-offset-key="15881:0" data-first-offset="true"><span data-slate-string="true">因为 iam-authz-server 资源授权是通过 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15882"><span data-slate-object="text" data-key="15883"><span data-slate-leaf="true" data-offset-key="15883:0" data-first-offset="true"><span data-slate-string="true">github.com/ory/ladon</span></span></span></span><span data-slate-object="text" data-key="15884"><span data-slate-leaf="true" data-offset-key="15884:0" data-first-offset="true"><span data-slate-string="true"> 来完成的，为了让你更好地理解 iam-authz-server 的授权策略，在这里我先介绍下 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15885"><span data-slate-object="text" data-key="15886"><span data-slate-leaf="true" data-offset-key="15886:0" data-first-offset="true"><span data-slate-string="true">github.com/ory/ladon</span></span></span></span><span data-slate-object="text" data-key="15887"><span data-slate-leaf="true" data-offset-key="15887:0" data-first-offset="true"><span data-slate-string="true"> 包。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15888"><span data-slate-object="text" data-key="15889"><span data-slate-leaf="true" data-offset-key="15889:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_ccdaf60d" data-attr-id="42725" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Ladon 是用 Go 语言编写的用于实现访问控制策略的库，类似于 RBAC（基于角色的访问控制系统，Role Based Access Control）和 ACL（访问控制列表，Access Control Lists）。但是与 RBAC 和 ACL 相比，Ladon 可以实现更细粒度的访问控制，并且能够在更为复杂的环境中（例如多租户、分布式应用程序和大型组织）工作。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15890"><span data-slate-object="text" data-key="15891"><span data-slate-leaf="true" data-offset-key="15891:0" data-first-offset="true"><span data-slate-string="true">Ladon 解决了这个问题：在特定的条件下，谁能够 / 不能够对哪些资源做哪些操作。为了解决这个问题，Ladon 引入了授权策略。授权策略是一个有语法规范的文档，这个文档描述了谁在什么条件下能够对哪些资源做哪些操作。Ladon 可以用请求的上下文，去匹配设置的授权策略，最终判断出当前授权请求是否通过。下面是一个 Ladon 的授权策略样例：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="15892"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15893"><span data-slate-object="text" data-key="15894"><span data-slate-leaf="true" data-offset-key="15894:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15895"><span data-slate-object="text" data-key="15896"><span data-slate-leaf="true" data-offset-key="15896:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15897"><span data-slate-leaf="true" data-offset-key="15897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"description"</span></span></span></span><span data-slate-object="text" data-key="15898"><span data-slate-leaf="true" data-offset-key="15898:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15899"><span data-slate-leaf="true" data-offset-key="15899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"One policy to rule them all."</span></span></span></span><span data-slate-object="text" data-key="15900"><span data-slate-leaf="true" data-offset-key="15900:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15901"><span data-slate-object="text" data-key="15902"><span data-slate-leaf="true" data-offset-key="15902:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15903"><span data-slate-leaf="true" data-offset-key="15903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"subjects"</span></span></span></span><span data-slate-object="text" data-key="15904"><span data-slate-leaf="true" data-offset-key="15904:0" data-first-offset="true"><span data-slate-string="true">: [</span></span></span><span data-slate-object="text" data-key="15905"><span data-slate-leaf="true" data-offset-key="15905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"users:&lt;peter|ken&gt;"</span></span></span></span><span data-slate-object="text" data-key="15906"><span data-slate-leaf="true" data-offset-key="15906:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="15907"><span data-slate-leaf="true" data-offset-key="15907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"users:maria"</span></span></span></span><span data-slate-object="text" data-key="15908"><span data-slate-leaf="true" data-offset-key="15908:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="15909"><span data-slate-leaf="true" data-offset-key="15909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"groups:admins"</span></span></span></span><span data-slate-object="text" data-key="15910"><span data-slate-leaf="true" data-offset-key="15910:0" data-first-offset="true"><span data-slate-string="true">],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15911"><span data-slate-object="text" data-key="15912"><span data-slate-leaf="true" data-offset-key="15912:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15913"><span data-slate-leaf="true" data-offset-key="15913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"actions"</span></span></span></span><span data-slate-object="text" data-key="15914"><span data-slate-leaf="true" data-offset-key="15914:0" data-first-offset="true"><span data-slate-string="true"> : [</span></span></span><span data-slate-object="text" data-key="15915"><span data-slate-leaf="true" data-offset-key="15915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"delete"</span></span></span></span><span data-slate-object="text" data-key="15916"><span data-slate-leaf="true" data-offset-key="15916:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="15917"><span data-slate-leaf="true" data-offset-key="15917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"&lt;create|update&gt;"</span></span></span></span><span data-slate-object="text" data-key="15918"><span data-slate-leaf="true" data-offset-key="15918:0" data-first-offset="true"><span data-slate-string="true">],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15919"><span data-slate-object="text" data-key="15920"><span data-slate-leaf="true" data-offset-key="15920:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15921"><span data-slate-leaf="true" data-offset-key="15921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"effect"</span></span></span></span><span data-slate-object="text" data-key="15922"><span data-slate-leaf="true" data-offset-key="15922:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15923"><span data-slate-leaf="true" data-offset-key="15923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"allow"</span></span></span></span><span data-slate-object="text" data-key="15924"><span data-slate-leaf="true" data-offset-key="15924:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15925"><span data-slate-object="text" data-key="15926"><span data-slate-leaf="true" data-offset-key="15926:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15927"><span data-slate-leaf="true" data-offset-key="15927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"resources"</span></span></span></span><span data-slate-object="text" data-key="15928"><span data-slate-leaf="true" data-offset-key="15928:0" data-first-offset="true"><span data-slate-string="true">: [</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15929"><span data-slate-object="text" data-key="15930"><span data-slate-leaf="true" data-offset-key="15930:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15931"><span data-slate-leaf="true" data-offset-key="15931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"resources:articles:&lt;.*&gt;"</span></span></span></span><span data-slate-object="text" data-key="15932"><span data-slate-leaf="true" data-offset-key="15932:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15933"><span data-slate-object="text" data-key="15934"><span data-slate-leaf="true" data-offset-key="15934:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15935"><span data-slate-leaf="true" data-offset-key="15935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"resources:printer"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15936"><span data-slate-object="text" data-key="15937"><span data-slate-leaf="true" data-offset-key="15937:0" data-first-offset="true"><span data-slate-string="true">  ],</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15938"><span data-slate-object="text" data-key="15939"><span data-slate-leaf="true" data-offset-key="15939:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15940"><span data-slate-leaf="true" data-offset-key="15940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"conditions"</span></span></span></span><span data-slate-object="text" data-key="15941"><span data-slate-leaf="true" data-offset-key="15941:0" data-first-offset="true"><span data-slate-string="true">: {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15942"><span data-slate-object="text" data-key="15943"><span data-slate-leaf="true" data-offset-key="15943:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15944"><span data-slate-leaf="true" data-offset-key="15944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"remoteIP"</span></span></span></span><span data-slate-object="text" data-key="15945"><span data-slate-leaf="true" data-offset-key="15945:0" data-first-offset="true"><span data-slate-string="true">: {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15946"><span data-slate-object="text" data-key="15947"><span data-slate-leaf="true" data-offset-key="15947:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15948"><span data-slate-leaf="true" data-offset-key="15948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"type"</span></span></span></span><span data-slate-object="text" data-key="15949"><span data-slate-leaf="true" data-offset-key="15949:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15950"><span data-slate-leaf="true" data-offset-key="15950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"CIDRCondition"</span></span></span></span><span data-slate-object="text" data-key="15951"><span data-slate-leaf="true" data-offset-key="15951:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15952"><span data-slate-object="text" data-key="15953"><span data-slate-leaf="true" data-offset-key="15953:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15954"><span data-slate-leaf="true" data-offset-key="15954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"options"</span></span></span></span><span data-slate-object="text" data-key="15955"><span data-slate-leaf="true" data-offset-key="15955:0" data-first-offset="true"><span data-slate-string="true">: {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15956"><span data-slate-object="text" data-key="15957"><span data-slate-leaf="true" data-offset-key="15957:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="15958"><span data-slate-leaf="true" data-offset-key="15958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cidr"</span></span></span></span><span data-slate-object="text" data-key="15959"><span data-slate-leaf="true" data-offset-key="15959:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15960"><span data-slate-leaf="true" data-offset-key="15960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"192.168.0.1/16"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15961"><span data-slate-object="text" data-key="15962"><span data-slate-leaf="true" data-offset-key="15962:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15963"><span data-slate-object="text" data-key="15964"><span data-slate-leaf="true" data-offset-key="15964:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15965"><span data-slate-object="text" data-key="15966"><span data-slate-leaf="true" data-offset-key="15966:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15967"><span data-slate-object="text" data-key="15968"><span data-slate-leaf="true" data-offset-key="15968:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15969"><span data-slate-object="text" data-key="15970"><span data-slate-leaf="true" data-offset-key="15970:0" data-first-offset="true"><span data-slate-string="true">策略（Policy）由若干元素构成，用来描述授权的具体信息，你可以把它们看成一组规则。核心元素包括主题（Subject）、操作（Action）、效力（Effect）、资源（Resource）以及生效条件（Condition）。元素保留字仅支持小写，它们在描述上没有顺序要求。对于没有特定约束条件的策略，Condition 元素是可选项。一条策略包含下面 6 个元素：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15971"><div data-slate-type="list-line" data-slate-object="block" data-key="15972"><span data-slate-object="text" data-key="15973"><span data-slate-leaf="true" data-offset-key="15973:0" data-first-offset="true"><span data-slate-string="true">主题（Subject），主题名是唯一的，代表一个授权主题。例如，“ken” or “printer-service.mydomain.com”。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15974"><span data-slate-object="text" data-key="15975"><span data-slate-leaf="true" data-offset-key="15975:0" data-first-offset="true"><span data-slate-string="true">操作（Action），描述允许或拒绝的操作。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15976"><span data-slate-object="text" data-key="15977"><span data-slate-leaf="true" data-offset-key="15977:0" data-first-offset="true"><span data-slate-string="true">效力（Effect），描述策略产生的结果是 “允许” 还是 “拒绝”，包括 allow（允许）和 deny（拒绝）。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15978"><span data-slate-object="text" data-key="15979"><span data-slate-leaf="true" data-offset-key="15979:0" data-first-offset="true"><span data-slate-string="true">资源（Resource），描述授权的具体数据。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15980"><span data-slate-object="text" data-key="15981"><span data-slate-leaf="true" data-offset-key="15981:0" data-first-offset="true"><span data-slate-string="true">生效条件（Condition），描述策略生效的约束条件。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15982"><span data-slate-object="text" data-key="15983"><span data-slate-leaf="true" data-offset-key="15983:0" data-first-offset="true"><span data-slate-string="true">描述（Description），策略的描述。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15984"><span data-slate-object="text" data-key="15985"><span data-slate-leaf="true" data-offset-key="15985:0" data-first-offset="true"><span data-slate-string="true">有了授权策略，我们就可以传入请求上下文，由 Ladon 来决定请求是否能通过授权。下面是一个请求示例：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="15986"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15987"><span data-slate-object="text" data-key="15988"><span data-slate-leaf="true" data-offset-key="15988:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15989"><span data-slate-object="text" data-key="15990"><span data-slate-leaf="true" data-offset-key="15990:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15991"><span data-slate-leaf="true" data-offset-key="15991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"subject"</span></span></span></span><span data-slate-object="text" data-key="15992"><span data-slate-leaf="true" data-offset-key="15992:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="15993"><span data-slate-leaf="true" data-offset-key="15993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"users:peter"</span></span></span></span><span data-slate-object="text" data-key="15994"><span data-slate-leaf="true" data-offset-key="15994:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15995"><span data-slate-object="text" data-key="15996"><span data-slate-leaf="true" data-offset-key="15996:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="15997"><span data-slate-leaf="true" data-offset-key="15997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"action"</span></span></span></span><span data-slate-object="text" data-key="15998"><span data-slate-leaf="true" data-offset-key="15998:0" data-first-offset="true"><span data-slate-string="true"> : </span></span></span><span data-slate-object="text" data-key="15999"><span data-slate-leaf="true" data-offset-key="15999:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"delete"</span></span></span></span><span data-slate-object="text" data-key="16000"><span data-slate-leaf="true" data-offset-key="16000:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16001"><span data-slate-object="text" data-key="16002"><span data-slate-leaf="true" data-offset-key="16002:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16003"><span data-slate-leaf="true" data-offset-key="16003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"resource"</span></span></span></span><span data-slate-object="text" data-key="16004"><span data-slate-leaf="true" data-offset-key="16004:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16005"><span data-slate-leaf="true" data-offset-key="16005:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"resources:articles:ladon-introduction"</span></span></span></span><span data-slate-object="text" data-key="16006"><span data-slate-leaf="true" data-offset-key="16006:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16007"><span data-slate-object="text" data-key="16008"><span data-slate-leaf="true" data-offset-key="16008:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16009"><span data-slate-leaf="true" data-offset-key="16009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"context"</span></span></span></span><span data-slate-object="text" data-key="16010"><span data-slate-leaf="true" data-offset-key="16010:0" data-first-offset="true"><span data-slate-string="true">: {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16011"><span data-slate-object="text" data-key="16012"><span data-slate-leaf="true" data-offset-key="16012:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16013"><span data-slate-leaf="true" data-offset-key="16013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"remoteIP"</span></span></span></span><span data-slate-object="text" data-key="16014"><span data-slate-leaf="true" data-offset-key="16014:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16015"><span data-slate-leaf="true" data-offset-key="16015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"192.168.0.5"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16016"><span data-slate-object="text" data-key="16017"><span data-slate-leaf="true" data-offset-key="16017:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16018"><span data-slate-object="text" data-key="16019"><span data-slate-leaf="true" data-offset-key="16019:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16020"><span data-slate-object="text" data-key="16021"><span data-slate-leaf="true" data-offset-key="16021:0" data-first-offset="true"><span data-slate-string="true">可以看到，在 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16022"><span data-slate-object="text" data-key="16023"><span data-slate-leaf="true" data-offset-key="16023:0" data-first-offset="true"><span data-slate-string="true">remoteIP="192.168.0.5"</span></span></span></span><span data-slate-object="text" data-key="16024"><span data-slate-leaf="true" data-offset-key="16024:0" data-first-offset="true"><span data-slate-string="true"> 生效条件（Condition）下，针对主题（Subject） </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16025"><span data-slate-object="text" data-key="16026"><span data-slate-leaf="true" data-offset-key="16026:0" data-first-offset="true"><span data-slate-string="true">users:peter</span></span></span></span><span data-slate-object="text" data-key="16027"><span data-slate-leaf="true" data-offset-key="16027:0" data-first-offset="true"><span data-slate-string="true"> 对资源（Resource） </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16028"><span data-slate-object="text" data-key="16029"><span data-slate-leaf="true" data-offset-key="16029:0" data-first-offset="true"><span data-slate-string="true">resources:articles:ladon-introduction</span></span></span></span><span data-slate-object="text" data-key="16030"><span data-slate-leaf="true" data-offset-key="16030:0" data-first-offset="true"><span data-slate-string="true"> 的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16031"><span data-slate-object="text" data-key="16032"><span data-slate-leaf="true" data-offset-key="16032:0" data-first-offset="true"><span data-slate-string="true">delete</span></span></span></span><span data-slate-object="text" data-key="16033"><span data-slate-leaf="true" data-offset-key="16033:0" data-first-offset="true"><span data-slate-string="true"> 操作（Action），授权策略的效力（Effect）是 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16034"><span data-slate-object="text" data-key="16035"><span data-slate-leaf="true" data-offset-key="16035:0" data-first-offset="true"><span data-slate-string="true">allow</span></span></span></span><span data-slate-object="text" data-key="16036"><span data-slate-leaf="true" data-offset-key="16036:0" data-first-offset="true"><span data-slate-string="true"> 的。所以 Ladon 会返回如下结果：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="16037"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16038"><span data-slate-object="text" data-key="16039"><span data-slate-leaf="true" data-offset-key="16039:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16040"><span data-slate-object="text" data-key="16041"><span data-slate-leaf="true" data-offset-key="16041:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16042"><span data-slate-leaf="true" data-offset-key="16042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"allowed"</span></span></span></span><span data-slate-object="text" data-key="16043"><span data-slate-leaf="true" data-offset-key="16043:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="16044"><span data-slate-leaf="true" data-offset-key="16044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16045"><span data-slate-object="text" data-key="16046"><span data-slate-leaf="true" data-offset-key="16046:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16047"><span data-slate-object="text" data-key="16048"><span data-slate-leaf="true" data-offset-key="16048:0" data-first-offset="true"><span data-slate-string="true">Ladon 支持很多 Condition，具体见下表：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16049"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/b8/dd/b84d2a1dc0e9ac07605a867594d734dd.jpg?wh=1920x1521"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16050"><span data-slate-object="text" data-key="16051"><span data-slate-leaf="true" data-offset-key="16051:0" data-first-offset="true"><span data-slate-string="true">至于如何使用这些 Condition，你可以参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16052"><span data-slate-object="text" data-key="16053"><span data-slate-leaf="true" data-offset-key="16053:0" data-first-offset="true"><span data-slate-string="true">Ladon Condition 使用示例</span></span></span></a><span data-slate-object="text" data-key="16054"><span data-slate-leaf="true" data-offset-key="16054:0" data-first-offset="true"><span data-slate-string="true">。此外，Ladon 还支持自定义 Condition。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16055"><span data-slate-object="text" data-key="16056"><span data-slate-leaf="true" data-offset-key="16056:0" data-first-offset="true"><span data-slate-string="true">另外，Ladon 还支持授权审计，用来记录授权历史。我们可以通过在 ladon.Ladon 中附加一个 ladon.AuditLogger 来实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16057"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16058"><span data-slate-object="text" data-key="16059"><span data-slate-leaf="true" data-offset-key="16059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="16060"><span data-slate-leaf="true" data-offset-key="16060:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16061"><span data-slate-leaf="true" data-offset-key="16061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"github.com/ory/ladon"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16062"><span data-slate-object="text" data-key="16063"><span data-slate-leaf="true" data-offset-key="16063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="16064"><span data-slate-leaf="true" data-offset-key="16064:0" data-first-offset="true"><span data-slate-string="true"> manager </span></span></span><span data-slate-object="text" data-key="16065"><span data-slate-leaf="true" data-offset-key="16065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"github.com/ory/ladon/manager/memory"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16066"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16067"><span data-slate-object="text" data-key="16068"><span data-slate-leaf="true" data-offset-key="16068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16069"><span data-slate-leaf="true" data-offset-key="16069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16070"><span data-slate-leaf="true" data-offset-key="16070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="16071"><span data-slate-leaf="true" data-offset-key="16071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16072"><span data-slate-leaf="true" data-offset-key="16072:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16073"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16074"><span data-slate-object="text" data-key="16075"><span data-slate-leaf="true" data-offset-key="16075:0" data-first-offset="true"><span data-slate-string="true">    warden := ladon.Ladon{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16076"><span data-slate-object="text" data-key="16077"><span data-slate-leaf="true" data-offset-key="16077:0" data-first-offset="true"><span data-slate-string="true">        Manager: manager.NewMemoryManager(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16078"><span data-slate-object="text" data-key="16079"><span data-slate-leaf="true" data-offset-key="16079:0" data-first-offset="true"><span data-slate-string="true">        AuditLogger: &amp;ladon.AuditLoggerInfo{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16080"><span data-slate-object="text" data-key="16081"><span data-slate-leaf="true" data-offset-key="16081:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16082"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16083"><span data-slate-object="text" data-key="16084"><span data-slate-leaf="true" data-offset-key="16084:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16085"><span data-slate-leaf="true" data-offset-key="16085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16086"><span data-slate-object="text" data-key="16087"><span data-slate-leaf="true" data-offset-key="16087:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16088"><span data-slate-object="text" data-key="16089"><span data-slate-leaf="true" data-offset-key="16089:0" data-first-offset="true"><span data-slate-string="true">在上面的示例中，我们提供了 ladon.AuditLoggerInfo，该 AuditLogger 会在授权时打印调用的策略到标准错误。AuditLogger 是一个 interface：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16090"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16091"><span data-slate-object="text" data-key="16092"><span data-slate-leaf="true" data-offset-key="16092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// AuditLogger tracks denied and granted authorizations.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16093"><span data-slate-object="text" data-key="16094"><span data-slate-leaf="true" data-offset-key="16094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16095"><span data-slate-leaf="true" data-offset-key="16095:0" data-first-offset="true"><span data-slate-string="true"> AuditLogger </span></span></span><span data-slate-object="text" data-key="16096"><span data-slate-leaf="true" data-offset-key="16096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="16097"><span data-slate-leaf="true" data-offset-key="16097:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16098"><span data-slate-object="text" data-key="16099"><span data-slate-leaf="true" data-offset-key="16099:0" data-first-offset="true"><span data-slate-string="true">    LogRejectedAccessRequest(request *Request, pool Policies, deciders Policies)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16100"><span data-slate-object="text" data-key="16101"><span data-slate-leaf="true" data-offset-key="16101:0" data-first-offset="true"><span data-slate-string="true">    LogGrantedAccessRequest(request *Request, pool Policies, deciders Policies)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16102"><span data-slate-object="text" data-key="16103"><span data-slate-leaf="true" data-offset-key="16103:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16104"><span data-slate-object="text" data-key="16105"><span data-slate-leaf="true" data-offset-key="16105:0" data-first-offset="true"><span data-slate-string="true">要实现一个新的 AuditLogger，你只需要实现 AuditLogger 接口就可以了。比如，我们可以实现一个 AuditLogger，将授权日志保存到 Redis 或者 MySQL 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16106"><span data-slate-object="text" data-key="16107"><span data-slate-leaf="true" data-offset-key="16107:0" data-first-offset="true"><span data-slate-string="true">Ladon 支持跟踪一些授权指标，比如 deny、allow、not match、error。你可以通过实现 ladon.Metric 接口，来对这些指标进行处理。ladon.Metric 接口定义如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16108"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16109"><span data-slate-object="text" data-key="16110"><span data-slate-leaf="true" data-offset-key="16110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Metric is used to expose metrics about authz</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16111"><span data-slate-object="text" data-key="16112"><span data-slate-leaf="true" data-offset-key="16112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16113"><span data-slate-leaf="true" data-offset-key="16113:0" data-first-offset="true"><span data-slate-string="true"> Metric </span></span></span><span data-slate-object="text" data-key="16114"><span data-slate-leaf="true" data-offset-key="16114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="16115"><span data-slate-leaf="true" data-offset-key="16115:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16116"><span data-slate-object="text" data-key="16117"><span data-slate-leaf="true" data-offset-key="16117:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16118"><span data-slate-leaf="true" data-offset-key="16118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// RequestDeniedBy is called when we get explicit deny by policy</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16119"><span data-slate-object="text" data-key="16120"><span data-slate-leaf="true" data-offset-key="16120:0" data-first-offset="true"><span data-slate-string="true">    RequestDeniedBy(Request, Policy)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16121"><span data-slate-object="text" data-key="16122"><span data-slate-leaf="true" data-offset-key="16122:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16123"><span data-slate-leaf="true" data-offset-key="16123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// RequestAllowedBy is called when a matching policy has been found.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16124"><span data-slate-object="text" data-key="16125"><span data-slate-leaf="true" data-offset-key="16125:0" data-first-offset="true"><span data-slate-string="true">    RequestAllowedBy(Request, Policies)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16126"><span data-slate-object="text" data-key="16127"><span data-slate-leaf="true" data-offset-key="16127:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16128"><span data-slate-leaf="true" data-offset-key="16128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// RequestNoMatch is called when no policy has matched our request</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16129"><span data-slate-object="text" data-key="16130"><span data-slate-leaf="true" data-offset-key="16130:0" data-first-offset="true"><span data-slate-string="true">    RequestNoMatch(Request)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16131"><span data-slate-object="text" data-key="16132"><span data-slate-leaf="true" data-offset-key="16132:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16133"><span data-slate-leaf="true" data-offset-key="16133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// RequestProcessingError is called when unexpected error occured</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16134"><span data-slate-object="text" data-key="16135"><span data-slate-leaf="true" data-offset-key="16135:0" data-first-offset="true"><span data-slate-string="true">    RequestProcessingError(Request, Policy, </span></span></span><span data-slate-object="text" data-key="16136"><span data-slate-leaf="true" data-offset-key="16136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="16137"><span data-slate-leaf="true" data-offset-key="16137:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16138"><span data-slate-object="text" data-key="16139"><span data-slate-leaf="true" data-offset-key="16139:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16140"><span data-slate-object="text" data-key="16141"><span data-slate-leaf="true" data-offset-key="16141:0" data-first-offset="true"><span data-slate-string="true">例如，你可以通过下面的示例，将这些指标暴露给 prometheus：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16142"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16143"><span data-slate-object="text" data-key="16144"><span data-slate-leaf="true" data-offset-key="16144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16145"><span data-slate-leaf="true" data-offset-key="16145:0" data-first-offset="true"><span data-slate-string="true"> prometheusMetrics </span></span></span><span data-slate-object="text" data-key="16146"><span data-slate-leaf="true" data-offset-key="16146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16147"><span data-slate-leaf="true" data-offset-key="16147:0" data-first-offset="true"><span data-slate-string="true">{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16148"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16149"><span data-slate-object="text" data-key="16150"><span data-slate-leaf="true" data-offset-key="16150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16151"><span data-slate-leaf="true" data-offset-key="16151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16152"><span data-slate-leaf="true" data-offset-key="16152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(mtr *prometheusMetrics)</span></span></span></span></span><span data-slate-object="text" data-key="16153"><span data-slate-leaf="true" data-offset-key="16153:0" data-first-offset="true"><span data-slate-string="true"> RequestDeniedBy(r ladon.Request, p ladon.Policy) {}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16154"><span data-slate-object="text" data-key="16155"><span data-slate-leaf="true" data-offset-key="16155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16156"><span data-slate-leaf="true" data-offset-key="16156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16157"><span data-slate-leaf="true" data-offset-key="16157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(mtr *prometheusMetrics)</span></span></span></span></span><span data-slate-object="text" data-key="16158"><span data-slate-leaf="true" data-offset-key="16158:0" data-first-offset="true"><span data-slate-string="true"> RequestAllowedBy(r ladon.Request, policies ladon.Policies) {}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16159"><span data-slate-object="text" data-key="16160"><span data-slate-leaf="true" data-offset-key="16160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16161"><span data-slate-leaf="true" data-offset-key="16161:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16162"><span data-slate-leaf="true" data-offset-key="16162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(mtr *prometheusMetrics)</span></span></span></span></span><span data-slate-object="text" data-key="16163"><span data-slate-leaf="true" data-offset-key="16163:0" data-first-offset="true"><span data-slate-string="true"> RequestNoMatch(r ladon.Request) {}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16164"><span data-slate-object="text" data-key="16165"><span data-slate-leaf="true" data-offset-key="16165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16166"><span data-slate-leaf="true" data-offset-key="16166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16167"><span data-slate-leaf="true" data-offset-key="16167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(mtr *prometheusMetrics)</span></span></span></span></span><span data-slate-object="text" data-key="16168"><span data-slate-leaf="true" data-offset-key="16168:0" data-first-offset="true"><span data-slate-string="true"> RequestProcessingError(r ladon.Request, err </span></span></span><span data-slate-object="text" data-key="16169"><span data-slate-leaf="true" data-offset-key="16169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="16170"><span data-slate-leaf="true" data-offset-key="16170:0" data-first-offset="true"><span data-slate-string="true">) {}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16171"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16172"><span data-slate-object="text" data-key="16173"><span data-slate-leaf="true" data-offset-key="16173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16174"><span data-slate-leaf="true" data-offset-key="16174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16175"><span data-slate-leaf="true" data-offset-key="16175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="16176"><span data-slate-leaf="true" data-offset-key="16176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="16177"><span data-slate-leaf="true" data-offset-key="16177:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16178"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16179"><span data-slate-object="text" data-key="16180"><span data-slate-leaf="true" data-offset-key="16180:0" data-first-offset="true"><span data-slate-string="true">    warden := ladon.Ladon{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16181"><span data-slate-object="text" data-key="16182"><span data-slate-leaf="true" data-offset-key="16182:0" data-first-offset="true"><span data-slate-string="true">        Manager: manager.NewMemoryManager(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16183"><span data-slate-object="text" data-key="16184"><span data-slate-leaf="true" data-offset-key="16184:0" data-first-offset="true"><span data-slate-string="true">        Metric:  &amp;prometheusMetrics{},</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16185"><span data-slate-object="text" data-key="16186"><span data-slate-leaf="true" data-offset-key="16186:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16187"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16188"><span data-slate-object="text" data-key="16189"><span data-slate-leaf="true" data-offset-key="16189:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16190"><span data-slate-leaf="true" data-offset-key="16190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16191"><span data-slate-object="text" data-key="16192"><span data-slate-leaf="true" data-offset-key="16192:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16193"><span data-slate-object="text" data-key="16194"><span data-slate-leaf="true" data-offset-key="16194:0" data-first-offset="true"><span data-slate-string="true">在使用 Ladon 的过程中，有两个地方需要你注意：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16195"><div data-slate-type="list-line" data-slate-object="block" data-key="16196"><span data-slate-object="text" data-key="16197"><span data-slate-leaf="true" data-offset-key="16197:0" data-first-offset="true"><span data-slate-string="true">所有检查都区分大小写，因为主题值可能是区分大小写的 ID。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16198"><span data-slate-object="text" data-key="16199"><span data-slate-leaf="true" data-offset-key="16199:0" data-first-offset="true"><span data-slate-string="true">如果 ladon.Ladon 无法将策略与请求匹配，会默认授权结果为拒绝，并返回错误。</span></span></span></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16200" id="sr-toc-3"><span data-slate-object="text" data-key="16201"><span data-slate-leaf="true" data-offset-key="16201:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 使用方法介绍</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16202"><span data-slate-object="text" data-key="16203"><span data-slate-leaf="true" data-offset-key="16203:0" data-first-offset="true"><span data-slate-string="true">上面，我介绍了 iam-authz-server 的资源授权功能，这里介绍下如何使用 iam-authz-server，也就是如何调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16204"><span data-slate-object="text" data-key="16205"><span data-slate-leaf="true" data-offset-key="16205:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="16206"><span data-slate-leaf="true" data-offset-key="16206:0" data-first-offset="true"><span data-slate-string="true"> 接口完成资源授权。你可以通过下面的 3 大步骤，来完成资源授权请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16207"><span data-slate-object="text" data-key="16208"><span data-slate-leaf="true" data-offset-key="16208:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第一步，登陆 iam-</span></span></span></span><span data-slate-object="text" data-key="16209"><span data-slate-leaf="true" data-offset-key="16209:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">a</span></span></span></span><span data-slate-object="text" data-key="16210"><span data-slate-leaf="true" data-offset-key="16210:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">p</span></span></span></span><span data-slate-object="text" data-key="16211"><span data-slate-leaf="true" data-offset-key="16211:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">i</span></span></span></span><span data-slate-object="text" data-key="16212"><span data-slate-leaf="true" data-offset-key="16212:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">s</span></span></span></span><span data-slate-object="text" data-key="16213"><span data-slate-leaf="true" data-offset-key="16213:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">e</span></span></span></span><span data-slate-object="text" data-key="16214"><span data-slate-leaf="true" data-offset-key="16214:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">r</span></span></span></span><span data-slate-object="text" data-key="16215"><span data-slate-leaf="true" data-offset-key="16215:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">v</span></span></span></span><span data-slate-object="text" data-key="16216"><span data-slate-leaf="true" data-offset-key="16216:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">er，创建授权策略和密钥。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16217"><span data-slate-object="text" data-key="16218"><span data-slate-leaf="true" data-offset-key="16218:0" data-first-offset="true"><span data-slate-string="true">这一步又分为 3 个小步骤。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16219"><div data-slate-type="list-line" data-slate-object="block" data-key="16220"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="16221"><span data-slate-leaf="true" data-offset-key="16221:0" data-first-offset="true"><span data-slate-string="true">登陆 iam-apiserver 系统，获取访问令牌：</span></span></span></div></div></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="16222"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16223"><span data-slate-object="text" data-key="16224"><span data-slate-leaf="true" data-offset-key="16224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="16225"><span data-slate-leaf="true" data-offset-key="16225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">token=`curl -s -XPOST -H</span></span></span></span><span data-slate-object="text" data-key="16226"><span data-slate-leaf="true" data-offset-key="16226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'Content-Type: application/json'</span></span></span></span></span><span data-slate-object="text" data-key="16227"><span data-slate-leaf="true" data-offset-key="16227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -d</span></span></span></span><span data-slate-object="text" data-key="16228"><span data-slate-leaf="true" data-offset-key="16228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'{"username":"admin","password":"Admin@2021"}'</span></span></span></span></span><span data-slate-object="text" data-key="16229"><span data-slate-leaf="true" data-offset-key="16229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://127.0.0.1:8080/login | jq -r .token`</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="16230"><div data-slate-type="list-line" data-slate-object="block" data-key="16231"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="16232"><span data-slate-leaf="true" data-offset-key="16232:0" data-first-offset="true"><span data-slate-string="true">创建授权策略：</span></span></span></div></div></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="16233"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16234"><span data-slate-object="text" data-key="16235"><span data-slate-leaf="true" data-offset-key="16235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="16236"><span data-slate-leaf="true" data-offset-key="16236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curl -s -XPOST -H</span></span></span></span><span data-slate-object="text" data-key="16237"><span data-slate-leaf="true" data-offset-key="16237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Content-Type: application/json"</span></span></span></span></span><span data-slate-object="text" data-key="16238"><span data-slate-leaf="true" data-offset-key="16238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -H</span></span></span></span><span data-slate-object="text" data-key="16239"><span data-slate-leaf="true" data-offset-key="16239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Bearer </span></span></span></span></span><span data-slate-object="text" data-key="16240"><span data-slate-leaf="true" data-offset-key="16240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$token</span></span></span></span></span></span><span data-slate-object="text" data-key="16241"><span data-slate-leaf="true" data-offset-key="16241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span></span><span data-slate-object="text" data-key="16242"><span data-slate-leaf="true" data-offset-key="16242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -d</span></span></span></span><span data-slate-object="text" data-key="16243"><span data-slate-leaf="true" data-offset-key="16243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'{"metadata":{"name":"authztest"},"policy":{"description":"One policy to rule them all.","subjects":["users:&lt;peter|ken&gt;","users:maria","groups:admins"],"actions":["delete","&lt;create|update&gt;"],"effect":"allow","resources":["resources:articles:&lt;.*&gt;","resources:printer"],"conditions":{"remoteIP":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}'</span></span></span></span></span><span data-slate-object="text" data-key="16244"><span data-slate-leaf="true" data-offset-key="16244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://127.0.0.1:8080/v1/policies</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="16245"><div data-slate-type="list-line" data-slate-object="block" data-key="16246"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="16247"><span data-slate-leaf="true" data-offset-key="16247:0" data-first-offset="true"><span data-slate-string="true">创建密钥，并从请求结果中提取 secretID 和 secretKey：</span></span></span></div></div></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="16248"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16249"><span data-slate-object="text" data-key="16250"><span data-slate-leaf="true" data-offset-key="16250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="16251"><span data-slate-leaf="true" data-offset-key="16251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curl -s -XPOST -H</span></span></span></span><span data-slate-object="text" data-key="16252"><span data-slate-leaf="true" data-offset-key="16252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Content-Type: application/json"</span></span></span></span></span><span data-slate-object="text" data-key="16253"><span data-slate-leaf="true" data-offset-key="16253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -H</span></span></span></span><span data-slate-object="text" data-key="16254"><span data-slate-leaf="true" data-offset-key="16254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Bearer </span></span></span></span></span><span data-slate-object="text" data-key="16255"><span data-slate-leaf="true" data-offset-key="16255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$token</span></span></span></span></span></span><span data-slate-object="text" data-key="16256"><span data-slate-leaf="true" data-offset-key="16256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span></span><span data-slate-object="text" data-key="16257"><span data-slate-leaf="true" data-offset-key="16257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -d</span></span></span></span><span data-slate-object="text" data-key="16258"><span data-slate-leaf="true" data-offset-key="16258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'{"metadata":{"name":"authztest"},"expires":0,"description":"admin secret"}'</span></span></span></span></span><span data-slate-object="text" data-key="16259"><span data-slate-leaf="true" data-offset-key="16259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://127.0.0.1:8080/v1/secrets</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16260"><span data-slate-object="text" data-key="16261"><span data-slate-leaf="true" data-offset-key="16261:0" data-first-offset="true"><span data-slate-string="true">{"metadata":{"id":23,"name":"authztest","createdAt":"2021-04-08T07:24:50.071671422+08:00","updatedAt":"2021-04-08T07:24:50.071671422+08:00"},"username":"admin","secretID":"ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox","secretKey":"7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8","expires":0,"description":"admin secret"}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16262"><span data-slate-object="text" data-key="16263"><span data-slate-leaf="true" data-offset-key="16263:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第二步，生成访问 iam-authz-server 的 token。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16264"><span data-slate-object="text" data-key="16265"><span data-slate-leaf="true" data-offset-key="16265:0" data-first-offset="true"><span data-slate-string="true">iamctl 提供了 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16266"><span data-slate-object="text" data-key="16267"><span data-slate-leaf="true" data-offset-key="16267:0" data-first-offset="true"><span data-slate-string="true">jwt sigin</span></span></span></span><span data-slate-object="text" data-key="16268"><span data-slate-leaf="true" data-offset-key="16268:0" data-first-offset="true"><span data-slate-string="true"> 子命令，可以根据 secretID 和 secretKey 签发 Token，方便使用。</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="16269"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16270"><span data-slate-object="text" data-key="16271"><span data-slate-leaf="true" data-offset-key="16271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="16272"><span data-slate-leaf="true" data-offset-key="16272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">iamctl jwt sign ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox 7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8 </span></span></span></span><span data-slate-object="text" data-key="16273"><span data-slate-leaf="true" data-offset-key="16273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># iamctl jwt sign $secretID $secretKey</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16274"><span data-slate-object="text" data-key="16275"><span data-slate-leaf="true" data-offset-key="16275:0" data-first-offset="true"><span data-slate-string="true">eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16276"><span data-slate-object="text" data-key="16277"><span data-slate-leaf="true" data-offset-key="16277:0" data-first-offset="true"><span data-slate-string="true">你可以通过 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16278"><span data-slate-object="text" data-key="16279"><span data-slate-leaf="true" data-offset-key="16279:0" data-first-offset="true"><span data-slate-string="true">iamctl jwt show &lt;token&gt;</span></span></span></span><span data-slate-object="text" data-key="16280"><span data-slate-leaf="true" data-offset-key="16280:0" data-first-offset="true"><span data-slate-string="true"> 来查看 Token 的内容：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="16281"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16282"><span data-slate-object="text" data-key="16283"><span data-slate-leaf="true" data-offset-key="16283:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="16284"><span data-slate-leaf="true" data-offset-key="16284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">iamctl jwt show eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16285"><span data-slate-object="text" data-key="16286"><span data-slate-leaf="true" data-offset-key="16286:0" data-first-offset="true"><span data-slate-string="true">Header:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16287"><span data-slate-object="text" data-key="16288"><span data-slate-leaf="true" data-offset-key="16288:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16289"><span data-slate-object="text" data-key="16290"><span data-slate-leaf="true" data-offset-key="16290:0" data-first-offset="true"><span data-slate-string="true">    "alg": "HS256",</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16291"><span data-slate-object="text" data-key="16292"><span data-slate-leaf="true" data-offset-key="16292:0" data-first-offset="true"><span data-slate-string="true">    "kid": "ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox",</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16293"><span data-slate-object="text" data-key="16294"><span data-slate-leaf="true" data-offset-key="16294:0" data-first-offset="true"><span data-slate-string="true">    "typ": "JWT"</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16295"><span data-slate-object="text" data-key="16296"><span data-slate-leaf="true" data-offset-key="16296:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16297"><span data-slate-object="text" data-key="16298"><span data-slate-leaf="true" data-offset-key="16298:0" data-first-offset="true"><span data-slate-string="true">Claims:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16299"><span data-slate-object="text" data-key="16300"><span data-slate-leaf="true" data-offset-key="16300:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16301"><span data-slate-object="text" data-key="16302"><span data-slate-leaf="true" data-offset-key="16302:0" data-first-offset="true"><span data-slate-string="true">    "aud": "iam.authz.marmotedu.com",</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16303"><span data-slate-object="text" data-key="16304"><span data-slate-leaf="true" data-offset-key="16304:0" data-first-offset="true"><span data-slate-string="true">    "exp": 1617845195,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16305"><span data-slate-object="text" data-key="16306"><span data-slate-leaf="true" data-offset-key="16306:0" data-first-offset="true"><span data-slate-string="true">    "iat": 1617837995,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16307"><span data-slate-object="text" data-key="16308"><span data-slate-leaf="true" data-offset-key="16308:0" data-first-offset="true"><span data-slate-string="true">    "iss": "iamctl",</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16309"><span data-slate-object="text" data-key="16310"><span data-slate-leaf="true" data-offset-key="16310:0" data-first-offset="true"><span data-slate-string="true">    "nbf": 1617837995</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16311"><span data-slate-object="text" data-key="16312"><span data-slate-leaf="true" data-offset-key="16312:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16313"><span data-slate-object="text" data-key="16314"><span data-slate-leaf="true" data-offset-key="16314:0" data-first-offset="true"><span data-slate-string="true">我们生成的 Token 包含了下面这些信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16315"><span data-slate-object="text" data-key="16316"><span data-slate-leaf="true" data-offset-key="16316:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Header</span></span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16317"><div data-slate-type="list-line" data-slate-object="block" data-key="16318"><span data-slate-object="text" data-key="16319"><span data-slate-leaf="true" data-offset-key="16319:0" data-first-offset="true"><span data-slate-string="true">alg：生成签名的算法。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16320"><span data-slate-object="text" data-key="16321"><span data-slate-leaf="true" data-offset-key="16321:0" data-first-offset="true"><span data-slate-string="true">kid：密钥 ID。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16322"><span data-slate-object="text" data-key="16323"><span data-slate-leaf="true" data-offset-key="16323:0" data-first-offset="true"><span data-slate-string="true">typ：Token 的类型，这里是 JWT。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16324"><span data-slate-object="text" data-key="16325"><span data-slate-leaf="true" data-offset-key="16325:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Claims</span></span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16326"><div data-slate-type="list-line" data-slate-object="block" data-key="16327"><span data-slate-object="text" data-key="16328"><span data-slate-leaf="true" data-offset-key="16328:0" data-first-offset="true"><span data-slate-string="true">aud：JWT Token 的接受者。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16329"><span data-slate-object="text" data-key="16330"><span data-slate-leaf="true" data-offset-key="16330:0" data-first-offset="true"><span data-slate-string="true">exp：JWT Token 的过期时间（UNIX 时间格式）。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16331"><span data-slate-object="text" data-key="16332"><span data-slate-leaf="true" data-offset-key="16332:0" data-first-offset="true"><span data-slate-string="true">iat：JWT Token 的签发时间（UNIX 时间格式）。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16333"><span data-slate-object="text" data-key="16334"><span data-slate-leaf="true" data-offset-key="16334:0" data-first-offset="true"><span data-slate-string="true">iss：签发者，因为我们是用 iamctl 工具签发的，所以这里的签发者是 iamctl。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16335"><span data-slate-object="text" data-key="16336"><span data-slate-leaf="true" data-offset-key="16336:0" data-first-offset="true"><span data-slate-string="true">nbf：JWT Token 的生效时间（UNIX 时间格式），默认是签发时间。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16337"><span data-slate-object="text" data-key="16338"><span data-slate-leaf="true" data-offset-key="16338:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第三步，调用</span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16339"><span data-slate-object="text" data-key="16340"><span data-slate-leaf="true" data-offset-key="16340:0" data-first-offset="true"><span data-slate-string="true"> /v1/authz</span></span></span></span><span data-slate-object="text" data-key="16341"><span data-slate-leaf="true" data-offset-key="16341:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 接口</span></span></span></span><span data-slate-object="text" data-key="16342"><span data-slate-leaf="true" data-offset-key="16342:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">，</span></span></span></span><span data-slate-object="text" data-key="16343"><span data-slate-leaf="true" data-offset-key="16343:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">完成资源授权请求。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16344"><span data-slate-object="text" data-key="16345"><span data-slate-leaf="true" data-offset-key="16345:0" data-first-offset="true"><span data-slate-string="true">请求方法如下：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="16346"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16347"><span data-slate-object="text" data-key="16348"><span data-slate-leaf="true" data-offset-key="16348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="16349"><span data-slate-leaf="true" data-offset-key="16349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curl -s -XPOST -H</span></span></span></span><span data-slate-object="text" data-key="16350"><span data-slate-leaf="true" data-offset-key="16350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'Content-Type: application/json'</span></span></span></span></span><span data-slate-object="text" data-key="16351"><span data-slate-leaf="true" data-offset-key="16351:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -H</span></span></span></span><span data-slate-object="text" data-key="16352"><span data-slate-leaf="true" data-offset-key="16352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'Authorization: Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ'</span></span></span></span></span><span data-slate-object="text" data-key="16353"><span data-slate-leaf="true" data-offset-key="16353:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -d</span></span></span></span><span data-slate-object="text" data-key="16354"><span data-slate-leaf="true" data-offset-key="16354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'{"subject":"users:maria","action":"delete","resource":"resources:articles:ladon-introduction","context":{"remoteIP":"192.168.0.5"}}'</span></span></span></span></span><span data-slate-object="text" data-key="16355"><span data-slate-leaf="true" data-offset-key="16355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://127.0.0.1:9090/v1/authz</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16356"><span data-slate-object="text" data-key="16357"><span data-slate-leaf="true" data-offset-key="16357:0" data-first-offset="true"><span data-slate-string="true">{"allowed":true}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16358"><span data-slate-object="text" data-key="16359"><span data-slate-leaf="true" data-offset-key="16359:0" data-first-offset="true"><span data-slate-string="true">如果授权通过，会返回：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16360"><span data-slate-object="text" data-key="16361"><span data-slate-leaf="true" data-offset-key="16361:0" data-first-offset="true"><span data-slate-string="true">{"allowed":true}</span></span></span></span><span data-slate-object="text" data-key="16362"><span data-slate-leaf="true" data-offset-key="16362:0" data-first-offset="true"><span data-slate-string="true"> 。 如果授权失败，则返回：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="16363"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16364"><span data-slate-object="text" data-key="16365"><span data-slate-leaf="true" data-offset-key="16365:0" data-first-offset="true"><span data-slate-string="true">{"allowed":false,"denied":true,"reason":"Request was denied by default"}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="16366" id="sr-toc-4"><span data-slate-object="text" data-key="16367"><span data-slate-leaf="true" data-offset-key="16367:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的代码实现</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="16368"><span data-slate-object="text" data-key="16369"><span data-slate-leaf="true" data-offset-key="16369:0" data-first-offset="true"><span data-slate-string="true">接下来，我们来看下 iam-authz-server 的具体实现，我会从配置处理、启动流程、请求处理流程和代码架构 4 个方面来讲解。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16370" id="sr-toc-5"><span data-slate-object="text" data-key="16371"><span data-slate-leaf="true" data-offset-key="16371:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的配置处理</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16372"><span data-slate-object="text" data-key="16373"><span data-slate-leaf="true" data-offset-key="16373:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 服务的 main 函数位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16374"><span data-slate-object="text" data-key="16375"><span data-slate-leaf="true" data-offset-key="16375:0" data-first-offset="true"><span data-slate-string="true">authzserver.go</span></span></span></a><span data-slate-object="text" data-key="16376"><span data-slate-leaf="true" data-offset-key="16376:0" data-first-offset="true"><span data-slate-string="true"> 文件中，你可以跟读代码，了解 iam-authz-server 的代码实现。iam-authz-server 的服务框架设计跟 iam-apiserver 的服务框架设计保持一致，也是有 3 种配置：Options 配置、组件配置和 HTTP 服务配置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16377"><span data-slate-object="text" data-key="16378"><span data-slate-leaf="true" data-offset-key="16378:0" data-first-offset="true"><span data-slate-string="true">Options 配置见 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16379"><span data-slate-object="text" data-key="16380"><span data-slate-leaf="true" data-offset-key="16380:0" data-first-offset="true"><span data-slate-string="true">options.go</span></span></span></a><span data-slate-object="text" data-key="16381"><span data-slate-leaf="true" data-offset-key="16381:0" data-first-offset="true"><span data-slate-string="true"> 文件：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16382"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16383"><span data-slate-object="text" data-key="16384"><span data-slate-leaf="true" data-offset-key="16384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16385"><span data-slate-leaf="true" data-offset-key="16385:0" data-first-offset="true"><span data-slate-string="true"> Options </span></span></span><span data-slate-object="text" data-key="16386"><span data-slate-leaf="true" data-offset-key="16386:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="16387"><span data-slate-leaf="true" data-offset-key="16387:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16388"><span data-slate-object="text" data-key="16389"><span data-slate-leaf="true" data-offset-key="16389:0" data-first-offset="true"><span data-slate-string="true">    RPCServer               </span></span></span><span data-slate-object="text" data-key="16390"><span data-slate-leaf="true" data-offset-key="16390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16391"><span data-slate-object="text" data-key="16392"><span data-slate-leaf="true" data-offset-key="16392:0" data-first-offset="true"><span data-slate-string="true">    ClientCA                </span></span></span><span data-slate-object="text" data-key="16393"><span data-slate-leaf="true" data-offset-key="16393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16394"><span data-slate-object="text" data-key="16395"><span data-slate-leaf="true" data-offset-key="16395:0" data-first-offset="true"><span data-slate-string="true">    GenericServerRunOptions *genericoptions.ServerRunOptions</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16396"><span data-slate-object="text" data-key="16397"><span data-slate-leaf="true" data-offset-key="16397:0" data-first-offset="true"><span data-slate-string="true">    InsecureServing         *genericoptions.InsecureServingOptions</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16398"><span data-slate-object="text" data-key="16399"><span data-slate-leaf="true" data-offset-key="16399:0" data-first-offset="true"><span data-slate-string="true">    SecureServing           *genericoptions.SecureServingOptions</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16400"><span data-slate-object="text" data-key="16401"><span data-slate-leaf="true" data-offset-key="16401:0" data-first-offset="true"><span data-slate-string="true">    RedisOptions            *genericoptions.RedisOptions</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16402"><span data-slate-object="text" data-key="16403"><span data-slate-leaf="true" data-offset-key="16403:0" data-first-offset="true"><span data-slate-string="true">    FeatureOptions          *genericoptions.FeatureOptions</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16404"><span data-slate-object="text" data-key="16405"><span data-slate-leaf="true" data-offset-key="16405:0" data-first-offset="true"><span data-slate-string="true">    Log                     *log.Options</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16406"><span data-slate-object="text" data-key="16407"><span data-slate-leaf="true" data-offset-key="16407:0" data-first-offset="true"><span data-slate-string="true">    AnalyticsOptions        *analytics.AnalyticsOptions</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16408"><span data-slate-object="text" data-key="16409"><span data-slate-leaf="true" data-offset-key="16409:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16410"><span data-slate-object="text" data-key="16411"><span data-slate-leaf="true" data-offset-key="16411:0" data-first-offset="true"><span data-slate-string="true">和 iam-apiserver 相比，iam-authz-server 多了 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16412"><span data-slate-object="text" data-key="16413"><span data-slate-leaf="true" data-offset-key="16413:0" data-first-offset="true"><span data-slate-string="true">AnalyticsOptions</span></span></span></span><span data-slate-object="text" data-key="16414"><span data-slate-leaf="true" data-offset-key="16414:0" data-first-offset="true"><span data-slate-string="true">，用来配置 iam-authz-server 内的 Analytics 服务，Analytics 服务会将授权日志异步写入到 Redis 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16415"><span data-slate-object="text" data-key="16416"><span data-slate-leaf="true" data-offset-key="16416:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 和 iam-authz-server 共用了 GenericServerRunOptions、InsecureServing、SecureServing、FeatureOptions、RedisOptions、Log 这些配置。所以，我们只需要用简单的几行代码，就可以将很多配置项都引入到 iam-authz-server 的命令行参数中，这也是命令行参数分组带来的好处：批量共享。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16417" id="sr-toc-6"><span data-slate-object="text" data-key="16418"><span data-slate-leaf="true" data-offset-key="16418:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 启动流程设计</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16419"><span data-slate-object="text" data-key="16420"><span data-slate-leaf="true" data-offset-key="16420:0" data-first-offset="true"><span data-slate-string="true">接下来，我们来详细看下 iam-authz-server 的启动流程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16421"><span data-slate-object="text" data-key="16422"><span data-slate-leaf="true" data-offset-key="16422:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的启动流程也和 iam-apiserver 基本保持一致。二者比较大的不同在于 Options 参数配置和应用初始化内容。另外，和 iam-apiserver 相比，iam-authz-server 只提供了 REST API 服务。启动流程如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16423"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/19/35/195178d37854bac7d5243d80e42a4c35.jpg?wh=2248x799"></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16424" id="sr-toc-7"><span data-slate-object="text" data-key="16425"><span data-slate-leaf="true" data-offset-key="16425:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的 RESTful API 请求处理流程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16426"><span data-slate-object="text" data-key="16427"><span data-slate-leaf="true" data-offset-key="16427:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的请求处理流程也是清晰、规范的，具体流程如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16428"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/5a/89/5a83384f5762c41831190628bfa60989.jpg?wh=2248x780"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16429"><span data-slate-object="text" data-key="16430"><span data-slate-leaf="true" data-offset-key="16430:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">首先，</span></span></span></span><span data-slate-object="text" data-key="16431"><span data-slate-leaf="true" data-offset-key="16431:0" data-first-offset="true"><span data-slate-string="true">我们通过 API 调用（</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16432"><span data-slate-object="text" data-key="16433"><span data-slate-leaf="true" data-offset-key="16433:0" data-first-offset="true"><span data-slate-string="true">&lt;HTTP Method&gt; + &lt;HTTP Request Path&gt;</span></span></span></span><span data-slate-object="text" data-key="16434"><span data-slate-leaf="true" data-offset-key="16434:0" data-first-offset="true"><span data-slate-string="true">）请求 iam-authz-server 提供的 RESTful API 接口 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16435"><span data-slate-object="text" data-key="16436"><span data-slate-leaf="true" data-offset-key="16436:0" data-first-offset="true"><span data-slate-string="true">POST /v1/authz</span></span></span></span><span data-slate-object="text" data-key="16437"><span data-slate-leaf="true" data-offset-key="16437:0" data-first-offset="true"><span data-slate-string="true"> 。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16438"><span data-slate-object="text" data-key="16439"><span data-slate-leaf="true" data-offset-key="16439:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">接着，</span></span></span></span><span data-slate-object="text" data-key="16440"><span data-slate-leaf="true" data-offset-key="16440:0" data-first-offset="true"><span data-slate-string="true">Gin Web 框架接收到 HTTP 请求之后，会通过认证中间件完成请求的认证，iam-authz-server 采用了 Bearer 认证方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16441"><span data-slate-object="text" data-key="16442"><span data-slate-leaf="true" data-offset-key="16442:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">然后，</span></span></span></span><span data-slate-object="text" data-key="16443"><span data-slate-leaf="true" data-offset-key="16443:0" data-first-offset="true"><span data-slate-string="true">请求会被我们加载的一系列中间件所处理，例如跨域、RequestID、Dump 等中间件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16444"><span data-slate-object="text" data-key="16445"><span data-slate-leaf="true" data-offset-key="16445:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最后，</span></span></span></span><span data-slate-object="text" data-key="16446"><span data-slate-leaf="true" data-offset-key="16446:0" data-first-offset="true"><span data-slate-string="true">根据</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16447"><span data-slate-object="text" data-key="16448"><span data-slate-leaf="true" data-offset-key="16448:0" data-first-offset="true"><span data-slate-string="true"> &lt;HTTP Method&gt; + &lt;HTTP Request Path&gt;</span></span></span></span><span data-slate-object="text" data-key="16449"><span data-slate-leaf="true" data-offset-key="16449:0" data-first-offset="true"><span data-slate-string="true"> 进行路由匹配。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16450"><span data-slate-object="text" data-key="16451"><span data-slate-leaf="true" data-offset-key="16451:0" data-first-offset="true"><span data-slate-string="true">比如，我们请求的 RESTful API 是</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16452"><span data-slate-object="text" data-key="16453"><span data-slate-leaf="true" data-offset-key="16453:0" data-first-offset="true"><span data-slate-string="true"> POST /v1/authz</span></span></span></span><span data-slate-object="text" data-key="16454"><span data-slate-leaf="true" data-offset-key="16454:0" data-first-offset="true"><span data-slate-string="true">，Gin Web 框架会根据 HTTP Method 和 HTTP Request Path，查找注册的 Controllers，最终匹配到 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16455"><span data-slate-object="text" data-key="16456"><span data-slate-leaf="true" data-offset-key="16456:0" data-first-offset="true"><span data-slate-string="true">authzController.Authorize</span></span></span></a><span data-slate-object="text" data-key="16457"><span data-slate-leaf="true" data-offset-key="16457:0" data-first-offset="true"><span data-slate-string="true"> Controller。在 Authorize Controller 中，会先解析请求参数，接着校验请求参数、调用业务层的方法进行资源授权，最后处理业务层的返回结果，返回最终的 HTTP 请求结果。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16458" id="sr-toc-8"><span data-slate-object="text" data-key="16459"><span data-slate-leaf="true" data-offset-key="16459:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的代码架构</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16460"><span data-slate-object="text" data-key="16461"><span data-slate-leaf="true" data-offset-key="16461:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的代码设计和 iam-apiserver 一样，遵循简洁架构设计。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16462"><span data-slate-object="text" data-key="16463"><span data-slate-leaf="true" data-offset-key="16463:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的代码架构也分为 4 层，分别是模型层（Models）、控制层（Controller）、业务层 （Service）和仓库层（Repository）。从控制层、业务层到仓库层，从左到右层级依次加深。模型层独立于其他层，可供其他层引用。如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16464"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a5/dd/a57832495c9e031a94282f0a8a3a61dd.jpg?wh=2248x702"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16465"><span data-slate-object="text" data-key="16466"><span data-slate-leaf="true" data-offset-key="16466:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 和 iam-apiserver 的代码架构有这三点不同：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16467"><div data-slate-type="list-line" data-slate-object="block" data-key="16468"><span data-slate-object="text" data-key="16469"><span data-slate-leaf="true" data-offset-key="16469:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 客户端不支持前端和命令行。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16470"><span data-slate-object="text" data-key="16471"><span data-slate-leaf="true" data-offset-key="16471:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 仓库层对接的是 iam-apiserver 微服务，而非数据库。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="16472"><span data-slate-object="text" data-key="16473"><span data-slate-leaf="true" data-offset-key="16473:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 业务层的代码存放在目录 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16474"><span data-slate-object="text" data-key="16475"><span data-slate-leaf="true" data-offset-key="16475:0" data-first-offset="true"><span data-slate-string="true">authorization</span></span></span></a><span data-slate-object="text" data-key="16476"><span data-slate-leaf="true" data-offset-key="16476:0" data-first-offset="true"><span data-slate-string="true"> 中。</span></span></span></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="16477" id="sr-toc-9"><span data-slate-object="text" data-key="16478"><span data-slate-leaf="true" data-offset-key="16478:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 关键代码分析</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="16479"><span data-slate-object="text" data-key="16480"><span data-slate-leaf="true" data-offset-key="16480:0" data-first-offset="true"><span data-slate-string="true">和 iam-apiserver 一样，iam-authz-server 也包含了一些优秀的设计思路和关键代码，这里我来一一介绍下。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16481" id="sr-toc-10"><span data-slate-object="text" data-key="16482"><span data-slate-leaf="true" data-offset-key="16482:0" data-first-offset="true"><span data-slate-string="true">资源授权</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16483"><span data-slate-object="text" data-key="16484"><span data-slate-leaf="true" data-offset-key="16484:0" data-first-offset="true"><span data-slate-string="true">先来看下，iam-authz-server 是如何实现资源授权的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16485"><span data-slate-object="text" data-key="16486"><span data-slate-leaf="true" data-offset-key="16486:0" data-first-offset="true"><span data-slate-string="true">我们可以调用 iam-authz-server 的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16487"><span data-slate-object="text" data-key="16488"><span data-slate-leaf="true" data-offset-key="16488:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="16489"><span data-slate-leaf="true" data-offset-key="16489:0" data-first-offset="true"><span data-slate-string="true">  API 接口，实现资源的访问授权。 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16490"><span data-slate-object="text" data-key="16491"><span data-slate-leaf="true" data-offset-key="16491:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="16492"><span data-slate-leaf="true" data-offset-key="16492:0" data-first-offset="true"><span data-slate-string="true"> 对应的 controller 方法是 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16493"><span data-slate-object="text" data-key="16494"><span data-slate-leaf="true" data-offset-key="16494:0" data-first-offset="true"><span data-slate-string="true">Authorize</span></span></span></a><span data-slate-object="text" data-key="16495"><span data-slate-leaf="true" data-offset-key="16495:0" data-first-offset="true"><span data-slate-string="true">：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16496"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16497"><span data-slate-object="text" data-key="16498"><span data-slate-leaf="true" data-offset-key="16498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16499"><span data-slate-leaf="true" data-offset-key="16499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16500"><span data-slate-leaf="true" data-offset-key="16500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(a *AuthzController)</span></span></span></span></span><span data-slate-object="text" data-key="16501"><span data-slate-leaf="true" data-offset-key="16501:0" data-first-offset="true"><span data-slate-string="true"> Authorize(c *gin.Context) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16502"><span data-slate-object="text" data-key="16503"><span data-slate-leaf="true" data-offset-key="16503:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16504"><span data-slate-leaf="true" data-offset-key="16504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="16505"><span data-slate-leaf="true" data-offset-key="16505:0" data-first-offset="true"><span data-slate-string="true"> r ladon.Request</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16506"><span data-slate-object="text" data-key="16507"><span data-slate-leaf="true" data-offset-key="16507:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16508"><span data-slate-leaf="true" data-offset-key="16508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16509"><span data-slate-leaf="true" data-offset-key="16509:0" data-first-offset="true"><span data-slate-string="true"> err := c.ShouldBind(&amp;r); err != </span></span></span><span data-slate-object="text" data-key="16510"><span data-slate-leaf="true" data-offset-key="16510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16511"><span data-slate-leaf="true" data-offset-key="16511:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16512"><span data-slate-object="text" data-key="16513"><span data-slate-leaf="true" data-offset-key="16513:0" data-first-offset="true"><span data-slate-string="true">    core.WriteResponse(c, errors.WithCode(code.ErrBind, err.Error()), </span></span></span><span data-slate-object="text" data-key="16514"><span data-slate-leaf="true" data-offset-key="16514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16515"><span data-slate-leaf="true" data-offset-key="16515:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16516"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16517"><span data-slate-object="text" data-key="16518"><span data-slate-leaf="true" data-offset-key="16518:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16519"><span data-slate-leaf="true" data-offset-key="16519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16520"><span data-slate-object="text" data-key="16521"><span data-slate-leaf="true" data-offset-key="16521:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16522"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16523"><span data-slate-object="text" data-key="16524"><span data-slate-leaf="true" data-offset-key="16524:0" data-first-offset="true"><span data-slate-string="true">  auth := authorization.NewAuthorizer(authorizer.NewAuthorization(a.store))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16525"><span data-slate-object="text" data-key="16526"><span data-slate-leaf="true" data-offset-key="16526:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16527"><span data-slate-leaf="true" data-offset-key="16527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16528"><span data-slate-leaf="true" data-offset-key="16528:0" data-first-offset="true"><span data-slate-string="true"> r.Context == </span></span></span><span data-slate-object="text" data-key="16529"><span data-slate-leaf="true" data-offset-key="16529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16530"><span data-slate-leaf="true" data-offset-key="16530:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16531"><span data-slate-object="text" data-key="16532"><span data-slate-leaf="true" data-offset-key="16532:0" data-first-offset="true"><span data-slate-string="true">    r.Context = ladon.Context{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16533"><span data-slate-object="text" data-key="16534"><span data-slate-leaf="true" data-offset-key="16534:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16535"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16536"><span data-slate-object="text" data-key="16537"><span data-slate-leaf="true" data-offset-key="16537:0" data-first-offset="true"><span data-slate-string="true">  r.Context[</span></span></span><span data-slate-object="text" data-key="16538"><span data-slate-leaf="true" data-offset-key="16538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="16539"><span data-slate-leaf="true" data-offset-key="16539:0" data-first-offset="true"><span data-slate-string="true">] = c.GetString(</span></span></span><span data-slate-object="text" data-key="16540"><span data-slate-leaf="true" data-offset-key="16540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="16541"><span data-slate-leaf="true" data-offset-key="16541:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16542"><span data-slate-object="text" data-key="16543"><span data-slate-leaf="true" data-offset-key="16543:0" data-first-offset="true"><span data-slate-string="true">  rsp := auth.Authorize(&amp;r)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16544"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16545"><span data-slate-object="text" data-key="16546"><span data-slate-leaf="true" data-offset-key="16546:0" data-first-offset="true"><span data-slate-string="true">  core.WriteResponse(c, </span></span></span><span data-slate-object="text" data-key="16547"><span data-slate-leaf="true" data-offset-key="16547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16548"><span data-slate-leaf="true" data-offset-key="16548:0" data-first-offset="true"><span data-slate-string="true">, rsp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16549"><span data-slate-object="text" data-key="16550"><span data-slate-leaf="true" data-offset-key="16550:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16551"><span data-slate-object="text" data-key="16552"><span data-slate-leaf="true" data-offset-key="16552:0" data-first-offset="true"><span data-slate-string="true">该函数使用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16553"><span data-slate-object="text" data-key="16554"><span data-slate-leaf="true" data-offset-key="16554:0" data-first-offset="true"><span data-slate-string="true">github.com/ory/ladon</span></span></span></span><span data-slate-object="text" data-key="16555"><span data-slate-leaf="true" data-offset-key="16555:0" data-first-offset="true"><span data-slate-string="true"> 包进行资源访问授权，授权流程如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16556"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/7c/a6/7c251c61cb535714edd390eac18df8a6.jpg?wh=2248x920"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16557"><span data-slate-object="text" data-key="16558"><span data-slate-leaf="true" data-offset-key="16558:0" data-first-offset="true"><span data-slate-string="true">具体分为以下几个步骤：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16559"><span data-slate-object="text" data-key="16560"><span data-slate-leaf="true" data-offset-key="16560:0" data-first-offset="true"><span data-slate-string="true">第一步，在 Authorize 方法中调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16561"><span data-slate-object="text" data-key="16562"><span data-slate-leaf="true" data-offset-key="16562:0" data-first-offset="true"><span data-slate-string="true">c.ShouldBind(&amp;r)</span></span></span></span><span data-slate-object="text" data-key="16563"><span data-slate-leaf="true" data-offset-key="16563:0" data-first-offset="true"><span data-slate-string="true"> ，将 API 请求参数解析到 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16564"><span data-slate-object="text" data-key="16565"><span data-slate-leaf="true" data-offset-key="16565:0" data-first-offset="true"><span data-slate-string="true">ladon.Request</span></span></span></span><span data-slate-object="text" data-key="16566"><span data-slate-leaf="true" data-offset-key="16566:0" data-first-offset="true"><span data-slate-string="true"> 类型的结构体变量中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16567"><span data-slate-object="text" data-key="16568"><span data-slate-leaf="true" data-offset-key="16568:0" data-first-offset="true"><span data-slate-string="true">第二步，调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16569"><span data-slate-object="text" data-key="16570"><span data-slate-leaf="true" data-offset-key="16570:0" data-first-offset="true"><span data-slate-string="true">authorization.NewAuthorizer</span></span></span></a><span data-slate-object="text" data-key="16571"><span data-slate-leaf="true" data-offset-key="16571:0" data-first-offset="true"><span data-slate-string="true"> 函数，该函数会创建并返回包含 Manager 和 AuditLogger 字段的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16572"><span data-slate-object="text" data-key="16573"><span data-slate-leaf="true" data-offset-key="16573:0" data-first-offset="true"><span data-slate-string="true">Authorizer</span></span></span></a><span data-slate-object="text" data-key="16574"><span data-slate-leaf="true" data-offset-key="16574:0" data-first-offset="true"><span data-slate-string="true"> 类型的变量。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16575"><span data-slate-object="text" data-key="16576"><span data-slate-leaf="true" data-offset-key="16576:0" data-first-offset="true"><span data-slate-string="true">Manager 包含一些函数，比如 Create、Update 和 FindRequestCandidates 等，用来对授权策略进行增删改查。AuditLogger 包含 LogRejectedAccessRequest 和 LogGrantedAccessRequest 函数，分别用来记录被拒绝的授权请求和被允许的授权请求，将其作为审计数据使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16577"><span data-slate-object="text" data-key="16578"><span data-slate-leaf="true" data-offset-key="16578:0" data-first-offset="true"><span data-slate-string="true">第三步，调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16579"><span data-slate-object="text" data-key="16580"><span data-slate-leaf="true" data-offset-key="16580:0" data-first-offset="true"><span data-slate-string="true">auth.Authorize</span></span></span></a><span data-slate-object="text" data-key="16581"><span data-slate-leaf="true" data-offset-key="16581:0" data-first-offset="true"><span data-slate-string="true"> 函数，对请求进行访问授权。auth.Authorize 函数内容如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16582"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16583"><span data-slate-object="text" data-key="16584"><span data-slate-leaf="true" data-offset-key="16584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16585"><span data-slate-leaf="true" data-offset-key="16585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16586"><span data-slate-leaf="true" data-offset-key="16586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(a *Authorizer)</span></span></span></span></span><span data-slate-object="text" data-key="16587"><span data-slate-leaf="true" data-offset-key="16587:0" data-first-offset="true"><span data-slate-string="true"> Authorize(request *ladon.Request) *authzv1.Response {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16588"><span data-slate-object="text" data-key="16589"><span data-slate-leaf="true" data-offset-key="16589:0" data-first-offset="true"><span data-slate-string="true">  log.Debug(</span></span></span><span data-slate-object="text" data-key="16590"><span data-slate-leaf="true" data-offset-key="16590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"authorize request"</span></span></span></span><span data-slate-object="text" data-key="16591"><span data-slate-leaf="true" data-offset-key="16591:0" data-first-offset="true"><span data-slate-string="true">, log.Any(</span></span></span><span data-slate-object="text" data-key="16592"><span data-slate-leaf="true" data-offset-key="16592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"request"</span></span></span></span><span data-slate-object="text" data-key="16593"><span data-slate-leaf="true" data-offset-key="16593:0" data-first-offset="true"><span data-slate-string="true">, request))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16594"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16595"><span data-slate-object="text" data-key="16596"><span data-slate-leaf="true" data-offset-key="16596:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16597"><span data-slate-leaf="true" data-offset-key="16597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16598"><span data-slate-leaf="true" data-offset-key="16598:0" data-first-offset="true"><span data-slate-string="true"> err := a.warden.IsAllowed(request); err != </span></span></span><span data-slate-object="text" data-key="16599"><span data-slate-leaf="true" data-offset-key="16599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16600"><span data-slate-leaf="true" data-offset-key="16600:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16601"><span data-slate-object="text" data-key="16602"><span data-slate-leaf="true" data-offset-key="16602:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16603"><span data-slate-leaf="true" data-offset-key="16603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16604"><span data-slate-leaf="true" data-offset-key="16604:0" data-first-offset="true"><span data-slate-string="true"> &amp;authzv1.Response{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16605"><span data-slate-object="text" data-key="16606"><span data-slate-leaf="true" data-offset-key="16606:0" data-first-offset="true"><span data-slate-string="true">      Denied: </span></span></span><span data-slate-object="text" data-key="16607"><span data-slate-leaf="true" data-offset-key="16607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="16608"><span data-slate-leaf="true" data-offset-key="16608:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16609"><span data-slate-object="text" data-key="16610"><span data-slate-leaf="true" data-offset-key="16610:0" data-first-offset="true"><span data-slate-string="true">      Reason: err.Error(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16611"><span data-slate-object="text" data-key="16612"><span data-slate-leaf="true" data-offset-key="16612:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16613"><span data-slate-object="text" data-key="16614"><span data-slate-leaf="true" data-offset-key="16614:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16615"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16616"><span data-slate-object="text" data-key="16617"><span data-slate-leaf="true" data-offset-key="16617:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="16618"><span data-slate-leaf="true" data-offset-key="16618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16619"><span data-slate-leaf="true" data-offset-key="16619:0" data-first-offset="true"><span data-slate-string="true"> &amp;authzv1.Response{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16620"><span data-slate-object="text" data-key="16621"><span data-slate-leaf="true" data-offset-key="16621:0" data-first-offset="true"><span data-slate-string="true">    Allowed: </span></span></span><span data-slate-object="text" data-key="16622"><span data-slate-leaf="true" data-offset-key="16622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="16623"><span data-slate-leaf="true" data-offset-key="16623:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16624"><span data-slate-object="text" data-key="16625"><span data-slate-leaf="true" data-offset-key="16625:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16626"><span data-slate-object="text" data-key="16627"><span data-slate-leaf="true" data-offset-key="16627:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16628"><span data-slate-object="text" data-key="16629"><span data-slate-leaf="true" data-offset-key="16629:0" data-first-offset="true"><span data-slate-string="true">该函数会调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16630"><span data-slate-object="text" data-key="16631"><span data-slate-leaf="true" data-offset-key="16631:0" data-first-offset="true"><span data-slate-string="true">a.warden.IsAllowed(request)</span></span></span></span><span data-slate-object="text" data-key="16632"><span data-slate-leaf="true" data-offset-key="16632:0" data-first-offset="true"><span data-slate-string="true"> 完成资源访问授权。IsAllowed 函数会调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16633"><span data-slate-object="text" data-key="16634"><span data-slate-leaf="true" data-offset-key="16634:0" data-first-offset="true"><span data-slate-string="true">FindRequestCandidates(r)</span></span></span></span><span data-slate-object="text" data-key="16635"><span data-slate-leaf="true" data-offset-key="16635:0" data-first-offset="true"><span data-slate-string="true"> 查询所有的策略列表，这里要注意，我们只需要查询请求用户的 policy 列表。在 Authorize 函数中，我们将 username 存入 ladon Request 的 context 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16636"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16637"><span data-slate-object="text" data-key="16638"><span data-slate-leaf="true" data-offset-key="16638:0" data-first-offset="true"><span data-slate-string="true">r.Context[</span></span></span><span data-slate-object="text" data-key="16639"><span data-slate-leaf="true" data-offset-key="16639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="16640"><span data-slate-leaf="true" data-offset-key="16640:0" data-first-offset="true"><span data-slate-string="true">] = c.GetHeader(</span></span></span><span data-slate-object="text" data-key="16641"><span data-slate-leaf="true" data-offset-key="16641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="16642"><span data-slate-leaf="true" data-offset-key="16642:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16643"><span data-slate-object="text" data-key="16644"><span data-slate-leaf="true" data-offset-key="16644:0" data-first-offset="true"><span data-slate-string="true">在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16645"><span data-slate-object="text" data-key="16646"><span data-slate-leaf="true" data-offset-key="16646:0" data-first-offset="true"><span data-slate-string="true">FindRequestCandidates</span></span></span></a><span data-slate-object="text" data-key="16647"><span data-slate-leaf="true" data-offset-key="16647:0" data-first-offset="true"><span data-slate-string="true"> 函数中，我们可以从 Request 中取出 username，并根据 username 查询缓存中的 policy 列表，FindRequestCandidates 实现如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16648"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16649"><span data-slate-object="text" data-key="16650"><span data-slate-leaf="true" data-offset-key="16650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16651"><span data-slate-leaf="true" data-offset-key="16651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16652"><span data-slate-leaf="true" data-offset-key="16652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(m *PolicyManager)</span></span></span></span></span><span data-slate-object="text" data-key="16653"><span data-slate-leaf="true" data-offset-key="16653:0" data-first-offset="true"><span data-slate-string="true"> FindRequestCandidates(r *ladon.Request) (ladon.Policies, </span></span></span><span data-slate-object="text" data-key="16654"><span data-slate-leaf="true" data-offset-key="16654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="16655"><span data-slate-leaf="true" data-offset-key="16655:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16656"><span data-slate-object="text" data-key="16657"><span data-slate-leaf="true" data-offset-key="16657:0" data-first-offset="true"><span data-slate-string="true">    username := </span></span></span><span data-slate-object="text" data-key="16658"><span data-slate-leaf="true" data-offset-key="16658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16659"><span data-slate-object="text" data-key="16660"><span data-slate-leaf="true" data-offset-key="16660:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16661"><span data-slate-object="text" data-key="16662"><span data-slate-leaf="true" data-offset-key="16662:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16663"><span data-slate-leaf="true" data-offset-key="16663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16664"><span data-slate-leaf="true" data-offset-key="16664:0" data-first-offset="true"><span data-slate-string="true"> user, ok := r.Context[</span></span></span><span data-slate-object="text" data-key="16665"><span data-slate-leaf="true" data-offset-key="16665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="16666"><span data-slate-leaf="true" data-offset-key="16666:0" data-first-offset="true"><span data-slate-string="true">].(</span></span></span><span data-slate-object="text" data-key="16667"><span data-slate-leaf="true" data-offset-key="16667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="16668"><span data-slate-leaf="true" data-offset-key="16668:0" data-first-offset="true"><span data-slate-string="true">); ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16669"><span data-slate-object="text" data-key="16670"><span data-slate-leaf="true" data-offset-key="16670:0" data-first-offset="true"><span data-slate-string="true">      username = user</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16671"><span data-slate-object="text" data-key="16672"><span data-slate-leaf="true" data-offset-key="16672:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16673"><span data-slate-object="text" data-key="16674"><span data-slate-leaf="true" data-offset-key="16674:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16675"><span data-slate-object="text" data-key="16676"><span data-slate-leaf="true" data-offset-key="16676:0" data-first-offset="true"><span data-slate-string="true">    policies, err := m.client.List(username)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16677"><span data-slate-object="text" data-key="16678"><span data-slate-leaf="true" data-offset-key="16678:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16679"><span data-slate-leaf="true" data-offset-key="16679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16680"><span data-slate-leaf="true" data-offset-key="16680:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="16681"><span data-slate-leaf="true" data-offset-key="16681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16682"><span data-slate-leaf="true" data-offset-key="16682:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16683"><span data-slate-object="text" data-key="16684"><span data-slate-leaf="true" data-offset-key="16684:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16685"><span data-slate-leaf="true" data-offset-key="16685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16686"><span data-slate-leaf="true" data-offset-key="16686:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16687"><span data-slate-leaf="true" data-offset-key="16687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16688"><span data-slate-leaf="true" data-offset-key="16688:0" data-first-offset="true"><span data-slate-string="true">, errors.Wrap(err, </span></span></span><span data-slate-object="text" data-key="16689"><span data-slate-leaf="true" data-offset-key="16689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"list policies failed"</span></span></span></span><span data-slate-object="text" data-key="16690"><span data-slate-leaf="true" data-offset-key="16690:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16691"><span data-slate-object="text" data-key="16692"><span data-slate-leaf="true" data-offset-key="16692:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16693"><span data-slate-object="text" data-key="16694"><span data-slate-leaf="true" data-offset-key="16694:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16695"><span data-slate-object="text" data-key="16696"><span data-slate-leaf="true" data-offset-key="16696:0" data-first-offset="true"><span data-slate-string="true">    ret := </span></span></span><span data-slate-object="text" data-key="16697"><span data-slate-leaf="true" data-offset-key="16697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="16698"><span data-slate-leaf="true" data-offset-key="16698:0" data-first-offset="true"><span data-slate-string="true">([]ladon.Policy, </span></span></span><span data-slate-object="text" data-key="16699"><span data-slate-leaf="true" data-offset-key="16699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="16700"><span data-slate-leaf="true" data-offset-key="16700:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="16701"><span data-slate-leaf="true" data-offset-key="16701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="16702"><span data-slate-leaf="true" data-offset-key="16702:0" data-first-offset="true"><span data-slate-string="true">(policies))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16703"><span data-slate-object="text" data-key="16704"><span data-slate-leaf="true" data-offset-key="16704:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16705"><span data-slate-leaf="true" data-offset-key="16705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16706"><span data-slate-leaf="true" data-offset-key="16706:0" data-first-offset="true"><span data-slate-string="true"> _, policy := </span></span></span><span data-slate-object="text" data-key="16707"><span data-slate-leaf="true" data-offset-key="16707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="16708"><span data-slate-leaf="true" data-offset-key="16708:0" data-first-offset="true"><span data-slate-string="true"> policies {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16709"><span data-slate-object="text" data-key="16710"><span data-slate-leaf="true" data-offset-key="16710:0" data-first-offset="true"><span data-slate-string="true">      ret = </span></span></span><span data-slate-object="text" data-key="16711"><span data-slate-leaf="true" data-offset-key="16711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="16712"><span data-slate-leaf="true" data-offset-key="16712:0" data-first-offset="true"><span data-slate-string="true">(ret, policy)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16713"><span data-slate-object="text" data-key="16714"><span data-slate-leaf="true" data-offset-key="16714:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16715"><span data-slate-object="text" data-key="16716"><span data-slate-leaf="true" data-offset-key="16716:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16717"><span data-slate-object="text" data-key="16718"><span data-slate-leaf="true" data-offset-key="16718:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16719"><span data-slate-leaf="true" data-offset-key="16719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16720"><span data-slate-leaf="true" data-offset-key="16720:0" data-first-offset="true"><span data-slate-string="true"> ret, </span></span></span><span data-slate-object="text" data-key="16721"><span data-slate-leaf="true" data-offset-key="16721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16722"><span data-slate-object="text" data-key="16723"><span data-slate-leaf="true" data-offset-key="16723:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16724"><span data-slate-object="text" data-key="16725"><span data-slate-leaf="true" data-offset-key="16725:0" data-first-offset="true"><span data-slate-string="true">IsAllowed 函数代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16726"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16727"><span data-slate-object="text" data-key="16728"><span data-slate-leaf="true" data-offset-key="16728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16729"><span data-slate-leaf="true" data-offset-key="16729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16730"><span data-slate-leaf="true" data-offset-key="16730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(l *Ladon)</span></span></span></span></span><span data-slate-object="text" data-key="16731"><span data-slate-leaf="true" data-offset-key="16731:0" data-first-offset="true"><span data-slate-string="true"> IsAllowed(r *Request) (err </span></span></span><span data-slate-object="text" data-key="16732"><span data-slate-leaf="true" data-offset-key="16732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="16733"><span data-slate-leaf="true" data-offset-key="16733:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16734"><span data-slate-object="text" data-key="16735"><span data-slate-leaf="true" data-offset-key="16735:0" data-first-offset="true"><span data-slate-string="true">    policies, err := l.Manager.FindRequestCandidates(r)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16736"><span data-slate-object="text" data-key="16737"><span data-slate-leaf="true" data-offset-key="16737:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16738"><span data-slate-leaf="true" data-offset-key="16738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16739"><span data-slate-leaf="true" data-offset-key="16739:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="16740"><span data-slate-leaf="true" data-offset-key="16740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16741"><span data-slate-leaf="true" data-offset-key="16741:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16742"><span data-slate-object="text" data-key="16743"><span data-slate-leaf="true" data-offset-key="16743:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16744"><span data-slate-leaf="true" data-offset-key="16744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16745"><span data-slate-leaf="true" data-offset-key="16745:0" data-first-offset="true"><span data-slate-string="true"> l.metric().RequestProcessingError(*r, </span></span></span><span data-slate-object="text" data-key="16746"><span data-slate-leaf="true" data-offset-key="16746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16747"><span data-slate-leaf="true" data-offset-key="16747:0" data-first-offset="true"><span data-slate-string="true">, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16748"><span data-slate-object="text" data-key="16749"><span data-slate-leaf="true" data-offset-key="16749:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16750"><span data-slate-leaf="true" data-offset-key="16750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16751"><span data-slate-leaf="true" data-offset-key="16751:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16752"><span data-slate-object="text" data-key="16753"><span data-slate-leaf="true" data-offset-key="16753:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16754"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16755"><span data-slate-object="text" data-key="16756"><span data-slate-leaf="true" data-offset-key="16756:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16757"><span data-slate-leaf="true" data-offset-key="16757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="16758"><span data-slate-leaf="true" data-offset-key="16758:0" data-first-offset="true"><span data-slate-string="true"> l.DoPoliciesAllow(r, policies)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16759"><span data-slate-object="text" data-key="16760"><span data-slate-leaf="true" data-offset-key="16760:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16761"><span data-slate-object="text" data-key="16762"><span data-slate-leaf="true" data-offset-key="16762:0" data-first-offset="true"><span data-slate-string="true">IsAllowed 会调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16763"><span data-slate-object="text" data-key="16764"><span data-slate-leaf="true" data-offset-key="16764:0" data-first-offset="true"><span data-slate-string="true">DoPoliciesAllow(r, policies)</span></span></span></span><span data-slate-object="text" data-key="16765"><span data-slate-leaf="true" data-offset-key="16765:0" data-first-offset="true"><span data-slate-string="true"> 函数进行权限校验。如果权限校验不通过（请求在指定条件下不能够对资源做指定操作），就调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16766"><span data-slate-object="text" data-key="16767"><span data-slate-leaf="true" data-offset-key="16767:0" data-first-offset="true"><span data-slate-string="true">LogRejectedAccessRequest</span></span></span></span><span data-slate-object="text" data-key="16768"><span data-slate-leaf="true" data-offset-key="16768:0" data-first-offset="true"><span data-slate-string="true"> 函数记录拒绝的请求，并返回值为非 nil 的 error，error 中记录了授权失败的错误信息。如果权限校验通过，则调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16769"><span data-slate-object="text" data-key="16770"><span data-slate-leaf="true" data-offset-key="16770:0" data-first-offset="true"><span data-slate-string="true">LogGrantedAccessRequest</span></span></span></span><span data-slate-object="text" data-key="16771"><span data-slate-leaf="true" data-offset-key="16771:0" data-first-offset="true"><span data-slate-string="true"> 函数记录允许的请求，并返回值为 nil 的 error。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16772"><span data-slate-object="text" data-key="16773"><span data-slate-leaf="true" data-offset-key="16773:0" data-first-offset="true"><span data-slate-string="true">为了降低请求延时，LogRejectedAccessRequest 和 LogGrantedAccessRequest 会将授权记录存储在 Redis 中，之后由 iam-pump 进程读取 Redis，并将授权记录持久化存储在 MongoDB 中。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="16774" id="sr-toc-11"><span data-slate-object="text" data-key="16775"><span data-slate-leaf="true" data-offset-key="16775:0" data-first-offset="true"><span data-slate-string="true">缓存设计</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="16776"><span data-slate-object="text" data-key="16777"><span data-slate-leaf="true" data-offset-key="16777:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 主要用来做资源访问授权，属于数据流的组件，对接口访问性能有比较高的要求，所以该组件采用了缓存的机制。如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="16778"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/05/51/05d1c9a9acdc451f915684c18c8b9f51.jpg?wh=2248x822"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16779"><span data-slate-object="text" data-key="16780"><span data-slate-leaf="true" data-offset-key="16780:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 组件通过</span></span></span><span data-slate-object="text" data-key="16781"><span data-slate-leaf="true" data-offset-key="16781:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">缓存密钥和授权策略信息</span></span></span></span><span data-slate-object="text" data-key="16782"><span data-slate-leaf="true" data-offset-key="16782:0" data-first-offset="true"><span data-slate-string="true">到内存中，加快密钥和授权策略的查询速度。通过</span></span></span><span data-slate-object="text" data-key="16783"><span data-slate-leaf="true" data-offset-key="16783:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">缓存授权记录</span></span></span></span><span data-slate-object="text" data-key="16784"><span data-slate-leaf="true" data-offset-key="16784:0" data-first-offset="true"><span data-slate-string="true">到内存中，提高了授权数据的写入速度，从而大大降低了授权请求接口的延时。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16785"><span data-slate-object="text" data-key="16786"><span data-slate-leaf="true" data-offset-key="16786:0" data-first-offset="true"><span data-slate-string="true">上面的缓存机制用到了 Redis key-value 存储，所以在 iam-authz-server 初始化阶段，需要先建立 Redis 连接（位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16787"><span data-slate-object="text" data-key="16788"><span data-slate-leaf="true" data-offset-key="16788:0" data-first-offset="true"><span data-slate-string="true">initialize</span></span></span></a><span data-slate-object="text" data-key="16789"><span data-slate-leaf="true" data-offset-key="16789:0" data-first-offset="true"><span data-slate-string="true"> 函数中）：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16790"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16791"><span data-slate-object="text" data-key="16792"><span data-slate-leaf="true" data-offset-key="16792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16793"><span data-slate-leaf="true" data-offset-key="16793:0" data-first-offset="true"><span data-slate-string="true"> storage.ConnectToRedis(ctx, s.buildStorageConfig())</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16794"><span data-slate-object="text" data-key="16795"><span data-slate-leaf="true" data-offset-key="16795:0" data-first-offset="true"><span data-slate-string="true">这个代码会维护一个 Redis 连接，如果 Redis 连接断掉，会尝试重连。这种方式可以使我们在调用 Redis 接口进行数据读写时，不用考虑连接断开的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16796"><span data-slate-object="text" data-key="16797"><span data-slate-leaf="true" data-offset-key="16797:0" data-first-offset="true"><span data-slate-string="true">接下来，我们就来详细看看，iam-authz-server 是如何实现缓存机制的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16798"><span data-slate-object="text" data-key="16799"><span data-slate-leaf="true" data-offset-key="16799:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">先来看下密钥和策略缓存。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16800"><span data-slate-object="text" data-key="16801"><span data-slate-leaf="true" data-offset-key="16801:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16802"><span data-slate-object="text" data-key="16803"><span data-slate-leaf="true" data-offset-key="16803:0" data-first-offset="true"><span data-slate-string="true">load</span></span></span></a><span data-slate-object="text" data-key="16804"><span data-slate-leaf="true" data-offset-key="16804:0" data-first-offset="true"><span data-slate-string="true"> 包来完成密钥和策略的缓存。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16805"><span data-slate-object="text" data-key="16806"><span data-slate-leaf="true" data-offset-key="16806:0" data-first-offset="true"><span data-slate-string="true">在 iam-authz-server 进程启动时，会创建并启动一个 Load 服务（位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16807"><span data-slate-object="text" data-key="16808"><span data-slate-leaf="true" data-offset-key="16808:0" data-first-offset="true"><span data-slate-string="true">initialize</span></span></span></a><span data-slate-object="text" data-key="16809"><span data-slate-leaf="true" data-offset-key="16809:0" data-first-offset="true"><span data-slate-string="true"> 函数中）：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16810"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16811"><span data-slate-object="text" data-key="16812"><span data-slate-leaf="true" data-offset-key="16812:0" data-first-offset="true"><span data-slate-string="true">load.NewLoader(ctx, cacheIns).Start() </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16813"><span data-slate-object="text" data-key="16814"><span data-slate-leaf="true" data-offset-key="16814:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">先来看创建 Load 服务。</span></span></span></span><span data-slate-object="text" data-key="16815"><span data-slate-leaf="true" data-offset-key="16815:0" data-first-offset="true"><span data-slate-string="true">创建 Load 服务时，传入了 cacheIns 参数，cacheIns 是一个实现了 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16816"><span data-slate-object="text" data-key="16817"><span data-slate-leaf="true" data-offset-key="16817:0" data-first-offset="true"><span data-slate-string="true">Loader</span></span></span></a><span data-slate-object="text" data-key="16818"><span data-slate-leaf="true" data-offset-key="16818:0" data-first-offset="true"><span data-slate-string="true"> 接口的实例：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16819"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16820"><span data-slate-object="text" data-key="16821"><span data-slate-leaf="true" data-offset-key="16821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="16822"><span data-slate-leaf="true" data-offset-key="16822:0" data-first-offset="true"><span data-slate-string="true"> Loader </span></span></span><span data-slate-object="text" data-key="16823"><span data-slate-leaf="true" data-offset-key="16823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="16824"><span data-slate-leaf="true" data-offset-key="16824:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16825"><span data-slate-object="text" data-key="16826"><span data-slate-leaf="true" data-offset-key="16826:0" data-first-offset="true"><span data-slate-string="true">    Reload() </span></span></span><span data-slate-object="text" data-key="16827"><span data-slate-leaf="true" data-offset-key="16827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16828"><span data-slate-object="text" data-key="16829"><span data-slate-leaf="true" data-offset-key="16829:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16830"><span data-slate-object="text" data-key="16831"><span data-slate-leaf="true" data-offset-key="16831:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">然后看启动 Load 服务。</span></span></span></span><span data-slate-object="text" data-key="16832"><span data-slate-leaf="true" data-offset-key="16832:0" data-first-offset="true"><span data-slate-string="true">通过 Load 实例的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16833"><span data-slate-object="text" data-key="16834"><span data-slate-leaf="true" data-offset-key="16834:0" data-first-offset="true"><span data-slate-string="true">Start</span></span></span></a><span data-slate-object="text" data-key="16835"><span data-slate-leaf="true" data-offset-key="16835:0" data-first-offset="true"><span data-slate-string="true"> 方法来启动 Load 服务：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16836"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16837"><span data-slate-object="text" data-key="16838"><span data-slate-leaf="true" data-offset-key="16838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16839"><span data-slate-leaf="true" data-offset-key="16839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16840"><span data-slate-leaf="true" data-offset-key="16840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(l *Load)</span></span></span></span></span><span data-slate-object="text" data-key="16841"><span data-slate-leaf="true" data-offset-key="16841:0" data-first-offset="true"><span data-slate-string="true"> Start() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16842"><span data-slate-object="text" data-key="16843"><span data-slate-leaf="true" data-offset-key="16843:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16844"><span data-slate-leaf="true" data-offset-key="16844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16845"><span data-slate-leaf="true" data-offset-key="16845:0" data-first-offset="true"><span data-slate-string="true"> startPubSubLoop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16846"><span data-slate-object="text" data-key="16847"><span data-slate-leaf="true" data-offset-key="16847:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16848"><span data-slate-leaf="true" data-offset-key="16848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16849"><span data-slate-leaf="true" data-offset-key="16849:0" data-first-offset="true"><span data-slate-string="true"> l.reloadQueueLoop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16850"><span data-slate-object="text" data-key="16851"><span data-slate-leaf="true" data-offset-key="16851:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16852"><span data-slate-leaf="true" data-offset-key="16852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="16853"><span data-slate-leaf="true" data-offset-key="16853:0" data-first-offset="true"><span data-slate-string="true"> l.reloadLoop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16854"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16855"><span data-slate-object="text" data-key="16856"><span data-slate-leaf="true" data-offset-key="16856:0" data-first-offset="true"><span data-slate-string="true">    l.DoReload()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16857"><span data-slate-object="text" data-key="16858"><span data-slate-leaf="true" data-offset-key="16858:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16859"><span data-slate-object="text" data-key="16860"><span data-slate-leaf="true" data-offset-key="16860:0" data-first-offset="true"><span data-slate-string="true">Start 函数先启动了 3 个协程，再调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16861"><span data-slate-object="text" data-key="16862"><span data-slate-leaf="true" data-offset-key="16862:0" data-first-offset="true"><span data-slate-string="true">l.DoReload()</span></span></span></span><span data-slate-object="text" data-key="16863"><span data-slate-leaf="true" data-offset-key="16863:0" data-first-offset="true"><span data-slate-string="true"> 完成一次密钥和策略的同步：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16864"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16865"><span data-slate-object="text" data-key="16866"><span data-slate-leaf="true" data-offset-key="16866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16867"><span data-slate-leaf="true" data-offset-key="16867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16868"><span data-slate-leaf="true" data-offset-key="16868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(l *Load)</span></span></span></span></span><span data-slate-object="text" data-key="16869"><span data-slate-leaf="true" data-offset-key="16869:0" data-first-offset="true"><span data-slate-string="true"> DoReload() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16870"><span data-slate-object="text" data-key="16871"><span data-slate-leaf="true" data-offset-key="16871:0" data-first-offset="true"><span data-slate-string="true">    l.lock.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16872"><span data-slate-object="text" data-key="16873"><span data-slate-leaf="true" data-offset-key="16873:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16874"><span data-slate-leaf="true" data-offset-key="16874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="16875"><span data-slate-leaf="true" data-offset-key="16875:0" data-first-offset="true"><span data-slate-string="true"> l.lock.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16876"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16877"><span data-slate-object="text" data-key="16878"><span data-slate-leaf="true" data-offset-key="16878:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16879"><span data-slate-leaf="true" data-offset-key="16879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16880"><span data-slate-leaf="true" data-offset-key="16880:0" data-first-offset="true"><span data-slate-string="true"> err := l.loader.Reload(); err != </span></span></span><span data-slate-object="text" data-key="16881"><span data-slate-leaf="true" data-offset-key="16881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16882"><span data-slate-leaf="true" data-offset-key="16882:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16883"><span data-slate-object="text" data-key="16884"><span data-slate-leaf="true" data-offset-key="16884:0" data-first-offset="true"><span data-slate-string="true">        log.Errorf(</span></span></span><span data-slate-object="text" data-key="16885"><span data-slate-leaf="true" data-offset-key="16885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"faild to refresh target storage: %s"</span></span></span></span><span data-slate-object="text" data-key="16886"><span data-slate-leaf="true" data-offset-key="16886:0" data-first-offset="true"><span data-slate-string="true">, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16887"><span data-slate-object="text" data-key="16888"><span data-slate-leaf="true" data-offset-key="16888:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16889"></div><div data-slate-type="code-line" data-slate-object="block" data-key="16890"><span data-slate-object="text" data-key="16891"><span data-slate-leaf="true" data-offset-key="16891:0" data-first-offset="true"><span data-slate-string="true">    log.Debug(</span></span></span><span data-slate-object="text" data-key="16892"><span data-slate-leaf="true" data-offset-key="16892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"refresh target storage succ"</span></span></span></span><span data-slate-object="text" data-key="16893"><span data-slate-leaf="true" data-offset-key="16893:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16894"><span data-slate-object="text" data-key="16895"><span data-slate-leaf="true" data-offset-key="16895:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16896"><span data-slate-object="text" data-key="16897"><span data-slate-leaf="true" data-offset-key="16897:0" data-first-offset="true"><span data-slate-string="true">上面我们说了，创建 Load 服务时，传入的 cacheIns 实例是一个实现了 Loader 接口的实例，所以在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16898"><span data-slate-object="text" data-key="16899"><span data-slate-leaf="true" data-offset-key="16899:0" data-first-offset="true"><span data-slate-string="true">DoReload</span></span></span></a><span data-slate-object="text" data-key="16900"><span data-slate-leaf="true" data-offset-key="16900:0" data-first-offset="true"><span data-slate-string="true"> 方法中，可以直接调用 Reload 方法。cacheIns 的 Reload 方法会从 iam-apiserver 中同步密钥和策略信息到 iam-authz-server 缓存中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16901"><span data-slate-object="text" data-key="16902"><span data-slate-leaf="true" data-offset-key="16902:0" data-first-offset="true"><span data-slate-string="true">我们再来看下，startPubSubLoop、reloadQueueLoop、reloadLoop 这 3 个 Go 协程分别完成了什么功能。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16903"><div data-slate-type="list-line" data-slate-object="block" data-key="16904"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="16905"><span data-slate-leaf="true" data-offset-key="16905:0" data-first-offset="true"><span data-slate-string="true">startPubSubLoop 协程</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16906"><a data-slate-type="link" data-slate-object="inline" data-key="16907"><span data-slate-object="text" data-key="16908"><span data-slate-leaf="true" data-offset-key="16908:0" data-first-offset="true"><span data-slate-string="true">startPubSubLoop</span></span></span></a><span data-slate-object="text" data-key="16909"><span data-slate-leaf="true" data-offset-key="16909:0" data-first-offset="true"><span data-slate-string="true"> 函数通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16910"><span data-slate-object="text" data-key="16911"><span data-slate-leaf="true" data-offset-key="16911:0" data-first-offset="true"><span data-slate-string="true">StartPubSubHandler</span></span></span></a><span data-slate-object="text" data-key="16912"><span data-slate-leaf="true" data-offset-key="16912:0" data-first-offset="true"><span data-slate-string="true"> 函数，订阅 Redis 的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16913"><span data-slate-object="text" data-key="16914"><span data-slate-leaf="true" data-offset-key="16914:0" data-first-offset="true"><span data-slate-string="true">iam.cluster.notifications</span></span></span></span><span data-slate-object="text" data-key="16915"><span data-slate-leaf="true" data-offset-key="16915:0" data-first-offset="true"><span data-slate-string="true"> channel，并注册一个回调函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16916"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16917"><span data-slate-object="text" data-key="16918"><span data-slate-leaf="true" data-offset-key="16918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16919"><span data-slate-leaf="true" data-offset-key="16919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(v </span></span></span></span></span><span data-slate-object="text" data-key="16920"><span data-slate-leaf="true" data-offset-key="16920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span></span></span><span data-slate-object="text" data-key="16921"><span data-slate-leaf="true" data-offset-key="16921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">{})</span></span></span></span></span><span data-slate-object="text" data-key="16922"><span data-slate-leaf="true" data-offset-key="16922:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16923"><span data-slate-object="text" data-key="16924"><span data-slate-leaf="true" data-offset-key="16924:0" data-first-offset="true"><span data-slate-string="true">    handleRedisEvent(v, </span></span></span><span data-slate-object="text" data-key="16925"><span data-slate-leaf="true" data-offset-key="16925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16926"><span data-slate-leaf="true" data-offset-key="16926:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="16927"><span data-slate-leaf="true" data-offset-key="16927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="16928"><span data-slate-leaf="true" data-offset-key="16928:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16929"><span data-slate-object="text" data-key="16930"><span data-slate-leaf="true" data-offset-key="16930:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16931"><a data-slate-type="link" data-slate-object="inline" data-key="16932"><span data-slate-object="text" data-key="16933"><span data-slate-leaf="true" data-offset-key="16933:0" data-first-offset="true"><span data-slate-string="true">handleRedisEvent</span></span></span></a><span data-slate-object="text" data-key="16934"><span data-slate-leaf="true" data-offset-key="16934:0" data-first-offset="true"><span data-slate-string="true"> 函数中，会将消息解析为 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="16935"><span data-slate-object="text" data-key="16936"><span data-slate-leaf="true" data-offset-key="16936:0" data-first-offset="true"><span data-slate-string="true">Notification</span></span></span></a><span data-slate-object="text" data-key="16937"><span data-slate-leaf="true" data-offset-key="16937:0" data-first-offset="true"><span data-slate-string="true"> 类型的消息，并判断 Command 的值。如果是 NoticePolicyChanged 或 NoticeSecretChanged，就会向 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16938"><span data-slate-object="text" data-key="16939"><span data-slate-leaf="true" data-offset-key="16939:0" data-first-offset="true"><span data-slate-string="true">reloadQueue</span></span></span></span><span data-slate-object="text" data-key="16940"><span data-slate-leaf="true" data-offset-key="16940:0" data-first-offset="true"><span data-slate-string="true"> channel 中写入一个回调函数。因为我们不需要用回调函数做任何事情，所以这里回调函数是 nil。 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16941"><span data-slate-object="text" data-key="16942"><span data-slate-leaf="true" data-offset-key="16942:0" data-first-offset="true"><span data-slate-string="true">reloadQueue</span></span></span></span><span data-slate-object="text" data-key="16943"><span data-slate-leaf="true" data-offset-key="16943:0" data-first-offset="true"><span data-slate-string="true"> 主要用来告诉程序，需要完成一次密钥和策略的同步。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="16944"><div data-slate-type="list-line" data-slate-object="block" data-key="16945"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="16946"><span data-slate-leaf="true" data-offset-key="16946:0" data-first-offset="true"><span data-slate-string="true">reloadQueueLoop 协程</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="16947"><span data-slate-object="text" data-key="16948"><span data-slate-leaf="true" data-offset-key="16948:0" data-first-offset="true"><span data-slate-string="true">reloadQueueLoop 函数会监听 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16949"><span data-slate-object="text" data-key="16950"><span data-slate-leaf="true" data-offset-key="16950:0" data-first-offset="true"><span data-slate-string="true">reloadQueue</span></span></span></span><span data-slate-object="text" data-key="16951"><span data-slate-leaf="true" data-offset-key="16951:0" data-first-offset="true"><span data-slate-string="true"> ，当发现有新的消息（这里是回调函数）写入时，会实时将消息缓存到 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="16952"><span data-slate-object="text" data-key="16953"><span data-slate-leaf="true" data-offset-key="16953:0" data-first-offset="true"><span data-slate-string="true">requeue</span></span></span></span><span data-slate-object="text" data-key="16954"><span data-slate-leaf="true" data-offset-key="16954:0" data-first-offset="true"><span data-slate-string="true"> 切片中，代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="16955"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="16956"><span data-slate-object="text" data-key="16957"><span data-slate-leaf="true" data-offset-key="16957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="16958"><span data-slate-leaf="true" data-offset-key="16958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16959"><span data-slate-leaf="true" data-offset-key="16959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(l *Load)</span></span></span></span></span><span data-slate-object="text" data-key="16960"><span data-slate-leaf="true" data-offset-key="16960:0" data-first-offset="true"><span data-slate-string="true"> reloadQueueLoop(cb ...</span></span></span><span data-slate-object="text" data-key="16961"><span data-slate-leaf="true" data-offset-key="16961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span><span data-slate-object="text" data-key="16962"><span data-slate-leaf="true" data-offset-key="16962:0" data-first-offset="true"><span data-slate-string="true">()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16963"><span data-slate-object="text" data-key="16964"><span data-slate-leaf="true" data-offset-key="16964:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="16965"><span data-slate-leaf="true" data-offset-key="16965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="16966"><span data-slate-leaf="true" data-offset-key="16966:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16967"><span data-slate-object="text" data-key="16968"><span data-slate-leaf="true" data-offset-key="16968:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16969"><span data-slate-leaf="true" data-offset-key="16969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="16970"><span data-slate-leaf="true" data-offset-key="16970:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16971"><span data-slate-object="text" data-key="16972"><span data-slate-leaf="true" data-offset-key="16972:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16973"><span data-slate-leaf="true" data-offset-key="16973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16974"><span data-slate-leaf="true" data-offset-key="16974:0" data-first-offset="true"><span data-slate-string="true"> &lt;-l.ctx.Done():</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16975"><span data-slate-object="text" data-key="16976"><span data-slate-leaf="true" data-offset-key="16976:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16977"><span data-slate-leaf="true" data-offset-key="16977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16978"><span data-slate-object="text" data-key="16979"><span data-slate-leaf="true" data-offset-key="16979:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="16980"><span data-slate-leaf="true" data-offset-key="16980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="16981"><span data-slate-leaf="true" data-offset-key="16981:0" data-first-offset="true"><span data-slate-string="true"> fn := &lt;-reloadQueue:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16982"><span data-slate-object="text" data-key="16983"><span data-slate-leaf="true" data-offset-key="16983:0" data-first-offset="true"><span data-slate-string="true">        requeueLock.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16984"><span data-slate-object="text" data-key="16985"><span data-slate-leaf="true" data-offset-key="16985:0" data-first-offset="true"><span data-slate-string="true">        requeue = </span></span></span><span data-slate-object="text" data-key="16986"><span data-slate-leaf="true" data-offset-key="16986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">append</span></span></span></span><span data-slate-object="text" data-key="16987"><span data-slate-leaf="true" data-offset-key="16987:0" data-first-offset="true"><span data-slate-string="true">(requeue, fn)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16988"><span data-slate-object="text" data-key="16989"><span data-slate-leaf="true" data-offset-key="16989:0" data-first-offset="true"><span data-slate-string="true">        requeueLock.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16990"><span data-slate-object="text" data-key="16991"><span data-slate-leaf="true" data-offset-key="16991:0" data-first-offset="true"><span data-slate-string="true">        log.Info(</span></span></span><span data-slate-object="text" data-key="16992"><span data-slate-leaf="true" data-offset-key="16992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Reload queued"</span></span></span></span><span data-slate-object="text" data-key="16993"><span data-slate-leaf="true" data-offset-key="16993:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="16994"><span data-slate-object="text" data-key="16995"><span data-slate-leaf="true" data-offset-key="16995:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="16996"><span data-slate-leaf="true" data-offset-key="16996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="16997"><span data-slate-leaf="true" data-offset-key="16997:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="16998"><span data-slate-leaf="true" data-offset-key="16998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="16999"><span data-slate-leaf="true" data-offset-key="16999:0" data-first-offset="true"><span data-slate-string="true">(cb) != </span></span></span><span data-slate-object="text" data-key="17000"><span data-slate-leaf="true" data-offset-key="17000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17001"><span data-slate-leaf="true" data-offset-key="17001:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17002"><span data-slate-object="text" data-key="17003"><span data-slate-leaf="true" data-offset-key="17003:0" data-first-offset="true"><span data-slate-string="true">          cb[</span></span></span><span data-slate-object="text" data-key="17004"><span data-slate-leaf="true" data-offset-key="17004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17005"><span data-slate-leaf="true" data-offset-key="17005:0" data-first-offset="true"><span data-slate-string="true">]()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17006"><span data-slate-object="text" data-key="17007"><span data-slate-leaf="true" data-offset-key="17007:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17008"><span data-slate-object="text" data-key="17009"><span data-slate-leaf="true" data-offset-key="17009:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17010"><span data-slate-object="text" data-key="17011"><span data-slate-leaf="true" data-offset-key="17011:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17012"><span data-slate-object="text" data-key="17013"><span data-slate-leaf="true" data-offset-key="17013:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="17014"><div data-slate-type="list-line" data-slate-object="block" data-key="17015"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="17016"><span data-slate-leaf="true" data-offset-key="17016:0" data-first-offset="true"><span data-slate-string="true">reloadLoop 协程</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17017"><span data-slate-object="text" data-key="17018"><span data-slate-leaf="true" data-offset-key="17018:0" data-first-offset="true"><span data-slate-string="true">通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17019"><span data-slate-object="text" data-key="17020"><span data-slate-leaf="true" data-offset-key="17020:0" data-first-offset="true"><span data-slate-string="true">reloadLoop</span></span></span></a><span data-slate-object="text" data-key="17021"><span data-slate-leaf="true" data-offset-key="17021:0" data-first-offset="true"><span data-slate-string="true"> 函数启动一个 timer 定时器，每隔 1 秒会检查 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17022"><span data-slate-object="text" data-key="17023"><span data-slate-leaf="true" data-offset-key="17023:0" data-first-offset="true"><span data-slate-string="true">requeue</span></span></span></span><span data-slate-object="text" data-key="17024"><span data-slate-leaf="true" data-offset-key="17024:0" data-first-offset="true"><span data-slate-string="true"> 切片是否为空，如果不为空，则调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17025"><span data-slate-object="text" data-key="17026"><span data-slate-leaf="true" data-offset-key="17026:0" data-first-offset="true"><span data-slate-string="true">l.DoReload</span></span></span></span><span data-slate-object="text" data-key="17027"><span data-slate-leaf="true" data-offset-key="17027:0" data-first-offset="true"><span data-slate-string="true"> 方法，从 iam-apiserver 中拉取密钥和策略，并缓存在内存中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17028"><span data-slate-object="text" data-key="17029"><span data-slate-leaf="true" data-offset-key="17029:0" data-first-offset="true"><span data-slate-string="true">密钥和策略的缓存模型如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17030"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a2/11/a2f5694e5d6291ca610b84ee49469211.jpg?wh=2248x890"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17031"><span data-slate-object="text" data-key="17032"><span data-slate-leaf="true" data-offset-key="17032:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">密钥和策略缓存的具体流程如下：</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17033"><span data-slate-object="text" data-key="17034"><span data-slate-leaf="true" data-offset-key="17034:0" data-first-offset="true"><span data-slate-string="true">接收上游消息（这里是从 Redis 中接收），将消息缓存到切片或者带缓冲的 channel 中，并启动一个消费协程去消费这些消息。这里的消费协程是 reloadLoop，reloadLoop 会每隔 1s 判断 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17035"><span data-slate-object="text" data-key="17036"><span data-slate-leaf="true" data-offset-key="17036:0" data-first-offset="true"><span data-slate-string="true">requeue</span></span></span></span><span data-slate-object="text" data-key="17037"><span data-slate-leaf="true" data-offset-key="17037:0" data-first-offset="true"><span data-slate-string="true"> 切片是否长度为 0，如果不为 0，则执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17038"><span data-slate-object="text" data-key="17039"><span data-slate-leaf="true" data-offset-key="17039:0" data-first-offset="true"><span data-slate-string="true">l.DoReload()</span></span></span></span><span data-slate-object="text" data-key="17040"><span data-slate-leaf="true" data-offset-key="17040:0" data-first-offset="true"><span data-slate-string="true"> 缓存密钥和策略。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17041"><span data-slate-object="text" data-key="17042"><span data-slate-leaf="true" data-offset-key="17042:0" data-first-offset="true"><span data-slate-string="true">讲完了密钥和策略缓存，</span></span></span><span data-slate-object="text" data-key="17043"><span data-slate-leaf="true" data-offset-key="17043:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">再</span></span></span></span><span data-slate-object="text" data-key="17044"><span data-slate-leaf="true" data-offset-key="17044:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">来</span></span></span></span><span data-slate-object="text" data-key="17045"><span data-slate-leaf="true" data-offset-key="17045:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">看下授权日志缓存。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17046"><span data-slate-object="text" data-key="17047"><span data-slate-leaf="true" data-offset-key="17047:0" data-first-offset="true"><span data-slate-string="true">在启动 iam-authz-server 时，还会启动一个 Analytics 服务，代码如下（位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17048"><span data-slate-object="text" data-key="17049"><span data-slate-leaf="true" data-offset-key="17049:0" data-first-offset="true"><span data-slate-string="true">internal/authzserver/server.go</span></span></span></a><span data-slate-object="text" data-key="17050"><span data-slate-leaf="true" data-offset-key="17050:0" data-first-offset="true"><span data-slate-string="true"> 文件中）：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17051"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17052"><span data-slate-object="text" data-key="17053"><span data-slate-leaf="true" data-offset-key="17053:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17054"><span data-slate-leaf="true" data-offset-key="17054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17055"><span data-slate-leaf="true" data-offset-key="17055:0" data-first-offset="true"><span data-slate-string="true"> s.analyticsOptions.Enable {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17056"><span data-slate-object="text" data-key="17057"><span data-slate-leaf="true" data-offset-key="17057:0" data-first-offset="true"><span data-slate-string="true">        analyticsStore := storage.RedisCluster{KeyPrefix: RedisKeyPrefix}    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17058"><span data-slate-object="text" data-key="17059"><span data-slate-leaf="true" data-offset-key="17059:0" data-first-offset="true"><span data-slate-string="true">        analyticsIns := analytics.NewAnalytics(s.analyticsOptions, &amp;analyticsStore)    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17060"><span data-slate-object="text" data-key="17061"><span data-slate-leaf="true" data-offset-key="17061:0" data-first-offset="true"><span data-slate-string="true">        analyticsIns.Start()    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17062"><span data-slate-object="text" data-key="17063"><span data-slate-leaf="true" data-offset-key="17063:0" data-first-offset="true"><span data-slate-string="true">        s.gs.AddShutdownCallback(shutdown.ShutdownFunc(</span></span></span><span data-slate-object="text" data-key="17064"><span data-slate-leaf="true" data-offset-key="17064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17065"><span data-slate-leaf="true" data-offset-key="17065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="17066"><span data-slate-leaf="true" data-offset-key="17066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="17067"><span data-slate-leaf="true" data-offset-key="17067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="17068"><span data-slate-leaf="true" data-offset-key="17068:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17069"><span data-slate-leaf="true" data-offset-key="17069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="17070"><span data-slate-leaf="true" data-offset-key="17070:0" data-first-offset="true"><span data-slate-string="true"> {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17071"><span data-slate-object="text" data-key="17072"><span data-slate-leaf="true" data-offset-key="17072:0" data-first-offset="true"><span data-slate-string="true">            analyticsIns.Stop()    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17073"><span data-slate-object="text" data-key="17074"><span data-slate-leaf="true" data-offset-key="17074:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17075"><span data-slate-object="text" data-key="17076"><span data-slate-leaf="true" data-offset-key="17076:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="17077"><span data-slate-leaf="true" data-offset-key="17077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17078"><span data-slate-leaf="true" data-offset-key="17078:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17079"><span data-slate-leaf="true" data-offset-key="17079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17080"><span data-slate-leaf="true" data-offset-key="17080:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17081"><span data-slate-object="text" data-key="17082"><span data-slate-leaf="true" data-offset-key="17082:0" data-first-offset="true"><span data-slate-string="true">        }))    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17083"><span data-slate-object="text" data-key="17084"><span data-slate-leaf="true" data-offset-key="17084:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17085"><a data-slate-type="link" data-slate-object="inline" data-key="17086"><span data-slate-object="text" data-key="17087"><span data-slate-leaf="true" data-offset-key="17087:0" data-first-offset="true"><span data-slate-string="true">NewAnalytics</span></span></span></a><span data-slate-object="text" data-key="17088"><span data-slate-leaf="true" data-offset-key="17088:0" data-first-offset="true"><span data-slate-string="true"> 函数会根据配置，创建一个 Analytics 实例：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17089"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17090"><span data-slate-object="text" data-key="17091"><span data-slate-leaf="true" data-offset-key="17091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17092"><span data-slate-leaf="true" data-offset-key="17092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17093"><span data-slate-leaf="true" data-offset-key="17093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NewAnalytics</span></span></span></span></span><span data-slate-object="text" data-key="17094"><span data-slate-leaf="true" data-offset-key="17094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(options *AnalyticsOptions, store storage.AnalyticsHandler)</span></span></span></span></span><span data-slate-object="text" data-key="17095"><span data-slate-leaf="true" data-offset-key="17095:0" data-first-offset="true"><span data-slate-string="true"> *Analytics {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17096"><span data-slate-object="text" data-key="17097"><span data-slate-leaf="true" data-offset-key="17097:0" data-first-offset="true"><span data-slate-string="true">    ps := options.PoolSize</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17098"><span data-slate-object="text" data-key="17099"><span data-slate-leaf="true" data-offset-key="17099:0" data-first-offset="true"><span data-slate-string="true">    recordsBufferSize := options.RecordsBufferSize</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17100"><span data-slate-object="text" data-key="17101"><span data-slate-leaf="true" data-offset-key="17101:0" data-first-offset="true"><span data-slate-string="true">    workerBufferSize := recordsBufferSize / </span></span></span><span data-slate-object="text" data-key="17102"><span data-slate-leaf="true" data-offset-key="17102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span><span data-slate-object="text" data-key="17103"><span data-slate-leaf="true" data-offset-key="17103:0" data-first-offset="true"><span data-slate-string="true">(ps)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17104"><span data-slate-object="text" data-key="17105"><span data-slate-leaf="true" data-offset-key="17105:0" data-first-offset="true"><span data-slate-string="true">    log.Debug(</span></span></span><span data-slate-object="text" data-key="17106"><span data-slate-leaf="true" data-offset-key="17106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Analytics pool worker buffer size"</span></span></span></span><span data-slate-object="text" data-key="17107"><span data-slate-leaf="true" data-offset-key="17107:0" data-first-offset="true"><span data-slate-string="true">, log.Uint64(</span></span></span><span data-slate-object="text" data-key="17108"><span data-slate-leaf="true" data-offset-key="17108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"workerBufferSize"</span></span></span></span><span data-slate-object="text" data-key="17109"><span data-slate-leaf="true" data-offset-key="17109:0" data-first-offset="true"><span data-slate-string="true">, workerBufferSize))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17110"><span data-slate-object="text" data-key="17111"><span data-slate-leaf="true" data-offset-key="17111:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17112"><span data-slate-object="text" data-key="17113"><span data-slate-leaf="true" data-offset-key="17113:0" data-first-offset="true"><span data-slate-string="true">    recordsChan := </span></span></span><span data-slate-object="text" data-key="17114"><span data-slate-leaf="true" data-offset-key="17114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17115"><span data-slate-leaf="true" data-offset-key="17115:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17116"><span data-slate-leaf="true" data-offset-key="17116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17117"><span data-slate-leaf="true" data-offset-key="17117:0" data-first-offset="true"><span data-slate-string="true"> *AnalyticsRecord, recordsBufferSize)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17118"><span data-slate-object="text" data-key="17119"><span data-slate-leaf="true" data-offset-key="17119:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17120"><span data-slate-object="text" data-key="17121"><span data-slate-leaf="true" data-offset-key="17121:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17122"><span data-slate-leaf="true" data-offset-key="17122:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17123"><span data-slate-leaf="true" data-offset-key="17123:0" data-first-offset="true"><span data-slate-string="true"> &amp;Analytics{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17124"><span data-slate-object="text" data-key="17125"><span data-slate-leaf="true" data-offset-key="17125:0" data-first-offset="true"><span data-slate-string="true">      store:                      store,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17126"><span data-slate-object="text" data-key="17127"><span data-slate-leaf="true" data-offset-key="17127:0" data-first-offset="true"><span data-slate-string="true">      poolSize:                   ps,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17128"><span data-slate-object="text" data-key="17129"><span data-slate-leaf="true" data-offset-key="17129:0" data-first-offset="true"><span data-slate-string="true">      recordsChan:                recordsChan,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17130"><span data-slate-object="text" data-key="17131"><span data-slate-leaf="true" data-offset-key="17131:0" data-first-offset="true"><span data-slate-string="true">      workerBufferSize:           workerBufferSize,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17132"><span data-slate-object="text" data-key="17133"><span data-slate-leaf="true" data-offset-key="17133:0" data-first-offset="true"><span data-slate-string="true">      recordsBufferFlushInterval: options.FlushInterval,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17134"><span data-slate-object="text" data-key="17135"><span data-slate-leaf="true" data-offset-key="17135:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17136"><span data-slate-object="text" data-key="17137"><span data-slate-leaf="true" data-offset-key="17137:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17138"><span data-slate-object="text" data-key="17139"><span data-slate-leaf="true" data-offset-key="17139:0" data-first-offset="true"><span data-slate-string="true">上面的代码创建了一个带缓冲的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17140"><span data-slate-object="text" data-key="17141"><span data-slate-leaf="true" data-offset-key="17141:0" data-first-offset="true"><span data-slate-string="true">recordsChan</span></span></span></span><span data-slate-object="text" data-key="17142"><span data-slate-leaf="true" data-offset-key="17142:0" data-first-offset="true"><span data-slate-string="true"> ：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17143"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17144"><span data-slate-object="text" data-key="17145"><span data-slate-leaf="true" data-offset-key="17145:0" data-first-offset="true"><span data-slate-string="true">recordsChan := </span></span></span><span data-slate-object="text" data-key="17146"><span data-slate-leaf="true" data-offset-key="17146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="17147"><span data-slate-leaf="true" data-offset-key="17147:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="17148"><span data-slate-leaf="true" data-offset-key="17148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="17149"><span data-slate-leaf="true" data-offset-key="17149:0" data-first-offset="true"><span data-slate-string="true"> *AnalyticsRecord, recordsBufferSize)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17150"><span data-slate-type="code" data-slate-object="inline" data-key="17151"><span data-slate-object="text" data-key="17152"><span data-slate-leaf="true" data-offset-key="17152:0" data-first-offset="true"><span data-slate-string="true">recordsChan</span></span></span></span><span data-slate-object="text" data-key="17153"><span data-slate-leaf="true" data-offset-key="17153:0" data-first-offset="true"><span data-slate-string="true"> 存放的数据类型为 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17154"><span data-slate-object="text" data-key="17155"><span data-slate-leaf="true" data-offset-key="17155:0" data-first-offset="true"><span data-slate-string="true">AnalyticsRecord</span></span></span></a><span data-slate-object="text" data-key="17156"><span data-slate-leaf="true" data-offset-key="17156:0" data-first-offset="true"><span data-slate-string="true">，缓冲区的大小为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17157"><span data-slate-object="text" data-key="17158"><span data-slate-leaf="true" data-offset-key="17158:0" data-first-offset="true"><span data-slate-string="true">recordsBufferSize</span></span></span></span><span data-slate-object="text" data-key="17159"><span data-slate-leaf="true" data-offset-key="17159:0" data-first-offset="true"><span data-slate-string="true"> （通过 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17160"><span data-slate-object="text" data-key="17161"><span data-slate-leaf="true" data-offset-key="17161:0" data-first-offset="true"><span data-slate-string="true">--analytics.records-buffer-size</span></span></span></span><span data-slate-object="text" data-key="17162"><span data-slate-leaf="true" data-offset-key="17162:0" data-first-offset="true"><span data-slate-string="true"> 选项指定）。可以通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17163"><span data-slate-object="text" data-key="17164"><span data-slate-leaf="true" data-offset-key="17164:0" data-first-offset="true"><span data-slate-string="true">RecordHit</span></span></span></a><span data-slate-object="text" data-key="17165"><span data-slate-leaf="true" data-offset-key="17165:0" data-first-offset="true"><span data-slate-string="true"> 函数，向</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17166"><span data-slate-object="text" data-key="17167"><span data-slate-leaf="true" data-offset-key="17167:0" data-first-offset="true"><span data-slate-string="true"> recordsChan</span></span></span></span><span data-slate-object="text" data-key="17168"><span data-slate-leaf="true" data-offset-key="17168:0" data-first-offset="true"><span data-slate-string="true"> 中写入 AnalyticsRecord 类型的数据：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17169"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17170"><span data-slate-object="text" data-key="17171"><span data-slate-leaf="true" data-offset-key="17171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17172"><span data-slate-leaf="true" data-offset-key="17172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17173"><span data-slate-leaf="true" data-offset-key="17173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(r *Analytics)</span></span></span></span></span><span data-slate-object="text" data-key="17174"><span data-slate-leaf="true" data-offset-key="17174:0" data-first-offset="true"><span data-slate-string="true"> RecordHit(record *AnalyticsRecord) </span></span></span><span data-slate-object="text" data-key="17175"><span data-slate-leaf="true" data-offset-key="17175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="17176"><span data-slate-leaf="true" data-offset-key="17176:0" data-first-offset="true"><span data-slate-string="true"> {                                                         </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17177"><span data-slate-object="text" data-key="17178"><span data-slate-leaf="true" data-offset-key="17178:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17179"><span data-slate-leaf="true" data-offset-key="17179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// check if we should stop sending records 1st                                                                     </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17180"><span data-slate-object="text" data-key="17181"><span data-slate-leaf="true" data-offset-key="17181:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17182"><span data-slate-leaf="true" data-offset-key="17182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="17183"><span data-slate-leaf="true" data-offset-key="17183:0" data-first-offset="true"><span data-slate-string="true"> atomic.LoadUint32(&amp;r.shouldStop) &gt; </span></span></span><span data-slate-object="text" data-key="17184"><span data-slate-leaf="true" data-offset-key="17184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17185"><span data-slate-leaf="true" data-offset-key="17185:0" data-first-offset="true"><span data-slate-string="true"> {                                                                          </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17186"><span data-slate-object="text" data-key="17187"><span data-slate-leaf="true" data-offset-key="17187:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="17188"><span data-slate-leaf="true" data-offset-key="17188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17189"><span data-slate-leaf="true" data-offset-key="17189:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17190"><span data-slate-leaf="true" data-offset-key="17190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17191"><span data-slate-leaf="true" data-offset-key="17191:0" data-first-offset="true"><span data-slate-string="true">                                                                                                     </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17192"><span data-slate-object="text" data-key="17193"><span data-slate-leaf="true" data-offset-key="17193:0" data-first-offset="true"><span data-slate-string="true">    }                                                                                                                  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17194"><span data-slate-object="text" data-key="17195"><span data-slate-leaf="true" data-offset-key="17195:0" data-first-offset="true"><span data-slate-string="true">                                                                                                                       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17196"><span data-slate-object="text" data-key="17197"><span data-slate-leaf="true" data-offset-key="17197:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17198"><span data-slate-leaf="true" data-offset-key="17198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// just send record to channel consumed by pool of workers                                                         </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17199"><span data-slate-object="text" data-key="17200"><span data-slate-leaf="true" data-offset-key="17200:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17201"><span data-slate-leaf="true" data-offset-key="17201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// leave all data crunching and Redis I/O work for pool workers                                                    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17202"><span data-slate-object="text" data-key="17203"><span data-slate-leaf="true" data-offset-key="17203:0" data-first-offset="true"><span data-slate-string="true">    r.recordsChan &lt;- record                                                                                            </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17204"><span data-slate-object="text" data-key="17205"><span data-slate-leaf="true" data-offset-key="17205:0" data-first-offset="true"><span data-slate-string="true">                                                                                                                       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17206"><span data-slate-object="text" data-key="17207"><span data-slate-leaf="true" data-offset-key="17207:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17208"><span data-slate-leaf="true" data-offset-key="17208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="17209"><span data-slate-leaf="true" data-offset-key="17209:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="17210"><span data-slate-leaf="true" data-offset-key="17210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="17211"><span data-slate-leaf="true" data-offset-key="17211:0" data-first-offset="true"><span data-slate-string="true">                                                                                                         </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17212"><span data-slate-object="text" data-key="17213"><span data-slate-leaf="true" data-offset-key="17213:0" data-first-offset="true"><span data-slate-string="true">}   </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17214"><span data-slate-object="text" data-key="17215"><span data-slate-leaf="true" data-offset-key="17215:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 是通过调用 LogGrantedAccessRequest 和 LogRejectedAccessRequest 函数来记录授权日志的。在记录授权日志时，会将授权日志写入 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17216"><span data-slate-object="text" data-key="17217"><span data-slate-leaf="true" data-offset-key="17217:0" data-first-offset="true"><span data-slate-string="true">recordsChan</span></span></span></span><span data-slate-object="text" data-key="17218"><span data-slate-leaf="true" data-offset-key="17218:0" data-first-offset="true"><span data-slate-string="true">  channel 中。</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17219"><span data-slate-object="text" data-key="17220"><span data-slate-leaf="true" data-offset-key="17220:0" data-first-offset="true"><span data-slate-string="true">LogGrantedAccessRequest</span></span></span></a><span data-slate-object="text" data-key="17221"><span data-slate-leaf="true" data-offset-key="17221:0" data-first-offset="true"><span data-slate-string="true"> 函数代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17222"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17223"><span data-slate-object="text" data-key="17224"><span data-slate-leaf="true" data-offset-key="17224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17225"><span data-slate-leaf="true" data-offset-key="17225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17226"><span data-slate-leaf="true" data-offset-key="17226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(auth *Authorization)</span></span></span></span></span><span data-slate-object="text" data-key="17227"><span data-slate-leaf="true" data-offset-key="17227:0" data-first-offset="true"><span data-slate-string="true"> LogGrantedAccessRequest(r *ladon.Request, p ladon.Policies, d ladon.Policies) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17228"><span data-slate-object="text" data-key="17229"><span data-slate-leaf="true" data-offset-key="17229:0" data-first-offset="true"><span data-slate-string="true">    conclusion := fmt.Sprintf(</span></span></span><span data-slate-object="text" data-key="17230"><span data-slate-leaf="true" data-offset-key="17230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"policies %s allow access"</span></span></span></span><span data-slate-object="text" data-key="17231"><span data-slate-leaf="true" data-offset-key="17231:0" data-first-offset="true"><span data-slate-string="true">, joinPoliciesNames(d))                               </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17232"><span data-slate-object="text" data-key="17233"><span data-slate-leaf="true" data-offset-key="17233:0" data-first-offset="true"><span data-slate-string="true">    rstring, pstring, dstring := convertToString(r, p, d)                          </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17234"><span data-slate-object="text" data-key="17235"><span data-slate-leaf="true" data-offset-key="17235:0" data-first-offset="true"><span data-slate-string="true">    record := analytics.AnalyticsRecord{                     </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17236"><span data-slate-object="text" data-key="17237"><span data-slate-leaf="true" data-offset-key="17237:0" data-first-offset="true"><span data-slate-string="true">        TimeStamp:  time.Now().Unix(),                              </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17238"><span data-slate-object="text" data-key="17239"><span data-slate-leaf="true" data-offset-key="17239:0" data-first-offset="true"><span data-slate-string="true">        Username:   r.Context[</span></span></span><span data-slate-object="text" data-key="17240"><span data-slate-leaf="true" data-offset-key="17240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"username"</span></span></span></span><span data-slate-object="text" data-key="17241"><span data-slate-leaf="true" data-offset-key="17241:0" data-first-offset="true"><span data-slate-string="true">].(</span></span></span><span data-slate-object="text" data-key="17242"><span data-slate-leaf="true" data-offset-key="17242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="17243"><span data-slate-leaf="true" data-offset-key="17243:0" data-first-offset="true"><span data-slate-string="true">),                 </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17244"><span data-slate-object="text" data-key="17245"><span data-slate-leaf="true" data-offset-key="17245:0" data-first-offset="true"><span data-slate-string="true">        Effect:     ladon.AllowAccess,                       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17246"><span data-slate-object="text" data-key="17247"><span data-slate-leaf="true" data-offset-key="17247:0" data-first-offset="true"><span data-slate-string="true">        Conclusion: conclusion,                              </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17248"><span data-slate-object="text" data-key="17249"><span data-slate-leaf="true" data-offset-key="17249:0" data-first-offset="true"><span data-slate-string="true">        Request:    rstring,       </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17250"><span data-slate-object="text" data-key="17251"><span data-slate-leaf="true" data-offset-key="17251:0" data-first-offset="true"><span data-slate-string="true">        Policies:   pstring,                                                   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17252"><span data-slate-object="text" data-key="17253"><span data-slate-leaf="true" data-offset-key="17253:0" data-first-offset="true"><span data-slate-string="true">        Deciders:   dstring,                                                   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17254"><span data-slate-object="text" data-key="17255"><span data-slate-leaf="true" data-offset-key="17255:0" data-first-offset="true"><span data-slate-string="true">    }                           </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17256"><span data-slate-object="text" data-key="17257"><span data-slate-leaf="true" data-offset-key="17257:0" data-first-offset="true"><span data-slate-string="true">                           </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17258"><span data-slate-object="text" data-key="17259"><span data-slate-leaf="true" data-offset-key="17259:0" data-first-offset="true"><span data-slate-string="true">    record.SetExpiry(</span></span></span><span data-slate-object="text" data-key="17260"><span data-slate-leaf="true" data-offset-key="17260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17261"><span data-slate-leaf="true" data-offset-key="17261:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17262"><span data-slate-object="text" data-key="17263"><span data-slate-leaf="true" data-offset-key="17263:0" data-first-offset="true"><span data-slate-string="true">    _ = analytics.GetAnalytics().RecordHit(&amp;record)         </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17264"><span data-slate-object="text" data-key="17265"><span data-slate-leaf="true" data-offset-key="17265:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17266"><span data-slate-object="text" data-key="17267"><span data-slate-leaf="true" data-offset-key="17267:0" data-first-offset="true"><span data-slate-string="true">上面的代码，会创建 AnalyticsRecord 类型的结构体变量，并调用 RecordHit 将变量的值写入 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17268"><span data-slate-object="text" data-key="17269"><span data-slate-leaf="true" data-offset-key="17269:0" data-first-offset="true"><span data-slate-string="true">recordsChan</span></span></span></span><span data-slate-object="text" data-key="17270"><span data-slate-leaf="true" data-offset-key="17270:0" data-first-offset="true"><span data-slate-string="true">  channel 中。将授权日志写入 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17271"><span data-slate-object="text" data-key="17272"><span data-slate-leaf="true" data-offset-key="17272:0" data-first-offset="true"><span data-slate-string="true">recordsChan</span></span></span></span><span data-slate-object="text" data-key="17273"><span data-slate-leaf="true" data-offset-key="17273:0" data-first-offset="true"><span data-slate-string="true"> &nbsp; channel 中，而不是直接写入 Redis 中，这可以大大减少写入延时，减少接口的响应延时。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17274"><span data-slate-object="text" data-key="17275"><span data-slate-leaf="true" data-offset-key="17275:0" data-first-offset="true"><span data-slate-string="true">还有一个 worker 进程从 recordsChan 中读取数据，并在数据达到一定阈值之后，批量写入 Redis 中。在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17276"><span data-slate-object="text" data-key="17277"><span data-slate-leaf="true" data-offset-key="17277:0" data-first-offset="true"><span data-slate-string="true">Start</span></span></span></a><span data-slate-object="text" data-key="17278"><span data-slate-leaf="true" data-offset-key="17278:0" data-first-offset="true"><span data-slate-string="true"> 函数中，我们创建了一批 worker，worker 个数可以通过 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17279"><span data-slate-object="text" data-key="17280"><span data-slate-leaf="true" data-offset-key="17280:0" data-first-offset="true"><span data-slate-string="true">--analytics.pool-size</span></span></span></span><span data-slate-object="text" data-key="17281"><span data-slate-leaf="true" data-offset-key="17281:0" data-first-offset="true"><span data-slate-string="true"> 来指定 。Start 函数内容如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17282"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17283"><span data-slate-object="text" data-key="17284"><span data-slate-leaf="true" data-offset-key="17284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="17285"><span data-slate-leaf="true" data-offset-key="17285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="17286"><span data-slate-leaf="true" data-offset-key="17286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(r *Analytics)</span></span></span></span></span><span data-slate-object="text" data-key="17287"><span data-slate-leaf="true" data-offset-key="17287:0" data-first-offset="true"><span data-slate-string="true"> Start() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17288"><span data-slate-object="text" data-key="17289"><span data-slate-leaf="true" data-offset-key="17289:0" data-first-offset="true"><span data-slate-string="true">    analytics = r</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17290"><span data-slate-object="text" data-key="17291"><span data-slate-leaf="true" data-offset-key="17291:0" data-first-offset="true"><span data-slate-string="true">    r.store.Connect()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17292"><span data-slate-object="text" data-key="17293"><span data-slate-leaf="true" data-offset-key="17293:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17294"><span data-slate-object="text" data-key="17295"><span data-slate-leaf="true" data-offset-key="17295:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17296"><span data-slate-leaf="true" data-offset-key="17296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// start worker pool</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17297"><span data-slate-object="text" data-key="17298"><span data-slate-leaf="true" data-offset-key="17298:0" data-first-offset="true"><span data-slate-string="true">    atomic.SwapUint32(&amp;r.shouldStop, </span></span></span><span data-slate-object="text" data-key="17299"><span data-slate-leaf="true" data-offset-key="17299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17300"><span data-slate-leaf="true" data-offset-key="17300:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17301"><span data-slate-object="text" data-key="17302"><span data-slate-leaf="true" data-offset-key="17302:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17303"><span data-slate-leaf="true" data-offset-key="17303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="17304"><span data-slate-leaf="true" data-offset-key="17304:0" data-first-offset="true"><span data-slate-string="true"> i := </span></span></span><span data-slate-object="text" data-key="17305"><span data-slate-leaf="true" data-offset-key="17305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="17306"><span data-slate-leaf="true" data-offset-key="17306:0" data-first-offset="true"><span data-slate-string="true">; i &lt; r.poolSize; i++ {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17307"><span data-slate-object="text" data-key="17308"><span data-slate-leaf="true" data-offset-key="17308:0" data-first-offset="true"><span data-slate-string="true">      r.poolWg.Add(</span></span></span><span data-slate-object="text" data-key="17309"><span data-slate-leaf="true" data-offset-key="17309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="17310"><span data-slate-leaf="true" data-offset-key="17310:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17311"><span data-slate-object="text" data-key="17312"><span data-slate-leaf="true" data-offset-key="17312:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="17313"><span data-slate-leaf="true" data-offset-key="17313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17314"><span data-slate-leaf="true" data-offset-key="17314:0" data-first-offset="true"><span data-slate-string="true"> r.recordWorker()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17315"><span data-slate-object="text" data-key="17316"><span data-slate-leaf="true" data-offset-key="17316:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17317"><span data-slate-object="text" data-key="17318"><span data-slate-leaf="true" data-offset-key="17318:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17319"><span data-slate-object="text" data-key="17320"><span data-slate-leaf="true" data-offset-key="17320:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17321"><span data-slate-leaf="true" data-offset-key="17321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// stop analytics workers</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17322"><span data-slate-object="text" data-key="17323"><span data-slate-leaf="true" data-offset-key="17323:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="17324"><span data-slate-leaf="true" data-offset-key="17324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="17325"><span data-slate-leaf="true" data-offset-key="17325:0" data-first-offset="true"><span data-slate-string="true"> r.Stop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17326"><span data-slate-object="text" data-key="17327"><span data-slate-leaf="true" data-offset-key="17327:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17328"><span data-slate-object="text" data-key="17329"><span data-slate-leaf="true" data-offset-key="17329:0" data-first-offset="true"><span data-slate-string="true">上面的代码通过 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17330"><span data-slate-object="text" data-key="17331"><span data-slate-leaf="true" data-offset-key="17331:0" data-first-offset="true"><span data-slate-string="true">go r.recordWorker()</span></span></span></span><span data-slate-object="text" data-key="17332"><span data-slate-leaf="true" data-offset-key="17332:0" data-first-offset="true"><span data-slate-string="true"> 创建了 由</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17333"><span data-slate-object="text" data-key="17334"><span data-slate-leaf="true" data-offset-key="17334:0" data-first-offset="true"><span data-slate-string="true"> poolSize</span></span></span></span><span data-slate-object="text" data-key="17335"><span data-slate-leaf="true" data-offset-key="17335:0" data-first-offset="true"><span data-slate-string="true"> 指定个数的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17336"><span data-slate-object="text" data-key="17337"><span data-slate-leaf="true" data-offset-key="17337:0" data-first-offset="true"><span data-slate-string="true">recordWorker</span></span></span></a><span data-slate-object="text" data-key="17338"><span data-slate-leaf="true" data-offset-key="17338:0" data-first-offset="true"><span data-slate-string="true">（worker），recordWorker 函数会从 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17339"><span data-slate-object="text" data-key="17340"><span data-slate-leaf="true" data-offset-key="17340:0" data-first-offset="true"><span data-slate-string="true">recordsChan</span></span></span></span><span data-slate-object="text" data-key="17341"><span data-slate-leaf="true" data-offset-key="17341:0" data-first-offset="true"><span data-slate-string="true"> 中读取授权日志并存入 recordsBuffer 中，recordsBuffer 的大小为 workerBufferSize，workerBufferSize 计算公式为：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="17342"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="17343"><span data-slate-object="text" data-key="17344"><span data-slate-leaf="true" data-offset-key="17344:0" data-first-offset="true"><span data-slate-string="true">ps := options.PoolSize</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17345"><span data-slate-object="text" data-key="17346"><span data-slate-leaf="true" data-offset-key="17346:0" data-first-offset="true"><span data-slate-string="true">recordsBufferSize := options.RecordsBufferSize</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="17347"><span data-slate-object="text" data-key="17348"><span data-slate-leaf="true" data-offset-key="17348:0" data-first-offset="true"><span data-slate-string="true">workerBufferSize := recordsBufferSize / </span></span></span><span data-slate-object="text" data-key="17349"><span data-slate-leaf="true" data-offset-key="17349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span><span data-slate-object="text" data-key="17350"><span data-slate-leaf="true" data-offset-key="17350:0" data-first-offset="true"><span data-slate-string="true">(ps)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17351"><span data-slate-object="text" data-key="17352"><span data-slate-leaf="true" data-offset-key="17352:0" data-first-offset="true"><span data-slate-string="true">其中，options.PoolSize 由命令行参数 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17353"><span data-slate-object="text" data-key="17354"><span data-slate-leaf="true" data-offset-key="17354:0" data-first-offset="true"><span data-slate-string="true">--analytics.pool-size</span></span></span></span><span data-slate-object="text" data-key="17355"><span data-slate-leaf="true" data-offset-key="17355:0" data-first-offset="true"><span data-slate-string="true"> 指定，代表 worker 的个数，默认 50；options.RecordsBufferSize 由命令行参数 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17356"><span data-slate-object="text" data-key="17357"><span data-slate-leaf="true" data-offset-key="17357:0" data-first-offset="true"><span data-slate-string="true">--analytics.records-buffer-size</span></span></span></span><span data-slate-object="text" data-key="17358"><span data-slate-leaf="true" data-offset-key="17358:0" data-first-offset="true"><span data-slate-string="true"> 指定，代表缓存的授权日志消息数。也就是说，我们把缓存的记录平均分配给所有的 worker。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17359"><span data-slate-object="text" data-key="17360"><span data-slate-leaf="true" data-offset-key="17360:0" data-first-offset="true"><span data-slate-string="true">当 recordsBuffer 存满或者达到投递最大时间后，调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17361"><span data-slate-object="text" data-key="17362"><span data-slate-leaf="true" data-offset-key="17362:0" data-first-offset="true"><span data-slate-string="true">r.Store.AppendToSetPipelined(analyticsKeyName, recordsBuffer)</span></span></span></span><span data-slate-object="text" data-key="17363"><span data-slate-leaf="true" data-offset-key="17363:0" data-first-offset="true"><span data-slate-string="true"> 将记录批量发送给 Redis，为了提高传输速率，这里将日志内容编码为 msgpack 格式后再传输。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17364"><span data-slate-object="text" data-key="17365"><span data-slate-leaf="true" data-offset-key="17365:0" data-first-offset="true"><span data-slate-string="true">上面的缓存方法可以抽象成一个缓存模型，满足实际开发中的大部分需要异步转存的场景，如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17366"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/47/95/479fyy2cd16a6c1fa5f6074f7ce6fe95.jpg?wh=2248x668"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17367"><span data-slate-object="text" data-key="17368"><span data-slate-leaf="true" data-offset-key="17368:0" data-first-offset="true"><span data-slate-string="true">Producer 将数据投递到带缓冲的 channel 中，后端有多个 worker 消费 channel 中的数据，并进行批量投递。你可以设置批量投递的条件，一般至少包含</span></span></span><span data-slate-object="text" data-key="17369"><span data-slate-leaf="true" data-offset-key="17369:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最大投递日志数</span></span></span></span><span data-slate-object="text" data-key="17370"><span data-slate-leaf="true" data-offset-key="17370:0" data-first-offset="true"><span data-slate-string="true">和</span></span></span><span data-slate-object="text" data-key="17371"><span data-slate-leaf="true" data-offset-key="17371:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">最大投递时间间隔</span></span></span></span><span data-slate-object="text" data-key="17372"><span data-slate-leaf="true" data-offset-key="17372:0" data-first-offset="true"><span data-slate-string="true">这两个。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17373"><span data-slate-object="text" data-key="17374"><span data-slate-leaf="true" data-offset-key="17374:0" data-first-offset="true"><span data-slate-string="true">通过以上缓冲模型，你可以将日志转存的时延降到最低。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="17375" id="sr-toc-12"><span data-slate-object="text" data-key="17376"><span data-slate-leaf="true" data-offset-key="17376:0" data-first-offset="true"><span data-slate-string="true">数据一致性</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="17377"><span data-slate-object="text" data-key="17378"><span data-slate-leaf="true" data-offset-key="17378:0" data-first-offset="true"><span data-slate-string="true">上面介绍了 iam-authz-server 的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17379"><span data-slate-object="text" data-key="17380"><span data-slate-leaf="true" data-offset-key="17380:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="17381"><span data-slate-leaf="true" data-offset-key="17381:0" data-first-offset="true"><span data-slate-string="true"> 接口，为了最大化地提高性能，采用了大量的缓存设计。因为数据会分别在持久化存储和内存中都存储一份，就可能会出现数据不一致的情况。所以，我们也要确保缓存中的数据和数据库中的数据是一致的。数据一致性架构如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="17382"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/72/a4/72c2afe63d197e7335deec1ac9f550a4.jpg?wh=2248x1006"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17383"><span data-slate-object="text" data-key="17384"><span data-slate-leaf="true" data-offset-key="17384:0" data-first-offset="true"><span data-slate-string="true">密钥和策略同步流程如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="17385"><div data-slate-type="list-line" data-slate-object="block" data-key="17386"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="17387"><span data-slate-leaf="true" data-offset-key="17387:0" data-first-offset="true"><span data-slate-string="true">通过 iam-webconsole 请求 iam-apiserver 创建（或更新、删除）密钥（或策略）。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="17388"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="17389"><span data-slate-leaf="true" data-offset-key="17389:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 收到 “写” 请求后，会向 Redis  </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17390"><span data-slate-object="text" data-key="17391"><span data-slate-leaf="true" data-offset-key="17391:0" data-first-offset="true"><span data-slate-string="true">iam.cluster.notifications</span></span></span></span><span data-slate-object="text" data-key="17392"><span data-slate-leaf="true" data-offset-key="17392:0" data-first-offset="true"><span data-slate-string="true"> channel 发送 PolicyChanged 或 SecretChanged 消息。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="17393"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="17394"><span data-slate-leaf="true" data-offset-key="17394:0" data-first-offset="true"><span data-slate-string="true">Loader 收到消息后，会触发 cache loader 实例执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17395"><span data-slate-object="text" data-key="17396"><span data-slate-leaf="true" data-offset-key="17396:0" data-first-offset="true"><span data-slate-string="true">Reload</span></span></span></span><span data-slate-object="text" data-key="17397"><span data-slate-leaf="true" data-offset-key="17397:0" data-first-offset="true"><span data-slate-string="true"> 方法，重新从 iam-apiserver 中同步密钥和策略信息。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17398"><span data-slate-object="text" data-key="17399"><span data-slate-leaf="true" data-offset-key="17399:0" data-first-offset="true"><span data-slate-string="true">Loader 不会关心 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17400"><span data-slate-object="text" data-key="17401"><span data-slate-leaf="true" data-offset-key="17401:0" data-first-offset="true"><span data-slate-string="true">Reload</span></span></span></span><span data-slate-object="text" data-key="17402"><span data-slate-leaf="true" data-offset-key="17402:0" data-first-offset="true"><span data-slate-string="true"> 方法的具体实现，只会在收到指定消息时，执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17403"><span data-slate-object="text" data-key="17404"><span data-slate-leaf="true" data-offset-key="17404:0" data-first-offset="true"><span data-slate-string="true">Reload</span></span></span></span><span data-slate-object="text" data-key="17405"><span data-slate-leaf="true" data-offset-key="17405:0" data-first-offset="true"><span data-slate-string="true"> 方法。通过这种方式，我们可以实现不同的缓存策略。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17406"><span data-slate-object="text" data-key="17407"><span data-slate-leaf="true" data-offset-key="17407:0" data-first-offset="true"><span data-slate-string="true">在 cache 实例的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17408"><span data-slate-object="text" data-key="17409"><span data-slate-leaf="true" data-offset-key="17409:0" data-first-offset="true"><span data-slate-string="true">Reload</span></span></span></span><span data-slate-object="text" data-key="17410"><span data-slate-leaf="true" data-offset-key="17410:0" data-first-offset="true"><span data-slate-string="true"> 方法中，我们其实是调用仓库层 Secret 和 Policy 的 List 方法来获取密钥和策略列表。仓库层又是通过执行 gRPC 请求，从 iam-apiserver 中获取密钥和策略列表。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17411"><span data-slate-object="text" data-key="17412"><span data-slate-leaf="true" data-offset-key="17412:0" data-first-offset="true"><span data-slate-string="true">cache 的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17413"><span data-slate-object="text" data-key="17414"><span data-slate-leaf="true" data-offset-key="17414:0" data-first-offset="true"><span data-slate-string="true">Reload</span></span></span></a><span data-slate-object="text" data-key="17415"><span data-slate-leaf="true" data-offset-key="17415:0" data-first-offset="true"><span data-slate-string="true"> 方法，会将获取到的密钥和策略列表缓存在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17416"><span data-slate-object="text" data-key="17417"><span data-slate-leaf="true" data-offset-key="17417:0" data-first-offset="true"><span data-slate-string="true">ristretto</span></span></span></a><span data-slate-object="text" data-key="17418"><span data-slate-leaf="true" data-offset-key="17418:0" data-first-offset="true"><span data-slate-string="true"> 类型的 Cache 中，供业务层调用。业务层代码位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17419"><span data-slate-object="text" data-key="17420"><span data-slate-leaf="true" data-offset-key="17420:0" data-first-offset="true"><span data-slate-string="true">internal/authzserver/authorization</span></span></span></a><span data-slate-object="text" data-key="17421"><span data-slate-leaf="true" data-offset-key="17421:0" data-first-offset="true"><span data-slate-string="true"> 目录下。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17422" id="sr-toc-13"><span data-slate-object="text" data-key="17423"><span data-slate-leaf="true" data-offset-key="17423:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="17424"><span data-slate-object="text" data-key="17425"><span data-slate-leaf="true" data-offset-key="17425:0" data-first-offset="true"><span data-slate-string="true">这一讲中，我介绍了 IAM 数据流服务 iam-authz-server 的设计和实现。iam-authz-server 提供了 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17426"><span data-slate-object="text" data-key="17427"><span data-slate-leaf="true" data-offset-key="17427:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="17428"><span data-slate-leaf="true" data-offset-key="17428:0" data-first-offset="true"><span data-slate-string="true"> RESTful API 接口，供第三方用户完成资源授权功能，具体是使用 Ladon 包来完成资源授权的。Ladon 包解决了 “在特定的条件下，谁能够 / 不能够对哪些资源做哪些操作” 的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17429"><span data-slate-object="text" data-key="17430"><span data-slate-leaf="true" data-offset-key="17430:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 的配置处理、启动流程和请求处理流程跟 iam-apiserver 保持一致。此外，iam-authz-server 也实现了简洁架构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17431"><span data-slate-object="text" data-key="17432"><span data-slate-leaf="true" data-offset-key="17432:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 通过缓存密钥和策略信息、缓存授权日志来提高 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="17433"><span data-slate-object="text" data-key="17434"><span data-slate-leaf="true" data-offset-key="17434:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="17435"><span data-slate-leaf="true" data-offset-key="17435:0" data-first-offset="true"><span data-slate-string="true"> 接口的性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17436"><span data-slate-object="text" data-key="17437"><span data-slate-leaf="true" data-offset-key="17437:0" data-first-offset="true"><span data-slate-string="true">在缓存密钥和策略信息时，为了和 iam-apiserver 中的密钥和策略信息保持一致，使用了 Redis Pub/Sub 机制。当 iam-apiserver 有密钥 / 策略变更时，会往指定的 Redis channel Pub 一条消息。iam-authz-server 订阅相同的 channel，在收到新消息时，会解析消息，并重新从 iam-apiserver 中获取密钥和策略信息，缓存在内存中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17438"><span data-slate-object="text" data-key="17439"><span data-slate-leaf="true" data-offset-key="17439:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 执行完资源授权之后，会将授权日志存放在一个带缓冲的 channel 中。后端有多个 worker 消费 channel 中的数据，并进行批量投递。可以设置批量投递的条件，例如最大投递日志数和最大投递时间间隔。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="17440" id="sr-toc-14"><span data-slate-object="text" data-key="17441"><span data-slate-leaf="true" data-offset-key="17441:0" data-first-offset="true"><span data-slate-string="true">课后练习</span></span></span></h2><div data-slate-type="list" data-slate-object="block" data-key="17442"><div data-slate-type="list-line" data-slate-object="block" data-key="17443"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="17444"><span data-slate-leaf="true" data-offset-key="17444:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 和 iam-apiserver 共用了应用框架（包括一些配置项）和 HTTP 服务框架层的代码，请阅读 iam-authz-server 代码，看下 IAM 项目是如何实现代码复用的。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="17445"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="17446"><span data-slate-leaf="true" data-offset-key="17446:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 使用了 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="17447"><span data-slate-object="text" data-key="17448"><span data-slate-leaf="true" data-offset-key="17448:0" data-first-offset="true"><span data-slate-string="true">ristretto</span></span></span></a><span data-slate-object="text" data-key="17449"><span data-slate-leaf="true" data-offset-key="17449:0" data-first-offset="true"><span data-slate-string="true"> 来缓存密钥和策略信息，请调研下业界还有哪些优秀的缓存包可供使用，欢迎在留言区分享。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="17450"><span data-slate-object="text" data-key="17451"><span data-slate-leaf="true" data-offset-key="17451:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区与我交流讨论，我们下一讲见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-15">精选留言 (12)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/64/53/c93b8110.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>daz2yy</span></div></div><div>老师，请问下，数据流和控制流这个怎么来理解呢，是从什么角度来定义的服务类型的？</div><div><p>作者回复：数据流承载核心业务功能。

控制流一般用来创建一些资源，供数据流使用。这些，资源一旦建成，控制流可以一直使用。所以这时候控制流挂了，资源还是存在的，数据流仍然能够正常运转，也就是不影响业务功能。</p></div><div><div>2021-08-06</div><div><div><i></i></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKhuGLVRYZibOTfMumk53Wn8Q0Rkg0o6DzTicbibCq42lWQoZ8lFeQvicaXuZa7dYsr9URMrtpXMVDDww/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>hello</span></div></div><div>老师，咨询您一个问题，使用 GiN 做 WEB 服务，微服务间通过 gRPC 通讯，如何选择配置注册中心，老师能否推荐几款比较流行开源的配置注册中心。</div><div><p>作者回复：网关可以使用，tyk：https://github.com/TykTechnologies/tyk。

tyk 后端开源，前端闭源。你可以自己开发一套前端。

配置中心可以试试：https://github.com/apache/servicecomb-service-center

servicecomb-service-center 是华为开源的注册中心，基于 etcd 封装。该注册中心可以无缝对接华为开源的微服务框架 go-chassis</p></div><div><div>2021-08-05</div><div><div><i></i><span>2</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/60/a1/8f003697.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 静心</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/8a/95/8ac15yy848f71919ef784a1c9065e495.png"></div></span></div></div><div>本地 channel 缓冲和 redis 缓存对于性能的提高效果会很明显，设计的比较好。但同时，这样的设计会导致多存储数据同步的问题。比如，如果服务突然宕机，本地缓冲中的数据就可能丢失。不知道老师有没有什么好的办法解决？</div><div><p>作者回复：这个地方最好的办法，就是做好优雅关停。

关停时获取终止信号，等待任务完成，并之后后续的清理，最后结束进程。

服务器宕机，任何高可用系统，都会存在多多少少的数据丢失。能做的是设计好时间窗口，确保服务器压力、性能都在可接受范围的情况下，及时提交、保存数据。</p></div><div><div>2021-10-29</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>yandongxiao</span></div></div><div>总结：
iam-authz-server 在数据流上工作，负责授权工作，对性能要求高。
authz 也需要对请求进行认证工作，authz 的认证采用 cache 方式实现 jwt token 认证，即密钥已经缓存在内存中，通过同样的加密方案，确认 token 的合法性。
authz 的认证工作主要交给了 landon 来完成。iam-apiserver 存储的授权策略符合 landon 的语法规范，iam-authz-server 接收的授权请求，也符合 landon 的语法规范。landon 通过接口的方式，暴露了 manager、auditLogger、metric 等相关的接口。比如，我们需要为 landon 提供用户的 policy 列表，是否允许授权，由 landon 来做决策。
缓存设计</div><div><p>作者回复: 6666</p></div><div><div>2021-12-04</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Sch0ng</span></div></div><div>详细介绍了 iam-authz-server 的设计与实现。
需要结合代码和跑起来的程序反复揣摩。</div><div><div>2021-08-16</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJKObzsYVibibyibmTVKBmoGPqS0WQC16EY4p1agGDCpv5okKpjzicLtHafBVa7TCwh9HaRxTx9qQ1Qkg/132"></div></div><div><div><div><span> 陈先生</span></div></div><div>如果 iam-authz-server 挂了，是不是有 audit log 丢失的可能性？</div><div><p>作者回复：服务挂了，audit log 是有丢失的可能，这个无法避免。只能尽可能规避</p></div><div><div>2021-10-07</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>helloworld</span></div></div><div>在实际应用中，请求 /v1/authz 接口的参数体是网关根据用户实际请求的某个具体业务的 api 的参数、请求方法、path 等，并根据提前定制的规则自动构造出来的吧，这样理解对吗</div><div><p>作者回复：是请求者自己指定的</p></div><div><div>2021-08-16</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/96/82/8ac1e909.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Jarvis</span></div></div><div>更新缓存时每次都 List 全部密钥 / 策略，数据量会不会太大了？ Pub 时带上变化的策略 / 密钥 id, 只更新该 id  的内容是不是好一点？</div><div><div>2022-06-28</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/c9/5e/b79e6d5d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>꧁子华宝宝萌萌哒꧂</span></div></div><div>preparedAuthzServer.Run 为啥需要一个 stopChan 来阻塞不让退出？

按我的理解这个 stopChan 没有写，这个进程永远就退不了， 

直接 return s.genericAPIServer.Run () 不可以吗？</div><div><div>2022-06-27</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/1e/4c/10174727.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>xinHAOr</span></div></div><div>func (r *Analytics) Start () 里面为什么同步执行了 Stop？刚启动完就停止了吗</div><div><p>作者回复：这里是一个 bug，master 分支已经更新了。教程这里后边会找编辑更新。

感谢反馈</p></div><div><div>2022-04-16</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/7orjLiard5WYicG0WaRjk01ycCDtAZadtf2sWzg0c7vXl7oqIwic0QvzlE3lr3fgMZibqXSwAibV4Qu0YSeeMlibUMSg/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_226b1b</span></div></div><div>老师，请问为什么用 Ristretto 缓存数据，不直接用 Redis 缓存数据呢？在用 Redis 缓存的基础上，讲一下 MySQL 与 Redis 的数据一致性相关的缓存读写策略会不会更好一点？把所有数据都简单缓存到一个缓存包 / Redis 里，没有淘汰机制是不是不太好？</div><div><p>作者回复: ristretto 是本地缓存，没用 redis 原因是：
1. policy、secret 缓存没必要持久化
2. 减少依赖 redis
3. 提高性能</p></div><div><div>2022-03-16</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/f0/eb/24a8be29.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>RunDouble</span></div></div><div>太强调授权相关的东西，并不是很好的 demo。</div><div><p>作者回复：这里主要是通过一个授权系统来展示如何开发 Go 项目。所以，里面业务部分大部分是跟授权相关的。</p></div><div><div>2022-02-27</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".v"><outline class="toc-level-h1" data-reactid=".v.0" style="width: 175px;"><active data-reactid=".v.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".v.0.1"><span data-reactid=".v.0.1.0"> 31 | 数据流：通过 iam-authz-server 设计，看数据流服务的设计</span></a></outline><outline class="toc-level-h2" data-reactid=".v.1" style="width: 165px;"><active data-reactid=".v.1.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".v.1.1"><span data-reactid=".v.1.1.0">iam-authz-server 的功能介绍</span></a></outline><outline class="toc-level-h3" data-reactid=".v.2" style="width: 155px;"><active data-reactid=".v.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".v.2.1"><span data-reactid=".v.2.1.0">github.com/ory/ladon 包介绍</span></a></outline><outline class="toc-level-h3" data-reactid=".v.3" style="width: 155px;"><active data-reactid=".v.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".v.3.1"><span data-reactid=".v.3.1.0">iam-authz-server 使用方法介绍</span></a></outline><outline class="toc-level-h2" data-reactid=".v.4" style="width: 165px;"><active data-reactid=".v.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".v.4.1"><span data-reactid=".v.4.1.0">iam-authz-server 的代码实现</span></a></outline><outline class="toc-level-h3" data-reactid=".v.5" style="width: 155px;"><active data-reactid=".v.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".v.5.1"><span data-reactid=".v.5.1.0">iam-authz-server 的配置处理</span></a></outline><outline class="toc-level-h3" data-reactid=".v.6" style="width: 155px;"><active data-reactid=".v.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".v.6.1"><span data-reactid=".v.6.1.0">iam-authz-server 启动流程设计</span></a></outline><outline class="toc-level-h3" data-reactid=".v.7" style="width: 155px;"><active data-reactid=".v.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".v.7.1"><span data-reactid=".v.7.1.0">iam-authz-server 的 RESTful API 请求处理流程</span></a></outline><outline class="toc-level-h3" data-reactid=".v.8" style="width: 155px;"><active data-reactid=".v.8.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".v.8.1"><span data-reactid=".v.8.1.0">iam-authz-server 的代码架构</span></a></outline><outline class="toc-level-h2" data-reactid=".v.9" style="width: 165px;"><active data-reactid=".v.9.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".v.9.1"><span data-reactid=".v.9.1.0">iam-authz-server 关键代码分析</span></a></outline><outline class="toc-level-h3" data-reactid=".v.a" style="width: 155px;"><active data-reactid=".v.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".v.a.1"><span data-reactid=".v.a.1.0">资源授权</span></a></outline><outline class="toc-level-h3" data-reactid=".v.b" style="width: 155px;"><active data-reactid=".v.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".v.b.1"><span data-reactid=".v.b.1.0">缓存设计</span></a></outline><outline class="toc-level-h3" data-reactid=".v.c" style="width: 155px;"><active data-reactid=".v.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".v.c.1"><span data-reactid=".v.c.1.0">数据一致性</span></a></outline><outline class="toc-level-h2" data-reactid=".v.d" style="width: 165px;"><active data-reactid=".v.d.0"></active><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".v.d.1"><span data-reactid=".v.d.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".v.e" style="width: 165px;"><active data-reactid=".v.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".v.e.1"><span data-reactid=".v.e.1.0">课后练习</span></a></outline><outline class="toc-level-h2" data-reactid=".v.f" style="width: 165px;"><active data-reactid=".v.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".v.f.1"><span data-reactid=".v.f.1.0">精选留言 (12)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/404542" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>