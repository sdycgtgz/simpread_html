
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 29 | 部门建立：如何在内核中注册设备？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>29 | 部门建立：如何在内核中注册设备？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我会带你实现分配和释放内存页面，达到内存管理的目的。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">29 | 部门建立：如何在内核中注册设备？</h1><div><span>LMOS</span> <span>2021-07-14</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/cf/fa/cfb09d6f62ba8eede93e2d3232a1d6fa.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：12.18M</span><span> 时长：13:20</span></div></div><audio title="29 | 部门建立：如何在内核中注册设备？" src="https://res001.geekbang.org/media/audio/65/b6/65e042af82481f94yy032f1108b965b6/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="18503" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="18504"><span data-slate-object="text" data-key="18505"><span data-slate-leaf="true" data-offset-key="18505:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18506"><span data-slate-object="text" data-key="18507"><span data-slate-leaf="true" data-offset-key="18507:0" data-first-offset="true"><span data-slate-string="true">在上节课里，我们对设备进行了分类，建立了设备与驱动的数据结构，同时也规定了一个驱动程序应该提供哪些标准操作方法，供操作系统内核调用。这相当于设计了行政部门的规章制度，一个部门叫什么，应该干什么，这些就确定好了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18508"><span data-slate-object="text" data-key="18509"><span data-slate-leaf="true" data-offset-key="18509:0" data-first-offset="true"><span data-slate-string="true">今天我们来继续探索部门的建立，也就是设备在内核中是如何注册的。我们先从全局了解一下设备的注册流程，然后了解怎么加载驱动，最后探索怎么让驱动建立一个设备，并在内核中注册。让我们正式开始今天的学习吧！</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18510"><span data-slate-object="text" data-key="18511"><span data-slate-leaf="true" data-offset-key="18511:0" data-first-offset="true"><span data-slate-string="true">这节课配套代码，你可以从</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18512"><span data-slate-object="text" data-key="18513"><span data-slate-leaf="true" data-offset-key="18513:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="18514"><span data-slate-leaf="true" data-offset-key="18514:0" data-first-offset="true"><span data-slate-string="true">下载。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18515" id="sr-toc-1"><span data-slate-object="text" data-key="18516"><span data-slate-leaf="true" data-offset-key="18516:0" data-first-offset="true"><span data-slate-string="true">设备的注册流程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18517"><span data-slate-object="text" data-key="18518"><span data-slate-leaf="true" data-offset-key="18518:0" data-first-offset="true"><span data-slate-string="true">你是否想象过，你在电脑上插入一个 USB 鼠标时，操作系统会作出怎样的反应呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18519"><span data-slate-object="text" data-key="18520"><span data-slate-leaf="true" data-offset-key="18520:0" data-first-offset="true"><span data-slate-string="true">我来简单作个描述，</span></span></span><span data-slate-object="text" data-key="18521"><span data-slate-leaf="true" data-offset-key="18521:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这个过程可以分成这样五步。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18522"><span data-slate-object="text" data-key="18523"><span data-slate-leaf="true" data-offset-key="18523:0" data-first-offset="true"><span data-slate-string="true">1. 操作系统会收到一个中断。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18524"><span data-slate-object="text" data-key="18525"><span data-slate-leaf="true" data-offset-key="18525:0" data-first-offset="true"><span data-slate-string="true">2.USB 总线驱动的中断处理程序会执行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18526"><span data-slate-object="text" data-key="18527"><span data-slate-leaf="true" data-offset-key="18527:0" data-first-offset="true"><span data-slate-string="true">3. 调用操作系统内核相关的服务，查找 USB 鼠标对应的驱动程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18528"><span data-slate-object="text" data-key="18529"><span data-slate-leaf="true" data-offset-key="18529:0" data-first-offset="true"><span data-slate-string="true">4. 操作系统加载驱动程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18530"><span data-slate-object="text" data-key="18531"><span data-slate-leaf="true" data-offset-key="18531:0" data-first-offset="true"><span data-slate-string="true">5. 驱动程序开始执行，向操作系统内核注册一个鼠标设备。这就是一般操作系统加载驱动的粗略过程。对于安装在主板上的设备，操作系统会枚举设备信息，然后加载驱动程序，让驱动程序创建并注册相应的设备。当然，你还可以手动加载驱动程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18532"><span data-slate-object="text" data-key="18533"><span data-slate-leaf="true" data-offset-key="18533:0" data-first-offset="true"><span data-slate-string="true">为了简单起见，我们的 Cosmos 不会这样复杂，暂时也不支持设备热拨插功能。我们让 Cosmos 自动加载驱动，在驱动中向 Cosmos 注册相应的设备，这样就可以大大降低问题的复杂度，我们先从简单的做起嘛，相信你明白了原理之后，还可以自行迭代。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18534"><span data-slate-object="text" data-key="18535"><span data-slate-leaf="true" data-offset-key="18535:0" data-first-offset="true"><span data-slate-string="true">为了让你更清楚地了解这个过程，我为你画了一幅图，如下所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="18536"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/eb/9f/ebd6fc28f859c09891cd7dc0a4f0c49f.jpg?wh=3287x4605"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18537"><span data-slate-object="text" data-key="18538"><span data-slate-leaf="true" data-offset-key="18538:0" data-first-offset="true"><span data-slate-string="true">上图中，完整展示了 Cosmos 自动加载驱动的整个流程，Cosmos 在初始化驱动时会扫描整个驱动表，然后加载表中每个驱动，分别调用各个驱动的入口函数，最后在驱动中建立设备并向内核注册。接下来，我们分别讨论这些流程的实现。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18539" id="sr-toc-2"><span data-slate-object="text" data-key="18540"><span data-slate-leaf="true" data-offset-key="18540:0" data-first-offset="true"><span data-slate-string="true">驱动程序表</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18541"><span data-slate-object="text" data-key="18542"><span data-slate-leaf="true" data-offset-key="18542:0" data-first-offset="true"><span data-slate-string="true">为了简化问题，便于你理解，我们把驱动程序和内核链接到一起，省略了加载驱动程序的过程，因为加载程序不仅仅是把驱动程序放在内存中就可以了，还要进行程序链接相关的操作，这个操作极其复杂，我们先不在这里研究，感兴趣的话你可以自行拓展。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18543"><span data-slate-object="text" data-key="18544"><span data-slate-leaf="true" data-offset-key="18544:0" data-first-offset="true"><span data-slate-string="true">既然我们把内核和驱动程序链接在了一起，就需要有个机制让内核知道驱动程序的存在。这个机制就是驱动程序表，它可以这样设计。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="18545"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18546"><span data-slate-object="text" data-key="18547"><span data-slate-leaf="true" data-offset-key="18547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cosmos/kernel/krlglobal.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18548"><span data-slate-object="text" data-key="18549"><span data-slate-leaf="true" data-offset-key="18549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KRL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="18550"><span data-slate-leaf="true" data-offset-key="18550:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18551"><span data-slate-leaf="true" data-offset-key="18551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drventyexit_t</span></span></span></span><span data-slate-object="text" data-key="18552"><span data-slate-leaf="true" data-offset-key="18552:0" data-first-offset="true"><span data-slate-string="true">,osdrvetytabl)[]={</span></span></span><span data-slate-object="text" data-key="18553"><span data-slate-leaf="true" data-offset-key="18553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="18554"><span data-slate-leaf="true" data-offset-key="18554:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18555"><span data-slate-object="text" data-key="18556"><span data-slate-leaf="true" data-offset-key="18556:0" data-first-offset="true"><span data-slate-string="true">drventyexit_t 类型，在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="18557"><span data-slate-object="text" data-key="18558"><span data-slate-leaf="true" data-offset-key="18558:0" data-first-offset="true"><span data-slate-string="true">上一课</span></span></span></a><span data-slate-object="text" data-key="18559"><span data-slate-leaf="true" data-offset-key="18559:0" data-first-offset="true"><span data-slate-string="true">中，我们已经了解过了。它就是一个函数指针类型，这里就是定义了一个函数指针数组，而这个函数指针数组中放的就是驱动程序的入口函数，而内核只需要扫描这个函数指针数组，就可以调用到每个驱动程序了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18560"><span data-slate-object="text" data-key="18561"><span data-slate-leaf="true" data-offset-key="18561:0" data-first-offset="true"><span data-slate-string="true">有了这个函数指针数组，接着我们还需要写好这个驱动程序的初始化函数，代码如下。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="18562"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18563"><span data-slate-object="text" data-key="18564"><span data-slate-leaf="true" data-offset-key="18564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="18565"><span data-slate-leaf="true" data-offset-key="18565:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18566"><span data-slate-leaf="true" data-offset-key="18566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krldriver</span></span></span></span><span data-slate-object="text" data-key="18567"><span data-slate-leaf="true" data-offset-key="18567:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18568"><span data-slate-leaf="true" data-offset-key="18568:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18569"><span data-slate-object="text" data-key="18570"><span data-slate-leaf="true" data-offset-key="18570:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18571"><span data-slate-object="text" data-key="18572"><span data-slate-leaf="true" data-offset-key="18572:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18573"><span data-slate-leaf="true" data-offset-key="18573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历驱动程序表中的每个驱动程序入口函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18574"><span data-slate-object="text" data-key="18575"><span data-slate-leaf="true" data-offset-key="18575:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18576"><span data-slate-leaf="true" data-offset-key="18576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="18577"><span data-slate-leaf="true" data-offset-key="18577:0" data-first-offset="true"><span data-slate-string="true"> (uint_t ei = </span></span></span><span data-slate-object="text" data-key="18578"><span data-slate-leaf="true" data-offset-key="18578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18579"><span data-slate-leaf="true" data-offset-key="18579:0" data-first-offset="true"><span data-slate-string="true">; osdrvetytabl[ei] != </span></span></span><span data-slate-object="text" data-key="18580"><span data-slate-leaf="true" data-offset-key="18580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="18581"><span data-slate-leaf="true" data-offset-key="18581:0" data-first-offset="true"><span data-slate-string="true">; ei++)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18582"><span data-slate-object="text" data-key="18583"><span data-slate-leaf="true" data-offset-key="18583:0" data-first-offset="true"><span data-slate-string="true">    {    </span></span></span><span data-slate-object="text" data-key="18584"><span data-slate-leaf="true" data-offset-key="18584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 运行一个驱动程序入口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18585"><span data-slate-object="text" data-key="18586"><span data-slate-leaf="true" data-offset-key="18586:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18587"><span data-slate-leaf="true" data-offset-key="18587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18588"><span data-slate-leaf="true" data-offset-key="18588:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="18589"><span data-slate-leaf="true" data-offset-key="18589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlrun_driverentry</span></span></span></span><span data-slate-object="text" data-key="18590"><span data-slate-leaf="true" data-offset-key="18590:0" data-first-offset="true"><span data-slate-string="true">(osdrvetytabl[ei]) == </span></span></span><span data-slate-object="text" data-key="18591"><span data-slate-leaf="true" data-offset-key="18591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">DFCERRSTUS</span></span></span></span><span data-slate-object="text" data-key="18592"><span data-slate-leaf="true" data-offset-key="18592:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18593"><span data-slate-object="text" data-key="18594"><span data-slate-leaf="true" data-offset-key="18594:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18595"><span data-slate-object="text" data-key="18596"><span data-slate-leaf="true" data-offset-key="18596:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18597"><span data-slate-leaf="true" data-offset-key="18597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_sysdie</span></span></span></span><span data-slate-object="text" data-key="18598"><span data-slate-leaf="true" data-offset-key="18598:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18599"><span data-slate-leaf="true" data-offset-key="18599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"init driver err"</span></span></span></span><span data-slate-object="text" data-key="18600"><span data-slate-leaf="true" data-offset-key="18600:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18601"><span data-slate-object="text" data-key="18602"><span data-slate-leaf="true" data-offset-key="18602:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18603"><span data-slate-object="text" data-key="18604"><span data-slate-leaf="true" data-offset-key="18604:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18605"><span data-slate-object="text" data-key="18606"><span data-slate-leaf="true" data-offset-key="18606:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18607"><span data-slate-leaf="true" data-offset-key="18607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18608"><span data-slate-leaf="true" data-offset-key="18608:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18609"><span data-slate-object="text" data-key="18610"><span data-slate-leaf="true" data-offset-key="18610:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18611"><span data-slate-object="text" data-key="18612"><span data-slate-leaf="true" data-offset-key="18612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="18613"><span data-slate-leaf="true" data-offset-key="18613:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="18614"><span data-slate-leaf="true" data-offset-key="18614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krl</span></span></span></span><span data-slate-object="text" data-key="18615"><span data-slate-leaf="true" data-offset-key="18615:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18616"><span data-slate-leaf="true" data-offset-key="18616:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18617"><span data-slate-object="text" data-key="18618"><span data-slate-leaf="true" data-offset-key="18618:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18619"><span data-slate-object="text" data-key="18620"><span data-slate-leaf="true" data-offset-key="18620:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18621"><span data-slate-leaf="true" data-offset-key="18621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlmm</span></span></span></span><span data-slate-object="text" data-key="18622"><span data-slate-leaf="true" data-offset-key="18622:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18623"><span data-slate-object="text" data-key="18624"><span data-slate-leaf="true" data-offset-key="18624:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18625"><span data-slate-leaf="true" data-offset-key="18625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krldevice</span></span></span></span><span data-slate-object="text" data-key="18626"><span data-slate-leaf="true" data-offset-key="18626:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18627"><span data-slate-object="text" data-key="18628"><span data-slate-leaf="true" data-offset-key="18628:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18629"><span data-slate-leaf="true" data-offset-key="18629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krldriver</span></span></span></span><span data-slate-object="text" data-key="18630"><span data-slate-leaf="true" data-offset-key="18630:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18631"><span data-slate-object="text" data-key="18632"><span data-slate-leaf="true" data-offset-key="18632:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18633"><span data-slate-leaf="true" data-offset-key="18633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//……</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18634"><span data-slate-object="text" data-key="18635"><span data-slate-leaf="true" data-offset-key="18635:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18636"><span data-slate-leaf="true" data-offset-key="18636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18637"><span data-slate-leaf="true" data-offset-key="18637:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18638"><span data-slate-object="text" data-key="18639"><span data-slate-leaf="true" data-offset-key="18639:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18640"><span data-slate-object="text" data-key="18641"><span data-slate-leaf="true" data-offset-key="18641:0" data-first-offset="true"><span data-slate-string="true">像上面代码这样，我们的初始化驱动的代码就写好了。init_krldriver 函数主要的工作就是</span></span></span><span data-slate-object="text" data-key="18642"><span data-slate-leaf="true" data-offset-key="18642:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">遍历驱动程序表中的每个驱动程序入口，并把它作为参数传给 krlrun_driverentry 函数。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18643"><span data-slate-object="text" data-key="18644"><span data-slate-leaf="true" data-offset-key="18644:0" data-first-offset="true"><span data-slate-string="true">有了 init_krldriver 函数，还要在 init_krl 函数中调用它，主要调用上述代码中的调用顺序，请注意，一定要先初始化设备表，然后才能初始化驱动程序，否则在驱动程序中建立的设备和驱动就无处安放了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="18645" id="sr-toc-3"><span data-slate-object="text" data-key="18646"><span data-slate-leaf="true" data-offset-key="18646:0" data-first-offset="true"><span data-slate-string="true">运行驱动程序</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="18647"><span data-slate-object="text" data-key="18648"><span data-slate-leaf="true" data-offset-key="18648:0" data-first-offset="true"><span data-slate-string="true">我们使用驱动程序表，虽然省略了加载驱动程序的步骤，但是驱动程序必须要运行，才能工作。接下来我们就详细看看运行驱动程序的全过程。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18649" id="sr-toc-4"><span data-slate-object="text" data-key="18650"><span data-slate-leaf="true" data-offset-key="18650:0" data-first-offset="true"><span data-slate-string="true">调用驱动程序入口函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18651"><span data-slate-object="text" data-key="18652"><span data-slate-leaf="true" data-offset-key="18652:0" data-first-offset="true"><span data-slate-string="true">我们首先来解决怎么调用驱动程序入口函数。你要知道，我们直接调用驱动程序入口函数是不行的，要先给它准备一个重要的参数，也就是</span></span></span><span data-slate-object="text" data-key="18653"><span data-slate-leaf="true" data-offset-key="18653:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">驱动描述符指针</span></span></span></span><span data-slate-object="text" data-key="18654"><span data-slate-leaf="true" data-offset-key="18654:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18655"><span data-slate-object="text" data-key="18656"><span data-slate-leaf="true" data-offset-key="18656:0" data-first-offset="true"><span data-slate-string="true">为了帮你进一步理解，我们来写一个函数描述内核加载驱动的过程，后面代码中 drvp 就是一个驱动描述符指针。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="18657"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18658"><span data-slate-object="text" data-key="18659"><span data-slate-leaf="true" data-offset-key="18659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="18660"><span data-slate-leaf="true" data-offset-key="18660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18661"><span data-slate-leaf="true" data-offset-key="18661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlrun_driverentry</span></span></span></span></span><span data-slate-object="text" data-key="18662"><span data-slate-leaf="true" data-offset-key="18662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="18663"><span data-slate-leaf="true" data-offset-key="18663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drventyexit_t</span></span></span></span></span></span><span data-slate-object="text" data-key="18664"><span data-slate-leaf="true" data-offset-key="18664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> drventry)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18665"><span data-slate-object="text" data-key="18666"><span data-slate-leaf="true" data-offset-key="18666:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18667"><span data-slate-object="text" data-key="18668"><span data-slate-leaf="true" data-offset-key="18668:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18669"><span data-slate-leaf="true" data-offset-key="18669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">driver_t</span></span></span></span><span data-slate-object="text" data-key="18670"><span data-slate-leaf="true" data-offset-key="18670:0" data-first-offset="true"><span data-slate-string="true"> *drvp = </span></span></span><span data-slate-object="text" data-key="18671"><span data-slate-leaf="true" data-offset-key="18671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new_driver_dsc</span></span></span></span><span data-slate-object="text" data-key="18672"><span data-slate-leaf="true" data-offset-key="18672:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="18673"><span data-slate-leaf="true" data-offset-key="18673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立 driver_t 实例变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18674"><span data-slate-object="text" data-key="18675"><span data-slate-leaf="true" data-offset-key="18675:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18676"><span data-slate-leaf="true" data-offset-key="18676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18677"><span data-slate-leaf="true" data-offset-key="18677:0" data-first-offset="true"><span data-slate-string="true"> (drvp == </span></span></span><span data-slate-object="text" data-key="18678"><span data-slate-leaf="true" data-offset-key="18678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="18679"><span data-slate-leaf="true" data-offset-key="18679:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18680"><span data-slate-object="text" data-key="18681"><span data-slate-leaf="true" data-offset-key="18681:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18682"><span data-slate-object="text" data-key="18683"><span data-slate-leaf="true" data-offset-key="18683:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18684"><span data-slate-leaf="true" data-offset-key="18684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18685"><span data-slate-leaf="true" data-offset-key="18685:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18686"><span data-slate-object="text" data-key="18687"><span data-slate-leaf="true" data-offset-key="18687:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18688"><span data-slate-object="text" data-key="18689"><span data-slate-leaf="true" data-offset-key="18689:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18690"><span data-slate-leaf="true" data-offset-key="18690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18691"><span data-slate-leaf="true" data-offset-key="18691:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="18692"><span data-slate-leaf="true" data-offset-key="18692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drventry</span></span></span></span><span data-slate-object="text" data-key="18693"><span data-slate-leaf="true" data-offset-key="18693:0" data-first-offset="true"><span data-slate-string="true">(drvp, </span></span></span><span data-slate-object="text" data-key="18694"><span data-slate-leaf="true" data-offset-key="18694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="18695"><span data-slate-leaf="true" data-offset-key="18695:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="18696"><span data-slate-leaf="true" data-offset-key="18696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="18697"><span data-slate-leaf="true" data-offset-key="18697:0" data-first-offset="true"><span data-slate-string="true">) == DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="18698"><span data-slate-leaf="true" data-offset-key="18698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 运行驱动程序入口函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18699"><span data-slate-object="text" data-key="18700"><span data-slate-leaf="true" data-offset-key="18700:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18701"><span data-slate-object="text" data-key="18702"><span data-slate-leaf="true" data-offset-key="18702:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18703"><span data-slate-leaf="true" data-offset-key="18703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18704"><span data-slate-leaf="true" data-offset-key="18704:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18705"><span data-slate-object="text" data-key="18706"><span data-slate-leaf="true" data-offset-key="18706:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18707"><span data-slate-object="text" data-key="18708"><span data-slate-leaf="true" data-offset-key="18708:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18709"><span data-slate-leaf="true" data-offset-key="18709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18710"><span data-slate-leaf="true" data-offset-key="18710:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="18711"><span data-slate-leaf="true" data-offset-key="18711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldriver_add_system</span></span></span></span><span data-slate-object="text" data-key="18712"><span data-slate-leaf="true" data-offset-key="18712:0" data-first-offset="true"><span data-slate-string="true">(drvp) == DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="18713"><span data-slate-leaf="true" data-offset-key="18713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把驱动程序加入系统</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18714"><span data-slate-object="text" data-key="18715"><span data-slate-leaf="true" data-offset-key="18715:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18716"><span data-slate-object="text" data-key="18717"><span data-slate-leaf="true" data-offset-key="18717:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18718"><span data-slate-leaf="true" data-offset-key="18718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18719"><span data-slate-leaf="true" data-offset-key="18719:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18720"><span data-slate-object="text" data-key="18721"><span data-slate-leaf="true" data-offset-key="18721:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18722"><span data-slate-object="text" data-key="18723"><span data-slate-leaf="true" data-offset-key="18723:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18724"><span data-slate-leaf="true" data-offset-key="18724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18725"><span data-slate-leaf="true" data-offset-key="18725:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18726"><span data-slate-object="text" data-key="18727"><span data-slate-leaf="true" data-offset-key="18727:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18728"><span data-slate-object="text" data-key="18729"><span data-slate-leaf="true" data-offset-key="18729:0" data-first-offset="true"><span data-slate-string="true">上述代码中，我们先调用了 一个 new_driver_dsc 函数，用来建立一个 driver_t 结构实例变量，这个函数我已经帮你写好了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18730"><span data-slate-object="text" data-key="18731"><span data-slate-leaf="true" data-offset-key="18731:0" data-first-offset="true"><span data-slate-string="true">然后就是调用传递进来的函数指针，并且把 drvp 作为参数传送进去。接着再进入驱动程序中运行，最后，当驱动程序入口函数返回的时候，就会把这个驱动程序加入到我们 Cosmos 系统中了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18732" id="sr-toc-5"><span data-slate-object="text" data-key="18733"><span data-slate-leaf="true" data-offset-key="18733:0" data-first-offset="true"><span data-slate-string="true">一个驱动程序入口函数的例子</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18734"><span data-slate-object="text" data-key="18735"><span data-slate-leaf="true" data-offset-key="18735:0" data-first-offset="true"><span data-slate-string="true">一个驱动程序要能够被操作系统调用，产生实际作用，那么这个驱动程序入口函数，就至少有一套标准流程要走，否则只需要返回一个 DFCOKSTUS 就行了，DFCOKSTUS 是个宏，表示成功的状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18736"><span data-slate-object="text" data-key="18737"><span data-slate-leaf="true" data-offset-key="18737:0" data-first-offset="true"><span data-slate-string="true">这个标准流程就是，首先要建立建立一个设备描述符，接着把驱动程序的功能函数设置到 driver_t 结构中的 drv_dipfun 数组中，并将设备挂载到驱动上，然后要向内核注册设备，最后驱动程序初始化自己的物理设备，安装中断回调函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18738"><span data-slate-object="text" data-key="18739"><span data-slate-leaf="true" data-offset-key="18739:0" data-first-offset="true"><span data-slate-string="true">光描述流程你还没有直观感受，所以下面我们来看一个驱动程序的实际例子，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="18740"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18741"><span data-slate-object="text" data-key="18742"><span data-slate-leaf="true" data-offset-key="18742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="18743"><span data-slate-leaf="true" data-offset-key="18743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18744"><span data-slate-leaf="true" data-offset-key="18744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_entry</span></span></span></span></span><span data-slate-object="text" data-key="18745"><span data-slate-leaf="true" data-offset-key="18745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="18746"><span data-slate-leaf="true" data-offset-key="18746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">driver_t</span></span></span></span></span></span><span data-slate-object="text" data-key="18747"><span data-slate-leaf="true" data-offset-key="18747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* drvp,</span></span></span></span></span><span data-slate-object="text" data-key="18748"><span data-slate-leaf="true" data-offset-key="18748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="18749"><span data-slate-leaf="true" data-offset-key="18749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> val,</span></span></span></span></span><span data-slate-object="text" data-key="18750"><span data-slate-leaf="true" data-offset-key="18750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="18751"><span data-slate-leaf="true" data-offset-key="18751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* p)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18752"><span data-slate-object="text" data-key="18753"><span data-slate-leaf="true" data-offset-key="18753:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18754"><span data-slate-object="text" data-key="18755"><span data-slate-leaf="true" data-offset-key="18755:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18756"><span data-slate-leaf="true" data-offset-key="18756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18757"><span data-slate-leaf="true" data-offset-key="18757:0" data-first-offset="true"><span data-slate-string="true">(drvp==</span></span></span><span data-slate-object="text" data-key="18758"><span data-slate-leaf="true" data-offset-key="18758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="18759"><span data-slate-leaf="true" data-offset-key="18759:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="18760"><span data-slate-leaf="true" data-offset-key="18760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//drvp 是内核传递进来的参数，不能为 NULL</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18761"><span data-slate-object="text" data-key="18762"><span data-slate-leaf="true" data-offset-key="18762:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18763"><span data-slate-object="text" data-key="18764"><span data-slate-leaf="true" data-offset-key="18764:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18765"><span data-slate-leaf="true" data-offset-key="18765:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18766"><span data-slate-leaf="true" data-offset-key="18766:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18767"><span data-slate-object="text" data-key="18768"><span data-slate-leaf="true" data-offset-key="18768:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18769"><span data-slate-object="text" data-key="18770"><span data-slate-leaf="true" data-offset-key="18770:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18771"><span data-slate-leaf="true" data-offset-key="18771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span><span data-slate-object="text" data-key="18772"><span data-slate-leaf="true" data-offset-key="18772:0" data-first-offset="true"><span data-slate-string="true">* devp=</span></span></span><span data-slate-object="text" data-key="18773"><span data-slate-leaf="true" data-offset-key="18773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new_device_dsc</span></span></span></span><span data-slate-object="text" data-key="18774"><span data-slate-leaf="true" data-offset-key="18774:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="18775"><span data-slate-leaf="true" data-offset-key="18775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立设备描述符结构的变量实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18776"><span data-slate-object="text" data-key="18777"><span data-slate-leaf="true" data-offset-key="18777:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18778"><span data-slate-leaf="true" data-offset-key="18778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18779"><span data-slate-leaf="true" data-offset-key="18779:0" data-first-offset="true"><span data-slate-string="true">(devp==</span></span></span><span data-slate-object="text" data-key="18780"><span data-slate-leaf="true" data-offset-key="18780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="18781"><span data-slate-leaf="true" data-offset-key="18781:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span><span data-slate-object="text" data-key="18782"><span data-slate-leaf="true" data-offset-key="18782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不能失败</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18783"><span data-slate-object="text" data-key="18784"><span data-slate-leaf="true" data-offset-key="18784:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18785"><span data-slate-object="text" data-key="18786"><span data-slate-leaf="true" data-offset-key="18786:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18787"><span data-slate-leaf="true" data-offset-key="18787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18788"><span data-slate-leaf="true" data-offset-key="18788:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18789"><span data-slate-object="text" data-key="18790"><span data-slate-leaf="true" data-offset-key="18790:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18791"><span data-slate-object="text" data-key="18792"><span data-slate-leaf="true" data-offset-key="18792:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18793"><span data-slate-leaf="true" data-offset-key="18793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_set_device</span></span></span></span><span data-slate-object="text" data-key="18794"><span data-slate-leaf="true" data-offset-key="18794:0" data-first-offset="true"><span data-slate-string="true">(devp,drvp);</span></span></span><span data-slate-object="text" data-key="18795"><span data-slate-leaf="true" data-offset-key="18795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 驱动程序的功能函数设置到 driver_t 结构中的 drv_dipfun 数组中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18796"><span data-slate-object="text" data-key="18797"><span data-slate-leaf="true" data-offset-key="18797:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18798"><span data-slate-leaf="true" data-offset-key="18798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18799"><span data-slate-leaf="true" data-offset-key="18799:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18800"><span data-slate-leaf="true" data-offset-key="18800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldev_add_driver</span></span></span></span><span data-slate-object="text" data-key="18801"><span data-slate-leaf="true" data-offset-key="18801:0" data-first-offset="true"><span data-slate-string="true">(devp,drvp)==DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="18802"><span data-slate-leaf="true" data-offset-key="18802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将设备挂载到驱动中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18803"><span data-slate-object="text" data-key="18804"><span data-slate-leaf="true" data-offset-key="18804:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18805"><span data-slate-object="text" data-key="18806"><span data-slate-leaf="true" data-offset-key="18806:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18807"><span data-slate-leaf="true" data-offset-key="18807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18808"><span data-slate-leaf="true" data-offset-key="18808:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18809"><span data-slate-leaf="true" data-offset-key="18809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">del_device_dsc</span></span></span></span><span data-slate-object="text" data-key="18810"><span data-slate-leaf="true" data-offset-key="18810:0" data-first-offset="true"><span data-slate-string="true">(devp)==DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="18811"><span data-slate-leaf="true" data-offset-key="18811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注意释放资源</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18812"><span data-slate-object="text" data-key="18813"><span data-slate-leaf="true" data-offset-key="18813:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18814"><span data-slate-object="text" data-key="18815"><span data-slate-leaf="true" data-offset-key="18815:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18816"><span data-slate-leaf="true" data-offset-key="18816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18817"><span data-slate-leaf="true" data-offset-key="18817:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18818"><span data-slate-object="text" data-key="18819"><span data-slate-leaf="true" data-offset-key="18819:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18820"><span data-slate-object="text" data-key="18821"><span data-slate-leaf="true" data-offset-key="18821:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18822"><span data-slate-leaf="true" data-offset-key="18822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18823"><span data-slate-leaf="true" data-offset-key="18823:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18824"><span data-slate-object="text" data-key="18825"><span data-slate-leaf="true" data-offset-key="18825:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18826"><span data-slate-object="text" data-key="18827"><span data-slate-leaf="true" data-offset-key="18827:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18828"><span data-slate-leaf="true" data-offset-key="18828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18829"><span data-slate-leaf="true" data-offset-key="18829:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18830"><span data-slate-leaf="true" data-offset-key="18830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_device</span></span></span></span><span data-slate-object="text" data-key="18831"><span data-slate-leaf="true" data-offset-key="18831:0" data-first-offset="true"><span data-slate-string="true">(devp)==DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="18832"><span data-slate-leaf="true" data-offset-key="18832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向内核注册设备</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18833"><span data-slate-object="text" data-key="18834"><span data-slate-leaf="true" data-offset-key="18834:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18835"><span data-slate-object="text" data-key="18836"><span data-slate-leaf="true" data-offset-key="18836:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18837"><span data-slate-leaf="true" data-offset-key="18837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18838"><span data-slate-leaf="true" data-offset-key="18838:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18839"><span data-slate-leaf="true" data-offset-key="18839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">del_device_dsc</span></span></span></span><span data-slate-object="text" data-key="18840"><span data-slate-leaf="true" data-offset-key="18840:0" data-first-offset="true"><span data-slate-string="true">(devp)==DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="18841"><span data-slate-leaf="true" data-offset-key="18841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注意释放资源</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18842"><span data-slate-object="text" data-key="18843"><span data-slate-leaf="true" data-offset-key="18843:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18844"><span data-slate-object="text" data-key="18845"><span data-slate-leaf="true" data-offset-key="18845:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18846"><span data-slate-leaf="true" data-offset-key="18846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18847"><span data-slate-leaf="true" data-offset-key="18847:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18848"><span data-slate-object="text" data-key="18849"><span data-slate-leaf="true" data-offset-key="18849:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18850"><span data-slate-object="text" data-key="18851"><span data-slate-leaf="true" data-offset-key="18851:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18852"><span data-slate-leaf="true" data-offset-key="18852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18853"><span data-slate-leaf="true" data-offset-key="18853:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18854"><span data-slate-object="text" data-key="18855"><span data-slate-leaf="true" data-offset-key="18855:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18856"><span data-slate-object="text" data-key="18857"><span data-slate-leaf="true" data-offset-key="18857:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18858"><span data-slate-leaf="true" data-offset-key="18858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 安装中断回调函数 systick_handle</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18859"><span data-slate-object="text" data-key="18860"><span data-slate-leaf="true" data-offset-key="18860:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18861"><span data-slate-leaf="true" data-offset-key="18861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18862"><span data-slate-leaf="true" data-offset-key="18862:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18863"><span data-slate-leaf="true" data-offset-key="18863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_devhandle</span></span></span></span><span data-slate-object="text" data-key="18864"><span data-slate-leaf="true" data-offset-key="18864:0" data-first-offset="true"><span data-slate-string="true">(devp,systick_handle,</span></span></span><span data-slate-object="text" data-key="18865"><span data-slate-leaf="true" data-offset-key="18865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20</span></span></span></span><span data-slate-object="text" data-key="18866"><span data-slate-leaf="true" data-offset-key="18866:0" data-first-offset="true"><span data-slate-string="true">)==DFCERRSTUS)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18867"><span data-slate-object="text" data-key="18868"><span data-slate-leaf="true" data-offset-key="18868:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18869"><span data-slate-object="text" data-key="18870"><span data-slate-leaf="true" data-offset-key="18870:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18871"><span data-slate-leaf="true" data-offset-key="18871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18872"><span data-slate-leaf="true" data-offset-key="18872:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;  </span></span></span><span data-slate-object="text" data-key="18873"><span data-slate-leaf="true" data-offset-key="18873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注意释放资源</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18874"><span data-slate-object="text" data-key="18875"><span data-slate-leaf="true" data-offset-key="18875:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18876"><span data-slate-object="text" data-key="18877"><span data-slate-leaf="true" data-offset-key="18877:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18878"><span data-slate-leaf="true" data-offset-key="18878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_8254</span></span></span></span><span data-slate-object="text" data-key="18879"><span data-slate-leaf="true" data-offset-key="18879:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="18880"><span data-slate-leaf="true" data-offset-key="18880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化物理设备 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18881"><span data-slate-object="text" data-key="18882"><span data-slate-leaf="true" data-offset-key="18882:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18883"><span data-slate-leaf="true" data-offset-key="18883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18884"><span data-slate-leaf="true" data-offset-key="18884:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18885"><span data-slate-leaf="true" data-offset-key="18885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlenable_intline</span></span></span></span><span data-slate-object="text" data-key="18886"><span data-slate-leaf="true" data-offset-key="18886:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="18887"><span data-slate-leaf="true" data-offset-key="18887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20</span></span></span></span><span data-slate-object="text" data-key="18888"><span data-slate-leaf="true" data-offset-key="18888:0" data-first-offset="true"><span data-slate-string="true">)==DFCERRSTUS)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18889"><span data-slate-object="text" data-key="18890"><span data-slate-leaf="true" data-offset-key="18890:0" data-first-offset="true"><span data-slate-string="true">    { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18891"><span data-slate-object="text" data-key="18892"><span data-slate-leaf="true" data-offset-key="18892:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18893"><span data-slate-leaf="true" data-offset-key="18893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18894"><span data-slate-leaf="true" data-offset-key="18894:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18895"><span data-slate-object="text" data-key="18896"><span data-slate-leaf="true" data-offset-key="18896:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18897"><span data-slate-object="text" data-key="18898"><span data-slate-leaf="true" data-offset-key="18898:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18899"><span data-slate-leaf="true" data-offset-key="18899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18900"><span data-slate-leaf="true" data-offset-key="18900:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18901"><span data-slate-object="text" data-key="18902"><span data-slate-leaf="true" data-offset-key="18902:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18903"><span data-slate-object="text" data-key="18904"><span data-slate-leaf="true" data-offset-key="18904:0" data-first-offset="true"><span data-slate-string="true">上述代码是一个真实设备驱动程序入口函数的标准流程，这是一个例子，不能运行，是一个驱动程序框架，这个例子告诉我们，操作系统内核要为驱动程序开发者</span></span></span><span data-slate-object="text" data-key="18905"><span data-slate-leaf="true" data-offset-key="18905:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">提供哪些功能接口函数</span></span></span></span><span data-slate-object="text" data-key="18906"><span data-slate-leaf="true" data-offset-key="18906:0" data-first-offset="true"><span data-slate-string="true">，这在很多通用操作系统上叫作</span></span></span><span data-slate-object="text" data-key="18907"><span data-slate-leaf="true" data-offset-key="18907:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">驱动模型</span></span></span></span><span data-slate-object="text" data-key="18908"><span data-slate-leaf="true" data-offset-key="18908:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18909" id="sr-toc-6"><span data-slate-object="text" data-key="18910"><span data-slate-leaf="true" data-offset-key="18910:0" data-first-offset="true"><span data-slate-string="true">设备与驱动的联系</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18911"><span data-slate-object="text" data-key="18912"><span data-slate-leaf="true" data-offset-key="18912:0" data-first-offset="true"><span data-slate-string="true">上面的例子只是演示流程的，我们并没有写好供驱动程序开发者使用的接口函数，我们这就来写好这些接口函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18913"><span data-slate-object="text" data-key="18914"><span data-slate-leaf="true" data-offset-key="18914:0" data-first-offset="true"><span data-slate-string="true">我们要写的第一个接口就是将设备挂载到驱动上，让设备和驱动产生联系，确保驱动能找到设备，设备能找到驱动。代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="18915"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18916"><span data-slate-object="text" data-key="18917"><span data-slate-leaf="true" data-offset-key="18917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="18918"><span data-slate-leaf="true" data-offset-key="18918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="18919"><span data-slate-leaf="true" data-offset-key="18919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldev_add_driver</span></span></span></span></span><span data-slate-object="text" data-key="18920"><span data-slate-leaf="true" data-offset-key="18920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="18921"><span data-slate-leaf="true" data-offset-key="18921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="18922"><span data-slate-leaf="true" data-offset-key="18922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="18923"><span data-slate-leaf="true" data-offset-key="18923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">driver_t</span></span></span></span></span></span><span data-slate-object="text" data-key="18924"><span data-slate-leaf="true" data-offset-key="18924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *drvp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18925"><span data-slate-object="text" data-key="18926"><span data-slate-leaf="true" data-offset-key="18926:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18927"><span data-slate-object="text" data-key="18928"><span data-slate-leaf="true" data-offset-key="18928:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18929"><span data-slate-leaf="true" data-offset-key="18929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="18930"><span data-slate-leaf="true" data-offset-key="18930:0" data-first-offset="true"><span data-slate-string="true"> *lst;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18931"><span data-slate-object="text" data-key="18932"><span data-slate-leaf="true" data-offset-key="18932:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18933"><span data-slate-leaf="true" data-offset-key="18933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span><span data-slate-object="text" data-key="18934"><span data-slate-leaf="true" data-offset-key="18934:0" data-first-offset="true"><span data-slate-string="true"> *fdevp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18935"><span data-slate-object="text" data-key="18936"><span data-slate-leaf="true" data-offset-key="18936:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18937"><span data-slate-leaf="true" data-offset-key="18937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历这个驱动上所有设备</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18938"><span data-slate-object="text" data-key="18939"><span data-slate-leaf="true" data-offset-key="18939:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18940"><span data-slate-leaf="true" data-offset-key="18940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_for_each</span></span></span></span><span data-slate-object="text" data-key="18941"><span data-slate-leaf="true" data-offset-key="18941:0" data-first-offset="true"><span data-slate-string="true">(lst, &amp;drvp-&gt;drv_alldevlist)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18942"><span data-slate-object="text" data-key="18943"><span data-slate-leaf="true" data-offset-key="18943:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18944"><span data-slate-object="text" data-key="18945"><span data-slate-leaf="true" data-offset-key="18945:0" data-first-offset="true"><span data-slate-string="true">        fdevp = </span></span></span><span data-slate-object="text" data-key="18946"><span data-slate-leaf="true" data-offset-key="18946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_entry</span></span></span></span><span data-slate-object="text" data-key="18947"><span data-slate-leaf="true" data-offset-key="18947:0" data-first-offset="true"><span data-slate-string="true">(lst, </span></span></span><span data-slate-object="text" data-key="18948"><span data-slate-leaf="true" data-offset-key="18948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span><span data-slate-object="text" data-key="18949"><span data-slate-leaf="true" data-offset-key="18949:0" data-first-offset="true"><span data-slate-string="true">, dev_indrvlst);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18950"><span data-slate-object="text" data-key="18951"><span data-slate-leaf="true" data-offset-key="18951:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18952"><span data-slate-leaf="true" data-offset-key="18952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 比较设备 ID 有相同的则返回错误</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18953"><span data-slate-object="text" data-key="18954"><span data-slate-leaf="true" data-offset-key="18954:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="18955"><span data-slate-leaf="true" data-offset-key="18955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="18956"><span data-slate-leaf="true" data-offset-key="18956:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="18957"><span data-slate-leaf="true" data-offset-key="18957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlcmp_devid</span></span></span></span><span data-slate-object="text" data-key="18958"><span data-slate-leaf="true" data-offset-key="18958:0" data-first-offset="true"><span data-slate-string="true">(&amp;devp-&gt;dev_id, &amp;fdevp-&gt;dev_id) == TRUE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18959"><span data-slate-object="text" data-key="18960"><span data-slate-leaf="true" data-offset-key="18960:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18961"><span data-slate-object="text" data-key="18962"><span data-slate-leaf="true" data-offset-key="18962:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="18963"><span data-slate-leaf="true" data-offset-key="18963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18964"><span data-slate-leaf="true" data-offset-key="18964:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18965"><span data-slate-object="text" data-key="18966"><span data-slate-leaf="true" data-offset-key="18966:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18967"><span data-slate-object="text" data-key="18968"><span data-slate-leaf="true" data-offset-key="18968:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18969"><span data-slate-object="text" data-key="18970"><span data-slate-leaf="true" data-offset-key="18970:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18971"><span data-slate-leaf="true" data-offset-key="18971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将设备挂载到驱动上</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18972"><span data-slate-object="text" data-key="18973"><span data-slate-leaf="true" data-offset-key="18973:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18974"><span data-slate-leaf="true" data-offset-key="18974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_add</span></span></span></span><span data-slate-object="text" data-key="18975"><span data-slate-leaf="true" data-offset-key="18975:0" data-first-offset="true"><span data-slate-string="true">(&amp;devp-&gt;dev_indrvlst, &amp;drvp-&gt;drv_alldevlist);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18976"><span data-slate-object="text" data-key="18977"><span data-slate-leaf="true" data-offset-key="18977:0" data-first-offset="true"><span data-slate-string="true">    devp-&gt;dev_drv = drvp;</span></span></span><span data-slate-object="text" data-key="18978"><span data-slate-leaf="true" data-offset-key="18978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 让设备中 dev_drv 字段指向管理自己的驱动</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18979"><span data-slate-object="text" data-key="18980"><span data-slate-leaf="true" data-offset-key="18980:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="18981"><span data-slate-leaf="true" data-offset-key="18981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="18982"><span data-slate-leaf="true" data-offset-key="18982:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18983"><span data-slate-object="text" data-key="18984"><span data-slate-leaf="true" data-offset-key="18984:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="18985"><span data-slate-object="text" data-key="18986"><span data-slate-leaf="true" data-offset-key="18986:0" data-first-offset="true"><span data-slate-string="true">由于我们的设计一个驱动程序可以管理多个设备，所以在上述代码中，要遍历驱动设备链表中的所有设备，看看有没有设备 ID 冲突。如果没有就把这个设备载入这个驱动中，并把设备中的相关字段指向这个管理自己的驱动，这样设备和驱动就联系起来了。是不是很简单呢？</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="18987" id="sr-toc-7"><span data-slate-object="text" data-key="18988"><span data-slate-leaf="true" data-offset-key="18988:0" data-first-offset="true"><span data-slate-string="true">向内核注册设备</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="18989"><span data-slate-object="text" data-key="18990"><span data-slate-leaf="true" data-offset-key="18990:0" data-first-offset="true"><span data-slate-string="true">一个设备要想被内核感知，最终供用户使用，就要先向内核注册，这个注册过程应该由内核来实现并提供接口，在这个注册设备的过程中，内核会通过设备的类型和 ID，把用来表示设备的 device_t 结构挂载到设备表中。下面我们来写好这部分代码，如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="18991"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="18992"><span data-slate-object="text" data-key="18993"><span data-slate-leaf="true" data-offset-key="18993:0" data-first-offset="true"><span data-slate-string="true">drvstus_t </span></span></span><span data-slate-object="text" data-key="18994"><span data-slate-leaf="true" data-offset-key="18994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_device</span></span></span></span><span data-slate-object="text" data-key="18995"><span data-slate-leaf="true" data-offset-key="18995:0" data-first-offset="true"><span data-slate-string="true">(device_t *devp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18996"><span data-slate-object="text" data-key="18997"><span data-slate-leaf="true" data-offset-key="18997:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="18998"><span data-slate-object="text" data-key="18999"><span data-slate-leaf="true" data-offset-key="18999:0" data-first-offset="true"><span data-slate-string="true">    device_t *findevp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19000"><span data-slate-object="text" data-key="19001"><span data-slate-leaf="true" data-offset-key="19001:0" data-first-offset="true"><span data-slate-string="true">    drvstus_t rets = DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19002"><span data-slate-object="text" data-key="19003"><span data-slate-leaf="true" data-offset-key="19003:0" data-first-offset="true"><span data-slate-string="true">    cpuflg_t cpufg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19004"><span data-slate-object="text" data-key="19005"><span data-slate-leaf="true" data-offset-key="19005:0" data-first-offset="true"><span data-slate-string="true">    list_h_t *lstp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19006"><span data-slate-object="text" data-key="19007"><span data-slate-leaf="true" data-offset-key="19007:0" data-first-offset="true"><span data-slate-string="true">    devtable_t *dtbp = &amp;osdevtable;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19008"><span data-slate-object="text" data-key="19009"><span data-slate-leaf="true" data-offset-key="19009:0" data-first-offset="true"><span data-slate-string="true">    uint_t devmty = devp</span></span></span><span data-slate-object="text" data-key="19010"><span data-slate-leaf="true" data-offset-key="19010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19011"><span data-slate-leaf="true" data-offset-key="19011:0" data-first-offset="true"><span data-slate-string="true">dev_id.dev_mtype;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19012"><span data-slate-object="text" data-key="19013"><span data-slate-leaf="true" data-offset-key="19013:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19014"><span data-slate-leaf="true" data-offset-key="19014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19015"><span data-slate-leaf="true" data-offset-key="19015:0" data-first-offset="true"><span data-slate-string="true"> (devp</span></span></span><span data-slate-object="text" data-key="19016"><span data-slate-leaf="true" data-offset-key="19016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19017"><span data-slate-leaf="true" data-offset-key="19017:0" data-first-offset="true"><span data-slate-string="true">dev_drv == NULL)</span></span></span><span data-slate-object="text" data-key="19018"><span data-slate-leaf="true" data-offset-key="19018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 没有驱动的设备不行</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19019"><span data-slate-object="text" data-key="19020"><span data-slate-leaf="true" data-offset-key="19020:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19021"><span data-slate-object="text" data-key="19022"><span data-slate-leaf="true" data-offset-key="19022:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19023"><span data-slate-leaf="true" data-offset-key="19023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19024"><span data-slate-leaf="true" data-offset-key="19024:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19025"><span data-slate-object="text" data-key="19026"><span data-slate-leaf="true" data-offset-key="19026:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19027"><span data-slate-object="text" data-key="19028"><span data-slate-leaf="true" data-offset-key="19028:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19029"><span data-slate-leaf="true" data-offset-key="19029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="19030"><span data-slate-leaf="true" data-offset-key="19030:0" data-first-offset="true"><span data-slate-string="true">(&amp;dtbp</span></span></span><span data-slate-object="text" data-key="19031"><span data-slate-leaf="true" data-offset-key="19031:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19032"><span data-slate-leaf="true" data-offset-key="19032:0" data-first-offset="true"><span data-slate-string="true">devt_lock, &amp;cpufg);</span></span></span><span data-slate-object="text" data-key="19033"><span data-slate-leaf="true" data-offset-key="19033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19034"><span data-slate-object="text" data-key="19035"><span data-slate-leaf="true" data-offset-key="19035:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19036"><span data-slate-leaf="true" data-offset-key="19036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历设备类型链表上的所有设备</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19037"><span data-slate-object="text" data-key="19038"><span data-slate-leaf="true" data-offset-key="19038:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19039"><span data-slate-leaf="true" data-offset-key="19039:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_for_each</span></span></span></span><span data-slate-object="text" data-key="19040"><span data-slate-leaf="true" data-offset-key="19040:0" data-first-offset="true"><span data-slate-string="true">(lstp, &amp;dtbp</span></span></span><span data-slate-object="text" data-key="19041"><span data-slate-leaf="true" data-offset-key="19041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19042"><span data-slate-leaf="true" data-offset-key="19042:0" data-first-offset="true"><span data-slate-string="true">devt_devclsl[devmty].dtl_list)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19043"><span data-slate-object="text" data-key="19044"><span data-slate-leaf="true" data-offset-key="19044:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19045"><span data-slate-object="text" data-key="19046"><span data-slate-leaf="true" data-offset-key="19046:0" data-first-offset="true"><span data-slate-string="true">        findevp = </span></span></span><span data-slate-object="text" data-key="19047"><span data-slate-leaf="true" data-offset-key="19047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_entry</span></span></span></span><span data-slate-object="text" data-key="19048"><span data-slate-leaf="true" data-offset-key="19048:0" data-first-offset="true"><span data-slate-string="true">(lstp, device_t, dev_intbllst);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19049"><span data-slate-object="text" data-key="19050"><span data-slate-leaf="true" data-offset-key="19050:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19051"><span data-slate-leaf="true" data-offset-key="19051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不能有设备 ID 相同的设备，如果有则出错</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19052"><span data-slate-object="text" data-key="19053"><span data-slate-leaf="true" data-offset-key="19053:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19054"><span data-slate-leaf="true" data-offset-key="19054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19055"><span data-slate-leaf="true" data-offset-key="19055:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="19056"><span data-slate-leaf="true" data-offset-key="19056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlcmp_devid</span></span></span></span><span data-slate-object="text" data-key="19057"><span data-slate-leaf="true" data-offset-key="19057:0" data-first-offset="true"><span data-slate-string="true">(&amp;devp</span></span></span><span data-slate-object="text" data-key="19058"><span data-slate-leaf="true" data-offset-key="19058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19059"><span data-slate-leaf="true" data-offset-key="19059:0" data-first-offset="true"><span data-slate-string="true">dev_id, &amp;findevp</span></span></span><span data-slate-object="text" data-key="19060"><span data-slate-leaf="true" data-offset-key="19060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19061"><span data-slate-leaf="true" data-offset-key="19061:0" data-first-offset="true"><span data-slate-string="true">dev_id) == TRUE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19062"><span data-slate-object="text" data-key="19063"><span data-slate-leaf="true" data-offset-key="19063:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19064"><span data-slate-object="text" data-key="19065"><span data-slate-leaf="true" data-offset-key="19065:0" data-first-offset="true"><span data-slate-string="true">            rets = DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19066"><span data-slate-object="text" data-key="19067"><span data-slate-leaf="true" data-offset-key="19067:0" data-first-offset="true"><span data-slate-string="true">            goto return_step;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19068"><span data-slate-object="text" data-key="19069"><span data-slate-leaf="true" data-offset-key="19069:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19070"><span data-slate-object="text" data-key="19071"><span data-slate-leaf="true" data-offset-key="19071:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19072"><span data-slate-object="text" data-key="19073"><span data-slate-leaf="true" data-offset-key="19073:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19074"><span data-slate-leaf="true" data-offset-key="19074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 先把设备加入设备表的全局设备链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19075"><span data-slate-object="text" data-key="19076"><span data-slate-leaf="true" data-offset-key="19076:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19077"><span data-slate-leaf="true" data-offset-key="19077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_add</span></span></span></span><span data-slate-object="text" data-key="19078"><span data-slate-leaf="true" data-offset-key="19078:0" data-first-offset="true"><span data-slate-string="true">(&amp;devp</span></span></span><span data-slate-object="text" data-key="19079"><span data-slate-leaf="true" data-offset-key="19079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19080"><span data-slate-leaf="true" data-offset-key="19080:0" data-first-offset="true"><span data-slate-string="true">dev_intbllst, &amp;dtbp</span></span></span><span data-slate-object="text" data-key="19081"><span data-slate-leaf="true" data-offset-key="19081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19082"><span data-slate-leaf="true" data-offset-key="19082:0" data-first-offset="true"><span data-slate-string="true">devt_devclsl[devmty].dtl_list);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19083"><span data-slate-object="text" data-key="19084"><span data-slate-leaf="true" data-offset-key="19084:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19085"><span data-slate-leaf="true" data-offset-key="19085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将设备加入对应设备类型的链表中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19086"><span data-slate-object="text" data-key="19087"><span data-slate-leaf="true" data-offset-key="19087:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19088"><span data-slate-leaf="true" data-offset-key="19088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_add</span></span></span></span><span data-slate-object="text" data-key="19089"><span data-slate-leaf="true" data-offset-key="19089:0" data-first-offset="true"><span data-slate-string="true">(&amp;devp</span></span></span><span data-slate-object="text" data-key="19090"><span data-slate-leaf="true" data-offset-key="19090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19091"><span data-slate-leaf="true" data-offset-key="19091:0" data-first-offset="true"><span data-slate-string="true">dev_list, &amp;dtbp</span></span></span><span data-slate-object="text" data-key="19092"><span data-slate-leaf="true" data-offset-key="19092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19093"><span data-slate-leaf="true" data-offset-key="19093:0" data-first-offset="true"><span data-slate-string="true">devt_devlist);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19094"><span data-slate-object="text" data-key="19095"><span data-slate-leaf="true" data-offset-key="19095:0" data-first-offset="true"><span data-slate-string="true">    dtbp</span></span></span><span data-slate-object="text" data-key="19096"><span data-slate-leaf="true" data-offset-key="19096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19097"><span data-slate-leaf="true" data-offset-key="19097:0" data-first-offset="true"><span data-slate-string="true">devt_devclsl[devmty].dtl_nr++;</span></span></span><span data-slate-object="text" data-key="19098"><span data-slate-leaf="true" data-offset-key="19098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备计数加一</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19099"><span data-slate-object="text" data-key="19100"><span data-slate-leaf="true" data-offset-key="19100:0" data-first-offset="true"><span data-slate-string="true">    dtbp</span></span></span><span data-slate-object="text" data-key="19101"><span data-slate-leaf="true" data-offset-key="19101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19102"><span data-slate-leaf="true" data-offset-key="19102:0" data-first-offset="true"><span data-slate-string="true">devt_devnr++;</span></span></span><span data-slate-object="text" data-key="19103"><span data-slate-leaf="true" data-offset-key="19103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 总的设备数加一</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19104"><span data-slate-object="text" data-key="19105"><span data-slate-leaf="true" data-offset-key="19105:0" data-first-offset="true"><span data-slate-string="true">    rets = DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19106"><span data-slate-object="text" data-key="19107"><span data-slate-leaf="true" data-offset-key="19107:0" data-first-offset="true"><span data-slate-string="true">return_step:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19108"><span data-slate-object="text" data-key="19109"><span data-slate-leaf="true" data-offset-key="19109:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19110"><span data-slate-leaf="true" data-offset-key="19110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="19111"><span data-slate-leaf="true" data-offset-key="19111:0" data-first-offset="true"><span data-slate-string="true">(&amp;dtbp</span></span></span><span data-slate-object="text" data-key="19112"><span data-slate-leaf="true" data-offset-key="19112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="19113"><span data-slate-leaf="true" data-offset-key="19113:0" data-first-offset="true"><span data-slate-string="true">devt_lock, &amp;cpufg);</span></span></span><span data-slate-object="text" data-key="19114"><span data-slate-leaf="true" data-offset-key="19114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19115"><span data-slate-object="text" data-key="19116"><span data-slate-leaf="true" data-offset-key="19116:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19117"><span data-slate-leaf="true" data-offset-key="19117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19118"><span data-slate-leaf="true" data-offset-key="19118:0" data-first-offset="true"><span data-slate-string="true"> rets;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19119"><span data-slate-object="text" data-key="19120"><span data-slate-leaf="true" data-offset-key="19120:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19121"><span data-slate-object="text" data-key="19122"><span data-slate-leaf="true" data-offset-key="19122:0" data-first-offset="true"><span data-slate-string="true">上述代码中，主要是检查在设备表中有没有设备 ID 冲突，如果没有的话就加入设备类型链表和全局设备链表中，最后对其计数器变量加一。完成了这些操作之后，我们在操作设备时，通过设备 ID 就可以找到对应的设备了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="19123" id="sr-toc-8"><span data-slate-object="text" data-key="19124"><span data-slate-leaf="true" data-offset-key="19124:0" data-first-offset="true"><span data-slate-string="true">安装中断回调函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="19125"><span data-slate-object="text" data-key="19126"><span data-slate-leaf="true" data-offset-key="19126:0" data-first-offset="true"><span data-slate-string="true">设备很多时候必须要和 CPU 进行通信，这是通过中断的形式进行的，例如，当硬盘的数据读取成功、当网卡又来了数据、或者定时器的时间已经过期，这时候这些设备就会发出中断信号，中断信号会被中断控制器接受，然后发送给 CPU 请求内核关注。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19127"><span data-slate-object="text" data-key="19128"><span data-slate-leaf="true" data-offset-key="19128:0" data-first-offset="true"><span data-slate-string="true">收到中断信号后，CPU 就会开始处理中断，转而调用中断处理框架函数，最后会调用设备驱动程序提供的中断回调函数，对该设备发出的中断进行具体处理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19129"><span data-slate-object="text" data-key="19130"><span data-slate-leaf="true" data-offset-key="19130:0" data-first-offset="true"><span data-slate-string="true">既然中断回调函数是驱动程序提供的，我们内核就要提供相应的</span></span></span><span data-slate-object="text" data-key="19131"><span data-slate-leaf="true" data-offset-key="19131:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">接口</span></span></span></span><span data-slate-object="text" data-key="19132"><span data-slate-leaf="true" data-offset-key="19132:0" data-first-offset="true"><span data-slate-string="true">用于安装中断回调函数，使得驱动程序开发者专注于设备本身，不用分心去了解内核的中断框架。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19133"><span data-slate-object="text" data-key="19134"><span data-slate-leaf="true" data-offset-key="19134:0" data-first-offset="true"><span data-slate-string="true">下面我们来实现这个安装中断回调函数的接口函数，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="19135"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19136"><span data-slate-object="text" data-key="19137"><span data-slate-leaf="true" data-offset-key="19137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断回调函数类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19138"><span data-slate-object="text" data-key="19139"><span data-slate-leaf="true" data-offset-key="19139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span></span><span data-slate-object="text" data-key="19140"><span data-slate-leaf="true" data-offset-key="19140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19141"><span data-slate-leaf="true" data-offset-key="19141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19142"><span data-slate-leaf="true" data-offset-key="19142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19143"><span data-slate-leaf="true" data-offset-key="19143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(*</span></span></span></span></span><span data-slate-object="text" data-key="19144"><span data-slate-leaf="true" data-offset-key="19144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intflthandle_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19145"><span data-slate-leaf="true" data-offset-key="19145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="19146"><span data-slate-leaf="true" data-offset-key="19146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19147"><span data-slate-leaf="true" data-offset-key="19147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19148"><span data-slate-leaf="true" data-offset-key="19148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ift_nr,</span></span></span></span></span><span data-slate-object="text" data-key="19149"><span data-slate-leaf="true" data-offset-key="19149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19150"><span data-slate-leaf="true" data-offset-key="19150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* device,</span></span></span></span></span><span data-slate-object="text" data-key="19151"><span data-slate-leaf="true" data-offset-key="19151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19152"><span data-slate-leaf="true" data-offset-key="19152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* sframe)</span></span></span></span></span><span data-slate-object="text" data-key="19153"><span data-slate-leaf="true" data-offset-key="19153:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19154"><span data-slate-object="text" data-key="19155"><span data-slate-leaf="true" data-offset-key="19155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 安装中断回调函数接口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19156"><span data-slate-object="text" data-key="19157"><span data-slate-leaf="true" data-offset-key="19157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19158"><span data-slate-leaf="true" data-offset-key="19158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19159"><span data-slate-leaf="true" data-offset-key="19159:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_devhandle</span></span></span></span></span><span data-slate-object="text" data-key="19160"><span data-slate-leaf="true" data-offset-key="19160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19161"><span data-slate-leaf="true" data-offset-key="19161:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19162"><span data-slate-leaf="true" data-offset-key="19162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="19163"><span data-slate-leaf="true" data-offset-key="19163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intflthandle_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19164"><span data-slate-leaf="true" data-offset-key="19164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> handle, </span></span></span></span></span><span data-slate-object="text" data-key="19165"><span data-slate-leaf="true" data-offset-key="19165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19166"><span data-slate-leaf="true" data-offset-key="19166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> phyiline)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19167"><span data-slate-object="text" data-key="19168"><span data-slate-leaf="true" data-offset-key="19168:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19169"><span data-slate-object="text" data-key="19170"><span data-slate-leaf="true" data-offset-key="19170:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19171"><span data-slate-leaf="true" data-offset-key="19171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用内核层中断框架接口函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19172"><span data-slate-object="text" data-key="19173"><span data-slate-leaf="true" data-offset-key="19173:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19174"><span data-slate-leaf="true" data-offset-key="19174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="19175"><span data-slate-leaf="true" data-offset-key="19175:0" data-first-offset="true"><span data-slate-string="true"> *sdp = </span></span></span><span data-slate-object="text" data-key="19176"><span data-slate-leaf="true" data-offset-key="19176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krladd_irqhandle</span></span></span></span><span data-slate-object="text" data-key="19177"><span data-slate-leaf="true" data-offset-key="19177:0" data-first-offset="true"><span data-slate-string="true">(devp, handle, phyiline);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19178"><span data-slate-object="text" data-key="19179"><span data-slate-leaf="true" data-offset-key="19179:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19180"><span data-slate-leaf="true" data-offset-key="19180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19181"><span data-slate-leaf="true" data-offset-key="19181:0" data-first-offset="true"><span data-slate-string="true"> (sdp == </span></span></span><span data-slate-object="text" data-key="19182"><span data-slate-leaf="true" data-offset-key="19182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19183"><span data-slate-leaf="true" data-offset-key="19183:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19184"><span data-slate-object="text" data-key="19185"><span data-slate-leaf="true" data-offset-key="19185:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19186"><span data-slate-object="text" data-key="19187"><span data-slate-leaf="true" data-offset-key="19187:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19188"><span data-slate-leaf="true" data-offset-key="19188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19189"><span data-slate-leaf="true" data-offset-key="19189:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19190"><span data-slate-object="text" data-key="19191"><span data-slate-leaf="true" data-offset-key="19191:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19192"><span data-slate-object="text" data-key="19193"><span data-slate-leaf="true" data-offset-key="19193:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19194"><span data-slate-leaf="true" data-offset-key="19194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cpuflg_t</span></span></span></span><span data-slate-object="text" data-key="19195"><span data-slate-leaf="true" data-offset-key="19195:0" data-first-offset="true"><span data-slate-string="true"> cpufg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19196"><span data-slate-object="text" data-key="19197"><span data-slate-leaf="true" data-offset-key="19197:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19198"><span data-slate-leaf="true" data-offset-key="19198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="19199"><span data-slate-leaf="true" data-offset-key="19199:0" data-first-offset="true"><span data-slate-string="true">(&amp;devp-&gt;dev_lock, &amp;cpufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19200"><span data-slate-object="text" data-key="19201"><span data-slate-leaf="true" data-offset-key="19201:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19202"><span data-slate-leaf="true" data-offset-key="19202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将中断服务描述符结构挂入这个设备结构中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19203"><span data-slate-object="text" data-key="19204"><span data-slate-leaf="true" data-offset-key="19204:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19205"><span data-slate-leaf="true" data-offset-key="19205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_add</span></span></span></span><span data-slate-object="text" data-key="19206"><span data-slate-leaf="true" data-offset-key="19206:0" data-first-offset="true"><span data-slate-string="true">(&amp;sdp-&gt;s_indevlst, &amp;devp-&gt;dev_intserlst);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19207"><span data-slate-object="text" data-key="19208"><span data-slate-leaf="true" data-offset-key="19208:0" data-first-offset="true"><span data-slate-string="true">    devp-&gt;dev_intlnenr++;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19209"><span data-slate-object="text" data-key="19210"><span data-slate-leaf="true" data-offset-key="19210:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19211"><span data-slate-leaf="true" data-offset-key="19211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="19212"><span data-slate-leaf="true" data-offset-key="19212:0" data-first-offset="true"><span data-slate-string="true">(&amp;devp-&gt;dev_lock, &amp;cpufg);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19213"><span data-slate-object="text" data-key="19214"><span data-slate-leaf="true" data-offset-key="19214:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19215"><span data-slate-leaf="true" data-offset-key="19215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19216"><span data-slate-leaf="true" data-offset-key="19216:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19217"><span data-slate-object="text" data-key="19218"><span data-slate-leaf="true" data-offset-key="19218:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19219"><span data-slate-object="text" data-key="19220"><span data-slate-leaf="true" data-offset-key="19220:0" data-first-offset="true"><span data-slate-string="true">我来给你做个解读，上述代码中，krlnew_devhandle 函数有三个参数，分别是安装中断回调函数的设备，驱动程序提供的中断回调函数，还有一个是设备在中断控制器中断线的号码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19221"><span data-slate-object="text" data-key="19222"><span data-slate-leaf="true" data-offset-key="19222:0" data-first-offset="true"><span data-slate-string="true">krlnew_devhandle 函数中一开始就会调用内核层的中断框架接口，你发现了么？这个接口还没写呢，所以我们马上就去写好它，但是我们不应该在 krldevice.c 文件中写，而是要在 cosmos/kernel/ 目录下建立一个 krlintupt.c 文件，在这个文件模块中写，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="19223"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19224"><span data-slate-object="text" data-key="19225"><span data-slate-leaf="true" data-offset-key="19225:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="19226"><span data-slate-leaf="true" data-offset-key="19226:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19227"><span data-slate-leaf="true" data-offset-key="19227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="19228"><span data-slate-leaf="true" data-offset-key="19228:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19229"><span data-slate-leaf="true" data-offset-key="19229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_INTSERDSC</span></span></span></span><span data-slate-object="text" data-key="19230"><span data-slate-leaf="true" data-offset-key="19230:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19231"><span data-slate-object="text" data-key="19232"><span data-slate-leaf="true" data-offset-key="19232:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19233"><span data-slate-leaf="true" data-offset-key="19233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="19234"><span data-slate-leaf="true" data-offset-key="19234:0" data-first-offset="true"><span data-slate-string="true">    s_list;        </span></span></span><span data-slate-object="text" data-key="19235"><span data-slate-leaf="true" data-offset-key="19235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在中断异常描述符中的链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19236"><span data-slate-object="text" data-key="19237"><span data-slate-leaf="true" data-offset-key="19237:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19238"><span data-slate-leaf="true" data-offset-key="19238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="19239"><span data-slate-leaf="true" data-offset-key="19239:0" data-first-offset="true"><span data-slate-string="true">    s_indevlst;    </span></span></span><span data-slate-object="text" data-key="19240"><span data-slate-leaf="true" data-offset-key="19240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在设备描述描述符中的链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19241"><span data-slate-object="text" data-key="19242"><span data-slate-leaf="true" data-offset-key="19242:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19243"><span data-slate-leaf="true" data-offset-key="19243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">u32_t</span></span></span></span><span data-slate-object="text" data-key="19244"><span data-slate-leaf="true" data-offset-key="19244:0" data-first-offset="true"><span data-slate-string="true">       s_flg;         </span></span></span><span data-slate-object="text" data-key="19245"><span data-slate-leaf="true" data-offset-key="19245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19246"><span data-slate-object="text" data-key="19247"><span data-slate-leaf="true" data-offset-key="19247:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19248"><span data-slate-leaf="true" data-offset-key="19248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intfltdsc_t</span></span></span></span><span data-slate-object="text" data-key="19249"><span data-slate-leaf="true" data-offset-key="19249:0" data-first-offset="true"><span data-slate-string="true">* s_intfltp;    </span></span></span><span data-slate-object="text" data-key="19250"><span data-slate-leaf="true" data-offset-key="19250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向中断异常描述符 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19251"><span data-slate-object="text" data-key="19252"><span data-slate-leaf="true" data-offset-key="19252:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19253"><span data-slate-leaf="true" data-offset-key="19253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="19254"><span data-slate-leaf="true" data-offset-key="19254:0" data-first-offset="true"><span data-slate-string="true">*       s_device;      </span></span></span><span data-slate-object="text" data-key="19255"><span data-slate-leaf="true" data-offset-key="19255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 指向设备描述符</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19256"><span data-slate-object="text" data-key="19257"><span data-slate-leaf="true" data-offset-key="19257:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19258"><span data-slate-leaf="true" data-offset-key="19258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19259"><span data-slate-leaf="true" data-offset-key="19259:0" data-first-offset="true"><span data-slate-string="true">      s_indx;        </span></span></span><span data-slate-object="text" data-key="19260"><span data-slate-leaf="true" data-offset-key="19260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断回调函数运行计数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19261"><span data-slate-object="text" data-key="19262"><span data-slate-leaf="true" data-offset-key="19262:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19263"><span data-slate-leaf="true" data-offset-key="19263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intflthandle_t</span></span></span></span><span data-slate-object="text" data-key="19264"><span data-slate-leaf="true" data-offset-key="19264:0" data-first-offset="true"><span data-slate-string="true"> s_handle;   </span></span></span><span data-slate-object="text" data-key="19265"><span data-slate-leaf="true" data-offset-key="19265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 中断处理的回调函数指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19266"><span data-slate-object="text" data-key="19267"><span data-slate-leaf="true" data-offset-key="19267:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="19268"><span data-slate-leaf="true" data-offset-key="19268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="19269"><span data-slate-leaf="true" data-offset-key="19269:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19270"></div><div data-slate-type="code-line" data-slate-object="block" data-key="19271"><span data-slate-object="text" data-key="19272"><span data-slate-leaf="true" data-offset-key="19272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span></span><span data-slate-object="text" data-key="19273"><span data-slate-leaf="true" data-offset-key="19273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="19274"><span data-slate-leaf="true" data-offset-key="19274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krladd_irqhandle</span></span></span></span></span><span data-slate-object="text" data-key="19275"><span data-slate-leaf="true" data-offset-key="19275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19276"><span data-slate-leaf="true" data-offset-key="19276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19277"><span data-slate-leaf="true" data-offset-key="19277:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *device, </span></span></span></span></span><span data-slate-object="text" data-key="19278"><span data-slate-leaf="true" data-offset-key="19278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intflthandle_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19279"><span data-slate-leaf="true" data-offset-key="19279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> handle, </span></span></span></span></span><span data-slate-object="text" data-key="19280"><span data-slate-leaf="true" data-offset-key="19280:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19281"><span data-slate-leaf="true" data-offset-key="19281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> phyiline)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19282"><span data-slate-object="text" data-key="19283"><span data-slate-leaf="true" data-offset-key="19283:0" data-first-offset="true"><span data-slate-string="true">{    </span></span></span><span data-slate-object="text" data-key="19284"><span data-slate-leaf="true" data-offset-key="19284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据设备中断线返回对应中断异常描述符</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19285"><span data-slate-object="text" data-key="19286"><span data-slate-leaf="true" data-offset-key="19286:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19287"><span data-slate-leaf="true" data-offset-key="19287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intfltdsc_t</span></span></span></span><span data-slate-object="text" data-key="19288"><span data-slate-leaf="true" data-offset-key="19288:0" data-first-offset="true"><span data-slate-string="true"> *intp = </span></span></span><span data-slate-object="text" data-key="19289"><span data-slate-leaf="true" data-offset-key="19289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_retn_intfltdsc</span></span></span></span><span data-slate-object="text" data-key="19290"><span data-slate-leaf="true" data-offset-key="19290:0" data-first-offset="true"><span data-slate-string="true">(phyiline);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19291"><span data-slate-object="text" data-key="19292"><span data-slate-leaf="true" data-offset-key="19292:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19293"><span data-slate-leaf="true" data-offset-key="19293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19294"><span data-slate-leaf="true" data-offset-key="19294:0" data-first-offset="true"><span data-slate-string="true"> (intp == </span></span></span><span data-slate-object="text" data-key="19295"><span data-slate-leaf="true" data-offset-key="19295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19296"><span data-slate-leaf="true" data-offset-key="19296:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19297"><span data-slate-object="text" data-key="19298"><span data-slate-leaf="true" data-offset-key="19298:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19299"><span data-slate-object="text" data-key="19300"><span data-slate-leaf="true" data-offset-key="19300:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19301"><span data-slate-leaf="true" data-offset-key="19301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19302"><span data-slate-leaf="true" data-offset-key="19302:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19303"><span data-slate-leaf="true" data-offset-key="19303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19304"><span data-slate-leaf="true" data-offset-key="19304:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19305"><span data-slate-object="text" data-key="19306"><span data-slate-leaf="true" data-offset-key="19306:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19307"><span data-slate-object="text" data-key="19308"><span data-slate-leaf="true" data-offset-key="19308:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19309"><span data-slate-leaf="true" data-offset-key="19309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="19310"><span data-slate-leaf="true" data-offset-key="19310:0" data-first-offset="true"><span data-slate-string="true"> *serdscp = (</span></span></span><span data-slate-object="text" data-key="19311"><span data-slate-leaf="true" data-offset-key="19311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="19312"><span data-slate-leaf="true" data-offset-key="19312:0" data-first-offset="true"><span data-slate-string="true"> *)</span></span></span><span data-slate-object="text" data-key="19313"><span data-slate-leaf="true" data-offset-key="19313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew</span></span></span></span><span data-slate-object="text" data-key="19314"><span data-slate-leaf="true" data-offset-key="19314:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19315"><span data-slate-leaf="true" data-offset-key="19315:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="19316"><span data-slate-leaf="true" data-offset-key="19316:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19317"><span data-slate-leaf="true" data-offset-key="19317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="19318"><span data-slate-leaf="true" data-offset-key="19318:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span><span data-slate-object="text" data-key="19319"><span data-slate-leaf="true" data-offset-key="19319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立一个 intserdsc_t 结构体实例变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19320"><span data-slate-object="text" data-key="19321"><span data-slate-leaf="true" data-offset-key="19321:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19322"><span data-slate-leaf="true" data-offset-key="19322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19323"><span data-slate-leaf="true" data-offset-key="19323:0" data-first-offset="true"><span data-slate-string="true"> (serdscp == </span></span></span><span data-slate-object="text" data-key="19324"><span data-slate-leaf="true" data-offset-key="19324:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19325"><span data-slate-leaf="true" data-offset-key="19325:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19326"><span data-slate-object="text" data-key="19327"><span data-slate-leaf="true" data-offset-key="19327:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19328"><span data-slate-object="text" data-key="19329"><span data-slate-leaf="true" data-offset-key="19329:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19330"><span data-slate-leaf="true" data-offset-key="19330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19331"><span data-slate-leaf="true" data-offset-key="19331:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19332"><span data-slate-leaf="true" data-offset-key="19332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19333"><span data-slate-leaf="true" data-offset-key="19333:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19334"><span data-slate-object="text" data-key="19335"><span data-slate-leaf="true" data-offset-key="19335:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19336"><span data-slate-object="text" data-key="19337"><span data-slate-leaf="true" data-offset-key="19337:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19338"><span data-slate-leaf="true" data-offset-key="19338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 intserdsc_t 结构体实例变量，并把设备指针和回调函数放入其中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19339"><span data-slate-object="text" data-key="19340"><span data-slate-leaf="true" data-offset-key="19340:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19341"><span data-slate-leaf="true" data-offset-key="19341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t_init</span></span></span></span><span data-slate-object="text" data-key="19342"><span data-slate-leaf="true" data-offset-key="19342:0" data-first-offset="true"><span data-slate-string="true">(serdscp, </span></span></span><span data-slate-object="text" data-key="19343"><span data-slate-leaf="true" data-offset-key="19343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19344"><span data-slate-leaf="true" data-offset-key="19344:0" data-first-offset="true"><span data-slate-string="true">, intp, device, handle);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19345"><span data-slate-object="text" data-key="19346"><span data-slate-leaf="true" data-offset-key="19346:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19347"><span data-slate-leaf="true" data-offset-key="19347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 intserdsc_t 结构体实例变量挂载到中断异常描述符结构中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19348"><span data-slate-object="text" data-key="19349"><span data-slate-leaf="true" data-offset-key="19349:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19350"><span data-slate-leaf="true" data-offset-key="19350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19351"><span data-slate-leaf="true" data-offset-key="19351:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="19352"><span data-slate-leaf="true" data-offset-key="19352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_add_ihandle</span></span></span></span><span data-slate-object="text" data-key="19353"><span data-slate-leaf="true" data-offset-key="19353:0" data-first-offset="true"><span data-slate-string="true">(intp, serdscp) == FALSE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19354"><span data-slate-object="text" data-key="19355"><span data-slate-leaf="true" data-offset-key="19355:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19356"><span data-slate-object="text" data-key="19357"><span data-slate-leaf="true" data-offset-key="19357:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19358"><span data-slate-leaf="true" data-offset-key="19358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19359"><span data-slate-leaf="true" data-offset-key="19359:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="19360"><span data-slate-leaf="true" data-offset-key="19360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldelete</span></span></span></span><span data-slate-object="text" data-key="19361"><span data-slate-leaf="true" data-offset-key="19361:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="19362"><span data-slate-leaf="true" data-offset-key="19362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="19363"><span data-slate-leaf="true" data-offset-key="19363:0" data-first-offset="true"><span data-slate-string="true">)serdscp, </span></span></span><span data-slate-object="text" data-key="19364"><span data-slate-leaf="true" data-offset-key="19364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="19365"><span data-slate-leaf="true" data-offset-key="19365:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19366"><span data-slate-leaf="true" data-offset-key="19366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">intserdsc_t</span></span></span></span><span data-slate-object="text" data-key="19367"><span data-slate-leaf="true" data-offset-key="19367:0" data-first-offset="true"><span data-slate-string="true">)) == FALSE)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19368"><span data-slate-object="text" data-key="19369"><span data-slate-leaf="true" data-offset-key="19369:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19370"><span data-slate-object="text" data-key="19371"><span data-slate-leaf="true" data-offset-key="19371:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="19372"><span data-slate-leaf="true" data-offset-key="19372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_sysdie</span></span></span></span><span data-slate-object="text" data-key="19373"><span data-slate-leaf="true" data-offset-key="19373:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19374"><span data-slate-leaf="true" data-offset-key="19374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"krladd_irqhandle ERR"</span></span></span></span><span data-slate-object="text" data-key="19375"><span data-slate-leaf="true" data-offset-key="19375:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19376"><span data-slate-object="text" data-key="19377"><span data-slate-leaf="true" data-offset-key="19377:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19378"><span data-slate-object="text" data-key="19379"><span data-slate-leaf="true" data-offset-key="19379:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19380"><span data-slate-leaf="true" data-offset-key="19380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19381"><span data-slate-leaf="true" data-offset-key="19381:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19382"><span data-slate-leaf="true" data-offset-key="19382:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19383"><span data-slate-leaf="true" data-offset-key="19383:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19384"><span data-slate-object="text" data-key="19385"><span data-slate-leaf="true" data-offset-key="19385:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19386"><span data-slate-object="text" data-key="19387"><span data-slate-leaf="true" data-offset-key="19387:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19388"><span data-slate-leaf="true" data-offset-key="19388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19389"><span data-slate-leaf="true" data-offset-key="19389:0" data-first-offset="true"><span data-slate-string="true"> serdscp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19390"><span data-slate-object="text" data-key="19391"><span data-slate-leaf="true" data-offset-key="19391:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19392"><span data-slate-object="text" data-key="19393"><span data-slate-leaf="true" data-offset-key="19393:0" data-first-offset="true"><span data-slate-string="true">上述代码中 hal_add_ihandle、hal_retn_intfltdsc 函数，我已经帮你写好了，如果你不明白其中原理，可以回到初始化中断那节课看看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19394"><span data-slate-object="text" data-key="19395"><span data-slate-leaf="true" data-offset-key="19395:0" data-first-offset="true"><span data-slate-string="true">krladd_irqhandle 函数，它的主要工作是创建了一个 intserdsc_t 结构，用来保存设备和其驱动程序提供的中断回调函数。同时，我想提醒你，通过 intserdsc_t 结构也让中断处理框架和设备驱动联系起来了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19396"><span data-slate-object="text" data-key="19397"><span data-slate-leaf="true" data-offset-key="19397:0" data-first-offset="true"><span data-slate-string="true">这样一来，中断来了以后，后续的工作就能有序开展了。具体来说就是，中断处理框架既能找到对应的 intserdsc_t 结构，又能从 intserdsc_t 结构中得到中断回调函数和对应的设备描述符，从而调用中断回调函数，进行具体设备的中断处理。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="19398" id="sr-toc-9"><span data-slate-object="text" data-key="19399"><span data-slate-leaf="true" data-offset-key="19399:0" data-first-offset="true"><span data-slate-string="true">驱动加入内核</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="19400"><span data-slate-object="text" data-key="19401"><span data-slate-leaf="true" data-offset-key="19401:0" data-first-offset="true"><span data-slate-string="true">当操作系统内核调用了驱动程序入口函数，驱动程序入口函数就会进行一系列操作，包括建立设备，安装中断回调函数等等，再之后就会返回到操作系统内核。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19402"><span data-slate-object="text" data-key="19403"><span data-slate-leaf="true" data-offset-key="19403:0" data-first-offset="true"><span data-slate-string="true">接下来，操作系统内核会根据返回状态，决定是否将该驱动程序加入到操作系统内核中。你可以这样理解，所谓将驱动程序加入到操作系统内核，无非就是</span></span></span><span data-slate-object="text" data-key="19404"><span data-slate-leaf="true" data-offset-key="19404:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">将 driver_t 结构的实例变量挂载到设备表中</span></span></span></span><span data-slate-object="text" data-key="19405"><span data-slate-leaf="true" data-offset-key="19405:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19406"><span data-slate-object="text" data-key="19407"><span data-slate-leaf="true" data-offset-key="19407:0" data-first-offset="true"><span data-slate-string="true">下面我们就来写这个实现挂载功能的函数，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="19408"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19409"><span data-slate-object="text" data-key="19410"><span data-slate-leaf="true" data-offset-key="19410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19411"><span data-slate-leaf="true" data-offset-key="19411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19412"><span data-slate-leaf="true" data-offset-key="19412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldriver_add_system</span></span></span></span></span><span data-slate-object="text" data-key="19413"><span data-slate-leaf="true" data-offset-key="19413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19414"><span data-slate-leaf="true" data-offset-key="19414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">driver_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19415"><span data-slate-leaf="true" data-offset-key="19415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *drvp)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19416"><span data-slate-object="text" data-key="19417"><span data-slate-leaf="true" data-offset-key="19417:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19418"><span data-slate-object="text" data-key="19419"><span data-slate-leaf="true" data-offset-key="19419:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19420"><span data-slate-leaf="true" data-offset-key="19420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cpuflg_t</span></span></span></span><span data-slate-object="text" data-key="19421"><span data-slate-leaf="true" data-offset-key="19421:0" data-first-offset="true"><span data-slate-string="true"> cpufg;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19422"><span data-slate-object="text" data-key="19423"><span data-slate-leaf="true" data-offset-key="19423:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19424"><span data-slate-leaf="true" data-offset-key="19424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">devtable_t</span></span></span></span><span data-slate-object="text" data-key="19425"><span data-slate-leaf="true" data-offset-key="19425:0" data-first-offset="true"><span data-slate-string="true"> *dtbp = &amp;osdevtable;</span></span></span><span data-slate-object="text" data-key="19426"><span data-slate-leaf="true" data-offset-key="19426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19427"><span data-slate-object="text" data-key="19428"><span data-slate-leaf="true" data-offset-key="19428:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19429"><span data-slate-leaf="true" data-offset-key="19429:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinlock_cli</span></span></span></span><span data-slate-object="text" data-key="19430"><span data-slate-leaf="true" data-offset-key="19430:0" data-first-offset="true"><span data-slate-string="true">(&amp;dtbp-&gt;devt_lock, &amp;cpufg);</span></span></span><span data-slate-object="text" data-key="19431"><span data-slate-leaf="true" data-offset-key="19431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19432"><span data-slate-object="text" data-key="19433"><span data-slate-leaf="true" data-offset-key="19433:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19434"><span data-slate-leaf="true" data-offset-key="19434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_add</span></span></span></span><span data-slate-object="text" data-key="19435"><span data-slate-leaf="true" data-offset-key="19435:0" data-first-offset="true"><span data-slate-string="true">(&amp;drvp-&gt;drv_list, &amp;dtbp-&gt;devt_drvlist);</span></span></span><span data-slate-object="text" data-key="19436"><span data-slate-leaf="true" data-offset-key="19436:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 挂载</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19437"><span data-slate-object="text" data-key="19438"><span data-slate-leaf="true" data-offset-key="19438:0" data-first-offset="true"><span data-slate-string="true">    dtbp-&gt;devt_drvnr++;</span></span></span><span data-slate-object="text" data-key="19439"><span data-slate-leaf="true" data-offset-key="19439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 增加驱动程序计数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19440"><span data-slate-object="text" data-key="19441"><span data-slate-leaf="true" data-offset-key="19441:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19442"><span data-slate-leaf="true" data-offset-key="19442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlspinunlock_sti</span></span></span></span><span data-slate-object="text" data-key="19443"><span data-slate-leaf="true" data-offset-key="19443:0" data-first-offset="true"><span data-slate-string="true">(&amp;dtbp-&gt;devt_lock, &amp;cpufg);</span></span></span><span data-slate-object="text" data-key="19444"><span data-slate-leaf="true" data-offset-key="19444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19445"><span data-slate-object="text" data-key="19446"><span data-slate-leaf="true" data-offset-key="19446:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19447"><span data-slate-leaf="true" data-offset-key="19447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19448"><span data-slate-leaf="true" data-offset-key="19448:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19449"><span data-slate-object="text" data-key="19450"><span data-slate-leaf="true" data-offset-key="19450:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19451"><span data-slate-object="text" data-key="19452"><span data-slate-leaf="true" data-offset-key="19452:0" data-first-offset="true"><span data-slate-string="true">配合代码中的注释，相信这里的思路你很容易就能领会。由于驱动程序不需要分门别类，所以我们只把它挂载到设备表中一个全局驱动程序链表上就行了，最后简单地增加一下驱动程序计数变量，用来表明有多少个驱动程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19453"><span data-slate-object="text" data-key="19454"><span data-slate-leaf="true" data-offset-key="19454:0" data-first-offset="true"><span data-slate-string="true">好了，现在我们操作系统内核向驱动程序开发人员提供的大部分功能接口就实现了。你自己也可以写驱动程序试试，看看是否只需要关注设备本身，而无须关注操作系统其它的部件。这就是我们 Cosmos 的驱动模型，虽然做了简化，但麻雀虽小，五脏俱全。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19455" id="sr-toc-10"><span data-slate-object="text" data-key="19456"><span data-slate-leaf="true" data-offset-key="19456:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19457"><span data-slate-object="text" data-key="19458"><span data-slate-leaf="true" data-offset-key="19458:0" data-first-offset="true"><span data-slate-string="true">又到了课程结束的时候，今天我们通过这节课已经了解到，一个驱动程序开始是由内核加载运行，然后调用由内核提供的接口建立设备，最后向内核注册设备和驱动，完成驱动和内核的握手动作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19459"><span data-slate-object="text" data-key="19460"><span data-slate-leaf="true" data-offset-key="19460:0" data-first-offset="true"><span data-slate-string="true">现在我们来梳理一下这节课的重点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19461"><span data-slate-object="text" data-key="19462"><span data-slate-leaf="true" data-offset-key="19462:0" data-first-offset="true"><span data-slate-string="true">首先我们一开始从全局出发，了解了设备的建立流程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19463"><span data-slate-object="text" data-key="19464"><span data-slate-leaf="true" data-offset-key="19464:0" data-first-offset="true"><span data-slate-string="true">然后为了简化内核加载驱动程序的复杂性，我们设计了一个驱动程序表。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19465"><span data-slate-object="text" data-key="19466"><span data-slate-leaf="true" data-offset-key="19466:0" data-first-offset="true"><span data-slate-string="true">最后，按照驱动程序的开发流程，我们给驱动程序开发者提供了一系列接口，它们是建立注册设备、设备加入驱动、安装中断回调函数，驱动加入到系统等，这些共同构成了一个最简化的驱动模型。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19467"><span data-slate-object="text" data-key="19468"><span data-slate-leaf="true" data-offset-key="19468:0" data-first-offset="true"><span data-slate-string="true">你可能会感觉我们虽然解决了建立设备的问题，可是怎么使用呢？这正是我们下一课要讨论的，敬请期待。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19469" id="sr-toc-11"><span data-slate-object="text" data-key="19470"><span data-slate-leaf="true" data-offset-key="19470:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19471"><span data-slate-object="text" data-key="19472"><span data-slate-leaf="true" data-offset-key="19472:0" data-first-offset="true"><span data-slate-string="true">请你写出帮驱动程序开发者自动分配设备 ID 接口函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19473"><span data-slate-object="text" data-key="19474"><span data-slate-leaf="true" data-offset-key="19474:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区和我交流互动。也欢迎你把这节课分享给自己的同事、朋友。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19475"><span data-slate-object="text" data-key="19476"><span data-slate-leaf="true" data-offset-key="19476:0" data-first-offset="true"><span data-slate-string="true">好，我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-12">精选留言 (6)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>
一、数据结构
有一个全局的 drventyexit_t 数组变量 osdrvetytabl，用于保存全部驱动程序入口函数
主要是为了便于理解，通过全局数组方式枚举并加载驱动，不需要涉及动态加载内核模块的相关内容

二、初始化
init_krl-&gt;init_krldriver
遍历驱动程序表中的每个驱动程序入口，并把它作为参数传给 krlrun_driverentry 函数

在 krlrun_driverentry 函数中
-&gt;new_driver_dsc-&gt;driver_t_init，初始化驱动结构，驱动处理函数默认指向 drv_defalt_func
-&gt;drventry，调用驱动入口函数
-&gt;krldriver_add_system 只需要将驱动加入设备表的驱动链表就好了

其中，在驱动入口函数 drventry 中【systick_entry 为例】：
-&gt; 建立设备描述符结构
-&gt; 将驱动程序的功能函数指针，设置到 driver_t 结构中的 drv_dipfun 数组中
-&gt; 将设备挂载到驱动中
-&gt; 调用 krlnew_device 向内核注册设备
-&gt;-&gt; 确认没有相同设备 ID，注册到对应设备类型的列表以及全局设备列表

-&gt; 调用 krlnew_devhandle-&gt;krladd_irqhandle，安装中断回调函数 systick_handle
-&gt;-&gt; 获取设备中断 phyiline 对应的中断异常描述符 intfltdsc_t 结构中
-&gt;-&gt; 新建一个 intserdsc_t 结构体
-&gt;-&gt; 初始化结构体，并设置好回调函数
-&gt;-&gt; 将新的 intserdsc_t 结构体挂载到对应的 intfltdsc_t 结构中
-&gt;-&gt; 也就是把驱动程序的中断处理回到函数，加入到了对应中断处理回调函数链表中

-&gt; 初始化物理设备
-&gt; 启用中断</div><div><p>作者回复：老哥 总结的很好</p></div><div><div>2021-07-19</div><div><div><i></i></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>想复杂了，应该可以这样实现，全局定义一个 device_id =0，获取 id 的时候返回该值，然后 ++，注意加锁。
早上看的时候犯迷糊了😂</div><div><p>作者回复：哈哈</p></div><div><div>2021-07-14</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/20/8b/48/ea3f84f3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>O 俊</span></div></div><div>内核会调用驱动的接口，如果驱动做死循环不返回内核咋办。</div><div><p>作者回复：可以使用看门狗定时器来解决</p></div><div><div>2021-09-23</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>uint_t device_id(device_t *devp) {
    return devp-&gt;dev_intlnenr
}</div><div><p>作者回复：这不行哦 </p></div><div><div>2021-07-14</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 艾恩凝</span></div></div><div>打卡，</div><div><p>编辑回复：速度很快嘛，加油加油～</p></div><div><div>2022-05-08</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/04/60/64d166b6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Fan</span></div></div><div>代码没看懂，看懂的大致的流程。😂</div><div><p>作者回复：加油 哈哈 </p></div><div><div>2021-08-03</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".y"><outline class="toc-level-h1" data-reactid=".y.0" style="width: 175px;"><active data-reactid=".y.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".y.0.1"><span data-reactid=".y.0.1.0">29 | 部门建立：如何在内核中注册设备？</span></a></outline><outline class="toc-level-h2" data-reactid=".y.1" style="width: 165px;"><active data-reactid=".y.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".y.1.1"><span data-reactid=".y.1.1.0">设备的注册流程</span></a></outline><outline class="toc-level-h2" data-reactid=".y.2" style="width: 165px;"><active data-reactid=".y.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".y.2.1"><span data-reactid=".y.2.1.0">驱动程序表</span></a></outline><outline class="toc-level-h2" data-reactid=".y.3" style="width: 165px;"><active data-reactid=".y.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".y.3.1"><span data-reactid=".y.3.1.0">运行驱动程序</span></a></outline><outline class="toc-level-h3" data-reactid=".y.4" style="width: 155px;"><active data-reactid=".y.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".y.4.1"><span data-reactid=".y.4.1.0">调用驱动程序入口函数</span></a></outline><outline class="toc-level-h3" data-reactid=".y.5" style="width: 155px;"><active data-reactid=".y.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".y.5.1"><span data-reactid=".y.5.1.0">一个驱动程序入口函数的例子</span></a></outline><outline class="toc-level-h3" data-reactid=".y.6" style="width: 155px;"><active data-reactid=".y.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".y.6.1"><span data-reactid=".y.6.1.0">设备与驱动的联系</span></a></outline><outline class="toc-level-h3" data-reactid=".y.7" style="width: 155px;"><active data-reactid=".y.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".y.7.1"><span data-reactid=".y.7.1.0">向内核注册设备</span></a></outline><outline class="toc-level-h3" data-reactid=".y.8" style="width: 155px;"><active data-reactid=".y.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".y.8.1"><span data-reactid=".y.8.1.0">安装中断回调函数</span></a></outline><outline class="toc-level-h3" data-reactid=".y.9" style="width: 155px;"><active data-reactid=".y.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".y.9.1"><span data-reactid=".y.9.1.0">驱动加入内核</span></a></outline><outline class="toc-level-h2" data-reactid=".y.a" style="width: 165px;"><active data-reactid=".y.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".y.a.1"><span data-reactid=".y.a.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".y.b" style="width: 165px;"><active data-reactid=".y.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".y.b.1"><span data-reactid=".y.b.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".y.c" style="width: 165px;"><active data-reactid=".y.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".y.c.1"><span data-reactid=".y.c.1.0">精选留言 (6)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/394875" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>