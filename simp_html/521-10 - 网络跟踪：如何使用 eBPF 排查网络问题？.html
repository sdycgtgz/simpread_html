
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 10 | 网络跟踪：如何使用 eBPF 排查网络问题？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>10 | 网络跟踪：如何使用 eBPF 排查网络问题？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">10 | 网络跟踪：如何使用 eBPF 排查网络问题？</h1><div><span>倪朋飞</span> <span> 2022-02-07</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/76/f0/76c0670490587bbcd0ce0889d56dd3f0.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：山荣</span><span>大小：15.87M</span><span> 时长：17:22</span></div></div><audio title="10 | 网络跟踪：如何使用 eBPF 排查网络问题？" src="https://res001.geekbang.org/media/audio/24/d4/24f461c1d2420b39cca5d794e00f1dd4/ld/ld.m3u8" __idm_id__="434187"></audio></div><div><div><div><div data-slate-editor="true" data-key="6047" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="6048"><span data-slate-object="text" data-key="6049"><span data-slate-leaf="true" data-offset-key="6049:0" data-first-offset="true"><span data-slate-string="true">你好，我是倪朋飞。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6050"><span data-slate-object="text" data-key="6051"><span data-slate-leaf="true" data-offset-key="6051:0" data-first-offset="true"><span data-slate-string="true">上一讲，我带你一起梳理了应用进程的跟踪方法。根据编程语言的不同，从应用程序二进制文件的跟踪点中可以获取的信息也不同：编译型语言程序中的符号信息可以直接拿来跟踪应用的执行状态，而对于解释型语言和即时编译型语言程序，我们只能从解释器或即时编译器的跟踪点参数中去获取应用的执行状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6052"><span data-slate-object="text" data-key="6053"><span data-slate-leaf="true" data-offset-key="6053:0" data-first-offset="true"><span data-slate-string="true">除了前面三讲提到的内核和应用程序的跟踪之外，网络不仅是 eBPF 应用最早的领域，也是目前 eBPF 应用最为广泛的一个领域。随着分布式系统、云计算和云原生应用的普及，网络已经成为了大部分应用最核心的依赖，随之而来的网络问题也是最难排查的问题之一。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6054"><span data-slate-object="text" data-key="6055"><span data-slate-leaf="true" data-offset-key="6055:0" data-first-offset="true"><span data-slate-string="true">那么，eBPF 能不能协助我们更好地排查和定位网络问题呢？我们又该如何利用 eBPF 来排查网络相关的问题呢？今天，我就带你一起具体看看。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6056" id="sr-toc-1"><span data-slate-object="text" data-key="6057"><span data-slate-leaf="true" data-offset-key="6057:0" data-first-offset="true"><span data-slate-string="true">eBPF 提供了哪些网络功能？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6058"><span data-slate-object="text" data-key="6059"><span data-slate-leaf="true" data-offset-key="6059:0" data-first-offset="true"><span data-slate-string="true">既然想要使用 eBPF 排查网络问题，我想进入你头脑的第一个问题就是：eBPF 到底提供了哪些网络相关的功能框架呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6060"><span data-slate-object="text" data-key="6061"><span data-slate-leaf="true" data-offset-key="6061:0" data-first-offset="true"><span data-slate-string="true">要回答这个问题，首先要理解 Linux 网络协议栈的基本原理。下面是一个简化版的内核协议栈示意图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6062"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/ce/a5/ce9371b7e3b696feaf4233c1595e20a5.jpg?wh=1920x2960"></div><div>Linux 内核协议栈</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6063"><span data-slate-object="text" data-key="6064"><span data-slate-leaf="true" data-offset-key="6064:0" data-first-offset="true"><span data-slate-string="true">如何理解这个网络栈示意图呢？从上往下看，就是应用程序发送网络包的过程；而反过来，从下往上看，则是网络包接收的过程。比如，从上到下来看这个网络栈，你可以发现：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6065"><div data-slate-type="list-line" data-slate-object="block" data-key="6066"><span data-slate-object="text" data-key="6067"><span data-slate-leaf="true" data-offset-key="6067:0" data-first-offset="true"><span data-slate-string="true">应用程序会通过系统调用来跟套接字接口进行交互；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6068"><span data-slate-object="text" data-key="6069"><span data-slate-leaf="true" data-offset-key="6069:0" data-first-offset="true"><span data-slate-string="true">套接字的下面，就是内核协议栈中的传输层、网络层和网络接口层，这其中也包含了网络过滤（Netfilter）和流量控制（Traffic Control）框架；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6070"><span data-slate-object="text" data-key="6071"><span data-slate-leaf="true" data-offset-key="6071:0" data-first-offset="true"><span data-slate-string="true">最底层，则是网卡驱动程序以及物理网卡设备。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6072"><span data-slate-object="text" data-key="6073"><span data-slate-leaf="true" data-offset-key="6073:0" data-first-offset="true"><span data-slate-string="true">理解了网络协议栈的基本流程，eBPF 提供的网络功能也就容易理解了。如下图所示，eBPF 实际上提供了贯穿整个网络协议栈的过滤、捕获以及重定向等丰富的网络功能：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6074"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/80/50/80c2a8fe3b36ee2fb033b4332431f750.jpg?wh=2284x2197"></div><div>内核协议栈 BPF 挂载点</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6075"><span data-slate-object="text" data-key="6076"><span data-slate-leaf="true" data-offset-key="6076:0" data-first-offset="true"><span data-slate-string="true">一方面，网络协议栈也是内核的一部分，因而</span></span></span><span data-slate-object="text" data-key="6077"><span data-slate-leaf="true" data-offset-key="6077:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">网络相关的内核函数、跟踪点以及用户程序的函数等，也都可以使用前几讲我们提到的 kprobe、uprobe、USDT 等跟踪类 eBPF 程序进行跟踪</span></span></span></span><span data-slate-object="text" data-key="6078"><span data-slate-leaf="true" data-offset-key="6078:0" data-first-offset="true"><span data-slate-string="true">（如上图中紫色部分所示）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6079"><span data-slate-object="text" data-key="6080"><span data-slate-leaf="true" data-offset-key="6080:0" data-first-offset="true"><span data-slate-string="true">另一方面，回顾一下 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6081"><span data-slate-object="text" data-key="6082"><span data-slate-leaf="true" data-offset-key="6082:0" data-first-offset="true"><span data-slate-string="true">06 讲</span></span></span></a><span data-slate-object="text" data-key="6083"><span data-slate-leaf="true" data-offset-key="6083:0" data-first-offset="true"><span data-slate-string="true"> 的内容，</span></span></span><span data-slate-object="text" data-key="6084"><span data-slate-leaf="true" data-offset-key="6084:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">eBPF 提供了大量专用于网络的 eBPF 程序类型，包括 XDP 程序、TC 程序、套接字程序以及 cgroup 程序等</span></span></span></span><span data-slate-object="text" data-key="6085"><span data-slate-leaf="true" data-offset-key="6085:0" data-first-offset="true"><span data-slate-string="true">。这些类型的程序涵盖了从网卡（如卸载到硬件网卡中的 XDP 程序）到网卡队列（如 TC 程序）、封装路由（如轻量级隧道程序）、TCP 拥塞控制、套接字（如 sockops 程序）等内核协议栈，再到同属于一个 cgroup 的一组进程的网络过滤和控制，而这些都是内核协议栈的核心组成部分（如上图中绿色部分所示）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6086"><span data-slate-object="text" data-key="6087"><span data-slate-leaf="true" data-offset-key="6087:0" data-first-offset="true"><span data-slate-string="true">从这两个方面，你可以发现 eBPF 已经涵盖了内核协议栈的很多方面，并且内核社区在网络方面的功能还在不断丰富中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6088"><span data-slate-object="text" data-key="6089"><span data-slate-leaf="true" data-offset-key="6089:0" data-first-offset="true"><span data-slate-string="true">接下来，我就以最常见的网络丢包为例，带你看看如何使用 eBPF 来排查网络问题。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6090" id="sr-toc-2"><span data-slate-object="text" data-key="6091"><span data-slate-leaf="true" data-offset-key="6091:0" data-first-offset="true"><span data-slate-string="true">如何跟踪内核网络协议栈？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6092"><span data-slate-object="text" data-key="6093"><span data-slate-leaf="true" data-offset-key="6093:0" data-first-offset="true"><span data-slate-string="true">即使理解了内核协议栈的基本原理，以及各种类型 eBPF 程序的基本功能，在想要跟踪网络相关的问题时，你可能还是觉得无从下手，这是为什么呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6094"><span data-slate-object="text" data-key="6095"><span data-slate-leaf="true" data-offset-key="6095:0" data-first-offset="true"><span data-slate-string="true">究其原因，我认为最主要是因为</span></span></span><span data-slate-object="text" data-key="6096"><span data-slate-leaf="true" data-offset-key="6096:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不清楚内核中都有哪些函数和跟踪点可以拿来跟踪</span></span></span></span><span data-slate-object="text" data-key="6097"><span data-slate-leaf="true" data-offset-key="6097:0" data-first-offset="true"><span data-slate-string="true">。而即使通过源码查询到了一系列的内核函数，还是没有一个清晰的思路把这些内核函数与所碰到的网络问题关联起来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6098"><span data-slate-object="text" data-key="6099"><span data-slate-leaf="true" data-offset-key="6099:0" data-first-offset="true"><span data-slate-string="true">不过，当你碰到这类困惑的时候不要有畏难心理。要知道，所有非内核开发者都会碰到类似的问题，而解决这类问题也并非难事，下面我们就来看解决方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6100"><span data-slate-object="text" data-key="6101"><span data-slate-leaf="true" data-offset-key="6101:0" data-first-offset="true"><span data-slate-string="true">如何把内核函数跟相关的网络问题关联起来呢？看到本小节的标题，你应该已经想到了：跟踪调用栈，</span></span></span><span data-slate-object="text" data-key="6102"><span data-slate-leaf="true" data-offset-key="6102:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">根据调用栈回溯路径</span></span></span></span><span data-slate-object="text" data-key="6103"><span data-slate-leaf="true" data-offset-key="6103:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">，</span></span></span></span><span data-slate-object="text" data-key="6104"><span data-slate-leaf="true" data-offset-key="6104:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">找出导致某个网络事件发生的整个流程，进而就可以再根据这些流程中的内核函数进一步跟踪</span></span></span></span><span data-slate-object="text" data-key="6105"><span data-slate-leaf="true" data-offset-key="6105:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6106"><span data-slate-object="text" data-key="6107"><span data-slate-leaf="true" data-offset-key="6107:0" data-first-offset="true"><span data-slate-string="true">既然是调用栈的</span></span></span><span data-slate-object="text" data-key="6108"><span data-slate-leaf="true" data-offset-key="6108:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">回溯</span></span></span></span><span data-slate-object="text" data-key="6109"><span data-slate-leaf="true" data-offset-key="6109:0" data-first-offset="true"><span data-slate-string="true">，只有我们知道了最接近整个执行逻辑结尾的函数，才有可能开始这个回溯过程。对 Linux 网络丢包问题来说，内核协议栈执行的结尾，当然就是释放最核心的 SKB（Socket Buffer）数据结构。查询内核 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6110"><span data-slate-object="text" data-key="6111"><span data-slate-leaf="true" data-offset-key="6111:0" data-first-offset="true"><span data-slate-string="true">SKB 文档</span></span></span></a><span data-slate-object="text" data-key="6112"><span data-slate-leaf="true" data-offset-key="6112:0" data-first-offset="true"><span data-slate-string="true">，你可以发现，内核中释放 SKB 相关的函数有两个：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6113"><div data-slate-type="list-line" data-slate-object="block" data-key="6114"><span data-slate-object="text" data-key="6115"><span data-slate-leaf="true" data-offset-key="6115:0" data-first-offset="true"><span data-slate-string="true">第一个，</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6116"><span data-slate-object="text" data-key="6117"><span data-slate-leaf="true" data-offset-key="6117:0" data-first-offset="true"><span data-slate-string="true">kfree_skb</span></span></span></a><span data-slate-object="text" data-key="6118"><span data-slate-leaf="true" data-offset-key="6118:0" data-first-offset="true"><span data-slate-string="true"> ，它经常在网络异常丢包时调用；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6119"><span data-slate-object="text" data-key="6120"><span data-slate-leaf="true" data-offset-key="6120:0" data-first-offset="true"><span data-slate-string="true">第二个，</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6121"><span data-slate-object="text" data-key="6122"><span data-slate-leaf="true" data-offset-key="6122:0" data-first-offset="true"><span data-slate-string="true">consume_skb</span></span></span></a><span data-slate-object="text" data-key="6123"><span data-slate-leaf="true" data-offset-key="6123:0" data-first-offset="true"><span data-slate-string="true"> ，它在正常网络连接完成时调用。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6124"><span data-slate-object="text" data-key="6125"><span data-slate-leaf="true" data-offset-key="6125:0" data-first-offset="true"><span data-slate-string="true">这两个函数除了使用场景的不同，其功能和实现流程都是一样的，即都是检查 SKB 的引用计数，当引用计数为 0 时释放其内核内存。所以，要跟踪网络丢包的执行过程，也就可以跟踪 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6126"><span data-slate-object="text" data-key="6127"><span data-slate-leaf="true" data-offset-key="6127:0" data-first-offset="true"><span data-slate-string="true">kfree_skb</span></span></span></span><span data-slate-object="text" data-key="6128"><span data-slate-leaf="true" data-offset-key="6128:0" data-first-offset="true"><span data-slate-string="true"> 的内核调用栈。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6129"><span data-slate-object="text" data-key="6130"><span data-slate-leaf="true" data-offset-key="6130:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">接下来，我就以访问极客时间的网站 </span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6131"><span data-slate-object="text" data-key="6132"><span data-slate-leaf="true" data-offset-key="6132:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">time.geekbang.org</span></span></span></span></span><span data-slate-object="text" data-key="6133"><span data-slate-leaf="true" data-offset-key="6133:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true"> 为例，来带你一起看看</span></span></span></span><span data-slate-object="text" data-key="6134"><span data-slate-leaf="true" data-offset-key="6134:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">，</span></span></span></span><span data-slate-object="text" data-key="6135"><span data-slate-leaf="true" data-offset-key="6135:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如何使用 bpftrace 来进行调用栈的跟踪。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6136"><span data-slate-object="text" data-key="6137"><span data-slate-leaf="true" data-offset-key="6137:0" data-first-offset="true"><span data-slate-string="true">为了方便调用栈的跟踪，bpftrace 提供了 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6138"><span data-slate-object="text" data-key="6139"><span data-slate-leaf="true" data-offset-key="6139:0" data-first-offset="true"><span data-slate-string="true">kstack</span></span></span></a><span data-slate-object="text" data-key="6140"><span data-slate-leaf="true" data-offset-key="6140:0" data-first-offset="true"><span data-slate-string="true"> 和 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6141"><span data-slate-object="text" data-key="6142"><span data-slate-leaf="true" data-offset-key="6142:0" data-first-offset="true"><span data-slate-string="true">ustack</span></span></span></a><span data-slate-object="text" data-key="6143"><span data-slate-leaf="true" data-offset-key="6143:0" data-first-offset="true"><span data-slate-string="true"> 这两个内置变量，分别用于获取内核和进程的调用栈。打开一个终端，执行下面的命令就可以跟踪 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6144"><span data-slate-object="text" data-key="6145"><span data-slate-leaf="true" data-offset-key="6145:0" data-first-offset="true"><span data-slate-string="true">kfree_skb</span></span></span></span><span data-slate-object="text" data-key="6146"><span data-slate-leaf="true" data-offset-key="6146:0" data-first-offset="true"><span data-slate-string="true"> 的内核调用栈了：</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="6147"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6148"><span data-slate-object="text" data-key="6149"><span data-slate-leaf="true" data-offset-key="6149:0" data-first-offset="true"><span data-slate-string="true">sudo bpftrace -e </span></span></span><span data-slate-object="text" data-key="6150"><span data-slate-leaf="true" data-offset-key="6150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'kprobe</span></span></span></span><span data-slate-object="text" data-key="6151"><span data-slate-leaf="true" data-offset-key="6151:0" data-first-offset="true"><span data-slate-string="true">:kfree_skb /comm==</span></span></span><span data-slate-object="text" data-key="6152"><span data-slate-leaf="true" data-offset-key="6152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"curl"</span></span></span></span><span data-slate-object="text" data-key="6153"><span data-slate-leaf="true" data-offset-key="6153:0" data-first-offset="true"><span data-slate-string="true">/ {</span></span></span><span data-slate-object="text" data-key="6154"><span data-slate-leaf="true" data-offset-key="6154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">printf</span></span></span></span><span data-slate-object="text" data-key="6155"><span data-slate-leaf="true" data-offset-key="6155:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="6156"><span data-slate-leaf="true" data-offset-key="6156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"kstack: %s\n"</span></span></span></span><span data-slate-object="text" data-key="6157"><span data-slate-leaf="true" data-offset-key="6157:0" data-first-offset="true"><span data-slate-string="true">, kstack);}'</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6158"><span data-slate-object="text" data-key="6159"><span data-slate-leaf="true" data-offset-key="6159:0" data-first-offset="true"><span data-slate-string="true">这个命令中的具体内容含义如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6160"><div data-slate-type="list-line" data-slate-object="block" data-key="6161"><span data-slate-type="code" data-slate-object="inline" data-key="6162"><span data-slate-object="text" data-key="6163"><span data-slate-leaf="true" data-offset-key="6163:0" data-first-offset="true"><span data-slate-string="true">kprobe:kfree_skb</span></span></span></span><span data-slate-object="text" data-key="6164"><span data-slate-leaf="true" data-offset-key="6164:0" data-first-offset="true"><span data-slate-string="true"> 指定跟踪的内核函数为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6165"><span data-slate-object="text" data-key="6166"><span data-slate-leaf="true" data-offset-key="6166:0" data-first-offset="true"><span data-slate-string="true">kfree_skb</span></span></span></span><span data-slate-object="text" data-key="6167"><span data-slate-leaf="true" data-offset-key="6167:0" data-first-offset="true"><span data-slate-string="true">；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6168"><span data-slate-object="text" data-key="6169"><span data-slate-leaf="true" data-offset-key="6169:0" data-first-offset="true"><span data-slate-string="true">紧随其后的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6170"><span data-slate-object="text" data-key="6171"><span data-slate-leaf="true" data-offset-key="6171:0" data-first-offset="true"><span data-slate-string="true">/comm=="curl"/</span></span></span></span><span data-slate-object="text" data-key="6172"><span data-slate-leaf="true" data-offset-key="6172:0" data-first-offset="true"><span data-slate-string="true"> ，表示只跟踪 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6173"><span data-slate-object="text" data-key="6174"><span data-slate-leaf="true" data-offset-key="6174:0" data-first-offset="true"><span data-slate-string="true">curl</span></span></span></span><span data-slate-object="text" data-key="6175"><span data-slate-leaf="true" data-offset-key="6175:0" data-first-offset="true"><span data-slate-string="true"> 进程，这是为了过滤掉其他不相关的进程操作；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6176"><span data-slate-object="text" data-key="6177"><span data-slate-leaf="true" data-offset-key="6177:0" data-first-offset="true"><span data-slate-string="true">最后的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6178"><span data-slate-object="text" data-key="6179"><span data-slate-leaf="true" data-offset-key="6179:0" data-first-offset="true"><span data-slate-string="true">printf()</span></span></span></span><span data-slate-object="text" data-key="6180"><span data-slate-leaf="true" data-offset-key="6180:0" data-first-offset="true"><span data-slate-string="true"> 函数就是把内核协议栈打印到终端中。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6181"><span data-slate-object="text" data-key="6182"><span data-slate-leaf="true" data-offset-key="6182:0" data-first-offset="true"><span data-slate-string="true">打开一个新终端，并在终端中执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6183"><span data-slate-object="text" data-key="6184"><span data-slate-leaf="true" data-offset-key="6184:0" data-first-offset="true"><span data-slate-string="true">curl time.geekbang.org</span></span></span></span><span data-slate-object="text" data-key="6185"><span data-slate-leaf="true" data-offset-key="6185:0" data-first-offset="true"><span data-slate-string="true"> 命令，然后回到第一个终端，就可以看到如下的输出：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="6186"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6187"><span data-slate-object="text" data-key="6188"><span data-slate-leaf="true" data-offset-key="6188:0" data-first-offset="true"><span data-slate-string="true">kstack:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6189"><span data-slate-object="text" data-key="6190"><span data-slate-leaf="true" data-offset-key="6190:0" data-first-offset="true"><span data-slate-string="true">        kfree_skb+1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6191"><span data-slate-object="text" data-key="6192"><span data-slate-leaf="true" data-offset-key="6192:0" data-first-offset="true"><span data-slate-string="true">        udpv6_destroy_sock+66</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6193"><span data-slate-object="text" data-key="6194"><span data-slate-leaf="true" data-offset-key="6194:0" data-first-offset="true"><span data-slate-string="true">        sk_common_release+34</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6195"><span data-slate-object="text" data-key="6196"><span data-slate-leaf="true" data-offset-key="6196:0" data-first-offset="true"><span data-slate-string="true">        udp_lib_close+9</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6197"><span data-slate-object="text" data-key="6198"><span data-slate-leaf="true" data-offset-key="6198:0" data-first-offset="true"><span data-slate-string="true">        inet_release+75</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6199"><span data-slate-object="text" data-key="6200"><span data-slate-leaf="true" data-offset-key="6200:0" data-first-offset="true"><span data-slate-string="true">        inet6_release+49</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6201"><span data-slate-object="text" data-key="6202"><span data-slate-leaf="true" data-offset-key="6202:0" data-first-offset="true"><span data-slate-string="true">        __sock_release+66</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6203"><span data-slate-object="text" data-key="6204"><span data-slate-leaf="true" data-offset-key="6204:0" data-first-offset="true"><span data-slate-string="true">        sock_close+21</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6205"><span data-slate-object="text" data-key="6206"><span data-slate-leaf="true" data-offset-key="6206:0" data-first-offset="true"><span data-slate-string="true">        __fput+159</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6207"><span data-slate-object="text" data-key="6208"><span data-slate-leaf="true" data-offset-key="6208:0" data-first-offset="true"><span data-slate-string="true">        ____fput+14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6209"><span data-slate-object="text" data-key="6210"><span data-slate-leaf="true" data-offset-key="6210:0" data-first-offset="true"><span data-slate-string="true">        task_work_run+103</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6211"><span data-slate-object="text" data-key="6212"><span data-slate-leaf="true" data-offset-key="6212:0" data-first-offset="true"><span data-slate-string="true">        exit_to_user_mode_loop+411</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6213"><span data-slate-object="text" data-key="6214"><span data-slate-leaf="true" data-offset-key="6214:0" data-first-offset="true"><span data-slate-string="true">        exit_to_user_mode_prepare+187</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6215"><span data-slate-object="text" data-key="6216"><span data-slate-leaf="true" data-offset-key="6216:0" data-first-offset="true"><span data-slate-string="true">        syscall_exit_to_user_mode+23</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6217"><span data-slate-object="text" data-key="6218"><span data-slate-leaf="true" data-offset-key="6218:0" data-first-offset="true"><span data-slate-string="true">        do_syscall_64+110</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6219"><span data-slate-object="text" data-key="6220"><span data-slate-leaf="true" data-offset-key="6220:0" data-first-offset="true"><span data-slate-string="true">        entry_SYSCALL_64_after_hwframe+68</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6221"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6222"><span data-slate-object="text" data-key="6223"><span data-slate-leaf="true" data-offset-key="6223:0" data-first-offset="true"><span data-slate-string="true">kstack:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6224"><span data-slate-object="text" data-key="6225"><span data-slate-leaf="true" data-offset-key="6225:0" data-first-offset="true"><span data-slate-string="true">        kfree_skb+1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6226"><span data-slate-object="text" data-key="6227"><span data-slate-leaf="true" data-offset-key="6227:0" data-first-offset="true"><span data-slate-string="true">        udpv6_destroy_sock+66</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6228"><span data-slate-object="text" data-key="6229"><span data-slate-leaf="true" data-offset-key="6229:0" data-first-offset="true"><span data-slate-string="true">        sk_common_release+34</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6230"><span data-slate-object="text" data-key="6231"><span data-slate-leaf="true" data-offset-key="6231:0" data-first-offset="true"><span data-slate-string="true">        udp_lib_close+9</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6232"><span data-slate-object="text" data-key="6233"><span data-slate-leaf="true" data-offset-key="6233:0" data-first-offset="true"><span data-slate-string="true">        inet_release+75</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6234"><span data-slate-object="text" data-key="6235"><span data-slate-leaf="true" data-offset-key="6235:0" data-first-offset="true"><span data-slate-string="true">        inet6_release+49</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6236"><span data-slate-object="text" data-key="6237"><span data-slate-leaf="true" data-offset-key="6237:0" data-first-offset="true"><span data-slate-string="true">        __sock_release+66</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6238"><span data-slate-object="text" data-key="6239"><span data-slate-leaf="true" data-offset-key="6239:0" data-first-offset="true"><span data-slate-string="true">        sock_close+21</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6240"><span data-slate-object="text" data-key="6241"><span data-slate-leaf="true" data-offset-key="6241:0" data-first-offset="true"><span data-slate-string="true">        __fput+159</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6242"><span data-slate-object="text" data-key="6243"><span data-slate-leaf="true" data-offset-key="6243:0" data-first-offset="true"><span data-slate-string="true">        ____fput+14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6244"><span data-slate-object="text" data-key="6245"><span data-slate-leaf="true" data-offset-key="6245:0" data-first-offset="true"><span data-slate-string="true">        task_work_run+103</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6246"><span data-slate-object="text" data-key="6247"><span data-slate-leaf="true" data-offset-key="6247:0" data-first-offset="true"><span data-slate-string="true">        exit_to_user_mode_loop+411</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6248"><span data-slate-object="text" data-key="6249"><span data-slate-leaf="true" data-offset-key="6249:0" data-first-offset="true"><span data-slate-string="true">        exit_to_user_mode_prepare+187</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6250"><span data-slate-object="text" data-key="6251"><span data-slate-leaf="true" data-offset-key="6251:0" data-first-offset="true"><span data-slate-string="true">        syscall_exit_to_user_mode+23</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6252"><span data-slate-object="text" data-key="6253"><span data-slate-leaf="true" data-offset-key="6253:0" data-first-offset="true"><span data-slate-string="true">        do_syscall_64+110</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6254"><span data-slate-object="text" data-key="6255"><span data-slate-leaf="true" data-offset-key="6255:0" data-first-offset="true"><span data-slate-string="true">        entry_SYSCALL_64_after_hwframe+68</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6256"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6257"><span data-slate-object="text" data-key="6258"><span data-slate-leaf="true" data-offset-key="6258:0" data-first-offset="true"><span data-slate-string="true">kstack:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6259"><span data-slate-object="text" data-key="6260"><span data-slate-leaf="true" data-offset-key="6260:0" data-first-offset="true"><span data-slate-string="true">        kfree_skb+1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6261"><span data-slate-object="text" data-key="6262"><span data-slate-leaf="true" data-offset-key="6262:0" data-first-offset="true"><span data-slate-string="true">        unix_release+29</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6263"><span data-slate-object="text" data-key="6264"><span data-slate-leaf="true" data-offset-key="6264:0" data-first-offset="true"><span data-slate-string="true">        __sock_release+66</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6265"><span data-slate-object="text" data-key="6266"><span data-slate-leaf="true" data-offset-key="6266:0" data-first-offset="true"><span data-slate-string="true">        sock_close+21</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6267"><span data-slate-object="text" data-key="6268"><span data-slate-leaf="true" data-offset-key="6268:0" data-first-offset="true"><span data-slate-string="true">        __fput+159</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6269"><span data-slate-object="text" data-key="6270"><span data-slate-leaf="true" data-offset-key="6270:0" data-first-offset="true"><span data-slate-string="true">        ____fput+14</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6271"><span data-slate-object="text" data-key="6272"><span data-slate-leaf="true" data-offset-key="6272:0" data-first-offset="true"><span data-slate-string="true">        task_work_run+103</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6273"><span data-slate-object="text" data-key="6274"><span data-slate-leaf="true" data-offset-key="6274:0" data-first-offset="true"><span data-slate-string="true">        exit_to_user_mode_loop+411</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6275"><span data-slate-object="text" data-key="6276"><span data-slate-leaf="true" data-offset-key="6276:0" data-first-offset="true"><span data-slate-string="true">        exit_to_user_mode_prepare+187</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6277"><span data-slate-object="text" data-key="6278"><span data-slate-leaf="true" data-offset-key="6278:0" data-first-offset="true"><span data-slate-string="true">        syscall_exit_to_user_mode+23</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6279"><span data-slate-object="text" data-key="6280"><span data-slate-leaf="true" data-offset-key="6280:0" data-first-offset="true"><span data-slate-string="true">        do_syscall_64+110</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6281"><span data-slate-object="text" data-key="6282"><span data-slate-leaf="true" data-offset-key="6282:0" data-first-offset="true"><span data-slate-string="true">        entry_SYSCALL_64_after_hwframe+68</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6283"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6284"><span data-slate-object="text" data-key="6285"><span data-slate-leaf="true" data-offset-key="6285:0" data-first-offset="true"><span data-slate-string="true">kstack:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6286"><span data-slate-object="text" data-key="6287"><span data-slate-leaf="true" data-offset-key="6287:0" data-first-offset="true"><span data-slate-string="true">        kfree_skb+1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6288"><span data-slate-object="text" data-key="6289"><span data-slate-leaf="true" data-offset-key="6289:0" data-first-offset="true"><span data-slate-string="true">        __sys_connect_file+95</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6290"><span data-slate-object="text" data-key="6291"><span data-slate-leaf="true" data-offset-key="6291:0" data-first-offset="true"><span data-slate-string="true">        __sys_connect+162</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6292"><span data-slate-object="text" data-key="6293"><span data-slate-leaf="true" data-offset-key="6293:0" data-first-offset="true"><span data-slate-string="true">        __x64_sys_connect+24</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6294"><span data-slate-object="text" data-key="6295"><span data-slate-leaf="true" data-offset-key="6295:0" data-first-offset="true"><span data-slate-string="true">        do_syscall_64+97</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6296"><span data-slate-object="text" data-key="6297"><span data-slate-leaf="true" data-offset-key="6297:0" data-first-offset="true"><span data-slate-string="true">        entry_SYSCALL_64_after_hwframe+68</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6298"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6299"><span data-slate-object="text" data-key="6300"><span data-slate-leaf="true" data-offset-key="6300:0" data-first-offset="true"><span data-slate-string="true">kstack:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6301"><span data-slate-object="text" data-key="6302"><span data-slate-leaf="true" data-offset-key="6302:0" data-first-offset="true"><span data-slate-string="true">        kfree_skb+1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6303"><span data-slate-object="text" data-key="6304"><span data-slate-leaf="true" data-offset-key="6304:0" data-first-offset="true"><span data-slate-string="true">        __sys_connect_file+95</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6305"><span data-slate-object="text" data-key="6306"><span data-slate-leaf="true" data-offset-key="6306:0" data-first-offset="true"><span data-slate-string="true">        __sys_connect+162</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6307"><span data-slate-object="text" data-key="6308"><span data-slate-leaf="true" data-offset-key="6308:0" data-first-offset="true"><span data-slate-string="true">        __x64_sys_connect+24</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6309"><span data-slate-object="text" data-key="6310"><span data-slate-leaf="true" data-offset-key="6310:0" data-first-offset="true"><span data-slate-string="true">        do_syscall_64+97</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6311"><span data-slate-object="text" data-key="6312"><span data-slate-leaf="true" data-offset-key="6312:0" data-first-offset="true"><span data-slate-string="true">        entry_SYSCALL_64_after_hwframe+68</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6313"><span data-slate-object="text" data-key="6314"><span data-slate-leaf="true" data-offset-key="6314:0" data-first-offset="true"><span data-slate-string="true">这个输出包含了多个调用栈，每个调用栈从下往上就是 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6315"><span data-slate-object="text" data-key="6316"><span data-slate-leaf="true" data-offset-key="6316:0" data-first-offset="true"><span data-slate-string="true">kfree_skb</span></span></span></span><span data-slate-object="text" data-key="6317"><span data-slate-leaf="true" data-offset-key="6317:0" data-first-offset="true"><span data-slate-string="true"> 被调用过程中的各个函数（函数名后的数字表示调用点相对函数地址的偏移），它们都是从系统调用（</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6318"><span data-slate-object="text" data-key="6319"><span data-slate-leaf="true" data-offset-key="6319:0" data-first-offset="true"><span data-slate-string="true">entry_SYSCALL_64</span></span></span></span><span data-slate-object="text" data-key="6320"><span data-slate-leaf="true" data-offset-key="6320:0" data-first-offset="true"><span data-slate-string="true">）开始，通过一系列的内核函数之后，最终调用到了跟踪函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6321"><span data-slate-object="text" data-key="6322"><span data-slate-leaf="true" data-offset-key="6322:0" data-first-offset="true"><span data-slate-string="true">输出中包含多个调用栈，是因为同一个内核函数是有可能在多个地方调用的。因此，我们需要对它进一步改进，加上网络信息的过滤，并把源 IP 和目的 IP 等基本信息也打印出来。比如，我们访问一个网址，只需要关心 TCP 协议，而其他协议相关的内核栈就可以忽略掉。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6323"><span data-slate-type="code" data-slate-object="inline" data-key="6324"><span data-slate-object="text" data-key="6325"><span data-slate-leaf="true" data-offset-key="6325:0" data-first-offset="true"><span data-slate-string="true">kfree_skb</span></span></span></span><span data-slate-object="text" data-key="6326"><span data-slate-leaf="true" data-offset-key="6326:0" data-first-offset="true"><span data-slate-string="true"> 函数的定义格式如下所示，它包含一个 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6327"><span data-slate-object="text" data-key="6328"><span data-slate-leaf="true" data-offset-key="6328:0" data-first-offset="true"><span data-slate-string="true">struct sk_buff</span></span></span></span><span data-slate-object="text" data-key="6329"><span data-slate-leaf="true" data-offset-key="6329:0" data-first-offset="true"><span data-slate-string="true"> 类型的参数，这样我们就可以从中获取协议、源 IP 和目的 IP 等基本信息：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="6330"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6331"><span data-slate-object="text" data-key="6332"><span data-slate-leaf="true" data-offset-key="6332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="6333"><span data-slate-leaf="true" data-offset-key="6333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6334"><span data-slate-leaf="true" data-offset-key="6334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kfree_skb</span></span></span></span></span><span data-slate-object="text" data-key="6335"><span data-slate-leaf="true" data-offset-key="6335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="6336"><span data-slate-leaf="true" data-offset-key="6336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="6337"><span data-slate-leaf="true" data-offset-key="6337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> sk_buff * skb)</span></span></span></span></span><span data-slate-object="text" data-key="6338"><span data-slate-leaf="true" data-offset-key="6338:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6339"><span data-slate-object="text" data-key="6340"><span data-slate-leaf="true" data-offset-key="6340:0" data-first-offset="true"><span data-slate-string="true">由于我们需要添加数据结构读取的过程，为了更好的可读性，你可以把这些过程放入一个脚本文件中，通常后缀为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6341"><span data-slate-object="text" data-key="6342"><span data-slate-leaf="true" data-offset-key="6342:0" data-first-offset="true"><span data-slate-string="true">.bt</span></span></span></span><span data-slate-object="text" data-key="6343"><span data-slate-leaf="true" data-offset-key="6343:0" data-first-offset="true"><span data-slate-string="true">。下面就是一个改进了的跟踪程序：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="6344"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6345"><span data-slate-object="text" data-key="6346"><span data-slate-leaf="true" data-offset-key="6346:0" data-first-offset="true"><span data-slate-string="true">kprobe:kfree_skb /comm==</span></span></span><span data-slate-object="text" data-key="6347"><span data-slate-leaf="true" data-offset-key="6347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"curl"</span></span></span></span><span data-slate-object="text" data-key="6348"><span data-slate-leaf="true" data-offset-key="6348:0" data-first-offset="true"><span data-slate-string="true">/</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6349"><span data-slate-object="text" data-key="6350"><span data-slate-leaf="true" data-offset-key="6350:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6351"><span data-slate-object="text" data-key="6352"><span data-slate-leaf="true" data-offset-key="6352:0" data-first-offset="true"><span data-slate-string="true">  // 1. 第一个参数是 struct sk_buff</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6353"><span data-slate-object="text" data-key="6354"><span data-slate-leaf="true" data-offset-key="6354:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6355"><span data-slate-leaf="true" data-offset-key="6355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$skb</span></span></span></span><span data-slate-object="text" data-key="6356"><span data-slate-leaf="true" data-offset-key="6356:0" data-first-offset="true"><span data-slate-string="true"> = (struct sk_buff *)arg0;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6357"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6358"><span data-slate-object="text" data-key="6359"><span data-slate-leaf="true" data-offset-key="6359:0" data-first-offset="true"><span data-slate-string="true">  // 2. 从网络头中获取源 IP 和目的 IP</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6360"><span data-slate-object="text" data-key="6361"><span data-slate-leaf="true" data-offset-key="6361:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6362"><span data-slate-leaf="true" data-offset-key="6362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$iph</span></span></span></span><span data-slate-object="text" data-key="6363"><span data-slate-leaf="true" data-offset-key="6363:0" data-first-offset="true"><span data-slate-string="true"> = (struct iphdr *)(</span></span></span><span data-slate-object="text" data-key="6364"><span data-slate-leaf="true" data-offset-key="6364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$skb</span></span></span></span><span data-slate-object="text" data-key="6365"><span data-slate-leaf="true" data-offset-key="6365:0" data-first-offset="true"><span data-slate-string="true">-&gt;</span></span></span><span data-slate-object="text" data-key="6366"><span data-slate-leaf="true" data-offset-key="6366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">head</span></span></span></span><span data-slate-object="text" data-key="6367"><span data-slate-leaf="true" data-offset-key="6367:0" data-first-offset="true"><span data-slate-string="true"> + </span></span></span><span data-slate-object="text" data-key="6368"><span data-slate-leaf="true" data-offset-key="6368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$skb</span></span></span></span><span data-slate-object="text" data-key="6369"><span data-slate-leaf="true" data-offset-key="6369:0" data-first-offset="true"><span data-slate-string="true">-&gt;network_header);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6370"><span data-slate-object="text" data-key="6371"><span data-slate-leaf="true" data-offset-key="6371:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6372"><span data-slate-leaf="true" data-offset-key="6372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$sip</span></span></span></span><span data-slate-object="text" data-key="6373"><span data-slate-leaf="true" data-offset-key="6373:0" data-first-offset="true"><span data-slate-string="true"> = ntop(AF_INET, </span></span></span><span data-slate-object="text" data-key="6374"><span data-slate-leaf="true" data-offset-key="6374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$iph</span></span></span></span><span data-slate-object="text" data-key="6375"><span data-slate-leaf="true" data-offset-key="6375:0" data-first-offset="true"><span data-slate-string="true">-&gt;saddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6376"><span data-slate-object="text" data-key="6377"><span data-slate-leaf="true" data-offset-key="6377:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6378"><span data-slate-leaf="true" data-offset-key="6378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$dip</span></span></span></span><span data-slate-object="text" data-key="6379"><span data-slate-leaf="true" data-offset-key="6379:0" data-first-offset="true"><span data-slate-string="true"> = ntop(AF_INET, </span></span></span><span data-slate-object="text" data-key="6380"><span data-slate-leaf="true" data-offset-key="6380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$iph</span></span></span></span><span data-slate-object="text" data-key="6381"><span data-slate-leaf="true" data-offset-key="6381:0" data-first-offset="true"><span data-slate-string="true">-&gt;daddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6382"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6383"><span data-slate-object="text" data-key="6384"><span data-slate-leaf="true" data-offset-key="6384:0" data-first-offset="true"><span data-slate-string="true">  // 3. 只处理 TCP 协议</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6385"><span data-slate-object="text" data-key="6386"><span data-slate-leaf="true" data-offset-key="6386:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6387"><span data-slate-leaf="true" data-offset-key="6387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6388"><span data-slate-leaf="true" data-offset-key="6388:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="6389"><span data-slate-leaf="true" data-offset-key="6389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$iph</span></span></span></span><span data-slate-object="text" data-key="6390"><span data-slate-leaf="true" data-offset-key="6390:0" data-first-offset="true"><span data-slate-string="true">-&gt;protocol == IPPROTO_TCP)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6391"><span data-slate-object="text" data-key="6392"><span data-slate-leaf="true" data-offset-key="6392:0" data-first-offset="true"><span data-slate-string="true">  {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6393"><span data-slate-object="text" data-key="6394"><span data-slate-leaf="true" data-offset-key="6394:0" data-first-offset="true"><span data-slate-string="true">    // 4. 打印源 IP、目的 IP 和内核调用栈</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6395"><span data-slate-object="text" data-key="6396"><span data-slate-leaf="true" data-offset-key="6396:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6397"><span data-slate-leaf="true" data-offset-key="6397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">printf</span></span></span></span><span data-slate-object="text" data-key="6398"><span data-slate-leaf="true" data-offset-key="6398:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="6399"><span data-slate-leaf="true" data-offset-key="6399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"SKB dropped: %s-&gt;%s, kstack: %s\n"</span></span></span></span><span data-slate-object="text" data-key="6400"><span data-slate-leaf="true" data-offset-key="6400:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6401"><span data-slate-leaf="true" data-offset-key="6401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$sip</span></span></span></span><span data-slate-object="text" data-key="6402"><span data-slate-leaf="true" data-offset-key="6402:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6403"><span data-slate-leaf="true" data-offset-key="6403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$dip</span></span></span></span><span data-slate-object="text" data-key="6404"><span data-slate-leaf="true" data-offset-key="6404:0" data-first-offset="true"><span data-slate-string="true">, kstack);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6405"><span data-slate-object="text" data-key="6406"><span data-slate-leaf="true" data-offset-key="6406:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6407"><span data-slate-object="text" data-key="6408"><span data-slate-leaf="true" data-offset-key="6408:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6409"><span data-slate-object="text" data-key="6410"><span data-slate-leaf="true" data-offset-key="6410:0" data-first-offset="true"><span data-slate-string="true">让我们来看看这个脚本中每一处的具体含义：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6411"><div data-slate-type="list-line" data-slate-object="block" data-key="6412"><span data-slate-object="text" data-key="6413"><span data-slate-leaf="true" data-offset-key="6413:0" data-first-offset="true"><span data-slate-string="true">第 1 处是把 bpftrace 的内置参数 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6414"><span data-slate-object="text" data-key="6415"><span data-slate-leaf="true" data-offset-key="6415:0" data-first-offset="true"><span data-slate-string="true">arg0</span></span></span></span><span data-slate-object="text" data-key="6416"><span data-slate-leaf="true" data-offset-key="6416:0" data-first-offset="true"><span data-slate-string="true"> 转换成 SKB 数据结构 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6417"><span data-slate-object="text" data-key="6418"><span data-slate-leaf="true" data-offset-key="6418:0" data-first-offset="true"><span data-slate-string="true">struct sk_buff *</span></span></span></span><span data-slate-object="text" data-key="6419"><span data-slate-leaf="true" data-offset-key="6419:0" data-first-offset="true"><span data-slate-string="true">（注意使用指针）。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6420"><span data-slate-object="text" data-key="6421"><span data-slate-leaf="true" data-offset-key="6421:0" data-first-offset="true"><span data-slate-string="true">第 2 处是从 SKB 数据结构中获取网络头之后，再从中拿到源 IP 和目的 IP，最后再调用内置函数 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6422"><span data-slate-object="text" data-key="6423"><span data-slate-leaf="true" data-offset-key="6423:0" data-first-offset="true"><span data-slate-string="true">ntop()</span></span></span></span><span data-slate-object="text" data-key="6424"><span data-slate-leaf="true" data-offset-key="6424:0" data-first-offset="true"><span data-slate-string="true"> ，把整数型的 IP 数据结构转换为可读性更好的字符串格式。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6425"><span data-slate-object="text" data-key="6426"><span data-slate-leaf="true" data-offset-key="6426:0" data-first-offset="true"><span data-slate-string="true">第 3 处是对网络协议进行了过滤，只保留 TCP 协议。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6427"><span data-slate-object="text" data-key="6428"><span data-slate-leaf="true" data-offset-key="6428:0" data-first-offset="true"><span data-slate-string="true">第 4 处是向终端中打印刚才获取的源 IP 和目的 IP，同时也打印内核调用栈。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6429"><span data-slate-object="text" data-key="6430"><span data-slate-leaf="true" data-offset-key="6430:0" data-first-offset="true"><span data-slate-string="true">直接把这个脚本保存到文件中，bpftrace 并不能直接运行。你会看到如下的类型未知错误：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="6431"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6432"><span data-slate-object="text" data-key="6433"><span data-slate-leaf="true" data-offset-key="6433:0" data-first-offset="true"><span data-slate-string="true">./dropwatch.bt:9:10-28: ERROR: Unknown struct/union: </span></span></span><span data-slate-object="text" data-key="6434"><span data-slate-leaf="true" data-offset-key="6434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'struct sk_buff'</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6435"><span data-slate-object="text" data-key="6436"><span data-slate-leaf="true" data-offset-key="6436:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6437"><span data-slate-leaf="true" data-offset-key="6437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$skb</span></span></span></span><span data-slate-object="text" data-key="6438"><span data-slate-leaf="true" data-offset-key="6438:0" data-first-offset="true"><span data-slate-string="true"> = (struct sk_buff *)arg0;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6439"><span data-slate-object="text" data-key="6440"><span data-slate-leaf="true" data-offset-key="6440:0" data-first-offset="true"><span data-slate-string="true">         ~~~~~~~~~~~~~~~~~~</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6441"><span data-slate-object="text" data-key="6442"><span data-slate-leaf="true" data-offset-key="6442:0" data-first-offset="true"><span data-slate-string="true">./dropwatch.bt:12:10-26: ERROR: Unknown struct/union: </span></span></span><span data-slate-object="text" data-key="6443"><span data-slate-leaf="true" data-offset-key="6443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'struct iphdr'</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6444"><span data-slate-object="text" data-key="6445"><span data-slate-leaf="true" data-offset-key="6445:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6446"><span data-slate-leaf="true" data-offset-key="6446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$iph</span></span></span></span><span data-slate-object="text" data-key="6447"><span data-slate-leaf="true" data-offset-key="6447:0" data-first-offset="true"><span data-slate-string="true"> = (struct iphdr *)(</span></span></span><span data-slate-object="text" data-key="6448"><span data-slate-leaf="true" data-offset-key="6448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$skb</span></span></span></span><span data-slate-object="text" data-key="6449"><span data-slate-leaf="true" data-offset-key="6449:0" data-first-offset="true"><span data-slate-string="true">-&gt;</span></span></span><span data-slate-object="text" data-key="6450"><span data-slate-leaf="true" data-offset-key="6450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">head</span></span></span></span><span data-slate-object="text" data-key="6451"><span data-slate-leaf="true" data-offset-key="6451:0" data-first-offset="true"><span data-slate-string="true"> + </span></span></span><span data-slate-object="text" data-key="6452"><span data-slate-leaf="true" data-offset-key="6452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$skb</span></span></span></span><span data-slate-object="text" data-key="6453"><span data-slate-leaf="true" data-offset-key="6453:0" data-first-offset="true"><span data-slate-string="true">-&gt;network_header);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6454"><span data-slate-object="text" data-key="6455"><span data-slate-leaf="true" data-offset-key="6455:0" data-first-offset="true"><span data-slate-string="true">         ~~~~~~~~~~~~~~~~</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6456"><span data-slate-object="text" data-key="6457"><span data-slate-leaf="true" data-offset-key="6457:0" data-first-offset="true"><span data-slate-string="true">./dropwatch.bt:13:10-22: ERROR: Unknown identifier: </span></span></span><span data-slate-object="text" data-key="6458"><span data-slate-leaf="true" data-offset-key="6458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'AF_INET'</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6459"><span data-slate-object="text" data-key="6460"><span data-slate-leaf="true" data-offset-key="6460:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6461"><span data-slate-leaf="true" data-offset-key="6461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$sip</span></span></span></span><span data-slate-object="text" data-key="6462"><span data-slate-leaf="true" data-offset-key="6462:0" data-first-offset="true"><span data-slate-string="true"> = ntop(AF_INET, </span></span></span><span data-slate-object="text" data-key="6463"><span data-slate-leaf="true" data-offset-key="6463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$iph</span></span></span></span><span data-slate-object="text" data-key="6464"><span data-slate-leaf="true" data-offset-key="6464:0" data-first-offset="true"><span data-slate-string="true">-&gt;saddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6465"><span data-slate-object="text" data-key="6466"><span data-slate-leaf="true" data-offset-key="6466:0" data-first-offset="true"><span data-slate-string="true">         ~~~~~~~~~~~~</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6467"><span data-slate-object="text" data-key="6468"><span data-slate-leaf="true" data-offset-key="6468:0" data-first-offset="true"><span data-slate-string="true">这是因为，bpftrace 在将上述脚本编译为 BPF 字节码的过程中，找不到这些类型的定义。在内核支持 BTF 之前，这其实是所有 eBPF 程序开发过程中都会遇到的一个问题。要解决这个问题，我们就需要把所需的内核头文件引入进来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6469"><span data-slate-object="text" data-key="6470"><span data-slate-leaf="true" data-offset-key="6470:0" data-first-offset="true"><span data-slate-string="true">这里给你一个小提示：v0.9.3 或更新版本的 bpftrace 已经支持 BTF 了，但需要新版本的 libbpf，且还有很多的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6471"><span data-slate-object="text" data-key="6472"><span data-slate-leaf="true" data-offset-key="6472:0" data-first-offset="true"><span data-slate-string="true">限制</span></span></span></a><span data-slate-object="text" data-key="6473"><span data-slate-leaf="true" data-offset-key="6473:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6474"><span data-slate-object="text" data-key="6475"><span data-slate-leaf="true" data-offset-key="6475:0" data-first-offset="true"><span data-slate-string="true">那么，如何找出这些数据结构的头文件呢？我通常使用下面的两种方法：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6476"><div data-slate-type="list-line" data-slate-object="block" data-key="6477"><span data-slate-object="text" data-key="6478"><span data-slate-leaf="true" data-offset-key="6478:0" data-first-offset="true"><span data-slate-string="true">第一种方法是在内核源码目录中，通过查找的方式，找出定义了这些数据结构的头文件（后缀为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6479"><span data-slate-object="text" data-key="6480"><span data-slate-leaf="true" data-offset-key="6480:0" data-first-offset="true"><span data-slate-string="true">.h</span></span></span></span><span data-slate-object="text" data-key="6481"><span data-slate-leaf="true" data-offset-key="6481:0" data-first-offset="true"><span data-slate-string="true">）。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6482"><span data-slate-object="text" data-key="6483"><span data-slate-leaf="true" data-offset-key="6483:0" data-first-offset="true"><span data-slate-string="true">另外一种方法是到 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6484"><span data-slate-object="text" data-key="6485"><span data-slate-leaf="true" data-offset-key="6485:0" data-first-offset="true"><span data-slate-string="true">https://elixir.bootlin.com/</span></span></span></a><span data-slate-object="text" data-key="6486"><span data-slate-leaf="true" data-offset-key="6486:0" data-first-offset="true"><span data-slate-string="true"> 上选择正确的内核版本后，再搜索数据结构的名字。我在下面还会详细介绍这个网站的使用方法。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6487"><span data-slate-object="text" data-key="6488"><span data-slate-leaf="true" data-offset-key="6488:0" data-first-offset="true"><span data-slate-string="true">我们在脚本文件中加入这些类型定义的头文件：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="6489"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6490"><span data-slate-object="text" data-key="6491"><span data-slate-leaf="true" data-offset-key="6491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="6492"><span data-slate-leaf="true" data-offset-key="6492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="6493"><span data-slate-leaf="true" data-offset-key="6493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6494"><span data-slate-leaf="true" data-offset-key="6494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;linux/skbuff.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6495"><span data-slate-object="text" data-key="6496"><span data-slate-leaf="true" data-offset-key="6496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="6497"><span data-slate-leaf="true" data-offset-key="6497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="6498"><span data-slate-leaf="true" data-offset-key="6498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6499"><span data-slate-leaf="true" data-offset-key="6499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;linux/ip.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6500"><span data-slate-object="text" data-key="6501"><span data-slate-leaf="true" data-offset-key="6501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="6502"><span data-slate-leaf="true" data-offset-key="6502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="6503"><span data-slate-leaf="true" data-offset-key="6503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6504"><span data-slate-leaf="true" data-offset-key="6504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;linux/socket.h&gt;</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6505"><span data-slate-object="text" data-key="6506"><span data-slate-leaf="true" data-offset-key="6506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="6507"><span data-slate-leaf="true" data-offset-key="6507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">include</span></span></span></span></span><span data-slate-object="text" data-key="6508"><span data-slate-leaf="true" data-offset-key="6508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6509"><span data-slate-leaf="true" data-offset-key="6509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">&lt;linux/netdevice.h&gt;</span></span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6510"><span data-slate-object="text" data-key="6511"><span data-slate-leaf="true" data-offset-key="6511:0" data-first-offset="true"><span data-slate-string="true">然后，保存到文件 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6512"><span data-slate-object="text" data-key="6513"><span data-slate-leaf="true" data-offset-key="6513:0" data-first-offset="true"><span data-slate-string="true">dropwatch.bt</span></span></span></span><span data-slate-object="text" data-key="6514"><span data-slate-leaf="true" data-offset-key="6514:0" data-first-offset="true"><span data-slate-string="true"> 中（你也可以在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6515"><span data-slate-object="text" data-key="6516"><span data-slate-leaf="true" data-offset-key="6516:0" data-first-offset="true"><span data-slate-string="true">GitHub</span></span></span></a><span data-slate-object="text" data-key="6517"><span data-slate-leaf="true" data-offset-key="6517:0" data-first-offset="true"><span data-slate-string="true"> 中找到完整的程序），就可以通过 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6518"><span data-slate-object="text" data-key="6519"><span data-slate-leaf="true" data-offset-key="6519:0" data-first-offset="true"><span data-slate-string="true">sudo bpftrace dropwatch.bt</span></span></span></span><span data-slate-object="text" data-key="6520"><span data-slate-leaf="true" data-offset-key="6520:0" data-first-offset="true"><span data-slate-string="true"> 来运行了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6521" id="sr-toc-3"><span data-slate-object="text" data-key="6522"><span data-slate-leaf="true" data-offset-key="6522:0" data-first-offset="true"><span data-slate-string="true">如何排查网络丢包问题？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6523"><span data-slate-object="text" data-key="6524"><span data-slate-leaf="true" data-offset-key="6524:0" data-first-offset="true"><span data-slate-string="true">有了 eBPF 跟踪脚本之后，它能不能用来排查网络丢包问题呢？我们来验证一下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6525"><span data-slate-object="text" data-key="6526"><span data-slate-leaf="true" data-offset-key="6526:0" data-first-offset="true"><span data-slate-string="true">最常见的丢包是由系统防火墙阻止了相应的 IP 或端口导致的，你可以执行下面的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6527"><span data-slate-object="text" data-key="6528"><span data-slate-leaf="true" data-offset-key="6528:0" data-first-offset="true"><span data-slate-string="true">nslookup</span></span></span></span><span data-slate-object="text" data-key="6529"><span data-slate-leaf="true" data-offset-key="6529:0" data-first-offset="true"><span data-slate-string="true"> 命令，查询到极客时间的 IP 地址，然后再执行</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6530"><span data-slate-object="text" data-key="6531"><span data-slate-leaf="true" data-offset-key="6531:0" data-first-offset="true"><span data-slate-string="true"> iptables</span></span></span></span><span data-slate-object="text" data-key="6532"><span data-slate-leaf="true" data-offset-key="6532:0" data-first-offset="true"><span data-slate-string="true"> 命令，禁止访问极客时间的 80 端口：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="6533"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6534"><span data-slate-object="text" data-key="6535"><span data-slate-leaf="true" data-offset-key="6535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># </span></span></span></span><span data-slate-object="text" data-key="6536"><span data-slate-leaf="true" data-offset-key="6536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">首先查询极客时间的 IP</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6537"><span data-slate-object="text" data-key="6538"><span data-slate-leaf="true" data-offset-key="6538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="6539"><span data-slate-leaf="true" data-offset-key="6539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nslookup time.geekbang.org</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6540"><span data-slate-object="text" data-key="6541"><span data-slate-leaf="true" data-offset-key="6541:0" data-first-offset="true"><span data-slate-string="true">Server:        127.0.0.53</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6542"><span data-slate-object="text" data-key="6543"><span data-slate-leaf="true" data-offset-key="6543:0" data-first-offset="true"><span data-slate-string="true">Address:    127.0.0.53#53</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6544"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6545"><span data-slate-object="text" data-key="6546"><span data-slate-leaf="true" data-offset-key="6546:0" data-first-offset="true"><span data-slate-string="true">Non-authoritative answer:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6547"><span data-slate-object="text" data-key="6548"><span data-slate-leaf="true" data-offset-key="6548:0" data-first-offset="true"><span data-slate-string="true">Name:    time.geekbang.org</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6549"><span data-slate-object="text" data-key="6550"><span data-slate-leaf="true" data-offset-key="6550:0" data-first-offset="true"><span data-slate-string="true">Address: 39.106.233.176</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6551"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6552"><span data-slate-object="text" data-key="6553"><span data-slate-leaf="true" data-offset-key="6553:0" data-first-offset="true"><span data-slate-string="true"># </span></span></span><span data-slate-object="text" data-key="6554"><span data-slate-leaf="true" data-offset-key="6554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">然后增加防火墙规则阻止 80 端口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6555"><span data-slate-object="text" data-key="6556"><span data-slate-leaf="true" data-offset-key="6556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="6557"><span data-slate-leaf="true" data-offset-key="6557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sudo iptables -I OUTPUT -d 39.106.233.176/32 -p tcp -m tcp --dport 80 -j DROP</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6558"><span data-slate-object="text" data-key="6559"><span data-slate-leaf="true" data-offset-key="6559:0" data-first-offset="true"><span data-slate-string="true">防火墙规则加好之后，在终端一中启动跟踪脚本：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="6560"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6561"><span data-slate-object="text" data-key="6562"><span data-slate-leaf="true" data-offset-key="6562:0" data-first-offset="true"><span data-slate-string="true">sudo bpftrace dropwatch.bt</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6563"><span data-slate-object="text" data-key="6564"><span data-slate-leaf="true" data-offset-key="6564:0" data-first-offset="true"><span data-slate-string="true">然后，新建一个终端，访问极客时间，你应该会看到超时的错误：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="6565"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6566"><span data-slate-object="text" data-key="6567"><span data-slate-leaf="true" data-offset-key="6567:0" data-first-offset="true"><span data-slate-string="true">$ curl </span></span></span><span data-slate-object="text" data-key="6568"><span data-slate-leaf="true" data-offset-key="6568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--connect-timeout 1 39.106.233.176</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6569"><span data-slate-object="text" data-key="6570"><span data-slate-leaf="true" data-offset-key="6570:0" data-first-offset="true"><span data-slate-string="true">curl: (</span></span></span><span data-slate-object="text" data-key="6571"><span data-slate-leaf="true" data-offset-key="6571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">28</span></span></span></span><span data-slate-object="text" data-key="6572"><span data-slate-leaf="true" data-offset-key="6572:0" data-first-offset="true"><span data-slate-string="true">) Connection timed </span></span></span><span data-slate-object="text" data-key="6573"><span data-slate-leaf="true" data-offset-key="6573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="6574"><span data-slate-leaf="true" data-offset-key="6574:0" data-first-offset="true"><span data-slate-string="true"> after </span></span></span><span data-slate-object="text" data-key="6575"><span data-slate-leaf="true" data-offset-key="6575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000</span></span></span></span><span data-slate-object="text" data-key="6576"><span data-slate-leaf="true" data-offset-key="6576:0" data-first-offset="true"><span data-slate-string="true"> milliseconds</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6577"><span data-slate-object="text" data-key="6578"><span data-slate-leaf="true" data-offset-key="6578:0" data-first-offset="true"><span data-slate-string="true">返回第一个终端，你就可以看到 eBPF 程序已经成功跟踪到了内核丢包的调用栈信息，如下所示：</span></span></span></div><div data-code-language="objectivec" data-slate-type="pre" data-slate-object="block" data-key="6579"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6580"><span data-slate-object="text" data-key="6581"><span data-slate-leaf="true" data-offset-key="6581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">SKB</span></span></span></span><span data-slate-object="text" data-key="6582"><span data-slate-leaf="true" data-offset-key="6582:0" data-first-offset="true"><span data-slate-string="true"> dropped: </span></span></span><span data-slate-object="text" data-key="6583"><span data-slate-leaf="true" data-offset-key="6583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">192.168</span></span></span></span><span data-slate-object="text" data-key="6584"><span data-slate-leaf="true" data-offset-key="6584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">.1</span></span></span></span><span data-slate-object="text" data-key="6585"><span data-slate-leaf="true" data-offset-key="6585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">.129</span></span></span></span><span data-slate-object="text" data-key="6586"><span data-slate-leaf="true" data-offset-key="6586:0" data-first-offset="true"><span data-slate-string="true">-&gt;</span></span></span><span data-slate-object="text" data-key="6587"><span data-slate-leaf="true" data-offset-key="6587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">39.106</span></span></span></span><span data-slate-object="text" data-key="6588"><span data-slate-leaf="true" data-offset-key="6588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">.233</span></span></span></span><span data-slate-object="text" data-key="6589"><span data-slate-leaf="true" data-offset-key="6589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">.176</span></span></span></span><span data-slate-object="text" data-key="6590"><span data-slate-leaf="true" data-offset-key="6590:0" data-first-offset="true"><span data-slate-string="true">, kstack:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6591"><span data-slate-object="text" data-key="6592"><span data-slate-leaf="true" data-offset-key="6592:0" data-first-offset="true"><span data-slate-string="true">        kfree_skb+</span></span></span><span data-slate-object="text" data-key="6593"><span data-slate-leaf="true" data-offset-key="6593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6594"><span data-slate-object="text" data-key="6595"><span data-slate-leaf="true" data-offset-key="6595:0" data-first-offset="true"><span data-slate-string="true">        __ip_local_out+</span></span></span><span data-slate-object="text" data-key="6596"><span data-slate-leaf="true" data-offset-key="6596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">219</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6597"><span data-slate-object="text" data-key="6598"><span data-slate-leaf="true" data-offset-key="6598:0" data-first-offset="true"><span data-slate-string="true">        ip_local_out+</span></span></span><span data-slate-object="text" data-key="6599"><span data-slate-leaf="true" data-offset-key="6599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">29</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6600"><span data-slate-object="text" data-key="6601"><span data-slate-leaf="true" data-offset-key="6601:0" data-first-offset="true"><span data-slate-string="true">        __ip_queue_xmit+</span></span></span><span data-slate-object="text" data-key="6602"><span data-slate-leaf="true" data-offset-key="6602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">367</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6603"><span data-slate-object="text" data-key="6604"><span data-slate-leaf="true" data-offset-key="6604:0" data-first-offset="true"><span data-slate-string="true">        ip_queue_xmit+</span></span></span><span data-slate-object="text" data-key="6605"><span data-slate-leaf="true" data-offset-key="6605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">21</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6606"><span data-slate-object="text" data-key="6607"><span data-slate-leaf="true" data-offset-key="6607:0" data-first-offset="true"><span data-slate-string="true">        __tcp_transmit_skb+</span></span></span><span data-slate-object="text" data-key="6608"><span data-slate-leaf="true" data-offset-key="6608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2237</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6609"><span data-slate-object="text" data-key="6610"><span data-slate-leaf="true" data-offset-key="6610:0" data-first-offset="true"><span data-slate-string="true">        tcp_connect+</span></span></span><span data-slate-object="text" data-key="6611"><span data-slate-leaf="true" data-offset-key="6611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1009</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6612"><span data-slate-object="text" data-key="6613"><span data-slate-leaf="true" data-offset-key="6613:0" data-first-offset="true"><span data-slate-string="true">        tcp_v4_connect+</span></span></span><span data-slate-object="text" data-key="6614"><span data-slate-leaf="true" data-offset-key="6614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">951</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6615"><span data-slate-object="text" data-key="6616"><span data-slate-leaf="true" data-offset-key="6616:0" data-first-offset="true"><span data-slate-string="true">        __inet_stream_connect+</span></span></span><span data-slate-object="text" data-key="6617"><span data-slate-leaf="true" data-offset-key="6617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">206</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6618"><span data-slate-object="text" data-key="6619"><span data-slate-leaf="true" data-offset-key="6619:0" data-first-offset="true"><span data-slate-string="true">        inet_stream_connect+</span></span></span><span data-slate-object="text" data-key="6620"><span data-slate-leaf="true" data-offset-key="6620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">59</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6621"><span data-slate-object="text" data-key="6622"><span data-slate-leaf="true" data-offset-key="6622:0" data-first-offset="true"><span data-slate-string="true">        __sys_connect_file+</span></span></span><span data-slate-object="text" data-key="6623"><span data-slate-leaf="true" data-offset-key="6623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">95</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6624"><span data-slate-object="text" data-key="6625"><span data-slate-leaf="true" data-offset-key="6625:0" data-first-offset="true"><span data-slate-string="true">        __sys_connect+</span></span></span><span data-slate-object="text" data-key="6626"><span data-slate-leaf="true" data-offset-key="6626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">162</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6627"><span data-slate-object="text" data-key="6628"><span data-slate-leaf="true" data-offset-key="6628:0" data-first-offset="true"><span data-slate-string="true">        __x64_sys_connect+</span></span></span><span data-slate-object="text" data-key="6629"><span data-slate-leaf="true" data-offset-key="6629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">24</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6630"><span data-slate-object="text" data-key="6631"><span data-slate-leaf="true" data-offset-key="6631:0" data-first-offset="true"><span data-slate-string="true">        do_syscall_64+</span></span></span><span data-slate-object="text" data-key="6632"><span data-slate-leaf="true" data-offset-key="6632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">97</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6633"><span data-slate-object="text" data-key="6634"><span data-slate-leaf="true" data-offset-key="6634:0" data-first-offset="true"><span data-slate-string="true">        entry_SYSCALL_64_after_hwframe+</span></span></span><span data-slate-object="text" data-key="6635"><span data-slate-leaf="true" data-offset-key="6635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">68</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6636"><span data-slate-object="text" data-key="6637"><span data-slate-leaf="true" data-offset-key="6637:0" data-first-offset="true"><span data-slate-string="true">从这个输出中，我们可以看到，第一行输出中我们成功拿到了源 IP 和目的 IP，而接下来的每一行中都包含了指令地址、函数名以及函数地址偏移。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6638"><span data-slate-object="text" data-key="6639"><span data-slate-leaf="true" data-offset-key="6639:0" data-first-offset="true"><span data-slate-string="true">从下往上看这个调用栈，最后调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6640"><span data-slate-object="text" data-key="6641"><span data-slate-leaf="true" data-offset-key="6641:0" data-first-offset="true"><span data-slate-string="true">kfree_skb</span></span></span></span><span data-slate-object="text" data-key="6642"><span data-slate-leaf="true" data-offset-key="6642:0" data-first-offset="true"><span data-slate-string="true"> 函数的是 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6643"><span data-slate-object="text" data-key="6644"><span data-slate-leaf="true" data-offset-key="6644:0" data-first-offset="true"><span data-slate-string="true">__ip_local_out</span></span></span></span><span data-slate-object="text" data-key="6645"><span data-slate-leaf="true" data-offset-key="6645:0" data-first-offset="true"><span data-slate-string="true">，那么 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6646"><span data-slate-object="text" data-key="6647"><span data-slate-leaf="true" data-offset-key="6647:0" data-first-offset="true"><span data-slate-string="true">__ip_local_out</span></span></span></span><span data-slate-object="text" data-key="6648"><span data-slate-leaf="true" data-offset-key="6648:0" data-first-offset="true"><span data-slate-string="true"> 这个函数又是干什么的呢？根据函数名，你可以大致猜测出，它是用于向外发送网络包的，但具体的步骤我们就不太确定了。所以，这时候就需要去参考一下内核源代码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6649"><span data-slate-object="text" data-key="6650"><span data-slate-leaf="true" data-offset-key="6650:0" data-first-offset="true"><span data-slate-string="true">这里推荐你使用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6651"><span data-slate-object="text" data-key="6652"><span data-slate-leaf="true" data-offset-key="6652:0" data-first-offset="true"><span data-slate-string="true">https://elixir.bootlin.com/</span></span></span></a><span data-slate-object="text" data-key="6653"><span data-slate-leaf="true" data-offset-key="6653:0" data-first-offset="true"><span data-slate-string="true"> 这个网站来查看内核源码，因为它不仅列出了所有内核版本的源代码，还提供了交叉引用的功能。在源码文件中点击任意函数或类型，它就可以自动跳转到其定义和引用的位置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6654"><span data-slate-object="text" data-key="6655"><span data-slate-leaf="true" data-offset-key="6655:0" data-first-offset="true"><span data-slate-string="true">比如，对于 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6656"><span data-slate-object="text" data-key="6657"><span data-slate-leaf="true" data-offset-key="6657:0" data-first-offset="true"><span data-slate-string="true">__ip_local_out</span></span></span></span><span data-slate-object="text" data-key="6658"><span data-slate-leaf="true" data-offset-key="6658:0" data-first-offset="true"><span data-slate-string="true"> 函数的定义和引用，就可以通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6659"><span data-slate-object="text" data-key="6660"><span data-slate-leaf="true" data-offset-key="6660:0" data-first-offset="true"><span data-slate-string="true">https://elixir.bootlin.com/linux/v5.13/A/ident/__ip_local_out</span></span></span></a><span data-slate-object="text" data-key="6661"><span data-slate-leaf="true" data-offset-key="6661:0" data-first-offset="true"><span data-slate-string="true"> （请注意把 v5.13 替换成你的内核版本）这个网址来查看。点击</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6662"><span data-slate-object="text" data-key="6663"><span data-slate-leaf="true" data-offset-key="6663:0" data-first-offset="true"><span data-slate-string="true">链接</span></span></span></a><span data-slate-object="text" data-key="6664"><span data-slate-leaf="true" data-offset-key="6664:0" data-first-offset="true"><span data-slate-string="true">，你会看到如下的界面：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6665"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/98/cc/98891ed6bf8f2d6e273299bba6a3edcc.png?wh=856x614" style="width: auto;"></div><div>交叉引用搜索结果示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6666"><span data-slate-object="text" data-key="6667"><span data-slate-leaf="true" data-offset-key="6667:0" data-first-offset="true"><span data-slate-string="true">查询的结果分为三个部分，分别是头文件中的函数声明、源码文件中的函数定义，以及其他文件的引用。点击中间部分（即上图红框中的第一个链接），就可以跳转到源码的定义位置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6668"><span data-slate-object="text" data-key="6669"><span data-slate-leaf="true" data-offset-key="6669:0" data-first-offset="true"><span data-slate-string="true">打开</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6670"><span data-slate-object="text" data-key="6671"><span data-slate-leaf="true" data-offset-key="6671:0" data-first-offset="true"><span data-slate-string="true">代码</span></span></span></a><span data-slate-object="text" data-key="6672"><span data-slate-leaf="true" data-offset-key="6672:0" data-first-offset="true"><span data-slate-string="true">之后，你会发现，其实并不需要因为不懂内核而担心自己看不懂内核源码，内核中的源码还是很简洁的。这里我把原始代码复制了过来，并且加入了详细的注释，如下所示：</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="6673"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6674"><span data-slate-object="text" data-key="6675"><span data-slate-leaf="true" data-offset-key="6675:0" data-first-offset="true"><span data-slate-string="true">int __ip_local_out(</span></span></span><span data-slate-object="text" data-key="6676"><span data-slate-leaf="true" data-offset-key="6676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="6677"><span data-slate-leaf="true" data-offset-key="6677:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6678"><span data-slate-leaf="true" data-offset-key="6678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">net</span></span></span></span><span data-slate-object="text" data-key="6679"><span data-slate-leaf="true" data-offset-key="6679:0" data-first-offset="true"><span data-slate-string="true"> *net, </span></span></span><span data-slate-object="text" data-key="6680"><span data-slate-leaf="true" data-offset-key="6680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="6681"><span data-slate-leaf="true" data-offset-key="6681:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6682"><span data-slate-leaf="true" data-offset-key="6682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sock</span></span></span></span><span data-slate-object="text" data-key="6683"><span data-slate-leaf="true" data-offset-key="6683:0" data-first-offset="true"><span data-slate-string="true"> *sk, </span></span></span><span data-slate-object="text" data-key="6684"><span data-slate-leaf="true" data-offset-key="6684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="6685"><span data-slate-leaf="true" data-offset-key="6685:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6686"><span data-slate-leaf="true" data-offset-key="6686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sk_buff</span></span></span></span><span data-slate-object="text" data-key="6687"><span data-slate-leaf="true" data-offset-key="6687:0" data-first-offset="true"><span data-slate-string="true"> *skb)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6688"><span data-slate-object="text" data-key="6689"><span data-slate-leaf="true" data-offset-key="6689:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6690"><span data-slate-object="text" data-key="6691"><span data-slate-leaf="true" data-offset-key="6691:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6692"><span data-slate-leaf="true" data-offset-key="6692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="6693"><span data-slate-leaf="true" data-offset-key="6693:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6694"><span data-slate-leaf="true" data-offset-key="6694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">iphdr</span></span></span></span><span data-slate-object="text" data-key="6695"><span data-slate-leaf="true" data-offset-key="6695:0" data-first-offset="true"><span data-slate-string="true"> *iph = </span></span></span><span data-slate-object="text" data-key="6696"><span data-slate-leaf="true" data-offset-key="6696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ip_hdr</span></span></span></span><span data-slate-object="text" data-key="6697"><span data-slate-leaf="true" data-offset-key="6697:0" data-first-offset="true"><span data-slate-string="true">(skb);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6698"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6699"><span data-slate-object="text" data-key="6700"><span data-slate-leaf="true" data-offset-key="6700:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6701"><span data-slate-leaf="true" data-offset-key="6701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 计算总长度 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6702"><span data-slate-object="text" data-key="6703"><span data-slate-leaf="true" data-offset-key="6703:0" data-first-offset="true"><span data-slate-string="true">    iph</span></span></span><span data-slate-object="text" data-key="6704"><span data-slate-leaf="true" data-offset-key="6704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6705"><span data-slate-leaf="true" data-offset-key="6705:0" data-first-offset="true"><span data-slate-string="true">tot_len = </span></span></span><span data-slate-object="text" data-key="6706"><span data-slate-leaf="true" data-offset-key="6706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">htons</span></span></span></span><span data-slate-object="text" data-key="6707"><span data-slate-leaf="true" data-offset-key="6707:0" data-first-offset="true"><span data-slate-string="true">(skb</span></span></span><span data-slate-object="text" data-key="6708"><span data-slate-leaf="true" data-offset-key="6708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6709"><span data-slate-leaf="true" data-offset-key="6709:0" data-first-offset="true"><span data-slate-string="true">len);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6710"><span data-slate-object="text" data-key="6711"><span data-slate-leaf="true" data-offset-key="6711:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6712"><span data-slate-leaf="true" data-offset-key="6712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 计算校验和 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6713"><span data-slate-object="text" data-key="6714"><span data-slate-leaf="true" data-offset-key="6714:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6715"><span data-slate-leaf="true" data-offset-key="6715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ip_send_check</span></span></span></span><span data-slate-object="text" data-key="6716"><span data-slate-leaf="true" data-offset-key="6716:0" data-first-offset="true"><span data-slate-string="true">(iph);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6717"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6718"><span data-slate-object="text" data-key="6719"><span data-slate-leaf="true" data-offset-key="6719:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6720"><span data-slate-leaf="true" data-offset-key="6720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* L3 主设备处理 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6721"><span data-slate-object="text" data-key="6722"><span data-slate-leaf="true" data-offset-key="6722:0" data-first-offset="true"><span data-slate-string="true">    skb = </span></span></span><span data-slate-object="text" data-key="6723"><span data-slate-leaf="true" data-offset-key="6723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">l3mdev_ip_out</span></span></span></span><span data-slate-object="text" data-key="6724"><span data-slate-leaf="true" data-offset-key="6724:0" data-first-offset="true"><span data-slate-string="true">(sk, skb);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6725"><span data-slate-object="text" data-key="6726"><span data-slate-leaf="true" data-offset-key="6726:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6727"><span data-slate-leaf="true" data-offset-key="6727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6728"><span data-slate-leaf="true" data-offset-key="6728:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="6729"><span data-slate-leaf="true" data-offset-key="6729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlikely</span></span></span></span><span data-slate-object="text" data-key="6730"><span data-slate-leaf="true" data-offset-key="6730:0" data-first-offset="true"><span data-slate-string="true">(!skb))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6731"><span data-slate-object="text" data-key="6732"><span data-slate-leaf="true" data-offset-key="6732:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="6733"><span data-slate-leaf="true" data-offset-key="6733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6734"><span data-slate-leaf="true" data-offset-key="6734:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6735"><span data-slate-leaf="true" data-offset-key="6735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6736"><span data-slate-leaf="true" data-offset-key="6736:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6737"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6738"><span data-slate-object="text" data-key="6739"><span data-slate-leaf="true" data-offset-key="6739:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6740"><span data-slate-leaf="true" data-offset-key="6740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 设置 IP 协议 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6741"><span data-slate-object="text" data-key="6742"><span data-slate-leaf="true" data-offset-key="6742:0" data-first-offset="true"><span data-slate-string="true">    skb</span></span></span><span data-slate-object="text" data-key="6743"><span data-slate-leaf="true" data-offset-key="6743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6744"><span data-slate-leaf="true" data-offset-key="6744:0" data-first-offset="true"><span data-slate-string="true">protocol = </span></span></span><span data-slate-object="text" data-key="6745"><span data-slate-leaf="true" data-offset-key="6745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">htons</span></span></span></span><span data-slate-object="text" data-key="6746"><span data-slate-leaf="true" data-offset-key="6746:0" data-first-offset="true"><span data-slate-string="true">(ETH_P_IP);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6747"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6748"><span data-slate-object="text" data-key="6749"><span data-slate-leaf="true" data-offset-key="6749:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="6750"><span data-slate-leaf="true" data-offset-key="6750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* 调用 NF_INET_LOCAL_OUT 钩子 */</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6751"><span data-slate-object="text" data-key="6752"><span data-slate-leaf="true" data-offset-key="6752:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6753"><span data-slate-leaf="true" data-offset-key="6753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="6754"><span data-slate-leaf="true" data-offset-key="6754:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6755"><span data-slate-leaf="true" data-offset-key="6755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nf_hook</span></span></span></span><span data-slate-object="text" data-key="6756"><span data-slate-leaf="true" data-offset-key="6756:0" data-first-offset="true"><span data-slate-string="true">(NFPROTO_IPV4, NF_INET_LOCAL_OUT,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6757"><span data-slate-object="text" data-key="6758"><span data-slate-leaf="true" data-offset-key="6758:0" data-first-offset="true"><span data-slate-string="true">               net, sk, skb, NULL, </span></span></span><span data-slate-object="text" data-key="6759"><span data-slate-leaf="true" data-offset-key="6759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">skb_dst</span></span></span></span><span data-slate-object="text" data-key="6760"><span data-slate-leaf="true" data-offset-key="6760:0" data-first-offset="true"><span data-slate-string="true">(skb)</span></span></span><span data-slate-object="text" data-key="6761"><span data-slate-leaf="true" data-offset-key="6761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="6762"><span data-slate-leaf="true" data-offset-key="6762:0" data-first-offset="true"><span data-slate-string="true">dev,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6763"><span data-slate-object="text" data-key="6764"><span data-slate-leaf="true" data-offset-key="6764:0" data-first-offset="true"><span data-slate-string="true">               dst_output);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6765"><span data-slate-object="text" data-key="6766"><span data-slate-leaf="true" data-offset-key="6766:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6767"><span data-slate-object="text" data-key="6768"><span data-slate-leaf="true" data-offset-key="6768:0" data-first-offset="true"><span data-slate-string="true">从这个代码来看，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6769"><span data-slate-object="text" data-key="6770"><span data-slate-leaf="true" data-offset-key="6770:0" data-first-offset="true"><span data-slate-string="true">__ip_local_out</span></span></span></span><span data-slate-object="text" data-key="6771"><span data-slate-leaf="true" data-offset-key="6771:0" data-first-offset="true"><span data-slate-string="true"> 函数的主要流程就是计算总长度和校验和，再设置 L3 主设备和协议等属性后，最终调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6772"><span data-slate-object="text" data-key="6773"><span data-slate-leaf="true" data-offset-key="6773:0" data-first-offset="true"><span data-slate-string="true">nf_hook</span></span></span></span><span data-slate-object="text" data-key="6774"><span data-slate-leaf="true" data-offset-key="6774:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6775"><span data-slate-object="text" data-key="6776"><span data-slate-leaf="true" data-offset-key="6776:0" data-first-offset="true"><span data-slate-string="true">而 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6777"><span data-slate-object="text" data-key="6778"><span data-slate-leaf="true" data-offset-key="6778:0" data-first-offset="true"><span data-slate-string="true">nf</span></span></span></span><span data-slate-object="text" data-key="6779"><span data-slate-leaf="true" data-offset-key="6779:0" data-first-offset="true"><span data-slate-string="true"> 就是 netfilter 的缩写，所以你就可以将其理解为调用 iptables 规则。再根据 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6780"><span data-slate-object="text" data-key="6781"><span data-slate-leaf="true" data-offset-key="6781:0" data-first-offset="true"><span data-slate-string="true">NF_INET_LOCAL_OUT</span></span></span></span><span data-slate-object="text" data-key="6782"><span data-slate-leaf="true" data-offset-key="6782:0" data-first-offset="true"><span data-slate-string="true"> 参数，你就可以知道接下来调用了 OUTPUT 链（chain）的钩子。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6783"><span data-slate-object="text" data-key="6784"><span data-slate-leaf="true" data-offset-key="6784:0" data-first-offset="true"><span data-slate-string="true">知道了发生丢包的问题来源，接下来再去定位 iptables 就比较容易了。在终端中执行下面的 iptables 命令，就可以查询 OUTPUT 链的过滤规则：</span></span></span></div><div data-slate-type="pre" data-slate-object="block" data-key="6785"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6786"><span data-slate-object="text" data-key="6787"><span data-slate-leaf="true" data-offset-key="6787:0" data-first-offset="true"><span data-slate-string="true">sudo iptables -nvL OUTPUT</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6788"><span data-slate-object="text" data-key="6789"><span data-slate-leaf="true" data-offset-key="6789:0" data-first-offset="true"><span data-slate-string="true">命令执行后，你应该可以看到类似下面的输出。可以看到，正是我们之前加入的 iptables 规则导致了丢包：</span></span></span></div><div data-code-language="sql" data-slate-type="pre" data-slate-object="block" data-key="6790"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6791"><span data-slate-object="text" data-key="6792"><span data-slate-leaf="true" data-offset-key="6792:0" data-first-offset="true"><span data-slate-string="true">Chain OUTPUT (policy ACCEPT </span></span></span><span data-slate-object="text" data-key="6793"><span data-slate-leaf="true" data-offset-key="6793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6794"><span data-slate-leaf="true" data-offset-key="6794:0" data-first-offset="true"><span data-slate-string="true"> packets, </span></span></span><span data-slate-object="text" data-key="6795"><span data-slate-leaf="true" data-offset-key="6795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6796"><span data-slate-leaf="true" data-offset-key="6796:0" data-first-offset="true"><span data-slate-string="true"> bytes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6797"><span data-slate-object="text" data-key="6798"><span data-slate-leaf="true" data-offset-key="6798:0" data-first-offset="true"><span data-slate-string="true"> pkts bytes target     prot opt </span></span></span><span data-slate-object="text" data-key="6799"><span data-slate-leaf="true" data-offset-key="6799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">in</span></span></span></span><span data-slate-object="text" data-key="6800"><span data-slate-leaf="true" data-offset-key="6800:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="6801"><span data-slate-leaf="true" data-offset-key="6801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">out</span></span></span></span><span data-slate-object="text" data-key="6802"><span data-slate-leaf="true" data-offset-key="6802:0" data-first-offset="true"><span data-slate-string="true">     source               destination</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6803"><span data-slate-object="text" data-key="6804"><span data-slate-leaf="true" data-offset-key="6804:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6805"><span data-slate-leaf="true" data-offset-key="6805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="6806"><span data-slate-leaf="true" data-offset-key="6806:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6807"><span data-slate-leaf="true" data-offset-key="6807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">180</span></span></span></span><span data-slate-object="text" data-key="6808"><span data-slate-leaf="true" data-offset-key="6808:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6809"><span data-slate-leaf="true" data-offset-key="6809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">DROP</span></span></span></span><span data-slate-object="text" data-key="6810"><span data-slate-leaf="true" data-offset-key="6810:0" data-first-offset="true"><span data-slate-string="true">       tcp  </span></span></span><span data-slate-object="text" data-key="6811"><span data-slate-leaf="true" data-offset-key="6811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--  *      *       0.0.0.0/0            39.106.233.176       tcp dpt:80</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6812"><span data-slate-object="text" data-key="6813"><span data-slate-leaf="true" data-offset-key="6813:0" data-first-offset="true"><span data-slate-string="true">恭喜，到这里，通过简单的几行 bpftrace 脚本，你就成功使用 eBPF 精确定位了一个常见的网络丢包问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6814"><span data-slate-object="text" data-key="6815"><span data-slate-leaf="true" data-offset-key="6815:0" data-first-offset="true"><span data-slate-string="true">清楚了问题的根源，要解决它当然就很简单了。只要执行下面的命令，把导致丢包的 iptables 规则删除即可：</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="6816"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6817"><span data-slate-object="text" data-key="6818"><span data-slate-leaf="true" data-offset-key="6818:0" data-first-offset="true"><span data-slate-string="true">sudo iptables -D OUTPUT -d </span></span></span><span data-slate-object="text" data-key="6819"><span data-slate-leaf="true" data-offset-key="6819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">39.106</span></span></span></span><span data-slate-object="text" data-key="6820"><span data-slate-leaf="true" data-offset-key="6820:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="6821"><span data-slate-leaf="true" data-offset-key="6821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">233.176</span></span></span></span><span data-slate-object="text" data-key="6822"><span data-slate-leaf="true" data-offset-key="6822:0" data-first-offset="true"><span data-slate-string="true">/</span></span></span><span data-slate-object="text" data-key="6823"><span data-slate-leaf="true" data-offset-key="6823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">32</span></span></span></span><span data-slate-object="text" data-key="6824"><span data-slate-leaf="true" data-offset-key="6824:0" data-first-offset="true"><span data-slate-string="true"> -</span></span></span><span data-slate-object="text" data-key="6825"><span data-slate-leaf="true" data-offset-key="6825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">p</span></span></span></span><span data-slate-object="text" data-key="6826"><span data-slate-leaf="true" data-offset-key="6826:0" data-first-offset="true"><span data-slate-string="true"> tcp -m tcp </span></span></span><span data-slate-object="text" data-key="6827"><span data-slate-leaf="true" data-offset-key="6827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">--dport</span></span></span></span><span data-slate-object="text" data-key="6828"><span data-slate-leaf="true" data-offset-key="6828:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6829"><span data-slate-leaf="true" data-offset-key="6829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">80</span></span></span></span><span data-slate-object="text" data-key="6830"><span data-slate-leaf="true" data-offset-key="6830:0" data-first-offset="true"><span data-slate-string="true"> -j DROP</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6831" id="sr-toc-4"><span data-slate-object="text" data-key="6832"><span data-slate-leaf="true" data-offset-key="6832:0" data-first-offset="true"><span data-slate-string="true">如何根据函数偏移快速定位源码？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6833"><span data-slate-object="text" data-key="6834"><span data-slate-leaf="true" data-offset-key="6834:0" data-first-offset="true"><span data-slate-string="true">在内核栈的输出中，我想你一定注意到每一个函数的输出格式都是</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6835"><span data-slate-object="text" data-key="6836"><span data-slate-leaf="true" data-offset-key="6836:0" data-first-offset="true"><span data-slate-string="true">函数名 + 偏移量</span></span></span></span><span data-slate-object="text" data-key="6837"><span data-slate-leaf="true" data-offset-key="6837:0" data-first-offset="true"><span data-slate-string="true">，而这儿的偏移就是调用下一个函数的位置。那么，能不能根据</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6838"><span data-slate-object="text" data-key="6839"><span data-slate-leaf="true" data-offset-key="6839:0" data-first-offset="true"><span data-slate-string="true">函数名 + 偏移量</span></span></span></span><span data-slate-object="text" data-key="6840"><span data-slate-leaf="true" data-offset-key="6840:0" data-first-offset="true"><span data-slate-string="true">直接定位源码的位置呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6841"><span data-slate-object="text" data-key="6842"><span data-slate-leaf="true" data-offset-key="6842:0" data-first-offset="true"><span data-slate-string="true">答案是肯定的。这是因为，不仅是我们这些 eBPF 学习者想要这种工具，内核开发者为了方便问题的排查，也经常需要根据内核栈，快速定位导致问题发生的代码位置。所以，Linux 内核维护了一个 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6843"><span data-slate-object="text" data-key="6844"><span data-slate-leaf="true" data-offset-key="6844:0" data-first-offset="true"><span data-slate-string="true">faddr2line</span></span></span></a><span data-slate-object="text" data-key="6845"><span data-slate-leaf="true" data-offset-key="6845:0" data-first-offset="true"><span data-slate-string="true"> 脚本，根据</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6846"><span data-slate-object="text" data-key="6847"><span data-slate-leaf="true" data-offset-key="6847:0" data-first-offset="true"><span data-slate-string="true">函数名 + 偏移量</span></span></span></span><span data-slate-object="text" data-key="6848"><span data-slate-leaf="true" data-offset-key="6848:0" data-first-offset="true"><span data-slate-string="true">输出源码文件名和行号。你可以点击</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6849"><span data-slate-object="text" data-key="6850"><span data-slate-leaf="true" data-offset-key="6850:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="6851"><span data-slate-leaf="true" data-offset-key="6851:0" data-first-offset="true"><span data-slate-string="true">，把它下载到本地，然后执行下面的命令加上可执行权限：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="6852"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6853"><span data-slate-object="text" data-key="6854"><span data-slate-leaf="true" data-offset-key="6854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chmod</span></span></span></span><span data-slate-object="text" data-key="6855"><span data-slate-leaf="true" data-offset-key="6855:0" data-first-offset="true"><span data-slate-string="true"> +x faddr2line</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6856"><span data-slate-object="text" data-key="6857"><span data-slate-leaf="true" data-offset-key="6857:0" data-first-offset="true"><span data-slate-string="true">在使用这个脚本之前，你还需要注意两个前提条件：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6858"><div data-slate-type="list-line" data-slate-object="block" data-key="6859"><span data-slate-object="text" data-key="6860"><span data-slate-leaf="true" data-offset-key="6860:0" data-first-offset="true"><span data-slate-string="true">第一，带有调试信息的内核文件，一般名字为 vmlinux（注意，/boot 目录下面的 vmlinz 是压缩后的内核，不可以直接拿来使用）。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6861"><span data-slate-object="text" data-key="6862"><span data-slate-leaf="true" data-offset-key="6862:0" data-first-offset="true"><span data-slate-string="true">第二，系统中需要安装 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6863"><span data-slate-object="text" data-key="6864"><span data-slate-leaf="true" data-offset-key="6864:0" data-first-offset="true"><span data-slate-string="true">awk</span></span></span></span><span data-slate-object="text" data-key="6865"><span data-slate-leaf="true" data-offset-key="6865:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6866"><span data-slate-object="text" data-key="6867"><span data-slate-leaf="true" data-offset-key="6867:0" data-first-offset="true"><span data-slate-string="true">readelf</span></span></span></span><span data-slate-object="text" data-key="6868"><span data-slate-leaf="true" data-offset-key="6868:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6869"><span data-slate-object="text" data-key="6870"><span data-slate-leaf="true" data-offset-key="6870:0" data-first-offset="true"><span data-slate-string="true">addr2line</span></span></span></span><span data-slate-object="text" data-key="6871"><span data-slate-leaf="true" data-offset-key="6871:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6872"><span data-slate-object="text" data-key="6873"><span data-slate-leaf="true" data-offset-key="6873:0" data-first-offset="true"><span data-slate-string="true">size</span></span></span></span><span data-slate-object="text" data-key="6874"><span data-slate-leaf="true" data-offset-key="6874:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6875"><span data-slate-object="text" data-key="6876"><span data-slate-leaf="true" data-offset-key="6876:0" data-first-offset="true"><span data-slate-string="true">nm</span></span></span></span><span data-slate-object="text" data-key="6877"><span data-slate-leaf="true" data-offset-key="6877:0" data-first-offset="true"><span data-slate-string="true"> 等命令。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6878"><span data-slate-object="text" data-key="6879"><span data-slate-leaf="true" data-offset-key="6879:0" data-first-offset="true"><span data-slate-string="true">对于第二个条件，这些命令都包含在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6880"><span data-slate-object="text" data-key="6881"><span data-slate-leaf="true" data-offset-key="6881:0" data-first-offset="true"><span data-slate-string="true">binutils</span></span></span></a><span data-slate-object="text" data-key="6882"><span data-slate-leaf="true" data-offset-key="6882:0" data-first-offset="true"><span data-slate-string="true"> 软件包中，只需要执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6883"><span data-slate-object="text" data-key="6884"><span data-slate-leaf="true" data-offset-key="6884:0" data-first-offset="true"><span data-slate-string="true">apt</span></span></span></span><span data-slate-object="text" data-key="6885"><span data-slate-leaf="true" data-offset-key="6885:0" data-first-offset="true"><span data-slate-string="true"> 或者 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6886"><span data-slate-object="text" data-key="6887"><span data-slate-leaf="true" data-offset-key="6887:0" data-first-offset="true"><span data-slate-string="true">dnf</span></span></span></span><span data-slate-object="text" data-key="6888"><span data-slate-leaf="true" data-offset-key="6888:0" data-first-offset="true"><span data-slate-string="true"> 命令安装即可。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6889"><span data-slate-object="text" data-key="6890"><span data-slate-leaf="true" data-offset-key="6890:0" data-first-offset="true"><span data-slate-string="true">而对第一个条件中的内核调试信息，各个主要的发行版也都提供了相应的软件仓库，你可以根据文档进行安装。比如，对于 Ubuntu 来说，你可以执行下面的命令安装调试信息：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="6891"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6892"><span data-slate-object="text" data-key="6893"><span data-slate-leaf="true" data-offset-key="6893:0" data-first-offset="true"><span data-slate-string="true">codename=$(lsb_release -cs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6894"><span data-slate-object="text" data-key="6895"><span data-slate-leaf="true" data-offset-key="6895:0" data-first-offset="true"><span data-slate-string="true">sudo tee /etc/apt/sources.list.d/ddebs.list &lt;&lt; EOF</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6896"><span data-slate-object="text" data-key="6897"><span data-slate-leaf="true" data-offset-key="6897:0" data-first-offset="true"><span data-slate-string="true">deb http:</span></span></span><span data-slate-object="text" data-key="6898"><span data-slate-leaf="true" data-offset-key="6898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//ddebs.ubuntu.com/ ${codename}      main restricted universe multiverse</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6899"><span data-slate-object="text" data-key="6900"><span data-slate-leaf="true" data-offset-key="6900:0" data-first-offset="true"><span data-slate-string="true">deb http:</span></span></span><span data-slate-object="text" data-key="6901"><span data-slate-leaf="true" data-offset-key="6901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//ddebs.ubuntu.com/ ${codename}-updates  main restricted universe multiverse</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6902"><span data-slate-object="text" data-key="6903"><span data-slate-leaf="true" data-offset-key="6903:0" data-first-offset="true"><span data-slate-string="true">EOF</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6904"><span data-slate-object="text" data-key="6905"><span data-slate-leaf="true" data-offset-key="6905:0" data-first-offset="true"><span data-slate-string="true">sudo apt-</span></span></span><span data-slate-object="text" data-key="6906"><span data-slate-leaf="true" data-offset-key="6906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="6907"><span data-slate-leaf="true" data-offset-key="6907:0" data-first-offset="true"><span data-slate-string="true"> install -y ubuntu-dbgsym-keyring</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6908"><span data-slate-object="text" data-key="6909"><span data-slate-leaf="true" data-offset-key="6909:0" data-first-offset="true"><span data-slate-string="true">sudo apt-</span></span></span><span data-slate-object="text" data-key="6910"><span data-slate-leaf="true" data-offset-key="6910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="6911"><span data-slate-leaf="true" data-offset-key="6911:0" data-first-offset="true"><span data-slate-string="true"> update</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6912"><span data-slate-object="text" data-key="6913"><span data-slate-leaf="true" data-offset-key="6913:0" data-first-offset="true"><span data-slate-string="true">sudo apt-</span></span></span><span data-slate-object="text" data-key="6914"><span data-slate-leaf="true" data-offset-key="6914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="6915"><span data-slate-leaf="true" data-offset-key="6915:0" data-first-offset="true"><span data-slate-string="true"> install -y linux-image-$(uname -r)-dbgsym</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6916"><span data-slate-object="text" data-key="6917"><span data-slate-leaf="true" data-offset-key="6917:0" data-first-offset="true"><span data-slate-string="true">而对于 RHEL8 等系统，则可以执行下面的命令：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="6918"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6919"><span data-slate-object="text" data-key="6920"><span data-slate-leaf="true" data-offset-key="6920:0" data-first-offset="true"><span data-slate-string="true">sudo debuginfo-install kernel-$(uname -r)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6921"><span data-slate-object="text" data-key="6922"><span data-slate-leaf="true" data-offset-key="6922:0" data-first-offset="true"><span data-slate-string="true">调试信息安装好之后，相关的调试文件会放到 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6923"><span data-slate-object="text" data-key="6924"><span data-slate-leaf="true" data-offset-key="6924:0" data-first-offset="true"><span data-slate-string="true">/usr/lib/debug</span></span></span></span><span data-slate-object="text" data-key="6925"><span data-slate-leaf="true" data-offset-key="6925:0" data-first-offset="true"><span data-slate-string="true"> 目录下。不同发行版的目录结构是不同的，但你可以使用下面的命令来搜索 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6926"><span data-slate-object="text" data-key="6927"><span data-slate-leaf="true" data-offset-key="6927:0" data-first-offset="true"><span data-slate-string="true">vmlinux</span></span></span></span><span data-slate-object="text" data-key="6928"><span data-slate-leaf="true" data-offset-key="6928:0" data-first-offset="true"><span data-slate-string="true"> 开头的文件：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="6929"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6930"><span data-slate-object="text" data-key="6931"><span data-slate-leaf="true" data-offset-key="6931:0" data-first-offset="true"><span data-slate-string="true">find /usr/lib/debug/ -name </span></span></span><span data-slate-object="text" data-key="6932"><span data-slate-leaf="true" data-offset-key="6932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'vmlinux*'</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6933"><span data-slate-object="text" data-key="6934"><span data-slate-leaf="true" data-offset-key="6934:0" data-first-offset="true"><span data-slate-string="true">以我使用的 Ubuntu 21.10 为例，查找到的文件路径为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6935"><span data-slate-object="text" data-key="6936"><span data-slate-leaf="true" data-offset-key="6936:0" data-first-offset="true"><span data-slate-string="true">/usr/lib/debug/boot/vmlinux-5.13.0-22-generic</span></span></span></span><span data-slate-object="text" data-key="6937"><span data-slate-leaf="true" data-offset-key="6937:0" data-first-offset="true"><span data-slate-string="true">。所以，接下来，就可以执行下面的命令，对刚才内核栈中的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6938"><span data-slate-object="text" data-key="6939"><span data-slate-leaf="true" data-offset-key="6939:0" data-first-offset="true"><span data-slate-string="true">__ip_local_out+219</span></span></span></span><span data-slate-object="text" data-key="6940"><span data-slate-leaf="true" data-offset-key="6940:0" data-first-offset="true"><span data-slate-string="true"> 进行定位：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="6941"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6942"><span data-slate-object="text" data-key="6943"><span data-slate-leaf="true" data-offset-key="6943:0" data-first-offset="true"><span data-slate-string="true">faddr2line /usr/lib/debug/boot/vmlinux-5.13.0-22-generic __ip_local_out+219</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6944"><span data-slate-object="text" data-key="6945"><span data-slate-leaf="true" data-offset-key="6945:0" data-first-offset="true"><span data-slate-string="true">命令执行后，可以得到下面的输出：</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="6946"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6947"><span data-slate-object="text" data-key="6948"><span data-slate-leaf="true" data-offset-key="6948:0" data-first-offset="true"><span data-slate-string="true">__ip_local_out+219/0x150:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6949"><span data-slate-object="text" data-key="6950"><span data-slate-leaf="true" data-offset-key="6950:0" data-first-offset="true"><span data-slate-string="true">nf_hook at include/linux/netfilter.h:256</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6951"><span data-slate-object="text" data-key="6952"><span data-slate-leaf="true" data-offset-key="6952:0" data-first-offset="true"><span data-slate-string="true">(inlined by) __ip_local_out at net/ipv4/ip_output.c:115</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6953"><span data-slate-object="text" data-key="6954"><span data-slate-leaf="true" data-offset-key="6954:0" data-first-offset="true"><span data-slate-string="true">这个输出中的具体内容含义如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6955"><div data-slate-type="list-line" data-slate-object="block" data-key="6956"><span data-slate-object="text" data-key="6957"><span data-slate-leaf="true" data-offset-key="6957:0" data-first-offset="true"><span data-slate-string="true">第二行表示 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6958"><span data-slate-object="text" data-key="6959"><span data-slate-leaf="true" data-offset-key="6959:0" data-first-offset="true"><span data-slate-string="true">nf_hook</span></span></span></span><span data-slate-object="text" data-key="6960"><span data-slate-leaf="true" data-offset-key="6960:0" data-first-offset="true"><span data-slate-string="true"> 的定义位置在 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6961"><span data-slate-object="text" data-key="6962"><span data-slate-leaf="true" data-offset-key="6962:0" data-first-offset="true"><span data-slate-string="true">netfilter.h</span></span></span></span><span data-slate-object="text" data-key="6963"><span data-slate-leaf="true" data-offset-key="6963:0" data-first-offset="true"><span data-slate-string="true"> 的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6964"><span data-slate-object="text" data-key="6965"><span data-slate-leaf="true" data-offset-key="6965:0" data-first-offset="true"><span data-slate-string="true"> 156</span></span></span></span><span data-slate-object="text" data-key="6966"><span data-slate-leaf="true" data-offset-key="6966:0" data-first-offset="true"><span data-slate-string="true"> 行。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6967"><span data-slate-object="text" data-key="6968"><span data-slate-leaf="true" data-offset-key="6968:0" data-first-offset="true"><span data-slate-string="true">第三行表示 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6969"><span data-slate-object="text" data-key="6970"><span data-slate-leaf="true" data-offset-key="6970:0" data-first-offset="true"><span data-slate-string="true">net/ipv4/ip_output.c</span></span></span></span><span data-slate-object="text" data-key="6971"><span data-slate-leaf="true" data-offset-key="6971:0" data-first-offset="true"><span data-slate-string="true"> 的 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6972"><span data-slate-object="text" data-key="6973"><span data-slate-leaf="true" data-offset-key="6973:0" data-first-offset="true"><span data-slate-string="true">115</span></span></span></span><span data-slate-object="text" data-key="6974"><span data-slate-leaf="true" data-offset-key="6974:0" data-first-offset="true"><span data-slate-string="true"> 行调用了 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6975"><span data-slate-object="text" data-key="6976"><span data-slate-leaf="true" data-offset-key="6976:0" data-first-offset="true"><span data-slate-string="true">kfree_skb</span></span></span></span><span data-slate-object="text" data-key="6977"><span data-slate-leaf="true" data-offset-key="6977:0" data-first-offset="true"><span data-slate-string="true"> 函数。但是，由于 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6978"><span data-slate-object="text" data-key="6979"><span data-slate-leaf="true" data-offset-key="6979:0" data-first-offset="true"><span data-slate-string="true">nf_hook</span></span></span></span><span data-slate-object="text" data-key="6980"><span data-slate-leaf="true" data-offset-key="6980:0" data-first-offset="true"><span data-slate-string="true"> 是一个内联函数，所以行号</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6981"><span data-slate-object="text" data-key="6982"><span data-slate-leaf="true" data-offset-key="6982:0" data-first-offset="true"><span data-slate-string="true"> 115</span></span></span></span><span data-slate-object="text" data-key="6983"><span data-slate-leaf="true" data-offset-key="6983:0" data-first-offset="true"><span data-slate-string="true"> 实际上是内联函数 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6984"><span data-slate-object="text" data-key="6985"><span data-slate-leaf="true" data-offset-key="6985:0" data-first-offset="true"><span data-slate-string="true">nf_hook</span></span></span></span><span data-slate-object="text" data-key="6986"><span data-slate-leaf="true" data-offset-key="6986:0" data-first-offset="true"><span data-slate-string="true"> 的调用位置。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6987"><span data-slate-object="text" data-key="6988"><span data-slate-leaf="true" data-offset-key="6988:0" data-first-offset="true"><span data-slate-string="true">对比一下上一个模块查找的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6989"><span data-slate-object="text" data-key="6990"><span data-slate-leaf="true" data-offset-key="6990:0" data-first-offset="true"><span data-slate-string="true">内核源码</span></span></span></a><span data-slate-object="text" data-key="6991"><span data-slate-leaf="true" data-offset-key="6991:0" data-first-offset="true"><span data-slate-string="true">，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6992"><span data-slate-object="text" data-key="6993"><span data-slate-leaf="true" data-offset-key="6993:0" data-first-offset="true"><span data-slate-string="true">net/ipv4/ip_output.c</span></span></span></span><span data-slate-object="text" data-key="6994"><span data-slate-leaf="true" data-offset-key="6994:0" data-first-offset="true"><span data-slate-string="true"> 的 115 号也刚好是调用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="6995"><span data-slate-object="text" data-key="6996"><span data-slate-leaf="true" data-offset-key="6996:0" data-first-offset="true"><span data-slate-string="true">nf_hook</span></span></span></span><span data-slate-object="text" data-key="6997"><span data-slate-leaf="true" data-offset-key="6997:0" data-first-offset="true"><span data-slate-string="true"> 的位置：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6998"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/31/6a/311b02beafc800c2bba434d24aa7b56a.png?wh=703x352"></div><div>__ip_local_out 源码</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6999"><span data-slate-object="text" data-key="7000"><span data-slate-leaf="true" data-offset-key="7000:0" data-first-offset="true"><span data-slate-string="true">而再点击 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7001"><span data-slate-object="text" data-key="7002"><span data-slate-leaf="true" data-offset-key="7002:0" data-first-offset="true"><span data-slate-string="true">nf_hook</span></span></span></a><span data-slate-object="text" data-key="7003"><span data-slate-leaf="true" data-offset-key="7003:0" data-first-offset="true"><span data-slate-string="true"> 继续去看它的定义，你可以发现，这的确是个内联函数：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="7004"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7005"><span data-slate-object="text" data-key="7006"><span data-slate-leaf="true" data-offset-key="7006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="7007"><span data-slate-leaf="true" data-offset-key="7007:0" data-first-offset="true"><span data-slate-string="true"> inline </span></span></span><span data-slate-object="text" data-key="7008"><span data-slate-leaf="true" data-offset-key="7008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="7009"><span data-slate-leaf="true" data-offset-key="7009:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7010"><span data-slate-leaf="true" data-offset-key="7010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nf_hook</span></span></span></span><span data-slate-object="text" data-key="7011"><span data-slate-leaf="true" data-offset-key="7011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(...)</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="block-quote" data-slate-object="block" data-key="7012"><div data-slate-type="quote-line" data-slate-object="block" data-key="7013"><span data-slate-object="text" data-key="7014"><span data-slate-leaf="true" data-offset-key="7014:0" data-first-offset="true"><span data-slate-string="true">小提示：内联是一种常用的编程优化技术，它告诉编译器把指定函数展开之后再进行编译，这样就省去了函数调用的开销。对频繁调用的小函数来说，这就可以大大提高程序的运行效率。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7015"><span data-slate-object="text" data-key="7016"><span data-slate-leaf="true" data-offset-key="7016:0" data-first-offset="true"><span data-slate-string="true">有了 faddr2line 工具，在以后排查内核协议栈时，你就可以根据栈中</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7017"><span data-slate-object="text" data-key="7018"><span data-slate-leaf="true" data-offset-key="7018:0" data-first-offset="true"><span data-slate-string="true">函数名 + 偏移量</span></span></span></span><span data-slate-object="text" data-key="7019"><span data-slate-leaf="true" data-offset-key="7019:0" data-first-offset="true"><span data-slate-string="true">，直接定位到源代码的位置。这样，你就可以直接去内核源码或 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7020"><span data-slate-object="text" data-key="7021"><span data-slate-leaf="true" data-offset-key="7021:0" data-first-offset="true"><span data-slate-string="true">elixir.bootlin.com</span></span></span></a><span data-slate-object="text" data-key="7022"><span data-slate-leaf="true" data-offset-key="7022:0" data-first-offset="true"><span data-slate-string="true"> 网站中查找相关函数的实现逻辑，进而更深层次地理解内核的实现原理。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7023" id="sr-toc-5"><span data-slate-object="text" data-key="7024"><span data-slate-leaf="true" data-offset-key="7024:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7025"><span data-slate-object="text" data-key="7026"><span data-slate-leaf="true" data-offset-key="7026:0" data-first-offset="true"><span data-slate-string="true">今天，我带你一起梳理了 eBPF 的网络功能，并以最常见的网络丢包问题为例，使用 bpftrace 开发了一个跟踪内核网络协议栈的 eBPF 程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7027"><span data-slate-object="text" data-key="7028"><span data-slate-leaf="true" data-offset-key="7028:0" data-first-offset="true"><span data-slate-string="true">eBPF 不仅诞生于网络过滤，它在网络方面的应用也是最为广泛和活跃的。由于内核协议栈也是内核的核心组成部分，前几讲我们讲到的 kprobe 跟踪、uprobe/USDT 跟踪等，也都可以应用到网络问题的跟踪和排查上来。由于内核协议栈相对比较复杂，在排查网络问题时，我们可以从内核调用栈入手。根据调用栈的执行过程，再配合 faddr2line 这样的工具，你就可以快速定位到问题发生所在的内核源码，进而找出问题的根源。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7029"><span data-slate-object="text" data-key="7030"><span data-slate-leaf="true" data-offset-key="7030:0" data-first-offset="true"><span data-slate-string="true">实际上，我们今天讲到的调用栈跟踪也可以用到其他内核功能和用户应用的跟踪上，并且也特别适用于性能优化领域经常需要的热点函数跟踪。在后续的课程中，我还将为你介绍更多的应用案例。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7031" id="sr-toc-6"><span data-slate-object="text" data-key="7032"><span data-slate-leaf="true" data-offset-key="7032:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7033"><span data-slate-object="text" data-key="7034"><span data-slate-leaf="true" data-offset-key="7034:0" data-first-offset="true"><span data-slate-string="true">由于加入了进程信息和网络协议的限制，今天我们使用 bpftrace 开发的 eBPF 程序，实际上只能跟踪到 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7035"><span data-slate-object="text" data-key="7036"><span data-slate-leaf="true" data-offset-key="7036:0" data-first-offset="true"><span data-slate-string="true">curl</span></span></span></span><span data-slate-object="text" data-key="7037"><span data-slate-leaf="true" data-offset-key="7037:0" data-first-offset="true"><span data-slate-string="true"> 命令发出的 TCP 请求丢包问题。而在实际的应用中，很可能是其他的进程发生了丢包问题，并且丢包的也不一定都是 TCP 协议。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7038"><span data-slate-object="text" data-key="7039"><span data-slate-leaf="true" data-offset-key="7039:0" data-first-offset="true"><span data-slate-string="true">那么，根据这一讲的内容和 bpftrace 的文档，你可以对今天的跟踪程序进行改进，并把进程信息（如 PID 和进程名）加到输出中吗？欢迎在评论区和我分享你的思路和解决方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7040"><span data-slate-object="text" data-key="7041"><span data-slate-leaf="true" data-offset-key="7041:0" data-first-offset="true"><span data-slate-string="true">期待你在留言区和我讨论，也欢迎把这节课分享给你的同事、朋友。让我们一起在实战中演练，在交流中进步。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/94/c1/9415076c60e63fc6303d9a3bc900b5c1.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-7">精选留言 (6)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/5e/96/a03175bc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>莫名</span></div></div><div>1、比较赞同【最主要是因为不清楚内核中都有哪些函数和跟踪点可以拿来跟踪】这一观点。如果对内核不熟悉，借助 tracepoint 通配符可以很好的协助理解网络协议栈的关键路径。举两个简单例子。

&gt; 例 1：追踪 net 相关追踪点以及调用堆栈：

# bpftrace -e 'tracepoint:net:* {printf ("% s (% d): % s % s\n", comm, pid, probe, kstack ()); }'

输出示例（sshd 发送数据包关键路径，涉及 tracepoint:net:net_dev_queue、tracepoint:net:net_dev_xmit 等追踪点，可以借助这些追踪点可进一步计算数据包排队时间等）：

sshd (219966): tracepoint:net:net_dev_queue
        __dev_queue_xmit+1524
        dev_queue_xmit+16
        ip_finish_output2+718
        __ip_finish_output+191
        ip_finish_output+54
        ip_output+112
        ip_local_out+53
        __ip_queue_xmit+354
        ip_queue_xmit+16
        __tcp_transmit_skb+1407
        tcp_write_xmit+982
        __tcp_push_pending_frames+57
        tcp_push+219
        tcp_sendmsg_locked+2415
        tcp_sendmsg+44
        inet_sendmsg+59
        sock_write_iter+156
        new_sync_write+287
        __vfs_write+38
        vfs_write+171
        ksys_write+97
        __x64_sys_write+26
        do_syscall_64+71
        entry_SYSCALL_64_after_hwframe+68

sshd (219966): tracepoint:net:net_dev_xmit
        dev_hard_start_xmit+368
        dev_hard_start_xmit+368
        sch_direct_xmit+278
        __dev_queue_xmit+1713
        dev_queue_xmit+16
        ip_finish_output2+718
        ...
        __x64_sys_write+26
        do_syscall_64+71
        entry_SYSCALL_64_after_hwframe+68

&gt; 例 2：使用 perf trace 也比较方便：

# perf trace --no-syscalls -e 'net:*' curl -s time.geekbang.org &gt; /dev/null

输出示例（可以看到具体走了哪些网络设备、数据包长度、skb 内存地址等）：

0.439 curl/2240 net:net_dev_queue:dev=eth1 skbaddr=... len=54
0.452 curl/2240 net:net_dev_start_xmit:dev=eth1 skbaddr=... len=54
0.455 curl/2240 net:net_dev_xmit:dev=eth1 skbaddr=... len=54
0.707 curl/2240 net:netif_receive_skb:dev=eth1 skbaddr=... len=52

2、dropwatch.bt 头文件有些没使用到，可以做下简化：

#include &lt;linux/skbuff.h&gt;
#include &lt;linux/ip.h&gt;
#include &lt;linux/socket.h&gt;
#include &lt;linux/netdevice.h&gt;

=====================&gt;

#include &lt;linux/skbuff.h&gt;
#include &lt;net/ip.h&gt;

思考题直接用 bpftrace 内置变量 comm、pid 即可。</div><div><p>作者回复：非常👍的答案！也谢谢分享跟踪点学习的经验！</p></div><div><div>2022-02-07</div><div><div><i></i><span>2</span></div><div><i></i><span>13</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/8a/b0/6ab66f1b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 牛金霖</span></div></div><div>老师，请问如何获取 5.16 的 debuginfo</div><div><div>2022-07-24</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/27/c5/d4d00da2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>为了维护世界和平</span></div></div><div>github 上的程序 执行 段错误
#bpftrace dropwatch.bt
Segmentation fault (core dumped)
</div><div><div>2022-07-19</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/0e/d64d4663.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>k8svip</span></div></div><div>老师 如何跟踪下 PHP-fpm 线程，去处理 MySQL 域名解析的过程呢？偶现连不通的情况，回出现 udp receive error 包数量增加，tcpdump 又捕获不到</div><div><p>作者回复：可以考虑去跟踪 DNS 请求？这可能比跟踪进程更简单一些</p></div><div><div>2022-03-16</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>从远方过来</span></div></div><div>老师，看了你举的查找 SKB 的例子，我很好奇要怎么才能快速地从内核相关文档中找到相关的函数呢？  例如：找出关于内存分配的函数，  这个有什么好窍门么？</div><div><p>作者回复：最容易的就是使用 eBPF 跟踪系统调用相关的内核栈，然后对栈中的相关函数进行跟踪。当然，如果熟悉内核代码，去内核源码查看更好。</p></div><div><div>2022-02-24</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/28/1c/adf427a5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>湛. bin</span></div></div><div>ubuntu 18.04 ,snap 安装的 bpftrace,kernel symbol 解析失败
➜  ~ bpftrace -V
bpftrace v0.13.0
➜  ~ echo $BPFTRACE_VMLINUX
/usr/lib/debug/boot/vmlinux-5.4.0-96-generic
➜  ~ uname -a              
Linux max-machine 5.4.0-96-generic #109~18.04.1-Ubuntu SMP Thu Jan 13 15:06:26 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
➜  ~                       
sudo bpftrace -e 'kprobe:kfree_skb /comm=="curl"/ {printf ("kstack: % s\n", kstack);}'
[sudo] password for max: 
Attaching 1 probe...
kstack: 
        0xffffffff9091b941
        0xffffffff90a5f5f7
        0xffffffff90914e41
        0xffffffff90a5eae9
        0xffffffff909f4009
        0xffffffff90a351c0
        0xffffffff9090b8e2
        0xffffffff9090b975
        0xffffffff902e0276
        0xffffffff902e047e
        0xffffffff900c493d
        0xffffffff90003ec9
        0xffffffff90004320
        0xffffffff90c0008c

kstack: 
        0xffffffff9091b941
        0xffffffff90a5f5f7
        0xffffffff90914e41
        0xffffffff90a5eae9
        0xffffffff909f4009
        0xffffffff90a351c0
        0xffffffff9090b8e2
        0xffffffff9090b975
        0xffffffff902e0276
        0xffffffff902e047e
        0xffffffff900c493d
        0xffffffff90003ec9
        0xffffffff90004320
        0xffffffff90c0008c

kstack: 
        0xffffffff9091b941
        0xffffffff9090fad3
        0xffffffff9090fb6a
        0xffffffff90004207
        0xffffffff90c0008c

kstack: 
        0xffffffff9091b941
        0xffffffff9090fad3
        0xffffffff9090fb6a
        0xffffffff90004207
        0xffffffff90c0008c

</div><div><p>作者回复：有没有使用 snap install --devmode 来安装？Github 上面也有个类似的 issuehttps://github.com/iovisor/bpftrace/issues/1488。旧的发行版最好还是从源码安装 BCC 和 bpftrace。</p></div><div><div>2022-02-07</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".w"><outline class="toc-level-h1" data-reactid=".w.0" style="width: 175px;"><active data-reactid=".w.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".w.0.1"><span data-reactid=".w.0.1.0">10 | 网络跟踪：如何使用 eBPF 排查网络问题？</span></a></outline><outline class="toc-level-h2" data-reactid=".w.1" style="width: 165px;"><active data-reactid=".w.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".w.1.1"><span data-reactid=".w.1.1.0">eBPF 提供了哪些网络功能？</span></a></outline><outline class="toc-level-h2" data-reactid=".w.2" style="width: 165px;"><active data-reactid=".w.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".w.2.1"><span data-reactid=".w.2.1.0">如何跟踪内核网络协议栈？</span></a></outline><outline class="toc-level-h2" data-reactid=".w.3" style="width: 165px;"><active data-reactid=".w.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".w.3.1"><span data-reactid=".w.3.1.0">如何排查网络丢包问题？</span></a></outline><outline class="toc-level-h2" data-reactid=".w.4" style="width: 165px;"><active data-reactid=".w.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".w.4.1"><span data-reactid=".w.4.1.0">如何根据函数偏移快速定位源码？</span></a></outline><outline class="toc-level-h2" data-reactid=".w.5" style="width: 165px;"><active data-reactid=".w.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".w.5.1"><span data-reactid=".w.5.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".w.6" style="width: 165px;"><active data-reactid=".w.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".w.6.1"><span data-reactid=".w.6.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".w.7" style="width: 165px;"><active data-reactid=".w.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".w.7.1"><span data-reactid=".w.7.1.0">精选留言 (6)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/484686" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>