
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 19 | TimingWheel：探究 Kafka 定时器背后的高效时间轮算法</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>19 | TimingWheel：探究 Kafka 定时器背后的高效时间轮算法</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">学完了今天的课程之后，你不但能够说出 4 种 Leader 选举的场景，还能总结出它们的共性。对于面试来说，绝对是个加分项！</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">19 | TimingWheel：探究 Kafka 定时器背后的高效时间轮算法</h1><div><span>胡夕</span> <span> 2020-06-06</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a2/ec/a2b1937d7784e4eba4b7bdd4616c00ec.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：20.76M</span><span> 时长：22:41</span></div></div><audio title="19 | TimingWheel：探究Kafka定时器背后的高效时间轮算法" src="https://res001.geekbang.org//media/audio/2b/03/2b009cd5a52215c17768554f58c8af03/ld/ld.m3u8" __idm_id__="57346"></audio></div><div><div><div><div data-slate-editor="true" data-key="1450" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="1451"><span data-slate-object="text" data-key="1452"><span data-slate-leaf="true" data-offset-key="1452:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。今天，我们开始学习 Kafka 延时请求的代码实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1453"><span data-slate-object="text" data-key="1454"><span data-slate-leaf="true" data-offset-key="1454:0" data-first-offset="true"><span data-slate-string="true">延时请求（Delayed Operation），也称延迟请求，是指因未满足条件而暂时无法被处理的 Kafka 请求。举个例子，配置了 acks=all 的生产者发送的请求可能一时无法完成，因为 Kafka 必须确保 ISR 中的所有副本都要成功响应这次写入。因此，通常情况下，这些请求没法被立即处理。只有满足了条件或发生了超时，Kafka 才会把该请求标记为完成状态。这就是所谓的延时请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1455"><span data-slate-object="text" data-key="1456"><span data-slate-leaf="true" data-offset-key="1456:0" data-first-offset="true"><span data-slate-string="true">今天，我们的重点是弄明白请求被延时处理的机制 —— 分层时间轮算法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1457"><span data-slate-object="text" data-key="1458"><span data-slate-leaf="true" data-offset-key="1458:0" data-first-offset="true"><span data-slate-string="true">时间轮的应用范围非常广。很多操作系统的定时任务调度（如 Crontab）以及通信框架（如 Netty 等）都利用了时间轮的思想。几乎所有的时间任务调度系统都是基于时间轮算法的。Kafka 应用基于时间轮算法管理延迟请求的代码简洁精炼，而且和业务逻辑代码完全解耦，你可以从 0 到 1 地照搬到你自己的项目工程中。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1459" id="sr-toc-1"><span data-slate-object="text" data-key="1460"><span data-slate-leaf="true" data-offset-key="1460:0" data-first-offset="true"><span data-slate-string="true">时间轮简介</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1461"><span data-slate-object="text" data-key="1462"><span data-slate-leaf="true" data-offset-key="1462:0" data-first-offset="true"><span data-slate-string="true">在开始介绍时间轮之前，我想先请你思考这样一个问题：“如果是你，你会怎么实现 Kafka 中的延时请求呢？”</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1463"><span data-slate-object="text" data-key="1464"><span data-slate-leaf="true" data-offset-key="1464:0" data-first-offset="true"><span data-slate-string="true">针对这个问题，我的第一反应是使用 Java 的 DelayQueue。毕竟，这个类是 Java 天然提供的延时队列，非常适合建模延时对象处理。实际上，Kafka 的第一版延时请求就是使用 DelayQueue 做的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1465"><span data-slate-object="text" data-key="1466"><span data-slate-leaf="true" data-offset-key="1466:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_0a74f5fa" data-attr-id="34474" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">但是，DelayQueue 有一个弊端：它插入和删除队列元素的时间复杂度是 O (logN)。对于 Kafka 这种非常容易积攒几十万个延时请求的场景来说，该数据结构的性能是瓶颈。</span></span></span><span data-slate-leaf="true" data-offset-key="1466:1"><span data-slate-string="true">当然，这一版的设计还有其他弊端，比如，它在清除已过期的延迟请求方面不够高效，可能会出现内存溢出的情形。后来，社区改造了延时请求的实现机制，采用了基于时间轮的方案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1467"><span data-slate-object="text" data-key="1468"><span data-slate-leaf="true" data-offset-key="1468:0" data-first-offset="true"><span data-slate-string="true">时间轮有简单时间轮（Simple Timing Wheel）和分层时间轮（Hierarchical Timing Wheel）两类。两者各有利弊，也都有各自的使用场景。Kafka 采用的是分层时间轮，这是我们重点学习的内容。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1469"><span data-slate-object="text" data-key="1470"><span data-slate-leaf="true" data-offset-key="1470:0" data-first-offset="true"><span data-slate-string="true">关于分层时间轮，有很多严谨的科学论文。不过，大多数的论文读起来晦涩难懂，而且偏理论研究。然而，我们并非是要完整系统地学习这套机制，我们关心的是如何将其应用于实践当中。要做到这一点，结合着源码来学习就是一个不错的途径。你需要关注，在代码层面，Kafka 是如何实现多层时间轮的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1471"><span data-slate-object="text" data-key="1472"><span data-slate-leaf="true" data-offset-key="1472:0" data-first-offset="true"><span data-slate-string="true">“时间轮” 的概念稍微有点抽象，我用一个生活中的例子，来帮助你建立一些初始印象。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1473"><span data-slate-object="text" data-key="1474"><span data-slate-leaf="true" data-offset-key="1474:0" data-first-offset="true"><span data-slate-string="true">想想我们生活中的手表。手表由时针、分针和秒针组成，它们各自有独立的刻度，但又彼此相关：秒针转动一圈，分针会向前推进一格；分针转动一圈，时针会向前推进一格。这就是典型的分层时间轮。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1475"><span data-slate-object="text" data-key="1476"><span data-slate-leaf="true" data-offset-key="1476:0" data-first-offset="true"><span data-slate-string="true">和手表不太一样的是，Kafka 自己有专门的术语。在 Kafka 中，手表中的 “一格” 叫 “一个桶（Bucket）”，而 “推进” 对应于 Kafka 中的 “滴答”，也就是 tick。后面你在阅读源码的时候，会频繁地看到 Bucket、tick 字眼，你可以把它们理解成手表刻度盘面上的 “一格” 和 “向前推进” 的意思。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1477"><span data-slate-object="text" data-key="1478"><span data-slate-leaf="true" data-offset-key="1478:0" data-first-offset="true"><span data-slate-string="true">除此之外，每个 Bucket 下也不是白板一块，它实际上是一个双向循环链表（Doubly Linked Cyclic List），里面保存了一组延时请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1479"><span data-slate-object="text" data-key="1480"><span data-slate-leaf="true" data-offset-key="1480:0" data-first-offset="true"><span data-slate-string="true">我先用一张图帮你理解下双向循环链表。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1481"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/fd/ed/fdcdc45c1c6adc87192e6101be7793ed.png?wh=2380*600"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1482"><span data-slate-object="text" data-key="1483"><span data-slate-leaf="true" data-offset-key="1483:0" data-first-offset="true"><span data-slate-string="true">图中的每个节点都有一个 next 和 prev 指针，分别指向下一个元素和上一个元素。Root 是链表的头部节点，不包含任何实际数据。它的 next 指针指向链表的第一个元素，而 prev 指针指向最后一个元素。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1484"><span data-slate-object="text" data-key="1485"><span data-slate-leaf="true" data-offset-key="1485:0" data-first-offset="true"><span data-slate-string="true">由于是双向链表结构，因此，代码能够利用 next 和 prev 两个指针快速地定位元素，因此，在 Bucket 下插入和删除一个元素的时间复杂度是 O (1)。当然，双向链表要求同时保存两个指针数据，在节省时间的同时消耗了更多的空间。在算法领域，这是典型的用空间去换时间的优化思想。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1486" id="sr-toc-2"><span data-slate-object="text" data-key="1487"><span data-slate-leaf="true" data-offset-key="1487:0" data-first-offset="true"><span data-slate-string="true">源码层级关系</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1488"><span data-slate-object="text" data-key="1489"><span data-slate-leaf="true" data-offset-key="1489:0" data-first-offset="true"><span data-slate-string="true">在 Kafka 中，具体是怎么应用分层时间轮实现请求队列的呢？</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1490"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/0d/f6/0d6eddb652a975f10563b594c77fd1f6.png?wh=2585*1020"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1491"><span data-slate-object="text" data-key="1492"><span data-slate-leaf="true" data-offset-key="1492:0" data-first-offset="true"><span data-slate-string="true">图中的时间轮共有两个层级，分别是 Level 0 和 Level 1。每个时间轮有 8 个 Bucket，每个 Bucket 下是一个双向循环链表，用来保存延迟请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1493"><span data-slate-object="text" data-key="1494"><span data-slate-leaf="true" data-offset-key="1494:0" data-first-offset="true"><span data-slate-string="true">在 Kafka 源码中，时间轮对应 utils.timer 包下的 TimingWheel 类，每个 Bucket 下的链表对应 TimerTaskList 类，链表元素对应 TimerTaskEntry 类，而每个链表元素里面保存的延时任务对应 TimerTask。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1495"><span data-slate-object="text" data-key="1496"><span data-slate-leaf="true" data-offset-key="1496:0" data-first-offset="true"><span data-slate-string="true">在这些类中，TimerTaskEntry 与 TimerTask 是 1 对 1 的关系，TimerTaskList 下包含多个 TimerTaskEntry，TimingWheel 包含多个 TimerTaskList。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1497"><span data-slate-object="text" data-key="1498"><span data-slate-leaf="true" data-offset-key="1498:0" data-first-offset="true"><span data-slate-string="true">我画了一张 UML 图，帮助你理解这些类之间的对应关系：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1499"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/2b/17/2b127feffa2475ca14b0c3ae5ca47817.png?wh=4060*405"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1500" id="sr-toc-3"><span data-slate-object="text" data-key="1501"><span data-slate-leaf="true" data-offset-key="1501:0" data-first-offset="true"><span data-slate-string="true">时间轮各个类源码定义</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1502"><span data-slate-object="text" data-key="1503"><span data-slate-leaf="true" data-offset-key="1503:0" data-first-offset="true"><span data-slate-string="true">掌握了这些基础知识，下面我就结合这些源码，来解释下延迟请求是如何被这套分层时间轮管理的。根据调用关系，我采用自底向上的方法给出它们的定义。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1504" id="sr-toc-4"><span data-slate-object="text" data-key="1505"><span data-slate-leaf="true" data-offset-key="1505:0" data-first-offset="true"><span data-slate-string="true">TimerTask 类</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1506"><span data-slate-object="text" data-key="1507"><span data-slate-leaf="true" data-offset-key="1507:0" data-first-offset="true"><span data-slate-string="true">首先是 TimerTask 类。该类位于 utils.timer 包下的 TimerTask.scala 文件中。它的代码只有几十行，非常容易理解。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="1508"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1509"><span data-slate-object="text" data-key="1510"><span data-slate-leaf="true" data-offset-key="1510:0" data-first-offset="true"><span data-slate-string="true">trait TimerTask </span></span></span><span data-slate-object="text" data-key="1511"><span data-slate-leaf="true" data-offset-key="1511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="1512"><span data-slate-leaf="true" data-offset-key="1512:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1513"><span data-slate-leaf="true" data-offset-key="1513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Runnable</span></span></span></span><span data-slate-object="text" data-key="1514"><span data-slate-leaf="true" data-offset-key="1514:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1515"><span data-slate-object="text" data-key="1516"><span data-slate-leaf="true" data-offset-key="1516:0" data-first-offset="true"><span data-slate-string="true">  val delayMs: Long </span></span></span><span data-slate-object="text" data-key="1517"><span data-slate-leaf="true" data-offset-key="1517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通常是 request.timeout.ms 参数值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1518"><span data-slate-object="text" data-key="1519"><span data-slate-leaf="true" data-offset-key="1519:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1520"><span data-slate-leaf="true" data-offset-key="1520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每个 TimerTask 实例关联一个 TimerTaskEntry</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1521"><span data-slate-object="text" data-key="1522"><span data-slate-leaf="true" data-offset-key="1522:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1523"><span data-slate-leaf="true" data-offset-key="1523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 就是说每个定时任务需要知道它在哪个 Bucket 链表下的哪个链表元素上</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1524"><span data-slate-object="text" data-key="1525"><span data-slate-leaf="true" data-offset-key="1525:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1526"><span data-slate-leaf="true" data-offset-key="1526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="1527"><span data-slate-leaf="true" data-offset-key="1527:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1528"><span data-slate-leaf="true" data-offset-key="1528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="1529"><span data-slate-leaf="true" data-offset-key="1529:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="1530"><span data-slate-leaf="true" data-offset-key="1530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1531"><span data-slate-leaf="true" data-offset-key="1531:0" data-first-offset="true"><span data-slate-string="true"> timerTaskEntry: TimerTaskEntry = </span></span></span><span data-slate-object="text" data-key="1532"><span data-slate-leaf="true" data-offset-key="1532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1533"><span data-slate-object="text" data-key="1534"><span data-slate-leaf="true" data-offset-key="1534:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1535"><span data-slate-leaf="true" data-offset-key="1535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 取消定时任务，原理就是将关联的 timerTaskEntry 置空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1536"><span data-slate-object="text" data-key="1537"><span data-slate-leaf="true" data-offset-key="1537:0" data-first-offset="true"><span data-slate-string="true">  def </span></span></span><span data-slate-object="text" data-key="1538"><span data-slate-leaf="true" data-offset-key="1538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cancel</span></span></span></span><span data-slate-object="text" data-key="1539"><span data-slate-leaf="true" data-offset-key="1539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="1540"><span data-slate-leaf="true" data-offset-key="1540:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1541"><span data-slate-object="text" data-key="1542"><span data-slate-leaf="true" data-offset-key="1542:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1543"><span data-slate-leaf="true" data-offset-key="1543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="1544"><span data-slate-leaf="true" data-offset-key="1544:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1545"><span data-slate-object="text" data-key="1546"><span data-slate-leaf="true" data-offset-key="1546:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1547"><span data-slate-leaf="true" data-offset-key="1547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1548"><span data-slate-leaf="true" data-offset-key="1548:0" data-first-offset="true"><span data-slate-string="true"> (timerTaskEntry != </span></span></span><span data-slate-object="text" data-key="1549"><span data-slate-leaf="true" data-offset-key="1549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="1550"><span data-slate-leaf="true" data-offset-key="1550:0" data-first-offset="true"><span data-slate-string="true">) timerTaskEntry.remove()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1551"><span data-slate-object="text" data-key="1552"><span data-slate-leaf="true" data-offset-key="1552:0" data-first-offset="true"><span data-slate-string="true">      timerTaskEntry = </span></span></span><span data-slate-object="text" data-key="1553"><span data-slate-leaf="true" data-offset-key="1553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1554"><span data-slate-object="text" data-key="1555"><span data-slate-leaf="true" data-offset-key="1555:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1556"><span data-slate-object="text" data-key="1557"><span data-slate-leaf="true" data-offset-key="1557:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1558"><span data-slate-object="text" data-key="1559"><span data-slate-leaf="true" data-offset-key="1559:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1560"><span data-slate-leaf="true" data-offset-key="1560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关联 timerTaskEntry，原理是给 timerTaskEntry 字段赋值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1561"><span data-slate-object="text" data-key="1562"><span data-slate-leaf="true" data-offset-key="1562:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1563"><span data-slate-leaf="true" data-offset-key="1563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="1564"><span data-slate-leaf="true" data-offset-key="1564:0" data-first-offset="true"><span data-slate-string="true">[timer] def </span></span></span><span data-slate-object="text" data-key="1565"><span data-slate-leaf="true" data-offset-key="1565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">setTimerTaskEntry</span></span></span></span><span data-slate-object="text" data-key="1566"><span data-slate-leaf="true" data-offset-key="1566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(entry: TimerTaskEntry)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1567"><span data-slate-object="text" data-key="1568"><span data-slate-leaf="true" data-offset-key="1568:0" data-first-offset="true"><span data-slate-string="true">    : Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1569"><span data-slate-object="text" data-key="1570"><span data-slate-leaf="true" data-offset-key="1570:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1571"><span data-slate-leaf="true" data-offset-key="1571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="1572"><span data-slate-leaf="true" data-offset-key="1572:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1573"><span data-slate-object="text" data-key="1574"><span data-slate-leaf="true" data-offset-key="1574:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1575"><span data-slate-leaf="true" data-offset-key="1575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1576"><span data-slate-leaf="true" data-offset-key="1576:0" data-first-offset="true"><span data-slate-string="true"> (timerTaskEntry != </span></span></span><span data-slate-object="text" data-key="1577"><span data-slate-leaf="true" data-offset-key="1577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="1578"><span data-slate-leaf="true" data-offset-key="1578:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; timerTaskEntry != entry)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1579"><span data-slate-object="text" data-key="1580"><span data-slate-leaf="true" data-offset-key="1580:0" data-first-offset="true"><span data-slate-string="true">        timerTaskEntry.remove()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1581"><span data-slate-object="text" data-key="1582"><span data-slate-leaf="true" data-offset-key="1582:0" data-first-offset="true"><span data-slate-string="true">      timerTaskEntry = entry</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1583"><span data-slate-object="text" data-key="1584"><span data-slate-leaf="true" data-offset-key="1584:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1585"><span data-slate-object="text" data-key="1586"><span data-slate-leaf="true" data-offset-key="1586:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1587"><span data-slate-object="text" data-key="1588"><span data-slate-leaf="true" data-offset-key="1588:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1589"><span data-slate-leaf="true" data-offset-key="1589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取关联的 timerTaskEntry 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1590"><span data-slate-object="text" data-key="1591"><span data-slate-leaf="true" data-offset-key="1591:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1592"><span data-slate-leaf="true" data-offset-key="1592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="1593"><span data-slate-leaf="true" data-offset-key="1593:0" data-first-offset="true"><span data-slate-string="true">[timer] def </span></span></span><span data-slate-object="text" data-key="1594"><span data-slate-leaf="true" data-offset-key="1594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getTimerTaskEntry</span></span></span></span><span data-slate-object="text" data-key="1595"><span data-slate-leaf="true" data-offset-key="1595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="1596"><span data-slate-leaf="true" data-offset-key="1596:0" data-first-offset="true"><span data-slate-string="true">: TimerTaskEntry = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1597"><span data-slate-object="text" data-key="1598"><span data-slate-leaf="true" data-offset-key="1598:0" data-first-offset="true"><span data-slate-string="true">    timerTaskEntry</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1599"><span data-slate-object="text" data-key="1600"><span data-slate-leaf="true" data-offset-key="1600:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1601"><span data-slate-object="text" data-key="1602"><span data-slate-leaf="true" data-offset-key="1602:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1603"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1604"><span data-slate-object="text" data-key="1605"><span data-slate-leaf="true" data-offset-key="1605:0" data-first-offset="true"><span data-slate-string="true">从代码可知，TimerTask 是一个 Scala 接口（Trait）。每个 TimerTask 都有一个 delayMs 字段，表示这个定时任务的超时时间。通常来说，这就是客户端参数 request.timeout.ms 的值。这个类还绑定了一个 timerTaskEntry 字段，因为，每个定时任务都要知道，它存放在哪个 Bucket 链表下的哪个链表元素上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1606"><span data-slate-object="text" data-key="1607"><span data-slate-leaf="true" data-offset-key="1607:0" data-first-offset="true"><span data-slate-string="true">既然绑定了这个字段，就要提供相应的 Setter 和 Getter 方法。Getter 方法仅仅是返回这个字段而已，Setter 方法要稍微复杂一些。在给 timerTaskEntry 赋值之前，它必须要先考虑这个定时任务是否已经绑定了其他的 timerTaskEntry，如果是的话，就必须先取消绑定。另外，Setter 的整个方法体必须由 monitor 锁保护起来，以保证线程安全性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1608"><span data-slate-object="text" data-key="1609"><span data-slate-leaf="true" data-offset-key="1609:0" data-first-offset="true"><span data-slate-string="true">这个类还有个 cancel 方法，用于取消定时任务。原理也很简单，就是将关联的 timerTaskEntry 置空。也就是说，把定时任务从链表上摘除。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1610"><span data-slate-object="text" data-key="1611"><span data-slate-leaf="true" data-offset-key="1611:0" data-first-offset="true"><span data-slate-string="true">总之，TimerTask 建模的是 Kafka 中的定时任务。接下来，我们来看 TimerTaskEntry 是如何承载这个定时任务的，以及如何在链表中实现双向关联。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1612" id="sr-toc-5"><span data-slate-object="text" data-key="1613"><span data-slate-leaf="true" data-offset-key="1613:0" data-first-offset="true"><span data-slate-string="true">TimerTaskEntry 类</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1614"><span data-slate-object="text" data-key="1615"><span data-slate-leaf="true" data-offset-key="1615:0" data-first-offset="true"><span data-slate-string="true">如前所述，TimerTaskEntry 表征的是 Bucket 链表下的一个元素。它的主要代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="1616"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1617"><span data-slate-object="text" data-key="1618"><span data-slate-leaf="true" data-offset-key="1618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="1619"><span data-slate-leaf="true" data-offset-key="1619:0" data-first-offset="true"><span data-slate-string="true">[timer] </span></span></span><span data-slate-object="text" data-key="1620"><span data-slate-leaf="true" data-offset-key="1620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="1621"><span data-slate-leaf="true" data-offset-key="1621:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1622"><span data-slate-leaf="true" data-offset-key="1622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimerTaskEntry</span></span></span></span><span data-slate-object="text" data-key="1623"><span data-slate-leaf="true" data-offset-key="1623:0" data-first-offset="true"><span data-slate-string="true">(val timerTask: TimerTask, val expirationMs: Long) </span></span></span><span data-slate-object="text" data-key="1624"><span data-slate-leaf="true" data-offset-key="1624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="1625"><span data-slate-leaf="true" data-offset-key="1625:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1626"><span data-slate-leaf="true" data-offset-key="1626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Ordered</span></span></span></span><span data-slate-object="text" data-key="1627"><span data-slate-leaf="true" data-offset-key="1627:0" data-first-offset="true"><span data-slate-string="true">[TimerTaskEntry] {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1628"><span data-slate-object="text" data-key="1629"><span data-slate-leaf="true" data-offset-key="1629:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1630"><span data-slate-leaf="true" data-offset-key="1630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1631"><span data-slate-object="text" data-key="1632"><span data-slate-leaf="true" data-offset-key="1632:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1633"><span data-slate-leaf="true" data-offset-key="1633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1634"><span data-slate-leaf="true" data-offset-key="1634:0" data-first-offset="true"><span data-slate-string="true"> list: TimerTaskList = </span></span></span><span data-slate-object="text" data-key="1635"><span data-slate-leaf="true" data-offset-key="1635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="1636"><span data-slate-leaf="true" data-offset-key="1636:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="1637"><span data-slate-leaf="true" data-offset-key="1637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 绑定的 Bucket 链表实例 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1638"><span data-slate-object="text" data-key="1639"><span data-slate-leaf="true" data-offset-key="1639:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1640"><span data-slate-leaf="true" data-offset-key="1640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1641"><span data-slate-leaf="true" data-offset-key="1641:0" data-first-offset="true"><span data-slate-string="true"> next: TimerTaskEntry = </span></span></span><span data-slate-object="text" data-key="1642"><span data-slate-leaf="true" data-offset-key="1642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="1643"><span data-slate-leaf="true" data-offset-key="1643:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1644"><span data-slate-leaf="true" data-offset-key="1644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//next 指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1645"><span data-slate-object="text" data-key="1646"><span data-slate-leaf="true" data-offset-key="1646:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1647"><span data-slate-leaf="true" data-offset-key="1647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1648"><span data-slate-leaf="true" data-offset-key="1648:0" data-first-offset="true"><span data-slate-string="true"> prev: TimerTaskEntry = </span></span></span><span data-slate-object="text" data-key="1649"><span data-slate-leaf="true" data-offset-key="1649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="1650"><span data-slate-leaf="true" data-offset-key="1650:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1651"><span data-slate-leaf="true" data-offset-key="1651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//prev 指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1652"><span data-slate-object="text" data-key="1653"><span data-slate-leaf="true" data-offset-key="1653:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1654"><span data-slate-leaf="true" data-offset-key="1654:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关联给定的定时任务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1655"><span data-slate-object="text" data-key="1656"><span data-slate-leaf="true" data-offset-key="1656:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1657"><span data-slate-leaf="true" data-offset-key="1657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1658"><span data-slate-leaf="true" data-offset-key="1658:0" data-first-offset="true"><span data-slate-string="true"> (timerTask != </span></span></span><span data-slate-object="text" data-key="1659"><span data-slate-leaf="true" data-offset-key="1659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="1660"><span data-slate-leaf="true" data-offset-key="1660:0" data-first-offset="true"><span data-slate-string="true">) timerTask.setTimerTaskEntry(</span></span></span><span data-slate-object="text" data-key="1661"><span data-slate-leaf="true" data-offset-key="1661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="1662"><span data-slate-leaf="true" data-offset-key="1662:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1663"><span data-slate-object="text" data-key="1664"><span data-slate-leaf="true" data-offset-key="1664:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1665"><span data-slate-leaf="true" data-offset-key="1665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关联定时任务是否已经被取消了</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1666"><span data-slate-object="text" data-key="1667"><span data-slate-leaf="true" data-offset-key="1667:0" data-first-offset="true"><span data-slate-string="true">  def cancelled: Boolean = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1668"><span data-slate-object="text" data-key="1669"><span data-slate-leaf="true" data-offset-key="1669:0" data-first-offset="true"><span data-slate-string="true">    timerTask.getTimerTaskEntry != </span></span></span><span data-slate-object="text" data-key="1670"><span data-slate-leaf="true" data-offset-key="1670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1671"><span data-slate-object="text" data-key="1672"><span data-slate-leaf="true" data-offset-key="1672:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1673"><span data-slate-object="text" data-key="1674"><span data-slate-leaf="true" data-offset-key="1674:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1675"><span data-slate-leaf="true" data-offset-key="1675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从 Bucket 链表中移除自己</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1676"><span data-slate-object="text" data-key="1677"><span data-slate-leaf="true" data-offset-key="1677:0" data-first-offset="true"><span data-slate-string="true">  def </span></span></span><span data-slate-object="text" data-key="1678"><span data-slate-leaf="true" data-offset-key="1678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">remove</span></span></span></span><span data-slate-object="text" data-key="1679"><span data-slate-leaf="true" data-offset-key="1679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="1680"><span data-slate-leaf="true" data-offset-key="1680:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1681"><span data-slate-object="text" data-key="1682"><span data-slate-leaf="true" data-offset-key="1682:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1683"><span data-slate-leaf="true" data-offset-key="1683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1684"><span data-slate-leaf="true" data-offset-key="1684:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1685"><span data-slate-leaf="true" data-offset-key="1685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">currentList</span></span></span></span><span data-slate-object="text" data-key="1686"><span data-slate-leaf="true" data-offset-key="1686:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1687"><span data-slate-leaf="true" data-offset-key="1687:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1688"><span data-slate-leaf="true" data-offset-key="1688:0" data-first-offset="true"><span data-slate-string="true"> list</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1689"><span data-slate-object="text" data-key="1690"><span data-slate-leaf="true" data-offset-key="1690:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1691"><span data-slate-leaf="true" data-offset-key="1691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="1692"><span data-slate-leaf="true" data-offset-key="1692:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1693"><span data-slate-leaf="true" data-offset-key="1693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(currentList != </span></span></span></span><span data-slate-object="text" data-key="1694"><span data-slate-leaf="true" data-offset-key="1694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></span><span data-slate-object="text" data-key="1695"><span data-slate-leaf="true" data-offset-key="1695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span><span data-slate-object="text" data-key="1696"><span data-slate-leaf="true" data-offset-key="1696:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1697"><span data-slate-object="text" data-key="1698"><span data-slate-leaf="true" data-offset-key="1698:0" data-first-offset="true"><span data-slate-string="true">      currentList.remove(</span></span></span><span data-slate-object="text" data-key="1699"><span data-slate-leaf="true" data-offset-key="1699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="1700"><span data-slate-leaf="true" data-offset-key="1700:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1701"><span data-slate-object="text" data-key="1702"><span data-slate-leaf="true" data-offset-key="1702:0" data-first-offset="true"><span data-slate-string="true">      currentList = list</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1703"><span data-slate-object="text" data-key="1704"><span data-slate-leaf="true" data-offset-key="1704:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1705"><span data-slate-object="text" data-key="1706"><span data-slate-leaf="true" data-offset-key="1706:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1707"><span data-slate-object="text" data-key="1708"><span data-slate-leaf="true" data-offset-key="1708:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1709"><span data-slate-object="text" data-key="1710"><span data-slate-leaf="true" data-offset-key="1710:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1711"><span data-slate-object="text" data-key="1712"><span data-slate-leaf="true" data-offset-key="1712:0" data-first-offset="true"><span data-slate-string="true">该类定义了 TimerTask 类字段，用来指定定时任务，同时还封装了一个过期时间戳字段，这个字段值定义了定时任务的过期时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1713"><span data-slate-object="text" data-key="1714"><span data-slate-leaf="true" data-offset-key="1714:0" data-first-offset="true"><span data-slate-string="true">举个例子，假设有个 PRODUCE 请求在当前时间 1 点钟被发送到 Broker，超时时间是 30 秒，那么，该请求必须在 1 点 30 秒之前完成，否则将被视为超时。这里的 1 点 30 秒，就是 expirationMs 值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1715"><span data-slate-object="text" data-key="1716"><span data-slate-leaf="true" data-offset-key="1716:0" data-first-offset="true"><span data-slate-string="true">除了 TimerTask 类字段，该类还定义了 3 个字段：list、next 和 prev。它们分别对应于 Bucket 链表实例以及自身的 next、prev 指针。注意，list 字段是 volatile 型的，这是因为，Kafka 的延时请求可能会被其他线程从一个链表搬移到另一个链表中，因此，</span></span></span><span data-slate-object="text" data-key="1717"><span data-slate-leaf="true" data-offset-key="1717:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">为了保证必要的内存可见性</span></span></span></span><span data-slate-object="text" data-key="1718"><span data-slate-leaf="true" data-offset-key="1718:0" data-first-offset="true"><span data-slate-string="true">，代码声明 list 为 volatile。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1719"><span data-slate-object="text" data-key="1720"><span data-slate-leaf="true" data-offset-key="1720:0" data-first-offset="true"><span data-slate-string="true">该类的方法代码都很直观，你可以看下我写的代码注释。这里我重点解释一下 remove 方法的实现原理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1721"><span data-slate-object="text" data-key="1722"><span data-slate-leaf="true" data-offset-key="1722:0" data-first-offset="true"><span data-slate-string="true">remove 的逻辑是将 TimerTask 自身从双向链表中移除掉，因此，代码调用了 TimerTaskList 的 remove 方法来做这件事。那这里就有一个问题：“怎么算真正移除掉呢？” 其实，这是根据 “TimerTaskEntry 的 list 是否为空” 来判断的。一旦置空了该字段，那么，这个 TimerTaskEntry 实例就变成了 “孤儿”，不再属于任何一个链表了。从这个角度来看，置空就相当于移除的效果。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1723"><span data-slate-object="text" data-key="1724"><span data-slate-leaf="true" data-offset-key="1724:0" data-first-offset="true"><span data-slate-string="true">需要注意的是，置空这个动作是在 TimerTaskList 的 remove 中完成的，而这个方法可能会被其他线程同时调用，因此，上段代码使用了 while 循环的方式来确保 TimerTaskEntry 的 list 字段确实被置空了。这样，Kafka 才能安全地认为此链表元素被成功移除。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1725" id="sr-toc-6"><span data-slate-object="text" data-key="1726"><span data-slate-leaf="true" data-offset-key="1726:0" data-first-offset="true"><span data-slate-string="true">TimerTaskList 类</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1727"><span data-slate-object="text" data-key="1728"><span data-slate-leaf="true" data-offset-key="1728:0" data-first-offset="true"><span data-slate-string="true">说完了 TimerTask 和 TimerTaskEntry，就轮到链表类 TimerTaskList 上场了。我们先看它的定义：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="1729"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1730"><span data-slate-object="text" data-key="1731"><span data-slate-leaf="true" data-offset-key="1731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="1732"><span data-slate-leaf="true" data-offset-key="1732:0" data-first-offset="true"><span data-slate-string="true">[timer] </span></span></span><span data-slate-object="text" data-key="1733"><span data-slate-leaf="true" data-offset-key="1733:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="1734"><span data-slate-leaf="true" data-offset-key="1734:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1735"><span data-slate-leaf="true" data-offset-key="1735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimerTaskList</span></span></span></span><span data-slate-object="text" data-key="1736"><span data-slate-leaf="true" data-offset-key="1736:0" data-first-offset="true"><span data-slate-string="true">(taskCounter: AtomicInteger) </span></span></span><span data-slate-object="text" data-key="1737"><span data-slate-leaf="true" data-offset-key="1737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="1738"><span data-slate-leaf="true" data-offset-key="1738:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1739"><span data-slate-leaf="true" data-offset-key="1739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Delayed</span></span></span></span><span data-slate-object="text" data-key="1740"><span data-slate-leaf="true" data-offset-key="1740:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1741"><span data-slate-object="text" data-key="1742"><span data-slate-leaf="true" data-offset-key="1742:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1743"><span data-slate-leaf="true" data-offset-key="1743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="1744"><span data-slate-leaf="true" data-offset-key="1744:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1745"><span data-slate-leaf="true" data-offset-key="1745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="1746"><span data-slate-leaf="true" data-offset-key="1746:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="1747"><span data-slate-leaf="true" data-offset-key="1747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1748"><span data-slate-leaf="true" data-offset-key="1748:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1749"><span data-slate-leaf="true" data-offset-key="1749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">root</span></span></span></span><span data-slate-object="text" data-key="1750"><span data-slate-leaf="true" data-offset-key="1750:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1751"><span data-slate-leaf="true" data-offset-key="1751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1752"><span data-slate-leaf="true" data-offset-key="1752:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1753"><span data-slate-leaf="true" data-offset-key="1753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="1754"><span data-slate-leaf="true" data-offset-key="1754:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1755"><span data-slate-leaf="true" data-offset-key="1755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimerTaskEntry</span></span></span></span><span data-slate-object="text" data-key="1756"><span data-slate-leaf="true" data-offset-key="1756:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1757"><span data-slate-leaf="true" data-offset-key="1757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="1758"><span data-slate-leaf="true" data-offset-key="1758:0" data-first-offset="true"><span data-slate-string="true">, -</span></span></span><span data-slate-object="text" data-key="1759"><span data-slate-leaf="true" data-offset-key="1759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1760"><span data-slate-leaf="true" data-offset-key="1760:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1761"><span data-slate-object="text" data-key="1762"><span data-slate-leaf="true" data-offset-key="1762:0" data-first-offset="true"><span data-slate-string="true">  root.next = root</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1763"><span data-slate-object="text" data-key="1764"><span data-slate-leaf="true" data-offset-key="1764:0" data-first-offset="true"><span data-slate-string="true">  root.prev = root</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1765"><span data-slate-object="text" data-key="1766"><span data-slate-leaf="true" data-offset-key="1766:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1767"><span data-slate-leaf="true" data-offset-key="1767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="1768"><span data-slate-leaf="true" data-offset-key="1768:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1769"><span data-slate-leaf="true" data-offset-key="1769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="1770"><span data-slate-leaf="true" data-offset-key="1770:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="1771"><span data-slate-leaf="true" data-offset-key="1771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1772"><span data-slate-leaf="true" data-offset-key="1772:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1773"><span data-slate-leaf="true" data-offset-key="1773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">expiration</span></span></span></span><span data-slate-object="text" data-key="1774"><span data-slate-leaf="true" data-offset-key="1774:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1775"><span data-slate-leaf="true" data-offset-key="1775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1776"><span data-slate-leaf="true" data-offset-key="1776:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1777"><span data-slate-leaf="true" data-offset-key="1777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="1778"><span data-slate-leaf="true" data-offset-key="1778:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1779"><span data-slate-leaf="true" data-offset-key="1779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AtomicLong</span></span></span></span><span data-slate-object="text" data-key="1780"><span data-slate-leaf="true" data-offset-key="1780:0" data-first-offset="true"><span data-slate-string="true">(-</span></span></span><span data-slate-object="text" data-key="1781"><span data-slate-leaf="true" data-offset-key="1781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1L</span></span></span></span><span data-slate-object="text" data-key="1782"><span data-slate-leaf="true" data-offset-key="1782:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1783"><span data-slate-object="text" data-key="1784"><span data-slate-leaf="true" data-offset-key="1784:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1785"><span data-slate-object="text" data-key="1786"><span data-slate-leaf="true" data-offset-key="1786:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1787"><span data-slate-object="text" data-key="1788"><span data-slate-leaf="true" data-offset-key="1788:0" data-first-offset="true"><span data-slate-string="true">TimerTaskList 实现了刚刚那张图所展示的双向循环链表。它定义了一个 Root 节点，同时还定义了两个字段：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1789"><div data-slate-type="list-line" data-slate-object="block" data-key="1790"><span data-slate-object="text" data-key="1791"><span data-slate-leaf="true" data-offset-key="1791:0" data-first-offset="true"><span data-slate-string="true">taskCounter，用于标识当前这个链表中的总定时任务数；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1792"><span data-slate-object="text" data-key="1793"><span data-slate-leaf="true" data-offset-key="1793:0" data-first-offset="true"><span data-slate-string="true">expiration，表示这个链表所在 Bucket 的过期时间戳。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1794"><span data-slate-object="text" data-key="1795"><span data-slate-leaf="true" data-offset-key="1795:0" data-first-offset="true"><span data-slate-string="true">就像我前面说的，每个 Bucket 对应于手表表盘上的一格。它有起始时间和结束时间，因而也就有时间间隔的概念，即 “结束时间 - 起始时间 = 时间间隔”。同一层的 Bucket 的时间间隔都是一样的。只有当前时间越过了 Bucket 的起始时间，这个 Bucket 才算是过期。而这里的起始时间，就是代码中 expiration 字段的值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1796"><span data-slate-object="text" data-key="1797"><span data-slate-leaf="true" data-offset-key="1797:0" data-first-offset="true"><span data-slate-string="true">除了定义的字段之外，TimerTaskList 类还定义一些重要的方法，比如 expiration 的 Getter 和 Setter 方法、add、remove 和 flush 方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1798"><span data-slate-object="text" data-key="1799"><span data-slate-leaf="true" data-offset-key="1799:0" data-first-offset="true"><span data-slate-string="true">我们先看 expiration 的 Getter 和 Setter 方法。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="1800"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1801"><span data-slate-object="text" data-key="1802"><span data-slate-leaf="true" data-offset-key="1802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Setter 方法</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1803"><span data-slate-object="text" data-key="1804"><span data-slate-leaf="true" data-offset-key="1804:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="1805"><span data-slate-leaf="true" data-offset-key="1805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">setExpiration</span></span></span></span><span data-slate-object="text" data-key="1806"><span data-slate-leaf="true" data-offset-key="1806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(expirationMs: Long)</span></span></span></span><span data-slate-object="text" data-key="1807"><span data-slate-leaf="true" data-offset-key="1807:0" data-first-offset="true"><span data-slate-string="true">: Boolean = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1808"><span data-slate-object="text" data-key="1809"><span data-slate-leaf="true" data-offset-key="1809:0" data-first-offset="true"><span data-slate-string="true">  expiration.getAndSet(expirationMs) != expirationMs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1810"><span data-slate-object="text" data-key="1811"><span data-slate-leaf="true" data-offset-key="1811:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1812"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1813"><span data-slate-object="text" data-key="1814"><span data-slate-leaf="true" data-offset-key="1814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Getter 方法</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1815"><span data-slate-object="text" data-key="1816"><span data-slate-leaf="true" data-offset-key="1816:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="1817"><span data-slate-leaf="true" data-offset-key="1817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getExpiration</span></span></span></span><span data-slate-object="text" data-key="1818"><span data-slate-leaf="true" data-offset-key="1818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="1819"><span data-slate-leaf="true" data-offset-key="1819:0" data-first-offset="true"><span data-slate-string="true">: Long = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1820"><span data-slate-object="text" data-key="1821"><span data-slate-leaf="true" data-offset-key="1821:0" data-first-offset="true"><span data-slate-string="true">  expiration.get()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1822"><span data-slate-object="text" data-key="1823"><span data-slate-leaf="true" data-offset-key="1823:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1824"><span data-slate-object="text" data-key="1825"><span data-slate-leaf="true" data-offset-key="1825:0" data-first-offset="true"><span data-slate-string="true">我重点解释下 Setter 方法。代码使用了 AtomicLong 的 CAS 方法 getAndSet 原子性地设置了过期时间戳，之后将新过期时间戳和旧值进行比较，看看是否不同，然后返回结果。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1826"><span data-slate-object="text" data-key="1827"><span data-slate-leaf="true" data-offset-key="1827:0" data-first-offset="true"><span data-slate-string="true">这里为什么要比较新旧值是否不同呢？这是因为，目前 Kafka 使用一个 DelayQueue 统一管理所有的 Bucket，也就是 TimerTaskList 对象。随着时钟不断向前推进，原有 Bucket 会不断地过期，然后失效。当这些 Bucket 失效后，源码会重用这些 Bucket。重用的方式就是重新设置 Bucket 的过期时间，并把它们加回到 DelayQueue 中。这里进行比较的目的，就是用来判断这个 Bucket 是否要被插入到 DelayQueue。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1828"><span data-slate-object="text" data-key="1829"><span data-slate-leaf="true" data-offset-key="1829:0" data-first-offset="true"><span data-slate-string="true">此外，TimerTaskList 类还提供了 add 和 remove 方法，分别实现将给定定时任务插入到链表、从链表中移除定时任务的逻辑。这两个方法的主体代码基本上就是我们在数据结构课上学过的链表元素插入和删除操作，所以这里我就不具体展开讲了。你可以将这些代码和数据结构书中的代码比对下，看看它们是不是长得很像。</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="1830"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1831"><span data-slate-object="text" data-key="1832"><span data-slate-leaf="true" data-offset-key="1832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//add 方法</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1833"><span data-slate-object="text" data-key="1834"><span data-slate-leaf="true" data-offset-key="1834:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="1835"><span data-slate-leaf="true" data-offset-key="1835:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">add</span></span></span></span><span data-slate-object="text" data-key="1836"><span data-slate-leaf="true" data-offset-key="1836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(timerTaskEntry: TimerTaskEntry)</span></span></span></span><span data-slate-object="text" data-key="1837"><span data-slate-leaf="true" data-offset-key="1837:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1838"><span data-slate-object="text" data-key="1839"><span data-slate-leaf="true" data-offset-key="1839:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1840"><span data-slate-leaf="true" data-offset-key="1840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1841"><span data-slate-leaf="true" data-offset-key="1841:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1842"><span data-slate-leaf="true" data-offset-key="1842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">done</span></span></span></span><span data-slate-object="text" data-key="1843"><span data-slate-leaf="true" data-offset-key="1843:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1844"><span data-slate-leaf="true" data-offset-key="1844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1845"><span data-slate-leaf="true" data-offset-key="1845:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1846"><span data-slate-leaf="true" data-offset-key="1846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1847"><span data-slate-object="text" data-key="1848"><span data-slate-leaf="true" data-offset-key="1848:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1849"><span data-slate-leaf="true" data-offset-key="1849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="1850"><span data-slate-leaf="true" data-offset-key="1850:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1851"><span data-slate-leaf="true" data-offset-key="1851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(!done)</span></span></span></span><span data-slate-object="text" data-key="1852"><span data-slate-leaf="true" data-offset-key="1852:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1853"><span data-slate-object="text" data-key="1854"><span data-slate-leaf="true" data-offset-key="1854:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1855"><span data-slate-leaf="true" data-offset-key="1855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 在添加之前尝试移除该定时任务，保证该任务没有在其他链表中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1856"><span data-slate-object="text" data-key="1857"><span data-slate-leaf="true" data-offset-key="1857:0" data-first-offset="true"><span data-slate-string="true">    timerTaskEntry.remove()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1858"><span data-slate-object="text" data-key="1859"><span data-slate-leaf="true" data-offset-key="1859:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1860"><span data-slate-leaf="true" data-offset-key="1860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="1861"><span data-slate-leaf="true" data-offset-key="1861:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1862"><span data-slate-object="text" data-key="1863"><span data-slate-leaf="true" data-offset-key="1863:0" data-first-offset="true"><span data-slate-string="true">      timerTaskEntry.</span></span></span><span data-slate-object="text" data-key="1864"><span data-slate-leaf="true" data-offset-key="1864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="1865"><span data-slate-leaf="true" data-offset-key="1865:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1866"><span data-slate-object="text" data-key="1867"><span data-slate-leaf="true" data-offset-key="1867:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1868"><span data-slate-leaf="true" data-offset-key="1868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1869"><span data-slate-leaf="true" data-offset-key="1869:0" data-first-offset="true"><span data-slate-string="true"> (timerTaskEntry.list == </span></span></span><span data-slate-object="text" data-key="1870"><span data-slate-leaf="true" data-offset-key="1870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="1871"><span data-slate-leaf="true" data-offset-key="1871:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1872"><span data-slate-object="text" data-key="1873"><span data-slate-leaf="true" data-offset-key="1873:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="1874"><span data-slate-leaf="true" data-offset-key="1874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="1875"><span data-slate-leaf="true" data-offset-key="1875:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1876"><span data-slate-leaf="true" data-offset-key="1876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">tail</span></span></span></span><span data-slate-object="text" data-key="1877"><span data-slate-leaf="true" data-offset-key="1877:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1878"><span data-slate-leaf="true" data-offset-key="1878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="1879"><span data-slate-leaf="true" data-offset-key="1879:0" data-first-offset="true"><span data-slate-string="true"> root.prev</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1880"><span data-slate-object="text" data-key="1881"><span data-slate-leaf="true" data-offset-key="1881:0" data-first-offset="true"><span data-slate-string="true">          timerTaskEntry.next = root</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1882"><span data-slate-object="text" data-key="1883"><span data-slate-leaf="true" data-offset-key="1883:0" data-first-offset="true"><span data-slate-string="true">          timerTaskEntry.prev = tail</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1884"><span data-slate-object="text" data-key="1885"><span data-slate-leaf="true" data-offset-key="1885:0" data-first-offset="true"><span data-slate-string="true">          timerTaskEntry.list = </span></span></span><span data-slate-object="text" data-key="1886"><span data-slate-leaf="true" data-offset-key="1886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1887"><span data-slate-object="text" data-key="1888"><span data-slate-leaf="true" data-offset-key="1888:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="1889"><span data-slate-leaf="true" data-offset-key="1889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 timerTaskEntry 添加到链表末尾</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1890"><span data-slate-object="text" data-key="1891"><span data-slate-leaf="true" data-offset-key="1891:0" data-first-offset="true"><span data-slate-string="true">          tail.next = timerTaskEntry</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1892"><span data-slate-object="text" data-key="1893"><span data-slate-leaf="true" data-offset-key="1893:0" data-first-offset="true"><span data-slate-string="true">          root.prev = timerTaskEntry</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1894"><span data-slate-object="text" data-key="1895"><span data-slate-leaf="true" data-offset-key="1895:0" data-first-offset="true"><span data-slate-string="true">          taskCounter.incrementAndGet()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1896"><span data-slate-object="text" data-key="1897"><span data-slate-leaf="true" data-offset-key="1897:0" data-first-offset="true"><span data-slate-string="true">          done = </span></span></span><span data-slate-object="text" data-key="1898"><span data-slate-leaf="true" data-offset-key="1898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1899"><span data-slate-object="text" data-key="1900"><span data-slate-leaf="true" data-offset-key="1900:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1901"><span data-slate-object="text" data-key="1902"><span data-slate-leaf="true" data-offset-key="1902:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1903"><span data-slate-object="text" data-key="1904"><span data-slate-leaf="true" data-offset-key="1904:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1905"><span data-slate-object="text" data-key="1906"><span data-slate-leaf="true" data-offset-key="1906:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1907"><span data-slate-object="text" data-key="1908"><span data-slate-leaf="true" data-offset-key="1908:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1909"><span data-slate-object="text" data-key="1910"><span data-slate-leaf="true" data-offset-key="1910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//remove 方法</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1911"><span data-slate-object="text" data-key="1912"><span data-slate-leaf="true" data-offset-key="1912:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="1913"><span data-slate-leaf="true" data-offset-key="1913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">remove</span></span></span></span><span data-slate-object="text" data-key="1914"><span data-slate-leaf="true" data-offset-key="1914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(timerTaskEntry: TimerTaskEntry)</span></span></span></span><span data-slate-object="text" data-key="1915"><span data-slate-leaf="true" data-offset-key="1915:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1916"><span data-slate-object="text" data-key="1917"><span data-slate-leaf="true" data-offset-key="1917:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1918"><span data-slate-leaf="true" data-offset-key="1918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="1919"><span data-slate-leaf="true" data-offset-key="1919:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1920"><span data-slate-object="text" data-key="1921"><span data-slate-leaf="true" data-offset-key="1921:0" data-first-offset="true"><span data-slate-string="true">    timerTaskEntry.</span></span></span><span data-slate-object="text" data-key="1922"><span data-slate-leaf="true" data-offset-key="1922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="1923"><span data-slate-leaf="true" data-offset-key="1923:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1924"><span data-slate-object="text" data-key="1925"><span data-slate-leaf="true" data-offset-key="1925:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1926"><span data-slate-leaf="true" data-offset-key="1926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1927"><span data-slate-leaf="true" data-offset-key="1927:0" data-first-offset="true"><span data-slate-string="true"> (timerTaskEntry.list eq </span></span></span><span data-slate-object="text" data-key="1928"><span data-slate-leaf="true" data-offset-key="1928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="1929"><span data-slate-leaf="true" data-offset-key="1929:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1930"><span data-slate-object="text" data-key="1931"><span data-slate-leaf="true" data-offset-key="1931:0" data-first-offset="true"><span data-slate-string="true">        timerTaskEntry.next.prev = timerTaskEntry.prev</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1932"><span data-slate-object="text" data-key="1933"><span data-slate-leaf="true" data-offset-key="1933:0" data-first-offset="true"><span data-slate-string="true">        timerTaskEntry.prev.next = timerTaskEntry.next</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1934"><span data-slate-object="text" data-key="1935"><span data-slate-leaf="true" data-offset-key="1935:0" data-first-offset="true"><span data-slate-string="true">        timerTaskEntry.next = </span></span></span><span data-slate-object="text" data-key="1936"><span data-slate-leaf="true" data-offset-key="1936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1937"><span data-slate-object="text" data-key="1938"><span data-slate-leaf="true" data-offset-key="1938:0" data-first-offset="true"><span data-slate-string="true">        timerTaskEntry.prev = </span></span></span><span data-slate-object="text" data-key="1939"><span data-slate-leaf="true" data-offset-key="1939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1940"><span data-slate-object="text" data-key="1941"><span data-slate-leaf="true" data-offset-key="1941:0" data-first-offset="true"><span data-slate-string="true">        timerTaskEntry.list = </span></span></span><span data-slate-object="text" data-key="1942"><span data-slate-leaf="true" data-offset-key="1942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1943"><span data-slate-object="text" data-key="1944"><span data-slate-leaf="true" data-offset-key="1944:0" data-first-offset="true"><span data-slate-string="true">        taskCounter.decrementAndGet()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1945"><span data-slate-object="text" data-key="1946"><span data-slate-leaf="true" data-offset-key="1946:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1947"><span data-slate-object="text" data-key="1948"><span data-slate-leaf="true" data-offset-key="1948:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1949"><span data-slate-object="text" data-key="1950"><span data-slate-leaf="true" data-offset-key="1950:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1951"><span data-slate-object="text" data-key="1952"><span data-slate-leaf="true" data-offset-key="1952:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1953"><span data-slate-object="text" data-key="1954"><span data-slate-leaf="true" data-offset-key="1954:0" data-first-offset="true"><span data-slate-string="true">最后，我们看看 flush 方法。它的代码如下：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="1955"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1956"><span data-slate-object="text" data-key="1957"><span data-slate-leaf="true" data-offset-key="1957:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="1958"><span data-slate-leaf="true" data-offset-key="1958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">flush</span></span></span></span><span data-slate-object="text" data-key="1959"><span data-slate-leaf="true" data-offset-key="1959:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1960"><span data-slate-leaf="true" data-offset-key="1960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">f</span></span></span></span><span data-slate-object="text" data-key="1961"><span data-slate-leaf="true" data-offset-key="1961:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="1962"><span data-slate-leaf="true" data-offset-key="1962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="1963"><span data-slate-leaf="true" data-offset-key="1963:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimerTaskEntry</span></span></span></span></span><span data-slate-object="text" data-key="1964"><span data-slate-leaf="true" data-offset-key="1964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)=&gt;</span></span></span></span><span data-slate-object="text" data-key="1965"><span data-slate-leaf="true" data-offset-key="1965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Unit</span></span></span></span><span data-slate-object="text" data-key="1966"><span data-slate-leaf="true" data-offset-key="1966:0" data-first-offset="true"><span data-slate-string="true">): </span></span></span><span data-slate-object="text" data-key="1967"><span data-slate-leaf="true" data-offset-key="1967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Unit</span></span></span></span><span data-slate-object="text" data-key="1968"><span data-slate-leaf="true" data-offset-key="1968:0" data-first-offset="true"><span data-slate-string="true"> = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1969"><span data-slate-object="text" data-key="1970"><span data-slate-leaf="true" data-offset-key="1970:0" data-first-offset="true"><span data-slate-string="true">  synchronized {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1971"><span data-slate-object="text" data-key="1972"><span data-slate-leaf="true" data-offset-key="1972:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1973"><span data-slate-leaf="true" data-offset-key="1973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 找到链表第一个元素</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1974"><span data-slate-object="text" data-key="1975"><span data-slate-leaf="true" data-offset-key="1975:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1976"><span data-slate-leaf="true" data-offset-key="1976:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1977"><span data-slate-leaf="true" data-offset-key="1977:0" data-first-offset="true"><span data-slate-string="true"> head = root.</span></span></span><span data-slate-object="text" data-key="1978"><span data-slate-leaf="true" data-offset-key="1978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">next</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1979"><span data-slate-object="text" data-key="1980"><span data-slate-leaf="true" data-offset-key="1980:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1981"><span data-slate-leaf="true" data-offset-key="1981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开始遍历链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1982"><span data-slate-object="text" data-key="1983"><span data-slate-leaf="true" data-offset-key="1983:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1984"><span data-slate-leaf="true" data-offset-key="1984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="1985"><span data-slate-leaf="true" data-offset-key="1985:0" data-first-offset="true"><span data-slate-string="true"> (head ne root) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1986"><span data-slate-object="text" data-key="1987"><span data-slate-leaf="true" data-offset-key="1987:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1988"><span data-slate-leaf="true" data-offset-key="1988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 移除遍历到的链表元素</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1989"><span data-slate-object="text" data-key="1990"><span data-slate-leaf="true" data-offset-key="1990:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1991"><span data-slate-leaf="true" data-offset-key="1991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">remove</span></span></span></span><span data-slate-object="text" data-key="1992"><span data-slate-leaf="true" data-offset-key="1992:0" data-first-offset="true"><span data-slate-string="true">(head)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1993"><span data-slate-object="text" data-key="1994"><span data-slate-leaf="true" data-offset-key="1994:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1995"><span data-slate-leaf="true" data-offset-key="1995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行传入参数 f 的逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1996"><span data-slate-object="text" data-key="1997"><span data-slate-leaf="true" data-offset-key="1997:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1998"><span data-slate-leaf="true" data-offset-key="1998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">f</span></span></span></span><span data-slate-object="text" data-key="1999"><span data-slate-leaf="true" data-offset-key="1999:0" data-first-offset="true"><span data-slate-string="true">(head)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2000"><span data-slate-object="text" data-key="2001"><span data-slate-leaf="true" data-offset-key="2001:0" data-first-offset="true"><span data-slate-string="true">      head = root.</span></span></span><span data-slate-object="text" data-key="2002"><span data-slate-leaf="true" data-offset-key="2002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">next</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2003"><span data-slate-object="text" data-key="2004"><span data-slate-leaf="true" data-offset-key="2004:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2005"><span data-slate-object="text" data-key="2006"><span data-slate-leaf="true" data-offset-key="2006:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2007"><span data-slate-leaf="true" data-offset-key="2007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 清空过期时间设置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2008"><span data-slate-object="text" data-key="2009"><span data-slate-leaf="true" data-offset-key="2009:0" data-first-offset="true"><span data-slate-string="true">    expiration.</span></span></span><span data-slate-object="text" data-key="2010"><span data-slate-leaf="true" data-offset-key="2010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">set</span></span></span></span><span data-slate-object="text" data-key="2011"><span data-slate-leaf="true" data-offset-key="2011:0" data-first-offset="true"><span data-slate-string="true">(-1L)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2012"><span data-slate-object="text" data-key="2013"><span data-slate-leaf="true" data-offset-key="2013:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2014"><span data-slate-object="text" data-key="2015"><span data-slate-leaf="true" data-offset-key="2015:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2016"><span data-slate-object="text" data-key="2017"><span data-slate-leaf="true" data-offset-key="2017:0" data-first-offset="true"><span data-slate-string="true">基本上，flush 方法是清空链表中的所有元素，并对每个元素执行指定的逻辑。该方法用于将高层次时间轮 Bucket 上的定时任务重新插入回低层次的 Bucket 中。具体为什么要这么做，下节课我会给出答案，现在你只需要知道它的大致作用就可以了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="2018" id="sr-toc-7"><span data-slate-object="text" data-key="2019"><span data-slate-leaf="true" data-offset-key="2019:0" data-first-offset="true"><span data-slate-string="true">TimingWheel 类</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="2020"><span data-slate-object="text" data-key="2021"><span data-slate-leaf="true" data-offset-key="2021:0" data-first-offset="true"><span data-slate-string="true">最后，我们再来看下 TimingWheel 类的代码。先看定义：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="2022"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2023"><span data-slate-object="text" data-key="2024"><span data-slate-leaf="true" data-offset-key="2024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="2025"><span data-slate-leaf="true" data-offset-key="2025:0" data-first-offset="true"><span data-slate-string="true">[timer] </span></span></span><span data-slate-object="text" data-key="2026"><span data-slate-leaf="true" data-offset-key="2026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="2027"><span data-slate-leaf="true" data-offset-key="2027:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2028"><span data-slate-leaf="true" data-offset-key="2028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimingWheel</span></span></span></span><span data-slate-object="text" data-key="2029"><span data-slate-leaf="true" data-offset-key="2029:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2030"><span data-slate-object="text" data-key="2031"><span data-slate-leaf="true" data-offset-key="2031:0" data-first-offset="true"><span data-slate-string="true">  tickMs: Long, wheelSize: Int, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2032"><span data-slate-object="text" data-key="2033"><span data-slate-leaf="true" data-offset-key="2033:0" data-first-offset="true"><span data-slate-string="true">  startMs: Long, taskCounter: AtomicInteger, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2034"><span data-slate-object="text" data-key="2035"><span data-slate-leaf="true" data-offset-key="2035:0" data-first-offset="true"><span data-slate-string="true">  queue: DelayQueue[TimerTaskList]) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2036"><span data-slate-object="text" data-key="2037"><span data-slate-leaf="true" data-offset-key="2037:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2038"><span data-slate-leaf="true" data-offset-key="2038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="2039"><span data-slate-leaf="true" data-offset-key="2039:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="2040"><span data-slate-leaf="true" data-offset-key="2040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="2041"><span data-slate-leaf="true" data-offset-key="2041:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="2042"><span data-slate-leaf="true" data-offset-key="2042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="2043"><span data-slate-leaf="true" data-offset-key="2043:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2044"><span data-slate-leaf="true" data-offset-key="2044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interval</span></span></span></span><span data-slate-object="text" data-key="2045"><span data-slate-leaf="true" data-offset-key="2045:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2046"><span data-slate-leaf="true" data-offset-key="2046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2047"><span data-slate-leaf="true" data-offset-key="2047:0" data-first-offset="true"><span data-slate-string="true"> tickMs * wheelSize</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2048"><span data-slate-object="text" data-key="2049"><span data-slate-leaf="true" data-offset-key="2049:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2050"><span data-slate-leaf="true" data-offset-key="2050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="2051"><span data-slate-leaf="true" data-offset-key="2051:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="2052"><span data-slate-leaf="true" data-offset-key="2052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="2053"><span data-slate-leaf="true" data-offset-key="2053:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="2054"><span data-slate-leaf="true" data-offset-key="2054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="2055"><span data-slate-leaf="true" data-offset-key="2055:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2056"><span data-slate-leaf="true" data-offset-key="2056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">buckets</span></span></span></span><span data-slate-object="text" data-key="2057"><span data-slate-leaf="true" data-offset-key="2057:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2058"><span data-slate-leaf="true" data-offset-key="2058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2059"><span data-slate-leaf="true" data-offset-key="2059:0" data-first-offset="true"><span data-slate-string="true"> Array.tabulate[TimerTaskList](wheelSize) { _ =&gt; </span></span></span><span data-slate-object="text" data-key="2060"><span data-slate-leaf="true" data-offset-key="2060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="2061"><span data-slate-leaf="true" data-offset-key="2061:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2062"><span data-slate-leaf="true" data-offset-key="2062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimerTaskList</span></span></span></span><span data-slate-object="text" data-key="2063"><span data-slate-leaf="true" data-offset-key="2063:0" data-first-offset="true"><span data-slate-string="true">(taskCounter) }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2064"><span data-slate-object="text" data-key="2065"><span data-slate-leaf="true" data-offset-key="2065:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2066"><span data-slate-leaf="true" data-offset-key="2066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="2067"><span data-slate-leaf="true" data-offset-key="2067:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="2068"><span data-slate-leaf="true" data-offset-key="2068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="2069"><span data-slate-leaf="true" data-offset-key="2069:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="2070"><span data-slate-leaf="true" data-offset-key="2070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="2071"><span data-slate-leaf="true" data-offset-key="2071:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2072"><span data-slate-leaf="true" data-offset-key="2072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">currentTime</span></span></span></span><span data-slate-object="text" data-key="2073"><span data-slate-leaf="true" data-offset-key="2073:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2074"><span data-slate-leaf="true" data-offset-key="2074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2075"><span data-slate-leaf="true" data-offset-key="2075:0" data-first-offset="true"><span data-slate-string="true"> startMs - (startMs % tickMs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2076"><span data-slate-object="text" data-key="2077"><span data-slate-leaf="true" data-offset-key="2077:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2078"><span data-slate-leaf="true" data-offset-key="2078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@volatile</span></span></span></span><span data-slate-object="text" data-key="2079"><span data-slate-leaf="true" data-offset-key="2079:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2080"><span data-slate-leaf="true" data-offset-key="2080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="2081"><span data-slate-leaf="true" data-offset-key="2081:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="2082"><span data-slate-leaf="true" data-offset-key="2082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="2083"><span data-slate-leaf="true" data-offset-key="2083:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="2084"><span data-slate-leaf="true" data-offset-key="2084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="2085"><span data-slate-leaf="true" data-offset-key="2085:0" data-first-offset="true"><span data-slate-string="true"> overflowWheel: TimingWheel = </span></span></span><span data-slate-object="text" data-key="2086"><span data-slate-leaf="true" data-offset-key="2086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2087"><span data-slate-object="text" data-key="2088"><span data-slate-leaf="true" data-offset-key="2088:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2089"><span data-slate-object="text" data-key="2090"><span data-slate-leaf="true" data-offset-key="2090:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2091"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2092"><span data-slate-object="text" data-key="2093"><span data-slate-leaf="true" data-offset-key="2093:0" data-first-offset="true"><span data-slate-string="true">每个 TimingWheel 对象都定义了 9 个字段。这 9 个字段都非常重要，每个字段都是分层时间轮的重要属性。因此，我来逐一介绍下。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2094"><div data-slate-type="list-line" data-slate-object="block" data-key="2095"><span data-slate-object="text" data-key="2096"><span data-slate-leaf="true" data-offset-key="2096:0" data-first-offset="true"><span data-slate-string="true">tickMs：滴答一次的时长，类似于手表的例子中向前推进一格的时间。对于秒针而言，tickMs 就是 1 秒。同理，分针是 1 分，时针是 1 小时。在 Kafka 中，第 1 层时间轮的 tickMs 被固定为 1 毫秒，也就是说，向前推进一格 Bucket 的时长是 1 毫秒。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2097"><span data-slate-object="text" data-key="2098"><span data-slate-leaf="true" data-offset-key="2098:0" data-first-offset="true"><span data-slate-string="true">wheelSize：每一层时间轮上的 Bucket 数量。第 1 层的 Bucket 数量是 20。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2099"><span data-slate-object="text" data-key="2100"><span data-slate-leaf="true" data-offset-key="2100:0" data-first-offset="true"><span data-slate-string="true">startMs：时间轮对象被创建时的起始时间戳。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2101"><span data-slate-object="text" data-key="2102"><span data-slate-leaf="true" data-offset-key="2102:0" data-first-offset="true"><span data-slate-string="true">taskCounter：这一层时间轮上的总定时任务数。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2103"><span data-slate-object="text" data-key="2104"><span data-slate-leaf="true" data-offset-key="2104:0" data-first-offset="true"><span data-slate-string="true">queue：将所有 Bucket 按照过期时间排序的延迟队列。随着时间不断向前推进，Kafka 需要依靠这个队列获取那些已过期的 Bucket，并清除它们。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2105"><span data-slate-object="text" data-key="2106"><span data-slate-leaf="true" data-offset-key="2106:0" data-first-offset="true"><span data-slate-string="true">interval：这层时间轮总时长，等于滴答时长乘以 wheelSize。以第 1 层为例，interval 就是 20 毫秒。由于下一层时间轮的滴答时长就是上一层的总时长，因此，第 2 层的滴答时长就是 20 毫秒，总时长是 400 毫秒，以此类推。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2107"><span data-slate-object="text" data-key="2108"><span data-slate-leaf="true" data-offset-key="2108:0" data-first-offset="true"><span data-slate-string="true">buckets：时间轮下的所有 Bucket 对象，也就是所有 TimerTaskList 对象。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2109"><span data-slate-object="text" data-key="2110"><span data-slate-leaf="true" data-offset-key="2110:0" data-first-offset="true"><span data-slate-string="true">currentTime：当前时间戳，只是源码对它进行了一些微调整，将它设置成小于当前时间的最大滴答时长的整数倍。举个例子，假设滴答时长是 20 毫秒，当前时间戳是 123 毫秒，那么，currentTime 会被调整为 120 毫秒。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2111"><span data-slate-object="text" data-key="2112"><span data-slate-leaf="true" data-offset-key="2112:0" data-first-offset="true"><span data-slate-string="true">overflowWheel：Kafka 是按需创建上层时间轮的。这也就是说，当有新的定时任务到达时，会尝试将其放入第 1 层时间轮。如果第 1 层的 interval 无法容纳定时任务的超时时间，就现场创建并配置好第 2 层时间轮，并再次尝试放入，如果依然无法容纳，那么，就再创建和配置第 3 层时间轮，以此类推，直到找到适合容纳该定时任务的第 N 层时间轮。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2113"><span data-slate-object="text" data-key="2114"><span data-slate-leaf="true" data-offset-key="2114:0" data-first-offset="true"><span data-slate-string="true">由于每层时间轮的长度都是倍增的，因此，代码并不需要创建太多层的时间轮，就足以容纳绝大部分的延时请求了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2115"><span data-slate-object="text" data-key="2116"><span data-slate-leaf="true" data-offset-key="2116:0" data-first-offset="true"><span data-slate-string="true">举个例子，目前 Clients 端默认的请求超时时间是 30 秒，按照现在代码中的 wheelSize=20 进行倍增，只需要 4 层时间轮，就能容纳 160 秒以内的所有延时请求了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2117"><span data-slate-object="text" data-key="2118"><span data-slate-leaf="true" data-offset-key="2118:0" data-first-offset="true"><span data-slate-string="true">说完了类声明，我们再来学习下 TimingWheel 中定义的 3 个方法：addOverflowWheel、add 和 advanceClock。就像我前面说的，TimingWheel 类字段 overflowWheel 的创建是按需的。每当需要一个新的上层时间轮时，代码就会调用 addOverflowWheel 方法。我们看下它的代码：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="2119"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2120"><span data-slate-object="text" data-key="2121"><span data-slate-leaf="true" data-offset-key="2121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="2122"><span data-slate-leaf="true" data-offset-key="2122:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="2123"><span data-slate-leaf="true" data-offset-key="2123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="2124"><span data-slate-leaf="true" data-offset-key="2124:0" data-first-offset="true"><span data-slate-string="true">] </span></span></span><span data-slate-object="text" data-key="2125"><span data-slate-leaf="true" data-offset-key="2125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def </span></span></span></span><span data-slate-object="text" data-key="2126"><span data-slate-leaf="true" data-offset-key="2126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">addOverflowWheel</span></span></span></span></span><span data-slate-object="text" data-key="2127"><span data-slate-leaf="true" data-offset-key="2127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="2128"><span data-slate-leaf="true" data-offset-key="2128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="2129"><span data-slate-leaf="true" data-offset-key="2129:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2130"><span data-slate-object="text" data-key="2131"><span data-slate-leaf="true" data-offset-key="2131:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2132"><span data-slate-leaf="true" data-offset-key="2132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="2133"><span data-slate-leaf="true" data-offset-key="2133:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2134"><span data-slate-object="text" data-key="2135"><span data-slate-leaf="true" data-offset-key="2135:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2136"><span data-slate-leaf="true" data-offset-key="2136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 只有之前没有创建上层时间轮方法才会继续</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2137"><span data-slate-object="text" data-key="2138"><span data-slate-leaf="true" data-offset-key="2138:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2139"><span data-slate-leaf="true" data-offset-key="2139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2140"><span data-slate-leaf="true" data-offset-key="2140:0" data-first-offset="true"><span data-slate-string="true"> (overflowWheel == null) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2141"><span data-slate-object="text" data-key="2142"><span data-slate-leaf="true" data-offset-key="2142:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="2143"><span data-slate-leaf="true" data-offset-key="2143:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建新的 TimingWheel 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2144"><span data-slate-object="text" data-key="2145"><span data-slate-leaf="true" data-offset-key="2145:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="2146"><span data-slate-leaf="true" data-offset-key="2146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 滴答时长 tickMs 等于下层时间轮总时长</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2147"><span data-slate-object="text" data-key="2148"><span data-slate-leaf="true" data-offset-key="2148:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="2149"><span data-slate-leaf="true" data-offset-key="2149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 每层的轮子数都是相同的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2150"><span data-slate-object="text" data-key="2151"><span data-slate-leaf="true" data-offset-key="2151:0" data-first-offset="true"><span data-slate-string="true">      overflowWheel = </span></span></span><span data-slate-object="text" data-key="2152"><span data-slate-leaf="true" data-offset-key="2152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="2153"><span data-slate-leaf="true" data-offset-key="2153:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2154"><span data-slate-leaf="true" data-offset-key="2154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TimingWheel</span></span></span></span><span data-slate-object="text" data-key="2155"><span data-slate-leaf="true" data-offset-key="2155:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2156"><span data-slate-object="text" data-key="2157"><span data-slate-leaf="true" data-offset-key="2157:0" data-first-offset="true"><span data-slate-string="true">        tickMs = interval,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2158"><span data-slate-object="text" data-key="2159"><span data-slate-leaf="true" data-offset-key="2159:0" data-first-offset="true"><span data-slate-string="true">        wheelSize = wheelSize,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2160"><span data-slate-object="text" data-key="2161"><span data-slate-leaf="true" data-offset-key="2161:0" data-first-offset="true"><span data-slate-string="true">        startMs = currentTime,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2162"><span data-slate-object="text" data-key="2163"><span data-slate-leaf="true" data-offset-key="2163:0" data-first-offset="true"><span data-slate-string="true">        taskCounter = taskCounter,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2164"><span data-slate-object="text" data-key="2165"><span data-slate-leaf="true" data-offset-key="2165:0" data-first-offset="true"><span data-slate-string="true">        queue</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2166"><span data-slate-object="text" data-key="2167"><span data-slate-leaf="true" data-offset-key="2167:0" data-first-offset="true"><span data-slate-string="true">      )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2168"><span data-slate-object="text" data-key="2169"><span data-slate-leaf="true" data-offset-key="2169:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2170"><span data-slate-object="text" data-key="2171"><span data-slate-leaf="true" data-offset-key="2171:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2172"><span data-slate-object="text" data-key="2173"><span data-slate-leaf="true" data-offset-key="2173:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2174"><span data-slate-object="text" data-key="2175"><span data-slate-leaf="true" data-offset-key="2175:0" data-first-offset="true"><span data-slate-string="true">这个方法就是创建一个新的 TimingWheel 实例，也就是创建上层时间轮。所用的滴答时长等于下层时间轮总时长，而每层的轮子数都是相同的。创建完成之后，代码将新创建的实例赋值给 overflowWheel 字段。至此，方法结束。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2176"><span data-slate-object="text" data-key="2177"><span data-slate-leaf="true" data-offset-key="2177:0" data-first-offset="true"><span data-slate-string="true">下面，我们再来学习下 add 和 advanceClock 方法。首先是 add 方法，代码及其注释如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="2178"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2179"><span data-slate-object="text" data-key="2180"><span data-slate-leaf="true" data-offset-key="2180:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="2181"><span data-slate-leaf="true" data-offset-key="2181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">add</span></span></span></span><span data-slate-object="text" data-key="2182"><span data-slate-leaf="true" data-offset-key="2182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(timerTaskEntry: TimerTaskEntry)</span></span></span></span><span data-slate-object="text" data-key="2183"><span data-slate-leaf="true" data-offset-key="2183:0" data-first-offset="true"><span data-slate-string="true">: Boolean = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2184"><span data-slate-object="text" data-key="2185"><span data-slate-leaf="true" data-offset-key="2185:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2186"><span data-slate-leaf="true" data-offset-key="2186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取定时任务的过期时间戳</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2187"><span data-slate-object="text" data-key="2188"><span data-slate-leaf="true" data-offset-key="2188:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2189"><span data-slate-leaf="true" data-offset-key="2189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="2190"><span data-slate-leaf="true" data-offset-key="2190:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2191"><span data-slate-leaf="true" data-offset-key="2191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">expiration</span></span></span></span><span data-slate-object="text" data-key="2192"><span data-slate-leaf="true" data-offset-key="2192:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2193"><span data-slate-leaf="true" data-offset-key="2193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2194"><span data-slate-leaf="true" data-offset-key="2194:0" data-first-offset="true"><span data-slate-string="true"> timerTaskEntry.expirationMs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2195"><span data-slate-object="text" data-key="2196"><span data-slate-leaf="true" data-offset-key="2196:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2197"><span data-slate-leaf="true" data-offset-key="2197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该任务已然被取消了，则无需添加，直接返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2198"><span data-slate-object="text" data-key="2199"><span data-slate-leaf="true" data-offset-key="2199:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2200"><span data-slate-leaf="true" data-offset-key="2200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2201"><span data-slate-leaf="true" data-offset-key="2201:0" data-first-offset="true"><span data-slate-string="true"> (timerTaskEntry.cancelled) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2202"><span data-slate-object="text" data-key="2203"><span data-slate-leaf="true" data-offset-key="2203:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2204"><span data-slate-leaf="true" data-offset-key="2204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2205"><span data-slate-object="text" data-key="2206"><span data-slate-leaf="true" data-offset-key="2206:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2207"><span data-slate-leaf="true" data-offset-key="2207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该任务超时时间已过期</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2208"><span data-slate-object="text" data-key="2209"><span data-slate-leaf="true" data-offset-key="2209:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="2210"><span data-slate-leaf="true" data-offset-key="2210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="2211"><span data-slate-leaf="true" data-offset-key="2211:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2212"><span data-slate-leaf="true" data-offset-key="2212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2213"><span data-slate-leaf="true" data-offset-key="2213:0" data-first-offset="true"><span data-slate-string="true"> (expiration &lt; currentTime + tickMs) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2214"><span data-slate-object="text" data-key="2215"><span data-slate-leaf="true" data-offset-key="2215:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2216"><span data-slate-leaf="true" data-offset-key="2216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2217"><span data-slate-object="text" data-key="2218"><span data-slate-leaf="true" data-offset-key="2218:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2219"><span data-slate-leaf="true" data-offset-key="2219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该任务超时时间在本层时间轮覆盖时间范围内</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2220"><span data-slate-object="text" data-key="2221"><span data-slate-leaf="true" data-offset-key="2221:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="2222"><span data-slate-leaf="true" data-offset-key="2222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="2223"><span data-slate-leaf="true" data-offset-key="2223:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2224"><span data-slate-leaf="true" data-offset-key="2224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2225"><span data-slate-leaf="true" data-offset-key="2225:0" data-first-offset="true"><span data-slate-string="true"> (expiration &lt; currentTime + interval) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2226"><span data-slate-object="text" data-key="2227"><span data-slate-leaf="true" data-offset-key="2227:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2228"><span data-slate-leaf="true" data-offset-key="2228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="2229"><span data-slate-leaf="true" data-offset-key="2229:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2230"><span data-slate-leaf="true" data-offset-key="2230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">virtualId</span></span></span></span><span data-slate-object="text" data-key="2231"><span data-slate-leaf="true" data-offset-key="2231:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2232"><span data-slate-leaf="true" data-offset-key="2232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2233"><span data-slate-leaf="true" data-offset-key="2233:0" data-first-offset="true"><span data-slate-string="true"> expiration / tickMs</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2234"><span data-slate-object="text" data-key="2235"><span data-slate-leaf="true" data-offset-key="2235:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2236"><span data-slate-leaf="true" data-offset-key="2236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 计算要被放入到哪个 Bucket 中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2237"><span data-slate-object="text" data-key="2238"><span data-slate-leaf="true" data-offset-key="2238:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2239"><span data-slate-leaf="true" data-offset-key="2239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="2240"><span data-slate-leaf="true" data-offset-key="2240:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2241"><span data-slate-leaf="true" data-offset-key="2241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bucket</span></span></span></span><span data-slate-object="text" data-key="2242"><span data-slate-leaf="true" data-offset-key="2242:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="2243"><span data-slate-leaf="true" data-offset-key="2243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="2244"><span data-slate-leaf="true" data-offset-key="2244:0" data-first-offset="true"><span data-slate-string="true"> buckets((virtualId % wheelSize.toLong).toInt)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2245"><span data-slate-object="text" data-key="2246"><span data-slate-leaf="true" data-offset-key="2246:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2247"><span data-slate-leaf="true" data-offset-key="2247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 添加到 Bucket 中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2248"><span data-slate-object="text" data-key="2249"><span data-slate-leaf="true" data-offset-key="2249:0" data-first-offset="true"><span data-slate-string="true">    bucket.add(timerTaskEntry)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2250"><span data-slate-object="text" data-key="2251"><span data-slate-leaf="true" data-offset-key="2251:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2252"><span data-slate-leaf="true" data-offset-key="2252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置 Bucket 过期时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2253"><span data-slate-object="text" data-key="2254"><span data-slate-leaf="true" data-offset-key="2254:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2255"><span data-slate-leaf="true" data-offset-key="2255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果该时间变更过，说明 Bucket 是新建或被重用，将其加回到 DelayQueue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2256"><span data-slate-object="text" data-key="2257"><span data-slate-leaf="true" data-offset-key="2257:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2258"><span data-slate-leaf="true" data-offset-key="2258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2259"><span data-slate-leaf="true" data-offset-key="2259:0" data-first-offset="true"><span data-slate-string="true"> (bucket.setExpiration(virtualId * tickMs)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2260"><span data-slate-object="text" data-key="2261"><span data-slate-leaf="true" data-offset-key="2261:0" data-first-offset="true"><span data-slate-string="true">      queue.offer(bucket)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2262"><span data-slate-object="text" data-key="2263"><span data-slate-leaf="true" data-offset-key="2263:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2264"><span data-slate-object="text" data-key="2265"><span data-slate-leaf="true" data-offset-key="2265:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2266"><span data-slate-leaf="true" data-offset-key="2266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2267"><span data-slate-object="text" data-key="2268"><span data-slate-leaf="true" data-offset-key="2268:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2269"><span data-slate-leaf="true" data-offset-key="2269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 本层时间轮无法容纳该任务，交由上层时间轮处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2270"><span data-slate-object="text" data-key="2271"><span data-slate-leaf="true" data-offset-key="2271:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="2272"><span data-slate-leaf="true" data-offset-key="2272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="2273"><span data-slate-leaf="true" data-offset-key="2273:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2274"><span data-slate-object="text" data-key="2275"><span data-slate-leaf="true" data-offset-key="2275:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2276"><span data-slate-leaf="true" data-offset-key="2276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 按需创建上层时间轮</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2277"><span data-slate-object="text" data-key="2278"><span data-slate-leaf="true" data-offset-key="2278:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2279"><span data-slate-leaf="true" data-offset-key="2279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2280"><span data-slate-leaf="true" data-offset-key="2280:0" data-first-offset="true"><span data-slate-string="true"> (overflowWheel == </span></span></span><span data-slate-object="text" data-key="2281"><span data-slate-leaf="true" data-offset-key="2281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="2282"><span data-slate-leaf="true" data-offset-key="2282:0" data-first-offset="true"><span data-slate-string="true">) addOverflowWheel()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2283"><span data-slate-object="text" data-key="2284"><span data-slate-leaf="true" data-offset-key="2284:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2285"><span data-slate-leaf="true" data-offset-key="2285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加入到上层时间轮中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2286"><span data-slate-object="text" data-key="2287"><span data-slate-leaf="true" data-offset-key="2287:0" data-first-offset="true"><span data-slate-string="true">    overflowWheel.add(timerTaskEntry)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2288"><span data-slate-object="text" data-key="2289"><span data-slate-leaf="true" data-offset-key="2289:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2290"><span data-slate-object="text" data-key="2291"><span data-slate-leaf="true" data-offset-key="2291:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2292"><span data-slate-object="text" data-key="2293"><span data-slate-leaf="true" data-offset-key="2293:0" data-first-offset="true"><span data-slate-string="true">我结合一张图来解释下这个 add 方法要做的事情：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="2294"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/a3/3e/a3f8774eeeb06d0d0394b69f4b106b3e.jpg?wh=2148*4464"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2295"><span data-slate-object="text" data-key="2296"><span data-slate-leaf="true" data-offset-key="2296:0" data-first-offset="true"><span data-slate-string="true">方法的</span></span></span><span data-slate-object="text" data-key="2297"><span data-slate-leaf="true" data-offset-key="2297:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 1 步</span></span></span></span><span data-slate-object="text" data-key="2298"><span data-slate-leaf="true" data-offset-key="2298:0" data-first-offset="true"><span data-slate-string="true">是获取定时任务的过期时间戳。所谓过期时间戳，就是这个定时任务过期时的时点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2299"><span data-slate-object="text" data-key="2300"><span data-slate-leaf="true" data-offset-key="2300:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 2 步</span></span></span></span><span data-slate-object="text" data-key="2301"><span data-slate-leaf="true" data-offset-key="2301:0" data-first-offset="true"><span data-slate-string="true">是看定时任务是否已被取消。如果已经被取消，则无需加入到时间轮中。如果没有被取消，就接着看这个定时任务是否已经过期。如果过期了，自然也不用加入到时间轮中。如果没有过期，就看这个定时任务的过期时间是否能够被涵盖在本层时间轮的时间范围内。如果可以，则进入到下一步。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2302"><span data-slate-object="text" data-key="2303"><span data-slate-leaf="true" data-offset-key="2303:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 3 步</span></span></span></span><span data-slate-object="text" data-key="2304"><span data-slate-leaf="true" data-offset-key="2304:0" data-first-offset="true"><span data-slate-string="true">，首先计算目标 Bucket 序号，也就是这个定时任务需要被保存在哪个 TimerTaskList 中。我举个实际的例子，来说明一下如何计算目标 Bucket。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2305"><span data-slate-object="text" data-key="2306"><span data-slate-leaf="true" data-offset-key="2306:0" data-first-offset="true"><span data-slate-string="true">前面说过了，第 1 层的时间轮有 20 个 Bucket，每个滴答时长是 1 毫秒。那么，第 2 层时间轮的滴答时长应该就是 20 毫秒，总时长是 400 毫秒。第 2 层第 1 个 Bucket 的时间范围应该是 [20，40)，第 2 个 Bucket 的时间范围是 [40，60），依次类推。假设现在有个延时请求的超时时间戳是 237，那么，它就应该被插入到第 11 个 Bucket 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2307"><span data-slate-object="text" data-key="2308"><span data-slate-leaf="true" data-offset-key="2308:0" data-first-offset="true"><span data-slate-string="true">在确定了目标 Bucket 序号之后，代码会将该定时任务添加到这个 Bucket 下，同时更新这个 Bucket 的过期时间戳。在刚刚的那个例子中，第 11 号 Bucket 的起始时间就应该是小于 237 的最大的 20 的倍数，即 220。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2309"><span data-slate-object="text" data-key="2310"><span data-slate-leaf="true" data-offset-key="2310:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第 4 步</span></span></span></span><span data-slate-object="text" data-key="2311"><span data-slate-leaf="true" data-offset-key="2311:0" data-first-offset="true"><span data-slate-string="true">，如果这个 Bucket 是首次插入定时任务，那么，还同时要将这个 Bucket 加入到 DelayQueue 中，方便 Kafka 轻松地获取那些已过期 Bucket，并删除它们。如果定时任务的过期时间无法被涵盖在本层时间轮中，那么，就按需创建上一层时间戳，然后在上一层时间轮上完整地执行刚刚所说的所有逻辑。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2312"><span data-slate-object="text" data-key="2313"><span data-slate-leaf="true" data-offset-key="2313:0" data-first-offset="true"><span data-slate-string="true">说完了 add 方法，我们看下 advanceClock 方法。顾名思义，它就是向前驱动时钟的方法。代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="2314"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="2315"><span data-slate-object="text" data-key="2316"><span data-slate-leaf="true" data-offset-key="2316:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="2317"><span data-slate-leaf="true" data-offset-key="2317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">advanceClock</span></span></span></span><span data-slate-object="text" data-key="2318"><span data-slate-leaf="true" data-offset-key="2318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(timeMs: Long)</span></span></span></span><span data-slate-object="text" data-key="2319"><span data-slate-leaf="true" data-offset-key="2319:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2320"><span data-slate-object="text" data-key="2321"><span data-slate-leaf="true" data-offset-key="2321:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2322"><span data-slate-leaf="true" data-offset-key="2322:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向前驱动到的时点要超过 Bucket 的时间范围，才是有意义的推进，否则什么都不做</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2323"><span data-slate-object="text" data-key="2324"><span data-slate-leaf="true" data-offset-key="2324:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2325"><span data-slate-leaf="true" data-offset-key="2325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新当前时间 currentTime 到下一个 Bucket 的起始时点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2326"><span data-slate-object="text" data-key="2327"><span data-slate-leaf="true" data-offset-key="2327:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="2328"><span data-slate-leaf="true" data-offset-key="2328:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2329"><span data-slate-leaf="true" data-offset-key="2329:0" data-first-offset="true"><span data-slate-string="true"> (timeMs&gt;= currentTime + tickMs) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2330"><span data-slate-object="text" data-key="2331"><span data-slate-leaf="true" data-offset-key="2331:0" data-first-offset="true"><span data-slate-string="true">    currentTime = timeMs - (timeMs % tickMs)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2332"><span data-slate-object="text" data-key="2333"><span data-slate-leaf="true" data-offset-key="2333:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2334"><span data-slate-leaf="true" data-offset-key="2334:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 同时尝试为上一层时间轮做向前推进动作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2335"><span data-slate-object="text" data-key="2336"><span data-slate-leaf="true" data-offset-key="2336:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="2337"><span data-slate-leaf="true" data-offset-key="2337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="2338"><span data-slate-leaf="true" data-offset-key="2338:0" data-first-offset="true"><span data-slate-string="true"> (overflowWheel != </span></span></span><span data-slate-object="text" data-key="2339"><span data-slate-leaf="true" data-offset-key="2339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="2340"><span data-slate-leaf="true" data-offset-key="2340:0" data-first-offset="true"><span data-slate-string="true">) overflowWheel.advanceClock(currentTime)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2341"><span data-slate-object="text" data-key="2342"><span data-slate-leaf="true" data-offset-key="2342:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="2343"><span data-slate-object="text" data-key="2344"><span data-slate-leaf="true" data-offset-key="2344:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2345"><span data-slate-object="text" data-key="2346"><span data-slate-leaf="true" data-offset-key="2346:0" data-first-offset="true"><span data-slate-string="true">参数 timeMs 表示要把时钟向前推动到这个时点。向前驱动到的时点必须要超过 Bucket 的时间范围，才是有意义的推进，否则什么都不做，毕竟它还在 Bucket 时间范围内。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2347"><span data-slate-object="text" data-key="2348"><span data-slate-leaf="true" data-offset-key="2348:0" data-first-offset="true"><span data-slate-string="true">相反，一旦超过了 Bucket 覆盖的时间范围，代码就会更新当前时间 currentTime 到下一个 Bucket 的起始时点，同时递归地为上一层时间轮做向前推进动作。推进时钟的动作是由 Kafka 后台专属的 Reaper 线程发起的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2349"><span data-slate-object="text" data-key="2350"><span data-slate-leaf="true" data-offset-key="2350:0" data-first-offset="true"><span data-slate-string="true">今天，我反复提到了删除过期 Bucket，这个操作是由这个 Reaper 线程执行的。下节课，我们会提到这个 Reaper 线程。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2351" id="sr-toc-8"><span data-slate-object="text" data-key="2352"><span data-slate-leaf="true" data-offset-key="2352:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2353"><span data-slate-object="text" data-key="2354"><span data-slate-leaf="true" data-offset-key="2354:0" data-first-offset="true"><span data-slate-string="true">今天，我简要介绍了时间轮机制，并结合代码重点讲解了分层时间轮在 Kafka 中的代码实现。Kafka 正是利用这套分层时间轮机制实现了对于延迟请求的处理。在源码层级上，Kafka 定义了 4 个类来构建整套分层时间轮体系。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="2355"><div data-slate-type="list-line" data-slate-object="block" data-key="2356"><span data-slate-object="text" data-key="2357"><span data-slate-leaf="true" data-offset-key="2357:0" data-first-offset="true"><span data-slate-string="true">TimerTask 类：建模 Kafka 延时请求。它是一个 Runnable 类，Kafka 使用一个单独线程异步添加延时请求到时间轮。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2358"><span data-slate-object="text" data-key="2359"><span data-slate-leaf="true" data-offset-key="2359:0" data-first-offset="true"><span data-slate-string="true">TimerTaskEntry 类：建模时间轮 Bucket 下延时请求链表的元素类型，封装了 TimerTask 对象和定时任务的过期时间戳信息。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2360"><span data-slate-object="text" data-key="2361"><span data-slate-leaf="true" data-offset-key="2361:0" data-first-offset="true"><span data-slate-string="true">TimerTaskList 类：建模时间轮 Bucket 下的延时请求双向循环链表，提供 O (1) 时间复杂度的请求插入和删除。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="2362"><span data-slate-object="text" data-key="2363"><span data-slate-leaf="true" data-offset-key="2363:0" data-first-offset="true"><span data-slate-string="true">TimingWheel 类：建模时间轮类型，统一管理下辖的所有 Bucket 以及定时任务。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="2364"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/ae/8d/ae956dfc9f494be6c50440c347f5fc8d.jpg?wh=2250*3068"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2365"><span data-slate-object="text" data-key="2366"><span data-slate-leaf="true" data-offset-key="2366:0" data-first-offset="true"><span data-slate-string="true">在下一讲中，我们将继续学习 Kafka 延时请求，以及管理它们的 DelayedOperation 家族的源码。只有了解了 DelayedOperation 及其具体实现子类的代码，我们才能完整地了解，当请求不能被及时处理时，Kafka 是如何应对的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2367"><span data-slate-object="text" data-key="2368"><span data-slate-leaf="true" data-offset-key="2368:0" data-first-offset="true"><span data-slate-string="true">在分布式系统中，如何优雅而高效地延迟处理任务是摆在设计者面前的难题之一。我建议你好好学习下这套实现机制在 Kafka 中的应用代码，活学活用，将其彻底私有化，加入到你的工具箱中。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="2369" id="sr-toc-9"><span data-slate-object="text" data-key="2370"><span data-slate-leaf="true" data-offset-key="2370:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="2371"><span data-slate-object="text" data-key="2372"><span data-slate-leaf="true" data-offset-key="2372:0" data-first-offset="true"><span data-slate-string="true">TimingWheel 类中的 overflowWheel 变量为什么是 volatile 型的？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="2373"><span data-slate-object="text" data-key="2374"><span data-slate-leaf="true" data-offset-key="2374:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区畅所欲言，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-10">精选留言 (10)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们结合源码重点了解了 PartitionStateMachine 的原理。课后我让你去自行分析下 triggerOnlineStateChangeForPartitions 方法，并尝试找出它被调用的时机。其实，这个方法，顾名思义就是将一组给定的主题分区的状态变更到 Online 状态。在执行变更前，必须要判断这些分区所属的主题当前没有被执行删除操作。另外除了要变更状态之外，该方法还会为这些分区执行 Leader 选举。triggerOnlineStateChangeForPartitions 方法被调用的时机主要有 3 个：1. 选举 Controller 成功之后；2. Broker 启动或下线时；3. Unclean Leader 选举时。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-06-15</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>伯安知心</span></div></div><div>首先声明 TimingWheel 不是线程安全的，addOverflowWheel 这个方法设计本身要单例模式，但是多个线程执行 addOverflowWheel 方法，可能出现不一致实例化多个类，如果是 volatile 限制了指令重排序，就解决了这个问题。首先声明 TimingWheel 不是线程安全的，addOverflowWheel 这个方法设计本身要单例模式，但是多个线程执行 addOverflowWheel 方法，可能出现不一致实例化多个类，如果是 volatile 限制了指令重排序，就解决了这个问题。</div><div><p>作者回复：不妨写个改进的 patch：）
</p></div><div><div>2020-06-06</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1e/37/29/b3af57a7.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 凯文小猪</span></div></div><div>overflowWheel 用在两个地方，一个是外部定时器也就是 tickout 线程的定时发起时钟轮转，此时需要更新层级时间轮（包括子级与父级），另一个是添加线程，也就是 kafka 接收到 produceRequest 的 handler 线程，他们会创建延时任务，如果牵涉到父级时间轮，也需要照顾他们的可见性。

这里要补充一点，就是老师没有讲到的 queue 问题。实际上分层时间轮最常见的问题有两个：
1. 空转。也就是 currentTime 指针指向了某个 bucket 但是那个 bucket 实际上是空的。kafka 的处理方式使用 delayqueue 来处理，delayQueue.poll () 对于未到期的数据 是不会返回的，这样我们就不需要更新空转的指针
2. 精度问题。实际上精度取决于最低一级时间轮的时间跨度，相当于 PC 里的 HZ。而外部定时器每一轮发起的频次也会影响。
综上 进度误差在：外部定时器每一轮的频次 + 最低一级时间轮的时间跨度 ——》就是最小误差精度
</div><div><div>2022-06-29</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/45/8f/a56b2214.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>innocent</span></div></div><div>JDK 自带的任务调度没有使用时间轮而是使用了优先队列</div><div><div>2020-12-17</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>李</span></div></div><div>老师，你好。源码中 TimerTaskList#add () 方法中有两行这样的注释 Remove the timer task entry if it is already in any other list，We do this outside of the sync block below to avoid deadlocking.  如果 timerTaskEntry.remove () 该行放进 timerTaskEntry.synchronized 代码块里，与其他方法加锁顺序都一致，这儿哪里会有死锁</div><div><p>作者回复：嗯，有一定道理。我觉得更多的就是一种防御性编程</p></div><div><div>2020-11-15</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/aa/6b/ab9a072a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>对与错</span></div></div><div>我还是没有 get 到这个延迟队列的用途，为啥更新过期时间之后，需要把任务放到延迟队列里面？</div><div><p>作者回复：其实只是把任务放入更高一级的时间轮中管理</p></div><div><div>2020-10-22</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/9a/25/3e5e942b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>张子涵</span></div></div><div> //overflowWheel can potentially be updated and read by two concurrent threads through add ().
  // Therefore, it needs to be volatile due to the issue of Double-Checked Locking pattern with JVM
  @volatile private [this] var overflowWheel: TimingWheel = null        源码中有解答，大家可以都看一下</div><div><div>2020-08-27</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>吃饭饭</span></div></div><div>有个问题不明白：TimerTaskEntry 的 remove () 方法的 while (currentList != null) ，这个链表不是能放很多 TimerTaskEntry 吗？只是移除当前这个 Entry 为什么要把整个链表置空？如果内部还有其他的 Entry 呢？</div><div><p>作者回复：这是从 TimerTaskEntry 的角度去做的。currentList 只是 TimerTaskEntry 角度下的链表，将它置空相当于把该 entry 与 list 割裂开来。链表本身还是存在的</p></div><div><div>2020-06-19</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIZcwnxGkjzENwyeEd3RZsh9tpZDeYmnT51iciaMiaLV2XRfzrJolZvUWjf3L5DuE3BmBg7uCKg3iaSzQ/132"></div></div><div><div><div><span>RonnieXie</span></div></div><div>老师，这里有一个疑问，使用哈希表 map 似乎也可以实现延迟队列，key 为时间戳，定期执行任务和删除过期任务，时间复杂度 O (1)，请问使用分层时间轮和哈希表 map 的优缺点是什么？</div><div><p>作者回复：如何解决排序问题呢？</p></div><div><div>2020-06-07</div><div><div><i></i><span>3</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/76/23/31e5e984.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>空知</span></div></div><div>只有当前时间越过了 Bucket 的起始时间，这个 Bucket 才算是过期。而这里的起始时间，就是代码中 expiration 字段的值。     这里的起始时间是否应该是 终止时间？
taskCounter：这一层时间轮上的总定时任务数。   这里是否是每个 Bucket 的任务数？</div><div><p>作者回复: 1. 源码中并没有终止时间的提法。一旦时钟越过了 Bucket 起始时间，该 Bucket 就被视为过期了
2. 不是单个 Bucket 的，而是整个时间轮上的</p></div><div><div>2020-06-07</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".4"><outline class="toc-level-h1" data-reactid=".4.0" style="width: 175px;"><active data-reactid=".4.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".4.0.1"><span data-reactid=".4.0.1.0">19 | TimingWheel：探究 Kafka 定时器背后的高效时间轮算法</span></a></outline><outline class="toc-level-h2" data-reactid=".4.1" style="width: 165px;"><active data-reactid=".4.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".4.1.1"><span data-reactid=".4.1.1.0">时间轮简介</span></a></outline><outline class="toc-level-h2" data-reactid=".4.2" style="width: 165px;"><active data-reactid=".4.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".4.2.1"><span data-reactid=".4.2.1.0">源码层级关系</span></a></outline><outline class="toc-level-h2" data-reactid=".4.3" style="width: 165px;"><active data-reactid=".4.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".4.3.1"><span data-reactid=".4.3.1.0">时间轮各个类源码定义</span></a></outline><outline class="toc-level-h3" data-reactid=".4.4" style="width: 155px;"><active data-reactid=".4.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".4.4.1"><span data-reactid=".4.4.1.0">TimerTask 类</span></a></outline><outline class="toc-level-h3" data-reactid=".4.5" style="width: 155px;"><active data-reactid=".4.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".4.5.1"><span data-reactid=".4.5.1.0">TimerTaskEntry 类</span></a></outline><outline class="toc-level-h3" data-reactid=".4.6" style="width: 155px;"><active data-reactid=".4.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".4.6.1"><span data-reactid=".4.6.1.0">TimerTaskList 类</span></a></outline><outline class="toc-level-h3" data-reactid=".4.7" style="width: 155px;"><active data-reactid=".4.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".4.7.1"><span data-reactid=".4.7.1.0">TimingWheel 类</span></a></outline><outline class="toc-level-h2" data-reactid=".4.8" style="width: 165px;"><active data-reactid=".4.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".4.8.1"><span data-reactid=".4.8.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".4.9" style="width: 165px;"><active data-reactid=".4.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".4.9.1"><span data-reactid=".4.9.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".4.a" style="width: 165px;"><active data-reactid=".4.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".4.a.1"><span data-reactid=".4.a.1.0">精选留言 (10)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/245212" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>