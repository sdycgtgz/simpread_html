
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 17 | 为什么 CPU 结构也会影响 Redis 的性能？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>17 | 为什么 CPU 结构也会影响 Redis 的性能？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">17 | 为什么 CPU 结构也会影响 Redis 的性能？</h1><div><span>蒋德钧</span> <span> 2020-09-16</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/18/5b/18bb8358dc42ee9016b8367ca1c85f5b.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：蒋德钧</span><span>大小：22.26M</span><span> 时长：24:22</span></div></div><audio title="17 | 为什么CPU结构也会影响Redis的性能？" src="https://res001.geekbang.org/media/audio/1e/6c/1e6bc30079078d1598c077262d1a3b6c/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="4253" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="4254"><span data-slate-object="text" data-key="4255"><span data-slate-leaf="true" data-offset-key="4255:0" data-first-offset="true"><span data-slate-string="true">你好，我是蒋德钧。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4256"><span data-slate-object="text" data-key="4257"><span data-slate-leaf="true" data-offset-key="4257:0" data-first-offset="true"><span data-slate-string="true">很多人都认为 Redis 和 CPU 的关系很简单，就是 Redis 的线程在 CPU 上运行，CPU 快，Redis 处理请求的速度也很快。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4258"><span data-slate-object="text" data-key="4259"><span data-slate-leaf="true" data-offset-key="4259:0" data-first-offset="true"><span data-slate-string="true">这种认知其实是片面的。CPU 的多核架构以及多 CPU 架构，也会影响到 Redis 的性能。如果不了解 CPU 对 Redis 的影响，在对 Redis 的性能进行调优时，就可能会遗漏一些调优方法，不能把 Redis 的性能发挥到极限。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4260"><span data-slate-object="text" data-key="4261"><span data-slate-leaf="true" data-offset-key="4261:0" data-first-offset="true"><span data-slate-string="true">今天，我们就来学习下目前主流服务器的 CPU 架构，以及基于 CPU 多核架构和多 CPU 架构优化 Redis 性能的方法。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4262" id="sr-toc-1"><span data-slate-object="text" data-key="4263"><span data-slate-leaf="true" data-offset-key="4263:0" data-first-offset="true"><span data-slate-string="true">主流的 CPU 架构</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4264"><span data-slate-object="text" data-key="4265"><span data-slate-leaf="true" data-offset-key="4265:0" data-first-offset="true"><span data-slate-string="true">要了解 CPU 对 Redis 具体有什么影响，我们得先了解一下 CPU 架构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4266"><span data-slate-object="text" data-key="4267"><span data-slate-leaf="true" data-offset-key="4267:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_12ccf9aa" data-attr-id="18983" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一个 CPU 处理器中一般有多个运行核心，我们把一个运行核心称为一个物理核，每个物理核都可以运行应用程序。每个物理核都拥有私有的一级缓存（Level 1 cache，简称 L1 cache），包括一级指令缓存和一级数据缓存，以及私有的二级缓存（Level 2 cache，简称 L2 cache）。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4268"><span data-slate-object="text" data-key="4269"><span data-slate-leaf="true" data-offset-key="4269:0" data-first-offset="true"><span data-slate-string="true">这里提到了一个概念，就是物理核的私有缓存。它其实是指缓存空间只能被当前的这个物理核使用，其他的物理核无法对这个核的缓存空间进行数据存取。我们来看一下 CPU 物理核的架构。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4270"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/c2/3a/c2d620c012a82e825570df631a7fbc3a.jpg?wh=2114*1167"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4271"><span data-slate-object="text" data-key="4272"><span data-slate-leaf="true" data-offset-key="4272:0" data-first-offset="true"><span data-slate-string="true">因为 L1 和 L2 缓存是每个物理核私有的，所以，当数据或指令保存在 L1、L2 缓存时，物理核访问它们的延迟不超过 10 纳秒，速度非常快。那么，如果 Redis 把要运行的指令或存取的数据保存在 L1 和 L2 缓存的话，就能高速地访问这些指令和数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4273"><span data-slate-object="text" data-key="4274"><span data-slate-leaf="true" data-offset-key="4274:0" data-first-offset="true"><span data-slate-string="true">但是，这些 L1 和 L2 缓存的大小受限于处理器的制造技术，一般只有 KB 级别，存不下太多的数据。如果 L1、L2 缓存中没有所需的数据，应用程序就需要访问内存来获取数据。而应用程序的访存延迟一般在百纳秒级别，是访问 L1、L2 缓存的延迟的近 10 倍，不可避免地会对性能造成影响。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4275"><span data-slate-object="text" data-key="4276"><span data-slate-leaf="true" data-offset-key="4276:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_9d522de7" data-attr-id="10013" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">所以，不同的物理核还会共享一个共同的三级缓存（Level 3 cache，简称为 L3 cache）。</span></span></span><span data-slate-leaf="true" data-offset-key="4276:1"><span data-slate-string="true">L3 缓存能够使用的存储资源比较多，所以一般比较大，能达到几 MB 到几十 MB，这就能让应用程序缓存更多的数据。当 L1、L2 缓存中没有数据缓存时，可以访问 L3，尽可能避免访问内存。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4277"><span data-slate-object="text" data-key="4278"><span data-slate-leaf="true" data-offset-key="4278:0" data-first-offset="true"><span data-slate-string="true">另外，现在主流的 CPU 处理器中，</span></span><span data-slate-leaf="true" data-offset-key="4278:1"><span data-slate-object="annotation" data-annotation-key="gkann_2cc9f5ec" data-attr-id="27307" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">每个物理核通常都会运行两个超线程，也叫作逻辑核。同一个物理核的逻辑核会共享使用 L1、L2 缓存。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4279"><span data-slate-object="text" data-key="4280"><span data-slate-leaf="true" data-offset-key="4280:0" data-first-offset="true"><span data-slate-string="true">为了方便你理解，我用一张图展示一下物理核和逻辑核，以及一级、二级缓存的关系。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4281"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/d9/09/d9689a38cbe67c3008d8ba99663c2f09.jpg?wh=3065*1633"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4282"><span data-slate-object="text" data-key="4283"><span data-slate-leaf="true" data-offset-key="4283:0" data-first-offset="true"><span data-slate-string="true">在主流的服务器上，一个 CPU 处理器会有 10 到 20 多个物理核。同时，为了提升服务器的处理能力，</span></span><span data-slate-leaf="true" data-offset-key="4283:1"><span data-slate-object="annotation" data-annotation-key="gkann_8db9ce65" data-attr-id="10014" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">服务器上通常还会有多个 CPU 处理器（也称为多 CPU Socket），</span></span></span><span data-slate-leaf="true" data-offset-key="4283:2"><span data-slate-string="true">每个处理器有自己的物理核（包括 L1、L2 缓存），L3 缓存，以及连接的内存，同时，不同处理器间通过总线连接。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4284"><span data-slate-object="text" data-key="4285"><span data-slate-leaf="true" data-offset-key="4285:0" data-first-offset="true"><span data-slate-string="true">下图显示的就是多 CPU Socket 的架构，图中有两个 Socket，每个 Socket 有两个物理核。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4286"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/5c/3d/5ceb2ab6f61c064284c8f8811431bc3d.jpg?wh=3000*1252"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4287"><span data-slate-object="text" data-key="4288"><span data-slate-leaf="true" data-offset-key="4288:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在多 CPU 架构上，应用程序可以在不同的处理器上运行</span></span></span></span><span data-slate-object="text" data-key="4289"><span data-slate-leaf="true" data-offset-key="4289:0" data-first-offset="true"><span data-slate-string="true">。在刚才的图中，Redis 可以先在 Socket  1 上运行一段时间，然后再被调度到 Socket  2 上运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4290"><span data-slate-object="text" data-key="4291"><span data-slate-leaf="true" data-offset-key="4291:0" data-first-offset="true"><span data-slate-string="true">但是，有个地方需要你注意一下：如果应用程序先在一个 Socket 上运行，并且把数据保存到了内存，然后被调度到另一个 Socket 上运行，此时，</span></span><span data-slate-leaf="true" data-offset-key="4291:1"><span data-slate-object="annotation" data-annotation-key="gkann_6166d4f6" data-attr-id="18823" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">应用程序再进行内存访问时，就需要访问之前 Socket 上连接的内存，</span></span></span><span data-slate-leaf="true" data-offset-key="4291:2"><span data-slate-string="true">这种访问属于</span></span></span><span data-slate-object="text" data-key="4292"><span data-slate-leaf="true" data-offset-key="4292:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">远端内存访问</span></span></span></span><span data-slate-object="text" data-key="4293"><span data-slate-leaf="true" data-offset-key="4293:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span><span data-slate-object="text" data-key="4294"><span data-slate-leaf="true" data-offset-key="4294:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">和访问 Socket 直接连接的内存相比，远端内存访问会增加应用程序的延迟。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4295"><span data-slate-object="text" data-key="4296"><span data-slate-leaf="true" data-offset-key="4296:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_7f89fec8" data-attr-id="8819" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在多 CPU 架构下，一个应用程序访问所在 Socket 的本地内存和访问远端内存的延迟并不一致，所以，我们也把这个架构称为非统一内存访问架构（Non-Uniform Memory Access，NUMA 架构）。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4297"><span data-slate-object="text" data-key="4298"><span data-slate-leaf="true" data-offset-key="4298:0" data-first-offset="true"><span data-slate-string="true">到这里，</span></span><span data-slate-leaf="true" data-offset-key="4298:1"><span data-slate-object="annotation" data-annotation-key="gkann_38a812b4" data-attr-id="23305" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们就知道了主流的 CPU 多核架构和多 CPU 架构，</span></span></span><span data-slate-leaf="true" data-offset-key="4298:2"><span data-slate-string="true">我们来简单总结下 CPU 架构对应用程序运行的影响。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4299"><div data-slate-type="list-line" data-slate-object="block" data-key="4300"><span data-slate-object="text" data-key="4301"><span data-slate-leaf="true" data-offset-key="4301:0" data-first-offset="true"><span data-slate-string="true">L1、L2 缓存中的指令和数据的访问速度很快，所以，充分利用 L1、L2 缓存，可以有效缩短应用程序的执行时间；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4302"><span data-slate-object="text" data-key="4303"><span data-slate-leaf="true" data-offset-key="4303:0" data-first-offset="true"><span data-slate-string="true">在 NUMA 架构下，如果应用程序从一个 Socket 上调度到另一个 Socket 上，就可能会出现远端内存访问的情况，这会直接增加应用程序的执行时间。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4304"><span data-slate-object="text" data-key="4305"><span data-slate-leaf="true" data-offset-key="4305:0" data-first-offset="true"><span data-slate-string="true">接下来，我们就先来了解下 CPU 多核是如何影响 Redis 性能的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4306" id="sr-toc-2"><span data-slate-object="text" data-key="4307"><span data-slate-leaf="true" data-offset-key="4307:0" data-first-offset="true"><span data-slate-string="true">CPU 多核对 Redis 性能的影响</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4308"><span data-slate-object="text" data-key="4309"><span data-slate-leaf="true" data-offset-key="4309:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_142a4d1f" data-attr-id="21189" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在一个 CPU 核上运行时，应用程序需要记录自身使用的软硬件资源信息（例如栈指针、CPU 核的寄存器值等），我们把这些信息称为</span></span></span></span><span data-slate-object="text" data-key="4310"><span data-slate-leaf="true" data-offset-key="4310:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_142a4d1f" data-attr-id="21189" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">运行时信息</span></span></span></span></span><span data-slate-object="text" data-key="4311"><span data-slate-leaf="true" data-offset-key="4311:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_142a4d1f" data-attr-id="21189" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span><span data-slate-leaf="true" data-offset-key="4311:1"><span data-slate-string="true">同时，</span></span><span data-slate-leaf="true" data-offset-key="4311:2"><span data-slate-object="annotation" data-annotation-key="gkann_1367c6d4" data-attr-id="37599" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">应用程序访问最频繁的指令和数据还会被缓存到 L1、L2 缓存上，</span></span></span><span data-slate-leaf="true" data-offset-key="4311:3"><span data-slate-string="true">以便提升执行速度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4312"><span data-slate-object="text" data-key="4313"><span data-slate-leaf="true" data-offset-key="4313:0" data-first-offset="true"><span data-slate-string="true">但是，在多核 CPU 的场景下，</span></span><span data-slate-leaf="true" data-offset-key="4313:1"><span data-slate-object="annotation" data-annotation-key="gkann_e2ed0c2e" data-attr-id="29203" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">一旦应用程序需要在一个新的 CPU 核上运行，</span></span></span><span data-slate-leaf="true" data-offset-key="4313:2"><span data-slate-string="true">那么，</span></span><span data-slate-leaf="true" data-offset-key="4313:3"><span data-slate-object="annotation" data-annotation-key="gkann_7357424c" data-attr-id="29204" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">运行时信息就需要重新加载到新的 CPU 核上。</span></span></span><span data-slate-leaf="true" data-offset-key="4313:4"><span data-slate-string="true">而且，新的 CPU 核的 L1、L2 缓存也需要重新加载数据和指令，这会导致程序的运行时间增加。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4314"><span data-slate-object="text" data-key="4315"><span data-slate-leaf="true" data-offset-key="4315:0" data-first-offset="true"><span data-slate-string="true">说到这儿，我想跟你分享一个我曾经在多核 CPU 环境下对 Redis 性能进行调优的案例。希望借助这个案例，帮你全方位地了解到多核 CPU 对 Redis 的性能的影响。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4316"><span data-slate-object="text" data-key="4317"><span data-slate-leaf="true" data-offset-key="4317:0" data-first-offset="true"><span data-slate-string="true">当时，我们的项目需求是要对 Redis 的 99% 尾延迟进行优化，</span></span><span data-slate-leaf="true" data-offset-key="4317:1"><span data-slate-object="annotation" data-annotation-key="gkann_d1de742f" data-attr-id="32429" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">要求 GET 尾延迟小于 300 微秒，PUT 尾延迟小于 500 微秒。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4318"><span data-slate-object="text" data-key="4319"><span data-slate-leaf="true" data-offset-key="4319:0" data-first-offset="true"><span data-slate-string="true">可能有同学不太清楚 99% 尾延迟是啥，我先解释一下。我们把所有请求的处理延迟从小到大排个序，</span></span></span><span data-slate-object="text" data-key="4320"><span data-slate-leaf="true" data-offset-key="4320:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_30340e08" data-attr-id="38269" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">99% 的请求延迟小于的值就是 99% 尾延迟</span></span></span></span></span><span data-slate-object="text" data-key="4321"><span data-slate-leaf="true" data-offset-key="4321:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_30340e08" data-attr-id="38269" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span><span data-slate-leaf="true" data-offset-key="4321:1"><span data-slate-object="annotation" data-annotation-key="gkann_54b4b789" data-attr-id="42964" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">比如说，我们有 1000 个请求，假设按请求延迟从小到大排序后，第 991 个请求的延迟实测值是 1ms，而前 990 个请求的延迟都小于 1ms，所以，这里的 99% 尾延迟就是 1ms。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4322"><span data-slate-object="text" data-key="4323"><span data-slate-leaf="true" data-offset-key="4323:0" data-first-offset="true"><span data-slate-string="true">刚开始的时候，我们使用 GET/PUT 复杂度为 O (1) 的 String 类型进行数据存取，同时关闭了 RDB 和 AOF，而且，Redis 实例中没有保存集合类型的其他数据，也就没有 bigkey 操作，避免了可能导致延迟增加的许多情况。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4324"><span data-slate-object="text" data-key="4325"><span data-slate-leaf="true" data-offset-key="4325:0" data-first-offset="true"><span data-slate-string="true">但是，即使这样，我们在一台有 24 个 CPU 核的服务器上运行 Redis 实例，GET 和 PUT 的 99% 尾延迟分别是 504 微秒和 1175 微秒，明显大于我们设定的目标。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4326"><span data-slate-object="text" data-key="4327"><span data-slate-leaf="true" data-offset-key="4327:0" data-first-offset="true"><span data-slate-string="true">后来，我们仔细检测了 Redis 实例运行时的服务器 CPU 的状态指标值，这才发现，</span></span><span data-slate-leaf="true" data-offset-key="4327:1"><span data-slate-object="annotation" data-annotation-key="gkann_61753ba6" data-attr-id="19153" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">CPU 的 context switch 次数比较多。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4328"><span data-slate-object="text" data-key="4329"><span data-slate-leaf="true" data-offset-key="4329:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_848fbcd3" data-attr-id="13778" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">context switch 是指线程的上下文切换，这里的上下文就是线程的运行时信息。在 CPU 多核的环境中，一个线程先在一个 CPU 核上运行，之后又切换到另一个 CPU 核上运行，这时就会发生 context switch。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4330"><span data-slate-object="text" data-key="4331"><span data-slate-leaf="true" data-offset-key="4331:0" data-first-offset="true"><span data-slate-string="true">当 context switch 发生后，Redis 主线程的运行时信息需要被重新加载到另一个 CPU 核上，而且，此时，另一个 CPU 核上的 L1、L2 缓存中，并没有 Redis 实例之前运行时频繁访问的指令和数据，所以，这些指令和数据都需要重新从 L3 缓存，甚至是内存中加载。这个重新加载的过程是需要花费一定时间的。而且，Redis 实例需要等待这个重新加载的过程完成后，才能开始处理请求，所以，这也会导致一些请求的处理时间增加。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4332"><span data-slate-object="text" data-key="4333"><span data-slate-leaf="true" data-offset-key="4333:0" data-first-offset="true"><span data-slate-string="true">如果在 CPU 多核场景下，Redis 实例被频繁调度到不同 CPU 核上运行的话，那么，对 Redis 实例的请求处理时间影响就更大了。</span></span></span><span data-slate-object="text" data-key="4334"><span data-slate-leaf="true" data-offset-key="4334:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_58c0b7c8" data-attr-id="7835" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">每调度一次，一些请求就会受到运行时信息、指令和数据重新加载过程的影响，这就会导致某些请求的延迟明显高于其他请求</span></span></span></span></span><span data-slate-object="text" data-key="4335"><span data-slate-leaf="true" data-offset-key="4335:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_58c0b7c8" data-attr-id="7835" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span><span data-slate-leaf="true" data-offset-key="4335:1"><span data-slate-string="true">分析到这里，我们就知道了刚刚的例子中 99% 尾延迟的值始终降不下来的原因。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4336"><span data-slate-object="text" data-key="4337"><span data-slate-leaf="true" data-offset-key="4337:0" data-first-offset="true"><span data-slate-string="true">所以，我们要避免 Redis 总是在不同 CPU 核上来回调度执行。于是，我们尝试着把 Redis 实例和 CPU 核绑定了，让一个 Redis 实例固定运行在一个 CPU 核上。</span></span><span data-slate-leaf="true" data-offset-key="4337:1"><span data-slate-object="annotation" data-annotation-key="gkann_5e6ccc28" data-attr-id="5316" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们可以使用 </span></span></span></span><span data-slate-object="text" data-key="4338"><span data-slate-leaf="true" data-offset-key="4338:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5e6ccc28" data-attr-id="5316" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">taskset 命令</span></span></span></span></span><span data-slate-object="text" data-key="4339"><span data-slate-leaf="true" data-offset-key="4339:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5e6ccc28" data-attr-id="5316" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">把一个程序绑定在一个核上运行。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4340"><span data-slate-object="text" data-key="4341"><span data-slate-leaf="true" data-offset-key="4341:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_e22fb83c" data-attr-id="32852" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">比如说，我们执行下面的命令，就把 Redis 实例绑在了 0 号核上，其中，“-c” 选项用于设置要绑定的核编号。</span></span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="4342"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4343"><span data-slate-object="text" data-key="4344"><span data-slate-leaf="true" data-offset-key="4344:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_ab680741" data-attr-id="37638" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">taskset -c 0 ./redis-server</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4345"><span data-slate-object="text" data-key="4346"><span data-slate-leaf="true" data-offset-key="4346:0" data-first-offset="true"><span data-slate-string="true">绑定以后，我们进行了测试。我们发现，Redis 实例的 GET 和 PUT 的 99% 尾延迟一下子就分别降到了 260 微秒和 482 微秒，达到了我们期望的目标。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4347"><span data-slate-object="text" data-key="4348"><span data-slate-leaf="true" data-offset-key="4348:0" data-first-offset="true"><span data-slate-string="true">我们来看一下绑核前后的 Redis 的 99% 尾延迟。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4349"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/eb/57/eb72b9f58052d6a6023d3e1dac522157.jpg?wh=2760*477"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4350"><span data-slate-object="text" data-key="4351"><span data-slate-leaf="true" data-offset-key="4351:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d1e4fef9" data-attr-id="10017" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">可以看到，在 CPU 多核的环境下，通过绑定 Redis 实例和 CPU 核，可以有效降低 Redis 的尾延迟。</span></span></span><span data-slate-leaf="true" data-offset-key="4351:1"><span data-slate-string="true">当然，绑核不仅对降低尾延迟有好处，同样也能降低平均延迟、提升吞吐率，进而提升 Redis 性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4352"><span data-slate-object="text" data-key="4353"><span data-slate-leaf="true" data-offset-key="4353:0" data-first-offset="true"><span data-slate-string="true">接下来，我们再来看看多 CPU 架构，也就是 NUMA 架构，对 Redis 性能的影响。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4354" id="sr-toc-3"><span data-slate-object="text" data-key="4355"><span data-slate-leaf="true" data-offset-key="4355:0" data-first-offset="true"><span data-slate-string="true">CPU 的 NUMA 架构对 Redis 性能的影响</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4356"><span data-slate-object="text" data-key="4357"><span data-slate-leaf="true" data-offset-key="4357:0" data-first-offset="true"><span data-slate-string="true">在实际应用 Redis 时，我经常看到一种做法，为了提升 Redis 的网络性能，</span></span><span data-slate-leaf="true" data-offset-key="4357:1"><span data-slate-object="annotation" data-annotation-key="gkann_5caf3afc" data-attr-id="5337" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">把操作系统的网络中断处理程序和 CPU 核绑定。</span></span></span><span data-slate-leaf="true" data-offset-key="4357:2"><span data-slate-string="true">这个做法可以避免网络中断处理程序在不同核上来回调度执行，的确能有效提升 Redis 的网络处理性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4358"><span data-slate-object="text" data-key="4359"><span data-slate-leaf="true" data-offset-key="4359:0" data-first-offset="true"><span data-slate-string="true">但是，网络中断程序是要和 Redis 实例进行网络数据交互的，一旦把网络中断程序绑核后，我们就需要注意 Redis 实例是绑在哪个核上了，这会关系到 Redis 访问网络数据的效率高低。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4360"><span data-slate-object="text" data-key="4361"><span data-slate-leaf="true" data-offset-key="4361:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_400e44ff" data-attr-id="10018" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们先来看下 Redis 实例和网络中断程序的数据交互：网络中断处理程序从网卡硬件中读取数据，并把数据写入到操作系统内核维护的一块内存缓冲区。内核会通过 epoll 机制触发事件，通知 Redis 实例，Redis 实例再把数据从内核的内存缓冲区拷贝到自己的内存空间，如下图所示：</span></span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4362"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/87/d2/8753ce6985fd08bb9cf9a3813c8b2cd2.jpg?wh=2108*1295"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4363"><span data-slate-object="text" data-key="4364"><span data-slate-leaf="true" data-offset-key="4364:0" data-first-offset="true"><span data-slate-string="true">那么，在 CPU 的 NUMA 架构下，当网络中断处理程序、Redis 实例分别和 CPU 核绑定后，</span></span><span data-slate-leaf="true" data-offset-key="4364:1"><span data-slate-object="annotation" data-annotation-key="gkann_d7663a9f" data-attr-id="10019" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">就会有一个潜在的风险：</span></span></span></span><span data-slate-object="text" data-key="4365"><span data-slate-leaf="true" data-offset-key="4365:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d7663a9f" data-attr-id="10019" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如果网络中断处理程序和 Redis 实例各自所绑的 CPU 核不在同一个 CPU Socket 上，那么，Redis 实例读取网络数据时，就需要跨 CPU Socket 访问内存，这个过程会花费较多时间。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4366"><span data-slate-object="text" data-key="4367"><span data-slate-leaf="true" data-offset-key="4367:0" data-first-offset="true"><span data-slate-string="true">这么说可能有点抽象，我再借助一张图来解释下。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4368"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/30/b0/30cd42yy86debc0eb6e7c5b069533ab0.jpg?wh=3000*1251"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4369"><span data-slate-object="text" data-key="4370"><span data-slate-leaf="true" data-offset-key="4370:0" data-first-offset="true"><span data-slate-string="true">可以看到，图中的网络中断处理程序被绑在了 CPU Socket 1 的某个核上，而 Redis 实例则被绑在了 CPU Socket  2 上。此时，网络中断处理程序读取到的网络数据，被保存在 CPU Socket  1 的本地内存中，当 Redis 实例要访问网络数据时，就需要 Socket 2 通过总线把内存访问命令发送到 Socket 1 上，进行远程访问，时间开销比较大。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4371"><span data-slate-object="text" data-key="4372"><span data-slate-leaf="true" data-offset-key="4372:0" data-first-offset="true"><span data-slate-string="true">我们曾经做过测试，和访问 CPU Socket 本地内存相比，跨 CPU Socket 的内存访问延迟增加了 18%，这自然会导致 Redis 处理请求的延迟增加。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4373"><span data-slate-object="text" data-key="4374"><span data-slate-leaf="true" data-offset-key="4374:0" data-first-offset="true"><span data-slate-string="true">所以，为了避免 Redis 跨 CPU Socket 访问网络数据，</span></span><span data-slate-leaf="true" data-offset-key="4374:1"><span data-slate-object="annotation" data-annotation-key="gkann_ce25d2a4" data-attr-id="13815" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我们最好把网络中断程序和 Redis 实例绑在同一个 CPU Socket 上，</span></span></span><span data-slate-leaf="true" data-offset-key="4374:2"><span data-slate-string="true">这样一来，Redis 实例就可以直接从本地内存读取网络数据了，如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="4375"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/41/79/41f02b2afb08ec54249680e8cac30179.jpg?wh=2874*1479"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4376"><span data-slate-object="text" data-key="4377"><span data-slate-leaf="true" data-offset-key="4377:0" data-first-offset="true"><span data-slate-string="true">不过，需要注意的是，</span></span></span><span data-slate-object="text" data-key="4378"><span data-slate-leaf="true" data-offset-key="4378:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_c908960d" data-attr-id="25148" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在 CPU 的 NUMA 架构下，对 CPU 核的编号规则，并不是先把一个 CPU Socket 中的所有逻辑核编完，再对下一个 CPU Socket 中的逻辑核编码，而是先给每个 CPU Socket 中每个物理核的第一个逻辑核依次编号，再给每个 CPU Socket 中的物理核的第二个逻辑核依次编号。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4379"><span data-slate-object="text" data-key="4380"><span data-slate-leaf="true" data-offset-key="4380:0" data-first-offset="true"><span data-slate-string="true">我给你举个例子。</span></span><span data-slate-leaf="true" data-offset-key="4380:1"><span data-slate-object="annotation" data-annotation-key="gkann_4636cb33" data-attr-id="19883" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">假设有 2 个 CPU Socket，每个 Socket 上有 6 个物理核，每个物理核又有 2 个逻辑核，总共 24 个逻辑核。我们可以执行 </span></span></span></span><span data-slate-object="text" data-key="4381"><span data-slate-leaf="true" data-offset-key="4381:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4636cb33" data-attr-id="19883" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">lscpu 命令</span></span></span></span></span><span data-slate-object="text" data-key="4382"><span data-slate-leaf="true" data-offset-key="4382:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4636cb33" data-attr-id="19883" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">，查看到这些核的编号：</span></span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="4383"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4384"><span data-slate-object="text" data-key="4385"><span data-slate-leaf="true" data-offset-key="4385:0" data-first-offset="true"><span data-slate-string="true">lscpu</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4386"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4387"><span data-slate-object="text" data-key="4388"><span data-slate-leaf="true" data-offset-key="4388:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_c93a77e4" data-attr-id="17449" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Architecture: x86_64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4389"><span data-slate-object="text" data-key="4390"><span data-slate-leaf="true" data-offset-key="4390:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4391"><span data-slate-object="text" data-key="4392"><span data-slate-leaf="true" data-offset-key="4392:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">NUMA node0 </span></span></span></span><span data-slate-object="text" data-key="4393"><span data-slate-leaf="true" data-offset-key="4393:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CPU</span></span></span></span></span><span data-slate-object="text" data-key="4394"><span data-slate-leaf="true" data-offset-key="4394:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s)</span></span></span></span></span><span data-slate-object="text" data-key="4395"><span data-slate-leaf="true" data-offset-key="4395:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">: </span></span></span></span><span data-slate-object="text" data-key="4396"><span data-slate-leaf="true" data-offset-key="4396:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></span><span data-slate-object="text" data-key="4397"><span data-slate-leaf="true" data-offset-key="4397:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">-</span></span></span></span><span data-slate-object="text" data-key="4398"><span data-slate-leaf="true" data-offset-key="4398:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span></span><span data-slate-object="text" data-key="4399"><span data-slate-leaf="true" data-offset-key="4399:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">,</span></span></span></span><span data-slate-object="text" data-key="4400"><span data-slate-leaf="true" data-offset-key="4400:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">12</span></span></span></span></span><span data-slate-object="text" data-key="4401"><span data-slate-leaf="true" data-offset-key="4401:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">-</span></span></span></span><span data-slate-object="text" data-key="4402"><span data-slate-leaf="true" data-offset-key="4402:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_4e8fb3da" data-attr-id="17450" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">17</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4403"><span data-slate-object="text" data-key="4404"><span data-slate-leaf="true" data-offset-key="4404:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">NUMA node1 </span></span></span></span><span data-slate-object="text" data-key="4405"><span data-slate-leaf="true" data-offset-key="4405:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CPU</span></span></span></span></span><span data-slate-object="text" data-key="4406"><span data-slate-leaf="true" data-offset-key="4406:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s)</span></span></span></span></span><span data-slate-object="text" data-key="4407"><span data-slate-leaf="true" data-offset-key="4407:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">: </span></span></span></span><span data-slate-object="text" data-key="4408"><span data-slate-leaf="true" data-offset-key="4408:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">6</span></span></span></span></span><span data-slate-object="text" data-key="4409"><span data-slate-leaf="true" data-offset-key="4409:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">-</span></span></span></span><span data-slate-object="text" data-key="4410"><span data-slate-leaf="true" data-offset-key="4410:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">11</span></span></span></span></span><span data-slate-object="text" data-key="4411"><span data-slate-leaf="true" data-offset-key="4411:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">,</span></span></span></span><span data-slate-object="text" data-key="4412"><span data-slate-leaf="true" data-offset-key="4412:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">18</span></span></span></span></span><span data-slate-object="text" data-key="4413"><span data-slate-leaf="true" data-offset-key="4413:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">-</span></span></span></span><span data-slate-object="text" data-key="4414"><span data-slate-leaf="true" data-offset-key="4414:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_69b64d45" data-attr-id="17451" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">23</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4415"><span data-slate-object="text" data-key="4416"><span data-slate-leaf="true" data-offset-key="4416:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4417"><span data-slate-object="text" data-key="4418"><span data-slate-leaf="true" data-offset-key="4418:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_89b95b0a" data-attr-id="17986" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">可以看到，NUMA node0 的 CPU 核编号是 0 到 5、12 到 17。其中，0 到 5 是 node0 上的 6 个物理核中的第一个逻辑核的编号，12 到 17 是相应物理核中的第二个逻辑核编号。NUMA node1 的 CPU 核编号规则和 node0 一样。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4419"><span data-slate-object="text" data-key="4420"><span data-slate-leaf="true" data-offset-key="4420:0" data-first-offset="true"><span data-slate-string="true">所以，在绑核时，我们一定要注意，不能想当然地认为第一个 Socket 上的 12 个逻辑核的编号就是 0 到 11。否则，网络中断程序和 Redis 实例就可能绑在了不同的 CPU Socket 上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4421"><span data-slate-object="text" data-key="4422"><span data-slate-leaf="true" data-offset-key="4422:0" data-first-offset="true"><span data-slate-string="true">比如说，如果我们把网络中断程序和 Redis 实例分别绑到编号为 1 和 7 的 CPU 核上，此时，它们仍然是在 2 个 CPU Socket 上，Redis 实例仍然需要跨 Socket 读取网络数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4423"><span data-slate-object="text" data-key="4424"><span data-slate-leaf="true" data-offset-key="4424:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">所以，你一定要注意 NUMA 架构下 CPU 核的编号方法，这样才不会绑错核。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4425"><span data-slate-object="text" data-key="4426"><span data-slate-leaf="true" data-offset-key="4426:0" data-first-offset="true"><span data-slate-string="true">我们先简单地总结下刚刚学习的内容。</span></span><span data-slate-leaf="true" data-offset-key="4426:1"><span data-slate-object="annotation" data-annotation-key="gkann_5aa20dfc" data-attr-id="27159" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在 CPU 多核的场景下，用 taskset 命令把 Redis 实例和一个核绑定，可以减少 Redis 实例在不同核上被来回调度执行的开销，避免较高的尾延迟；在多 CPU 的 NUMA 架构下，如果你对网络中断程序做了绑核操作，建议你同时把 Redis 实例和网络中断程序绑在同一个 CPU Socket 的不同核上，这样可以避免 Redis 跨 Socket 访问内存中的网络数据的时间开销。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4427"><span data-slate-object="text" data-key="4428"><span data-slate-leaf="true" data-offset-key="4428:0" data-first-offset="true"><span data-slate-string="true">不过，“硬币都是有两面的”，绑核也存在一定的风险。接下来，我们就来了解下它的潜在风险点和解决方案。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4429" id="sr-toc-4"><span data-slate-object="text" data-key="4430"><span data-slate-leaf="true" data-offset-key="4430:0" data-first-offset="true"><span data-slate-string="true">绑核的风险和解决方案</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4431"><span data-slate-object="text" data-key="4432"><span data-slate-leaf="true" data-offset-key="4432:0" data-first-offset="true"><span data-slate-string="true">Redis 除了主线程以外，还有用于 RDB 生成和 AOF 重写的子进程（可以回顾看下</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="4433"><span data-slate-object="text" data-key="4434"><span data-slate-leaf="true" data-offset-key="4434:0" data-first-offset="true"><span data-slate-string="true">第 4 讲</span></span></span></a><span data-slate-object="text" data-key="4435"><span data-slate-leaf="true" data-offset-key="4435:0" data-first-offset="true"><span data-slate-string="true">和</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="4436"><span data-slate-object="text" data-key="4437"><span data-slate-leaf="true" data-offset-key="4437:0" data-first-offset="true"><span data-slate-string="true">第 5 讲</span></span></span></a><span data-slate-object="text" data-key="4438"><span data-slate-leaf="true" data-offset-key="4438:0" data-first-offset="true"><span data-slate-string="true">）。此外，我们还在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="4439"><span data-slate-object="text" data-key="4440"><span data-slate-leaf="true" data-offset-key="4440:0" data-first-offset="true"><span data-slate-string="true">第 16 讲</span></span></span></a><span data-slate-object="text" data-key="4441"><span data-slate-leaf="true" data-offset-key="4441:0" data-first-offset="true"><span data-slate-string="true">学习了 Redis 的后台线程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4442"><span data-slate-object="text" data-key="4443"><span data-slate-leaf="true" data-offset-key="4443:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_fe836dfa" data-attr-id="10021" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">当我们把 Redis 实例绑到一个 CPU 逻辑核上时，就会导致子进程、后台线程和 Redis 主线程竞争 CPU 资源，一旦子进程或后台线程占用 CPU 时，主线程就会被阻塞，导致 Redis 请求延迟增加。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4444"><span data-slate-object="text" data-key="4445"><span data-slate-leaf="true" data-offset-key="4445:0" data-first-offset="true"><span data-slate-string="true">针对这种情况，我来给你介绍两种解决方案，</span></span><span data-slate-leaf="true" data-offset-key="4445:1"><span data-slate-object="annotation" data-annotation-key="gkann_10e55c58" data-attr-id="25149" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">分别是</span></span></span></span><span data-slate-object="text" data-key="4446"><span data-slate-leaf="true" data-offset-key="4446:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_10e55c58" data-attr-id="25149" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">一个 Redis 实例对应绑一个物理核和优化 Redis 源码。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4447"><span data-slate-object="text" data-key="4448"><span data-slate-leaf="true" data-offset-key="4448:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_7b323b06" data-attr-id="28448" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">方案一：一个 Redis 实例对应绑一个物理核</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4449"><span data-slate-object="text" data-key="4450"><span data-slate-leaf="true" data-offset-key="4450:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1b6dd5be" data-attr-id="42985" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在给 Redis 实例绑核时，我们不要把一个实例和一个逻辑核绑定，而要和一个物理核绑定，也就是说，把一个物理核的 2 个逻辑核都用上。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4451"><span data-slate-object="text" data-key="4452"><span data-slate-leaf="true" data-offset-key="4452:0" data-first-offset="true"><span data-slate-string="true">我们还是以刚才的 NUMA 架构为例，NUMA node0 的 CPU 核编号是 0 到 5、12 到 17。其中，编号 0 和 12、1 和 13、2 和 14 等都是表示一个物理核的 2 个逻辑核。所以，在绑核时，我们使用属于同一个物理核的 2 个逻辑核进行绑核操作。例如，我们执行下面的命令，就把 Redis 实例绑定到了逻辑核 0 和 12 上，而这两个核正好都属于物理核 1。</span></span></span></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="4453"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4454"><span data-slate-object="text" data-key="4455"><span data-slate-leaf="true" data-offset-key="4455:0" data-first-offset="true"><span data-slate-string="true">taskset -c 0,12 ./redis-server</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4456"><span data-slate-object="text" data-key="4457"><span data-slate-leaf="true" data-offset-key="4457:0" data-first-offset="true"><span data-slate-string="true">和只绑一个逻辑核相比，把 Redis 实例和物理核绑定，可以让主线程、子进程、后台线程共享使用 2 个逻辑核，可以在一定程度上缓解 CPU 资源竞争。但是，因为只用了 2 个逻辑核，它们相互之间的 CPU 竞争仍然还会存在。如果你还想进一步减少 CPU 竞争，我再给你介绍一种方案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4458"><span data-slate-object="text" data-key="4459"><span data-slate-leaf="true" data-offset-key="4459:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">方案二：优化 Redis 源码</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4460"><span data-slate-object="text" data-key="4461"><span data-slate-leaf="true" data-offset-key="4461:0" data-first-offset="true"><span data-slate-string="true">这个方案就是通过修改 Redis 源码，把子进程和后台线程绑到不同的 CPU 核上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4462"><span data-slate-object="text" data-key="4463"><span data-slate-leaf="true" data-offset-key="4463:0" data-first-offset="true"><span data-slate-string="true">如果你对 Redis 的源码不太熟悉，也没关系，因为这是通过编程实现绑核的一个通用做法。学会了这个方案，你可以在熟悉了源码之后把它用上，也可以应用在其他需要绑核的场景中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4464"><span data-slate-object="text" data-key="4465"><span data-slate-leaf="true" data-offset-key="4465:0" data-first-offset="true"><span data-slate-string="true">接下来，我先介绍一下通用的做法，然后，再具体说说可以把这个做法对应到 Redis 的哪部分源码中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4466"><span data-slate-object="text" data-key="4467"><span data-slate-leaf="true" data-offset-key="4467:0" data-first-offset="true"><span data-slate-string="true">通过编程实现绑核时，要用到操作系统提供的 1 个数据结构 cpu_set_t 和 3 个函数 CPU_ZERO、CPU_SET 和 sched_setaffinity，我先来解释下它们。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4468"><div data-slate-type="list-line" data-slate-object="block" data-key="4469"><span data-slate-object="text" data-key="4470"><span data-slate-leaf="true" data-offset-key="4470:0" data-first-offset="true"><span data-slate-string="true">cpu_set_t 数据结构：是一个位图，每一位用来表示服务器上的一个 CPU 逻辑核。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4471"><span data-slate-object="text" data-key="4472"><span data-slate-leaf="true" data-offset-key="4472:0" data-first-offset="true"><span data-slate-string="true">CPU_ZERO 函数：以 cpu_set_t 结构的位图为输入参数，把位图中所有的位设置为 0。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4473"><span data-slate-object="text" data-key="4474"><span data-slate-leaf="true" data-offset-key="4474:0" data-first-offset="true"><span data-slate-string="true">CPU_SET 函数：以 CPU 逻辑核编号和 cpu_set_t 位图为参数，把位图中和输入的逻辑核编号对应的位设置为 1。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4475"><span data-slate-object="text" data-key="4476"><span data-slate-leaf="true" data-offset-key="4476:0" data-first-offset="true"><span data-slate-string="true">sched_setaffinity 函数：以进程 / 线程 ID 号和 cpu_set_t 为参数，检查 cpu_set_t 中哪一位为 1，就把输入的 ID 号所代表的进程 / 线程绑在对应的逻辑核上。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4477"><span data-slate-object="text" data-key="4478"><span data-slate-leaf="true" data-offset-key="4478:0" data-first-offset="true"><span data-slate-string="true">那么，怎么在编程时把这三个函数结合起来实现绑核呢？很简单，我们分四步走就行。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4479"><div data-slate-type="list-line" data-slate-object="block" data-key="4480"><span data-slate-object="text" data-key="4481"><span data-slate-leaf="true" data-offset-key="4481:0" data-first-offset="true"><span data-slate-string="true">第一步：创建一个 cpu_set_t 结构的位图变量；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4482"><span data-slate-object="text" data-key="4483"><span data-slate-leaf="true" data-offset-key="4483:0" data-first-offset="true"><span data-slate-string="true">第二步：使用 CPU_ZERO 函数，把 cpu_set_t 结构的位图所有的位都设置为 0；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4484"><span data-slate-object="text" data-key="4485"><span data-slate-leaf="true" data-offset-key="4485:0" data-first-offset="true"><span data-slate-string="true">第三步：根据要绑定的逻辑核编号，使用 CPU_SET 函数，把 cpu_set_t 结构的位图相应位设置为 1；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4486"><span data-slate-object="text" data-key="4487"><span data-slate-leaf="true" data-offset-key="4487:0" data-first-offset="true"><span data-slate-string="true">第四步：使用 sched_setaffinity 函数，把程序绑定在 cpu_set_t 结构位图中为 1 的逻辑核上。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4488"><span data-slate-object="text" data-key="4489"><span data-slate-leaf="true" data-offset-key="4489:0" data-first-offset="true"><span data-slate-string="true">下面，我就具体介绍下，分别把后台线程、子进程绑到不同的核上的做法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4490"><span data-slate-object="text" data-key="4491"><span data-slate-leaf="true" data-offset-key="4491:0" data-first-offset="true"><span data-slate-string="true">先说后台线程。为了让你更好地理解编程实现绑核，你可以看下这段示例代码，它实现了为线程绑核的操作：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="4492"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4493"><span data-slate-object="text" data-key="4494"><span data-slate-leaf="true" data-offset-key="4494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 线程函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4495"><span data-slate-object="text" data-key="4496"><span data-slate-leaf="true" data-offset-key="4496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4497"><span data-slate-leaf="true" data-offset-key="4497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4498"><span data-slate-leaf="true" data-offset-key="4498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">worker</span></span></span></span></span><span data-slate-object="text" data-key="4499"><span data-slate-leaf="true" data-offset-key="4499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4500"><span data-slate-leaf="true" data-offset-key="4500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="4501"><span data-slate-leaf="true" data-offset-key="4501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> bind_cpu)</span></span></span></span></span><span data-slate-object="text" data-key="4502"><span data-slate-leaf="true" data-offset-key="4502:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4503"><span data-slate-object="text" data-key="4504"><span data-slate-leaf="true" data-offset-key="4504:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4505"><span data-slate-leaf="true" data-offset-key="4505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cpu_set_t</span></span></span></span><span data-slate-object="text" data-key="4506"><span data-slate-leaf="true" data-offset-key="4506:0" data-first-offset="true"><span data-slate-string="true"> cpuset;  </span></span></span><span data-slate-object="text" data-key="4507"><span data-slate-leaf="true" data-offset-key="4507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建位图变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4508"><span data-slate-object="text" data-key="4509"><span data-slate-leaf="true" data-offset-key="4509:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4510"><span data-slate-leaf="true" data-offset-key="4510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CPU_ZERO</span></span></span></span><span data-slate-object="text" data-key="4511"><span data-slate-leaf="true" data-offset-key="4511:0" data-first-offset="true"><span data-slate-string="true">(&amp;cpu_set); </span></span></span><span data-slate-object="text" data-key="4512"><span data-slate-leaf="true" data-offset-key="4512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 位图变量所有位设置 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4513"><span data-slate-object="text" data-key="4514"><span data-slate-leaf="true" data-offset-key="4514:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4515"><span data-slate-leaf="true" data-offset-key="4515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CPU_SET</span></span></span></span><span data-slate-object="text" data-key="4516"><span data-slate-leaf="true" data-offset-key="4516:0" data-first-offset="true"><span data-slate-string="true">(bind_cpu, &amp;cpuset); </span></span></span><span data-slate-object="text" data-key="4517"><span data-slate-leaf="true" data-offset-key="4517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据输入的 bind_cpu 编号，把位图对应为设置为 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4518"><span data-slate-object="text" data-key="4519"><span data-slate-leaf="true" data-offset-key="4519:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4520"><span data-slate-leaf="true" data-offset-key="4520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_setaffinity</span></span></span></span><span data-slate-object="text" data-key="4521"><span data-slate-leaf="true" data-offset-key="4521:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4522"><span data-slate-leaf="true" data-offset-key="4522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4523"><span data-slate-leaf="true" data-offset-key="4523:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4524"><span data-slate-leaf="true" data-offset-key="4524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="4525"><span data-slate-leaf="true" data-offset-key="4525:0" data-first-offset="true"><span data-slate-string="true">(cpuset), &amp;cpuset); </span></span></span><span data-slate-object="text" data-key="4526"><span data-slate-leaf="true" data-offset-key="4526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把程序绑定在 cpu_set_t 结构位图中为 1 的逻辑核</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4527"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4528"><span data-slate-object="text" data-key="4529"><span data-slate-leaf="true" data-offset-key="4529:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4530"><span data-slate-leaf="true" data-offset-key="4530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际线程函数工作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4531"><span data-slate-object="text" data-key="4532"><span data-slate-leaf="true" data-offset-key="4532:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4533"></div><div data-slate-type="code-line" data-slate-object="block" data-key="4534"><span data-slate-object="text" data-key="4535"><span data-slate-leaf="true" data-offset-key="4535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="4536"><span data-slate-leaf="true" data-offset-key="4536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4537"><span data-slate-leaf="true" data-offset-key="4537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="4538"><span data-slate-leaf="true" data-offset-key="4538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4539"><span data-slate-leaf="true" data-offset-key="4539:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4540"><span data-slate-object="text" data-key="4541"><span data-slate-leaf="true" data-offset-key="4541:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4542"><span data-slate-leaf="true" data-offset-key="4542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pthread_t</span></span></span></span><span data-slate-object="text" data-key="4543"><span data-slate-leaf="true" data-offset-key="4543:0" data-first-offset="true"><span data-slate-string="true"> pthread1</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4544"><span data-slate-object="text" data-key="4545"><span data-slate-leaf="true" data-offset-key="4545:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4546"><span data-slate-leaf="true" data-offset-key="4546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把创建的 pthread1 绑在编号为 3 的逻辑核上</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4547"><span data-slate-object="text" data-key="4548"><span data-slate-leaf="true" data-offset-key="4548:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4549"><span data-slate-leaf="true" data-offset-key="4549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pthread_create</span></span></span></span><span data-slate-object="text" data-key="4550"><span data-slate-leaf="true" data-offset-key="4550:0" data-first-offset="true"><span data-slate-string="true">(&amp;pthread1, </span></span></span><span data-slate-object="text" data-key="4551"><span data-slate-leaf="true" data-offset-key="4551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="4552"><span data-slate-leaf="true" data-offset-key="4552:0" data-first-offset="true"><span data-slate-string="true">, (</span></span></span><span data-slate-object="text" data-key="4553"><span data-slate-leaf="true" data-offset-key="4553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="4554"><span data-slate-leaf="true" data-offset-key="4554:0" data-first-offset="true"><span data-slate-string="true"> *)worker, </span></span></span><span data-slate-object="text" data-key="4555"><span data-slate-leaf="true" data-offset-key="4555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="4556"><span data-slate-leaf="true" data-offset-key="4556:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4557"><span data-slate-object="text" data-key="4558"><span data-slate-leaf="true" data-offset-key="4558:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4559"><span data-slate-object="text" data-key="4560"><span data-slate-leaf="true" data-offset-key="4560:0" data-first-offset="true"><span data-slate-string="true">对于 Redis 来说，它是在 bio.c 文件中的 bioProcessBackgroundJobs 函数中创建了后台线程。bioProcessBackgroundJobs 函数类似于刚刚的例子中的 worker 函数，在这个函数中实现绑核四步操作，就可以把后台线程绑到和主线程不同的核上了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4561"><span data-slate-object="text" data-key="4562"><span data-slate-leaf="true" data-offset-key="4562:0" data-first-offset="true"><span data-slate-string="true">和给线程绑核类似，当我们使用 fork 创建子进程时，也可以把刚刚说的四步操作实现在 fork 后的子进程代码中，示例代码如下：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="4563"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4564"><span data-slate-object="text" data-key="4565"><span data-slate-leaf="true" data-offset-key="4565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="4566"><span data-slate-leaf="true" data-offset-key="4566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4567"><span data-slate-leaf="true" data-offset-key="4567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="4568"><span data-slate-leaf="true" data-offset-key="4568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="4569"><span data-slate-leaf="true" data-offset-key="4569:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4570"><span data-slate-object="text" data-key="4571"><span data-slate-leaf="true" data-offset-key="4571:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="4572"><span data-slate-leaf="true" data-offset-key="4572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用 fork 创建一个子进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4573"><span data-slate-object="text" data-key="4574"><span data-slate-leaf="true" data-offset-key="4574:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="4575"><span data-slate-leaf="true" data-offset-key="4575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">pid_t</span></span></span></span><span data-slate-object="text" data-key="4576"><span data-slate-leaf="true" data-offset-key="4576:0" data-first-offset="true"><span data-slate-string="true"> p = fork();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4577"><span data-slate-object="text" data-key="4578"><span data-slate-leaf="true" data-offset-key="4578:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="4579"><span data-slate-leaf="true" data-offset-key="4579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4580"><span data-slate-leaf="true" data-offset-key="4580:0" data-first-offset="true"><span data-slate-string="true">(p &lt; </span></span></span><span data-slate-object="text" data-key="4581"><span data-slate-leaf="true" data-offset-key="4581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4582"><span data-slate-leaf="true" data-offset-key="4582:0" data-first-offset="true"><span data-slate-string="true">){</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4583"><span data-slate-object="text" data-key="4584"><span data-slate-leaf="true" data-offset-key="4584:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4585"><span data-slate-leaf="true" data-offset-key="4585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">printf</span></span></span></span><span data-slate-object="text" data-key="4586"><span data-slate-leaf="true" data-offset-key="4586:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4587"><span data-slate-leaf="true" data-offset-key="4587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fork error\n"</span></span></span></span><span data-slate-object="text" data-key="4588"><span data-slate-leaf="true" data-offset-key="4588:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4589"><span data-slate-object="text" data-key="4590"><span data-slate-leaf="true" data-offset-key="4590:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4591"><span data-slate-object="text" data-key="4592"><span data-slate-leaf="true" data-offset-key="4592:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="4593"><span data-slate-leaf="true" data-offset-key="4593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 子进程代码部分</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4594"><span data-slate-object="text" data-key="4595"><span data-slate-leaf="true" data-offset-key="4595:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="4596"><span data-slate-leaf="true" data-offset-key="4596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="4597"><span data-slate-leaf="true" data-offset-key="4597:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4598"><span data-slate-leaf="true" data-offset-key="4598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="4599"><span data-slate-leaf="true" data-offset-key="4599:0" data-first-offset="true"><span data-slate-string="true">(!p){</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4600"><span data-slate-object="text" data-key="4601"><span data-slate-leaf="true" data-offset-key="4601:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4602"><span data-slate-leaf="true" data-offset-key="4602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">cpu_set_t</span></span></span></span><span data-slate-object="text" data-key="4603"><span data-slate-leaf="true" data-offset-key="4603:0" data-first-offset="true"><span data-slate-string="true"> cpuset;  </span></span></span><span data-slate-object="text" data-key="4604"><span data-slate-leaf="true" data-offset-key="4604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建位图变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4605"><span data-slate-object="text" data-key="4606"><span data-slate-leaf="true" data-offset-key="4606:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4607"><span data-slate-leaf="true" data-offset-key="4607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CPU_ZERO</span></span></span></span><span data-slate-object="text" data-key="4608"><span data-slate-leaf="true" data-offset-key="4608:0" data-first-offset="true"><span data-slate-string="true">(&amp;cpu_set); </span></span></span><span data-slate-object="text" data-key="4609"><span data-slate-leaf="true" data-offset-key="4609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 位图变量所有位设置 0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4610"><span data-slate-object="text" data-key="4611"><span data-slate-leaf="true" data-offset-key="4611:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4612"><span data-slate-leaf="true" data-offset-key="4612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">CPU_SET</span></span></span></span><span data-slate-object="text" data-key="4613"><span data-slate-leaf="true" data-offset-key="4613:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4614"><span data-slate-leaf="true" data-offset-key="4614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3</span></span></span></span><span data-slate-object="text" data-key="4615"><span data-slate-leaf="true" data-offset-key="4615:0" data-first-offset="true"><span data-slate-string="true">, &amp;cpuset); </span></span></span><span data-slate-object="text" data-key="4616"><span data-slate-leaf="true" data-offset-key="4616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把位图的第 3 位设置为 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4617"><span data-slate-object="text" data-key="4618"><span data-slate-leaf="true" data-offset-key="4618:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4619"><span data-slate-leaf="true" data-offset-key="4619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sched_setaffinity</span></span></span></span><span data-slate-object="text" data-key="4620"><span data-slate-leaf="true" data-offset-key="4620:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4621"><span data-slate-leaf="true" data-offset-key="4621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4622"><span data-slate-leaf="true" data-offset-key="4622:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="4623"><span data-slate-leaf="true" data-offset-key="4623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="4624"><span data-slate-leaf="true" data-offset-key="4624:0" data-first-offset="true"><span data-slate-string="true">(cpuset), &amp;cpuset);  </span></span></span><span data-slate-object="text" data-key="4625"><span data-slate-leaf="true" data-offset-key="4625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把程序绑定在 3 号逻辑核</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4626"><span data-slate-object="text" data-key="4627"><span data-slate-leaf="true" data-offset-key="4627:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4628"><span data-slate-leaf="true" data-offset-key="4628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际子进程工作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4629"><span data-slate-object="text" data-key="4630"><span data-slate-leaf="true" data-offset-key="4630:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="4631"><span data-slate-leaf="true" data-offset-key="4631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">exit</span></span></span></span><span data-slate-object="text" data-key="4632"><span data-slate-leaf="true" data-offset-key="4632:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="4633"><span data-slate-leaf="true" data-offset-key="4633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4634"><span data-slate-leaf="true" data-offset-key="4634:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4635"><span data-slate-object="text" data-key="4636"><span data-slate-leaf="true" data-offset-key="4636:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4637"><span data-slate-object="text" data-key="4638"><span data-slate-leaf="true" data-offset-key="4638:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4639"><span data-slate-object="text" data-key="4640"><span data-slate-leaf="true" data-offset-key="4640:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4641"><span data-slate-object="text" data-key="4642"><span data-slate-leaf="true" data-offset-key="4642:0" data-first-offset="true"><span data-slate-string="true">对于 Redis 来说，生成 RDB 和 AOF 日志重写的子进程分别是下面两个文件的函数中实现的。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4643"><div data-slate-type="list-line" data-slate-object="block" data-key="4644"><span data-slate-object="text" data-key="4645"><span data-slate-leaf="true" data-offset-key="4645:0" data-first-offset="true"><span data-slate-string="true">rdb.c 文件：rdbSaveBackground 函数；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4646"><span data-slate-object="text" data-key="4647"><span data-slate-leaf="true" data-offset-key="4647:0" data-first-offset="true"><span data-slate-string="true">aof.c 文件：rewriteAppendOnlyFileBackground 函数。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4648"><span data-slate-object="text" data-key="4649"><span data-slate-leaf="true" data-offset-key="4649:0" data-first-offset="true"><span data-slate-string="true">这两个函数中都调用了 fork 创建子进程，所以，我们可以在子进程代码部分加上绑核的四步操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4650"><span data-slate-object="text" data-key="4651"><span data-slate-leaf="true" data-offset-key="4651:0" data-first-offset="true"><span data-slate-string="true">使用源码优化方案，我们既可以实现 Redis 实例绑核，避免切换核带来的性能影响，还可以让子进程、后台线程和主线程不在同一个核上运行，避免了它们之间的 CPU 资源竞争。相比使用 taskset 绑核来说，这个方案可以进一步降低绑核的风险。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4652" id="sr-toc-5"><span data-slate-object="text" data-key="4653"><span data-slate-leaf="true" data-offset-key="4653:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4654"><span data-slate-object="text" data-key="4655"><span data-slate-leaf="true" data-offset-key="4655:0" data-first-offset="true"><span data-slate-string="true">这节课，我们学习了 CPU 架构对 Redis 性能的影响。首先，我们了解了目前主流的多核 CPU 架构，以及 NUMA 架构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4656"><span data-slate-object="text" data-key="4657"><span data-slate-leaf="true" data-offset-key="4657:0" data-first-offset="true"><span data-slate-string="true">在多核 CPU 架构下，Redis 如果在不同的核上运行，就需要频繁地进行上下文切换，这个过程会增加 Redis 的执行时间，客户端也会观察到较高的尾延迟了。所以，建议你在 Redis 运行时，把实例和某个核绑定，这样，就能重复利用核上的 L1、L2 缓存，可以降低响应延迟。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4658"><span data-slate-object="text" data-key="4659"><span data-slate-leaf="true" data-offset-key="4659:0" data-first-offset="true"><span data-slate-string="true">为了提升 Redis 的网络性能，我们有时还会把网络中断处理程序和 CPU 核绑定。在这种情况下，</span></span><span data-slate-leaf="true" data-offset-key="4659:1"><span data-slate-object="annotation" data-annotation-key="gkann_9e3d41eb" data-attr-id="17748" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_44df17fa" data-attr-id="17749" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果服务器使用的是 NUMA 架构，Redis 实例一旦被调度到和中断处理程序不在同一个 CPU Socket，就要跨 CPU Socket 访问网络数据，这就会降低 Redis 的性能。</span></span></span></span><span data-slate-leaf="true" data-offset-key="4659:2"><span data-slate-string="true">所以，我建议你把 Redis 实例和网络中断处理程序绑在同一个 CPU Socket 下的不同核上，这样可以提升 Redis 的运行性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4660"><span data-slate-object="text" data-key="4661"><span data-slate-leaf="true" data-offset-key="4661:0" data-first-offset="true"><span data-slate-string="true">虽然绑核可以帮助 Redis 降低请求执行时间，但是，除了主线程，Redis 还有用于 RDB 和 AOF 重写的子进程，以及 4.0 版本之后提供的用于惰性删除的后台线程。当 Redis 实例和一个逻辑核绑定后，这些子进程和后台线程会和主线程竞争 CPU 资源，也会对 Redis 性能造成影响。所以，我给了你两个建议：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4662"><div data-slate-type="list-line" data-slate-object="block" data-key="4663"><span data-slate-object="text" data-key="4664"><span data-slate-leaf="true" data-offset-key="4664:0" data-first-offset="true"><span data-slate-string="true">如果你不想修改 Redis 代码，可以把按一个 Redis 实例一个物理核方式进行绑定，这样，Redis 的主线程、子进程和后台线程可以共享使用一个物理核上的两个逻辑核。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="4665"><span data-slate-object="text" data-key="4666"><span data-slate-leaf="true" data-offset-key="4666:0" data-first-offset="true"><span data-slate-string="true">如果你很熟悉 Redis 的源码，就可以在源码中增加绑核操作，把子进程和后台线程绑到不同的核上，这样可以避免对主线程的 CPU 资源竞争。不过，如果你不熟悉 Redis 源码，也不用太担心，</span></span><span data-slate-leaf="true" data-offset-key="4666:1"><span data-slate-object="annotation" data-annotation-key="gkann_fa3b6d89" data-attr-id="33277" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Redis 6.0 出来后，可以支持 CPU 核绑定的配置操作了，</span></span></span><span data-slate-leaf="true" data-offset-key="4666:2"><span data-slate-string="true">我将在第 38 讲中向你介绍 Redis 6.0 的最新特性。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4667"><span data-slate-object="text" data-key="4668"><span data-slate-leaf="true" data-offset-key="4668:0" data-first-offset="true"><span data-slate-string="true">Redis 的低延迟是我们永恒的追求目标，而多核 CPU 和 NUMA 架构已经成为了目前服务器的主流配置，所以，希望你能掌握绑核优化方案，并把它应用到实践中。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4669" id="sr-toc-6"><span data-slate-object="text" data-key="4670"><span data-slate-leaf="true" data-offset-key="4670:0" data-first-offset="true"><span data-slate-string="true">每课一问</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4671"><span data-slate-object="text" data-key="4672"><span data-slate-leaf="true" data-offset-key="4672:0" data-first-offset="true"><span data-slate-string="true">按照惯例，我给你提个小问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4673"><span data-slate-object="text" data-key="4674"><span data-slate-leaf="true" data-offset-key="4674:0" data-first-offset="true"><span data-slate-string="true">在一台有 2 个 CPU Socket（每个 Socket 8 个物理核）的服务器上，我们部署了有 8 个实例的 Redis 切片集群（8 个实例都为主节点，没有主备关系），现在有两个方案：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="4675"><div data-slate-type="list-line" data-slate-object="block" data-key="4676"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="4677"><span data-slate-leaf="true" data-offset-key="4677:0" data-first-offset="true"><span data-slate-string="true">在同一个 CPU Socket 上运行 8 个实例，并和 8 个 CPU 核绑定；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="4678"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="4679"><span data-slate-leaf="true" data-offset-key="4679:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_75d0ff5e" data-attr-id="38223" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在 2 个 CPU Socket 上各运行 4 个实例，并和相应 Socket 上的核绑定。</span></span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4680"><span data-slate-object="text" data-key="4681"><span data-slate-leaf="true" data-offset-key="4681:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_dded1717" data-attr-id="17731" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果不考虑网络数据读取的影响，</span></span></span><span data-slate-leaf="true" data-offset-key="4681:1"><span data-slate-string="true">你会选择哪个方案呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4682"><span data-slate-object="text" data-key="4683"><span data-slate-leaf="true" data-offset-key="4683:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区写下你的思考和答案，如果你觉得有所收获，也欢迎你帮我把今天的内容分享给你的朋友。我们下节课见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>68</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-7">精选留言 (58)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/90/8a/288f9f94.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Kaito</span></div></div><div>这篇文章收获很大！对于 CPU 结构和如何绑核有了进一步了解。其实在 NUMA 架构下，不光对于 CPU 的绑核需要注意，对于内存的使用，也有很多注意点，下面回答课后问题，也会提到 NUMA 架构下内存方面的注意事项。

在一台有 2 个 CPU Socket（每个 Socket 8 个物理核）的服务器上，我们部署了有 8 个实例的 Redis 切片集群（8 个实例都为主节点，没有主备关系），采用哪种方案绑核最佳？

我更倾向于的方案是：在两个 CPU Socket 上各运行 4 个实例，并和相应 Socket 上的核绑定。这么做的原因主要从 L3 Cache 的命中率、内存利用率、避免使用到 Swap 这三个方面考虑：

1、由于 CPU Socket1 和 2 分别有自己的 L3 Cache，如果把所有实例都绑定在同一个 CPU Socket 上，相当于这些实例共用这一个 L3 Cache，另一个 CPU Socket 的 L3 Cache 浪费了。这些实例共用一个 L3 Cache，会导致 Cache 中的数据频繁被替换，访问命中率下降，之后只能从内存中读取数据，这会增加访问的延迟。而 8 个实例分别绑定 CPU Socket，可以充分使用 2 个 L3 Cache，提高 L3 Cache 的命中率，减少从内存读取数据的开销，从而降低延迟。

2、如果这些实例都绑定在一个 CPU Socket，由于采用 NUMA 架构的原因，所有实例会优先使用这一个节点的内存，当这个节点内存不足时，再经过总线去申请另一个 CPU Socket 下的内存，此时也会增加延迟。而 8 个实例分别使用 2 个 CPU Socket，各自在访问内存时都是就近访问，延迟最低。

3、如果这些实例都绑定在一个 CPU Socket，还有一个比较大的风险是：用到 Swap 的概率将会大大提高。如果这个 CPU Socket 对应的内存不够了，也可能不会去另一个节点申请内存（操作系统可以配置内存回收策略和 Swap 使用倾向：本节点回收内存 / 其他节点申请内存 / 内存数据换到 Swap 的倾向程度），而操作系统可能会把这个节点的一部分内存数据换到 Swap 上从而释放出内存给进程使用（如果没开启 Swap 可会导致直接 OOM）。因为 Redis 要求性能非常高，如果从 Swap 中读取数据，此时 Redis 的性能就会急剧下降，延迟变大。所以 8 个实例分别绑定 CPU Socket，既可以充分使用 2 个节点的内存，提高内存使用率，而且触发使用 Swap 的风险也会降低。

其实我们可以查一下，在 NUMA 架构下，也经常发生某一个节点内存不够，但其他节点内存充足的情况下，依旧使用到了 Swap，进而导致软件性能急剧下降的例子。所以在运维层面，我们也需要关注 NUMA 架构下的内存使用情况（多个内存节点使用可能不均衡），并合理配置系统参数（内存回收策略 / Swap 使用倾向），尽量去避免使用到 Swap。</div><div><div>2020-09-16</div><div><div><i></i><span>36</span></div><div><i></i><span>274</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/31/d2/56bf47c8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 薛定谔的猫</span></div></div><div>小白请教一下，网络中断处理程序是指什么呢？</div><div><p>作者回复：当网卡接收到数据后，会触发网卡中断，用来通知操作系统内核进行数据处理。因此，操作系统内核中用来处理网卡中断事件，把数据从内核的缓冲区拷贝到应用程序缓冲区的程序就是指网卡中断处理程序。</p></div><div><div>2020-11-25</div><div><div><i></i><span>6</span></div><div><i></i><span>49</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_9b08a5</span></div></div><div>1. 作者讲了什么？
	在多核 CPU 架构和 NUMA 架构下，如何对 redis 进行优化配置
2. 作者是怎么把这件事将明白的？
	1，讲解了主流的 CPU 架构，主要有多核 CPU 架构和 NUMA 架构两个架构
		多核 CPU 架构： 多个物理核，各物理核使用私有的 1、2 级缓存，共享 3 级缓存。物理核可包含 2 个超线程，称为逻辑核
		NUMA 架构： 一个服务器上多个 cpu，称为 CPU Socket，每个 cpu socker 存在多个物理核。每个 socket 通过总线连接，并且有用私有的内存空间
3. 为了讲明白，作者讲了哪些要点，哪些亮点？
	1、亮点：将主流的 CPU 架构进行剖析，使人更好理解 cpu 的原理，有助于后续 redis 性能的优化
	2、要点：cpu 架构：一个 cpu 一般拥有多个物理核，每个物理核都拥有私有的一级缓存，二级缓存。三级缓存是各物理核共享的缓存空间。而物理核又可以分为多个超线程，称为逻辑核，同一个物理核的逻辑核会共享使用 L1、L2 缓存。
	3、要点：一级缓存和二级缓存访问延迟不超过 10 纳秒，但空间很小，只是 KB 单位。而应用程序访问内存延迟是百纳秒级别，基本上是一二级缓存的 10 倍
	4、要点：不同的物理核还会共享一个共同的三级缓存，三级缓存空间比较多，为几到几十 MB，当 L1、L2 缓存中没有数据缓存时，可以访问 L3，尽可能避免访问内存。
	5、要点：多核 CPU 运行 redis 实例，会导致 context switch，导致增加延迟，可以通过 taskset 命令把 redis 进程绑定到某个 cup 物理核上。
	6、要点：NUMA 架构运行 redis 实例，如果网络中断程序和 redis 实例运行在不同的 socket 上，就需要跨 CPU Socket 访问内存，这个过程会花费较多时间。
	7、要点：绑核的风险和解决方案：
			一个 Redis 实例对应绑一个物理核 ： 将 redis 服务绑定到一个物理核上，而不是一个逻辑核上，如 taskset -c 0,12 ./redis-server
			优化 Redis 源码。
4. 对于作者所讲的，我有哪些发散性思考？
给自己提了几个问题：
	1，在多核 CPU 架构和 NUMA 架构，那个对于 redis 来说性能比较好
	2，如何设置网络中断处理和 redis 绑定设置在同个 socket 上呢？

5. 将来在哪些场景里，我能够使用它？

6. 留言区收获
	如果 redis 实例中内存不足以使用时，会用到 swap 那会怎么样？（答案来自 @kaito 大佬）
		因为 Redis 要求性能非常高，如果从 Swap 中读取数据，此时 Redis 的性能就会急剧下降，延迟变大。</div><div><div>2020-12-30</div><div><div><i></i><span></span></div><div><i></i><span>25</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/cd/de/0334fd13.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 许峰</span></div></div><div>阿里云 ecs 主机都是 vcpus, 这玩意算物理核心吗？
比如一个 4vcpu, lscpu 可以看到
NUMA node0 CPU (s):     0-3
这么绑？</div><div><p>作者回复: ECS 主机提供的 vCPU 是指虚拟核，一般对应一个物理核心上的一个超线程，这是因为底层服务器一般会开启超线程。通常，一个物理核心会对应 2 个超线程，每个超线程对应一个 vCPU。多个 vCPU 一般是在同一个 NUMA 节点上。

如果希望减少 CPU 超线程对性能的影响，可以通过阿里云 SDK 的选项关闭超线程。
</p></div><div><div>2020-11-30</div><div><div><i></i></div><div><i></i><span>23</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/43/79/18073134.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>test</span></div></div><div>课后问题：我会选择方案二。首先一个实例不止有一个线程需要运行，所以方案一肯定会有 CPU 竞争问题；其次切片集群的通信不是通过内存，而是通过网络 IO。</div><div><div>2020-09-16</div><div><div><i></i><span>2</span></div><div><i></i><span>14</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/71/3d/da8dc880.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 游弋云端</span></div></div><div>有两套房子，就不用挤着睡吧，优选方案二。老师实验用的 X86 的 CPU 吧，对于 ARM 架构来讲，存在着跨 DIE 和跨 P 的说法，跨 P 的访问时延会更高，且多个 P 之间的访问存在着 NUMA distances 的说法，不同的布局导致的跨 P 访问时延也不相同。</div><div><div>2020-09-16</div><div><div><i></i><span></span></div><div><i></i><span>11</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/91/c4/bcdcda65.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 明月几时</span></div></div><div>很多人都认为 Redis 和 CPU 的关系很简单，就是 Redis 的线程在 CPU 上运行，CPU 快，Redis 处理请求的速度也很快。
这种认知其实是片面的。CPU 的多核架构以及多 CPU 架构，也会影响到 Redis 的性能。如果不了解 CPU 对 Redis 的影响，在对 Redis 的性能进行调优时，就可能会遗漏一些调优方法，不能把 Redis 的性能发挥到极限。</div><div><p>作者回复: CPU 有多核，即使单核上也会有超线程技术。除了多核，多处理器会形成 NUMA 架构，这些都会对系统性能产生影响。

所以，计算机体系结构的知识点对系统优化还是很有帮助的：)
</p></div><div><div>2020-11-12</div><div><div><i></i></div><div><i></i><span>10</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/5c/8f/551b5624.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 小可</span></div></div><div>这篇文章真是太好了！对 cpu 有了更多的认识，公司服务 lscpu 挨个看了一遍，不懂的地方也去查了资料，自己也画了 NUMA 架构下多个 cpu socket 示意图，给每个逻辑 cpu 编号，对照图看怎么绑定网络中断和 redis 实例到同一个 cpu socket，怎么绑定一个 redis 实例到同一个物理核，非常清晰！还有 cpu 的架构设计思路也可以应用到我们实际系统架构上，不得不赞叹这些神级设计，也感谢老师心细深入的讲解，真的发现宝藏了，O (∩_∩) O 哈哈～</div><div><div>2021-02-04</div><div><div><i></i><span>3</span></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/41/5e/9d2953a3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>zhou</span></div></div><div>在 NUMA 架构下，比如有两个 CPU Socket：CPU Socket 1 和 CPU Socket 2，每个 CPU Socket 都有自己的内存，CPU Socket 1 有自己的内存 Mem1，CPU Socket 2 有自己的内存 Mem2。

Redis 实例在 CPU Socket 1 上执行，网络中断处理程序在 CPU Socket 2 上执行，所以 Redis 实例的数据在内存 Mem1 上，网络中断处理程序的数据在 Mem2 上。

因此 Redis 实例读取网络中断处理程序的内存数据（Mem2）时，是需要远端访问的，比直接访问自己的内存数据（Mem1）要慢。
</div><div><div>2020-09-16</div><div><div><i></i><span></span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/20/e9/32/b89fcc77.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 元末</span></div></div><div>这篇文章很顶</div><div><div>2021-07-13</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/61/23/30d134cf.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Young</span></div></div><div>老师您好，有个疑问： 即使内核绑定，但是当 cpu 时间片用尽，context switch 依然会发生对吧？ 之后，cache 里的数据会被刷掉， 所谓绑定的优势如何保证呢？ 谢谢！</div><div><div>2021-05-06</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/15/ca/4b/c1ace3aa.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 蚝不鱿鱼</span></div></div><div>结合隔壁我浩哥的计算机组成原理课程食用本节内容是真的香，感谢钧哥。</div><div><div>2021-01-13</div><div><div><i></i><span>1</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/77/2a/244d98aa.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>cp★钊</span></div></div><div>挺有收获，以前学习比较少关注系统 cpu 结构这块。这次顺带也了解 cpu 亲和度、NUMA 结构相关的知识点，希望老师也可以在文章中推荐一些相关知识点的学习链接之类的。</div><div><div>2020-11-16</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/3e/3a/2267d2a3.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>hoppo</span></div></div><div>这篇文章确实收获很大，从 CPU 核心说到 NUMA 架构、我原来其实就是抱着 ”Redis 的线程在 CPU 上运行，CPU 越快，Redis 处理请求的速度也越快” 相法的。现在想来真是太肤浅了...orz（失意体前屈）

不过一步一步跟着老师的思路来，还是很容易理解的，读到远端内存访问影响性能的时候，就会想是不是可以分到一个核上；看完了绑核的优点介绍又联系到风险和解决方式，一气呵成，给老师点个赞～</div><div><div>2020-11-15</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/b6/75/32c19395.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 土豆白菜</span></div></div><div>老师，我也想问下比如 azure redis 能否做这些优化</div><div><div>2020-09-16</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/8f/cf/890f82d6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 那时刻</span></div></div><div>请问老师，您文中提到我们仔细检测了 Redis 实例运行时的服务器 CPU 的状态指标值，这才发现，CPU 的 context switch 次数比较多。再遇到这样的问题的时候，排查的点有哪些呢？</div><div><div>2020-09-16</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2e/3c/08/02d27b63.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 我爱小童。</span></div></div><div>网络中断和 cpu 怎么绑定啊</div><div><div>2022-08-29</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/23/4c/89/82a3ee04.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>going</span></div></div><div>同一个 socket 运行八个实例。
</div><div><div>2022-08-05</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/17/2e/6d/00a1c1b1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Nerd</span></div></div><div>才知道一台服务器可以有多个 CPU 的配置，学习了</div><div><div>2022-05-06</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1b/68/ec/eb0ebbb6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>日月星辰</span></div></div><div>taskset 是操作系统的命令还是 Redis 的命令，感觉应该是操作系统的命令，但是不知道对不对。</div><div><div>2022-02-16</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1g"><outline class="toc-level-h1" data-reactid=".1g.0" style="width: 175px;"><active data-reactid=".1g.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1g.0.1"><span data-reactid=".1g.0.1.0">17 | 为什么 CPU 结构也会影响 Redis 的性能？</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.1" style="width: 165px;"><active data-reactid=".1g.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1g.1.1"><span data-reactid=".1g.1.1.0">主流的 CPU 架构</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.2" style="width: 165px;"><active data-reactid=".1g.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1g.2.1"><span data-reactid=".1g.2.1.0">CPU 多核对 Redis 性能的影响</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.3" style="width: 165px;"><active data-reactid=".1g.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1g.3.1"><span data-reactid=".1g.3.1.0">CPU 的 NUMA 架构对 Redis 性能的影响</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.4" style="width: 165px;"><active data-reactid=".1g.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1g.4.1"><span data-reactid=".1g.4.1.0">绑核的风险和解决方案</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.5" style="width: 165px;"><active data-reactid=".1g.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1g.5.1"><span data-reactid=".1g.5.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.6" style="width: 165px;"><active data-reactid=".1g.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1g.6.1"><span data-reactid=".1g.6.1.0">每课一问</span></a></outline><outline class="toc-level-h2" data-reactid=".1g.7" style="width: 165px;"><active data-reactid=".1g.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1g.7.1"><span data-reactid=".1g.7.1.0">精选留言 (58)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/286082" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>