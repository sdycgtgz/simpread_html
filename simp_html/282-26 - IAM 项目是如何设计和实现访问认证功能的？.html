
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 26 | IAM 项目是如何设计和实现访问认证功能的？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>26 | IAM 项目是如何设计和实现访问认证功能的？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这一讲我们来了解目前业界有哪些优秀的开源日志包，以及手把手教你从 0 编写一个日志包</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 26 | IAM 项目是如何设计和实现访问认证功能的？</h1><div><span>孔令飞</span> <span> 2021-07-24</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/ab/dd/ab565a3ec2beecc54c282a52b721eedd.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：孔令飞</span><span>大小：19.63M</span><span> 时长：21:29</span></div></div><audio title="26 | IAM项目是如何设计和实现访问认证功能的？" src="https://res001.geekbang.org/media/audio/09/f9/095f81d524a2ed3541177750768146f9/ld/ld.m3u8" __idm_id__="319494"></audio></div><div><div><div><div data-slate-editor="true" data-key="7344" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="7345"><span data-slate-object="text" data-key="7346"><span data-slate-leaf="true" data-offset-key="7346:0" data-first-offset="true"><span data-slate-string="true">你好，我是孔令飞。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7347"><span data-slate-object="text" data-key="7348"><span data-slate-leaf="true" data-offset-key="7348:0" data-first-offset="true"><span data-slate-string="true">上一讲，我们学习了应用认证常用的四种方式：Basic、Digest、OAuth、Bearer。这一讲，我们再来看下 IAM 项目是如何设计和实现认证功能的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7349"><span data-slate-object="text" data-key="7350"><span data-slate-leaf="true" data-offset-key="7350:0" data-first-offset="true"><span data-slate-string="true">IAM 项目用到了 Basic 认证和 Bearer 认证。其中，Basic 认证用在前端登陆的场景，Bearer 认证用在调用后端 API 服务的场景下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7351"><span data-slate-object="text" data-key="7352"><span data-slate-leaf="true" data-offset-key="7352:0" data-first-offset="true"><span data-slate-string="true">接下来，我们先来看下 IAM 项目认证功能的整体设计思路。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7353" id="sr-toc-1"><span data-slate-object="text" data-key="7354"><span data-slate-leaf="true" data-offset-key="7354:0" data-first-offset="true"><span data-slate-string="true">如何设计 IAM 项目的认证功能？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7355"><span data-slate-object="text" data-key="7356"><span data-slate-leaf="true" data-offset-key="7356:0" data-first-offset="true"><span data-slate-string="true">在认证功能开发之前，我们要根据需求，认真考虑下如何设计认证功能，并在设计阶段通过技术评审。那么我们先来看下，如何设计 IAM 项目的认证功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7357"><span data-slate-object="text" data-key="7358"><span data-slate-leaf="true" data-offset-key="7358:0" data-first-offset="true"><span data-slate-string="true">首先，我们要</span></span></span><span data-slate-object="text" data-key="7359"><span data-slate-leaf="true" data-offset-key="7359:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">梳理清楚认证功能的使用场景和需求</span></span></span></span><span data-slate-object="text" data-key="7360"><span data-slate-leaf="true" data-offset-key="7360:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7361"><div data-slate-type="list-line" data-slate-object="block" data-key="7362"><span data-slate-object="text" data-key="7363"><span data-slate-leaf="true" data-offset-key="7363:0" data-first-offset="true"><span data-slate-string="true">IAM 项目的 iam-apiserver 服务，提供了 IAM 系统的管理流功能接口，它的客户端可以是前端（这里也叫控制台），也可以是 App 端。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7364"><span data-slate-object="text" data-key="7365"><span data-slate-leaf="true" data-offset-key="7365:0" data-first-offset="true"><span data-slate-string="true">为了方便用户在 Linux 系统下调用，IAM 项目还提供了 iamctl 命令行工具。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7366"><span data-slate-object="text" data-key="7367"><span data-slate-leaf="true" data-offset-key="7367:0" data-first-offset="true"><span data-slate-string="true">为了支持在第三方代码中调用 iam-apiserver 提供的 API 接口，还支持了 API 调用。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7368"><span data-slate-object="text" data-key="7369"><span data-slate-leaf="true" data-offset-key="7369:0" data-first-offset="true"><span data-slate-string="true">为了提高用户在代码中调用 API 接口的效率，IAM 项目提供了 Go SDK。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7370"><span data-slate-object="text" data-key="7371"><span data-slate-leaf="true" data-offset-key="7371:0" data-first-offset="true"><span data-slate-string="true">可以看到，iam-apiserver 有很多客户端，每种客户端适用的认证方式是有区别的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7372"><span data-slate-object="text" data-key="7373"><span data-slate-leaf="true" data-offset-key="7373:0" data-first-offset="true"><span data-slate-string="true">控制台、App 端需要登录系统，所以需要使用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7374"><span data-slate-object="text" data-key="7375"><span data-slate-leaf="true" data-offset-key="7375:0" data-first-offset="true"><span data-slate-string="true">用户名：密码</span></span></span></span><span data-slate-object="text" data-key="7376"><span data-slate-leaf="true" data-offset-key="7376:0" data-first-offset="true"><span data-slate-string="true">这种认证方式，也即 Basic 认证。iamctl、API 调用、Go SDK 因为可以不用登录系统，所以可以采用更安全的认证方式：Bearer 认证。同时，Basic 认证作为 iam-apiserver 已经集成的认证方式，仍然可以供 iamctl、API 调用、Go SDK 使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7377"><span data-slate-object="text" data-key="7378"><span data-slate-leaf="true" data-offset-key="7378:0" data-first-offset="true"><span data-slate-string="true">这里有个地方需要注意：如果 iam-apiserver 采用 Bearer Token 的认证方式，目前最受欢迎的 Token 格式是 JWT Token。而 JWT Token 需要密钥（后面统一用 secretKey 来指代），因此需要在 iam-apiserver 服务中为每个用户维护一个密钥，这样会增加开发和维护成本。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7379"><span data-slate-object="text" data-key="7380"><span data-slate-leaf="true" data-offset-key="7380:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5b68754a" data-attr-id="34683" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">业界有一个更好的实现方式：将 iam-apiserver 提供的 API 接口注册到 API 网关中，通过 API 网关中的 Token 认证功能，来实现对 iam-apiserver API 接口的认证。</span></span></span><span data-slate-leaf="true" data-offset-key="7380:1"><span data-slate-string="true">有很多 API 网关可供选择，例如腾讯云 API 网关、Tyk、Kong 等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7381"><span data-slate-object="text" data-key="7382"><span data-slate-leaf="true" data-offset-key="7382:0" data-first-offset="true"><span data-slate-string="true">这里需要你注意：通过 iam-apiserver 创建的密钥对是提供给 iam-authz-server 使用的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7383"><span data-slate-object="text" data-key="7384"><span data-slate-leaf="true" data-offset-key="7384:0" data-first-offset="true"><span data-slate-string="true">另外，我们还需要调用 iam-authz-server 提供的 RESTful API 接口：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7385"><span data-slate-object="text" data-key="7386"><span data-slate-leaf="true" data-offset-key="7386:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="7387"><span data-slate-leaf="true" data-offset-key="7387:0" data-first-offset="true"><span data-slate-string="true">，来进行资源授权。API 调用比较适合采用的认证方式是 Bearer 认证。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7388"><span data-slate-object="text" data-key="7389"><span data-slate-leaf="true" data-offset-key="7389:0" data-first-offset="true"><span data-slate-string="true">当然，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7390"><span data-slate-object="text" data-key="7391"><span data-slate-leaf="true" data-offset-key="7391:0" data-first-offset="true"><span data-slate-string="true">/v1/authz</span></span></span></span><span data-slate-object="text" data-key="7392"><span data-slate-leaf="true" data-offset-key="7392:0" data-first-offset="true"><span data-slate-string="true"> 也可以直接注册到 API 网关中。在实际的 Go 项目开发中，也是我推荐的一种方式。但在这里，为了展示实现 Bearer 认证的过程，iam-authz-server 自己实现了 Bearer 认证。讲到 iam-authz-server Bearer 认证实现的时候，我会详细介绍这一点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7393"><span data-slate-object="text" data-key="7394"><span data-slate-leaf="true" data-offset-key="7394:0" data-first-offset="true"><span data-slate-string="true">Basic 认证需要用户名和密码，Bearer 认证则需要密钥，所以 iam-apiserver 需要将用户名 / 密码、密钥等信息保存在后端的 MySQL 中，持久存储起来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7395"><span data-slate-object="text" data-key="7396"><span data-slate-leaf="true" data-offset-key="7396:0" data-first-offset="true"><span data-slate-string="true">在进行认证的时候，需要获取密码或密钥进行反加密，这就需要查询密码或密钥。查询密码或密钥有两种方式。一种是在请求到达时查询数据库。因为数据库的查询操作延时高，会导致 API 接口延时较高，所以不太适合用在数据流组件中。另外一种是将密码或密钥缓存在内存中，这样请求到来时，就可以直接从内存中查询，从而提升查询速度，提高接口性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7397"><span data-slate-object="text" data-key="7398"><span data-slate-leaf="true" data-offset-key="7398:0" data-first-offset="true"><span data-slate-string="true">但是，将密码或密钥缓存在内存中时，就要考虑内存和数据库的数据一致性，这会增加代码实现的复杂度。因为管控流组件对性能延时要求不那么敏感，而数据流组件则一定要实现非常高的接口性能，所以 iam-apiserver 在请求到来时查询数据库，而 iam-authz-server 则将密钥信息缓存在内存中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7399"><span data-slate-object="text" data-key="7400"><span data-slate-leaf="true" data-offset-key="7400:0" data-first-offset="true"><span data-slate-string="true">那在这里，可以总结出一张 IAM 项目的认证设计图：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="7401"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/7e/b6/7eed8e2364d358a8483c671d972fd2b6.jpg?wh=2248x1094"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7402"><span data-slate-object="text" data-key="7403"><span data-slate-leaf="true" data-offset-key="7403:0" data-first-offset="true"><span data-slate-string="true">另外，为了将控制流和数据流区分开来，密钥的 CURD 操作也放在了 iam-apiserver 中，但是 iam-authz-server 需要用到这些密钥信息。为了解决这个问题，目前的做法是：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7404"><div data-slate-type="list-line" data-slate-object="block" data-key="7405"><span data-slate-object="text" data-key="7406"><span data-slate-leaf="true" data-offset-key="7406:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 通过 gRPC API 请求 iam-apiserver，获取所有的密钥信息；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7407"><span data-slate-object="text" data-key="7408"><span data-slate-leaf="true" data-offset-key="7408:0" data-first-offset="true"><span data-slate-string="true">当 iam-apiserver 有密钥更新时，会 Pub 一条消息到 Redis Channel 中。因为 iam-authz-server 订阅了同一个 Redis Channel，iam-authz-searver 监听到 channel 有新消息时，会获取、解析消息，并更新它缓存的密钥信息。这样，我们就能确保 iam-authz-server 内存中缓存的密钥和 iam-apiserver 中的密钥保持一致。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7409"><span data-slate-object="text" data-key="7410"><span data-slate-leaf="true" data-offset-key="7410:0" data-first-offset="true"><span data-slate-string="true">学到这里，你可能会问：将所有密钥都缓存在 iam-authz-server 中，那岂不是要占用很大的内存？别担心，这个问题我也想过，并且替你计算好了：8G 的内存大概能保存约 8 千万个密钥信息，完全够用。后期不够用的话，可以加大内存。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7411"><span data-slate-object="text" data-key="7412"><span data-slate-leaf="true" data-offset-key="7412:0" data-first-offset="true"><span data-slate-string="true">不过这里还是有个小缺陷：如果 Redis down 掉，或者出现网络抖动，可能会造成 iam-apiserver 中和 iam-authz-server 内存中保存的密钥数据不一致，但这不妨碍我们学习认证功能的设计和实现。至于如何保证缓存系统的数据一致性，我会在新一期的特别放送里专门介绍下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7413"><span data-slate-object="text" data-key="7414"><span data-slate-leaf="true" data-offset-key="7414:0" data-first-offset="true"><span data-slate-string="true">最后注意一点：Basic 认证请求和 Bearer 认证请求都可能被截获并重放。所以，为了确保 Basic 认证和 Bearer 认证的安全性，</span></span></span><span data-slate-object="text" data-key="7415"><span data-slate-leaf="true" data-offset-key="7415:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">和服务端通信时都需要配合使用 HTTPS 协议</span></span></span></span><span data-slate-object="text" data-key="7416"><span data-slate-leaf="true" data-offset-key="7416:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7417" id="sr-toc-2"><span data-slate-object="text" data-key="7418"><span data-slate-leaf="true" data-offset-key="7418:0" data-first-offset="true"><span data-slate-string="true">IAM 项目是如何实现 Basic 认证的？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7419"><span data-slate-object="text" data-key="7420"><span data-slate-leaf="true" data-offset-key="7420:0" data-first-offset="true"><span data-slate-string="true">我们已经知道，IAM 项目中主要用了 Basic 和 Bearer 这两种认证方式。我们要支持 Basic 认证和 Bearer 认证，并根据需要选择不同的认证方式，这很容易让我们想到使用设计模式中的策略模式来实现。所以，在 IAM 项目中，我将每一种认证方式都视作一个策略，通过选择不同的策略，来使用不同的认证方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7421"><span data-slate-object="text" data-key="7422"><span data-slate-leaf="true" data-offset-key="7422:0" data-first-offset="true"><span data-slate-string="true">IAM 项目实现了如下策略：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7423"><div data-slate-type="list-line" data-slate-object="block" data-key="7424"><a data-slate-type="link" data-slate-object="inline" data-key="7425"><span data-slate-object="text" data-key="7426"><span data-slate-leaf="true" data-offset-key="7426:0" data-first-offset="true"><span data-slate-string="true">auto 策略</span></span></span></a><span data-slate-object="text" data-key="7427"><span data-slate-leaf="true" data-offset-key="7427:0" data-first-offset="true"><span data-slate-string="true">：该策略会根据 HTTP 头</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7428"><span data-slate-object="text" data-key="7429"><span data-slate-leaf="true" data-offset-key="7429:0" data-first-offset="true"><span data-slate-string="true"> Authorization: Basic XX.YY.ZZ</span></span></span></span><span data-slate-object="text" data-key="7430"><span data-slate-leaf="true" data-offset-key="7430:0" data-first-offset="true"><span data-slate-string="true"> 和</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7431"><span data-slate-object="text" data-key="7432"><span data-slate-leaf="true" data-offset-key="7432:0" data-first-offset="true"><span data-slate-string="true"> Authorization: Bearer XX.YY.ZZ</span></span></span></span><span data-slate-object="text" data-key="7433"><span data-slate-leaf="true" data-offset-key="7433:0" data-first-offset="true"><span data-slate-string="true"> 自动选择使用 Basic 认证还是 Bearer 认证。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7434"><a data-slate-type="link" data-slate-object="inline" data-key="7435"><span data-slate-object="text" data-key="7436"><span data-slate-leaf="true" data-offset-key="7436:0" data-first-offset="true"><span data-slate-string="true">basic 策略</span></span></span></a><span data-slate-object="text" data-key="7437"><span data-slate-leaf="true" data-offset-key="7437:0" data-first-offset="true"><span data-slate-string="true">：该策略实现了 Basic 认证。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7438"><a data-slate-type="link" data-slate-object="inline" data-key="7439"><span data-slate-object="text" data-key="7440"><span data-slate-leaf="true" data-offset-key="7440:0" data-first-offset="true"><span data-slate-string="true">jwt 策略</span></span></span></a><span data-slate-object="text" data-key="7441"><span data-slate-leaf="true" data-offset-key="7441:0" data-first-offset="true"><span data-slate-string="true">：该策略实现了 Bearer 认证，JWT 是 Bearer 认证的具体实现。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7442"><a data-slate-type="link" data-slate-object="inline" data-key="7443"><span data-slate-object="text" data-key="7444"><span data-slate-leaf="true" data-offset-key="7444:0" data-first-offset="true"><span data-slate-string="true">cache 策略</span></span></span></a><span data-slate-object="text" data-key="7445"><span data-slate-leaf="true" data-offset-key="7445:0" data-first-offset="true"><span data-slate-string="true">：该策略其实是一个 Bearer 认证的实现，Token 采用了 JWT 格式，因为 Token 中的密钥 ID 是从内存中获取的，所以叫 Cache 认证。这一点后面会详细介绍。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7446"><span data-slate-object="text" data-key="7447"><span data-slate-leaf="true" data-offset-key="7447:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 通过创建需要的认证策略，并加载到需要认证的 API 路由上，来实现 API 认证。具体代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7448"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7449"><span data-slate-object="text" data-key="7450"><span data-slate-leaf="true" data-offset-key="7450:0" data-first-offset="true"><span data-slate-string="true">jwtStrategy, _ := newJWTAuth().(auth.JWTStrategy)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7451"><span data-slate-object="text" data-key="7452"><span data-slate-leaf="true" data-offset-key="7452:0" data-first-offset="true"><span data-slate-string="true">g.POST(</span></span></span><span data-slate-object="text" data-key="7453"><span data-slate-leaf="true" data-offset-key="7453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/login"</span></span></span></span><span data-slate-object="text" data-key="7454"><span data-slate-leaf="true" data-offset-key="7454:0" data-first-offset="true"><span data-slate-string="true">, jwtStrategy.LoginHandler)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7455"><span data-slate-object="text" data-key="7456"><span data-slate-leaf="true" data-offset-key="7456:0" data-first-offset="true"><span data-slate-string="true">g.POST(</span></span></span><span data-slate-object="text" data-key="7457"><span data-slate-leaf="true" data-offset-key="7457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/logout"</span></span></span></span><span data-slate-object="text" data-key="7458"><span data-slate-leaf="true" data-offset-key="7458:0" data-first-offset="true"><span data-slate-string="true">, jwtStrategy.LogoutHandler)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7459"><span data-slate-object="text" data-key="7460"><span data-slate-leaf="true" data-offset-key="7460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Refresh time can be longer than token timeout</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7461"><span data-slate-object="text" data-key="7462"><span data-slate-leaf="true" data-offset-key="7462:0" data-first-offset="true"><span data-slate-string="true">g.POST(</span></span></span><span data-slate-object="text" data-key="7463"><span data-slate-leaf="true" data-offset-key="7463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/refresh"</span></span></span></span><span data-slate-object="text" data-key="7464"><span data-slate-leaf="true" data-offset-key="7464:0" data-first-offset="true"><span data-slate-string="true">, jwtStrategy.RefreshHandler)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7465"><span data-slate-object="text" data-key="7466"><span data-slate-leaf="true" data-offset-key="7466:0" data-first-offset="true"><span data-slate-string="true">上述代码中，我们通过 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7467"><span data-slate-object="text" data-key="7468"><span data-slate-leaf="true" data-offset-key="7468:0" data-first-offset="true"><span data-slate-string="true">newJWTAuth</span></span></span></a><span data-slate-object="text" data-key="7469"><span data-slate-leaf="true" data-offset-key="7469:0" data-first-offset="true"><span data-slate-string="true"> 函数创建了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7470"><span data-slate-object="text" data-key="7471"><span data-slate-leaf="true" data-offset-key="7471:0" data-first-offset="true"><span data-slate-string="true"> auth.JWTStrategy</span></span></span></span><span data-slate-object="text" data-key="7472"><span data-slate-leaf="true" data-offset-key="7472:0" data-first-offset="true"><span data-slate-string="true"> 类型的变量，该变量包含了一些认证相关函数。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7473"><div data-slate-type="list-line" data-slate-object="block" data-key="7474"><span data-slate-object="text" data-key="7475"><span data-slate-leaf="true" data-offset-key="7475:0" data-first-offset="true"><span data-slate-string="true">LoginHandler：实现了 Basic 认证，完成登陆认证。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7476"><span data-slate-object="text" data-key="7477"><span data-slate-leaf="true" data-offset-key="7477:0" data-first-offset="true"><span data-slate-string="true">RefreshHandler：重新刷新 Token 的过期时间。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7478"><span data-slate-object="text" data-key="7479"><span data-slate-leaf="true" data-offset-key="7479:0" data-first-offset="true"><span data-slate-string="true">LogoutHandler：用户注销时调用。登陆成功后，如果在 Cookie 中设置了认证相关的信息，执行 LogoutHandler 则会清空这些信息。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7480"><span data-slate-object="text" data-key="7481"><span data-slate-leaf="true" data-offset-key="7481:0" data-first-offset="true"><span data-slate-string="true">下面，我来分别介绍下 LoginHandler、RefreshHandler 和 LogoutHandler。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7482"><div data-slate-type="list-line" data-slate-object="block" data-key="7483"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="7484"><span data-slate-leaf="true" data-offset-key="7484:0" data-first-offset="true"><span data-slate-string="true">LoginHandler</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7485"><span data-slate-object="text" data-key="7486"><span data-slate-leaf="true" data-offset-key="7486:0" data-first-offset="true"><span data-slate-string="true">这里，我们来看下 LoginHandler Gin 中间件，该函数定义位于</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7487"><span data-slate-object="text" data-key="7488"><span data-slate-leaf="true" data-offset-key="7488:0" data-first-offset="true"><span data-slate-string="true"> github.com/appleboy/gin-jwt</span></span></span></span><span data-slate-object="text" data-key="7489"><span data-slate-leaf="true" data-offset-key="7489:0" data-first-offset="true"><span data-slate-string="true"> 包的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7490"><span data-slate-object="text" data-key="7491"><span data-slate-leaf="true" data-offset-key="7491:0" data-first-offset="true"><span data-slate-string="true">auth_jwt.go</span></span></span></a><span data-slate-object="text" data-key="7492"><span data-slate-leaf="true" data-offset-key="7492:0" data-first-offset="true"><span data-slate-string="true"> 文件中。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7493"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7494"><span data-slate-object="text" data-key="7495"><span data-slate-leaf="true" data-offset-key="7495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7496"><span data-slate-leaf="true" data-offset-key="7496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="7497"><span data-slate-leaf="true" data-offset-key="7497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(mw *GinJWTMiddleware)</span></span></span></span></span><span data-slate-object="text" data-key="7498"><span data-slate-leaf="true" data-offset-key="7498:0" data-first-offset="true"><span data-slate-string="true"> LoginHandler(c *gin.Context) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7499"><span data-slate-object="text" data-key="7500"><span data-slate-leaf="true" data-offset-key="7500:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7501"><span data-slate-leaf="true" data-offset-key="7501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7502"><span data-slate-leaf="true" data-offset-key="7502:0" data-first-offset="true"><span data-slate-string="true"> mw.Authenticator == </span></span></span><span data-slate-object="text" data-key="7503"><span data-slate-leaf="true" data-offset-key="7503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7504"><span data-slate-leaf="true" data-offset-key="7504:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7505"><span data-slate-object="text" data-key="7506"><span data-slate-leaf="true" data-offset-key="7506:0" data-first-offset="true"><span data-slate-string="true">    mw.unauthorized(c, http.StatusInternalServerError, mw.HTTPStatusMessageFunc(ErrMissingAuthenticatorFunc, c))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7507"><span data-slate-object="text" data-key="7508"><span data-slate-leaf="true" data-offset-key="7508:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7509"><span data-slate-leaf="true" data-offset-key="7509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7510"><span data-slate-object="text" data-key="7511"><span data-slate-leaf="true" data-offset-key="7511:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7512"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7513"><span data-slate-object="text" data-key="7514"><span data-slate-leaf="true" data-offset-key="7514:0" data-first-offset="true"><span data-slate-string="true">  data, err := mw.Authenticator(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7515"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7516"><span data-slate-object="text" data-key="7517"><span data-slate-leaf="true" data-offset-key="7517:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7518"><span data-slate-leaf="true" data-offset-key="7518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7519"><span data-slate-leaf="true" data-offset-key="7519:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7520"><span data-slate-leaf="true" data-offset-key="7520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7521"><span data-slate-leaf="true" data-offset-key="7521:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7522"><span data-slate-object="text" data-key="7523"><span data-slate-leaf="true" data-offset-key="7523:0" data-first-offset="true"><span data-slate-string="true">    mw.unauthorized(c, http.StatusUnauthorized, mw.HTTPStatusMessageFunc(err, c))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7524"><span data-slate-object="text" data-key="7525"><span data-slate-leaf="true" data-offset-key="7525:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7526"><span data-slate-leaf="true" data-offset-key="7526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7527"><span data-slate-object="text" data-key="7528"><span data-slate-leaf="true" data-offset-key="7528:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7529"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7530"><span data-slate-object="text" data-key="7531"><span data-slate-leaf="true" data-offset-key="7531:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7532"><span data-slate-leaf="true" data-offset-key="7532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Create the token</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7533"><span data-slate-object="text" data-key="7534"><span data-slate-leaf="true" data-offset-key="7534:0" data-first-offset="true"><span data-slate-string="true">  token := jwt.New(jwt.GetSigningMethod(mw.SigningAlgorithm))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7535"><span data-slate-object="text" data-key="7536"><span data-slate-leaf="true" data-offset-key="7536:0" data-first-offset="true"><span data-slate-string="true">  claims := token.Claims.(jwt.MapClaims)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7537"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7538"><span data-slate-object="text" data-key="7539"><span data-slate-leaf="true" data-offset-key="7539:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7540"><span data-slate-leaf="true" data-offset-key="7540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7541"><span data-slate-leaf="true" data-offset-key="7541:0" data-first-offset="true"><span data-slate-string="true"> mw.PayloadFunc != </span></span></span><span data-slate-object="text" data-key="7542"><span data-slate-leaf="true" data-offset-key="7542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7543"><span data-slate-leaf="true" data-offset-key="7543:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7544"><span data-slate-object="text" data-key="7545"><span data-slate-leaf="true" data-offset-key="7545:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7546"><span data-slate-leaf="true" data-offset-key="7546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="7547"><span data-slate-leaf="true" data-offset-key="7547:0" data-first-offset="true"><span data-slate-string="true"> key, value := </span></span></span><span data-slate-object="text" data-key="7548"><span data-slate-leaf="true" data-offset-key="7548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="7549"><span data-slate-leaf="true" data-offset-key="7549:0" data-first-offset="true"><span data-slate-string="true"> mw.PayloadFunc(data) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7550"><span data-slate-object="text" data-key="7551"><span data-slate-leaf="true" data-offset-key="7551:0" data-first-offset="true"><span data-slate-string="true">      claims[key] = value</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7552"><span data-slate-object="text" data-key="7553"><span data-slate-leaf="true" data-offset-key="7553:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7554"><span data-slate-object="text" data-key="7555"><span data-slate-leaf="true" data-offset-key="7555:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7556"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7557"><span data-slate-object="text" data-key="7558"><span data-slate-leaf="true" data-offset-key="7558:0" data-first-offset="true"><span data-slate-string="true">  expire := mw.TimeFunc().Add(mw.Timeout)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7559"><span data-slate-object="text" data-key="7560"><span data-slate-leaf="true" data-offset-key="7560:0" data-first-offset="true"><span data-slate-string="true">  claims[</span></span></span><span data-slate-object="text" data-key="7561"><span data-slate-leaf="true" data-offset-key="7561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exp"</span></span></span></span><span data-slate-object="text" data-key="7562"><span data-slate-leaf="true" data-offset-key="7562:0" data-first-offset="true"><span data-slate-string="true">] = expire.Unix()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7563"><span data-slate-object="text" data-key="7564"><span data-slate-leaf="true" data-offset-key="7564:0" data-first-offset="true"><span data-slate-string="true">  claims[</span></span></span><span data-slate-object="text" data-key="7565"><span data-slate-leaf="true" data-offset-key="7565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"orig_iat"</span></span></span></span><span data-slate-object="text" data-key="7566"><span data-slate-leaf="true" data-offset-key="7566:0" data-first-offset="true"><span data-slate-string="true">] = mw.TimeFunc().Unix()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7567"><span data-slate-object="text" data-key="7568"><span data-slate-leaf="true" data-offset-key="7568:0" data-first-offset="true"><span data-slate-string="true">  tokenString, err := mw.signedString(token)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7569"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7570"><span data-slate-object="text" data-key="7571"><span data-slate-leaf="true" data-offset-key="7571:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7572"><span data-slate-leaf="true" data-offset-key="7572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7573"><span data-slate-leaf="true" data-offset-key="7573:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7574"><span data-slate-leaf="true" data-offset-key="7574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7575"><span data-slate-leaf="true" data-offset-key="7575:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7576"><span data-slate-object="text" data-key="7577"><span data-slate-leaf="true" data-offset-key="7577:0" data-first-offset="true"><span data-slate-string="true">    mw.unauthorized(c, http.StatusUnauthorized, mw.HTTPStatusMessageFunc(ErrFailedTokenCreation, c))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7578"><span data-slate-object="text" data-key="7579"><span data-slate-leaf="true" data-offset-key="7579:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7580"><span data-slate-leaf="true" data-offset-key="7580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7581"><span data-slate-object="text" data-key="7582"><span data-slate-leaf="true" data-offset-key="7582:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7583"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7584"><span data-slate-object="text" data-key="7585"><span data-slate-leaf="true" data-offset-key="7585:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7586"><span data-slate-leaf="true" data-offset-key="7586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// set cookie</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7587"><span data-slate-object="text" data-key="7588"><span data-slate-leaf="true" data-offset-key="7588:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7589"><span data-slate-leaf="true" data-offset-key="7589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7590"><span data-slate-leaf="true" data-offset-key="7590:0" data-first-offset="true"><span data-slate-string="true"> mw.SendCookie {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7591"><span data-slate-object="text" data-key="7592"><span data-slate-leaf="true" data-offset-key="7592:0" data-first-offset="true"><span data-slate-string="true">    expireCookie := mw.TimeFunc().Add(mw.CookieMaxAge)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7593"><span data-slate-object="text" data-key="7594"><span data-slate-leaf="true" data-offset-key="7594:0" data-first-offset="true"><span data-slate-string="true">    maxage := </span></span></span><span data-slate-object="text" data-key="7595"><span data-slate-leaf="true" data-offset-key="7595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="7596"><span data-slate-leaf="true" data-offset-key="7596:0" data-first-offset="true"><span data-slate-string="true">(expireCookie.Unix() - mw.TimeFunc().Unix())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7597"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7598"><span data-slate-object="text" data-key="7599"><span data-slate-leaf="true" data-offset-key="7599:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7600"><span data-slate-leaf="true" data-offset-key="7600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7601"><span data-slate-leaf="true" data-offset-key="7601:0" data-first-offset="true"><span data-slate-string="true"> mw.CookieSameSite != </span></span></span><span data-slate-object="text" data-key="7602"><span data-slate-leaf="true" data-offset-key="7602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="7603"><span data-slate-leaf="true" data-offset-key="7603:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7604"><span data-slate-object="text" data-key="7605"><span data-slate-leaf="true" data-offset-key="7605:0" data-first-offset="true"><span data-slate-string="true">      c.SetSameSite(mw.CookieSameSite)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7606"><span data-slate-object="text" data-key="7607"><span data-slate-leaf="true" data-offset-key="7607:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7608"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7609"><span data-slate-object="text" data-key="7610"><span data-slate-leaf="true" data-offset-key="7610:0" data-first-offset="true"><span data-slate-string="true">    c.SetCookie(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7611"><span data-slate-object="text" data-key="7612"><span data-slate-leaf="true" data-offset-key="7612:0" data-first-offset="true"><span data-slate-string="true">      mw.CookieName,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7613"><span data-slate-object="text" data-key="7614"><span data-slate-leaf="true" data-offset-key="7614:0" data-first-offset="true"><span data-slate-string="true">      tokenString,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7615"><span data-slate-object="text" data-key="7616"><span data-slate-leaf="true" data-offset-key="7616:0" data-first-offset="true"><span data-slate-string="true">      maxage,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7617"><span data-slate-object="text" data-key="7618"><span data-slate-leaf="true" data-offset-key="7618:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7619"><span data-slate-leaf="true" data-offset-key="7619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/"</span></span></span></span><span data-slate-object="text" data-key="7620"><span data-slate-leaf="true" data-offset-key="7620:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7621"><span data-slate-object="text" data-key="7622"><span data-slate-leaf="true" data-offset-key="7622:0" data-first-offset="true"><span data-slate-string="true">      mw.CookieDomain,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7623"><span data-slate-object="text" data-key="7624"><span data-slate-leaf="true" data-offset-key="7624:0" data-first-offset="true"><span data-slate-string="true">      mw.SecureCookie,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7625"><span data-slate-object="text" data-key="7626"><span data-slate-leaf="true" data-offset-key="7626:0" data-first-offset="true"><span data-slate-string="true">      mw.CookieHTTPOnly,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7627"><span data-slate-object="text" data-key="7628"><span data-slate-leaf="true" data-offset-key="7628:0" data-first-offset="true"><span data-slate-string="true">    )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7629"><span data-slate-object="text" data-key="7630"><span data-slate-leaf="true" data-offset-key="7630:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7631"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7632"><span data-slate-object="text" data-key="7633"><span data-slate-leaf="true" data-offset-key="7633:0" data-first-offset="true"><span data-slate-string="true">  mw.LoginResponse(c, http.StatusOK, tokenString, expire)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7634"><span data-slate-object="text" data-key="7635"><span data-slate-leaf="true" data-offset-key="7635:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7636"><span data-slate-object="text" data-key="7637"><span data-slate-leaf="true" data-offset-key="7637:0" data-first-offset="true"><span data-slate-string="true">从 LoginHandler 函数的代码实现中，我们可以知道，LoginHandler 函数会执行</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7638"><span data-slate-object="text" data-key="7639"><span data-slate-leaf="true" data-offset-key="7639:0" data-first-offset="true"><span data-slate-string="true"> Authenticator</span></span></span></span><span data-slate-object="text" data-key="7640"><span data-slate-leaf="true" data-offset-key="7640:0" data-first-offset="true"><span data-slate-string="true"> 函数，来完成 Basic 认证。如果认证通过，则会签发 JWT Token，并执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7641"><span data-slate-object="text" data-key="7642"><span data-slate-leaf="true" data-offset-key="7642:0" data-first-offset="true"><span data-slate-string="true">PayloadFunc</span></span></span></span><span data-slate-object="text" data-key="7643"><span data-slate-leaf="true" data-offset-key="7643:0" data-first-offset="true"><span data-slate-string="true"> 函数设置 Token Payload。如果我们设置了 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7644"><span data-slate-object="text" data-key="7645"><span data-slate-leaf="true" data-offset-key="7645:0" data-first-offset="true"><span data-slate-string="true">SendCookie=true</span></span></span></span><span data-slate-object="text" data-key="7646"><span data-slate-leaf="true" data-offset-key="7646:0" data-first-offset="true"><span data-slate-string="true"> ，还会在 Cookie 中添加认证相关的信息，例如 Token、Token 的生命周期等，最后执行 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7647"><span data-slate-object="text" data-key="7648"><span data-slate-leaf="true" data-offset-key="7648:0" data-first-offset="true"><span data-slate-string="true">LoginResponse</span></span></span></span><span data-slate-object="text" data-key="7649"><span data-slate-leaf="true" data-offset-key="7649:0" data-first-offset="true"><span data-slate-string="true"> 方法返回 Token 和 Token 的过期时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7650"><span data-slate-type="code" data-slate-object="inline" data-key="7651"><span data-slate-object="text" data-key="7652"><span data-slate-leaf="true" data-offset-key="7652:0" data-first-offset="true"><span data-slate-string="true">Authenticator</span></span></span></span><span data-slate-object="text" data-key="7653"><span data-slate-leaf="true" data-offset-key="7653:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7654"><span data-slate-object="text" data-key="7655"><span data-slate-leaf="true" data-offset-key="7655:0" data-first-offset="true"><span data-slate-string="true">PayloadFunc</span></span></span></span><span data-slate-object="text" data-key="7656"><span data-slate-leaf="true" data-offset-key="7656:0" data-first-offset="true"><span data-slate-string="true">、</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7657"><span data-slate-object="text" data-key="7658"><span data-slate-leaf="true" data-offset-key="7658:0" data-first-offset="true"><span data-slate-string="true">LoginResponse</span></span></span></span><span data-slate-object="text" data-key="7659"><span data-slate-leaf="true" data-offset-key="7659:0" data-first-offset="true"><span data-slate-string="true"> 这三个函数，是我们在创建 JWT 认证策略时指定的。下面我来分别介绍下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7660"><span data-slate-object="text" data-key="7661"><span data-slate-leaf="true" data-offset-key="7661:0" data-first-offset="true"><span data-slate-string="true">先来看下 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7662"><span data-slate-object="text" data-key="7663"><span data-slate-leaf="true" data-offset-key="7663:0" data-first-offset="true"><span data-slate-string="true">Authenticator</span></span></span></a><span data-slate-object="text" data-key="7664"><span data-slate-leaf="true" data-offset-key="7664:0" data-first-offset="true"><span data-slate-string="true"> 函数。Authenticator 函数从 HTTP Authorization Header 中获取用户名和密码，并校验密码是否合法。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7665"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7666"><span data-slate-object="text" data-key="7667"><span data-slate-leaf="true" data-offset-key="7667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7668"><span data-slate-leaf="true" data-offset-key="7668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="7669"><span data-slate-leaf="true" data-offset-key="7669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">authenticator</span></span></span></span></span><span data-slate-object="text" data-key="7670"><span data-slate-leaf="true" data-offset-key="7670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="7671"><span data-slate-leaf="true" data-offset-key="7671:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7672"><span data-slate-leaf="true" data-offset-key="7672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7673"><span data-slate-leaf="true" data-offset-key="7673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *gin.Context)</span></span></span></span></span><span data-slate-object="text" data-key="7674"><span data-slate-leaf="true" data-offset-key="7674:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7675"><span data-slate-leaf="true" data-offset-key="7675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="7676"><span data-slate-leaf="true" data-offset-key="7676:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="7677"><span data-slate-leaf="true" data-offset-key="7677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="7678"><span data-slate-leaf="true" data-offset-key="7678:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7679"><span data-slate-object="text" data-key="7680"><span data-slate-leaf="true" data-offset-key="7680:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7681"><span data-slate-leaf="true" data-offset-key="7681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7682"><span data-slate-leaf="true" data-offset-key="7682:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7683"><span data-slate-leaf="true" data-offset-key="7683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7684"><span data-slate-leaf="true" data-offset-key="7684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *gin.Context)</span></span></span></span></span><span data-slate-object="text" data-key="7685"><span data-slate-leaf="true" data-offset-key="7685:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7686"><span data-slate-leaf="true" data-offset-key="7686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="7687"><span data-slate-leaf="true" data-offset-key="7687:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="7688"><span data-slate-leaf="true" data-offset-key="7688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="7689"><span data-slate-leaf="true" data-offset-key="7689:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7690"><span data-slate-object="text" data-key="7691"><span data-slate-leaf="true" data-offset-key="7691:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7692"><span data-slate-leaf="true" data-offset-key="7692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="7693"><span data-slate-leaf="true" data-offset-key="7693:0" data-first-offset="true"><span data-slate-string="true"> login loginInfo</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7694"><span data-slate-object="text" data-key="7695"><span data-slate-leaf="true" data-offset-key="7695:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7696"><span data-slate-leaf="true" data-offset-key="7696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="7697"><span data-slate-leaf="true" data-offset-key="7697:0" data-first-offset="true"><span data-slate-string="true"> err </span></span></span><span data-slate-object="text" data-key="7698"><span data-slate-leaf="true" data-offset-key="7698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7699"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7700"><span data-slate-object="text" data-key="7701"><span data-slate-leaf="true" data-offset-key="7701:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7702"><span data-slate-leaf="true" data-offset-key="7702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// support header and body both</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7703"><span data-slate-object="text" data-key="7704"><span data-slate-leaf="true" data-offset-key="7704:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7705"><span data-slate-leaf="true" data-offset-key="7705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7706"><span data-slate-leaf="true" data-offset-key="7706:0" data-first-offset="true"><span data-slate-string="true"> c.Request.Header.Get(</span></span></span><span data-slate-object="text" data-key="7707"><span data-slate-leaf="true" data-offset-key="7707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization"</span></span></span></span><span data-slate-object="text" data-key="7708"><span data-slate-leaf="true" data-offset-key="7708:0" data-first-offset="true"><span data-slate-string="true">) != </span></span></span><span data-slate-object="text" data-key="7709"><span data-slate-leaf="true" data-offset-key="7709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="7710"><span data-slate-leaf="true" data-offset-key="7710:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7711"><span data-slate-object="text" data-key="7712"><span data-slate-leaf="true" data-offset-key="7712:0" data-first-offset="true"><span data-slate-string="true">      login, err = parseWithHeader(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7713"><span data-slate-object="text" data-key="7714"><span data-slate-leaf="true" data-offset-key="7714:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="7715"><span data-slate-leaf="true" data-offset-key="7715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="7716"><span data-slate-leaf="true" data-offset-key="7716:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7717"><span data-slate-object="text" data-key="7718"><span data-slate-leaf="true" data-offset-key="7718:0" data-first-offset="true"><span data-slate-string="true">      login, err = parseWithBody(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7719"><span data-slate-object="text" data-key="7720"><span data-slate-leaf="true" data-offset-key="7720:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7721"><span data-slate-object="text" data-key="7722"><span data-slate-leaf="true" data-offset-key="7722:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7723"><span data-slate-leaf="true" data-offset-key="7723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7724"><span data-slate-leaf="true" data-offset-key="7724:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7725"><span data-slate-leaf="true" data-offset-key="7725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7726"><span data-slate-leaf="true" data-offset-key="7726:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7727"><span data-slate-object="text" data-key="7728"><span data-slate-leaf="true" data-offset-key="7728:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7729"><span data-slate-leaf="true" data-offset-key="7729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7730"><span data-slate-leaf="true" data-offset-key="7730:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7731"><span data-slate-leaf="true" data-offset-key="7731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="7732"><span data-slate-leaf="true" data-offset-key="7732:0" data-first-offset="true"><span data-slate-string="true">, jwt.ErrFailedAuthentication</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7733"><span data-slate-object="text" data-key="7734"><span data-slate-leaf="true" data-offset-key="7734:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7735"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7736"><span data-slate-object="text" data-key="7737"><span data-slate-leaf="true" data-offset-key="7737:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7738"><span data-slate-leaf="true" data-offset-key="7738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Get the user information by the login username.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7739"><span data-slate-object="text" data-key="7740"><span data-slate-leaf="true" data-offset-key="7740:0" data-first-offset="true"><span data-slate-string="true">    user, err := store.Client().Users().Get(c, login.Username, metav1.GetOptions{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7741"><span data-slate-object="text" data-key="7742"><span data-slate-leaf="true" data-offset-key="7742:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7743"><span data-slate-leaf="true" data-offset-key="7743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7744"><span data-slate-leaf="true" data-offset-key="7744:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7745"><span data-slate-leaf="true" data-offset-key="7745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7746"><span data-slate-leaf="true" data-offset-key="7746:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7747"><span data-slate-object="text" data-key="7748"><span data-slate-leaf="true" data-offset-key="7748:0" data-first-offset="true"><span data-slate-string="true">      log.Errorf(</span></span></span><span data-slate-object="text" data-key="7749"><span data-slate-leaf="true" data-offset-key="7749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"get user information failed: %s"</span></span></span></span><span data-slate-object="text" data-key="7750"><span data-slate-leaf="true" data-offset-key="7750:0" data-first-offset="true"><span data-slate-string="true">, err.Error())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7751"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7752"><span data-slate-object="text" data-key="7753"><span data-slate-leaf="true" data-offset-key="7753:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7754"><span data-slate-leaf="true" data-offset-key="7754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7755"><span data-slate-leaf="true" data-offset-key="7755:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7756"><span data-slate-leaf="true" data-offset-key="7756:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="7757"><span data-slate-leaf="true" data-offset-key="7757:0" data-first-offset="true"><span data-slate-string="true">, jwt.ErrFailedAuthentication</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7758"><span data-slate-object="text" data-key="7759"><span data-slate-leaf="true" data-offset-key="7759:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7760"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7761"><span data-slate-object="text" data-key="7762"><span data-slate-leaf="true" data-offset-key="7762:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7763"><span data-slate-leaf="true" data-offset-key="7763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Compare the login password with the user password.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7764"><span data-slate-object="text" data-key="7765"><span data-slate-leaf="true" data-offset-key="7765:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7766"><span data-slate-leaf="true" data-offset-key="7766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7767"><span data-slate-leaf="true" data-offset-key="7767:0" data-first-offset="true"><span data-slate-string="true"> err := user.Compare(login.Password); err != </span></span></span><span data-slate-object="text" data-key="7768"><span data-slate-leaf="true" data-offset-key="7768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7769"><span data-slate-leaf="true" data-offset-key="7769:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7770"><span data-slate-object="text" data-key="7771"><span data-slate-leaf="true" data-offset-key="7771:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7772"><span data-slate-leaf="true" data-offset-key="7772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7773"><span data-slate-leaf="true" data-offset-key="7773:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7774"><span data-slate-leaf="true" data-offset-key="7774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="7775"><span data-slate-leaf="true" data-offset-key="7775:0" data-first-offset="true"><span data-slate-string="true">, jwt.ErrFailedAuthentication</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7776"><span data-slate-object="text" data-key="7777"><span data-slate-leaf="true" data-offset-key="7777:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7778"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7779"><span data-slate-object="text" data-key="7780"><span data-slate-leaf="true" data-offset-key="7780:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7781"><span data-slate-leaf="true" data-offset-key="7781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7782"><span data-slate-leaf="true" data-offset-key="7782:0" data-first-offset="true"><span data-slate-string="true"> user, </span></span></span><span data-slate-object="text" data-key="7783"><span data-slate-leaf="true" data-offset-key="7783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7784"><span data-slate-object="text" data-key="7785"><span data-slate-leaf="true" data-offset-key="7785:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7786"><span data-slate-object="text" data-key="7787"><span data-slate-leaf="true" data-offset-key="7787:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7788"><span data-slate-type="code" data-slate-object="inline" data-key="7789"><span data-slate-object="text" data-key="7790"><span data-slate-leaf="true" data-offset-key="7790:0" data-first-offset="true"><span data-slate-string="true">Authenticator</span></span></span></span><span data-slate-object="text" data-key="7791"><span data-slate-leaf="true" data-offset-key="7791:0" data-first-offset="true"><span data-slate-string="true"> 函数需要获取用户名和密码。它首先会判断是否有</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7792"><span data-slate-object="text" data-key="7793"><span data-slate-leaf="true" data-offset-key="7793:0" data-first-offset="true"><span data-slate-string="true"> Authorization</span></span></span></span><span data-slate-object="text" data-key="7794"><span data-slate-leaf="true" data-offset-key="7794:0" data-first-offset="true"><span data-slate-string="true"> 请求头，如果有，则调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7795"><span data-slate-object="text" data-key="7796"><span data-slate-leaf="true" data-offset-key="7796:0" data-first-offset="true"><span data-slate-string="true"> parseWithHeader</span></span></span></span><span data-slate-object="text" data-key="7797"><span data-slate-leaf="true" data-offset-key="7797:0" data-first-offset="true"><span data-slate-string="true"> 函数获取用户名和密码，否则调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7798"><span data-slate-object="text" data-key="7799"><span data-slate-leaf="true" data-offset-key="7799:0" data-first-offset="true"><span data-slate-string="true"> parseWithBody</span></span></span></span><span data-slate-object="text" data-key="7800"><span data-slate-leaf="true" data-offset-key="7800:0" data-first-offset="true"><span data-slate-string="true"> 从 Body 中获取用户名和密码。如果都获取失败，则返回认证失败错误。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7801"><span data-slate-object="text" data-key="7802"><span data-slate-leaf="true" data-offset-key="7802:0" data-first-offset="true"><span data-slate-string="true">所以，IAM 项目的 Basic 支持以下两种请求方式：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="7803"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7804"><span data-slate-object="text" data-key="7805"><span data-slate-leaf="true" data-offset-key="7805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="7806"><span data-slate-leaf="true" data-offset-key="7806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curl -XPOST -H</span></span></span></span><span data-slate-object="text" data-key="7807"><span data-slate-leaf="true" data-offset-key="7807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Basic YWRtaW46QWRtaW5AMjAyMQ=="</span></span></span></span></span><span data-slate-object="text" data-key="7808"><span data-slate-leaf="true" data-offset-key="7808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://127.0.0.1:8080/login </span></span></span></span><span data-slate-object="text" data-key="7809"><span data-slate-leaf="true" data-offset-key="7809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 用户名：密码通过 base64 加码后，通过 HTTP Authorization Header 进行传递，因为密码非明文，建议使用这种方式。</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7810"><span data-slate-object="text" data-key="7811"><span data-slate-leaf="true" data-offset-key="7811:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="7812"><span data-slate-leaf="true" data-offset-key="7812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curl -s -XPOST -H</span></span></span></span><span data-slate-object="text" data-key="7813"><span data-slate-leaf="true" data-offset-key="7813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'Content-Type: application/json'</span></span></span></span></span><span data-slate-object="text" data-key="7814"><span data-slate-leaf="true" data-offset-key="7814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -d</span></span></span></span><span data-slate-object="text" data-key="7815"><span data-slate-leaf="true" data-offset-key="7815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'{"username":"admin","password":"Admin@2021"}'</span></span></span></span></span><span data-slate-object="text" data-key="7816"><span data-slate-leaf="true" data-offset-key="7816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://127.0.0.1:8080/login </span></span></span></span><span data-slate-object="text" data-key="7817"><span data-slate-leaf="true" data-offset-key="7817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 用户名和密码在 HTTP Body 中传递，因为密码是明文，所以这里不建议实际开发中，使用这种方式。</span></span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7818"><span data-slate-object="text" data-key="7819"><span data-slate-leaf="true" data-offset-key="7819:0" data-first-offset="true"><span data-slate-string="true">这里，我们来看下 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7820"><span data-slate-object="text" data-key="7821"><span data-slate-leaf="true" data-offset-key="7821:0" data-first-offset="true"><span data-slate-string="true">parseWithHeader</span></span></span></span><span data-slate-object="text" data-key="7822"><span data-slate-leaf="true" data-offset-key="7822:0" data-first-offset="true"><span data-slate-string="true"> 是如何获取用户名和密码的。假设我们的请求为：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="7823"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7824"><span data-slate-object="text" data-key="7825"><span data-slate-leaf="true" data-offset-key="7825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="7826"><span data-slate-leaf="true" data-offset-key="7826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">curl -XPOST -H</span></span></span></span><span data-slate-object="text" data-key="7827"><span data-slate-leaf="true" data-offset-key="7827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Basic YWRtaW46QWRtaW5AMjAyMQ=="</span></span></span></span></span><span data-slate-object="text" data-key="7828"><span data-slate-leaf="true" data-offset-key="7828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> http://127.0.0.1:8080/login</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7829"><span data-slate-object="text" data-key="7830"><span data-slate-leaf="true" data-offset-key="7830:0" data-first-offset="true"><span data-slate-string="true">其中，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7831"><span data-slate-object="text" data-key="7832"><span data-slate-leaf="true" data-offset-key="7832:0" data-first-offset="true"><span data-slate-string="true">YWRtaW46QWRtaW5AMjAyMQ==</span></span></span></span><span data-slate-object="text" data-key="7833"><span data-slate-leaf="true" data-offset-key="7833:0" data-first-offset="true"><span data-slate-string="true"> 值由以下命令生成：</span></span></span></div><div data-code-language="shell" data-slate-type="pre" data-slate-object="block" data-key="7834"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7835"><span data-slate-object="text" data-key="7836"><span data-slate-leaf="true" data-offset-key="7836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$ </span></span></span></span><span data-slate-object="text" data-key="7837"><span data-slate-leaf="true" data-offset-key="7837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">echo</span></span></span></span></span><span data-slate-object="text" data-key="7838"><span data-slate-leaf="true" data-offset-key="7838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> -n </span></span></span></span><span data-slate-object="text" data-key="7839"><span data-slate-leaf="true" data-offset-key="7839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'admin:Admin@2021'</span></span></span></span></span><span data-slate-object="text" data-key="7840"><span data-slate-leaf="true" data-offset-key="7840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">|base64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7841"><span data-slate-object="text" data-key="7842"><span data-slate-leaf="true" data-offset-key="7842:0" data-first-offset="true"><span data-slate-string="true">YWRtaW46QWRtaW5AMjAyMQ==</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7843"><span data-slate-type="code" data-slate-object="inline" data-key="7844"><span data-slate-object="text" data-key="7845"><span data-slate-leaf="true" data-offset-key="7845:0" data-first-offset="true"><span data-slate-string="true">parseWithHeader</span></span></span></span><span data-slate-object="text" data-key="7846"><span data-slate-leaf="true" data-offset-key="7846:0" data-first-offset="true"><span data-slate-string="true"> 实际上执行的是上述命令的逆向步骤：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7847"><div data-slate-type="list-line" data-slate-object="block" data-key="7848"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="7849"><span data-slate-leaf="true" data-offset-key="7849:0" data-first-offset="true"><span data-slate-string="true">获取</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7850"><span data-slate-object="text" data-key="7851"><span data-slate-leaf="true" data-offset-key="7851:0" data-first-offset="true"><span data-slate-string="true"> Authorization</span></span></span></span><span data-slate-object="text" data-key="7852"><span data-slate-leaf="true" data-offset-key="7852:0" data-first-offset="true"><span data-slate-string="true"> 头的值，并调用 strings.SplitN 函数，获取一个切片变量 auth，其值为 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7853"><span data-slate-object="text" data-key="7854"><span data-slate-leaf="true" data-offset-key="7854:0" data-first-offset="true"><span data-slate-string="true">["Basic","YWRtaW46QWRtaW5AMjAyMQ=="]</span></span></span></span><span data-slate-object="text" data-key="7855"><span data-slate-leaf="true" data-offset-key="7855:0" data-first-offset="true"><span data-slate-string="true"> 。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="7856"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="7857"><span data-slate-leaf="true" data-offset-key="7857:0" data-first-offset="true"><span data-slate-string="true">将</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7858"><span data-slate-object="text" data-key="7859"><span data-slate-leaf="true" data-offset-key="7859:0" data-first-offset="true"><span data-slate-string="true"> YWRtaW46QWRtaW5AMjAyMQ==</span></span></span></span><span data-slate-object="text" data-key="7860"><span data-slate-leaf="true" data-offset-key="7860:0" data-first-offset="true"><span data-slate-string="true"> 进行 base64 解码，得到</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7861"><span data-slate-object="text" data-key="7862"><span data-slate-leaf="true" data-offset-key="7862:0" data-first-offset="true"><span data-slate-string="true"> admin:Admin@2021</span></span></span></span><span data-slate-object="text" data-key="7863"><span data-slate-leaf="true" data-offset-key="7863:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="7864"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="7865"><span data-slate-leaf="true" data-offset-key="7865:0" data-first-offset="true"><span data-slate-string="true">调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7866"><span data-slate-object="text" data-key="7867"><span data-slate-leaf="true" data-offset-key="7867:0" data-first-offset="true"><span data-slate-string="true"> strings.SplitN</span></span></span></span><span data-slate-object="text" data-key="7868"><span data-slate-leaf="true" data-offset-key="7868:0" data-first-offset="true"><span data-slate-string="true"> 函数获取 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7869"><span data-slate-object="text" data-key="7870"><span data-slate-leaf="true" data-offset-key="7870:0" data-first-offset="true"><span data-slate-string="true">admin:Admin@2021</span></span></span></span><span data-slate-object="text" data-key="7871"><span data-slate-leaf="true" data-offset-key="7871:0" data-first-offset="true"><span data-slate-string="true"> ，得到用户名为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7872"><span data-slate-object="text" data-key="7873"><span data-slate-leaf="true" data-offset-key="7873:0" data-first-offset="true"><span data-slate-string="true"> admin</span></span></span></span><span data-slate-object="text" data-key="7874"><span data-slate-leaf="true" data-offset-key="7874:0" data-first-offset="true"><span data-slate-string="true">，密码为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7875"><span data-slate-object="text" data-key="7876"><span data-slate-leaf="true" data-offset-key="7876:0" data-first-offset="true"><span data-slate-string="true"> Admin@2021</span></span></span></span><span data-slate-object="text" data-key="7877"><span data-slate-leaf="true" data-offset-key="7877:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7878"><span data-slate-type="code" data-slate-object="inline" data-key="7879"><span data-slate-object="text" data-key="7880"><span data-slate-leaf="true" data-offset-key="7880:0" data-first-offset="true"><span data-slate-string="true">parseWithBody</span></span></span></span><span data-slate-object="text" data-key="7881"><span data-slate-leaf="true" data-offset-key="7881:0" data-first-offset="true"><span data-slate-string="true"> 则是调用了 Gin 的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7882"><span data-slate-object="text" data-key="7883"><span data-slate-leaf="true" data-offset-key="7883:0" data-first-offset="true"><span data-slate-string="true"> ShouldBindJSON</span></span></span></span><span data-slate-object="text" data-key="7884"><span data-slate-leaf="true" data-offset-key="7884:0" data-first-offset="true"><span data-slate-string="true"> 函数，来从 Body 中解析出用户名和密码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7885"><span data-slate-object="text" data-key="7886"><span data-slate-leaf="true" data-offset-key="7886:0" data-first-offset="true"><span data-slate-string="true">获取到用户名和密码之后，程序会从数据库中查询出该用户对应的加密后的密码，这里我们假设是</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7887"><span data-slate-object="text" data-key="7888"><span data-slate-leaf="true" data-offset-key="7888:0" data-first-offset="true"><span data-slate-string="true"> xxxx</span></span></span></span><span data-slate-object="text" data-key="7889"><span data-slate-leaf="true" data-offset-key="7889:0" data-first-offset="true"><span data-slate-string="true">。最后</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7890"><span data-slate-object="text" data-key="7891"><span data-slate-leaf="true" data-offset-key="7891:0" data-first-offset="true"><span data-slate-string="true"> authenticator</span></span></span></span><span data-slate-object="text" data-key="7892"><span data-slate-leaf="true" data-offset-key="7892:0" data-first-offset="true"><span data-slate-string="true"> 函数调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7893"><span data-slate-object="text" data-key="7894"><span data-slate-leaf="true" data-offset-key="7894:0" data-first-offset="true"><span data-slate-string="true"> user.Compare</span></span></span></span><span data-slate-object="text" data-key="7895"><span data-slate-leaf="true" data-offset-key="7895:0" data-first-offset="true"><span data-slate-string="true"> 来判断 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7896"><span data-slate-object="text" data-key="7897"><span data-slate-leaf="true" data-offset-key="7897:0" data-first-offset="true"><span data-slate-string="true">xxxx</span></span></span></span><span data-slate-object="text" data-key="7898"><span data-slate-leaf="true" data-offset-key="7898:0" data-first-offset="true"><span data-slate-string="true"> 是否和通过</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7899"><span data-slate-object="text" data-key="7900"><span data-slate-leaf="true" data-offset-key="7900:0" data-first-offset="true"><span data-slate-string="true"> user.Compare</span></span></span></span><span data-slate-object="text" data-key="7901"><span data-slate-leaf="true" data-offset-key="7901:0" data-first-offset="true"><span data-slate-string="true"> 加密后的字符串相匹配，如果匹配则认证成功，否则返回认证失败。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7902"><span data-slate-object="text" data-key="7903"><span data-slate-leaf="true" data-offset-key="7903:0" data-first-offset="true"><span data-slate-string="true">再来看下</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="7904"><span data-slate-object="text" data-key="7905"><span data-slate-leaf="true" data-offset-key="7905:0" data-first-offset="true"><span data-slate-string="true"> PayloadFunc</span></span></span></span><span data-slate-object="text" data-key="7906"><span data-slate-leaf="true" data-offset-key="7906:0" data-first-offset="true"><span data-slate-string="true"> 函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7907"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7908"><span data-slate-object="text" data-key="7909"><span data-slate-leaf="true" data-offset-key="7909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7910"><span data-slate-leaf="true" data-offset-key="7910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="7911"><span data-slate-leaf="true" data-offset-key="7911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">payloadFunc</span></span></span></span></span><span data-slate-object="text" data-key="7912"><span data-slate-leaf="true" data-offset-key="7912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="7913"><span data-slate-leaf="true" data-offset-key="7913:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7914"><span data-slate-leaf="true" data-offset-key="7914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7915"><span data-slate-leaf="true" data-offset-key="7915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(data </span></span></span></span></span><span data-slate-object="text" data-key="7916"><span data-slate-leaf="true" data-offset-key="7916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span></span></span><span data-slate-object="text" data-key="7917"><span data-slate-leaf="true" data-offset-key="7917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">{})</span></span></span></span></span><span data-slate-object="text" data-key="7918"><span data-slate-leaf="true" data-offset-key="7918:0" data-first-offset="true"><span data-slate-string="true"> jwt.MapClaims {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7919"><span data-slate-object="text" data-key="7920"><span data-slate-leaf="true" data-offset-key="7920:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7921"><span data-slate-leaf="true" data-offset-key="7921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7922"><span data-slate-leaf="true" data-offset-key="7922:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7923"><span data-slate-leaf="true" data-offset-key="7923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7924"><span data-slate-leaf="true" data-offset-key="7924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(data </span></span></span></span></span><span data-slate-object="text" data-key="7925"><span data-slate-leaf="true" data-offset-key="7925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span></span></span><span data-slate-object="text" data-key="7926"><span data-slate-leaf="true" data-offset-key="7926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">{})</span></span></span></span></span><span data-slate-object="text" data-key="7927"><span data-slate-leaf="true" data-offset-key="7927:0" data-first-offset="true"><span data-slate-string="true"> jwt.MapClaims {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7928"><span data-slate-object="text" data-key="7929"><span data-slate-leaf="true" data-offset-key="7929:0" data-first-offset="true"><span data-slate-string="true">        claims := jwt.MapClaims{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7930"><span data-slate-object="text" data-key="7931"><span data-slate-leaf="true" data-offset-key="7931:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7932"><span data-slate-leaf="true" data-offset-key="7932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"iss"</span></span></span></span><span data-slate-object="text" data-key="7933"><span data-slate-leaf="true" data-offset-key="7933:0" data-first-offset="true"><span data-slate-string="true">: APIServerIssuer,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7934"><span data-slate-object="text" data-key="7935"><span data-slate-leaf="true" data-offset-key="7935:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7936"><span data-slate-leaf="true" data-offset-key="7936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"aud"</span></span></span></span><span data-slate-object="text" data-key="7937"><span data-slate-leaf="true" data-offset-key="7937:0" data-first-offset="true"><span data-slate-string="true">: APIServerAudience,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7938"><span data-slate-object="text" data-key="7939"><span data-slate-leaf="true" data-offset-key="7939:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7940"><span data-slate-object="text" data-key="7941"><span data-slate-leaf="true" data-offset-key="7941:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7942"><span data-slate-leaf="true" data-offset-key="7942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7943"><span data-slate-leaf="true" data-offset-key="7943:0" data-first-offset="true"><span data-slate-string="true"> u, ok := data.(*v1.User); ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7944"><span data-slate-object="text" data-key="7945"><span data-slate-leaf="true" data-offset-key="7945:0" data-first-offset="true"><span data-slate-string="true">            claims[jwt.IdentityKey] = u.Name</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7946"><span data-slate-object="text" data-key="7947"><span data-slate-leaf="true" data-offset-key="7947:0" data-first-offset="true"><span data-slate-string="true">            claims[</span></span></span><span data-slate-object="text" data-key="7948"><span data-slate-leaf="true" data-offset-key="7948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"sub"</span></span></span></span><span data-slate-object="text" data-key="7949"><span data-slate-leaf="true" data-offset-key="7949:0" data-first-offset="true"><span data-slate-string="true">] = u.Name</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7950"><span data-slate-object="text" data-key="7951"><span data-slate-leaf="true" data-offset-key="7951:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7952"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7953"><span data-slate-object="text" data-key="7954"><span data-slate-leaf="true" data-offset-key="7954:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7955"><span data-slate-leaf="true" data-offset-key="7955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7956"><span data-slate-leaf="true" data-offset-key="7956:0" data-first-offset="true"><span data-slate-string="true"> claims</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7957"><span data-slate-object="text" data-key="7958"><span data-slate-leaf="true" data-offset-key="7958:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7959"><span data-slate-object="text" data-key="7960"><span data-slate-leaf="true" data-offset-key="7960:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7961"><span data-slate-object="text" data-key="7962"><span data-slate-leaf="true" data-offset-key="7962:0" data-first-offset="true"><span data-slate-string="true">PayloadFunc 函数会设置 JWT Token 中 Payload 部分的 iss、aud、sub、identity 字段，供后面使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7963"><span data-slate-object="text" data-key="7964"><span data-slate-leaf="true" data-offset-key="7964:0" data-first-offset="true"><span data-slate-string="true">再来看下我们刚才说的第三个函数，LoginResponse 函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7965"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7966"><span data-slate-object="text" data-key="7967"><span data-slate-leaf="true" data-offset-key="7967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7968"><span data-slate-leaf="true" data-offset-key="7968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="7969"><span data-slate-leaf="true" data-offset-key="7969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">loginResponse</span></span></span></span></span><span data-slate-object="text" data-key="7970"><span data-slate-leaf="true" data-offset-key="7970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="7971"><span data-slate-leaf="true" data-offset-key="7971:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7972"><span data-slate-leaf="true" data-offset-key="7972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7973"><span data-slate-leaf="true" data-offset-key="7973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *gin.Context, code </span></span></span></span></span><span data-slate-object="text" data-key="7974"><span data-slate-leaf="true" data-offset-key="7974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="7975"><span data-slate-leaf="true" data-offset-key="7975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, token </span></span></span></span></span><span data-slate-object="text" data-key="7976"><span data-slate-leaf="true" data-offset-key="7976:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="7977"><span data-slate-leaf="true" data-offset-key="7977:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, expire time.Time)</span></span></span></span></span><span data-slate-object="text" data-key="7978"><span data-slate-leaf="true" data-offset-key="7978:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7979"><span data-slate-object="text" data-key="7980"><span data-slate-leaf="true" data-offset-key="7980:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7981"><span data-slate-leaf="true" data-offset-key="7981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7982"><span data-slate-leaf="true" data-offset-key="7982:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7983"><span data-slate-leaf="true" data-offset-key="7983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7984"><span data-slate-leaf="true" data-offset-key="7984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *gin.Context, code </span></span></span></span></span><span data-slate-object="text" data-key="7985"><span data-slate-leaf="true" data-offset-key="7985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="7986"><span data-slate-leaf="true" data-offset-key="7986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, token </span></span></span></span></span><span data-slate-object="text" data-key="7987"><span data-slate-leaf="true" data-offset-key="7987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="7988"><span data-slate-leaf="true" data-offset-key="7988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">, expire time.Time)</span></span></span></span></span><span data-slate-object="text" data-key="7989"><span data-slate-leaf="true" data-offset-key="7989:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7990"><span data-slate-object="text" data-key="7991"><span data-slate-leaf="true" data-offset-key="7991:0" data-first-offset="true"><span data-slate-string="true">        c.JSON(http.StatusOK, gin.H{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7992"><span data-slate-object="text" data-key="7993"><span data-slate-leaf="true" data-offset-key="7993:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7994"><span data-slate-leaf="true" data-offset-key="7994:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"token"</span></span></span></span><span data-slate-object="text" data-key="7995"><span data-slate-leaf="true" data-offset-key="7995:0" data-first-offset="true"><span data-slate-string="true">:  token,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7996"><span data-slate-object="text" data-key="7997"><span data-slate-leaf="true" data-offset-key="7997:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7998"><span data-slate-leaf="true" data-offset-key="7998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expire"</span></span></span></span><span data-slate-object="text" data-key="7999"><span data-slate-leaf="true" data-offset-key="7999:0" data-first-offset="true"><span data-slate-string="true">: expire.Format(time.RFC3339),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8000"><span data-slate-object="text" data-key="8001"><span data-slate-leaf="true" data-offset-key="8001:0" data-first-offset="true"><span data-slate-string="true">        })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8002"><span data-slate-object="text" data-key="8003"><span data-slate-leaf="true" data-offset-key="8003:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8004"><span data-slate-object="text" data-key="8005"><span data-slate-leaf="true" data-offset-key="8005:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8006"><span data-slate-object="text" data-key="8007"><span data-slate-leaf="true" data-offset-key="8007:0" data-first-offset="true"><span data-slate-string="true">该函数用来在 Basic 认证成功之后，返回 Token 和 Token 的过期时间给调用者：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="8008"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8009"><span data-slate-object="text" data-key="8010"><span data-slate-leaf="true" data-offset-key="8010:0" data-first-offset="true"><span data-slate-string="true">$ curl -</span></span></span><span data-slate-object="text" data-key="8011"><span data-slate-leaf="true" data-offset-key="8011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">XPOST</span></span></span></span><span data-slate-object="text" data-key="8012"><span data-slate-leaf="true" data-offset-key="8012:0" data-first-offset="true"><span data-slate-string="true"> -H</span></span></span><span data-slate-object="text" data-key="8013"><span data-slate-leaf="true" data-offset-key="8013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization: Basic YWRtaW46QWRtaW5AMjAyMQ=="</span></span></span></span><span data-slate-object="text" data-key="8014"><span data-slate-leaf="true" data-offset-key="8014:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8015"><span data-slate-leaf="true" data-offset-key="8015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">http</span></span></span></span><span data-slate-object="text" data-key="8016"><span data-slate-leaf="true" data-offset-key="8016:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="8017"><span data-slate-leaf="true" data-offset-key="8017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//127.0.0.1:8080/login</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8018"><span data-slate-object="text" data-key="8019"><span data-slate-leaf="true" data-offset-key="8019:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span><span data-slate-object="text" data-key="8020"><span data-slate-leaf="true" data-offset-key="8020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expire"</span></span></span></span><span data-slate-object="text" data-key="8021"><span data-slate-leaf="true" data-offset-key="8021:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="8022"><span data-slate-leaf="true" data-offset-key="8022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2021-09-29T01:38:49+08:00"</span></span></span></span><span data-slate-object="text" data-key="8023"><span data-slate-leaf="true" data-offset-key="8023:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="8024"><span data-slate-leaf="true" data-offset-key="8024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"token"</span></span></span></span><span data-slate-object="text" data-key="8025"><span data-slate-leaf="true" data-offset-key="8025:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="8026"><span data-slate-leaf="true" data-offset-key="8026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"XX.YY.ZZ"</span></span></span></span><span data-slate-object="text" data-key="8027"><span data-slate-leaf="true" data-offset-key="8027:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8028"><span data-slate-object="text" data-key="8029"><span data-slate-leaf="true" data-offset-key="8029:0" data-first-offset="true"><span data-slate-string="true">登陆成功后，iam-apiserver 会返回 Token 和 Token 的过期时间，前端可以将这些信息缓存在 Cookie 中或 LocalStorage 中，之后的请求都可以使用 Token 来进行认证。使用 Token 进行认证，不仅能够提高认证的安全性，还能够避免查询数据库，从而提高认证效率。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="8030"><div data-slate-type="list-line" data-slate-object="block" data-key="8031"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="8032"><span data-slate-leaf="true" data-offset-key="8032:0" data-first-offset="true"><span data-slate-string="true">RefreshHandler</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8033"><span data-slate-type="code" data-slate-object="inline" data-key="8034"><span data-slate-object="text" data-key="8035"><span data-slate-leaf="true" data-offset-key="8035:0" data-first-offset="true"><span data-slate-string="true">RefreshHandler</span></span></span></span><span data-slate-object="text" data-key="8036"><span data-slate-leaf="true" data-offset-key="8036:0" data-first-offset="true"><span data-slate-string="true"> 函数会先执行 Bearer 认证，如果认证通过，则会重新签发 Token。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="8037"><div data-slate-type="list-line" data-slate-object="block" data-key="8038"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="8039"><span data-slate-leaf="true" data-offset-key="8039:0" data-first-offset="true"><span data-slate-string="true">LogoutHandler</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8040"><span data-slate-object="text" data-key="8041"><span data-slate-leaf="true" data-offset-key="8041:0" data-first-offset="true"><span data-slate-string="true">最后，来看下</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8042"><span data-slate-object="text" data-key="8043"><span data-slate-leaf="true" data-offset-key="8043:0" data-first-offset="true"><span data-slate-string="true"> LogoutHandler</span></span></span></span><span data-slate-object="text" data-key="8044"><span data-slate-leaf="true" data-offset-key="8044:0" data-first-offset="true"><span data-slate-string="true"> 函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8045"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8046"><span data-slate-object="text" data-key="8047"><span data-slate-leaf="true" data-offset-key="8047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8048"><span data-slate-leaf="true" data-offset-key="8048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8049"><span data-slate-leaf="true" data-offset-key="8049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(mw *GinJWTMiddleware)</span></span></span></span></span><span data-slate-object="text" data-key="8050"><span data-slate-leaf="true" data-offset-key="8050:0" data-first-offset="true"><span data-slate-string="true"> LogoutHandler(c *gin.Context) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8051"><span data-slate-object="text" data-key="8052"><span data-slate-leaf="true" data-offset-key="8052:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8053"><span data-slate-leaf="true" data-offset-key="8053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// delete auth cookie</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8054"><span data-slate-object="text" data-key="8055"><span data-slate-leaf="true" data-offset-key="8055:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8056"><span data-slate-leaf="true" data-offset-key="8056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8057"><span data-slate-leaf="true" data-offset-key="8057:0" data-first-offset="true"><span data-slate-string="true"> mw.SendCookie {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8058"><span data-slate-object="text" data-key="8059"><span data-slate-leaf="true" data-offset-key="8059:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8060"><span data-slate-leaf="true" data-offset-key="8060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8061"><span data-slate-leaf="true" data-offset-key="8061:0" data-first-offset="true"><span data-slate-string="true"> mw.CookieSameSite != </span></span></span><span data-slate-object="text" data-key="8062"><span data-slate-leaf="true" data-offset-key="8062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8063"><span data-slate-leaf="true" data-offset-key="8063:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8064"><span data-slate-object="text" data-key="8065"><span data-slate-leaf="true" data-offset-key="8065:0" data-first-offset="true"><span data-slate-string="true">            c.SetSameSite(mw.CookieSameSite)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8066"><span data-slate-object="text" data-key="8067"><span data-slate-leaf="true" data-offset-key="8067:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8068"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8069"><span data-slate-object="text" data-key="8070"><span data-slate-leaf="true" data-offset-key="8070:0" data-first-offset="true"><span data-slate-string="true">        c.SetCookie(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8071"><span data-slate-object="text" data-key="8072"><span data-slate-leaf="true" data-offset-key="8072:0" data-first-offset="true"><span data-slate-string="true">            mw.CookieName,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8073"><span data-slate-object="text" data-key="8074"><span data-slate-leaf="true" data-offset-key="8074:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="8075"><span data-slate-leaf="true" data-offset-key="8075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="8076"><span data-slate-leaf="true" data-offset-key="8076:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8077"><span data-slate-object="text" data-key="8078"><span data-slate-leaf="true" data-offset-key="8078:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="8079"><span data-slate-leaf="true" data-offset-key="8079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-1</span></span></span></span><span data-slate-object="text" data-key="8080"><span data-slate-leaf="true" data-offset-key="8080:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8081"><span data-slate-object="text" data-key="8082"><span data-slate-leaf="true" data-offset-key="8082:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="8083"><span data-slate-leaf="true" data-offset-key="8083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/"</span></span></span></span><span data-slate-object="text" data-key="8084"><span data-slate-leaf="true" data-offset-key="8084:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8085"><span data-slate-object="text" data-key="8086"><span data-slate-leaf="true" data-offset-key="8086:0" data-first-offset="true"><span data-slate-string="true">            mw.CookieDomain,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8087"><span data-slate-object="text" data-key="8088"><span data-slate-leaf="true" data-offset-key="8088:0" data-first-offset="true"><span data-slate-string="true">            mw.SecureCookie,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8089"><span data-slate-object="text" data-key="8090"><span data-slate-leaf="true" data-offset-key="8090:0" data-first-offset="true"><span data-slate-string="true">            mw.CookieHTTPOnly,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8091"><span data-slate-object="text" data-key="8092"><span data-slate-leaf="true" data-offset-key="8092:0" data-first-offset="true"><span data-slate-string="true">        )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8093"><span data-slate-object="text" data-key="8094"><span data-slate-leaf="true" data-offset-key="8094:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8095"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8096"><span data-slate-object="text" data-key="8097"><span data-slate-leaf="true" data-offset-key="8097:0" data-first-offset="true"><span data-slate-string="true">    mw.LogoutResponse(c, http.StatusOK)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8098"><span data-slate-object="text" data-key="8099"><span data-slate-leaf="true" data-offset-key="8099:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8100"><span data-slate-object="text" data-key="8101"><span data-slate-leaf="true" data-offset-key="8101:0" data-first-offset="true"><span data-slate-string="true">可以看到，LogoutHandler 其实是用来清空 Cookie 中 Bearer 认证相关信息的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8102"><span data-slate-object="text" data-key="8103"><span data-slate-leaf="true" data-offset-key="8103:0" data-first-offset="true"><span data-slate-string="true">最后，我们来做个总结：Basic 认证通过用户名和密码来进行认证，通常用在登陆接口 /login 中。用户登陆成功后，会返回 JWT Token，前端会保存该 JWT Token 在浏览器的 Cookie 或 LocalStorage 中，供后续请求使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8104"><span data-slate-object="text" data-key="8105"><span data-slate-leaf="true" data-offset-key="8105:0" data-first-offset="true"><span data-slate-string="true">后续请求时，均会携带该 Token，以完成 Bearer 认证。另外，有了登陆接口，一般还会配套 /logout 接口和 /refresh 接口，分别用来进行注销和刷新 Token。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8106"><span data-slate-object="text" data-key="8107"><span data-slate-leaf="true" data-offset-key="8107:0" data-first-offset="true"><span data-slate-string="true">这里你可能会问，为什么要刷新 Token？因为通过登陆接口签发的 Token 有过期时间，有了刷新接口，前端就可以根据需要，自行刷新 Token 的过期时间。过期时间可以通过 iam-apiserver 配置文件的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8108"><span data-slate-object="text" data-key="8109"><span data-slate-leaf="true" data-offset-key="8109:0" data-first-offset="true"><span data-slate-string="true">jwt.timeout</span></span></span></a><span data-slate-object="text" data-key="8110"><span data-slate-leaf="true" data-offset-key="8110:0" data-first-offset="true"><span data-slate-string="true"> 配置项来指定。登陆后签发 Token 时，使用的密钥（secretKey）由 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8111"><span data-slate-object="text" data-key="8112"><span data-slate-leaf="true" data-offset-key="8112:0" data-first-offset="true"><span data-slate-string="true">jwt.key</span></span></span></a><span data-slate-object="text" data-key="8113"><span data-slate-leaf="true" data-offset-key="8113:0" data-first-offset="true"><span data-slate-string="true"> 配置项来指定。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="8114" id="sr-toc-3"><span data-slate-object="text" data-key="8115"><span data-slate-leaf="true" data-offset-key="8115:0" data-first-offset="true"><span data-slate-string="true">IAM 项目是如何实现 Bearer 认证的？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="8116"><span data-slate-object="text" data-key="8117"><span data-slate-leaf="true" data-offset-key="8117:0" data-first-offset="true"><span data-slate-string="true">上面我们介绍了 Basic 认证。这里，我再来介绍下 IAM 项目中 Bearer 认证的实现方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8118"><span data-slate-object="text" data-key="8119"><span data-slate-leaf="true" data-offset-key="8119:0" data-first-offset="true"><span data-slate-string="true">IAM 项目中有两个地方实现了 Bearer 认证，分别是 iam-apiserver 和 iam-authz-server。下面我来分别介绍下它们是如何实现 Bearer 认证的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="8120" id="sr-toc-4"><span data-slate-object="text" data-key="8121"><span data-slate-leaf="true" data-offset-key="8121:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server Bearer 认证实现</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="8122"><span data-slate-object="text" data-key="8123"><span data-slate-leaf="true" data-offset-key="8123:0" data-first-offset="true"><span data-slate-string="true">先来看下 iam-authz-server 是如何实现 Bearer 认证的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8124"><span data-slate-object="text" data-key="8125"><span data-slate-leaf="true" data-offset-key="8125:0" data-first-offset="true"><span data-slate-string="true">iam-authz-server 通过在 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8126"><span data-slate-object="text" data-key="8127"><span data-slate-leaf="true" data-offset-key="8127:0" data-first-offset="true"><span data-slate-string="true">/v1</span></span></span></span><span data-slate-object="text" data-key="8128"><span data-slate-leaf="true" data-offset-key="8128:0" data-first-offset="true"><span data-slate-string="true"> 路由分组中加载 cache 认证中间件来使用 cache 认证策略：</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="8129"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8130"><span data-slate-object="text" data-key="8131"><span data-slate-leaf="true" data-offset-key="8131:0" data-first-offset="true"><span data-slate-string="true">auth := </span></span></span><span data-slate-object="text" data-key="8132"><span data-slate-leaf="true" data-offset-key="8132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newCacheAuth</span></span></span></span><span data-slate-object="text" data-key="8133"><span data-slate-leaf="true" data-offset-key="8133:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8134"><span data-slate-object="text" data-key="8135"><span data-slate-leaf="true" data-offset-key="8135:0" data-first-offset="true"><span data-slate-string="true">apiv1 := g.</span></span></span><span data-slate-object="text" data-key="8136"><span data-slate-leaf="true" data-offset-key="8136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Group</span></span></span></span><span data-slate-object="text" data-key="8137"><span data-slate-leaf="true" data-offset-key="8137:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8138"><span data-slate-leaf="true" data-offset-key="8138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/v1"</span></span></span></span><span data-slate-object="text" data-key="8139"><span data-slate-leaf="true" data-offset-key="8139:0" data-first-offset="true"><span data-slate-string="true">, auth.</span></span></span><span data-slate-object="text" data-key="8140"><span data-slate-leaf="true" data-offset-key="8140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AuthFunc</span></span></span></span><span data-slate-object="text" data-key="8141"><span data-slate-leaf="true" data-offset-key="8141:0" data-first-offset="true"><span data-slate-string="true">())</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8142"><span data-slate-object="text" data-key="8143"><span data-slate-leaf="true" data-offset-key="8143:0" data-first-offset="true"><span data-slate-string="true">来看下 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8144"><span data-slate-object="text" data-key="8145"><span data-slate-leaf="true" data-offset-key="8145:0" data-first-offset="true"><span data-slate-string="true">newCacheAuth</span></span></span></a><span data-slate-object="text" data-key="8146"><span data-slate-leaf="true" data-offset-key="8146:0" data-first-offset="true"><span data-slate-string="true"> 函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8147"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8148"><span data-slate-object="text" data-key="8149"><span data-slate-leaf="true" data-offset-key="8149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8150"><span data-slate-leaf="true" data-offset-key="8150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8151"><span data-slate-leaf="true" data-offset-key="8151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">newCacheAuth</span></span></span></span></span><span data-slate-object="text" data-key="8152"><span data-slate-leaf="true" data-offset-key="8152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8153"><span data-slate-leaf="true" data-offset-key="8153:0" data-first-offset="true"><span data-slate-string="true"> middleware.AuthStrategy {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8154"><span data-slate-object="text" data-key="8155"><span data-slate-leaf="true" data-offset-key="8155:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8156"><span data-slate-leaf="true" data-offset-key="8156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8157"><span data-slate-leaf="true" data-offset-key="8157:0" data-first-offset="true"><span data-slate-string="true"> auth.NewCacheStrategy(getSecretFunc())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8158"><span data-slate-object="text" data-key="8159"><span data-slate-leaf="true" data-offset-key="8159:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8160"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8161"><span data-slate-object="text" data-key="8162"><span data-slate-leaf="true" data-offset-key="8162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8163"><span data-slate-leaf="true" data-offset-key="8163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8164"><span data-slate-leaf="true" data-offset-key="8164:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">getSecretFunc</span></span></span></span></span><span data-slate-object="text" data-key="8165"><span data-slate-leaf="true" data-offset-key="8165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8166"><span data-slate-leaf="true" data-offset-key="8166:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8167"><span data-slate-leaf="true" data-offset-key="8167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8168"><span data-slate-leaf="true" data-offset-key="8168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="8169"><span data-slate-leaf="true" data-offset-key="8169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="8170"><span data-slate-leaf="true" data-offset-key="8170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="8171"><span data-slate-leaf="true" data-offset-key="8171:0" data-first-offset="true"><span data-slate-string="true"> (auth.Secret, </span></span></span><span data-slate-object="text" data-key="8172"><span data-slate-leaf="true" data-offset-key="8172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="8173"><span data-slate-leaf="true" data-offset-key="8173:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8174"><span data-slate-object="text" data-key="8175"><span data-slate-leaf="true" data-offset-key="8175:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8176"><span data-slate-leaf="true" data-offset-key="8176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8177"><span data-slate-leaf="true" data-offset-key="8177:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8178"><span data-slate-leaf="true" data-offset-key="8178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8179"><span data-slate-leaf="true" data-offset-key="8179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(kid </span></span></span></span></span><span data-slate-object="text" data-key="8180"><span data-slate-leaf="true" data-offset-key="8180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="8181"><span data-slate-leaf="true" data-offset-key="8181:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="8182"><span data-slate-leaf="true" data-offset-key="8182:0" data-first-offset="true"><span data-slate-string="true"> (auth.Secret, </span></span></span><span data-slate-object="text" data-key="8183"><span data-slate-leaf="true" data-offset-key="8183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="8184"><span data-slate-leaf="true" data-offset-key="8184:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8185"><span data-slate-object="text" data-key="8186"><span data-slate-leaf="true" data-offset-key="8186:0" data-first-offset="true"><span data-slate-string="true">        cli, err := store.GetStoreInsOr(</span></span></span><span data-slate-object="text" data-key="8187"><span data-slate-leaf="true" data-offset-key="8187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8188"><span data-slate-leaf="true" data-offset-key="8188:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8189"><span data-slate-object="text" data-key="8190"><span data-slate-leaf="true" data-offset-key="8190:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8191"><span data-slate-leaf="true" data-offset-key="8191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8192"><span data-slate-leaf="true" data-offset-key="8192:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="8193"><span data-slate-leaf="true" data-offset-key="8193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8194"><span data-slate-leaf="true" data-offset-key="8194:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8195"><span data-slate-object="text" data-key="8196"><span data-slate-leaf="true" data-offset-key="8196:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="8197"><span data-slate-leaf="true" data-offset-key="8197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8198"><span data-slate-leaf="true" data-offset-key="8198:0" data-first-offset="true"><span data-slate-string="true"> auth.Secret{}, errors.Wrap(err, </span></span></span><span data-slate-object="text" data-key="8199"><span data-slate-leaf="true" data-offset-key="8199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"get store instance failed"</span></span></span></span><span data-slate-object="text" data-key="8200"><span data-slate-leaf="true" data-offset-key="8200:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8201"><span data-slate-object="text" data-key="8202"><span data-slate-leaf="true" data-offset-key="8202:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8203"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8204"><span data-slate-object="text" data-key="8205"><span data-slate-leaf="true" data-offset-key="8205:0" data-first-offset="true"><span data-slate-string="true">        secret, err := cli.GetSecret(kid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8206"><span data-slate-object="text" data-key="8207"><span data-slate-leaf="true" data-offset-key="8207:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8208"><span data-slate-leaf="true" data-offset-key="8208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8209"><span data-slate-leaf="true" data-offset-key="8209:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="8210"><span data-slate-leaf="true" data-offset-key="8210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8211"><span data-slate-leaf="true" data-offset-key="8211:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8212"><span data-slate-object="text" data-key="8213"><span data-slate-leaf="true" data-offset-key="8213:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="8214"><span data-slate-leaf="true" data-offset-key="8214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8215"><span data-slate-leaf="true" data-offset-key="8215:0" data-first-offset="true"><span data-slate-string="true"> auth.Secret{}, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8216"><span data-slate-object="text" data-key="8217"><span data-slate-leaf="true" data-offset-key="8217:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8218"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8219"><span data-slate-object="text" data-key="8220"><span data-slate-leaf="true" data-offset-key="8220:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8221"><span data-slate-leaf="true" data-offset-key="8221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8222"><span data-slate-leaf="true" data-offset-key="8222:0" data-first-offset="true"><span data-slate-string="true"> auth.Secret{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8223"><span data-slate-object="text" data-key="8224"><span data-slate-leaf="true" data-offset-key="8224:0" data-first-offset="true"><span data-slate-string="true">            Username: secret.Username,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8225"><span data-slate-object="text" data-key="8226"><span data-slate-leaf="true" data-offset-key="8226:0" data-first-offset="true"><span data-slate-string="true">            ID:       secret.SecretId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8227"><span data-slate-object="text" data-key="8228"><span data-slate-leaf="true" data-offset-key="8228:0" data-first-offset="true"><span data-slate-string="true">            Key:      secret.SecretKey,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8229"><span data-slate-object="text" data-key="8230"><span data-slate-leaf="true" data-offset-key="8230:0" data-first-offset="true"><span data-slate-string="true">            Expires:  secret.Expires,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8231"><span data-slate-object="text" data-key="8232"><span data-slate-leaf="true" data-offset-key="8232:0" data-first-offset="true"><span data-slate-string="true">        }, </span></span></span><span data-slate-object="text" data-key="8233"><span data-slate-leaf="true" data-offset-key="8233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8234"><span data-slate-object="text" data-key="8235"><span data-slate-leaf="true" data-offset-key="8235:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8236"><span data-slate-object="text" data-key="8237"><span data-slate-leaf="true" data-offset-key="8237:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8238"><span data-slate-object="text" data-key="8239"><span data-slate-leaf="true" data-offset-key="8239:0" data-first-offset="true"><span data-slate-string="true">newCacheAuth 函数调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8240"><span data-slate-object="text" data-key="8241"><span data-slate-leaf="true" data-offset-key="8241:0" data-first-offset="true"><span data-slate-string="true"> auth.NewCacheStrategy</span></span></span></span><span data-slate-object="text" data-key="8242"><span data-slate-leaf="true" data-offset-key="8242:0" data-first-offset="true"><span data-slate-string="true"> 创建了一个 cache 认证策略，创建时传入了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8243"><span data-slate-object="text" data-key="8244"><span data-slate-leaf="true" data-offset-key="8244:0" data-first-offset="true"><span data-slate-string="true"> getSecretFunc</span></span></span></span><span data-slate-object="text" data-key="8245"><span data-slate-leaf="true" data-offset-key="8245:0" data-first-offset="true"><span data-slate-string="true"> 函数，该函数会返回密钥的信息。密钥信息包含了以下字段：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8246"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8247"><span data-slate-object="text" data-key="8248"><span data-slate-leaf="true" data-offset-key="8248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="8249"><span data-slate-leaf="true" data-offset-key="8249:0" data-first-offset="true"><span data-slate-string="true"> Secret </span></span></span><span data-slate-object="text" data-key="8250"><span data-slate-leaf="true" data-offset-key="8250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="8251"><span data-slate-leaf="true" data-offset-key="8251:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8252"><span data-slate-object="text" data-key="8253"><span data-slate-leaf="true" data-offset-key="8253:0" data-first-offset="true"><span data-slate-string="true">    Username </span></span></span><span data-slate-object="text" data-key="8254"><span data-slate-leaf="true" data-offset-key="8254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8255"><span data-slate-object="text" data-key="8256"><span data-slate-leaf="true" data-offset-key="8256:0" data-first-offset="true"><span data-slate-string="true">    ID       </span></span></span><span data-slate-object="text" data-key="8257"><span data-slate-leaf="true" data-offset-key="8257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8258"><span data-slate-object="text" data-key="8259"><span data-slate-leaf="true" data-offset-key="8259:0" data-first-offset="true"><span data-slate-string="true">    Key      </span></span></span><span data-slate-object="text" data-key="8260"><span data-slate-leaf="true" data-offset-key="8260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8261"><span data-slate-object="text" data-key="8262"><span data-slate-leaf="true" data-offset-key="8262:0" data-first-offset="true"><span data-slate-string="true">    Expires  </span></span></span><span data-slate-object="text" data-key="8263"><span data-slate-leaf="true" data-offset-key="8263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8264"><span data-slate-object="text" data-key="8265"><span data-slate-leaf="true" data-offset-key="8265:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8266"><span data-slate-object="text" data-key="8267"><span data-slate-leaf="true" data-offset-key="8267:0" data-first-offset="true"><span data-slate-string="true">再来看下 cache 认证策略实现的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8268"><span data-slate-object="text" data-key="8269"><span data-slate-leaf="true" data-offset-key="8269:0" data-first-offset="true"><span data-slate-string="true">AuthFunc</span></span></span></a><span data-slate-object="text" data-key="8270"><span data-slate-leaf="true" data-offset-key="8270:0" data-first-offset="true"><span data-slate-string="true"> 方法：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8271"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8272"><span data-slate-object="text" data-key="8273"><span data-slate-leaf="true" data-offset-key="8273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8274"><span data-slate-leaf="true" data-offset-key="8274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8275"><span data-slate-leaf="true" data-offset-key="8275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(cache CacheStrategy)</span></span></span></span></span><span data-slate-object="text" data-key="8276"><span data-slate-leaf="true" data-offset-key="8276:0" data-first-offset="true"><span data-slate-string="true"> AuthFunc() gin.HandlerFunc {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8277"><span data-slate-object="text" data-key="8278"><span data-slate-leaf="true" data-offset-key="8278:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8279"><span data-slate-leaf="true" data-offset-key="8279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8280"><span data-slate-leaf="true" data-offset-key="8280:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8281"><span data-slate-leaf="true" data-offset-key="8281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8282"><span data-slate-leaf="true" data-offset-key="8282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *gin.Context)</span></span></span></span></span><span data-slate-object="text" data-key="8283"><span data-slate-leaf="true" data-offset-key="8283:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8284"><span data-slate-object="text" data-key="8285"><span data-slate-leaf="true" data-offset-key="8285:0" data-first-offset="true"><span data-slate-string="true">    header := c.Request.Header.Get(</span></span></span><span data-slate-object="text" data-key="8286"><span data-slate-leaf="true" data-offset-key="8286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization"</span></span></span></span><span data-slate-object="text" data-key="8287"><span data-slate-leaf="true" data-offset-key="8287:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8288"><span data-slate-object="text" data-key="8289"><span data-slate-leaf="true" data-offset-key="8289:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8290"><span data-slate-leaf="true" data-offset-key="8290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8291"><span data-slate-leaf="true" data-offset-key="8291:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8292"><span data-slate-leaf="true" data-offset-key="8292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="8293"><span data-slate-leaf="true" data-offset-key="8293:0" data-first-offset="true"><span data-slate-string="true">(header) == </span></span></span><span data-slate-object="text" data-key="8294"><span data-slate-leaf="true" data-offset-key="8294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8295"><span data-slate-leaf="true" data-offset-key="8295:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8296"><span data-slate-object="text" data-key="8297"><span data-slate-leaf="true" data-offset-key="8297:0" data-first-offset="true"><span data-slate-string="true">      core.WriteResponse(c, errors.WithCode(code.ErrMissingHeader, </span></span></span><span data-slate-object="text" data-key="8298"><span data-slate-leaf="true" data-offset-key="8298:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization header cannot be empty."</span></span></span></span><span data-slate-object="text" data-key="8299"><span data-slate-leaf="true" data-offset-key="8299:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="8300"><span data-slate-leaf="true" data-offset-key="8300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8301"><span data-slate-leaf="true" data-offset-key="8301:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8302"><span data-slate-object="text" data-key="8303"><span data-slate-leaf="true" data-offset-key="8303:0" data-first-offset="true"><span data-slate-string="true">      c.Abort()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8304"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8305"><span data-slate-object="text" data-key="8306"><span data-slate-leaf="true" data-offset-key="8306:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8307"><span data-slate-leaf="true" data-offset-key="8307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8308"><span data-slate-object="text" data-key="8309"><span data-slate-leaf="true" data-offset-key="8309:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8310"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8311"><span data-slate-object="text" data-key="8312"><span data-slate-leaf="true" data-offset-key="8312:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8313"><span data-slate-leaf="true" data-offset-key="8313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="8314"><span data-slate-leaf="true" data-offset-key="8314:0" data-first-offset="true"><span data-slate-string="true"> rawJWT </span></span></span><span data-slate-object="text" data-key="8315"><span data-slate-leaf="true" data-offset-key="8315:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8316"><span data-slate-object="text" data-key="8317"><span data-slate-leaf="true" data-offset-key="8317:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8318"><span data-slate-leaf="true" data-offset-key="8318:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Parse the header to get the token part.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8319"><span data-slate-object="text" data-key="8320"><span data-slate-leaf="true" data-offset-key="8320:0" data-first-offset="true"><span data-slate-string="true">    fmt.Sscanf(header, </span></span></span><span data-slate-object="text" data-key="8321"><span data-slate-leaf="true" data-offset-key="8321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Bearer %s"</span></span></span></span><span data-slate-object="text" data-key="8322"><span data-slate-leaf="true" data-offset-key="8322:0" data-first-offset="true"><span data-slate-string="true">, &amp;rawJWT)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8323"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8324"><span data-slate-object="text" data-key="8325"><span data-slate-leaf="true" data-offset-key="8325:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8326"><span data-slate-leaf="true" data-offset-key="8326:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Use own validation logic, see below</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8327"><span data-slate-object="text" data-key="8328"><span data-slate-leaf="true" data-offset-key="8328:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8329"><span data-slate-leaf="true" data-offset-key="8329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="8330"><span data-slate-leaf="true" data-offset-key="8330:0" data-first-offset="true"><span data-slate-string="true"> secret Secret</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8331"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8332"><span data-slate-object="text" data-key="8333"><span data-slate-leaf="true" data-offset-key="8333:0" data-first-offset="true"><span data-slate-string="true">    claims := &amp;jwt.MapClaims{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8334"><span data-slate-object="text" data-key="8335"><span data-slate-leaf="true" data-offset-key="8335:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8336"><span data-slate-leaf="true" data-offset-key="8336:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Verify the token</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8337"><span data-slate-object="text" data-key="8338"><span data-slate-leaf="true" data-offset-key="8338:0" data-first-offset="true"><span data-slate-string="true">    parsedT, err := jwt.ParseWithClaims(rawJWT, claims, </span></span></span><span data-slate-object="text" data-key="8339"><span data-slate-leaf="true" data-offset-key="8339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8340"><span data-slate-leaf="true" data-offset-key="8340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(token *jwt.Token)</span></span></span></span></span><span data-slate-object="text" data-key="8341"><span data-slate-leaf="true" data-offset-key="8341:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="8342"><span data-slate-leaf="true" data-offset-key="8342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="8343"><span data-slate-leaf="true" data-offset-key="8343:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="8344"><span data-slate-leaf="true" data-offset-key="8344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="8345"><span data-slate-leaf="true" data-offset-key="8345:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8346"><span data-slate-object="text" data-key="8347"><span data-slate-leaf="true" data-offset-key="8347:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8348"><span data-slate-leaf="true" data-offset-key="8348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Validate the alg is HMAC signature</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8349"><span data-slate-object="text" data-key="8350"><span data-slate-leaf="true" data-offset-key="8350:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8351"><span data-slate-leaf="true" data-offset-key="8351:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8352"><span data-slate-leaf="true" data-offset-key="8352:0" data-first-offset="true"><span data-slate-string="true"> _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8353"><span data-slate-object="text" data-key="8354"><span data-slate-leaf="true" data-offset-key="8354:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8355"><span data-slate-leaf="true" data-offset-key="8355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8356"><span data-slate-leaf="true" data-offset-key="8356:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8357"><span data-slate-leaf="true" data-offset-key="8357:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8358"><span data-slate-leaf="true" data-offset-key="8358:0" data-first-offset="true"><span data-slate-string="true">, fmt.Errorf(</span></span></span><span data-slate-object="text" data-key="8359"><span data-slate-leaf="true" data-offset-key="8359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"unexpected signing method: %v"</span></span></span></span><span data-slate-object="text" data-key="8360"><span data-slate-leaf="true" data-offset-key="8360:0" data-first-offset="true"><span data-slate-string="true">, token.Header[</span></span></span><span data-slate-object="text" data-key="8361"><span data-slate-leaf="true" data-offset-key="8361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"alg"</span></span></span></span><span data-slate-object="text" data-key="8362"><span data-slate-leaf="true" data-offset-key="8362:0" data-first-offset="true"><span data-slate-string="true">])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8363"><span data-slate-object="text" data-key="8364"><span data-slate-leaf="true" data-offset-key="8364:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8365"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8366"><span data-slate-object="text" data-key="8367"><span data-slate-leaf="true" data-offset-key="8367:0" data-first-offset="true"><span data-slate-string="true">      kid, ok := token.Header[</span></span></span><span data-slate-object="text" data-key="8368"><span data-slate-leaf="true" data-offset-key="8368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"kid"</span></span></span></span><span data-slate-object="text" data-key="8369"><span data-slate-leaf="true" data-offset-key="8369:0" data-first-offset="true"><span data-slate-string="true">].(</span></span></span><span data-slate-object="text" data-key="8370"><span data-slate-leaf="true" data-offset-key="8370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="8371"><span data-slate-leaf="true" data-offset-key="8371:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8372"><span data-slate-object="text" data-key="8373"><span data-slate-leaf="true" data-offset-key="8373:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8374"><span data-slate-leaf="true" data-offset-key="8374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8375"><span data-slate-leaf="true" data-offset-key="8375:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8376"><span data-slate-object="text" data-key="8377"><span data-slate-leaf="true" data-offset-key="8377:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8378"><span data-slate-leaf="true" data-offset-key="8378:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8379"><span data-slate-leaf="true" data-offset-key="8379:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8380"><span data-slate-leaf="true" data-offset-key="8380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8381"><span data-slate-leaf="true" data-offset-key="8381:0" data-first-offset="true"><span data-slate-string="true">, ErrMissingKID</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8382"><span data-slate-object="text" data-key="8383"><span data-slate-leaf="true" data-offset-key="8383:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8384"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8385"><span data-slate-object="text" data-key="8386"><span data-slate-leaf="true" data-offset-key="8386:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8387"><span data-slate-leaf="true" data-offset-key="8387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="8388"><span data-slate-leaf="true" data-offset-key="8388:0" data-first-offset="true"><span data-slate-string="true"> err </span></span></span><span data-slate-object="text" data-key="8389"><span data-slate-leaf="true" data-offset-key="8389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8390"><span data-slate-object="text" data-key="8391"><span data-slate-leaf="true" data-offset-key="8391:0" data-first-offset="true"><span data-slate-string="true">      secret, err = cache.get(kid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8392"><span data-slate-object="text" data-key="8393"><span data-slate-leaf="true" data-offset-key="8393:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8394"><span data-slate-leaf="true" data-offset-key="8394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8395"><span data-slate-leaf="true" data-offset-key="8395:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="8396"><span data-slate-leaf="true" data-offset-key="8396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8397"><span data-slate-leaf="true" data-offset-key="8397:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8398"><span data-slate-object="text" data-key="8399"><span data-slate-leaf="true" data-offset-key="8399:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8400"><span data-slate-leaf="true" data-offset-key="8400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8401"><span data-slate-leaf="true" data-offset-key="8401:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8402"><span data-slate-leaf="true" data-offset-key="8402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8403"><span data-slate-leaf="true" data-offset-key="8403:0" data-first-offset="true"><span data-slate-string="true">, ErrMissingSecret</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8404"><span data-slate-object="text" data-key="8405"><span data-slate-leaf="true" data-offset-key="8405:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8406"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8407"><span data-slate-object="text" data-key="8408"><span data-slate-leaf="true" data-offset-key="8408:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8409"><span data-slate-leaf="true" data-offset-key="8409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8410"><span data-slate-leaf="true" data-offset-key="8410:0" data-first-offset="true"><span data-slate-string="true"> []</span></span></span><span data-slate-object="text" data-key="8411"><span data-slate-leaf="true" data-offset-key="8411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="8412"><span data-slate-leaf="true" data-offset-key="8412:0" data-first-offset="true"><span data-slate-string="true">(secret.Key), </span></span></span><span data-slate-object="text" data-key="8413"><span data-slate-leaf="true" data-offset-key="8413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8414"><span data-slate-object="text" data-key="8415"><span data-slate-leaf="true" data-offset-key="8415:0" data-first-offset="true"><span data-slate-string="true">    }, jwt.WithAudience(AuthzAudience))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8416"><span data-slate-object="text" data-key="8417"><span data-slate-leaf="true" data-offset-key="8417:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8418"><span data-slate-leaf="true" data-offset-key="8418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8419"><span data-slate-leaf="true" data-offset-key="8419:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="8420"><span data-slate-leaf="true" data-offset-key="8420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8421"><span data-slate-leaf="true" data-offset-key="8421:0" data-first-offset="true"><span data-slate-string="true"> || !parsedT.Valid {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8422"><span data-slate-object="text" data-key="8423"><span data-slate-leaf="true" data-offset-key="8423:0" data-first-offset="true"><span data-slate-string="true">      core.WriteResponse(c, errors.WithCode(code.ErrSignatureInvalid, err.Error()), </span></span></span><span data-slate-object="text" data-key="8424"><span data-slate-leaf="true" data-offset-key="8424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8425"><span data-slate-leaf="true" data-offset-key="8425:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8426"><span data-slate-object="text" data-key="8427"><span data-slate-leaf="true" data-offset-key="8427:0" data-first-offset="true"><span data-slate-string="true">      c.Abort()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8428"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8429"><span data-slate-object="text" data-key="8430"><span data-slate-leaf="true" data-offset-key="8430:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8431"><span data-slate-leaf="true" data-offset-key="8431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8432"><span data-slate-object="text" data-key="8433"><span data-slate-leaf="true" data-offset-key="8433:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8434"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8435"><span data-slate-object="text" data-key="8436"><span data-slate-leaf="true" data-offset-key="8436:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8437"><span data-slate-leaf="true" data-offset-key="8437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8438"><span data-slate-leaf="true" data-offset-key="8438:0" data-first-offset="true"><span data-slate-string="true"> KeyExpired(secret.Expires) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8439"><span data-slate-object="text" data-key="8440"><span data-slate-leaf="true" data-offset-key="8440:0" data-first-offset="true"><span data-slate-string="true">      tm := time.Unix(secret.Expires, </span></span></span><span data-slate-object="text" data-key="8441"><span data-slate-leaf="true" data-offset-key="8441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8442"><span data-slate-leaf="true" data-offset-key="8442:0" data-first-offset="true"><span data-slate-string="true">).Format(</span></span></span><span data-slate-object="text" data-key="8443"><span data-slate-leaf="true" data-offset-key="8443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2006-01-02 15:04:05"</span></span></span></span><span data-slate-object="text" data-key="8444"><span data-slate-leaf="true" data-offset-key="8444:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8445"><span data-slate-object="text" data-key="8446"><span data-slate-leaf="true" data-offset-key="8446:0" data-first-offset="true"><span data-slate-string="true">      core.WriteResponse(c, errors.WithCode(code.ErrExpired, </span></span></span><span data-slate-object="text" data-key="8447"><span data-slate-leaf="true" data-offset-key="8447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"expired at: %s"</span></span></span></span><span data-slate-object="text" data-key="8448"><span data-slate-leaf="true" data-offset-key="8448:0" data-first-offset="true"><span data-slate-string="true">, tm), </span></span></span><span data-slate-object="text" data-key="8449"><span data-slate-leaf="true" data-offset-key="8449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8450"><span data-slate-leaf="true" data-offset-key="8450:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8451"><span data-slate-object="text" data-key="8452"><span data-slate-leaf="true" data-offset-key="8452:0" data-first-offset="true"><span data-slate-string="true">      c.Abort()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8453"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8454"><span data-slate-object="text" data-key="8455"><span data-slate-leaf="true" data-offset-key="8455:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8456"><span data-slate-leaf="true" data-offset-key="8456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8457"><span data-slate-object="text" data-key="8458"><span data-slate-leaf="true" data-offset-key="8458:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8459"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8460"><span data-slate-object="text" data-key="8461"><span data-slate-leaf="true" data-offset-key="8461:0" data-first-offset="true"><span data-slate-string="true">    c.Set(CtxUsername, secret.Username)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8462"><span data-slate-object="text" data-key="8463"><span data-slate-leaf="true" data-offset-key="8463:0" data-first-offset="true"><span data-slate-string="true">    c.Next()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8464"><span data-slate-object="text" data-key="8465"><span data-slate-leaf="true" data-offset-key="8465:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8466"><span data-slate-object="text" data-key="8467"><span data-slate-leaf="true" data-offset-key="8467:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8468"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8469"><span data-slate-object="text" data-key="8470"><span data-slate-leaf="true" data-offset-key="8470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// KeyExpired checks if a key has expired, if the value of user.SessionState.Expires is 0, it will be ignored.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8471"><span data-slate-object="text" data-key="8472"><span data-slate-leaf="true" data-offset-key="8472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8473"><span data-slate-leaf="true" data-offset-key="8473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8474"><span data-slate-leaf="true" data-offset-key="8474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KeyExpired</span></span></span></span></span><span data-slate-object="text" data-key="8475"><span data-slate-leaf="true" data-offset-key="8475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(expires </span></span></span></span></span><span data-slate-object="text" data-key="8476"><span data-slate-leaf="true" data-offset-key="8476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></span></span><span data-slate-object="text" data-key="8477"><span data-slate-leaf="true" data-offset-key="8477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="8478"><span data-slate-leaf="true" data-offset-key="8478:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8479"><span data-slate-leaf="true" data-offset-key="8479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="8480"><span data-slate-leaf="true" data-offset-key="8480:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8481"><span data-slate-object="text" data-key="8482"><span data-slate-leaf="true" data-offset-key="8482:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8483"><span data-slate-leaf="true" data-offset-key="8483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8484"><span data-slate-leaf="true" data-offset-key="8484:0" data-first-offset="true"><span data-slate-string="true"> expires &gt;= </span></span></span><span data-slate-object="text" data-key="8485"><span data-slate-leaf="true" data-offset-key="8485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="8486"><span data-slate-leaf="true" data-offset-key="8486:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8487"><span data-slate-object="text" data-key="8488"><span data-slate-leaf="true" data-offset-key="8488:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8489"><span data-slate-leaf="true" data-offset-key="8489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8490"><span data-slate-leaf="true" data-offset-key="8490:0" data-first-offset="true"><span data-slate-string="true"> time.Now().After(time.Unix(expires, </span></span></span><span data-slate-object="text" data-key="8491"><span data-slate-leaf="true" data-offset-key="8491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8492"><span data-slate-leaf="true" data-offset-key="8492:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8493"><span data-slate-object="text" data-key="8494"><span data-slate-leaf="true" data-offset-key="8494:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8495"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8496"><span data-slate-object="text" data-key="8497"><span data-slate-leaf="true" data-offset-key="8497:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8498"><span data-slate-leaf="true" data-offset-key="8498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8499"><span data-slate-leaf="true" data-offset-key="8499:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8500"><span data-slate-leaf="true" data-offset-key="8500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8501"><span data-slate-object="text" data-key="8502"><span data-slate-leaf="true" data-offset-key="8502:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8503"><span data-slate-object="text" data-key="8504"><span data-slate-leaf="true" data-offset-key="8504:0" data-first-offset="true"><span data-slate-string="true">AuthFunc 函数依次执行了以下四大步来完成 JWT 认证，每一步中又有一些小步骤，下面我们来一起看看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8505"><span data-slate-object="text" data-key="8506"><span data-slate-leaf="true" data-offset-key="8506:0" data-first-offset="true"><span data-slate-string="true">第一步，从 Authorization: Bearer XX.YY.ZZ 请求头中获取 XX.YY.ZZ，XX.YY.ZZ 即为 JWT Token。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8507"><span data-slate-object="text" data-key="8508"><span data-slate-leaf="true" data-offset-key="8508:0" data-first-offset="true"><span data-slate-string="true">第二步，调用 github.com/dgrijalva/jwt-go 包提供的 ParseWithClaims 函数，该函数会依次执行下面四步操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8509"><span data-slate-object="text" data-key="8510"><span data-slate-leaf="true" data-offset-key="8510:0" data-first-offset="true"><span data-slate-string="true">调用 ParseUnverified 函数，依次执行以下操作：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8511"><span data-slate-object="text" data-key="8512"><span data-slate-leaf="true" data-offset-key="8512:0" data-first-offset="true"><span data-slate-string="true">从 Token 中获取第一段 XX，base64 解码后得到 JWT Token 的 Header {“alg”:“HS256”,“kid”:“a45yPqUnQ8gljH43jAGQdRo0bXzNLjlU0hxa”,“typ”:“JWT”}。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8513"><span data-slate-object="text" data-key="8514"><span data-slate-leaf="true" data-offset-key="8514:0" data-first-offset="true"><span data-slate-string="true">从 Token 中获取第二段 YY，base64 解码后得到 JWT Token 的 Payload {“aud”:“iam.authz.marmotedu.com”,“exp”:1625104314,“iat”:1625097114,“iss”:“iamctl”,“nbf”:1625097114}。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8515"><span data-slate-object="text" data-key="8516"><span data-slate-leaf="true" data-offset-key="8516:0" data-first-offset="true"><span data-slate-string="true">根据 Token Header 中的 alg 字段，获取 Token 加密函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8517"><span data-slate-object="text" data-key="8518"><span data-slate-leaf="true" data-offset-key="8518:0" data-first-offset="true"><span data-slate-string="true">最终 ParseUnverified 函数会返回 Token 类型的变量，Token 类型包含 Method、Header、Claims、Valid 这些重要字段，这些字段会用于后续的认证步骤中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8519"><span data-slate-object="text" data-key="8520"><span data-slate-leaf="true" data-offset-key="8520:0" data-first-offset="true"><span data-slate-string="true">调用传入的 keyFunc 获取密钥，这里来看下 keyFunc 的实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8521"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8522"><span data-slate-object="text" data-key="8523"><span data-slate-leaf="true" data-offset-key="8523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8524"><span data-slate-leaf="true" data-offset-key="8524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(token *jwt.Token)</span></span></span></span></span><span data-slate-object="text" data-key="8525"><span data-slate-leaf="true" data-offset-key="8525:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="8526"><span data-slate-leaf="true" data-offset-key="8526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="8527"><span data-slate-leaf="true" data-offset-key="8527:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="8528"><span data-slate-leaf="true" data-offset-key="8528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="8529"><span data-slate-leaf="true" data-offset-key="8529:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8530"><span data-slate-object="text" data-key="8531"><span data-slate-leaf="true" data-offset-key="8531:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8532"><span data-slate-leaf="true" data-offset-key="8532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Validate the alg is HMAC signature</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8533"><span data-slate-object="text" data-key="8534"><span data-slate-leaf="true" data-offset-key="8534:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8535"><span data-slate-leaf="true" data-offset-key="8535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8536"><span data-slate-leaf="true" data-offset-key="8536:0" data-first-offset="true"><span data-slate-string="true"> _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8537"><span data-slate-object="text" data-key="8538"><span data-slate-leaf="true" data-offset-key="8538:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8539"><span data-slate-leaf="true" data-offset-key="8539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8540"><span data-slate-leaf="true" data-offset-key="8540:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8541"><span data-slate-leaf="true" data-offset-key="8541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8542"><span data-slate-leaf="true" data-offset-key="8542:0" data-first-offset="true"><span data-slate-string="true">, fmt.Errorf(</span></span></span><span data-slate-object="text" data-key="8543"><span data-slate-leaf="true" data-offset-key="8543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"unexpected signing method: %v"</span></span></span></span><span data-slate-object="text" data-key="8544"><span data-slate-leaf="true" data-offset-key="8544:0" data-first-offset="true"><span data-slate-string="true">, token.Header[</span></span></span><span data-slate-object="text" data-key="8545"><span data-slate-leaf="true" data-offset-key="8545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"alg"</span></span></span></span><span data-slate-object="text" data-key="8546"><span data-slate-leaf="true" data-offset-key="8546:0" data-first-offset="true"><span data-slate-string="true">])</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8547"><span data-slate-object="text" data-key="8548"><span data-slate-leaf="true" data-offset-key="8548:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8549"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8550"><span data-slate-object="text" data-key="8551"><span data-slate-leaf="true" data-offset-key="8551:0" data-first-offset="true"><span data-slate-string="true">  kid, ok := token.Header[</span></span></span><span data-slate-object="text" data-key="8552"><span data-slate-leaf="true" data-offset-key="8552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"kid"</span></span></span></span><span data-slate-object="text" data-key="8553"><span data-slate-leaf="true" data-offset-key="8553:0" data-first-offset="true"><span data-slate-string="true">].(</span></span></span><span data-slate-object="text" data-key="8554"><span data-slate-leaf="true" data-offset-key="8554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="8555"><span data-slate-leaf="true" data-offset-key="8555:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8556"><span data-slate-object="text" data-key="8557"><span data-slate-leaf="true" data-offset-key="8557:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8558"><span data-slate-leaf="true" data-offset-key="8558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8559"><span data-slate-leaf="true" data-offset-key="8559:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8560"><span data-slate-object="text" data-key="8561"><span data-slate-leaf="true" data-offset-key="8561:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8562"><span data-slate-leaf="true" data-offset-key="8562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8563"><span data-slate-leaf="true" data-offset-key="8563:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8564"><span data-slate-leaf="true" data-offset-key="8564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8565"><span data-slate-leaf="true" data-offset-key="8565:0" data-first-offset="true"><span data-slate-string="true">, ErrMissingKID</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8566"><span data-slate-object="text" data-key="8567"><span data-slate-leaf="true" data-offset-key="8567:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8568"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8569"><span data-slate-object="text" data-key="8570"><span data-slate-leaf="true" data-offset-key="8570:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8571"><span data-slate-leaf="true" data-offset-key="8571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="8572"><span data-slate-leaf="true" data-offset-key="8572:0" data-first-offset="true"><span data-slate-string="true"> err </span></span></span><span data-slate-object="text" data-key="8573"><span data-slate-leaf="true" data-offset-key="8573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8574"><span data-slate-object="text" data-key="8575"><span data-slate-leaf="true" data-offset-key="8575:0" data-first-offset="true"><span data-slate-string="true">  secret, err = cache.get(kid)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8576"><span data-slate-object="text" data-key="8577"><span data-slate-leaf="true" data-offset-key="8577:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8578"><span data-slate-leaf="true" data-offset-key="8578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8579"><span data-slate-leaf="true" data-offset-key="8579:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="8580"><span data-slate-leaf="true" data-offset-key="8580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8581"><span data-slate-leaf="true" data-offset-key="8581:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8582"><span data-slate-object="text" data-key="8583"><span data-slate-leaf="true" data-offset-key="8583:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8584"><span data-slate-leaf="true" data-offset-key="8584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8585"><span data-slate-leaf="true" data-offset-key="8585:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8586"><span data-slate-leaf="true" data-offset-key="8586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8587"><span data-slate-leaf="true" data-offset-key="8587:0" data-first-offset="true"><span data-slate-string="true">, ErrMissingSecret</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8588"><span data-slate-object="text" data-key="8589"><span data-slate-leaf="true" data-offset-key="8589:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8590"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8591"><span data-slate-object="text" data-key="8592"><span data-slate-leaf="true" data-offset-key="8592:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8593"><span data-slate-leaf="true" data-offset-key="8593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8594"><span data-slate-leaf="true" data-offset-key="8594:0" data-first-offset="true"><span data-slate-string="true"> []</span></span></span><span data-slate-object="text" data-key="8595"><span data-slate-leaf="true" data-offset-key="8595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="8596"><span data-slate-leaf="true" data-offset-key="8596:0" data-first-offset="true"><span data-slate-string="true">(secret.Key), </span></span></span><span data-slate-object="text" data-key="8597"><span data-slate-leaf="true" data-offset-key="8597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8598"><span data-slate-object="text" data-key="8599"><span data-slate-leaf="true" data-offset-key="8599:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8600"><span data-slate-object="text" data-key="8601"><span data-slate-leaf="true" data-offset-key="8601:0" data-first-offset="true"><span data-slate-string="true">可以看到，keyFunc 接受 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8602"><span data-slate-object="text" data-key="8603"><span data-slate-leaf="true" data-offset-key="8603:0" data-first-offset="true"><span data-slate-string="true">*Token</span></span></span></span><span data-slate-object="text" data-key="8604"><span data-slate-leaf="true" data-offset-key="8604:0" data-first-offset="true"><span data-slate-string="true"> 类型的变量，并获取 Token Header 中的 kid，kid 即为密钥 ID：secretID。接着，调用 cache.get (kid) 获取密钥 secretKey。cache.get 函数即为 getSecretFunc，getSecretFunc 函数会根据 kid，从内存中查找密钥信息，密钥信息中包含了 secretKey。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="8605"><div data-slate-type="list-line" data-slate-object="block" data-key="8606"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="8607"><span data-slate-leaf="true" data-offset-key="8607:0" data-first-offset="true"><span data-slate-string="true">从 Token 中获取 Signature 签名字符串 ZZ，也即 Token 的第三段。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="8608"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="8609"><span data-slate-leaf="true" data-offset-key="8609:0" data-first-offset="true"><span data-slate-string="true">获取到 secretKey 之后，token.Method.Verify 验证 Signature 签名字符串 ZZ，也即 Token 的第三段是否合法。token.Method.Verify 实际上是使用了相同的加密算法和相同的 secretKey 加密 XX.YY 字符串。假设加密之后的字符串为 WW，接下来会用 WW 和 ZZ base64 解码后的字符串进行比较，如果相等则认证通过，如果不相等则认证失败。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8610"><span data-slate-object="text" data-key="8611"><span data-slate-leaf="true" data-offset-key="8611:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第三步，</span></span></span></span><span data-slate-object="text" data-key="8612"><span data-slate-leaf="true" data-offset-key="8612:0" data-first-offset="true"><span data-slate-string="true">调用 KeyExpired，验证 secret 是否过期。secret 信息中包含过期时间，你只需要拿该过期时间和当前时间对比就行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8613"><span data-slate-object="text" data-key="8614"><span data-slate-leaf="true" data-offset-key="8614:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第四步，</span></span></span></span><span data-slate-object="text" data-key="8615"><span data-slate-leaf="true" data-offset-key="8615:0" data-first-offset="true"><span data-slate-string="true">设置 HTTP Header</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8616"><span data-slate-object="text" data-key="8617"><span data-slate-leaf="true" data-offset-key="8617:0" data-first-offset="true"><span data-slate-string="true">username: colin</span></span></span></span><span data-slate-object="text" data-key="8618"><span data-slate-leaf="true" data-offset-key="8618:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8619"><span data-slate-object="text" data-key="8620"><span data-slate-leaf="true" data-offset-key="8620:0" data-first-offset="true"><span data-slate-string="true">到这里，iam-authz-server 的 Bearer 认证分析就完成了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8621"><span data-slate-object="text" data-key="8622"><span data-slate-leaf="true" data-offset-key="8622:0" data-first-offset="true"><span data-slate-string="true">我们来做个总结：iam-authz-server 通过加载 Gin 中间件的方式，在请求</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8623"><span data-slate-object="text" data-key="8624"><span data-slate-leaf="true" data-offset-key="8624:0" data-first-offset="true"><span data-slate-string="true"> /v1/authz</span></span></span></span><span data-slate-object="text" data-key="8625"><span data-slate-leaf="true" data-offset-key="8625:0" data-first-offset="true"><span data-slate-string="true"> 接口时进行访问认证。因为 Bearer 认证具有过期时间，而且可以在认证字符串中携带更多有用信息，还具有不可逆加密等优点，所以 </span></span></span><span data-slate-object="text" data-key="8626"><span data-slate-leaf="true" data-offset-key="8626:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">/v1/authz 采用了 Bearer 认证，Token 格式采用了 JWT 格式</span></span></span></span><span data-slate-object="text" data-key="8627"><span data-slate-leaf="true" data-offset-key="8627:0" data-first-offset="true"><span data-slate-string="true">，这也是业界在 API 认证中最受欢迎的认证方式。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8628"><span data-slate-object="text" data-key="8629"><span data-slate-leaf="true" data-offset-key="8629:0" data-first-offset="true"><span data-slate-string="true">Bearer 认证需要 secretID 和 secretKey，这些信息会通过 gRPC 接口调用，从 iam-apisaerver 中获取，并缓存在 iam-authz-server 的内存中供认证时查询使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8630"><span data-slate-object="text" data-key="8631"><span data-slate-leaf="true" data-offset-key="8631:0" data-first-offset="true"><span data-slate-string="true">当请求来临时，iam-authz-server Bearer 认证中间件从 JWT Token 中解析出 Header，并从 Header 的 kid 字段中获取到 secretID，根据 secretID 查找到 secretKey，最后使用 secretKey 加密 JWT Token 的 Header 和 Payload，并与 Signature 部分进行对比。如果相等，则认证通过；如果不等，则认证失败。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="8632" id="sr-toc-5"><span data-slate-object="text" data-key="8633"><span data-slate-leaf="true" data-offset-key="8633:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver Bearer 认证实现</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="8634"><span data-slate-object="text" data-key="8635"><span data-slate-leaf="true" data-offset-key="8635:0" data-first-offset="true"><span data-slate-string="true">再来看下 iam-apiserver 的 Bearer 认证。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8636"><span data-slate-object="text" data-key="8637"><span data-slate-leaf="true" data-offset-key="8637:0" data-first-offset="true"><span data-slate-string="true">iam-apiserver 的 Bearer 认证通过以下代码（位于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8638"><span data-slate-object="text" data-key="8639"><span data-slate-leaf="true" data-offset-key="8639:0" data-first-offset="true"><span data-slate-string="true">router.go</span></span></span></a><span data-slate-object="text" data-key="8640"><span data-slate-leaf="true" data-offset-key="8640:0" data-first-offset="true"><span data-slate-string="true"> 文件中）指定使用了 auto 认证策略：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="8641"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8642"><span data-slate-object="text" data-key="8643"><span data-slate-leaf="true" data-offset-key="8643:0" data-first-offset="true"><span data-slate-string="true">v1.</span></span></span><span data-slate-object="text" data-key="8644"><span data-slate-leaf="true" data-offset-key="8644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Use</span></span></span></span><span data-slate-object="text" data-key="8645"><span data-slate-leaf="true" data-offset-key="8645:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="8646"><span data-slate-leaf="true" data-offset-key="8646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">auto</span></span></span></span><span data-slate-object="text" data-key="8647"><span data-slate-leaf="true" data-offset-key="8647:0" data-first-offset="true"><span data-slate-string="true">.</span></span></span><span data-slate-object="text" data-key="8648"><span data-slate-leaf="true" data-offset-key="8648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AuthFunc</span></span></span></span><span data-slate-object="text" data-key="8649"><span data-slate-leaf="true" data-offset-key="8649:0" data-first-offset="true"><span data-slate-string="true">())</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8650"><span data-slate-object="text" data-key="8651"><span data-slate-leaf="true" data-offset-key="8651:0" data-first-offset="true"><span data-slate-string="true">我们来看下 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8652"><span data-slate-object="text" data-key="8653"><span data-slate-leaf="true" data-offset-key="8653:0" data-first-offset="true"><span data-slate-string="true">auto.AuthFunc()</span></span></span></a><span data-slate-object="text" data-key="8654"><span data-slate-leaf="true" data-offset-key="8654:0" data-first-offset="true"><span data-slate-string="true"> 的实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8655"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8656"><span data-slate-object="text" data-key="8657"><span data-slate-leaf="true" data-offset-key="8657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8658"><span data-slate-leaf="true" data-offset-key="8658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8659"><span data-slate-leaf="true" data-offset-key="8659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(a AutoStrategy)</span></span></span></span></span><span data-slate-object="text" data-key="8660"><span data-slate-leaf="true" data-offset-key="8660:0" data-first-offset="true"><span data-slate-string="true"> AuthFunc() gin.HandlerFunc {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8661"><span data-slate-object="text" data-key="8662"><span data-slate-leaf="true" data-offset-key="8662:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8663"><span data-slate-leaf="true" data-offset-key="8663:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8664"><span data-slate-leaf="true" data-offset-key="8664:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8665"><span data-slate-leaf="true" data-offset-key="8665:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8666"><span data-slate-leaf="true" data-offset-key="8666:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *gin.Context)</span></span></span></span></span><span data-slate-object="text" data-key="8667"><span data-slate-leaf="true" data-offset-key="8667:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8668"><span data-slate-object="text" data-key="8669"><span data-slate-leaf="true" data-offset-key="8669:0" data-first-offset="true"><span data-slate-string="true">    operator := middleware.AuthOperator{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8670"><span data-slate-object="text" data-key="8671"><span data-slate-leaf="true" data-offset-key="8671:0" data-first-offset="true"><span data-slate-string="true">    authHeader := strings.SplitN(c.Request.Header.Get(</span></span></span><span data-slate-object="text" data-key="8672"><span data-slate-leaf="true" data-offset-key="8672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization"</span></span></span></span><span data-slate-object="text" data-key="8673"><span data-slate-leaf="true" data-offset-key="8673:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="8674"><span data-slate-leaf="true" data-offset-key="8674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">" "</span></span></span></span><span data-slate-object="text" data-key="8675"><span data-slate-leaf="true" data-offset-key="8675:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="8676"><span data-slate-leaf="true" data-offset-key="8676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="8677"><span data-slate-leaf="true" data-offset-key="8677:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8678"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8679"><span data-slate-object="text" data-key="8680"><span data-slate-leaf="true" data-offset-key="8680:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8681"><span data-slate-leaf="true" data-offset-key="8681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8682"><span data-slate-leaf="true" data-offset-key="8682:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8683"><span data-slate-leaf="true" data-offset-key="8683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="8684"><span data-slate-leaf="true" data-offset-key="8684:0" data-first-offset="true"><span data-slate-string="true">(authHeader) != authHeaderCount {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8685"><span data-slate-object="text" data-key="8686"><span data-slate-leaf="true" data-offset-key="8686:0" data-first-offset="true"><span data-slate-string="true">      core.WriteResponse(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8687"><span data-slate-object="text" data-key="8688"><span data-slate-leaf="true" data-offset-key="8688:0" data-first-offset="true"><span data-slate-string="true">        c,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8689"><span data-slate-object="text" data-key="8690"><span data-slate-leaf="true" data-offset-key="8690:0" data-first-offset="true"><span data-slate-string="true">        errors.WithCode(code.ErrInvalidAuthHeader, </span></span></span><span data-slate-object="text" data-key="8691"><span data-slate-leaf="true" data-offset-key="8691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization header format is wrong."</span></span></span></span><span data-slate-object="text" data-key="8692"><span data-slate-leaf="true" data-offset-key="8692:0" data-first-offset="true"><span data-slate-string="true">),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8693"><span data-slate-object="text" data-key="8694"><span data-slate-leaf="true" data-offset-key="8694:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="8695"><span data-slate-leaf="true" data-offset-key="8695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8696"><span data-slate-leaf="true" data-offset-key="8696:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8697"><span data-slate-object="text" data-key="8698"><span data-slate-leaf="true" data-offset-key="8698:0" data-first-offset="true"><span data-slate-string="true">      )</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8699"><span data-slate-object="text" data-key="8700"><span data-slate-leaf="true" data-offset-key="8700:0" data-first-offset="true"><span data-slate-string="true">      c.Abort()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8701"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8702"><span data-slate-object="text" data-key="8703"><span data-slate-leaf="true" data-offset-key="8703:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8704"><span data-slate-leaf="true" data-offset-key="8704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8705"><span data-slate-object="text" data-key="8706"><span data-slate-leaf="true" data-offset-key="8706:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8707"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8708"><span data-slate-object="text" data-key="8709"><span data-slate-leaf="true" data-offset-key="8709:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8710"><span data-slate-leaf="true" data-offset-key="8710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">switch</span></span></span></span><span data-slate-object="text" data-key="8711"><span data-slate-leaf="true" data-offset-key="8711:0" data-first-offset="true"><span data-slate-string="true"> authHeader[</span></span></span><span data-slate-object="text" data-key="8712"><span data-slate-leaf="true" data-offset-key="8712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="8713"><span data-slate-leaf="true" data-offset-key="8713:0" data-first-offset="true"><span data-slate-string="true">] {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8714"><span data-slate-object="text" data-key="8715"><span data-slate-leaf="true" data-offset-key="8715:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8716"><span data-slate-leaf="true" data-offset-key="8716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8717"><span data-slate-leaf="true" data-offset-key="8717:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8718"><span data-slate-leaf="true" data-offset-key="8718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Basic"</span></span></span></span><span data-slate-object="text" data-key="8719"><span data-slate-leaf="true" data-offset-key="8719:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8720"><span data-slate-object="text" data-key="8721"><span data-slate-leaf="true" data-offset-key="8721:0" data-first-offset="true"><span data-slate-string="true">      operator.SetStrategy(a.basic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8722"><span data-slate-object="text" data-key="8723"><span data-slate-leaf="true" data-offset-key="8723:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8724"><span data-slate-leaf="true" data-offset-key="8724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="8725"><span data-slate-leaf="true" data-offset-key="8725:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8726"><span data-slate-leaf="true" data-offset-key="8726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Bearer"</span></span></span></span><span data-slate-object="text" data-key="8727"><span data-slate-leaf="true" data-offset-key="8727:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8728"><span data-slate-object="text" data-key="8729"><span data-slate-leaf="true" data-offset-key="8729:0" data-first-offset="true"><span data-slate-string="true">      operator.SetStrategy(a.jwt)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8730"><span data-slate-object="text" data-key="8731"><span data-slate-leaf="true" data-offset-key="8731:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8732"><span data-slate-leaf="true" data-offset-key="8732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// a.JWT.MiddlewareFunc()(c)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8733"><span data-slate-object="text" data-key="8734"><span data-slate-leaf="true" data-offset-key="8734:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8735"><span data-slate-leaf="true" data-offset-key="8735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="8736"><span data-slate-leaf="true" data-offset-key="8736:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8737"><span data-slate-object="text" data-key="8738"><span data-slate-leaf="true" data-offset-key="8738:0" data-first-offset="true"><span data-slate-string="true">      core.WriteResponse(c, errors.WithCode(code.ErrSignatureInvalid, </span></span></span><span data-slate-object="text" data-key="8739"><span data-slate-leaf="true" data-offset-key="8739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"unrecognized Authorization header."</span></span></span></span><span data-slate-object="text" data-key="8740"><span data-slate-leaf="true" data-offset-key="8740:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="8741"><span data-slate-leaf="true" data-offset-key="8741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8742"><span data-slate-leaf="true" data-offset-key="8742:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8743"><span data-slate-object="text" data-key="8744"><span data-slate-leaf="true" data-offset-key="8744:0" data-first-offset="true"><span data-slate-string="true">      c.Abort()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8745"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8746"><span data-slate-object="text" data-key="8747"><span data-slate-leaf="true" data-offset-key="8747:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="8748"><span data-slate-leaf="true" data-offset-key="8748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8749"><span data-slate-object="text" data-key="8750"><span data-slate-leaf="true" data-offset-key="8750:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8751"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8752"><span data-slate-object="text" data-key="8753"><span data-slate-leaf="true" data-offset-key="8753:0" data-first-offset="true"><span data-slate-string="true">    operator.AuthFunc()(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8754"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8755"><span data-slate-object="text" data-key="8756"><span data-slate-leaf="true" data-offset-key="8756:0" data-first-offset="true"><span data-slate-string="true">    c.Next()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8757"><span data-slate-object="text" data-key="8758"><span data-slate-leaf="true" data-offset-key="8758:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8759"><span data-slate-object="text" data-key="8760"><span data-slate-leaf="true" data-offset-key="8760:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8761"><span data-slate-object="text" data-key="8762"><span data-slate-leaf="true" data-offset-key="8762:0" data-first-offset="true"><span data-slate-string="true">从上面代码中可以看到，AuthFunc 函数会从 Authorization Header 中解析出认证方式是 Basic 还是 Bearer。如果是 Bearer，就会使用 JWT 认证策略；如果是 Basic，就会使用 Basic 认证策略。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8763"><span data-slate-object="text" data-key="8764"><span data-slate-leaf="true" data-offset-key="8764:0" data-first-offset="true"><span data-slate-string="true">我们再来看下 JWT 认证策略的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8765"><span data-slate-object="text" data-key="8766"><span data-slate-leaf="true" data-offset-key="8766:0" data-first-offset="true"><span data-slate-string="true">AuthFunc</span></span></span></a><span data-slate-object="text" data-key="8767"><span data-slate-leaf="true" data-offset-key="8767:0" data-first-offset="true"><span data-slate-string="true"> 函数实现：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8768"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8769"><span data-slate-object="text" data-key="8770"><span data-slate-leaf="true" data-offset-key="8770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8771"><span data-slate-leaf="true" data-offset-key="8771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8772"><span data-slate-leaf="true" data-offset-key="8772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(j JWTStrategy)</span></span></span></span></span><span data-slate-object="text" data-key="8773"><span data-slate-leaf="true" data-offset-key="8773:0" data-first-offset="true"><span data-slate-string="true"> AuthFunc() gin.HandlerFunc {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8774"><span data-slate-object="text" data-key="8775"><span data-slate-leaf="true" data-offset-key="8775:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8776"><span data-slate-leaf="true" data-offset-key="8776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8777"><span data-slate-leaf="true" data-offset-key="8777:0" data-first-offset="true"><span data-slate-string="true"> j.MiddlewareFunc()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8778"><span data-slate-object="text" data-key="8779"><span data-slate-leaf="true" data-offset-key="8779:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8780"><span data-slate-object="text" data-key="8781"><span data-slate-leaf="true" data-offset-key="8781:0" data-first-offset="true"><span data-slate-string="true">我们跟随代码，可以定位到</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8782"><span data-slate-object="text" data-key="8783"><span data-slate-leaf="true" data-offset-key="8783:0" data-first-offset="true"><span data-slate-string="true"> MiddlewareFunc</span></span></span></span><span data-slate-object="text" data-key="8784"><span data-slate-leaf="true" data-offset-key="8784:0" data-first-offset="true"><span data-slate-string="true"> 函数最终调用了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8785"><span data-slate-object="text" data-key="8786"><span data-slate-leaf="true" data-offset-key="8786:0" data-first-offset="true"><span data-slate-string="true"> github.com/appleboy/gin-jwt</span></span></span></span><span data-slate-object="text" data-key="8787"><span data-slate-leaf="true" data-offset-key="8787:0" data-first-offset="true"><span data-slate-string="true"> 包</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8788"><span data-slate-object="text" data-key="8789"><span data-slate-leaf="true" data-offset-key="8789:0" data-first-offset="true"><span data-slate-string="true"> GinJWTMiddleware</span></span></span></span><span data-slate-object="text" data-key="8790"><span data-slate-leaf="true" data-offset-key="8790:0" data-first-offset="true"><span data-slate-string="true"> 结构体的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8791"><span data-slate-object="text" data-key="8792"><span data-slate-leaf="true" data-offset-key="8792:0" data-first-offset="true"><span data-slate-string="true">middlewareImpl</span></span></span></a><span data-slate-object="text" data-key="8793"><span data-slate-leaf="true" data-offset-key="8793:0" data-first-offset="true"><span data-slate-string="true"> 方法：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8794"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8795"><span data-slate-object="text" data-key="8796"><span data-slate-leaf="true" data-offset-key="8796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8797"><span data-slate-leaf="true" data-offset-key="8797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8798"><span data-slate-leaf="true" data-offset-key="8798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(mw *GinJWTMiddleware)</span></span></span></span></span><span data-slate-object="text" data-key="8799"><span data-slate-leaf="true" data-offset-key="8799:0" data-first-offset="true"><span data-slate-string="true"> middlewareImpl(c *gin.Context) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8800"><span data-slate-object="text" data-key="8801"><span data-slate-leaf="true" data-offset-key="8801:0" data-first-offset="true"><span data-slate-string="true">  claims, err := mw.GetClaimsFromJWT(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8802"><span data-slate-object="text" data-key="8803"><span data-slate-leaf="true" data-offset-key="8803:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8804"><span data-slate-leaf="true" data-offset-key="8804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8805"><span data-slate-leaf="true" data-offset-key="8805:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="8806"><span data-slate-leaf="true" data-offset-key="8806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8807"><span data-slate-leaf="true" data-offset-key="8807:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8808"><span data-slate-object="text" data-key="8809"><span data-slate-leaf="true" data-offset-key="8809:0" data-first-offset="true"><span data-slate-string="true">    mw.unauthorized(c, http.StatusUnauthorized, mw.HTTPStatusMessageFunc(err, c))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8810"><span data-slate-object="text" data-key="8811"><span data-slate-leaf="true" data-offset-key="8811:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8812"><span data-slate-leaf="true" data-offset-key="8812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8813"><span data-slate-object="text" data-key="8814"><span data-slate-leaf="true" data-offset-key="8814:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8815"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8816"><span data-slate-object="text" data-key="8817"><span data-slate-leaf="true" data-offset-key="8817:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8818"><span data-slate-leaf="true" data-offset-key="8818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8819"><span data-slate-leaf="true" data-offset-key="8819:0" data-first-offset="true"><span data-slate-string="true"> claims[</span></span></span><span data-slate-object="text" data-key="8820"><span data-slate-leaf="true" data-offset-key="8820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exp"</span></span></span></span><span data-slate-object="text" data-key="8821"><span data-slate-leaf="true" data-offset-key="8821:0" data-first-offset="true"><span data-slate-string="true">] == </span></span></span><span data-slate-object="text" data-key="8822"><span data-slate-leaf="true" data-offset-key="8822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8823"><span data-slate-leaf="true" data-offset-key="8823:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8824"><span data-slate-object="text" data-key="8825"><span data-slate-leaf="true" data-offset-key="8825:0" data-first-offset="true"><span data-slate-string="true">    mw.unauthorized(c, http.StatusBadRequest, mw.HTTPStatusMessageFunc(ErrMissingExpField, c))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8826"><span data-slate-object="text" data-key="8827"><span data-slate-leaf="true" data-offset-key="8827:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8828"><span data-slate-leaf="true" data-offset-key="8828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8829"><span data-slate-object="text" data-key="8830"><span data-slate-leaf="true" data-offset-key="8830:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8831"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8832"><span data-slate-object="text" data-key="8833"><span data-slate-leaf="true" data-offset-key="8833:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8834"><span data-slate-leaf="true" data-offset-key="8834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8835"><span data-slate-leaf="true" data-offset-key="8835:0" data-first-offset="true"><span data-slate-string="true"> _, ok := claims[</span></span></span><span data-slate-object="text" data-key="8836"><span data-slate-leaf="true" data-offset-key="8836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exp"</span></span></span></span><span data-slate-object="text" data-key="8837"><span data-slate-leaf="true" data-offset-key="8837:0" data-first-offset="true"><span data-slate-string="true">].(</span></span></span><span data-slate-object="text" data-key="8838"><span data-slate-leaf="true" data-offset-key="8838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">float64</span></span></span></span><span data-slate-object="text" data-key="8839"><span data-slate-leaf="true" data-offset-key="8839:0" data-first-offset="true"><span data-slate-string="true">); !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8840"><span data-slate-object="text" data-key="8841"><span data-slate-leaf="true" data-offset-key="8841:0" data-first-offset="true"><span data-slate-string="true">    mw.unauthorized(c, http.StatusBadRequest, mw.HTTPStatusMessageFunc(ErrWrongFormatOfExp, c))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8842"><span data-slate-object="text" data-key="8843"><span data-slate-leaf="true" data-offset-key="8843:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8844"><span data-slate-leaf="true" data-offset-key="8844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8845"><span data-slate-object="text" data-key="8846"><span data-slate-leaf="true" data-offset-key="8846:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8847"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8848"><span data-slate-object="text" data-key="8849"><span data-slate-leaf="true" data-offset-key="8849:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8850"><span data-slate-leaf="true" data-offset-key="8850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8851"><span data-slate-leaf="true" data-offset-key="8851:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8852"><span data-slate-leaf="true" data-offset-key="8852:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="8853"><span data-slate-leaf="true" data-offset-key="8853:0" data-first-offset="true"><span data-slate-string="true">(claims[</span></span></span><span data-slate-object="text" data-key="8854"><span data-slate-leaf="true" data-offset-key="8854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"exp"</span></span></span></span><span data-slate-object="text" data-key="8855"><span data-slate-leaf="true" data-offset-key="8855:0" data-first-offset="true"><span data-slate-string="true">].(</span></span></span><span data-slate-object="text" data-key="8856"><span data-slate-leaf="true" data-offset-key="8856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">float64</span></span></span></span><span data-slate-object="text" data-key="8857"><span data-slate-leaf="true" data-offset-key="8857:0" data-first-offset="true"><span data-slate-string="true">)) &lt;mw.TimeFunc().Unix() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8858"><span data-slate-object="text" data-key="8859"><span data-slate-leaf="true" data-offset-key="8859:0" data-first-offset="true"><span data-slate-string="true">    mw.unauthorized(c, http.StatusUnauthorized, mw.HTTPStatusMessageFunc(ErrExpiredToken, c))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8860"><span data-slate-object="text" data-key="8861"><span data-slate-leaf="true" data-offset-key="8861:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8862"><span data-slate-leaf="true" data-offset-key="8862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8863"><span data-slate-object="text" data-key="8864"><span data-slate-leaf="true" data-offset-key="8864:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8865"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8866"><span data-slate-object="text" data-key="8867"><span data-slate-leaf="true" data-offset-key="8867:0" data-first-offset="true"><span data-slate-string="true">  c.Set(</span></span></span><span data-slate-object="text" data-key="8868"><span data-slate-leaf="true" data-offset-key="8868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"JWT_PAYLOAD"</span></span></span></span><span data-slate-object="text" data-key="8869"><span data-slate-leaf="true" data-offset-key="8869:0" data-first-offset="true"><span data-slate-string="true">, claims)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8870"><span data-slate-object="text" data-key="8871"><span data-slate-leaf="true" data-offset-key="8871:0" data-first-offset="true"><span data-slate-string="true">  identity := mw.IdentityHandler(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8872"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8873"><span data-slate-object="text" data-key="8874"><span data-slate-leaf="true" data-offset-key="8874:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8875"><span data-slate-leaf="true" data-offset-key="8875:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8876"><span data-slate-leaf="true" data-offset-key="8876:0" data-first-offset="true"><span data-slate-string="true"> identity != </span></span></span><span data-slate-object="text" data-key="8877"><span data-slate-leaf="true" data-offset-key="8877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8878"><span data-slate-leaf="true" data-offset-key="8878:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8879"><span data-slate-object="text" data-key="8880"><span data-slate-leaf="true" data-offset-key="8880:0" data-first-offset="true"><span data-slate-string="true">    c.Set(mw.IdentityKey, identity)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8881"><span data-slate-object="text" data-key="8882"><span data-slate-leaf="true" data-offset-key="8882:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8883"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8884"><span data-slate-object="text" data-key="8885"><span data-slate-leaf="true" data-offset-key="8885:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="8886"><span data-slate-leaf="true" data-offset-key="8886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8887"><span data-slate-leaf="true" data-offset-key="8887:0" data-first-offset="true"><span data-slate-string="true"> !mw.Authorizator(identity, c) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8888"><span data-slate-object="text" data-key="8889"><span data-slate-leaf="true" data-offset-key="8889:0" data-first-offset="true"><span data-slate-string="true">    mw.unauthorized(c, http.StatusForbidden, mw.HTTPStatusMessageFunc(ErrForbidden, c))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8890"><span data-slate-object="text" data-key="8891"><span data-slate-leaf="true" data-offset-key="8891:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8892"><span data-slate-leaf="true" data-offset-key="8892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8893"><span data-slate-object="text" data-key="8894"><span data-slate-leaf="true" data-offset-key="8894:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8895"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8896"><span data-slate-object="text" data-key="8897"><span data-slate-leaf="true" data-offset-key="8897:0" data-first-offset="true"><span data-slate-string="true">  c.Next()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8898"><span data-slate-object="text" data-key="8899"><span data-slate-leaf="true" data-offset-key="8899:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8900"><span data-slate-object="text" data-key="8901"><span data-slate-leaf="true" data-offset-key="8901:0" data-first-offset="true"><span data-slate-string="true">分析上面的代码，我们可以知道，middlewareImpl 的 Bearer 认证流程为：</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8902"><span data-slate-object="text" data-key="8903"><span data-slate-leaf="true" data-offset-key="8903:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第一步</span></span></span></span><span data-slate-object="text" data-key="8904"><span data-slate-leaf="true" data-offset-key="8904:0" data-first-offset="true"><span data-slate-string="true">：调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8905"><span data-slate-object="text" data-key="8906"><span data-slate-leaf="true" data-offset-key="8906:0" data-first-offset="true"><span data-slate-string="true"> GetClaimsFromJWT</span></span></span></span><span data-slate-object="text" data-key="8907"><span data-slate-leaf="true" data-offset-key="8907:0" data-first-offset="true"><span data-slate-string="true"> 函数，从 HTTP 请求中获取 Authorization Header，并解析出 Token 字符串，进行认证，最后返回 Token Payload。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8908"><span data-slate-object="text" data-key="8909"><span data-slate-leaf="true" data-offset-key="8909:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第二步</span></span></span></span><span data-slate-object="text" data-key="8910"><span data-slate-leaf="true" data-offset-key="8910:0" data-first-offset="true"><span data-slate-string="true">：校验 Payload 中的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8911"><span data-slate-object="text" data-key="8912"><span data-slate-leaf="true" data-offset-key="8912:0" data-first-offset="true"><span data-slate-string="true"> exp</span></span></span></span><span data-slate-object="text" data-key="8913"><span data-slate-leaf="true" data-offset-key="8913:0" data-first-offset="true"><span data-slate-string="true"> 是否超过当前时间，如果超过就说明 Token 过期，校验不通过。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8914"><span data-slate-object="text" data-key="8915"><span data-slate-leaf="true" data-offset-key="8915:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第三步</span></span></span></span><span data-slate-object="text" data-key="8916"><span data-slate-leaf="true" data-offset-key="8916:0" data-first-offset="true"><span data-slate-string="true">：给 gin.Context 中添加</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8917"><span data-slate-object="text" data-key="8918"><span data-slate-leaf="true" data-offset-key="8918:0" data-first-offset="true"><span data-slate-string="true"> JWT_PAYLOAD</span></span></span></span><span data-slate-object="text" data-key="8919"><span data-slate-leaf="true" data-offset-key="8919:0" data-first-offset="true"><span data-slate-string="true"> 键，供后续程序使用（当然也可能用不到）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8920"><span data-slate-object="text" data-key="8921"><span data-slate-leaf="true" data-offset-key="8921:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第四步</span></span></span></span><span data-slate-object="text" data-key="8922"><span data-slate-leaf="true" data-offset-key="8922:0" data-first-offset="true"><span data-slate-string="true">：通过以下代码，在 gin.Context 中添加 IdentityKey 键，IdentityKey 键可以在创建</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8923"><span data-slate-object="text" data-key="8924"><span data-slate-leaf="true" data-offset-key="8924:0" data-first-offset="true"><span data-slate-string="true"> GinJWTMiddleware</span></span></span></span><span data-slate-object="text" data-key="8925"><span data-slate-leaf="true" data-offset-key="8925:0" data-first-offset="true"><span data-slate-string="true"> 结构体时指定，这里我们设置为</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8926"><span data-slate-object="text" data-key="8927"><span data-slate-leaf="true" data-offset-key="8927:0" data-first-offset="true"><span data-slate-string="true"> middleware.UsernameKey</span></span></span></span><span data-slate-object="text" data-key="8928"><span data-slate-leaf="true" data-offset-key="8928:0" data-first-offset="true"><span data-slate-string="true">，也就是 username。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8929"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8930"><span data-slate-object="text" data-key="8931"><span data-slate-leaf="true" data-offset-key="8931:0" data-first-offset="true"><span data-slate-string="true">identity := mw.IdentityHandler(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8932"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8933"><span data-slate-object="text" data-key="8934"><span data-slate-leaf="true" data-offset-key="8934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="8935"><span data-slate-leaf="true" data-offset-key="8935:0" data-first-offset="true"><span data-slate-string="true"> identity != </span></span></span><span data-slate-object="text" data-key="8936"><span data-slate-leaf="true" data-offset-key="8936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="8937"><span data-slate-leaf="true" data-offset-key="8937:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8938"><span data-slate-object="text" data-key="8939"><span data-slate-leaf="true" data-offset-key="8939:0" data-first-offset="true"><span data-slate-string="true">    c.Set(mw.IdentityKey, identity)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8940"><span data-slate-object="text" data-key="8941"><span data-slate-leaf="true" data-offset-key="8941:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8942"><span data-slate-object="text" data-key="8943"><span data-slate-leaf="true" data-offset-key="8943:0" data-first-offset="true"><span data-slate-string="true">IdentityKey 键的值由 IdentityHandler 函数返回，IdentityHandler 函数为：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8944"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8945"><span data-slate-object="text" data-key="8946"><span data-slate-leaf="true" data-offset-key="8946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8947"><span data-slate-leaf="true" data-offset-key="8947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *gin.Context)</span></span></span></span></span><span data-slate-object="text" data-key="8948"><span data-slate-leaf="true" data-offset-key="8948:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8949"><span data-slate-leaf="true" data-offset-key="8949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="8950"><span data-slate-leaf="true" data-offset-key="8950:0" data-first-offset="true"><span data-slate-string="true">{} {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8951"><span data-slate-object="text" data-key="8952"><span data-slate-leaf="true" data-offset-key="8952:0" data-first-offset="true"><span data-slate-string="true">    claims := jwt.ExtractClaims(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8953"></div><div data-slate-type="code-line" data-slate-object="block" data-key="8954"><span data-slate-object="text" data-key="8955"><span data-slate-leaf="true" data-offset-key="8955:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8956"><span data-slate-leaf="true" data-offset-key="8956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8957"><span data-slate-leaf="true" data-offset-key="8957:0" data-first-offset="true"><span data-slate-string="true"> claims[jwt.IdentityKey]</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8958"><span data-slate-object="text" data-key="8959"><span data-slate-leaf="true" data-offset-key="8959:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8960"><span data-slate-object="text" data-key="8961"><span data-slate-leaf="true" data-offset-key="8961:0" data-first-offset="true"><span data-slate-string="true">上述函数会从 Token 的 Payload 中获取 identity 域的值，identity 域的值是在签发 Token 时指定的，它的值其实是用户名，你可以查看 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="8962"><span data-slate-object="text" data-key="8963"><span data-slate-leaf="true" data-offset-key="8963:0" data-first-offset="true"><span data-slate-string="true">payloadFunc</span></span></span></a><span data-slate-object="text" data-key="8964"><span data-slate-leaf="true" data-offset-key="8964:0" data-first-offset="true"><span data-slate-string="true"> 函数了解。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="8965"><span data-slate-object="text" data-key="8966"><span data-slate-leaf="true" data-offset-key="8966:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第五步</span></span></span></span><span data-slate-object="text" data-key="8967"><span data-slate-leaf="true" data-offset-key="8967:0" data-first-offset="true"><span data-slate-string="true">：接下来，会调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8968"><span data-slate-object="text" data-key="8969"><span data-slate-leaf="true" data-offset-key="8969:0" data-first-offset="true"><span data-slate-string="true"> Authorizator</span></span></span></span><span data-slate-object="text" data-key="8970"><span data-slate-leaf="true" data-offset-key="8970:0" data-first-offset="true"><span data-slate-string="true"> 方法，</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8971"><span data-slate-object="text" data-key="8972"><span data-slate-leaf="true" data-offset-key="8972:0" data-first-offset="true"><span data-slate-string="true">Authorizator</span></span></span></span><span data-slate-object="text" data-key="8973"><span data-slate-leaf="true" data-offset-key="8973:0" data-first-offset="true"><span data-slate-string="true"> 是一个 callback 函数，成功时必须返回真，失败时必须返回假。</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="8974"><span data-slate-object="text" data-key="8975"><span data-slate-leaf="true" data-offset-key="8975:0" data-first-offset="true"><span data-slate-string="true">Authorizator</span></span></span></span><span data-slate-object="text" data-key="8976"><span data-slate-leaf="true" data-offset-key="8976:0" data-first-offset="true"><span data-slate-string="true"> 也是在创建 GinJWTMiddleware 时指定的，例如：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="8977"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="8978"><span data-slate-object="text" data-key="8979"><span data-slate-leaf="true" data-offset-key="8979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8980"><span data-slate-leaf="true" data-offset-key="8980:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="8981"><span data-slate-leaf="true" data-offset-key="8981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">authorizator</span></span></span></span></span><span data-slate-object="text" data-key="8982"><span data-slate-leaf="true" data-offset-key="8982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="8983"><span data-slate-leaf="true" data-offset-key="8983:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8984"><span data-slate-leaf="true" data-offset-key="8984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8985"><span data-slate-leaf="true" data-offset-key="8985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(data </span></span></span></span></span><span data-slate-object="text" data-key="8986"><span data-slate-leaf="true" data-offset-key="8986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span></span></span><span data-slate-object="text" data-key="8987"><span data-slate-leaf="true" data-offset-key="8987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">{}, c *gin.Context)</span></span></span></span></span><span data-slate-object="text" data-key="8988"><span data-slate-leaf="true" data-offset-key="8988:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8989"><span data-slate-leaf="true" data-offset-key="8989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="8990"><span data-slate-leaf="true" data-offset-key="8990:0" data-first-offset="true"><span data-slate-string="true"> {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="8991"><span data-slate-object="text" data-key="8992"><span data-slate-leaf="true" data-offset-key="8992:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="8993"><span data-slate-leaf="true" data-offset-key="8993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="8994"><span data-slate-leaf="true" data-offset-key="8994:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="8995"><span data-slate-leaf="true" data-offset-key="8995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="8996"><span data-slate-leaf="true" data-offset-key="8996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(data </span></span></span></span></span><span data-slate-object="text" data-key="8997"><span data-slate-leaf="true" data-offset-key="8997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span></span></span><span data-slate-object="text" data-key="8998"><span data-slate-leaf="true" data-offset-key="8998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">{}, c *gin.Context)</span></span></span></span></span><span data-slate-object="text" data-key="8999"><span data-slate-leaf="true" data-offset-key="8999:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9000"><span data-slate-leaf="true" data-offset-key="9000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="9001"><span data-slate-leaf="true" data-offset-key="9001:0" data-first-offset="true"><span data-slate-string="true"> {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9002"><span data-slate-object="text" data-key="9003"><span data-slate-leaf="true" data-offset-key="9003:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9004"><span data-slate-leaf="true" data-offset-key="9004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="9005"><span data-slate-leaf="true" data-offset-key="9005:0" data-first-offset="true"><span data-slate-string="true"> v, ok := data.(</span></span></span><span data-slate-object="text" data-key="9006"><span data-slate-leaf="true" data-offset-key="9006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="9007"><span data-slate-leaf="true" data-offset-key="9007:0" data-first-offset="true"><span data-slate-string="true">); ok {    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9008"><span data-slate-object="text" data-key="9009"><span data-slate-leaf="true" data-offset-key="9009:0" data-first-offset="true"><span data-slate-string="true">            log.L(c).Infof(</span></span></span><span data-slate-object="text" data-key="9010"><span data-slate-leaf="true" data-offset-key="9010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"user `%s` is authenticated."</span></span></span></span><span data-slate-object="text" data-key="9011"><span data-slate-leaf="true" data-offset-key="9011:0" data-first-offset="true"><span data-slate-string="true">, v)         </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9012"><span data-slate-object="text" data-key="9013"><span data-slate-leaf="true" data-offset-key="9013:0" data-first-offset="true"><span data-slate-string="true">                                                                     </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9014"><span data-slate-object="text" data-key="9015"><span data-slate-leaf="true" data-offset-key="9015:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="9016"><span data-slate-leaf="true" data-offset-key="9016:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9017"><span data-slate-leaf="true" data-offset-key="9017:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9018"><span data-slate-leaf="true" data-offset-key="9018:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="9019"><span data-slate-leaf="true" data-offset-key="9019:0" data-first-offset="true"><span data-slate-string="true">                            </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9020"><span data-slate-object="text" data-key="9021"><span data-slate-leaf="true" data-offset-key="9021:0" data-first-offset="true"><span data-slate-string="true">        }                                                        </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9022"><span data-slate-object="text" data-key="9023"><span data-slate-leaf="true" data-offset-key="9023:0" data-first-offset="true"><span data-slate-string="true">                                                                 </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9024"><span data-slate-object="text" data-key="9025"><span data-slate-leaf="true" data-offset-key="9025:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="9026"><span data-slate-leaf="true" data-offset-key="9026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9027"><span data-slate-leaf="true" data-offset-key="9027:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9028"><span data-slate-leaf="true" data-offset-key="9028:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="9029"><span data-slate-leaf="true" data-offset-key="9029:0" data-first-offset="true"><span data-slate-string="true">                     </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9030"><span data-slate-object="text" data-key="9031"><span data-slate-leaf="true" data-offset-key="9031:0" data-first-offset="true"><span data-slate-string="true">    }    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9032"><span data-slate-object="text" data-key="9033"><span data-slate-leaf="true" data-offset-key="9033:0" data-first-offset="true"><span data-slate-string="true">}    </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9034"><span data-slate-type="code" data-slate-object="inline" data-key="9035"><span data-slate-object="text" data-key="9036"><span data-slate-leaf="true" data-offset-key="9036:0" data-first-offset="true"><span data-slate-string="true">authorizator</span></span></span></span><span data-slate-object="text" data-key="9037"><span data-slate-leaf="true" data-offset-key="9037:0" data-first-offset="true"><span data-slate-string="true"> 函数返回了一个匿名函数，匿名函数在认证成功后，会打印一条认证成功日志。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9038" id="sr-toc-6"><span data-slate-object="text" data-key="9039"><span data-slate-leaf="true" data-offset-key="9039:0" data-first-offset="true"><span data-slate-string="true">IAM 项目认证功能设计技巧</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9040"><span data-slate-object="text" data-key="9041"><span data-slate-leaf="true" data-offset-key="9041:0" data-first-offset="true"><span data-slate-string="true">我在设计 IAM 项目的认证功能时，也运用了一些技巧，这里分享给你。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9042" id="sr-toc-7"><span data-slate-object="text" data-key="9043"><span data-slate-leaf="true" data-offset-key="9043:0" data-first-offset="true"><span data-slate-string="true">技巧 1：面向接口编程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9044"><span data-slate-object="text" data-key="9045"><span data-slate-leaf="true" data-offset-key="9045:0" data-first-offset="true"><span data-slate-string="true">在使用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9046"><span data-slate-object="text" data-key="9047"><span data-slate-leaf="true" data-offset-key="9047:0" data-first-offset="true"><span data-slate-string="true">NewAutoStrategy</span></span></span></a><span data-slate-object="text" data-key="9048"><span data-slate-leaf="true" data-offset-key="9048:0" data-first-offset="true"><span data-slate-string="true"> 函数创建 auto 认证策略时，传入了 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9049"><span data-slate-object="text" data-key="9050"><span data-slate-leaf="true" data-offset-key="9050:0" data-first-offset="true"><span data-slate-string="true">middleware.AuthStrategy</span></span></span></a><span data-slate-object="text" data-key="9051"><span data-slate-leaf="true" data-offset-key="9051:0" data-first-offset="true"><span data-slate-string="true"> 接口类型的参数，这意味着 Basic 认证和 Bearer 认证都可以有不同的实现，这样后期可以根据需要扩展新的认证方式。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9052" id="sr-toc-8"><span data-slate-object="text" data-key="9053"><span data-slate-leaf="true" data-offset-key="9053:0" data-first-offset="true"><span data-slate-string="true">技巧 2：使用抽象工厂模式</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9054"><a data-slate-type="link" data-slate-object="inline" data-key="9055"><span data-slate-object="text" data-key="9056"><span data-slate-leaf="true" data-offset-key="9056:0" data-first-offset="true"><span data-slate-string="true">auth.go</span></span></span></a><span data-slate-object="text" data-key="9057"><span data-slate-leaf="true" data-offset-key="9057:0" data-first-offset="true"><span data-slate-string="true"> 文件中，通过 newBasicAuth、newJWTAuth、newAutoAuth 创建认证策略时，返回的都是接口。通过返回接口，可以在不公开内部实现的情况下，让调用者使用你提供的各种认证功能。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="9058" id="sr-toc-9"><span data-slate-object="text" data-key="9059"><span data-slate-leaf="true" data-offset-key="9059:0" data-first-offset="true"><span data-slate-string="true">技巧 3：使用策略模式</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="9060"><span data-slate-object="text" data-key="9061"><span data-slate-leaf="true" data-offset-key="9061:0" data-first-offset="true"><span data-slate-string="true">在 auto 认证策略中，我们会根据 HTTP 请求头</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9062"><span data-slate-object="text" data-key="9063"><span data-slate-leaf="true" data-offset-key="9063:0" data-first-offset="true"><span data-slate-string="true"> Authorization: XXX X.Y.X</span></span></span></span><span data-slate-object="text" data-key="9064"><span data-slate-leaf="true" data-offset-key="9064:0" data-first-offset="true"><span data-slate-string="true"> 中的 XXX 来选择并设置认证策略（Basic 或 Bearer）。具体可以查看</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9065"><span data-slate-object="text" data-key="9066"><span data-slate-leaf="true" data-offset-key="9066:0" data-first-offset="true"><span data-slate-string="true"> AutoStrategy</span></span></span></span><span data-slate-object="text" data-key="9067"><span data-slate-leaf="true" data-offset-key="9067:0" data-first-offset="true"><span data-slate-string="true"> 的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9068"><span data-slate-object="text" data-key="9069"><span data-slate-leaf="true" data-offset-key="9069:0" data-first-offset="true"><span data-slate-string="true">AuthFunc</span></span></span></a><span data-slate-object="text" data-key="9070"><span data-slate-leaf="true" data-offset-key="9070:0" data-first-offset="true"><span data-slate-string="true"> 函数：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="9071"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="9072"><span data-slate-object="text" data-key="9073"><span data-slate-leaf="true" data-offset-key="9073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9074"><span data-slate-leaf="true" data-offset-key="9074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="9075"><span data-slate-leaf="true" data-offset-key="9075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(a AutoStrategy)</span></span></span></span></span><span data-slate-object="text" data-key="9076"><span data-slate-leaf="true" data-offset-key="9076:0" data-first-offset="true"><span data-slate-string="true"> AuthFunc() gin.HandlerFunc {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9077"><span data-slate-object="text" data-key="9078"><span data-slate-leaf="true" data-offset-key="9078:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="9079"><span data-slate-leaf="true" data-offset-key="9079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="9080"><span data-slate-leaf="true" data-offset-key="9080:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9081"><span data-slate-leaf="true" data-offset-key="9081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="9082"><span data-slate-leaf="true" data-offset-key="9082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c *gin.Context)</span></span></span></span></span><span data-slate-object="text" data-key="9083"><span data-slate-leaf="true" data-offset-key="9083:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9084"><span data-slate-object="text" data-key="9085"><span data-slate-leaf="true" data-offset-key="9085:0" data-first-offset="true"><span data-slate-string="true">    operator := middleware.AuthOperator{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9086"><span data-slate-object="text" data-key="9087"><span data-slate-leaf="true" data-offset-key="9087:0" data-first-offset="true"><span data-slate-string="true">    authHeader := strings.SplitN(c.Request.Header.Get(</span></span></span><span data-slate-object="text" data-key="9088"><span data-slate-leaf="true" data-offset-key="9088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Authorization"</span></span></span></span><span data-slate-object="text" data-key="9089"><span data-slate-leaf="true" data-offset-key="9089:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="9090"><span data-slate-leaf="true" data-offset-key="9090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">" "</span></span></span></span><span data-slate-object="text" data-key="9091"><span data-slate-leaf="true" data-offset-key="9091:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="9092"><span data-slate-leaf="true" data-offset-key="9092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="9093"><span data-slate-leaf="true" data-offset-key="9093:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9094"><span data-slate-object="text" data-key="9095"><span data-slate-leaf="true" data-offset-key="9095:0" data-first-offset="true"><span data-slate-string="true">        ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9096"><span data-slate-object="text" data-key="9097"><span data-slate-leaf="true" data-offset-key="9097:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9098"><span data-slate-leaf="true" data-offset-key="9098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">switch</span></span></span></span><span data-slate-object="text" data-key="9099"><span data-slate-leaf="true" data-offset-key="9099:0" data-first-offset="true"><span data-slate-string="true"> authHeader[</span></span></span><span data-slate-object="text" data-key="9100"><span data-slate-leaf="true" data-offset-key="9100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="9101"><span data-slate-leaf="true" data-offset-key="9101:0" data-first-offset="true"><span data-slate-string="true">] {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9102"><span data-slate-object="text" data-key="9103"><span data-slate-leaf="true" data-offset-key="9103:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9104"><span data-slate-leaf="true" data-offset-key="9104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="9105"><span data-slate-leaf="true" data-offset-key="9105:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9106"><span data-slate-leaf="true" data-offset-key="9106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Basic"</span></span></span></span><span data-slate-object="text" data-key="9107"><span data-slate-leaf="true" data-offset-key="9107:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9108"><span data-slate-object="text" data-key="9109"><span data-slate-leaf="true" data-offset-key="9109:0" data-first-offset="true"><span data-slate-string="true">      operator.SetStrategy(a.basic)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9110"><span data-slate-object="text" data-key="9111"><span data-slate-leaf="true" data-offset-key="9111:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9112"><span data-slate-leaf="true" data-offset-key="9112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="9113"><span data-slate-leaf="true" data-offset-key="9113:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="9114"><span data-slate-leaf="true" data-offset-key="9114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Bearer"</span></span></span></span><span data-slate-object="text" data-key="9115"><span data-slate-leaf="true" data-offset-key="9115:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9116"><span data-slate-object="text" data-key="9117"><span data-slate-leaf="true" data-offset-key="9117:0" data-first-offset="true"><span data-slate-string="true">      operator.SetStrategy(a.jwt)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9118"><span data-slate-object="text" data-key="9119"><span data-slate-leaf="true" data-offset-key="9119:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="9120"><span data-slate-leaf="true" data-offset-key="9120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// a.JWT.MiddlewareFunc()(c)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9121"><span data-slate-object="text" data-key="9122"><span data-slate-leaf="true" data-offset-key="9122:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="9123"><span data-slate-leaf="true" data-offset-key="9123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="9124"><span data-slate-leaf="true" data-offset-key="9124:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9125"><span data-slate-object="text" data-key="9126"><span data-slate-leaf="true" data-offset-key="9126:0" data-first-offset="true"><span data-slate-string="true">      core.WriteResponse(c, errors.WithCode(code.ErrSignatureInvalid, </span></span></span><span data-slate-object="text" data-key="9127"><span data-slate-leaf="true" data-offset-key="9127:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"unrecognized Authorization header."</span></span></span></span><span data-slate-object="text" data-key="9128"><span data-slate-leaf="true" data-offset-key="9128:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="9129"><span data-slate-leaf="true" data-offset-key="9129:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="9130"><span data-slate-leaf="true" data-offset-key="9130:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9131"><span data-slate-object="text" data-key="9132"><span data-slate-leaf="true" data-offset-key="9132:0" data-first-offset="true"><span data-slate-string="true">      c.Abort()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9133"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9134"><span data-slate-object="text" data-key="9135"><span data-slate-leaf="true" data-offset-key="9135:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="9136"><span data-slate-leaf="true" data-offset-key="9136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9137"><span data-slate-object="text" data-key="9138"><span data-slate-leaf="true" data-offset-key="9138:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9139"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9140"><span data-slate-object="text" data-key="9141"><span data-slate-leaf="true" data-offset-key="9141:0" data-first-offset="true"><span data-slate-string="true">    operator.AuthFunc()(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9142"></div><div data-slate-type="code-line" data-slate-object="block" data-key="9143"><span data-slate-object="text" data-key="9144"><span data-slate-leaf="true" data-offset-key="9144:0" data-first-offset="true"><span data-slate-string="true">    c.Next()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9145"><span data-slate-object="text" data-key="9146"><span data-slate-leaf="true" data-offset-key="9146:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="9147"><span data-slate-object="text" data-key="9148"><span data-slate-leaf="true" data-offset-key="9148:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9149"><span data-slate-object="text" data-key="9150"><span data-slate-leaf="true" data-offset-key="9150:0" data-first-offset="true"><span data-slate-string="true">上述代码中，如果是 Basic，则设置为 Basic 认证方法</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9151"><span data-slate-object="text" data-key="9152"><span data-slate-leaf="true" data-offset-key="9152:0" data-first-offset="true"><span data-slate-string="true"> operator.SetStrategy(a.basic)</span></span></span></span><span data-slate-object="text" data-key="9153"><span data-slate-leaf="true" data-offset-key="9153:0" data-first-offset="true"><span data-slate-string="true">；如果是 Bearer，则设置为 Bearer 认证方法</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9154"><span data-slate-object="text" data-key="9155"><span data-slate-leaf="true" data-offset-key="9155:0" data-first-offset="true"><span data-slate-string="true"> operator.SetStrategy(a.jwt)</span></span></span></span><span data-slate-object="text" data-key="9156"><span data-slate-leaf="true" data-offset-key="9156:0" data-first-offset="true"><span data-slate-string="true">。 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9157"><span data-slate-object="text" data-key="9158"><span data-slate-leaf="true" data-offset-key="9158:0" data-first-offset="true"><span data-slate-string="true">SetStrategy</span></span></span></span><span data-slate-object="text" data-key="9159"><span data-slate-leaf="true" data-offset-key="9159:0" data-first-offset="true"><span data-slate-string="true"> 方法的入参是 AuthStrategy 类型的接口，都实现了</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9160"><span data-slate-object="text" data-key="9161"><span data-slate-leaf="true" data-offset-key="9161:0" data-first-offset="true"><span data-slate-string="true"> AuthFunc() gin.HandlerFunc</span></span></span></span><span data-slate-object="text" data-key="9162"><span data-slate-leaf="true" data-offset-key="9162:0" data-first-offset="true"><span data-slate-string="true"> 函数，用来进行认证，所以最后我们调用</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9163"><span data-slate-object="text" data-key="9164"><span data-slate-leaf="true" data-offset-key="9164:0" data-first-offset="true"><span data-slate-string="true"> operator.AuthFunc()(c)</span></span></span></span><span data-slate-object="text" data-key="9165"><span data-slate-leaf="true" data-offset-key="9165:0" data-first-offset="true"><span data-slate-string="true"> 即可完成认证。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9166" id="sr-toc-10"><span data-slate-object="text" data-key="9167"><span data-slate-leaf="true" data-offset-key="9167:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="9168"><span data-slate-object="text" data-key="9169"><span data-slate-leaf="true" data-offset-key="9169:0" data-first-offset="true"><span data-slate-string="true">在 IAM 项目中，iam-apiserver 实现了 Basic 认证和 Bearer 认证，iam-authz-server 实现了 Bearer 认证。这一讲重点介绍了 iam-apiserver 的认证实现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9170"><span data-slate-object="text" data-key="9171"><span data-slate-leaf="true" data-offset-key="9171:0" data-first-offset="true"><span data-slate-string="true">用户要访问 iam-apiserver，首先需要通过 Basic 认证，认证通过之后，会返回 JWT Token 和 JWT Token 的过期时间。前端将 Token 缓存在 LocalStorage 或 Cookie 中，后续的请求都通过 Token 来认证。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9172"><span data-slate-object="text" data-key="9173"><span data-slate-leaf="true" data-offset-key="9173:0" data-first-offset="true"><span data-slate-string="true">执行 Basic 认证时，iam-apiserver 会从 HTTP Authorization Header 中解析出用户名和密码，将密码再加密，并和数据库中保存的值进行对比。如果不匹配，则认证失败，否则认证成功。认证成功之后，会返回 Token，并在 Token 的 Payload 部分设置用户名，Key 为 username 。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9174"><span data-slate-object="text" data-key="9175"><span data-slate-leaf="true" data-offset-key="9175:0" data-first-offset="true"><span data-slate-string="true">执行 Bearer 认证时，iam-apiserver 会从 JWT Token 中解析出 Header 和 Payload，并从 Header 中获取加密算法。接着，用获取到的加密算法和从配置文件中获取到的密钥对 Header.Payload 进行再加密，得到 Signature，并对比两次的 Signature 是否相等。如果不相等，则返回 HTTP 401 Unauthorized 错误；如果相等，接下来会判断 Token 是否过期，如果过期则返回认证不通过，否则认证通过。认证通过之后，会将 Payload 中的 username 添加到 gin.Context 类型的变量中，供后面的业务逻辑使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9176"><span data-slate-object="text" data-key="9177"><span data-slate-leaf="true" data-offset-key="9177:0" data-first-offset="true"><span data-slate-string="true">我绘制了整个流程的示意图，你可以对照着再回顾一遍。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="9178"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/64/7e/642a010388e759dd76d411055bbd637e.jpg?wh=2248x1104"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="9179" id="sr-toc-11"><span data-slate-object="text" data-key="9180"><span data-slate-leaf="true" data-offset-key="9180:0" data-first-offset="true"><span data-slate-string="true">课后练习</span></span></span></h2><div data-slate-type="list" data-slate-object="block" data-key="9181"><div data-slate-type="list-line" data-slate-object="block" data-key="9182"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="9183"><span data-slate-leaf="true" data-offset-key="9183:0" data-first-offset="true"><span data-slate-string="true">走读</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9184"><span data-slate-object="text" data-key="9185"><span data-slate-leaf="true" data-offset-key="9185:0" data-first-offset="true"><span data-slate-string="true"> github.com/appleboy/gin-jwt</span></span></span></span><span data-slate-object="text" data-key="9186"><span data-slate-leaf="true" data-offset-key="9186:0" data-first-offset="true"><span data-slate-string="true"> 包的</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="9187"><span data-slate-object="text" data-key="9188"><span data-slate-leaf="true" data-offset-key="9188:0" data-first-offset="true"><span data-slate-string="true"> GinJWTMiddleware</span></span></span></span><span data-slate-object="text" data-key="9189"><span data-slate-leaf="true" data-offset-key="9189:0" data-first-offset="true"><span data-slate-string="true"> 结构体的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9190"><span data-slate-object="text" data-key="9191"><span data-slate-leaf="true" data-offset-key="9191:0" data-first-offset="true"><span data-slate-string="true">GetClaimsFromJWT</span></span></span></a><span data-slate-object="text" data-key="9192"><span data-slate-leaf="true" data-offset-key="9192:0" data-first-offset="true"><span data-slate-string="true"> 方法，分析一下：GetClaimsFromJWT 方法是如何从 gin.Context 中解析出 Token，并进行认证的？</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="9193"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="9194"><span data-slate-leaf="true" data-offset-key="9194:0" data-first-offset="true"><span data-slate-string="true">思考下，iam-apiserver 和 iam-authzserver 是否可以使用同一个认证策略？如果可以，又该如何实现？</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="9195"><span data-slate-object="text" data-key="9196"><span data-slate-leaf="true" data-offset-key="9196:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区与我交流讨论，我们下一讲见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>15</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-12">精选留言 (10)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/dd/09/feca820a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>helloworld</span></div></div><div>本文的意思是说正常的生产环境下，iam-apiserver 和 iam-authz-server 的 api 的认证功能其实都应该放到网关来实现的，本文之所以由 iam 项目亲自来实现就是为了方便讲解认证的具体实现方法，我理解的对不对？</div><div><p>作者回复：老哥理解的没毛病</p></div><div><div>2021-07-26</div><div><div><i></i></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/7a/d2/4ba67c0c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Sch0ng</span></div></div><div>服务端实现 Basic 和 Bearer 认证的详细方案。
配合源码和架构图理解。</div><div><div>2021-08-14</div><div><div><i></i><span></span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/51/84/5b7d4d95.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 冷峰</span></div></div><div>为什么每个用户都要有一个 SecretKey， 所有的用户用同一个 SecretKey 不行吗？</div><div><p>作者回复：这样不安全了，A、B、C 都使用同一个 secretKey，那都依赖于同一个 secretKey，如果 A 想更改 secretKey 的过期时间，不就影响到 B、C 了。secretKey 也属于用户资源，每个用于都应该有一个，符合产品设计思路</p></div><div><div>2021-08-17</div><div><div><i></i><span>9</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/5b/66/ad35bc68.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 党</span></div></div><div>jwt 需要后端解析并从缓存中拿用户对应秘钥在进行运算进行鉴权，这些流程是不是有点复杂和多余啊，登录时候直接随机生成一个 token（uuid hash）传给前端并保存到缓存中，缓存中 token 直接对应用户的 session，每次前端传过来 token 根据是否能用 token 获取缓存中的 session 来鉴权 这样岂不是实现简单 也安全啊  </div><div><p>作者回复：这样做不太合理：
1. 如果很多用户，那应用程序会缓存并维护很多 session，对应用程序是一种压力，如果应用程序重启，那登录会失效，这种是不合理的
2. jwt token 中能够包含很多信息，可以基于这些信息做更多的认证逻辑</p></div><div><div>2021-11-11</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLDUJyeq54fiaXAgF62tNeocO3lHsKT4mygEcNoZLnibg6ONKicMgCgUHSfgW8hrMUXlwpNSzR8MHZwg/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>types</span></div></div><div>根据文中所说
 秘钥对是给 iam-authz-server 使用的
 每个用户维护一个密钥
请问:
1. iam-authz-server jwt 认证中的 jwt token 谁谁生成的？是客户端还是 iam-auth-server
2. 如果是客户端生成的 jwt token，说明客户端是需要有 secret 秘钥对的信息的，请问这样设计有什么优势？
跟通过用户名密码登陆后，由服务端生成 jwt token 这种方式相比较有什么优势
</div><div><p>作者回复: 1. IAM 项目写了一个工具来生成 jwt token:

iamctl jwt sign &lt;secretID&gt; &lt;secretKey&gt;

2. 其实，这里有 2 个维度，需要解释。

第一个 token vs password 的优势对比：

token 相比 password 更加安全 - token 有过期时间，经过加密。
更丰富的信息 - 可以在 token 的 payload 中，携带更丰富的信息，实现更强大的认证功能。

第二个 API 通过密钥访问 VS 控制台通过密码访问。

通过第一个对比，显然 Token 比 password 更安全。

但如果是控制台，我们需要提供给用户一个友好的登陆界面，所以控制台一般通过密码登陆。登陆后生成临时 token，后面继续走 token 认证。

当然，随着技术的发展，目前也有很多其它登陆方式比如：扫一扫、安全令牌等</p></div><div><div>2021-09-05</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIW5xLKMIwlibBXdP5sGVqhXAGuLYk7XFBrhzkFytlKicjNpSHIKXQclDUlSbD9s2HDuOiaBXslCqVbg/132"></div></div><div><div><div><span>Geek_f23c82</span></div></div><div>麻烦问下 authserver 什么时候派发的 jwt token？</div><div><div>2022-05-29</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/5b/66/ad35bc68.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 党</span></div></div><div>jwt 貌似不可以实现实时踢人吧 一个账号登录了 在登录一次 让上次的 token 失效 这个 jwt 不可以吧</div><div><p>作者回复：这个 JWT 是没这种功能的</p></div><div><div>2021-11-29</div><div><div><i></i><span>4</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/87/64/3882d90d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>yandongxiao</span></div></div><div>总结：
IAM 系统采用 Basic + bearer 两种认证方式。Basic 认证要求输入用户名和密码，返回 JWT Token；虽然客户端在访问 iam-apiserver 或者 iam-auth-server 时，在 bearer 认证中携带该 Token，服务端对该请求进行认证。
1. 服务端 basic 认证实现逻辑：通过 gin middleware 实现了签发 JWT 的功能。jwt.New 对象在实例化时，传递多个回调函数，比如 Authentiactor, LoginResponse 等。
2. 服务端 bearer 认证实现逻辑：在 gin 中以 middleware 的方式存在，借助 jwt package 完成认证。认证完成后，会在 Context 中保存 Username，方便后面的 handler 使用</div><div><p>作者回复：总结的好细！</p></div><div><div>2021-11-27</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/25/59/a2/b28b1ffb.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>姚力晓</span></div></div><div>如果 Redis down 掉，或者出现网络抖动，老师说会在新一期的特别放送里专门介绍下， 这个内容没看到？</div><div><p>作者回复：文章已经写完了，打磨后马上放出来</p></div><div><div>2021-10-28</div><div><div><i></i><span>4</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/24/55/05/72d9aa41.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>指尖”^^ 的童话</span></div></div><div>项目有点大，如果是一步步实现的就更好了</div><div><div>2021-10-04</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".g"><outline class="toc-level-h1" data-reactid=".g.0" style="width: 175px;"><active data-reactid=".g.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".g.0.1"><span data-reactid=".g.0.1.0"> 26 | IAM 项目是如何设计和实现访问认证功能的？</span></a></outline><outline class="toc-level-h2" data-reactid=".g.1" style="width: 165px;"><active data-reactid=".g.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".g.1.1"><span data-reactid=".g.1.1.0">如何设计 IAM 项目的认证功能？</span></a></outline><outline class="toc-level-h2" data-reactid=".g.2" style="width: 165px;"><active data-reactid=".g.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".g.2.1"><span data-reactid=".g.2.1.0">IAM 项目是如何实现 Basic 认证的？</span></a></outline><outline class="toc-level-h2" data-reactid=".g.3" style="width: 165px;"><active data-reactid=".g.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".g.3.1"><span data-reactid=".g.3.1.0">IAM 项目是如何实现 Bearer 认证的？</span></a></outline><outline class="toc-level-h3" data-reactid=".g.4" style="width: 155px;"><active data-reactid=".g.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".g.4.1"><span data-reactid=".g.4.1.0">iam-authz-server Bearer 认证实现</span></a></outline><outline class="toc-level-h3" data-reactid=".g.5" style="width: 155px;"><active data-reactid=".g.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".g.5.1"><span data-reactid=".g.5.1.0">iam-apiserver Bearer 认证实现</span></a></outline><outline class="toc-level-h2" data-reactid=".g.6" style="width: 165px;"><active data-reactid=".g.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".g.6.1"><span data-reactid=".g.6.1.0">IAM 项目认证功能设计技巧</span></a></outline><outline class="toc-level-h3" data-reactid=".g.7" style="width: 155px;"><active data-reactid=".g.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".g.7.1"><span data-reactid=".g.7.1.0">技巧 1：面向接口编程</span></a></outline><outline class="toc-level-h3" data-reactid=".g.8" style="width: 155px;"><active data-reactid=".g.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".g.8.1"><span data-reactid=".g.8.1.0">技巧 2：使用抽象工厂模式</span></a></outline><outline class="toc-level-h3" data-reactid=".g.9" style="width: 155px;"><active data-reactid=".g.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".g.9.1"><span data-reactid=".g.9.1.0">技巧 3：使用策略模式</span></a></outline><outline class="toc-level-h2" data-reactid=".g.a" style="width: 165px;"><active data-reactid=".g.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".g.a.1"><span data-reactid=".g.a.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".g.b" style="width: 165px;"><active data-reactid=".g.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".g.b.1"><span data-reactid=".g.b.1.0">课后练习</span></a></outline><outline class="toc-level-h2" data-reactid=".g.c" style="width: 165px;"><active data-reactid=".g.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".g.c.1"><span data-reactid=".g.c.1.0">精选留言 (10)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/399307" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>