
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 18 | 实战：如何基于 Raft 从 0 到 1 构建一个支持多存储引擎分布式 KV 服务？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>18 | 实战：如何基于 Raft 从 0 到 1 构建一个支持多存储引擎分布式 KV 服务？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">我希望你能够用最低的学习成本，掌握 etcd 核心原理和最佳实践，让 etcd 为你所用。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">18 | 实战：如何基于 Raft 从 0 到 1 构建一个支持多存储引擎分布式 KV 服务？</h1><div><span>唐聪</span> <span> 2021-03-01</span></div><div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/2b/16/2b3af6ef988f3d1d624538cf91647c16.jpg" style="width: auto;"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：王超凡</span><span>大小：16.31M</span><span> 时长：17:51</span></div></div><audio title="18 | 实战：如何基于Raft从0到1构建一个支持多存储引擎分布式KV服务？" src="https://res001.geekbang.org/media/audio/85/11/859d136469cbee1454035d0086fe1011/ld/ld.m3u8" __idm_id__="925715"></audio></div><div><div><div><div data-slate-editor="true" data-key="6732" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="6733"><span data-slate-object="text" data-key="6734"><span data-slate-leaf="true" data-offset-key="6734:0" data-first-offset="true"><span data-slate-string="true">你好，我是唐聪。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6735"><span data-slate-object="text" data-key="6736"><span data-slate-leaf="true" data-offset-key="6736:0" data-first-offset="true"><span data-slate-string="true">通过前面课程的学习，我相信你已经对 etcd 基本架构、核心特性有了一定理解。如果让你基于 Raft 协议，实现一个简易的类 etcd、支持多存储引擎的分布式 KV 服务，并能满足读多写少、读少写多的不同业务场景诉求，你知道该怎么动手吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6737"><span data-slate-object="text" data-key="6738"><span data-slate-leaf="true" data-offset-key="6738:0" data-first-offset="true"><span data-slate-string="true">纸上得来终觉浅，绝知此事要躬行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6739"><span data-slate-object="text" data-key="6740"><span data-slate-leaf="true" data-offset-key="6740:0" data-first-offset="true"><span data-slate-string="true">今天我就和你聊聊如何实现一个类 etcd、支持多存储引擎的 KV 服务，我们将基于 etcd 自带的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6741"><span data-slate-object="text" data-key="6742"><span data-slate-leaf="true" data-offset-key="6742:0" data-first-offset="true"><span data-slate-string="true">raftexample</span></span></span></a><span data-slate-object="text" data-key="6743"><span data-slate-leaf="true" data-offset-key="6743:0" data-first-offset="true"><span data-slate-string="true"> 项目快速构建它。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6744"><span data-slate-object="text" data-key="6745"><span data-slate-leaf="true" data-offset-key="6745:0" data-first-offset="true"><span data-slate-string="true">为了方便后面描述，我把它命名为 metcd（表示微型的 etcd），它是 raftexample 的加强版。希望通过 metcd 这个小小的实战项目，能够帮助你进一步理解 etcd 乃至分布式存储服务的核心架构、原理、典型问题解决方案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6746"><span data-slate-object="text" data-key="6747"><span data-slate-leaf="true" data-offset-key="6747:0" data-first-offset="true"><span data-slate-string="true">同时在这个过程中，我将详细为你介绍 etcd 的 Raft 算法工程实现库、不同类型存储引擎的优缺点，拓宽你的知识视野，为你独立分析 etcd 源码，夯实基础。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6748" id="sr-toc-1"><span data-slate-object="text" data-key="6749"><span data-slate-leaf="true" data-offset-key="6749:0" data-first-offset="true"><span data-slate-string="true">整体架构设计</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6750"><span data-slate-object="text" data-key="6751"><span data-slate-leaf="true" data-offset-key="6751:0" data-first-offset="true"><span data-slate-string="true">在和你深入聊代码细节之前，首先我和你从整体上介绍下系统架构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6752"><span data-slate-object="text" data-key="6753"><span data-slate-leaf="true" data-offset-key="6753:0" data-first-offset="true"><span data-slate-string="true">下面是我给你画的 metcd 整体架构设计，它由 API 层、Raft 层的共识模块、逻辑层及存储层组成的状态机组成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6754"><span data-slate-object="text" data-key="6755"><span data-slate-leaf="true" data-offset-key="6755:0" data-first-offset="true"><span data-slate-string="true">接下来，我分别和你简要分析下 API 设计及复制状态机。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6756"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/5e/03/5e9f6882a6f6e357e5c2c5yyffda4e03.png?wh=1920*1166"></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6757" id="sr-toc-2"><span data-slate-object="text" data-key="6758"><span data-slate-leaf="true" data-offset-key="6758:0" data-first-offset="true"><span data-slate-string="true">API 设计</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6759"><span data-slate-object="text" data-key="6760"><span data-slate-leaf="true" data-offset-key="6760:0" data-first-offset="true"><span data-slate-string="true">API 是软件系统对外的语言，它是应用编程接口的缩写，由一组接口定义和协议组成。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6761"><span data-slate-object="text" data-key="6762"><span data-slate-leaf="true" data-offset-key="6762:0" data-first-offset="true"><span data-slate-string="true">在设计 API 的时候，我们往往会考虑以下几个因素：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6763"><div data-slate-type="list-line" data-slate-object="block" data-key="6764"><span data-slate-object="text" data-key="6765"><span data-slate-leaf="true" data-offset-key="6765:0" data-first-offset="true"><span data-slate-string="true">性能。如 etcd v2 使用的是简单的 HTTP/1.x，性能上无法满足大规模 Kubernetes 集群等场景的诉求，因此 etcd v3 使用的是基于 HTTP/2 的 gRPC 协议。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6766"><span data-slate-object="text" data-key="6767"><span data-slate-leaf="true" data-offset-key="6767:0" data-first-offset="true"><span data-slate-string="true">易用性、可调试性。如有的内部高并发服务为了满足性能等诉求，使用的是 UDP 协议。相比 HTTP 协议，UDP 协议显然在易用性、可调试性上存在一定的差距。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6768"><span data-slate-object="text" data-key="6769"><span data-slate-leaf="true" data-offset-key="6769:0" data-first-offset="true"><span data-slate-string="true">开发效率、跨平台、可移植性。相比基于裸 UDP、TCP 协议设计的接口，如果你使用 Protobuf 等 IDL 语言，它支持跨平台、代码自动自动生成，开发效率更高。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6770"><span data-slate-object="text" data-key="6771"><span data-slate-leaf="true" data-offset-key="6771:0" data-first-offset="true"><span data-slate-string="true">安全性。如相比 HTTP 协议，使用 HTTPS 协议可对通信数据加密更安全，可适用于不安全的网络环境（比如公网传输）。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6772"><span data-slate-object="text" data-key="6773"><span data-slate-leaf="true" data-offset-key="6773:0" data-first-offset="true"><span data-slate-string="true">接口幂等性。幂等性简单来说，就是同样一个接口请求一次与多次的效果一样。若你的接口对外保证幂等性，则可降低使用者的复杂度。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6774"><span data-slate-object="text" data-key="6775"><span data-slate-leaf="true" data-offset-key="6775:0" data-first-offset="true"><span data-slate-string="true">因为我们场景的是 POC (Proof of concept)、Demo 开发，因此在 metcd 项目中，我们优先考虑点是易用性、可调试性，选择 HTTP/1.x 协议，接口上为了满足 key-value 操作，支持 Get 和 Put 接口即可。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6776"><span data-slate-object="text" data-key="6777"><span data-slate-leaf="true" data-offset-key="6777:0" data-first-offset="true"><span data-slate-string="true">假设 metcd 项目使用 3379 端口，Put 和 Get 接口，如下所示。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6778"><div data-slate-type="list-line" data-slate-object="block" data-key="6779"><span data-slate-object="text" data-key="6780"><span data-slate-leaf="true" data-offset-key="6780:0" data-first-offset="true"><span data-slate-string="true">Put 接口，设置 key-value</span></span></span></div></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="6781"><div><span></span></div><div><div data-code-line-number="1"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6782"><span data-slate-object="text" data-key="6783"><span data-slate-leaf="true" data-offset-key="6783:0" data-first-offset="true"><span data-slate-string="true">curl -L </span></span></span><span data-slate-object="text" data-key="6784"><span data-slate-leaf="true" data-offset-key="6784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">http</span></span></span></span><span data-slate-object="text" data-key="6785"><span data-slate-leaf="true" data-offset-key="6785:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="6786"><span data-slate-leaf="true" data-offset-key="6786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//127.0.0.1:3379/hello -XPUT -d world</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="6787"><div data-slate-type="list-line" data-slate-object="block" data-key="6788"><span data-slate-object="text" data-key="6789"><span data-slate-leaf="true" data-offset-key="6789:0" data-first-offset="true"><span data-slate-string="true">Get 接口，查询 key-value</span></span></span></div></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="6790"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6791"><span data-slate-object="text" data-key="6792"><span data-slate-leaf="true" data-offset-key="6792:0" data-first-offset="true"><span data-slate-string="true">curl -L </span></span></span><span data-slate-object="text" data-key="6793"><span data-slate-leaf="true" data-offset-key="6793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">http</span></span></span></span><span data-slate-object="text" data-key="6794"><span data-slate-leaf="true" data-offset-key="6794:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="6795"><span data-slate-leaf="true" data-offset-key="6795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//127.0.0.1:3379/hello</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6796"><span data-slate-object="text" data-key="6797"><span data-slate-leaf="true" data-offset-key="6797:0" data-first-offset="true"><span data-slate-string="true">world</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6798" id="sr-toc-3"><span data-slate-object="text" data-key="6799"><span data-slate-leaf="true" data-offset-key="6799:0" data-first-offset="true"><span data-slate-string="true">复制状态机</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6800"><span data-slate-object="text" data-key="6801"><span data-slate-leaf="true" data-offset-key="6801:0" data-first-offset="true"><span data-slate-string="true">了解完 API 设计，那最核心的复制状态机是如何工作的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6802"><span data-slate-object="text" data-key="6803"><span data-slate-leaf="true" data-offset-key="6803:0" data-first-offset="true"><span data-slate-string="true">我们知道 etcd 是基于下图复制状态机实现的分布式 KV 服务，复制状态机由共识模块、日志模块、状态机组成。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6804"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/5c/4f/5c7a3079032f90120a6b309ee401fc4f.png?wh=605*319"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6805"><span data-slate-object="text" data-key="6806"><span data-slate-leaf="true" data-offset-key="6806:0" data-first-offset="true"><span data-slate-string="true">我们的实战项目 metcd，也正是使用与之一样的模型，并且使用 etcd 项目中实现的 Raft 算法库作为共识模块，此算法库已被广泛应用在 etcd、cockroachdb、dgraph 等开源项目中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6807"><span data-slate-object="text" data-key="6808"><span data-slate-leaf="true" data-offset-key="6808:0" data-first-offset="true"><span data-slate-string="true">以下是复制状态机的写请求流程：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6809"><div data-slate-type="list-line" data-slate-object="block" data-key="6810"><span data-slate-object="text" data-key="6811"><span data-slate-leaf="true" data-offset-key="6811:0" data-first-offset="true"><span data-slate-string="true">client 发起一个写请求（put hello = world）；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6812"><span data-slate-object="text" data-key="6813"><span data-slate-leaf="true" data-offset-key="6813:0" data-first-offset="true"><span data-slate-string="true">server 向 Raft 共识模块提交请求，共识模块生成一个写提案日志条目。若 server 是 Leader，则把日志条目广播给其他节点，并持久化日志条目到 WAL 中；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6814"><span data-slate-object="text" data-key="6815"><span data-slate-leaf="true" data-offset-key="6815:0" data-first-offset="true"><span data-slate-string="true">当一半以上节点持久化日志条目后，Leader 的共识模块将此日志条目标记为已提交（committed），并通知其他节点提交；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6816"><span data-slate-object="text" data-key="6817"><span data-slate-leaf="true" data-offset-key="6817:0" data-first-offset="true"><span data-slate-string="true">server 从共识模块获取已经提交的日志条目，异步应用到状态机存储中（boltdb/leveldb/memory），然后返回给 client。</span></span></span></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6818" id="sr-toc-4"><span data-slate-object="text" data-key="6819"><span data-slate-leaf="true" data-offset-key="6819:0" data-first-offset="true"><span data-slate-string="true">多存储引擎</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6820"><span data-slate-object="text" data-key="6821"><span data-slate-leaf="true" data-offset-key="6821:0" data-first-offset="true"><span data-slate-string="true">了解完复制状态机模型后，我和你再深入介绍下状态机。状态机中最核心模块当然是存储引擎，那要如何同时支持多种存储引擎呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6822"><span data-slate-object="text" data-key="6823"><span data-slate-leaf="true" data-offset-key="6823:0" data-first-offset="true"><span data-slate-string="true">metcd 项目将基于 etcd 本身自带的 raftexample 项目进行快速开发，而 raftexample 本身只支持内存存储。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6824"><span data-slate-object="text" data-key="6825"><span data-slate-leaf="true" data-offset-key="6825:0" data-first-offset="true"><span data-slate-string="true">因此我们通过将 KV 存储接口进行抽象化设计，实现支持多存储引擎。KVStore interface 的定义如下所示。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="6826"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6827"><span data-slate-object="text" data-key="6828"><span data-slate-leaf="true" data-offset-key="6828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="6829"><span data-slate-leaf="true" data-offset-key="6829:0" data-first-offset="true"><span data-slate-string="true"> KVStore </span></span></span><span data-slate-object="text" data-key="6830"><span data-slate-leaf="true" data-offset-key="6830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="6831"><span data-slate-leaf="true" data-offset-key="6831:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6832"><span data-slate-object="text" data-key="6833"><span data-slate-leaf="true" data-offset-key="6833:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6834"><span data-slate-leaf="true" data-offset-key="6834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// LookUp get key value</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6835"><span data-slate-object="text" data-key="6836"><span data-slate-leaf="true" data-offset-key="6836:0" data-first-offset="true"><span data-slate-string="true">   Lookup(key </span></span></span><span data-slate-object="text" data-key="6837"><span data-slate-leaf="true" data-offset-key="6837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6838"><span data-slate-leaf="true" data-offset-key="6838:0" data-first-offset="true"><span data-slate-string="true">) (</span></span></span><span data-slate-object="text" data-key="6839"><span data-slate-leaf="true" data-offset-key="6839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6840"><span data-slate-leaf="true" data-offset-key="6840:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6841"><span data-slate-leaf="true" data-offset-key="6841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="6842"><span data-slate-leaf="true" data-offset-key="6842:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6843"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6844"><span data-slate-object="text" data-key="6845"><span data-slate-leaf="true" data-offset-key="6845:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6846"><span data-slate-leaf="true" data-offset-key="6846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Propose propose kv request into raft state machine</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6847"><span data-slate-object="text" data-key="6848"><span data-slate-leaf="true" data-offset-key="6848:0" data-first-offset="true"><span data-slate-string="true">   Propose(k, v </span></span></span><span data-slate-object="text" data-key="6849"><span data-slate-leaf="true" data-offset-key="6849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6850"><span data-slate-leaf="true" data-offset-key="6850:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6851"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6852"><span data-slate-object="text" data-key="6853"><span data-slate-leaf="true" data-offset-key="6853:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6854"><span data-slate-leaf="true" data-offset-key="6854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ReadCommits consume entry from raft state machine into KvStore map until error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6855"><span data-slate-object="text" data-key="6856"><span data-slate-leaf="true" data-offset-key="6856:0" data-first-offset="true"><span data-slate-string="true">   ReadCommits(commitC &lt;-</span></span></span><span data-slate-object="text" data-key="6857"><span data-slate-leaf="true" data-offset-key="6857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="6858"><span data-slate-leaf="true" data-offset-key="6858:0" data-first-offset="true"><span data-slate-string="true"> *</span></span></span><span data-slate-object="text" data-key="6859"><span data-slate-leaf="true" data-offset-key="6859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="6860"><span data-slate-leaf="true" data-offset-key="6860:0" data-first-offset="true"><span data-slate-string="true">, errorC &lt;-</span></span></span><span data-slate-object="text" data-key="6861"><span data-slate-leaf="true" data-offset-key="6861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="6862"><span data-slate-leaf="true" data-offset-key="6862:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6863"><span data-slate-leaf="true" data-offset-key="6863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="6864"><span data-slate-leaf="true" data-offset-key="6864:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6865"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6866"><span data-slate-object="text" data-key="6867"><span data-slate-leaf="true" data-offset-key="6867:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6868"><span data-slate-leaf="true" data-offset-key="6868:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Snapshot return KvStore snapshot</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6869"><span data-slate-object="text" data-key="6870"><span data-slate-leaf="true" data-offset-key="6870:0" data-first-offset="true"><span data-slate-string="true">   Snapshot() ([]</span></span></span><span data-slate-object="text" data-key="6871"><span data-slate-leaf="true" data-offset-key="6871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="6872"><span data-slate-leaf="true" data-offset-key="6872:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="6873"><span data-slate-leaf="true" data-offset-key="6873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="6874"><span data-slate-leaf="true" data-offset-key="6874:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6875"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6876"><span data-slate-object="text" data-key="6877"><span data-slate-leaf="true" data-offset-key="6877:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6878"><span data-slate-leaf="true" data-offset-key="6878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// RecoverFromSnapshot recover data from snapshot</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6879"><span data-slate-object="text" data-key="6880"><span data-slate-leaf="true" data-offset-key="6880:0" data-first-offset="true"><span data-slate-string="true">   RecoverFromSnapshot(snapshot []</span></span></span><span data-slate-object="text" data-key="6881"><span data-slate-leaf="true" data-offset-key="6881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="6882"><span data-slate-leaf="true" data-offset-key="6882:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="6883"><span data-slate-leaf="true" data-offset-key="6883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6884"></div><div data-slate-type="code-line" data-slate-object="block" data-key="6885"><span data-slate-object="text" data-key="6886"><span data-slate-leaf="true" data-offset-key="6886:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6887"><span data-slate-leaf="true" data-offset-key="6887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Close close backend databases</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6888"><span data-slate-object="text" data-key="6889"><span data-slate-leaf="true" data-offset-key="6889:0" data-first-offset="true"><span data-slate-string="true">   Close() err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6890"><span data-slate-object="text" data-key="6891"><span data-slate-leaf="true" data-offset-key="6891:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6892"><span data-slate-object="text" data-key="6893"><span data-slate-leaf="true" data-offset-key="6893:0" data-first-offset="true"><span data-slate-string="true">基于 KV 接口抽象化的设计，我们只需要针对具体的存储引擎，实现对应的操作即可。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6894"><span data-slate-object="text" data-key="6895"><span data-slate-leaf="true" data-offset-key="6895:0" data-first-offset="true"><span data-slate-string="true">我们期望支持三种存储引擎，分别是内存 map、boltdb、leveldb，并做一系列简化设计。一组 metcd 实例，通过 metcd 启动时的配置来决定使用哪种存储引擎。不同业务场景不同实例，比如读多写少的存储引擎可使用 boltdb，写多读少的可使用 leveldb。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6896"><span data-slate-object="text" data-key="6897"><span data-slate-leaf="true" data-offset-key="6897:0" data-first-offset="true"><span data-slate-string="true">接下来我和你重点介绍下存储引擎的选型及原理。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="6898" id="sr-toc-5"><span data-slate-object="text" data-key="6899"><span data-slate-leaf="true" data-offset-key="6899:0" data-first-offset="true"><span data-slate-string="true">boltdb</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="6900"><span data-slate-object="text" data-key="6901"><span data-slate-leaf="true" data-offset-key="6901:0" data-first-offset="true"><span data-slate-string="true">boltdb 是一个基于 B+ tree 实现的存储引擎库，在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6902"><span data-slate-object="text" data-key="6903"><span data-slate-leaf="true" data-offset-key="6903:0" data-first-offset="true"><span data-slate-string="true">10</span></span></span></a><span data-slate-object="text" data-key="6904"><span data-slate-leaf="true" data-offset-key="6904:0" data-first-offset="true"><span data-slate-string="true"> 中我已和你详细介绍过原理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6905"><span data-slate-object="text" data-key="6906"><span data-slate-leaf="true" data-offset-key="6906:0" data-first-offset="true"><span data-slate-string="true">boltdb 为什么适合读多写少？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6907"><span data-slate-object="text" data-key="6908"><span data-slate-leaf="true" data-offset-key="6908:0" data-first-offset="true"><span data-slate-string="true">对于读请求而言，一般情况下它可直接从内存中基于 B+ tree 遍历，快速获取数据返回给 client，不涉及经过磁盘 I/O。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6909"><span data-slate-object="text" data-key="6910"><span data-slate-leaf="true" data-offset-key="6910:0" data-first-offset="true"><span data-slate-string="true">对于写请求，它基于 B+ tree 查找写入位置，更新 key-value。事务提交时，写请求包括 B+ tree 重平衡、分裂、持久化 ditry page、持久化 freelist、持久化 meta page 流程。同时，ditry page 可能分布在文件的各个位置，它发起的是随机写磁盘 I/O。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6911"><span data-slate-object="text" data-key="6912"><span data-slate-leaf="true" data-offset-key="6912:0" data-first-offset="true"><span data-slate-string="true">因此在 boltdb 中，完成一个写请求的开销相比读请求是大很多的。正如我在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6913"><span data-slate-object="text" data-key="6914"><span data-slate-leaf="true" data-offset-key="6914:0" data-first-offset="true"><span data-slate-string="true">16</span></span></span></a><span data-slate-object="text" data-key="6915"><span data-slate-leaf="true" data-offset-key="6915:0" data-first-offset="true"><span data-slate-string="true"> 和 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6916"><span data-slate-object="text" data-key="6917"><span data-slate-leaf="true" data-offset-key="6917:0" data-first-offset="true"><span data-slate-string="true">17</span></span></span></a><span data-slate-object="text" data-key="6918"><span data-slate-leaf="true" data-offset-key="6918:0" data-first-offset="true"><span data-slate-string="true"> 中给你介绍的一样，一个 3 节点的 8 核 16G 空集群，线性读性能可以达到 19 万 QPS，而写 QPS 仅为 5 万。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="6919" id="sr-toc-6"><span data-slate-object="text" data-key="6920"><span data-slate-leaf="true" data-offset-key="6920:0" data-first-offset="true"><span data-slate-string="true">leveldb</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="6921"><span data-slate-object="text" data-key="6922"><span data-slate-leaf="true" data-offset-key="6922:0" data-first-offset="true"><span data-slate-string="true">那要如何设计适合写多读少的存储引擎呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6923"><span data-slate-object="text" data-key="6924"><span data-slate-leaf="true" data-offset-key="6924:0" data-first-offset="true"><span data-slate-string="true">最简单的思路当然是写内存最快。可是内存有限的，无法支撑大容量的数据存储，不持久化数据会丢失。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6925"><span data-slate-object="text" data-key="6926"><span data-slate-leaf="true" data-offset-key="6926:0" data-first-offset="true"><span data-slate-string="true">那能否直接将数据顺序追加到文件末尾（AOF）呢？因为磁盘的特点是顺序写性能比较快。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6927"><span data-slate-object="text" data-key="6928"><span data-slate-leaf="true" data-offset-key="6928:0" data-first-offset="true"><span data-slate-string="true">当然可以。</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6929"><span data-slate-object="text" data-key="6930"><span data-slate-leaf="true" data-offset-key="6930:0" data-first-offset="true"><span data-slate-string="true">Bitcask</span></span></span></a><span data-slate-object="text" data-key="6931"><span data-slate-leaf="true" data-offset-key="6931:0" data-first-offset="true"><span data-slate-string="true"> 存储模型就是采用 AOF 模式，把写请求顺序追加到文件。Facebook 的图片存储 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6932"><span data-slate-object="text" data-key="6933"><span data-slate-leaf="true" data-offset-key="6933:0" data-first-offset="true"><span data-slate-string="true">Haystack</span></span></span></a><span data-slate-object="text" data-key="6934"><span data-slate-leaf="true" data-offset-key="6934:0" data-first-offset="true"><span data-slate-string="true"> 根据其论文介绍，也是使用类似的方案来解决大规模写入痛点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6935"><span data-slate-object="text" data-key="6936"><span data-slate-leaf="true" data-offset-key="6936:0" data-first-offset="true"><span data-slate-string="true">那在 AOF 写入模型中如何实现查询数据呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6937"><span data-slate-object="text" data-key="6938"><span data-slate-leaf="true" data-offset-key="6938:0" data-first-offset="true"><span data-slate-string="true">很显然通过遍历文件一个个匹配 key 是可以的，但是它的性能是极差的。为了实现高性能的查询，最理想的解决方案从直接从内存中查询，但是内存是有限的，那么我们能否通过内存索引来记录一个 key-value 数据在文件中的偏移量，实现从磁盘快速读取呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6939"><span data-slate-object="text" data-key="6940"><span data-slate-leaf="true" data-offset-key="6940:0" data-first-offset="true"><span data-slate-string="true">是的，这正是 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6941"><span data-slate-object="text" data-key="6942"><span data-slate-leaf="true" data-offset-key="6942:0" data-first-offset="true"><span data-slate-string="true">Bitcask</span></span></span></a><span data-slate-object="text" data-key="6943"><span data-slate-leaf="true" data-offset-key="6943:0" data-first-offset="true"><span data-slate-string="true"> 存储模型的查询的实现，它通过内存哈希表维护各个 key-value 数据的索引，实现了快速查找 key-value 数据。不过，内存中虽然只保存 key 索引信息，但是当 key 较多的时候，其对内存要求依然比较高。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6944"><span data-slate-object="text" data-key="6945"><span data-slate-leaf="true" data-offset-key="6945:0" data-first-offset="true"><span data-slate-string="true">快速了解完存储引擎提升写性能的核心思路（随机写转化为顺序写）之后，那 leveldb 它的原理是怎样的呢？与 Bitcask 存储模型有什么不一样？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6946"><span data-slate-object="text" data-key="6947"><span data-slate-leaf="true" data-offset-key="6947:0" data-first-offset="true"><span data-slate-string="true">leveldb 是基于 LSM tree (log-structured merge-tree) 实现的 key-value 存储，它的架构如下图所示（</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6948"><span data-slate-object="text" data-key="6949"><span data-slate-leaf="true" data-offset-key="6949:0" data-first-offset="true"><span data-slate-string="true">引用自微软博客</span></span></span></a><span data-slate-object="text" data-key="6950"><span data-slate-leaf="true" data-offset-key="6950:0" data-first-offset="true"><span data-slate-string="true">）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6951"><span data-slate-object="text" data-key="6952"><span data-slate-leaf="true" data-offset-key="6952:0" data-first-offset="true"><span data-slate-string="true">它提升写性能的核心思路同样是将随机写转化为顺序写磁盘 WAL 文件和内存，结合了我们上面讨论的写内存和磁盘两种方法。数据持久化到 WAL 文件是为了确保机器 crash 后数据不丢失。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6953"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/05/50/05f01951fe5862a62624b81e2ceea150.png?wh=992*677" style="width: auto;"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6954"><span data-slate-object="text" data-key="6955"><span data-slate-leaf="true" data-offset-key="6955:0" data-first-offset="true"><span data-slate-string="true">那么它要如何解决内存不足和查询的痛点问题呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6956"><span data-slate-object="text" data-key="6957"><span data-slate-leaf="true" data-offset-key="6957:0" data-first-offset="true"><span data-slate-string="true">核心解决方案是分层的设计和基于一系列对象的转换和压缩。接下来我给你分析一下上面架构图写流程和后台 compaction 任务：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6958"><div data-slate-type="list-line" data-slate-object="block" data-key="6959"><span data-slate-object="text" data-key="6960"><span data-slate-leaf="true" data-offset-key="6960:0" data-first-offset="true"><span data-slate-string="true">首先写请求顺序写入 Log 文件 (WAL)；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6961"><span data-slate-object="text" data-key="6962"><span data-slate-leaf="true" data-offset-key="6962:0" data-first-offset="true"><span data-slate-string="true">更新内存的 Memtable。leveldb Memtable 后端数据结构实现是 skiplist，skiplist 相比平衡二叉树，实现简单却同样拥有高性能的读写；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6963"><span data-slate-object="text" data-key="6964"><span data-slate-leaf="true" data-offset-key="6964:0" data-first-offset="true"><span data-slate-string="true">当 Memtable 达到一定的阈值时，转换成不可变的 Memtable，也就是只读不可写；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6965"><span data-slate-object="text" data-key="6966"><span data-slate-leaf="true" data-offset-key="6966:0" data-first-offset="true"><span data-slate-string="true">leveldb 后台 Compact 任务会将不可变的 Memtable 生成 SSTable 文件，它有序地存储一系列 key-value 数据。注意 SST 文件按写入时间进行了分层，Level 层次越小数据越新。Manifest 文件记录了各个 SSTable 文件处于哪个层级、它的最小与最大 key 范围；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6967"><span data-slate-object="text" data-key="6968"><span data-slate-leaf="true" data-offset-key="6968:0" data-first-offset="true"><span data-slate-string="true">当某个 level 下的 SSTable 文件数目超过一定阈值后，Compact 任务会从这个 level 的 SSTable 中选择一个文件（level&gt;0），将其和高一层级的 level+1 的 SSTable 文件合并；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6969"><span data-slate-object="text" data-key="6970"><span data-slate-leaf="true" data-offset-key="6970:0" data-first-offset="true"><span data-slate-string="true">注意 level 0 是由 Immutable 直接生成的，因此 level 0 SSTable 文件中的 key-value 存在相互重叠。而 level &gt; 0 时，在和更高一层 SSTable 合并过程中，参与的 SSTable 文件是多个，leveldb 会确保各个 SSTable 中的 key-value 不重叠。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6971"><span data-slate-object="text" data-key="6972"><span data-slate-leaf="true" data-offset-key="6972:0" data-first-offset="true"><span data-slate-string="true">了解完写流程，读流程也就简单了，核心步骤如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="6973"><div data-slate-type="list-line" data-slate-object="block" data-key="6974"><span data-slate-object="text" data-key="6975"><span data-slate-leaf="true" data-offset-key="6975:0" data-first-offset="true"><span data-slate-string="true">从 Memtable 跳跃表中查询 key；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6976"><span data-slate-object="text" data-key="6977"><span data-slate-leaf="true" data-offset-key="6977:0" data-first-offset="true"><span data-slate-string="true">未找到则从 Immutable 中查找；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6978"><span data-slate-object="text" data-key="6979"><span data-slate-leaf="true" data-offset-key="6979:0" data-first-offset="true"><span data-slate-string="true">Immutable 仍未命中，则按照 leveldb 的分层属性，因 level 0 SSTable 文件是直接从 Immutable 生成的，level 0 存在特殊性，因此你需要从 level 0 遍历 SSTable 查找 key；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="6980"><span data-slate-object="text" data-key="6981"><span data-slate-leaf="true" data-offset-key="6981:0" data-first-offset="true"><span data-slate-string="true">level 0 中若未命中，则从 level 1 乃至更高的层次查找。level 大于 0 时，各个 SSTable 中的 key 是不存在相互重叠的。根据 manifest 记录的 key-value 范围信息，可快递定位到具体的 SSTable。同时 leveldb 基于 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6982"><span data-slate-object="text" data-key="6983"><span data-slate-leaf="true" data-offset-key="6983:0" data-first-offset="true"><span data-slate-string="true">bloom filter</span></span></span></a><span data-slate-object="text" data-key="6984"><span data-slate-leaf="true" data-offset-key="6984:0" data-first-offset="true"><span data-slate-string="true"> 实现了快速筛选 SSTable，因此查询效率较高。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6985"><span data-slate-object="text" data-key="6986"><span data-slate-leaf="true" data-offset-key="6986:0" data-first-offset="true"><span data-slate-string="true">更详细原理你可以参考一下 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6987"><span data-slate-object="text" data-key="6988"><span data-slate-leaf="true" data-offset-key="6988:0" data-first-offset="true"><span data-slate-string="true">leveldb</span></span></span></a><span data-slate-object="text" data-key="6989"><span data-slate-leaf="true" data-offset-key="6989:0" data-first-offset="true"><span data-slate-string="true"> 源码。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6990" id="sr-toc-7"><span data-slate-object="text" data-key="6991"><span data-slate-leaf="true" data-offset-key="6991:0" data-first-offset="true"><span data-slate-string="true">实现分析</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6992"><span data-slate-object="text" data-key="6993"><span data-slate-leaf="true" data-offset-key="6993:0" data-first-offset="true"><span data-slate-string="true">从 API 设计、复制状态机、多存储引擎支持等几个方面你介绍了 metcd 架构设计后，接下来我就和你重点介绍下共识模块、状态机支持多存储引擎模块的核心实现要点。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="6994" id="sr-toc-8"><span data-slate-object="text" data-key="6995"><span data-slate-leaf="true" data-offset-key="6995:0" data-first-offset="true"><span data-slate-string="true">Raft 算法库</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="6996"><span data-slate-object="text" data-key="6997"><span data-slate-leaf="true" data-offset-key="6997:0" data-first-offset="true"><span data-slate-string="true">共识模块使用的是 etcd </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6998"><span data-slate-object="text" data-key="6999"><span data-slate-leaf="true" data-offset-key="6999:0" data-first-offset="true"><span data-slate-string="true">Raft 算法库</span></span></span></a><span data-slate-object="text" data-key="7000"><span data-slate-leaf="true" data-offset-key="7000:0" data-first-offset="true"><span data-slate-string="true">，它是一个经过大量业务生产环境检验、具备良好可扩展性的共识算法库。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7001"><span data-slate-object="text" data-key="7002"><span data-slate-leaf="true" data-offset-key="7002:0" data-first-offset="true"><span data-slate-string="true">它提供了哪些接口给你使用？如何提交一个提案，并且获取 Raft 共识模块输出结果呢？</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="7003" id="sr-toc-9"><span data-slate-object="text" data-key="7004"><span data-slate-leaf="true" data-offset-key="7004:0" data-first-offset="true"><span data-slate-string="true">Raft API</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="7005"><span data-slate-object="text" data-key="7006"><span data-slate-leaf="true" data-offset-key="7006:0" data-first-offset="true"><span data-slate-string="true">Raft 作为一个库，它对外最核心的对象是一个名为 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7007"><span data-slate-object="text" data-key="7008"><span data-slate-leaf="true" data-offset-key="7008:0" data-first-offset="true"><span data-slate-string="true">Node</span></span></span></a><span data-slate-object="text" data-key="7009"><span data-slate-leaf="true" data-offset-key="7009:0" data-first-offset="true"><span data-slate-string="true"> 的数据结构。Node 表示 Raft 集群中的一个节点，它的输入与输出接口如下图所示，下面我重点和你介绍它的几个接口功能：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7010"><div data-slate-type="list-line" data-slate-object="block" data-key="7011"><span data-slate-object="text" data-key="7012"><span data-slate-leaf="true" data-offset-key="7012:0" data-first-offset="true"><span data-slate-string="true">Campaign，状态转换成 Candidate，发起新一轮 Leader 选举；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7013"><span data-slate-object="text" data-key="7014"><span data-slate-leaf="true" data-offset-key="7014:0" data-first-offset="true"><span data-slate-string="true">Propose，提交提案接口；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7015"><span data-slate-object="text" data-key="7016"><span data-slate-leaf="true" data-offset-key="7016:0" data-first-offset="true"><span data-slate-string="true">Ready，Raft 状态机输出接口，它的返回是一个输出 Ready 数据结构类型的管道，应用需要监听此管道，获取 Ready 数据，处理其中的各个消息（如持久化未提交的日志条目到 WAL 中，发送消息给其他节点等）；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7017"><span data-slate-object="text" data-key="7018"><span data-slate-leaf="true" data-offset-key="7018:0" data-first-offset="true"><span data-slate-string="true">Advance，通知 Raft 状态机，应用已处理上一个输出的 Ready 数据，等待发送下一个 Ready 数据；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7019"><span data-slate-object="text" data-key="7020"><span data-slate-leaf="true" data-offset-key="7020:0" data-first-offset="true"><span data-slate-string="true">TransferLeaderShip，尝试将 Leader 转移到某个节点；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7021"><span data-slate-object="text" data-key="7022"><span data-slate-leaf="true" data-offset-key="7022:0" data-first-offset="true"><span data-slate-string="true">Step，向 Raft 状态机提交收到的消息，比如当 Leader 广播完 MsgApp 消息给 Follower 节点后，Leader 收到 Follower 节点回复的 MsgAppResp 消息时，就通过 Step 接口将此消息提交给 Raft 状态机驱动其工作；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7023"><span data-slate-object="text" data-key="7024"><span data-slate-leaf="true" data-offset-key="7024:0" data-first-offset="true"><span data-slate-string="true">ReadIndex，用于实现线性读。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="7025"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/a7/39/a79a97f8cc8294dcb93f9552fb638f39.png?wh=1920*787"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7026"><span data-slate-object="text" data-key="7027"><span data-slate-leaf="true" data-offset-key="7027:0" data-first-offset="true"><span data-slate-string="true">上面提到的 Raft 状态机的输出 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7028"><span data-slate-object="text" data-key="7029"><span data-slate-leaf="true" data-offset-key="7029:0" data-first-offset="true"><span data-slate-string="true">Ready 结构</span></span></span></a><span data-slate-object="text" data-key="7030"><span data-slate-leaf="true" data-offset-key="7030:0" data-first-offset="true"><span data-slate-string="true">含有哪些信息呢？下图是其详细字段，含义如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7031"><div data-slate-type="list-line" data-slate-object="block" data-key="7032"><span data-slate-object="text" data-key="7033"><span data-slate-leaf="true" data-offset-key="7033:0" data-first-offset="true"><span data-slate-string="true">SoftState，软状态。包括集群 Leader 和节点状态，不需要持久化到 WAL；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7034"><span data-slate-object="text" data-key="7035"><span data-slate-leaf="true" data-offset-key="7035:0" data-first-offset="true"><span data-slate-string="true">pb.HardState，硬状态。与软状态相反，包括了节点当前 Term、Vote 等信息，需要持久化到 WAL 中；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7036"><span data-slate-object="text" data-key="7037"><span data-slate-leaf="true" data-offset-key="7037:0" data-first-offset="true"><span data-slate-string="true">ReadStates，用于线性一致性读；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7038"><span data-slate-object="text" data-key="7039"><span data-slate-leaf="true" data-offset-key="7039:0" data-first-offset="true"><span data-slate-string="true">Entries，在向其他节点发送消息之前需持久化到 WAL 中；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7040"><span data-slate-object="text" data-key="7041"><span data-slate-leaf="true" data-offset-key="7041:0" data-first-offset="true"><span data-slate-string="true">Messages，持久化 Entries 后，发送给其他节点的消息；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7042"><span data-slate-object="text" data-key="7043"><span data-slate-leaf="true" data-offset-key="7043:0" data-first-offset="true"><span data-slate-string="true">Committed Entries，已提交的日志条目，需要应用到存储状态机中；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7044"><span data-slate-object="text" data-key="7045"><span data-slate-leaf="true" data-offset-key="7045:0" data-first-offset="true"><span data-slate-string="true">Snapshot，快照需保存到持久化存储中；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7046"><span data-slate-object="text" data-key="7047"><span data-slate-leaf="true" data-offset-key="7047:0" data-first-offset="true"><span data-slate-string="true">MustSync，HardState 和 Entries 是否要持久化到 WAL 中；</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="7048"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/c0/d6/c0f0b8046a7c8c67c277fed9548251d6.png?wh=1920*786"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7049"><span data-slate-object="text" data-key="7050"><span data-slate-leaf="true" data-offset-key="7050:0" data-first-offset="true"><span data-slate-string="true">了解完 API 后，我们接下来继续看看代码如何使用 Raft 的 Node API。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7051"><span data-slate-object="text" data-key="7052"><span data-slate-leaf="true" data-offset-key="7052:0" data-first-offset="true"><span data-slate-string="true">正如我在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7053"><span data-slate-object="text" data-key="7054"><span data-slate-leaf="true" data-offset-key="7054:0" data-first-offset="true"><span data-slate-string="true">04</span></span></span></a><span data-slate-object="text" data-key="7055"><span data-slate-leaf="true" data-offset-key="7055:0" data-first-offset="true"><span data-slate-string="true"> 中和你介绍的，etcd Raft 库的设计抽象了网络、Raft 日志存储等模块，它本身并不会进行网络、存储相关的操作，上层应用需结合自己业务场景选择内置的模块或自定义实现网络、存储、日志等模块。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7056"><span data-slate-object="text" data-key="7057"><span data-slate-leaf="true" data-offset-key="7057:0" data-first-offset="true"><span data-slate-string="true">因此我们在使用 Raft 库时，需要先自定义好相关网络、存储等模块，再结合上面介绍的 Raft Node API，就可以完成一个 Node 的核心操作了。其数据结构定义如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7058"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7059"><span data-slate-object="text" data-key="7060"><span data-slate-leaf="true" data-offset-key="7060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// A key-value stream backed by raft</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7061"><span data-slate-object="text" data-key="7062"><span data-slate-leaf="true" data-offset-key="7062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="7063"><span data-slate-leaf="true" data-offset-key="7063:0" data-first-offset="true"><span data-slate-string="true"> raftNode </span></span></span><span data-slate-object="text" data-key="7064"><span data-slate-leaf="true" data-offset-key="7064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="7065"><span data-slate-leaf="true" data-offset-key="7065:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7066"><span data-slate-object="text" data-key="7067"><span data-slate-leaf="true" data-offset-key="7067:0" data-first-offset="true"><span data-slate-string="true">   proposeC    &lt;-</span></span></span><span data-slate-object="text" data-key="7068"><span data-slate-leaf="true" data-offset-key="7068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="7069"><span data-slate-leaf="true" data-offset-key="7069:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7070"><span data-slate-leaf="true" data-offset-key="7070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="7071"><span data-slate-leaf="true" data-offset-key="7071:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7072"><span data-slate-leaf="true" data-offset-key="7072:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// proposed messages (k,v)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7073"><span data-slate-object="text" data-key="7074"><span data-slate-leaf="true" data-offset-key="7074:0" data-first-offset="true"><span data-slate-string="true">   confChangeC &lt;-</span></span></span><span data-slate-object="text" data-key="7075"><span data-slate-leaf="true" data-offset-key="7075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="7076"><span data-slate-leaf="true" data-offset-key="7076:0" data-first-offset="true"><span data-slate-string="true"> raftpb.ConfChange </span></span></span><span data-slate-object="text" data-key="7077"><span data-slate-leaf="true" data-offset-key="7077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// proposed cluster config changes</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7078"><span data-slate-object="text" data-key="7079"><span data-slate-leaf="true" data-offset-key="7079:0" data-first-offset="true"><span data-slate-string="true">   commitC     </span></span></span><span data-slate-object="text" data-key="7080"><span data-slate-leaf="true" data-offset-key="7080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="7081"><span data-slate-leaf="true" data-offset-key="7081:0" data-first-offset="true"><span data-slate-string="true">&lt;- *</span></span></span><span data-slate-object="text" data-key="7082"><span data-slate-leaf="true" data-offset-key="7082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="7083"><span data-slate-leaf="true" data-offset-key="7083:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="7084"><span data-slate-leaf="true" data-offset-key="7084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// entries committed to log (k,v)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7085"><span data-slate-object="text" data-key="7086"><span data-slate-leaf="true" data-offset-key="7086:0" data-first-offset="true"><span data-slate-string="true">   errorC      </span></span></span><span data-slate-object="text" data-key="7087"><span data-slate-leaf="true" data-offset-key="7087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="7088"><span data-slate-leaf="true" data-offset-key="7088:0" data-first-offset="true"><span data-slate-string="true">&lt;- </span></span></span><span data-slate-object="text" data-key="7089"><span data-slate-leaf="true" data-offset-key="7089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="7090"><span data-slate-leaf="true" data-offset-key="7090:0" data-first-offset="true"><span data-slate-string="true">             </span></span></span><span data-slate-object="text" data-key="7091"><span data-slate-leaf="true" data-offset-key="7091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// errors from raft session</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7092"><span data-slate-object="text" data-key="7093"><span data-slate-leaf="true" data-offset-key="7093:0" data-first-offset="true"><span data-slate-string="true">   id          </span></span></span><span data-slate-object="text" data-key="7094"><span data-slate-leaf="true" data-offset-key="7094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="7095"><span data-slate-leaf="true" data-offset-key="7095:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7096"><span data-slate-leaf="true" data-offset-key="7096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// client ID for raft session</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7097"><span data-slate-object="text" data-key="7098"><span data-slate-leaf="true" data-offset-key="7098:0" data-first-offset="true"><span data-slate-string="true">   ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7099"><span data-slate-object="text" data-key="7100"><span data-slate-leaf="true" data-offset-key="7100:0" data-first-offset="true"><span data-slate-string="true">   node        raft.Node</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7101"><span data-slate-object="text" data-key="7102"><span data-slate-leaf="true" data-offset-key="7102:0" data-first-offset="true"><span data-slate-string="true">   raftStorage *raft.MemoryStorage</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7103"><span data-slate-object="text" data-key="7104"><span data-slate-leaf="true" data-offset-key="7104:0" data-first-offset="true"><span data-slate-string="true">   wal         *wal.WAL</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7105"><span data-slate-object="text" data-key="7106"><span data-slate-leaf="true" data-offset-key="7106:0" data-first-offset="true"><span data-slate-string="true">   transport *rafthttp.Transport</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7107"><span data-slate-object="text" data-key="7108"><span data-slate-leaf="true" data-offset-key="7108:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7109"><span data-slate-object="text" data-key="7110"><span data-slate-leaf="true" data-offset-key="7110:0" data-first-offset="true"><span data-slate-string="true">这个数据结构名字叫 raftNode，它表示 Raft 集群中的一个节点。它是由我们业务应用层设计的一个组合结构。从结构体定义中你可以看到它包含了 Raft 核心数据结构 Node (raft.Node)、Raft 日志条目内存存储模块 (raft.MemoryStorage）、WAL 持久化模块 (wal.WAL) 以及网络模块 (rafthttp.Transport)。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7111"><span data-slate-object="text" data-key="7112"><span data-slate-leaf="true" data-offset-key="7112:0" data-first-offset="true"><span data-slate-string="true">同时，它提供了三个核心的管道与业务逻辑模块、存储状态机交互：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7113"><div data-slate-type="list-line" data-slate-object="block" data-key="7114"><span data-slate-object="text" data-key="7115"><span data-slate-leaf="true" data-offset-key="7115:0" data-first-offset="true"><span data-slate-string="true">proposeC，它用来接收 client 发送的写请求提案消息；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7116"><span data-slate-object="text" data-key="7117"><span data-slate-leaf="true" data-offset-key="7117:0" data-first-offset="true"><span data-slate-string="true">confChangeC，它用来接收集群配置变化消息；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7118"><span data-slate-object="text" data-key="7119"><span data-slate-leaf="true" data-offset-key="7119:0" data-first-offset="true"><span data-slate-string="true">commitC，它用来输出 Raft 共识模块已提交的日志条目消息。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7120"><span data-slate-object="text" data-key="7121"><span data-slate-leaf="true" data-offset-key="7121:0" data-first-offset="true"><span data-slate-string="true">在 metcd 项目中因为我们是直接基于 raftexample 定制开发，因此日志持久化存储、网络都使用的是 etcd 自带的 WAL 和 rafthttp 模块。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7122"><a data-slate-type="link" data-slate-object="inline" data-key="7123"><span data-slate-object="text" data-key="7124"><span data-slate-leaf="true" data-offset-key="7124:0" data-first-offset="true"><span data-slate-string="true">WAL</span></span></span></a><span data-slate-object="text" data-key="7125"><span data-slate-leaf="true" data-offset-key="7125:0" data-first-offset="true"><span data-slate-string="true"> 模块中提供了核心的保存未持久化的日志条目和快照功能接口，你可以参考 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7126"><span data-slate-object="text" data-key="7127"><span data-slate-leaf="true" data-offset-key="7127:0" data-first-offset="true"><span data-slate-string="true">03</span></span></span></a><span data-slate-object="text" data-key="7128"><span data-slate-leaf="true" data-offset-key="7128:0" data-first-offset="true"><span data-slate-string="true"> 节写请求中我和你介绍的原理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7129"><a data-slate-type="link" data-slate-object="inline" data-key="7130"><span data-slate-object="text" data-key="7131"><span data-slate-leaf="true" data-offset-key="7131:0" data-first-offset="true"><span data-slate-string="true">rafthttp</span></span></span></a><span data-slate-object="text" data-key="7132"><span data-slate-leaf="true" data-offset-key="7132:0" data-first-offset="true"><span data-slate-string="true"> 模块基于 HTTP 协议提供了各个节点间的消息发送能力，metcd 使用如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7133"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7134"><span data-slate-object="text" data-key="7135"><span data-slate-leaf="true" data-offset-key="7135:0" data-first-offset="true"><span data-slate-string="true">rc.transport = &amp;rafthttp.Transport{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7136"><span data-slate-object="text" data-key="7137"><span data-slate-leaf="true" data-offset-key="7137:0" data-first-offset="true"><span data-slate-string="true">   Logger:      zap.NewExample(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7138"><span data-slate-object="text" data-key="7139"><span data-slate-leaf="true" data-offset-key="7139:0" data-first-offset="true"><span data-slate-string="true">   ID:          types.ID(rc.id),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7140"><span data-slate-object="text" data-key="7141"><span data-slate-leaf="true" data-offset-key="7141:0" data-first-offset="true"><span data-slate-string="true">   ClusterID:   </span></span></span><span data-slate-object="text" data-key="7142"><span data-slate-leaf="true" data-offset-key="7142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x1000</span></span></span></span><span data-slate-object="text" data-key="7143"><span data-slate-leaf="true" data-offset-key="7143:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7144"><span data-slate-object="text" data-key="7145"><span data-slate-leaf="true" data-offset-key="7145:0" data-first-offset="true"><span data-slate-string="true">   Raft:        rc,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7146"><span data-slate-object="text" data-key="7147"><span data-slate-leaf="true" data-offset-key="7147:0" data-first-offset="true"><span data-slate-string="true">   ServerStats: stats.NewServerStats(</span></span></span><span data-slate-object="text" data-key="7148"><span data-slate-leaf="true" data-offset-key="7148:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="7149"><span data-slate-leaf="true" data-offset-key="7149:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7150"><span data-slate-leaf="true" data-offset-key="7150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="7151"><span data-slate-leaf="true" data-offset-key="7151:0" data-first-offset="true"><span data-slate-string="true">),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7152"><span data-slate-object="text" data-key="7153"><span data-slate-leaf="true" data-offset-key="7153:0" data-first-offset="true"><span data-slate-string="true">   LeaderStats: stats.NewLeaderStats(strconv.Itoa(rc.id)),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7154"><span data-slate-object="text" data-key="7155"><span data-slate-leaf="true" data-offset-key="7155:0" data-first-offset="true"><span data-slate-string="true">   ErrorC:      </span></span></span><span data-slate-object="text" data-key="7156"><span data-slate-leaf="true" data-offset-key="7156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="7157"><span data-slate-leaf="true" data-offset-key="7157:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7158"><span data-slate-leaf="true" data-offset-key="7158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">chan</span></span></span></span><span data-slate-object="text" data-key="7159"><span data-slate-leaf="true" data-offset-key="7159:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7160"><span data-slate-leaf="true" data-offset-key="7160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="7161"><span data-slate-leaf="true" data-offset-key="7161:0" data-first-offset="true"><span data-slate-string="true">),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7162"><span data-slate-object="text" data-key="7163"><span data-slate-leaf="true" data-offset-key="7163:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7164"><span data-slate-object="text" data-key="7165"><span data-slate-leaf="true" data-offset-key="7165:0" data-first-offset="true"><span data-slate-string="true">搞清楚 Raft 模块的输入、输出 API，设计好 raftNode 结构，复用 etcd 的 WAL、网络等模块后，接下来我们就只需要实现如下两个循环逻辑，处理业务层发送给 proposeC 和 confChangeC 消息、将 Raft 的 Node 输出 Ready 结构进行相对应的处理即可。精简后的代码如下所示：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7166"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7167"><span data-slate-object="text" data-key="7168"><span data-slate-leaf="true" data-offset-key="7168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7169"><span data-slate-leaf="true" data-offset-key="7169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="7170"><span data-slate-leaf="true" data-offset-key="7170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(rc *raftNode)</span></span></span></span></span><span data-slate-object="text" data-key="7171"><span data-slate-leaf="true" data-offset-key="7171:0" data-first-offset="true"><span data-slate-string="true"> serveChannels() {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7172"><span data-slate-object="text" data-key="7173"><span data-slate-leaf="true" data-offset-key="7173:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7174"><span data-slate-leaf="true" data-offset-key="7174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// send proposals over raft</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7175"><span data-slate-object="text" data-key="7176"><span data-slate-leaf="true" data-offset-key="7176:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7177"><span data-slate-leaf="true" data-offset-key="7177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="7178"><span data-slate-leaf="true" data-offset-key="7178:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7179"><span data-slate-leaf="true" data-offset-key="7179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7180"><span data-slate-leaf="true" data-offset-key="7180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="7181"><span data-slate-leaf="true" data-offset-key="7181:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7182"><span data-slate-object="text" data-key="7183"><span data-slate-leaf="true" data-offset-key="7183:0" data-first-offset="true"><span data-slate-string="true">      confChangeCount := </span></span></span><span data-slate-object="text" data-key="7184"><span data-slate-leaf="true" data-offset-key="7184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span><span data-slate-object="text" data-key="7185"><span data-slate-leaf="true" data-offset-key="7185:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7186"><span data-slate-leaf="true" data-offset-key="7186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="7187"><span data-slate-leaf="true" data-offset-key="7187:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7188"><span data-slate-object="text" data-key="7189"><span data-slate-leaf="true" data-offset-key="7189:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7190"><span data-slate-leaf="true" data-offset-key="7190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="7191"><span data-slate-leaf="true" data-offset-key="7191:0" data-first-offset="true"><span data-slate-string="true"> rc.proposeC != </span></span></span><span data-slate-object="text" data-key="7192"><span data-slate-leaf="true" data-offset-key="7192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7193"><span data-slate-leaf="true" data-offset-key="7193:0" data-first-offset="true"><span data-slate-string="true"> &amp;&amp; rc.confChangeC != </span></span></span><span data-slate-object="text" data-key="7194"><span data-slate-leaf="true" data-offset-key="7194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7195"><span data-slate-leaf="true" data-offset-key="7195:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7196"><span data-slate-object="text" data-key="7197"><span data-slate-leaf="true" data-offset-key="7197:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="7198"><span data-slate-leaf="true" data-offset-key="7198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="7199"><span data-slate-leaf="true" data-offset-key="7199:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7200"><span data-slate-object="text" data-key="7201"><span data-slate-leaf="true" data-offset-key="7201:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="7202"><span data-slate-leaf="true" data-offset-key="7202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="7203"><span data-slate-leaf="true" data-offset-key="7203:0" data-first-offset="true"><span data-slate-string="true"> prop, ok := &lt;-rc.proposeC:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7204"><span data-slate-object="text" data-key="7205"><span data-slate-leaf="true" data-offset-key="7205:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7206"><span data-slate-leaf="true" data-offset-key="7206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7207"><span data-slate-leaf="true" data-offset-key="7207:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7208"><span data-slate-object="text" data-key="7209"><span data-slate-leaf="true" data-offset-key="7209:0" data-first-offset="true"><span data-slate-string="true">               rc.proposeC = </span></span></span><span data-slate-object="text" data-key="7210"><span data-slate-leaf="true" data-offset-key="7210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7211"><span data-slate-object="text" data-key="7212"><span data-slate-leaf="true" data-offset-key="7212:0" data-first-offset="true"><span data-slate-string="true">            } </span></span></span><span data-slate-object="text" data-key="7213"><span data-slate-leaf="true" data-offset-key="7213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="7214"><span data-slate-leaf="true" data-offset-key="7214:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7215"><span data-slate-object="text" data-key="7216"><span data-slate-leaf="true" data-offset-key="7216:0" data-first-offset="true"><span data-slate-string="true">               </span></span></span><span data-slate-object="text" data-key="7217"><span data-slate-leaf="true" data-offset-key="7217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// blocks until accepted by raft state machine</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7218"><span data-slate-object="text" data-key="7219"><span data-slate-leaf="true" data-offset-key="7219:0" data-first-offset="true"><span data-slate-string="true">               rc.node.Propose(context.TODO(), []</span></span></span><span data-slate-object="text" data-key="7220"><span data-slate-leaf="true" data-offset-key="7220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7221"><span data-slate-leaf="true" data-offset-key="7221:0" data-first-offset="true"><span data-slate-string="true">(prop))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7222"><span data-slate-object="text" data-key="7223"><span data-slate-leaf="true" data-offset-key="7223:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7224"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7225"><span data-slate-object="text" data-key="7226"><span data-slate-leaf="true" data-offset-key="7226:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="7227"><span data-slate-leaf="true" data-offset-key="7227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="7228"><span data-slate-leaf="true" data-offset-key="7228:0" data-first-offset="true"><span data-slate-string="true"> cc, ok := &lt;-rc.confChangeC:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7229"><span data-slate-object="text" data-key="7230"><span data-slate-leaf="true" data-offset-key="7230:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7231"><span data-slate-leaf="true" data-offset-key="7231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7232"><span data-slate-leaf="true" data-offset-key="7232:0" data-first-offset="true"><span data-slate-string="true"> !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7233"><span data-slate-object="text" data-key="7234"><span data-slate-leaf="true" data-offset-key="7234:0" data-first-offset="true"><span data-slate-string="true">               rc.confChangeC = </span></span></span><span data-slate-object="text" data-key="7235"><span data-slate-leaf="true" data-offset-key="7235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7236"><span data-slate-object="text" data-key="7237"><span data-slate-leaf="true" data-offset-key="7237:0" data-first-offset="true"><span data-slate-string="true">            } </span></span></span><span data-slate-object="text" data-key="7238"><span data-slate-leaf="true" data-offset-key="7238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="7239"><span data-slate-leaf="true" data-offset-key="7239:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7240"><span data-slate-object="text" data-key="7241"><span data-slate-leaf="true" data-offset-key="7241:0" data-first-offset="true"><span data-slate-string="true">               confChangeCount++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7242"><span data-slate-object="text" data-key="7243"><span data-slate-leaf="true" data-offset-key="7243:0" data-first-offset="true"><span data-slate-string="true">               cc.ID = confChangeCount</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7244"><span data-slate-object="text" data-key="7245"><span data-slate-leaf="true" data-offset-key="7245:0" data-first-offset="true"><span data-slate-string="true">               rc.node.ProposeConfChange(context.TODO(), cc)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7246"><span data-slate-object="text" data-key="7247"><span data-slate-leaf="true" data-offset-key="7247:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7248"><span data-slate-object="text" data-key="7249"><span data-slate-leaf="true" data-offset-key="7249:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7250"><span data-slate-object="text" data-key="7251"><span data-slate-leaf="true" data-offset-key="7251:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7252"><span data-slate-object="text" data-key="7253"><span data-slate-leaf="true" data-offset-key="7253:0" data-first-offset="true"><span data-slate-string="true">   }()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7254"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7255"><span data-slate-object="text" data-key="7256"><span data-slate-leaf="true" data-offset-key="7256:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7257"><span data-slate-leaf="true" data-offset-key="7257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// event loop on raft state machine updates</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7258"><span data-slate-object="text" data-key="7259"><span data-slate-leaf="true" data-offset-key="7259:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7260"><span data-slate-leaf="true" data-offset-key="7260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="7261"><span data-slate-leaf="true" data-offset-key="7261:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7262"><span data-slate-object="text" data-key="7263"><span data-slate-leaf="true" data-offset-key="7263:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7264"><span data-slate-leaf="true" data-offset-key="7264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">select</span></span></span></span><span data-slate-object="text" data-key="7265"><span data-slate-leaf="true" data-offset-key="7265:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7266"><span data-slate-object="text" data-key="7267"><span data-slate-leaf="true" data-offset-key="7267:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7268"><span data-slate-leaf="true" data-offset-key="7268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="7269"><span data-slate-leaf="true" data-offset-key="7269:0" data-first-offset="true"><span data-slate-string="true"> &lt;-ticker.C:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7270"><span data-slate-object="text" data-key="7271"><span data-slate-leaf="true" data-offset-key="7271:0" data-first-offset="true"><span data-slate-string="true">         rc.node.Tick()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7272"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7273"><span data-slate-object="text" data-key="7274"><span data-slate-leaf="true" data-offset-key="7274:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7275"><span data-slate-leaf="true" data-offset-key="7275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// store raft entries to wal, then publish over commit channel</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7276"><span data-slate-object="text" data-key="7277"><span data-slate-leaf="true" data-offset-key="7277:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7278"><span data-slate-leaf="true" data-offset-key="7278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="7279"><span data-slate-leaf="true" data-offset-key="7279:0" data-first-offset="true"><span data-slate-string="true"> rd := &lt;-rc.node.Ready():</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7280"><span data-slate-object="text" data-key="7281"><span data-slate-leaf="true" data-offset-key="7281:0" data-first-offset="true"><span data-slate-string="true">         rc.wal.Save(rd.HardState, rd.Entries)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7282"><span data-slate-object="text" data-key="7283"><span data-slate-leaf="true" data-offset-key="7283:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="7284"><span data-slate-leaf="true" data-offset-key="7284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7285"><span data-slate-leaf="true" data-offset-key="7285:0" data-first-offset="true"><span data-slate-string="true"> !raft.IsEmptySnap(rd.Snapshot) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7286"><span data-slate-object="text" data-key="7287"><span data-slate-leaf="true" data-offset-key="7287:0" data-first-offset="true"><span data-slate-string="true">            rc.saveSnap(rd.Snapshot)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7288"><span data-slate-object="text" data-key="7289"><span data-slate-leaf="true" data-offset-key="7289:0" data-first-offset="true"><span data-slate-string="true">            rc.raftStorage.ApplySnapshot(rd.Snapshot)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7290"><span data-slate-object="text" data-key="7291"><span data-slate-leaf="true" data-offset-key="7291:0" data-first-offset="true"><span data-slate-string="true">            rc.publishSnapshot(rd.Snapshot)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7292"><span data-slate-object="text" data-key="7293"><span data-slate-leaf="true" data-offset-key="7293:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7294"><span data-slate-object="text" data-key="7295"><span data-slate-leaf="true" data-offset-key="7295:0" data-first-offset="true"><span data-slate-string="true">         rc.raftStorage.Append(rd.Entries)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7296"><span data-slate-object="text" data-key="7297"><span data-slate-leaf="true" data-offset-key="7297:0" data-first-offset="true"><span data-slate-string="true">         rc.transport.Send(rd.Messages)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7298"><span data-slate-object="text" data-key="7299"><span data-slate-leaf="true" data-offset-key="7299:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="7300"><span data-slate-leaf="true" data-offset-key="7300:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7301"><span data-slate-leaf="true" data-offset-key="7301:0" data-first-offset="true"><span data-slate-string="true"> ok := rc.publishEntries(rc.entriesToApply(rd.CommittedEntries)); !ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7302"><span data-slate-object="text" data-key="7303"><span data-slate-leaf="true" data-offset-key="7303:0" data-first-offset="true"><span data-slate-string="true">            rc.stop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7304"><span data-slate-object="text" data-key="7305"><span data-slate-leaf="true" data-offset-key="7305:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7306"><span data-slate-leaf="true" data-offset-key="7306:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7307"><span data-slate-object="text" data-key="7308"><span data-slate-leaf="true" data-offset-key="7308:0" data-first-offset="true"><span data-slate-string="true">         }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7309"><span data-slate-object="text" data-key="7310"><span data-slate-leaf="true" data-offset-key="7310:0" data-first-offset="true"><span data-slate-string="true">         rc.maybeTriggerSnapshot()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7311"><span data-slate-object="text" data-key="7312"><span data-slate-leaf="true" data-offset-key="7312:0" data-first-offset="true"><span data-slate-string="true">         rc.node.Advance()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7313"><span data-slate-object="text" data-key="7314"><span data-slate-leaf="true" data-offset-key="7314:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7315"><span data-slate-object="text" data-key="7316"><span data-slate-leaf="true" data-offset-key="7316:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7317"><span data-slate-object="text" data-key="7318"><span data-slate-leaf="true" data-offset-key="7318:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7319"><span data-slate-object="text" data-key="7320"><span data-slate-leaf="true" data-offset-key="7320:0" data-first-offset="true"><span data-slate-string="true">代码简要分析如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7321"><div data-slate-type="list-line" data-slate-object="block" data-key="7322"><span data-slate-object="text" data-key="7323"><span data-slate-leaf="true" data-offset-key="7323:0" data-first-offset="true"><span data-slate-string="true">从 proposeC 中取出提案消息，通过 raft.Node.Propose API 提交提案；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7324"><span data-slate-object="text" data-key="7325"><span data-slate-leaf="true" data-offset-key="7325:0" data-first-offset="true"><span data-slate-string="true">从 confChangeC 取出配置变更消息，通过 raft.Node.ProposeConfChange API 提交配置变化消息；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7326"><span data-slate-object="text" data-key="7327"><span data-slate-leaf="true" data-offset-key="7327:0" data-first-offset="true"><span data-slate-string="true">从 raft.Node 中获取 Raft 算法状态机输出到 Ready 结构中，将 rd.Entries 和 rd.HardState 通过 WAL 模块持久化，将 rd.Messages 通过 rafthttp 模块，发送给其他节点。将 rd.CommittedEntries 应用到业务存储状态机。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7328"><span data-slate-object="text" data-key="7329"><span data-slate-leaf="true" data-offset-key="7329:0" data-first-offset="true"><span data-slate-string="true">以上就是 Raft 实现的核心流程，接下来我来和你聊聊业务存储状态机。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="7330" id="sr-toc-10"><span data-slate-object="text" data-key="7331"><span data-slate-leaf="true" data-offset-key="7331:0" data-first-offset="true"><span data-slate-string="true">支持多存储引擎</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="7332"><span data-slate-object="text" data-key="7333"><span data-slate-leaf="true" data-offset-key="7333:0" data-first-offset="true"><span data-slate-string="true">在整体架构设计时，我和你介绍了为了使 metcd 项目能支撑多存储引擎，我们将 KVStore 进行了抽象化设计，因此我们只需要实现各个存储引擎相对应的 API 即可。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7334"><span data-slate-object="text" data-key="7335"><span data-slate-leaf="true" data-offset-key="7335:0" data-first-offset="true"><span data-slate-string="true">这里我以 Put 接口为案例，分别给你介绍下各个存储引擎的实现。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="7336" id="sr-toc-11"><span data-slate-object="text" data-key="7337"><span data-slate-leaf="true" data-offset-key="7337:0" data-first-offset="true"><span data-slate-string="true">boltdb</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="7338"><span data-slate-object="text" data-key="7339"><span data-slate-leaf="true" data-offset-key="7339:0" data-first-offset="true"><span data-slate-string="true">首先是 boltdb 存储引擎，它的实现如下，你也可以去 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7340"><span data-slate-object="text" data-key="7341"><span data-slate-leaf="true" data-offset-key="7341:0" data-first-offset="true"><span data-slate-string="true">10</span></span></span></a><span data-slate-object="text" data-key="7342"><span data-slate-leaf="true" data-offset-key="7342:0" data-first-offset="true"><span data-slate-string="true"> 里回顾一下它的 API 和原理。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7343"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7344"><span data-slate-object="text" data-key="7345"><span data-slate-leaf="true" data-offset-key="7345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7346"><span data-slate-leaf="true" data-offset-key="7346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="7347"><span data-slate-leaf="true" data-offset-key="7347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *boltdbKVStore)</span></span></span></span></span><span data-slate-object="text" data-key="7348"><span data-slate-leaf="true" data-offset-key="7348:0" data-first-offset="true"><span data-slate-string="true"> Put(key, value </span></span></span><span data-slate-object="text" data-key="7349"><span data-slate-leaf="true" data-offset-key="7349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="7350"><span data-slate-leaf="true" data-offset-key="7350:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="7351"><span data-slate-leaf="true" data-offset-key="7351:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="7352"><span data-slate-leaf="true" data-offset-key="7352:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7353"><span data-slate-object="text" data-key="7354"><span data-slate-leaf="true" data-offset-key="7354:0" data-first-offset="true"><span data-slate-string="true">   s.mu.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7355"><span data-slate-object="text" data-key="7356"><span data-slate-leaf="true" data-offset-key="7356:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7357"><span data-slate-leaf="true" data-offset-key="7357:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="7358"><span data-slate-leaf="true" data-offset-key="7358:0" data-first-offset="true"><span data-slate-string="true"> s.mu.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7359"><span data-slate-object="text" data-key="7360"><span data-slate-leaf="true" data-offset-key="7360:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7361"><span data-slate-leaf="true" data-offset-key="7361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Start a writable transaction.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7362"><span data-slate-object="text" data-key="7363"><span data-slate-leaf="true" data-offset-key="7363:0" data-first-offset="true"><span data-slate-string="true">   tx, err := s.db.Begin(</span></span></span><span data-slate-object="text" data-key="7364"><span data-slate-leaf="true" data-offset-key="7364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="7365"><span data-slate-leaf="true" data-offset-key="7365:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7366"><span data-slate-object="text" data-key="7367"><span data-slate-leaf="true" data-offset-key="7367:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7368"><span data-slate-leaf="true" data-offset-key="7368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7369"><span data-slate-leaf="true" data-offset-key="7369:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7370"><span data-slate-leaf="true" data-offset-key="7370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7371"><span data-slate-leaf="true" data-offset-key="7371:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7372"><span data-slate-object="text" data-key="7373"><span data-slate-leaf="true" data-offset-key="7373:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7374"><span data-slate-leaf="true" data-offset-key="7374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7375"><span data-slate-leaf="true" data-offset-key="7375:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7376"><span data-slate-object="text" data-key="7377"><span data-slate-leaf="true" data-offset-key="7377:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7378"><span data-slate-object="text" data-key="7379"><span data-slate-leaf="true" data-offset-key="7379:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7380"><span data-slate-leaf="true" data-offset-key="7380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="7381"><span data-slate-leaf="true" data-offset-key="7381:0" data-first-offset="true"><span data-slate-string="true"> tx.Rollback()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7382"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7383"><span data-slate-object="text" data-key="7384"><span data-slate-leaf="true" data-offset-key="7384:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7385"><span data-slate-leaf="true" data-offset-key="7385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Use the transaction...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7386"><span data-slate-object="text" data-key="7387"><span data-slate-leaf="true" data-offset-key="7387:0" data-first-offset="true"><span data-slate-string="true">   bucket, err := tx.CreateBucketIfNotExists([]</span></span></span><span data-slate-object="text" data-key="7388"><span data-slate-leaf="true" data-offset-key="7388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7389"><span data-slate-leaf="true" data-offset-key="7389:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7390"><span data-slate-leaf="true" data-offset-key="7390:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"keys"</span></span></span></span><span data-slate-object="text" data-key="7391"><span data-slate-leaf="true" data-offset-key="7391:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7392"><span data-slate-object="text" data-key="7393"><span data-slate-leaf="true" data-offset-key="7393:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7394"><span data-slate-leaf="true" data-offset-key="7394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7395"><span data-slate-leaf="true" data-offset-key="7395:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7396"><span data-slate-leaf="true" data-offset-key="7396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7397"><span data-slate-leaf="true" data-offset-key="7397:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7398"><span data-slate-object="text" data-key="7399"><span data-slate-leaf="true" data-offset-key="7399:0" data-first-offset="true"><span data-slate-string="true">      log.Printf(</span></span></span><span data-slate-object="text" data-key="7400"><span data-slate-leaf="true" data-offset-key="7400:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"failed to put key %s, value %s, err is %v"</span></span></span></span><span data-slate-object="text" data-key="7401"><span data-slate-leaf="true" data-offset-key="7401:0" data-first-offset="true"><span data-slate-string="true">, key, value, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7402"><span data-slate-object="text" data-key="7403"><span data-slate-leaf="true" data-offset-key="7403:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7404"><span data-slate-leaf="true" data-offset-key="7404:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7405"><span data-slate-leaf="true" data-offset-key="7405:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7406"><span data-slate-object="text" data-key="7407"><span data-slate-leaf="true" data-offset-key="7407:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7408"><span data-slate-object="text" data-key="7409"><span data-slate-leaf="true" data-offset-key="7409:0" data-first-offset="true"><span data-slate-string="true">   err = bucket.Put([]</span></span></span><span data-slate-object="text" data-key="7410"><span data-slate-leaf="true" data-offset-key="7410:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7411"><span data-slate-leaf="true" data-offset-key="7411:0" data-first-offset="true"><span data-slate-string="true">(key), []</span></span></span><span data-slate-object="text" data-key="7412"><span data-slate-leaf="true" data-offset-key="7412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7413"><span data-slate-leaf="true" data-offset-key="7413:0" data-first-offset="true"><span data-slate-string="true">(value))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7414"><span data-slate-object="text" data-key="7415"><span data-slate-leaf="true" data-offset-key="7415:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7416"><span data-slate-leaf="true" data-offset-key="7416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7417"><span data-slate-leaf="true" data-offset-key="7417:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7418"><span data-slate-leaf="true" data-offset-key="7418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7419"><span data-slate-leaf="true" data-offset-key="7419:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7420"><span data-slate-object="text" data-key="7421"><span data-slate-leaf="true" data-offset-key="7421:0" data-first-offset="true"><span data-slate-string="true">      log.Printf(</span></span></span><span data-slate-object="text" data-key="7422"><span data-slate-leaf="true" data-offset-key="7422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"failed to put key %s, value %s, err is %v"</span></span></span></span><span data-slate-object="text" data-key="7423"><span data-slate-leaf="true" data-offset-key="7423:0" data-first-offset="true"><span data-slate-string="true">, key, value, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7424"><span data-slate-object="text" data-key="7425"><span data-slate-leaf="true" data-offset-key="7425:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7426"><span data-slate-leaf="true" data-offset-key="7426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7427"><span data-slate-leaf="true" data-offset-key="7427:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7428"><span data-slate-object="text" data-key="7429"><span data-slate-leaf="true" data-offset-key="7429:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7430"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7431"><span data-slate-object="text" data-key="7432"><span data-slate-leaf="true" data-offset-key="7432:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7433"><span data-slate-leaf="true" data-offset-key="7433:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Commit the transaction and check for error.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7434"><span data-slate-object="text" data-key="7435"><span data-slate-leaf="true" data-offset-key="7435:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7436"><span data-slate-leaf="true" data-offset-key="7436:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7437"><span data-slate-leaf="true" data-offset-key="7437:0" data-first-offset="true"><span data-slate-string="true"> err := tx.Commit(); err != </span></span></span><span data-slate-object="text" data-key="7438"><span data-slate-leaf="true" data-offset-key="7438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7439"><span data-slate-leaf="true" data-offset-key="7439:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7440"><span data-slate-object="text" data-key="7441"><span data-slate-leaf="true" data-offset-key="7441:0" data-first-offset="true"><span data-slate-string="true">      log.Printf(</span></span></span><span data-slate-object="text" data-key="7442"><span data-slate-leaf="true" data-offset-key="7442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"failed to commit transaction, key %s, err is %v"</span></span></span></span><span data-slate-object="text" data-key="7443"><span data-slate-leaf="true" data-offset-key="7443:0" data-first-offset="true"><span data-slate-string="true">, key, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7444"><span data-slate-object="text" data-key="7445"><span data-slate-leaf="true" data-offset-key="7445:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7446"><span data-slate-leaf="true" data-offset-key="7446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7447"><span data-slate-leaf="true" data-offset-key="7447:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7448"><span data-slate-object="text" data-key="7449"><span data-slate-leaf="true" data-offset-key="7449:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7450"><span data-slate-object="text" data-key="7451"><span data-slate-leaf="true" data-offset-key="7451:0" data-first-offset="true"><span data-slate-string="true">   log.Printf(</span></span></span><span data-slate-object="text" data-key="7452"><span data-slate-leaf="true" data-offset-key="7452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"backend:%s,put key:%s,value:%s succ"</span></span></span></span><span data-slate-object="text" data-key="7453"><span data-slate-leaf="true" data-offset-key="7453:0" data-first-offset="true"><span data-slate-string="true">, s.config.backend, key, value)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7454"><span data-slate-object="text" data-key="7455"><span data-slate-leaf="true" data-offset-key="7455:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7456"><span data-slate-leaf="true" data-offset-key="7456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7457"><span data-slate-leaf="true" data-offset-key="7457:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7458"><span data-slate-leaf="true" data-offset-key="7458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h4 data-slate-type="heading" data-slate-object="block" data-key="7459" id="sr-toc-12"><span data-slate-object="text" data-key="7460"><span data-slate-leaf="true" data-offset-key="7460:0" data-first-offset="true"><span data-slate-string="true">leveldb</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="7461"><span data-slate-object="text" data-key="7462"><span data-slate-leaf="true" data-offset-key="7462:0" data-first-offset="true"><span data-slate-string="true">其次是 leveldb，我们使用的是 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7463"><span data-slate-object="text" data-key="7464"><span data-slate-leaf="true" data-offset-key="7464:0" data-first-offset="true"><span data-slate-string="true">goleveldb</span></span></span></a><span data-slate-object="text" data-key="7465"><span data-slate-leaf="true" data-offset-key="7465:0" data-first-offset="true"><span data-slate-string="true">，它基于 Google 开源的 c++ </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7466"><span data-slate-object="text" data-key="7467"><span data-slate-leaf="true" data-offset-key="7467:0" data-first-offset="true"><span data-slate-string="true">leveldb</span></span></span></a><span data-slate-object="text" data-key="7468"><span data-slate-leaf="true" data-offset-key="7468:0" data-first-offset="true"><span data-slate-string="true"> 版本实现。它提供的常用 API 如下所示。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7469"><div data-slate-type="list-line" data-slate-object="block" data-key="7470"><span data-slate-object="text" data-key="7471"><span data-slate-leaf="true" data-offset-key="7471:0" data-first-offset="true"><span data-slate-string="true">通过 OpenFile API 创建或打开一个 leveldb 数据库。</span></span></span></div></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7472"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7473"><span data-slate-object="text" data-key="7474"><span data-slate-leaf="true" data-offset-key="7474:0" data-first-offset="true"><span data-slate-string="true">db, err := leveldb.OpenFile(</span></span></span><span data-slate-object="text" data-key="7475"><span data-slate-leaf="true" data-offset-key="7475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"path/to/db"</span></span></span></span><span data-slate-object="text" data-key="7476"><span data-slate-leaf="true" data-offset-key="7476:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7477"><span data-slate-leaf="true" data-offset-key="7477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7478"><span data-slate-leaf="true" data-offset-key="7478:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7479"><span data-slate-object="text" data-key="7480"><span data-slate-leaf="true" data-offset-key="7480:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7481"><span data-slate-object="text" data-key="7482"><span data-slate-leaf="true" data-offset-key="7482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="7483"><span data-slate-leaf="true" data-offset-key="7483:0" data-first-offset="true"><span data-slate-string="true"> db.Close()</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="7484"><div data-slate-type="list-line" data-slate-object="block" data-key="7485"><span data-slate-object="text" data-key="7486"><span data-slate-leaf="true" data-offset-key="7486:0" data-first-offset="true"><span data-slate-string="true">通过 DB.Get/Put/Delete API 操作数据。</span></span></span></div></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7487"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7488"><span data-slate-object="text" data-key="7489"><span data-slate-leaf="true" data-offset-key="7489:0" data-first-offset="true"><span data-slate-string="true">data, err := db.Get([]</span></span></span><span data-slate-object="text" data-key="7490"><span data-slate-leaf="true" data-offset-key="7490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7491"><span data-slate-leaf="true" data-offset-key="7491:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7492"><span data-slate-leaf="true" data-offset-key="7492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"key"</span></span></span></span><span data-slate-object="text" data-key="7493"><span data-slate-leaf="true" data-offset-key="7493:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="7494"><span data-slate-leaf="true" data-offset-key="7494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7495"><span data-slate-leaf="true" data-offset-key="7495:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7496"><span data-slate-object="text" data-key="7497"><span data-slate-leaf="true" data-offset-key="7497:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7498"><span data-slate-object="text" data-key="7499"><span data-slate-leaf="true" data-offset-key="7499:0" data-first-offset="true"><span data-slate-string="true">err = db.Put([]</span></span></span><span data-slate-object="text" data-key="7500"><span data-slate-leaf="true" data-offset-key="7500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7501"><span data-slate-leaf="true" data-offset-key="7501:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7502"><span data-slate-leaf="true" data-offset-key="7502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"key"</span></span></span></span><span data-slate-object="text" data-key="7503"><span data-slate-leaf="true" data-offset-key="7503:0" data-first-offset="true"><span data-slate-string="true">), []</span></span></span><span data-slate-object="text" data-key="7504"><span data-slate-leaf="true" data-offset-key="7504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7505"><span data-slate-leaf="true" data-offset-key="7505:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7506"><span data-slate-leaf="true" data-offset-key="7506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"value"</span></span></span></span><span data-slate-object="text" data-key="7507"><span data-slate-leaf="true" data-offset-key="7507:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="7508"><span data-slate-leaf="true" data-offset-key="7508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7509"><span data-slate-leaf="true" data-offset-key="7509:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7510"><span data-slate-object="text" data-key="7511"><span data-slate-leaf="true" data-offset-key="7511:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7512"><span data-slate-object="text" data-key="7513"><span data-slate-leaf="true" data-offset-key="7513:0" data-first-offset="true"><span data-slate-string="true">err = db.Delete([]</span></span></span><span data-slate-object="text" data-key="7514"><span data-slate-leaf="true" data-offset-key="7514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7515"><span data-slate-leaf="true" data-offset-key="7515:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="7516"><span data-slate-leaf="true" data-offset-key="7516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"key"</span></span></span></span><span data-slate-object="text" data-key="7517"><span data-slate-leaf="true" data-offset-key="7517:0" data-first-offset="true"><span data-slate-string="true">), </span></span></span><span data-slate-object="text" data-key="7518"><span data-slate-leaf="true" data-offset-key="7518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7519"><span data-slate-leaf="true" data-offset-key="7519:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7520"><span data-slate-object="text" data-key="7521"><span data-slate-leaf="true" data-offset-key="7521:0" data-first-offset="true"><span data-slate-string="true">...</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7522"><span data-slate-object="text" data-key="7523"><span data-slate-leaf="true" data-offset-key="7523:0" data-first-offset="true"><span data-slate-string="true">了解其接口后，通过 goleveldb 的库，client 调用就非常简单了，下面是 metcd 项目中，leveldb 存储引擎 Put 接口的实现。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="7524"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7525"><span data-slate-object="text" data-key="7526"><span data-slate-leaf="true" data-offset-key="7526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="7527"><span data-slate-leaf="true" data-offset-key="7527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="7528"><span data-slate-leaf="true" data-offset-key="7528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s *leveldbKVStore)</span></span></span></span></span><span data-slate-object="text" data-key="7529"><span data-slate-leaf="true" data-offset-key="7529:0" data-first-offset="true"><span data-slate-string="true"> Put(key, value </span></span></span><span data-slate-object="text" data-key="7530"><span data-slate-leaf="true" data-offset-key="7530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="7531"><span data-slate-leaf="true" data-offset-key="7531:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="7532"><span data-slate-leaf="true" data-offset-key="7532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="7533"><span data-slate-leaf="true" data-offset-key="7533:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7534"><span data-slate-object="text" data-key="7535"><span data-slate-leaf="true" data-offset-key="7535:0" data-first-offset="true"><span data-slate-string="true">   err := s.db.Put([]</span></span></span><span data-slate-object="text" data-key="7536"><span data-slate-leaf="true" data-offset-key="7536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7537"><span data-slate-leaf="true" data-offset-key="7537:0" data-first-offset="true"><span data-slate-string="true">(key), []</span></span></span><span data-slate-object="text" data-key="7538"><span data-slate-leaf="true" data-offset-key="7538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span><span data-slate-object="text" data-key="7539"><span data-slate-leaf="true" data-offset-key="7539:0" data-first-offset="true"><span data-slate-string="true">(value), </span></span></span><span data-slate-object="text" data-key="7540"><span data-slate-leaf="true" data-offset-key="7540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7541"><span data-slate-leaf="true" data-offset-key="7541:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7542"><span data-slate-object="text" data-key="7543"><span data-slate-leaf="true" data-offset-key="7543:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7544"><span data-slate-leaf="true" data-offset-key="7544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7545"><span data-slate-leaf="true" data-offset-key="7545:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="7546"><span data-slate-leaf="true" data-offset-key="7546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="7547"><span data-slate-leaf="true" data-offset-key="7547:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7548"><span data-slate-object="text" data-key="7549"><span data-slate-leaf="true" data-offset-key="7549:0" data-first-offset="true"><span data-slate-string="true">      log.Printf(</span></span></span><span data-slate-object="text" data-key="7550"><span data-slate-leaf="true" data-offset-key="7550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"failed to put key %s, value %s, err is %v"</span></span></span></span><span data-slate-object="text" data-key="7551"><span data-slate-leaf="true" data-offset-key="7551:0" data-first-offset="true"><span data-slate-string="true">, key, value, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7552"><span data-slate-object="text" data-key="7553"><span data-slate-leaf="true" data-offset-key="7553:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="7554"><span data-slate-leaf="true" data-offset-key="7554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7555"><span data-slate-leaf="true" data-offset-key="7555:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7556"><span data-slate-object="text" data-key="7557"><span data-slate-leaf="true" data-offset-key="7557:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7558"><span data-slate-object="text" data-key="7559"><span data-slate-leaf="true" data-offset-key="7559:0" data-first-offset="true"><span data-slate-string="true">   log.Printf(</span></span></span><span data-slate-object="text" data-key="7560"><span data-slate-leaf="true" data-offset-key="7560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"backend:%s,put key:%s,value:%s succ"</span></span></span></span><span data-slate-object="text" data-key="7561"><span data-slate-leaf="true" data-offset-key="7561:0" data-first-offset="true"><span data-slate-string="true">, s.config.backend, key, value)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7562"><span data-slate-object="text" data-key="7563"><span data-slate-leaf="true" data-offset-key="7563:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="7564"><span data-slate-leaf="true" data-offset-key="7564:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7565"><span data-slate-leaf="true" data-offset-key="7565:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7566"><span data-slate-leaf="true" data-offset-key="7566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7567"><span data-slate-object="text" data-key="7568"><span data-slate-leaf="true" data-offset-key="7568:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="7569" id="sr-toc-13"><span data-slate-object="text" data-key="7570"><span data-slate-leaf="true" data-offset-key="7570:0" data-first-offset="true"><span data-slate-string="true">读写流程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="7571"><span data-slate-object="text" data-key="7572"><span data-slate-leaf="true" data-offset-key="7572:0" data-first-offset="true"><span data-slate-string="true">介绍完在 metcd 项目中如何使用 Raft 共识模块、支持多存储引擎后，我们再从整体上介绍下在 metcd 中写入和读取一个 key-value 的流程。</span></span></span></div><h4 data-slate-type="heading" data-slate-object="block" data-key="7573" id="sr-toc-14"><span data-slate-object="text" data-key="7574"><span data-slate-leaf="true" data-offset-key="7574:0" data-first-offset="true"><span data-slate-string="true">写流程</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="7575"><span data-slate-object="text" data-key="7576"><span data-slate-leaf="true" data-offset-key="7576:0" data-first-offset="true"><span data-slate-string="true">当你通过如下 curl 命令发起一个写操作时，写流程如下面架构图序号所示:</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="7577"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7578"><span data-slate-object="text" data-key="7579"><span data-slate-leaf="true" data-offset-key="7579:0" data-first-offset="true"><span data-slate-string="true">curl -L </span></span></span><span data-slate-object="text" data-key="7580"><span data-slate-leaf="true" data-offset-key="7580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">http</span></span></span></span><span data-slate-object="text" data-key="7581"><span data-slate-leaf="true" data-offset-key="7581:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="7582"><span data-slate-leaf="true" data-offset-key="7582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//127.0.0.1:3379/hello -XPUT -d world</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7583"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="7584"><div data-slate-type="list-line" data-slate-object="block" data-key="7585"><span data-slate-object="text" data-key="7586"><span data-slate-leaf="true" data-offset-key="7586:0" data-first-offset="true"><span data-slate-string="true">client 通过 curl 发送 HTTP PUT 请求到 server；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7587"><span data-slate-object="text" data-key="7588"><span data-slate-leaf="true" data-offset-key="7588:0" data-first-offset="true"><span data-slate-string="true">server 收到后，将消息写入到 KVStore 的 ProposeC 管道；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7589"><span data-slate-object="text" data-key="7590"><span data-slate-leaf="true" data-offset-key="7590:0" data-first-offset="true"><span data-slate-string="true">raftNode 循环逻辑将消息通过 Raft 模块的 Propose 接口提交；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7591"><span data-slate-object="text" data-key="7592"><span data-slate-leaf="true" data-offset-key="7592:0" data-first-offset="true"><span data-slate-string="true">Raft 模块输出 Ready 结构，server 将日志条目持久化后，并发送给其他节点；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7593"><span data-slate-object="text" data-key="7594"><span data-slate-leaf="true" data-offset-key="7594:0" data-first-offset="true"><span data-slate-string="true">集群多数节点持久化此日志条目后，这个日志条目被提交给存储状态机 KVStore 执行；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7595"><span data-slate-object="text" data-key="7596"><span data-slate-leaf="true" data-offset-key="7596:0" data-first-offset="true"><span data-slate-string="true">KVStore 根据启动的 backend 存储引擎名称，调用对应的 Put 接口即可。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="7597"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/9b/c1/9b84a7e312165de46749e1c4046fc9c1.png?wh=1920*1135"></div></div><h4 data-slate-type="heading" data-slate-object="block" data-key="7598" id="sr-toc-15"><span data-slate-object="text" data-key="7599"><span data-slate-leaf="true" data-offset-key="7599:0" data-first-offset="true"><span data-slate-string="true">读流程</span></span></span></h4><div data-slate-type="paragraph" data-slate-object="block" data-key="7600"><span data-slate-object="text" data-key="7601"><span data-slate-leaf="true" data-offset-key="7601:0" data-first-offset="true"><span data-slate-string="true">当你通过如下 curl 命令发起一个读操作时，读流程如下面架构图序号所示：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="7602"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7603"><span data-slate-object="text" data-key="7604"><span data-slate-leaf="true" data-offset-key="7604:0" data-first-offset="true"><span data-slate-string="true">curl -L </span></span></span><span data-slate-object="text" data-key="7605"><span data-slate-leaf="true" data-offset-key="7605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">http</span></span></span></span><span data-slate-object="text" data-key="7606"><span data-slate-leaf="true" data-offset-key="7606:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="7607"><span data-slate-leaf="true" data-offset-key="7607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//127.0.0.1:3379/hello</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7608"><span data-slate-object="text" data-key="7609"><span data-slate-leaf="true" data-offset-key="7609:0" data-first-offset="true"><span data-slate-string="true">world</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="list" data-slate-object="block" data-key="7610"><div data-slate-type="list-line" data-slate-object="block" data-key="7611"><span data-slate-object="text" data-key="7612"><span data-slate-leaf="true" data-offset-key="7612:0" data-first-offset="true"><span data-slate-string="true">client 通过 curl 发送 HTTP Get 请求到 server；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7613"><span data-slate-object="text" data-key="7614"><span data-slate-leaf="true" data-offset-key="7614:0" data-first-offset="true"><span data-slate-string="true">server 收到后，根据 KVStore 的存储引擎，从后端查询出对应的 key-value 数据。</span></span></span></div></div><div data-slate-type="image" data-slate-object="block" data-key="7615"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/17/b2/1746fbd9e9435d8607e44bea2d2c39b2.png?wh=1920*1187"></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7616" id="sr-toc-16"><span data-slate-object="text" data-key="7617"><span data-slate-leaf="true" data-offset-key="7617:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7618"><span data-slate-object="text" data-key="7619"><span data-slate-leaf="true" data-offset-key="7619:0" data-first-offset="true"><span data-slate-string="true">最后，我来总结下我们今天的内容。我这节课分别从整体架构设计和实现分析，给你介绍了如何基于 Raft 从 0 到 1 构建一个支持多存储引擎的分布式 key-value 数据库。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7620"><span data-slate-object="text" data-key="7621"><span data-slate-leaf="true" data-offset-key="7621:0" data-first-offset="true"><span data-slate-string="true">在整体架构设计上，我给你介绍了 API 设计核心因素，它们分别是性能、易用性、开发效率、安全性、幂等性。其次我和你介绍了复制状态机的原理，它由共识模块、日志模块、存储状态机模块组成。最后我和你深入分析了多存储引擎设计，重点介绍了 leveldb 原理，它将随机写转换为顺序写日志和内存，通过一系列分层、创新的设计实现了优异的写性能，适合读少写多。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7622"><span data-slate-object="text" data-key="7623"><span data-slate-leaf="true" data-offset-key="7623:0" data-first-offset="true"><span data-slate-string="true">在实现分析上，我和你重点介绍了 Raft 算法库的核心对象 Node API。对于一个库而言，我们重点关注的是其输入、输出接口，业务逻辑层可通过 Propose 接口提交提案，通过 Ready 结构获取 Raft 算法状态机的输出内容。其次我和你介绍了 Raft 算法库如何与 WAL 模块、Raft 日志存储模块、网络模块协作完成一个写请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7624"><span data-slate-object="text" data-key="7625"><span data-slate-leaf="true" data-offset-key="7625:0" data-first-offset="true"><span data-slate-string="true">最后为了支持多存储引擎，我们分别基于 boltdb、leveldb 实现了 KVStore 相关接口操作，并通过读写流程图，从整体上为你介绍了一个读写请求在 metcd 中是如何工作的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7626"><span data-slate-object="text" data-key="7627"><span data-slate-leaf="true" data-offset-key="7627:0" data-first-offset="true"><span data-slate-string="true">麻雀虽小，五脏俱全。希望能通过这个迷你项目解答你对如何构建一个简易分布式 KV 服务的疑问，以及让你对 etcd 的工作原理有更深的理解。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7628" id="sr-toc-17"><span data-slate-object="text" data-key="7629"><span data-slate-leaf="true" data-offset-key="7629:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7630"><span data-slate-object="text" data-key="7631"><span data-slate-leaf="true" data-offset-key="7631:0" data-first-offset="true"><span data-slate-string="true">你知道 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7632"><span data-slate-object="text" data-key="7633"><span data-slate-leaf="true" data-offset-key="7633:0" data-first-offset="true"><span data-slate-string="true">raftexample</span></span></span></a><span data-slate-object="text" data-key="7634"><span data-slate-leaf="true" data-offset-key="7634:0" data-first-offset="true"><span data-slate-string="true"> 启动的时候是如何工作的吗？它的存储引擎内存 map 是如何保证数据不丢失的呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7635"><span data-slate-object="text" data-key="7636"><span data-slate-leaf="true" data-offset-key="7636:0" data-first-offset="true"><span data-slate-string="true">感谢你的阅读，如果你认为这节课的内容有收获，也欢迎把它分享给你的朋友，我们下一讲见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png" style="width: auto;"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-18">精选留言 (5)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/22/3a/de/e5c30589.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>云原生工程师</span></div></div><div>设计上存储引擎的介绍，获益匪浅，具体实现上的解读，也搞清了之前几个疑问，etcd 足够轻量级，简直就是学习分布式系统的最佳案例，后面抽空自己基于 raft 搞个小小项目，进一步加深下，老师在这块有什么分布式书籍推荐没</div><div><p>作者回复：嗯，自己动手会有更深的理解，书籍推荐《Designing Data-Intensive Applications》，中文名《设计数据密集型应用》，豆瓣评分高达 9.7，https://book.douban.com/subject/30329536/，非常不错的分布式入门书籍。</p></div><div><div>2021-03-02</div><div><div><i></i><span>2</span></div><div><i></i><span>11</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/2a/b9/2bf8cc89.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 无名氏</span></div></div><div>大佬 有完整 demo 可以分享吗😀</div><div><div>2022-02-08</div><div><div><i></i><span></span></div><div><i></i><span>6</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/36/7d/eab0d26a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 丹尼尔 - 雪碧</span></div></div><div>请问大佬，raft 模块返回的快照信息，快照是从哪里来的？我理解快照就是从 kvStorage 来的？所以是当需要生成快照的时候，raft 模块调用 kvStorage 的接口生成快照？</div><div><div>2022-07-31</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/49/fc/5627215c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>小何</span></div></div><div>这个实现的代码在哪里可以下载？</div><div><div>2022-05-28</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/bc/fc/cf98963a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>lixg</span></div></div><div>文中提到 “Messages，持久化 Entries 后，发送给其他节点的消息”

这里的消息是指什么消息，包含什么内容？</div><div><div>2022-03-14</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1j"><outline class="toc-level-h1" data-reactid=".1j.0" style="width: 175px;"><active data-reactid=".1j.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1j.0.1"><span data-reactid=".1j.0.1.0">18 | 实战：如何基于 Raft 从 0 到 1 构建一个支持多存储引擎分布式 KV 服务？</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.1" style="width: 165px;"><active data-reactid=".1j.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1j.1.1"><span data-reactid=".1j.1.1.0">整体架构设计</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.2" style="width: 155px;"><active data-reactid=".1j.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1j.2.1"><span data-reactid=".1j.2.1.0">API 设计</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.3" style="width: 155px;"><active data-reactid=".1j.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1j.3.1"><span data-reactid=".1j.3.1.0">复制状态机</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.4" style="width: 155px;"><active data-reactid=".1j.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1j.4.1"><span data-reactid=".1j.4.1.0">多存储引擎</span></a></outline><outline class="toc-level-h4" data-reactid=".1j.5" style="width: 145px;"><active data-reactid=".1j.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1j.5.1"><span data-reactid=".1j.5.1.0">boltdb</span></a></outline><outline class="toc-level-h4" data-reactid=".1j.6" style="width: 145px;"><active data-reactid=".1j.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1j.6.1"><span data-reactid=".1j.6.1.0">leveldb</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.7" style="width: 165px;"><active data-reactid=".1j.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1j.7.1"><span data-reactid=".1j.7.1.0">实现分析</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.8" style="width: 155px;"><active data-reactid=".1j.8.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1j.8.1"><span data-reactid=".1j.8.1.0">Raft 算法库</span></a></outline><outline class="toc-level-h4" data-reactid=".1j.9" style="width: 145px;"><active data-reactid=".1j.9.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1j.9.1"><span data-reactid=".1j.9.1.0">Raft API</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.a" style="width: 155px;"><active data-reactid=".1j.a.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1j.a.1"><span data-reactid=".1j.a.1.0">支持多存储引擎</span></a></outline><outline class="toc-level-h4" data-reactid=".1j.b" style="width: 145px;"><active data-reactid=".1j.b.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1j.b.1"><span data-reactid=".1j.b.1.0">boltdb</span></a></outline><outline class="toc-level-h4" data-reactid=".1j.c" style="width: 145px;"><active data-reactid=".1j.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".1j.c.1"><span data-reactid=".1j.c.1.0">leveldb</span></a></outline><outline class="toc-level-h3" data-reactid=".1j.d" style="width: 155px;"><active data-reactid=".1j.d.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-13" data-reactid=".1j.d.1"><span data-reactid=".1j.d.1.0">读写流程</span></a></outline><outline class="toc-level-h4" data-reactid=".1j.e" style="width: 145px;"><active data-reactid=".1j.e.0"></active><a class="toc-outline-theme-github" href="#sr-toc-14" data-reactid=".1j.e.1"><span data-reactid=".1j.e.1.0">写流程</span></a></outline><outline class="toc-level-h4" data-reactid=".1j.f" style="width: 145px;"><active data-reactid=".1j.f.0"></active><a class="toc-outline-theme-github" href="#sr-toc-15" data-reactid=".1j.f.1"><span data-reactid=".1j.f.1.0">读流程</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.g" style="width: 165px;"><active data-reactid=".1j.g.0"></active><a class="toc-outline-theme-github" href="#sr-toc-16" data-reactid=".1j.g.1"><span data-reactid=".1j.g.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.h" style="width: 165px;"><active data-reactid=".1j.h.0"></active><a class="toc-outline-theme-github" href="#sr-toc-17" data-reactid=".1j.h.1"><span data-reactid=".1j.h.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1j.i" style="width: 165px;"><active data-reactid=".1j.i.0"></active><a class="toc-outline-theme-github" href="#sr-toc-18" data-reactid=".1j.i.1"><span data-reactid=".1j.i.1.0">精选留言 (5)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/347136" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>