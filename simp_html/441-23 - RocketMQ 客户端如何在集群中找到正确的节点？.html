
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 23 | RocketMQ 客户端如何在集群中找到正确的节点？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>23 | RocketMQ 客户端如何在集群中找到正确的节点？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">带着问题去读源码，最好是带着问题的答案去读源码。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">23 | RocketMQ 客户端如何在集群中找到正确的节点？</h1><div><span>李玥</span> <span> 2019-09-17</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/00/a5/00e1e18a433a78d973685afbe90bfaa5.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：李玥</span><span>大小：19.09M</span><span> 时长：13:53</span></div></div><audio title="23 | RocketMQ客户端如何在集群中找到正确的节点？" src="https://res001.geekbang.org//media/audio/10/c4/101d5b238d6e34039294281d2b91ddc4/ld/ld.m3u8" __idm_id__="1646620"></audio></div><div><div><div><div data-slate-editor="true" data-key="6967" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="6968"><span data-slate-object="text" data-key="6969"><span data-slate-leaf="true" data-offset-key="6969:0" data-first-offset="true"><span data-slate-string="true">你好，我是李玥。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6970"><span data-slate-object="text" data-key="6971"><span data-slate-leaf="true" data-offset-key="6971:0" data-first-offset="true"><span data-slate-string="true">我们在《</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6972"><span data-slate-object="text" data-key="6973"><span data-slate-leaf="true" data-offset-key="6973:0" data-first-offset="true"><span data-slate-string="true">21 | RocketMQ Producer 源码分析：消息生产的实现过程</span></span></span></a><span data-slate-object="text" data-key="6974"><span data-slate-leaf="true" data-offset-key="6974:0" data-first-offset="true"><span data-slate-string="true">》这节课中，讲解 RocketMQ 的生产者启动流程时提到过，生产者只要配置一个接入地址，就可以访问整个集群，并不需要客户端配置每个 Broker 的地址。RocketMQ 会自动根据要访问的主题名称和队列序号，找到对应的 Broker 地址。如果 Broker 发生宕机，客户端还会自动切换到新的 Broker 节点上，这些对于用户代码来说都是透明的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6975"><span data-slate-object="text" data-key="6976"><span data-slate-leaf="true" data-offset-key="6976:0" data-first-offset="true"><span data-slate-string="true">这些功能都是由 NameServer 协调 Broker 和客户端共同实现的，其中 NameServer 的作用是最关键的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6977"><span data-slate-object="text" data-key="6978"><span data-slate-leaf="true" data-offset-key="6978:0" data-first-offset="true"><span data-slate-string="true">展开来讲，不仅仅是 RocketMQ，</span></span><span data-slate-leaf="true" data-offset-key="6978:1"><span data-slate-object="annotation" data-annotation-key="gkann_bb945c53" data-attr-id="31811" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">任何一个弹性分布式集群，都需要一个类似于 NameServer 服务，来帮助访问集群的客户端寻找集群中的节点，</span></span></span><span data-slate-leaf="true" data-offset-key="6978:2"><span data-slate-string="true">这个服务一般称为 NamingService。比如，像 Dubbo 这种 RPC 框架，它的注册中心就承担了 NamingService 的职责。在 Flink 中，则是 JobManager 承担了 NamingService 的职责。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6979"><span data-slate-object="text" data-key="6980"><span data-slate-leaf="true" data-offset-key="6980:0" data-first-offset="true"><span data-slate-string="true">也就是说，这种使用 NamingService 服务来协调集群的设计，在分布式集群的架构设计中，是一种非常通用的方法。你在学习这节课之后，不仅要掌握 RocketMQ 的 NameServer 是如何实现的，还要能总结出通用的 NamingService 的设计思想，并能应用于其他分布式系统的设计中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6981"><span data-slate-object="text" data-key="6982"><span data-slate-leaf="true" data-offset-key="6982:0" data-first-offset="true"><span data-slate-string="true">这节课，我们一起来分析一下 NameServer 的源代码，看一下 NameServer 是如何协调集群中众多的 Broker 和客户端的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6983" id="sr-toc-1"><span data-slate-object="text" data-key="6984"><span data-slate-leaf="true" data-offset-key="6984:0" data-first-offset="true"><span data-slate-string="true">NameServer 是如何提供服务的？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6985"><span data-slate-object="text" data-key="6986"><span data-slate-leaf="true" data-offset-key="6986:0" data-first-offset="true"><span data-slate-string="true">在 RocketMQ 中，</span></span><span data-slate-leaf="true" data-offset-key="6986:1"><span data-slate-object="annotation" data-annotation-key="gkann_e042c323" data-attr-id="37425" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">NameServer 是一个独立的进程，</span></span></span><span data-slate-leaf="true" data-offset-key="6986:2"><span data-slate-string="true">为 Broker、生产者和消费者提供服务。</span></span><span data-slate-leaf="true" data-offset-key="6986:3"><span data-slate-object="annotation" data-annotation-key="gkann_d59ff6d1" data-attr-id="37426" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">NameServer 最主要的功能就是，为客户端提供寻址服务，协助客户端找到主题对应的 Broker 地址。此外，NameServer 还负责监控每个 Broker 的存活状态。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6987"><span data-slate-object="text" data-key="6988"><span data-slate-leaf="true" data-offset-key="6988:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1985dd50" data-attr-id="32245" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">NameServer 支持只部署一个节点，也支持部署多个节点组成一个集群，这样可以避免单点故障。在集群模式下，NameServer 各节点之间是不需要任何通信的，也不会通过任何方式互相感知，每个节点都可以独立提供全部服务。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6989"><span data-slate-object="text" data-key="6990"><span data-slate-leaf="true" data-offset-key="6990:0" data-first-offset="true"><span data-slate-string="true">我们一起通过这个图来看一下，在 RocketMQ 集群中，NameServer 是如何配合 Broker、生产者和消费者一起工作的。这个图来自 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6991"><span data-slate-object="text" data-key="6992"><span data-slate-leaf="true" data-offset-key="6992:0" data-first-offset="true"><span data-slate-string="true">RocketMQ 的官方文档</span></span></span></a><span data-slate-object="text" data-key="6993"><span data-slate-leaf="true" data-offset-key="6993:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6994"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/53/5e/53baeb70d388de042f7347d137b9d35e.jpeg?wh=2208*916"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6995"><span data-slate-object="text" data-key="6996"><span data-slate-leaf="true" data-offset-key="6996:0" data-first-offset="true"><span data-slate-string="true">每个 Broker 都需要和所有的 NameServer 节点进行通信。当 Broker 保存的 Topic 信息发生变化的时候，</span></span><span data-slate-leaf="true" data-offset-key="6996:1"><span data-slate-object="annotation" data-annotation-key="gkann_0862d622" data-attr-id="37427" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">它会主动通知所有的 NameServer 更新路由信息，为了保证数据一致性，Broker 还会定时给所有的 NameServer 节点上报路由信息。</span></span></span><span data-slate-leaf="true" data-offset-key="6996:2"><span data-slate-string="true">这个上报路由信息的 RPC 请求，也同时起到 Broker 与 NameServer 之间的心跳作用，NameServer 依靠这个心跳来确定 Broker 的健康状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6997"><span data-slate-object="text" data-key="6998"><span data-slate-leaf="true" data-offset-key="6998:0" data-first-offset="true"><span data-slate-string="true">因为每个 NameServer 节点都可以独立提供完整的服务，所以，对于客户端来说，包括生产者和消费者，只需要选择任意一个 NameServer 节点来查询路由信息就可以了。客户端在生产或消费某个主题的消息之前，会先从 NameServer 上查询这个主题的路由信息，然后根据路由信息获取到当前主题和队列对应的 Broker 物理地址，再连接到 Broker 节点上进行生产或消费。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6999"><span data-slate-object="text" data-key="7000"><span data-slate-leaf="true" data-offset-key="7000:0" data-first-offset="true"><span data-slate-string="true">如果 NameServer 检测到与 Broker 的连接中断了，NameServer 会认为这个 Broker 不再能提供服务。</span></span><span data-slate-leaf="true" data-offset-key="7000:1"><span data-slate-object="annotation" data-annotation-key="gkann_d377579f" data-attr-id="35824" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">NameServer 会立即把这个 Broker 从路由信息中移除掉，</span></span></span><span data-slate-leaf="true" data-offset-key="7000:2"><span data-slate-string="true">避免客户端连接到一个不可用的 Broker 上去。而客户端在与 Broker 通信失败之后，会重新去 NameServer 上拉取路由信息，然后连接到其他 Broker 上继续生产或消费消息，这样就实现了自动切换失效 Broker 的功能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7001"><span data-slate-object="text" data-key="7002"><span data-slate-leaf="true" data-offset-key="7002:0" data-first-offset="true"><span data-slate-string="true">此外，NameServer 还提供一个类似 Redis 的 KV 读写服务，这个不是主要的流程，我们不展开讲。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7003"><span data-slate-object="text" data-key="7004"><span data-slate-leaf="true" data-offset-key="7004:0" data-first-offset="true"><span data-slate-string="true">接下来我带你一起分析 NameServer 的源代码，看一下这些服务都是如何实现的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7005" id="sr-toc-2"><span data-slate-object="text" data-key="7006"><span data-slate-leaf="true" data-offset-key="7006:0" data-first-offset="true"><span data-slate-string="true">NameServer 的总体结构</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7007"><span data-slate-object="text" data-key="7008"><span data-slate-leaf="true" data-offset-key="7008:0" data-first-offset="true"><span data-slate-string="true">由于 NameServer 的结构非常简单，排除 KV 读写相关的类之后，一共只有 6 个类，这里面直接给出这 6 个类的说明：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7009"><div data-slate-type="list-line" data-slate-object="block" data-key="7010"><span data-slate-object="text" data-key="7011"><span data-slate-leaf="true" data-offset-key="7011:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">NamesrvStartup</span></span></span></span><span data-slate-object="text" data-key="7012"><span data-slate-leaf="true" data-offset-key="7012:0" data-first-offset="true"><span data-slate-string="true">：程序入口。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7013"><span data-slate-object="text" data-key="7014"><span data-slate-leaf="true" data-offset-key="7014:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">NamesrvController</span></span></span></span><span data-slate-object="text" data-key="7015"><span data-slate-leaf="true" data-offset-key="7015:0" data-first-offset="true"><span data-slate-string="true">：NameServer 的总控制器，负责所有服务的生命周期管理。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7016"><span data-slate-object="text" data-key="7017"><span data-slate-leaf="true" data-offset-key="7017:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">RouteInfoManager</span></span></span></span><span data-slate-object="text" data-key="7018"><span data-slate-leaf="true" data-offset-key="7018:0" data-first-offset="true"><span data-slate-string="true">：NameServer 最核心的实现类，负责保存和管理集群路由信息。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7019"><span data-slate-object="text" data-key="7020"><span data-slate-leaf="true" data-offset-key="7020:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">BrokerHousekeepingService</span></span></span></span><span data-slate-object="text" data-key="7021"><span data-slate-leaf="true" data-offset-key="7021:0" data-first-offset="true"><span data-slate-string="true">：监控 Broker 连接状态的代理类。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7022"><span data-slate-object="text" data-key="7023"><span data-slate-leaf="true" data-offset-key="7023:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">DefaultRequestProcessor</span></span></span></span><span data-slate-object="text" data-key="7024"><span data-slate-leaf="true" data-offset-key="7024:0" data-first-offset="true"><span data-slate-string="true">：负责处理客户端和 Broker 发送过来的 RPC 请求的处理器。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7025"><span data-slate-object="text" data-key="7026"><span data-slate-leaf="true" data-offset-key="7026:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">ClusterTestRequestProcessor</span></span></span></span><span data-slate-object="text" data-key="7027"><span data-slate-leaf="true" data-offset-key="7027:0" data-first-offset="true"><span data-slate-string="true">：用于测试的请求处理器。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7028"><span data-slate-object="text" data-key="7029"><span data-slate-leaf="true" data-offset-key="7029:0" data-first-offset="true"><span data-slate-string="true">RouteInfoManager 这个类中保存了所有的路由信息，这些路由信息都是保存在内存中，并且没有持久化的。在代码中，这些路由信息保存在 RouteInfoManager 的几个成员变量中：</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="7030"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7031"><span data-slate-object="text" data-key="7032"><span data-slate-leaf="true" data-offset-key="7032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7033"><span data-slate-leaf="true" data-offset-key="7033:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7034"><span data-slate-leaf="true" data-offset-key="7034:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="7035"><span data-slate-leaf="true" data-offset-key="7035:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7036"><span data-slate-leaf="true" data-offset-key="7036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerData</span></span></span></span><span data-slate-object="text" data-key="7037"><span data-slate-leaf="true" data-offset-key="7037:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7038"><span data-slate-leaf="true" data-offset-key="7038:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">implements</span></span></span></span><span data-slate-object="text" data-key="7039"><span data-slate-leaf="true" data-offset-key="7039:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7040"><span data-slate-leaf="true" data-offset-key="7040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Comparable</span></span></span></span><span data-slate-object="text" data-key="7041"><span data-slate-leaf="true" data-offset-key="7041:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7042"><span data-slate-leaf="true" data-offset-key="7042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerData</span></span></span></span><span data-slate-object="text" data-key="7043"><span data-slate-leaf="true" data-offset-key="7043:0" data-first-offset="true"><span data-slate-string="true">&gt; {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7044"><span data-slate-object="text" data-key="7045"><span data-slate-leaf="true" data-offset-key="7045:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7046"><span data-slate-leaf="true" data-offset-key="7046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7047"><span data-slate-object="text" data-key="7048"><span data-slate-leaf="true" data-offset-key="7048:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7049"><span data-slate-leaf="true" data-offset-key="7049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7050"><span data-slate-leaf="true" data-offset-key="7050:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7051"><span data-slate-leaf="true" data-offset-key="7051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HashMap</span></span></span></span><span data-slate-object="text" data-key="7052"><span data-slate-leaf="true" data-offset-key="7052:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7053"><span data-slate-leaf="true" data-offset-key="7053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7054"><span data-slate-leaf="true" data-offset-key="7054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* topic */</span></span></span></span><span data-slate-object="text" data-key="7055"><span data-slate-leaf="true" data-offset-key="7055:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7056"><span data-slate-leaf="true" data-offset-key="7056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="7057"><span data-slate-leaf="true" data-offset-key="7057:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7058"><span data-slate-leaf="true" data-offset-key="7058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">QueueData</span></span></span></span><span data-slate-object="text" data-key="7059"><span data-slate-leaf="true" data-offset-key="7059:0" data-first-offset="true"><span data-slate-string="true">&gt;&gt; topicQueueTable;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7060"><span data-slate-object="text" data-key="7061"><span data-slate-leaf="true" data-offset-key="7061:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7062"><span data-slate-leaf="true" data-offset-key="7062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7063"><span data-slate-leaf="true" data-offset-key="7063:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7064"><span data-slate-leaf="true" data-offset-key="7064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HashMap</span></span></span></span><span data-slate-object="text" data-key="7065"><span data-slate-leaf="true" data-offset-key="7065:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7066"><span data-slate-leaf="true" data-offset-key="7066:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7067"><span data-slate-leaf="true" data-offset-key="7067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* brokerName */</span></span></span></span><span data-slate-object="text" data-key="7068"><span data-slate-leaf="true" data-offset-key="7068:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7069"><span data-slate-leaf="true" data-offset-key="7069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerData</span></span></span></span><span data-slate-object="text" data-key="7070"><span data-slate-leaf="true" data-offset-key="7070:0" data-first-offset="true"><span data-slate-string="true">&gt; brokerAddrTable;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7071"><span data-slate-object="text" data-key="7072"><span data-slate-leaf="true" data-offset-key="7072:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7073"><span data-slate-leaf="true" data-offset-key="7073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7074"><span data-slate-leaf="true" data-offset-key="7074:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7075"><span data-slate-leaf="true" data-offset-key="7075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HashMap</span></span></span></span><span data-slate-object="text" data-key="7076"><span data-slate-leaf="true" data-offset-key="7076:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7077"><span data-slate-leaf="true" data-offset-key="7077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7078"><span data-slate-leaf="true" data-offset-key="7078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* clusterName */</span></span></span></span><span data-slate-object="text" data-key="7079"><span data-slate-leaf="true" data-offset-key="7079:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7080"><span data-slate-leaf="true" data-offset-key="7080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="7081"><span data-slate-leaf="true" data-offset-key="7081:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7082"><span data-slate-leaf="true" data-offset-key="7082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7083"><span data-slate-leaf="true" data-offset-key="7083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* brokerName */</span></span></span></span><span data-slate-object="text" data-key="7084"><span data-slate-leaf="true" data-offset-key="7084:0" data-first-offset="true"><span data-slate-string="true">&gt;&gt; clusterAddrTable;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7085"><span data-slate-object="text" data-key="7086"><span data-slate-leaf="true" data-offset-key="7086:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7087"><span data-slate-leaf="true" data-offset-key="7087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7088"><span data-slate-leaf="true" data-offset-key="7088:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7089"><span data-slate-leaf="true" data-offset-key="7089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HashMap</span></span></span></span><span data-slate-object="text" data-key="7090"><span data-slate-leaf="true" data-offset-key="7090:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7091"><span data-slate-leaf="true" data-offset-key="7091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7092"><span data-slate-leaf="true" data-offset-key="7092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* brokerAddr */</span></span></span></span><span data-slate-object="text" data-key="7093"><span data-slate-leaf="true" data-offset-key="7093:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7094"><span data-slate-leaf="true" data-offset-key="7094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerLiveInfo</span></span></span></span><span data-slate-object="text" data-key="7095"><span data-slate-leaf="true" data-offset-key="7095:0" data-first-offset="true"><span data-slate-string="true">&gt; brokerLiveTable;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7096"><span data-slate-object="text" data-key="7097"><span data-slate-leaf="true" data-offset-key="7097:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7098"><span data-slate-leaf="true" data-offset-key="7098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7099"><span data-slate-leaf="true" data-offset-key="7099:0" data-first-offset="true"><span data-slate-string="true"> final </span></span></span><span data-slate-object="text" data-key="7100"><span data-slate-leaf="true" data-offset-key="7100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HashMap</span></span></span></span><span data-slate-object="text" data-key="7101"><span data-slate-leaf="true" data-offset-key="7101:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7102"><span data-slate-leaf="true" data-offset-key="7102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7103"><span data-slate-leaf="true" data-offset-key="7103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* brokerAddr */</span></span></span></span><span data-slate-object="text" data-key="7104"><span data-slate-leaf="true" data-offset-key="7104:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7105"><span data-slate-leaf="true" data-offset-key="7105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="7106"><span data-slate-leaf="true" data-offset-key="7106:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7107"><span data-slate-leaf="true" data-offset-key="7107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7108"><span data-slate-leaf="true" data-offset-key="7108:0" data-first-offset="true"><span data-slate-string="true">&gt;</span></span></span><span data-slate-object="text" data-key="7109"><span data-slate-leaf="true" data-offset-key="7109:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* Filter Server */</span></span></span></span><span data-slate-object="text" data-key="7110"><span data-slate-leaf="true" data-offset-key="7110:0" data-first-offset="true"><span data-slate-string="true">&gt; filterServerTable;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7111"><span data-slate-object="text" data-key="7112"><span data-slate-leaf="true" data-offset-key="7112:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="7113"><span data-slate-leaf="true" data-offset-key="7113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7114"><span data-slate-object="text" data-key="7115"><span data-slate-leaf="true" data-offset-key="7115:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7116"><span data-slate-object="text" data-key="7117"><span data-slate-leaf="true" data-offset-key="7117:0" data-first-offset="true"><span data-slate-string="true">以上代码中的这 5 个 Map 对象，保存了集群所有的 Broker 和主题的路由信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7118"><span data-slate-object="text" data-key="7119"><span data-slate-leaf="true" data-offset-key="7119:0" data-first-offset="true"><span data-slate-string="true">topicQueueTable 保存的是主题和队列信息，其中每个队列信息对应的类 QueueData 中，还保存了 brokerName。需要注意的是，这个 brokerName 并不真正是某个 Broker 的物理地址，它对应的一组 Broker 节点，包括一个主节点和若干个从节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7120"><span data-slate-object="text" data-key="7121"><span data-slate-leaf="true" data-offset-key="7121:0" data-first-offset="true"><span data-slate-string="true">brokerAddrTable 中保存了集群中每个 brokerName 对应 Broker 信息，每个 Broker 信息用一个 BrokerData 对象表示：</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="7122"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7123"><span data-slate-object="text" data-key="7124"><span data-slate-leaf="true" data-offset-key="7124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7125"><span data-slate-leaf="true" data-offset-key="7125:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7126"><span data-slate-leaf="true" data-offset-key="7126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="7127"><span data-slate-leaf="true" data-offset-key="7127:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7128"><span data-slate-leaf="true" data-offset-key="7128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerData</span></span></span></span><span data-slate-object="text" data-key="7129"><span data-slate-leaf="true" data-offset-key="7129:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7130"><span data-slate-leaf="true" data-offset-key="7130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">implements</span></span></span></span><span data-slate-object="text" data-key="7131"><span data-slate-leaf="true" data-offset-key="7131:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7132"><span data-slate-leaf="true" data-offset-key="7132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Comparable</span></span></span></span><span data-slate-object="text" data-key="7133"><span data-slate-leaf="true" data-offset-key="7133:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7134"><span data-slate-leaf="true" data-offset-key="7134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">BrokerData</span></span></span></span><span data-slate-object="text" data-key="7135"><span data-slate-leaf="true" data-offset-key="7135:0" data-first-offset="true"><span data-slate-string="true">&gt; {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7136"><span data-slate-object="text" data-key="7137"><span data-slate-leaf="true" data-offset-key="7137:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7138"><span data-slate-leaf="true" data-offset-key="7138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7139"><span data-slate-leaf="true" data-offset-key="7139:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7140"><span data-slate-leaf="true" data-offset-key="7140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7141"><span data-slate-leaf="true" data-offset-key="7141:0" data-first-offset="true"><span data-slate-string="true"> cluster;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7142"><span data-slate-object="text" data-key="7143"><span data-slate-leaf="true" data-offset-key="7143:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7144"><span data-slate-leaf="true" data-offset-key="7144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7145"><span data-slate-leaf="true" data-offset-key="7145:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7146"><span data-slate-leaf="true" data-offset-key="7146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7147"><span data-slate-leaf="true" data-offset-key="7147:0" data-first-offset="true"><span data-slate-string="true"> brokerName;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7148"><span data-slate-object="text" data-key="7149"><span data-slate-leaf="true" data-offset-key="7149:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7150"><span data-slate-leaf="true" data-offset-key="7150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7151"><span data-slate-leaf="true" data-offset-key="7151:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7152"><span data-slate-leaf="true" data-offset-key="7152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">HashMap</span></span></span></span><span data-slate-object="text" data-key="7153"><span data-slate-leaf="true" data-offset-key="7153:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7154"><span data-slate-leaf="true" data-offset-key="7154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Long</span></span></span></span><span data-slate-object="text" data-key="7155"><span data-slate-leaf="true" data-offset-key="7155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* brokerId */</span></span></span></span><span data-slate-object="text" data-key="7156"><span data-slate-leaf="true" data-offset-key="7156:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7157"><span data-slate-leaf="true" data-offset-key="7157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7158"><span data-slate-leaf="true" data-offset-key="7158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">/* broker address */</span></span></span></span><span data-slate-object="text" data-key="7159"><span data-slate-leaf="true" data-offset-key="7159:0" data-first-offset="true"><span data-slate-string="true">&gt; brokerAddrs;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7160"><span data-slate-object="text" data-key="7161"><span data-slate-leaf="true" data-offset-key="7161:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7162"><span data-slate-leaf="true" data-offset-key="7162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7163"><span data-slate-object="text" data-key="7164"><span data-slate-leaf="true" data-offset-key="7164:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7165"><span data-slate-object="text" data-key="7166"><span data-slate-leaf="true" data-offset-key="7166:0" data-first-offset="true"><span data-slate-string="true">BrokerData 中保存了集群名称 cluster，brokerName 和一个保存 Broker 物理地址的 Map：brokerAddrs，它的 Key 是 BrokerID，Value 就是这个 BrokerID 对应的 Broker 的物理地址。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7167"><span data-slate-object="text" data-key="7168"><span data-slate-leaf="true" data-offset-key="7168:0" data-first-offset="true"><span data-slate-string="true">下面这三个 map 相对没那么重要，简单说明如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7169"><div data-slate-type="list-line" data-slate-object="block" data-key="7170"><span data-slate-object="text" data-key="7171"><span data-slate-leaf="true" data-offset-key="7171:0" data-first-offset="true"><span data-slate-string="true">brokerLiveTable 中，保存了每个 Broker 当前的动态信息，包括心跳更新时间，路由数据版本等等。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7172"><span data-slate-object="text" data-key="7173"><span data-slate-leaf="true" data-offset-key="7173:0" data-first-offset="true"><span data-slate-string="true">clusterAddrTable 中，保存的是集群名称与 BrokerName 的对应关系。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="7174"><span data-slate-object="text" data-key="7175"><span data-slate-leaf="true" data-offset-key="7175:0" data-first-offset="true"><span data-slate-string="true">filterServerTable 中，保存了每个 Broker 对应的消息过滤服务的地址，用于服务端消息过滤。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7176"><span data-slate-object="text" data-key="7177"><span data-slate-leaf="true" data-offset-key="7177:0" data-first-offset="true"><span data-slate-string="true">可以看到，在 NameServer 的 RouteInfoManager 中，主要的路由信息就是由 topicQueueTable 和 brokerAddrTable 这两个 Map 来保存的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7178"><span data-slate-object="text" data-key="7179"><span data-slate-leaf="true" data-offset-key="7179:0" data-first-offset="true"><span data-slate-string="true">在了解了总体结构和数据结构之后，我们再来看一下实现的流程。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7180" id="sr-toc-3"><span data-slate-object="text" data-key="7181"><span data-slate-leaf="true" data-offset-key="7181:0" data-first-offset="true"><span data-slate-string="true">NameServer 如何处理 Broker 注册的路由信息？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7182"><span data-slate-object="text" data-key="7183"><span data-slate-leaf="true" data-offset-key="7183:0" data-first-offset="true"><span data-slate-string="true">首先来看一下，NameServer 是如何处理 Broker 注册的路由信息的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7184"><span data-slate-object="text" data-key="7185"><span data-slate-leaf="true" data-offset-key="7185:0" data-first-offset="true"><span data-slate-string="true">NameServer 处理 Broker 和客户端所有 RPC 请求的入口方法是：“DefaultRequestProcessor#processRequest”，其中处理 Broker 注册请求的代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="7186"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7187"><span data-slate-object="text" data-key="7188"><span data-slate-leaf="true" data-offset-key="7188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7189"><span data-slate-leaf="true" data-offset-key="7189:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7190"><span data-slate-leaf="true" data-offset-key="7190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="7191"><span data-slate-leaf="true" data-offset-key="7191:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7192"><span data-slate-leaf="true" data-offset-key="7192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">DefaultRequestProcessor</span></span></span></span><span data-slate-object="text" data-key="7193"><span data-slate-leaf="true" data-offset-key="7193:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7194"><span data-slate-leaf="true" data-offset-key="7194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">implements</span></span></span></span><span data-slate-object="text" data-key="7195"><span data-slate-leaf="true" data-offset-key="7195:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7196"><span data-slate-leaf="true" data-offset-key="7196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NettyRequestProcessor</span></span></span></span><span data-slate-object="text" data-key="7197"><span data-slate-leaf="true" data-offset-key="7197:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7198"><span data-slate-object="text" data-key="7199"><span data-slate-leaf="true" data-offset-key="7199:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7200"><span data-slate-leaf="true" data-offset-key="7200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7201"><span data-slate-object="text" data-key="7202"><span data-slate-leaf="true" data-offset-key="7202:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7203"><span data-slate-leaf="true" data-offset-key="7203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">@Override</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7204"><span data-slate-object="text" data-key="7205"><span data-slate-leaf="true" data-offset-key="7205:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7206"><span data-slate-leaf="true" data-offset-key="7206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7207"><span data-slate-leaf="true" data-offset-key="7207:0" data-first-offset="true"><span data-slate-string="true"> RemotingCommand </span></span></span><span data-slate-object="text" data-key="7208"><span data-slate-leaf="true" data-offset-key="7208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processRequest</span></span></span></span><span data-slate-object="text" data-key="7209"><span data-slate-leaf="true" data-offset-key="7209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(ChannelHandlerContext ctx,</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7210"><span data-slate-object="text" data-key="7211"><span data-slate-leaf="true" data-offset-key="7211:0" data-first-offset="true"><span data-slate-string="true">        RemotingCommand request) </span></span></span><span data-slate-object="text" data-key="7212"><span data-slate-leaf="true" data-offset-key="7212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">throws</span></span></span></span><span data-slate-object="text" data-key="7213"><span data-slate-leaf="true" data-offset-key="7213:0" data-first-offset="true"><span data-slate-string="true"> RemotingCommandException {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7214"><span data-slate-object="text" data-key="7215"><span data-slate-leaf="true" data-offset-key="7215:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7216"><span data-slate-leaf="true" data-offset-key="7216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7217"><span data-slate-object="text" data-key="7218"><span data-slate-leaf="true" data-offset-key="7218:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7219"><span data-slate-leaf="true" data-offset-key="7219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">switch</span></span></span></span><span data-slate-object="text" data-key="7220"><span data-slate-leaf="true" data-offset-key="7220:0" data-first-offset="true"><span data-slate-string="true"> (request.getCode()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7221"><span data-slate-object="text" data-key="7222"><span data-slate-leaf="true" data-offset-key="7222:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7223"><span data-slate-leaf="true" data-offset-key="7223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7224"><span data-slate-object="text" data-key="7225"><span data-slate-leaf="true" data-offset-key="7225:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7226"><span data-slate-leaf="true" data-offset-key="7226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="7227"><span data-slate-leaf="true" data-offset-key="7227:0" data-first-offset="true"><span data-slate-string="true"> RequestCode.REGISTER_BROKER:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7228"><span data-slate-object="text" data-key="7229"><span data-slate-leaf="true" data-offset-key="7229:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7230"><span data-slate-leaf="true" data-offset-key="7230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Version</span></span></span></span><span data-slate-object="text" data-key="7231"><span data-slate-leaf="true" data-offset-key="7231:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7232"><span data-slate-leaf="true" data-offset-key="7232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">brokerVersion</span></span></span></span><span data-slate-object="text" data-key="7233"><span data-slate-leaf="true" data-offset-key="7233:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7234"><span data-slate-leaf="true" data-offset-key="7234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="7235"><span data-slate-leaf="true" data-offset-key="7235:0" data-first-offset="true"><span data-slate-string="true"> MQVersion.value2Version(request.getVersion());</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7236"><span data-slate-object="text" data-key="7237"><span data-slate-leaf="true" data-offset-key="7237:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7238"><span data-slate-leaf="true" data-offset-key="7238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7239"><span data-slate-leaf="true" data-offset-key="7239:0" data-first-offset="true"><span data-slate-string="true"> (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7240"><span data-slate-object="text" data-key="7241"><span data-slate-leaf="true" data-offset-key="7241:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="7242"><span data-slate-leaf="true" data-offset-key="7242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7243"><span data-slate-leaf="true" data-offset-key="7243:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7244"><span data-slate-leaf="true" data-offset-key="7244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7245"><span data-slate-leaf="true" data-offset-key="7245:0" data-first-offset="true"><span data-slate-string="true">.registerBrokerWithFilterServer(ctx, request);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7246"><span data-slate-object="text" data-key="7247"><span data-slate-leaf="true" data-offset-key="7247:0" data-first-offset="true"><span data-slate-string="true">                } </span></span></span><span data-slate-object="text" data-key="7248"><span data-slate-leaf="true" data-offset-key="7248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="7249"><span data-slate-leaf="true" data-offset-key="7249:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7250"><span data-slate-object="text" data-key="7251"><span data-slate-leaf="true" data-offset-key="7251:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="7252"><span data-slate-leaf="true" data-offset-key="7252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7253"><span data-slate-leaf="true" data-offset-key="7253:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7254"><span data-slate-leaf="true" data-offset-key="7254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7255"><span data-slate-leaf="true" data-offset-key="7255:0" data-first-offset="true"><span data-slate-string="true">.registerBroker(ctx, request);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7256"><span data-slate-object="text" data-key="7257"><span data-slate-leaf="true" data-offset-key="7257:0" data-first-offset="true"><span data-slate-string="true">                }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7258"><span data-slate-object="text" data-key="7259"><span data-slate-leaf="true" data-offset-key="7259:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7260"><span data-slate-leaf="true" data-offset-key="7260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7261"><span data-slate-object="text" data-key="7262"><span data-slate-leaf="true" data-offset-key="7262:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7263"><span data-slate-leaf="true" data-offset-key="7263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="7264"><span data-slate-leaf="true" data-offset-key="7264:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7265"><span data-slate-object="text" data-key="7266"><span data-slate-leaf="true" data-offset-key="7266:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7267"><span data-slate-leaf="true" data-offset-key="7267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">break</span></span></span></span><span data-slate-object="text" data-key="7268"><span data-slate-leaf="true" data-offset-key="7268:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7269"><span data-slate-object="text" data-key="7270"><span data-slate-leaf="true" data-offset-key="7270:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7271"><span data-slate-object="text" data-key="7272"><span data-slate-leaf="true" data-offset-key="7272:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7273"><span data-slate-leaf="true" data-offset-key="7273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7274"><span data-slate-leaf="true" data-offset-key="7274:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7275"><span data-slate-leaf="true" data-offset-key="7275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7276"><span data-slate-leaf="true" data-offset-key="7276:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7277"><span data-slate-object="text" data-key="7278"><span data-slate-leaf="true" data-offset-key="7278:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7279"><span data-slate-object="text" data-key="7280"><span data-slate-leaf="true" data-offset-key="7280:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7281"><span data-slate-leaf="true" data-offset-key="7281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7282"><span data-slate-object="text" data-key="7283"><span data-slate-leaf="true" data-offset-key="7283:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7284"><span data-slate-object="text" data-key="7285"><span data-slate-leaf="true" data-offset-key="7285:0" data-first-offset="true"><span data-slate-string="true">这是一个非常典型的处理 Request 的路由分发器，根据 request.getCode () 来分发请求到对应的处理器中。Broker 发给 NameServer 注册请求的 Code 为 REGISTER_BROKER，在代码中根据 Broker 的版本号不同，分别有两个不同的处理实现方法：“registerBrokerWithFilterServer” 和 "registerBroker"。这两个方法实现的流程是差不多的，实际上都是调用了 "RouteInfoManager#registerBroker" 方法，我们直接看这个方法的代码：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="7286"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div><div data-code-line-number="72"></div><div data-code-line-number="73"></div><div data-code-line-number="74"></div><div data-code-line-number="75"></div><div data-code-line-number="76"></div><div data-code-line-number="77"></div><div data-code-line-number="78"></div><div data-code-line-number="79"></div><div data-code-line-number="80"></div><div data-code-line-number="81"></div><div data-code-line-number="82"></div><div data-code-line-number="83"></div><div data-code-line-number="84"></div><div data-code-line-number="85"></div><div data-code-line-number="86"></div><div data-code-line-number="87"></div><div data-code-line-number="88"></div><div data-code-line-number="89"></div><div data-code-line-number="90"></div><div data-code-line-number="91"></div><div data-code-line-number="92"></div><div data-code-line-number="93"></div><div data-code-line-number="94"></div><div data-code-line-number="95"></div><div data-code-line-number="96"></div><div data-code-line-number="97"></div><div data-code-line-number="98"></div><div data-code-line-number="99"></div><div data-code-line-number="100"></div><div data-code-line-number="101"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7287"><span data-slate-object="text" data-key="7288"><span data-slate-leaf="true" data-offset-key="7288:0" data-first-offset="true"><span data-slate-string="true">public RegisterBrokerResult registerBroker(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7289"><span data-slate-object="text" data-key="7290"><span data-slate-leaf="true" data-offset-key="7290:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7291"><span data-slate-leaf="true" data-offset-key="7291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7292"><span data-slate-leaf="true" data-offset-key="7292:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7293"><span data-slate-leaf="true" data-offset-key="7293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7294"><span data-slate-leaf="true" data-offset-key="7294:0" data-first-offset="true"><span data-slate-string="true"> clusterName,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7295"><span data-slate-object="text" data-key="7296"><span data-slate-leaf="true" data-offset-key="7296:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7297"><span data-slate-leaf="true" data-offset-key="7297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7298"><span data-slate-leaf="true" data-offset-key="7298:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7299"><span data-slate-leaf="true" data-offset-key="7299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7300"><span data-slate-leaf="true" data-offset-key="7300:0" data-first-offset="true"><span data-slate-string="true"> brokerAddr,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7301"><span data-slate-object="text" data-key="7302"><span data-slate-leaf="true" data-offset-key="7302:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7303"><span data-slate-leaf="true" data-offset-key="7303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7304"><span data-slate-leaf="true" data-offset-key="7304:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7305"><span data-slate-leaf="true" data-offset-key="7305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7306"><span data-slate-leaf="true" data-offset-key="7306:0" data-first-offset="true"><span data-slate-string="true"> brokerName,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7307"><span data-slate-object="text" data-key="7308"><span data-slate-leaf="true" data-offset-key="7308:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7309"><span data-slate-leaf="true" data-offset-key="7309:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7310"><span data-slate-leaf="true" data-offset-key="7310:0" data-first-offset="true"><span data-slate-string="true"> long brokerId,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7311"><span data-slate-object="text" data-key="7312"><span data-slate-leaf="true" data-offset-key="7312:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7313"><span data-slate-leaf="true" data-offset-key="7313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7314"><span data-slate-leaf="true" data-offset-key="7314:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7315"><span data-slate-leaf="true" data-offset-key="7315:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7316"><span data-slate-leaf="true" data-offset-key="7316:0" data-first-offset="true"><span data-slate-string="true"> haServerAddr,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7317"><span data-slate-object="text" data-key="7318"><span data-slate-leaf="true" data-offset-key="7318:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7319"><span data-slate-leaf="true" data-offset-key="7319:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7320"><span data-slate-leaf="true" data-offset-key="7320:0" data-first-offset="true"><span data-slate-string="true"> TopicConfigSerializeWrapper topicConfigWrapper,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7321"><span data-slate-object="text" data-key="7322"><span data-slate-leaf="true" data-offset-key="7322:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7323"><span data-slate-leaf="true" data-offset-key="7323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7324"><span data-slate-leaf="true" data-offset-key="7324:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7325"><span data-slate-leaf="true" data-offset-key="7325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="7326"><span data-slate-leaf="true" data-offset-key="7326:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7327"><span data-slate-leaf="true" data-offset-key="7327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7328"><span data-slate-leaf="true" data-offset-key="7328:0" data-first-offset="true"><span data-slate-string="true">&gt; filterServerList,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7329"><span data-slate-object="text" data-key="7330"><span data-slate-leaf="true" data-offset-key="7330:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7331"><span data-slate-leaf="true" data-offset-key="7331:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7332"><span data-slate-leaf="true" data-offset-key="7332:0" data-first-offset="true"><span data-slate-string="true"> Channel channel) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7333"><span data-slate-object="text" data-key="7334"><span data-slate-leaf="true" data-offset-key="7334:0" data-first-offset="true"><span data-slate-string="true">    RegisterBrokerResult result = </span></span></span><span data-slate-object="text" data-key="7335"><span data-slate-leaf="true" data-offset-key="7335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7336"><span data-slate-leaf="true" data-offset-key="7336:0" data-first-offset="true"><span data-slate-string="true"> RegisterBrokerResult();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7337"><span data-slate-object="text" data-key="7338"><span data-slate-leaf="true" data-offset-key="7338:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7339"><span data-slate-leaf="true" data-offset-key="7339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="7340"><span data-slate-leaf="true" data-offset-key="7340:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7341"><span data-slate-object="text" data-key="7342"><span data-slate-leaf="true" data-offset-key="7342:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7343"><span data-slate-leaf="true" data-offset-key="7343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="7344"><span data-slate-leaf="true" data-offset-key="7344:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7345"><span data-slate-object="text" data-key="7346"><span data-slate-leaf="true" data-offset-key="7346:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7347"><span data-slate-leaf="true" data-offset-key="7347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加写锁，防止并发修改数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7348"><span data-slate-object="text" data-key="7349"><span data-slate-leaf="true" data-offset-key="7349:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7350"><span data-slate-leaf="true" data-offset-key="7350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7351"><span data-slate-leaf="true" data-offset-key="7351:0" data-first-offset="true"><span data-slate-string="true">.lock.writeLock().lockInterruptibly();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7352"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7353"><span data-slate-object="text" data-key="7354"><span data-slate-leaf="true" data-offset-key="7354:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7355"><span data-slate-leaf="true" data-offset-key="7355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 clusterAddrTable</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7356"><span data-slate-object="text" data-key="7357"><span data-slate-leaf="true" data-offset-key="7357:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7358"><span data-slate-leaf="true" data-offset-key="7358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="7359"><span data-slate-leaf="true" data-offset-key="7359:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7360"><span data-slate-leaf="true" data-offset-key="7360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7361"><span data-slate-leaf="true" data-offset-key="7361:0" data-first-offset="true"><span data-slate-string="true">&gt; brokerNames = </span></span></span><span data-slate-object="text" data-key="7362"><span data-slate-leaf="true" data-offset-key="7362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7363"><span data-slate-leaf="true" data-offset-key="7363:0" data-first-offset="true"><span data-slate-string="true">.clusterAddrTable.</span></span></span><span data-slate-object="text" data-key="7364"><span data-slate-leaf="true" data-offset-key="7364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7365"><span data-slate-leaf="true" data-offset-key="7365:0" data-first-offset="true"><span data-slate-string="true">(clusterName);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7366"><span data-slate-object="text" data-key="7367"><span data-slate-leaf="true" data-offset-key="7367:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7368"><span data-slate-leaf="true" data-offset-key="7368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7369"><span data-slate-leaf="true" data-offset-key="7369:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7370"><span data-slate-leaf="true" data-offset-key="7370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7371"><span data-slate-leaf="true" data-offset-key="7371:0" data-first-offset="true"><span data-slate-string="true"> == brokerNames) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7372"><span data-slate-object="text" data-key="7373"><span data-slate-leaf="true" data-offset-key="7373:0" data-first-offset="true"><span data-slate-string="true">                brokerNames = </span></span></span><span data-slate-object="text" data-key="7374"><span data-slate-leaf="true" data-offset-key="7374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7375"><span data-slate-leaf="true" data-offset-key="7375:0" data-first-offset="true"><span data-slate-string="true"> HashSet&lt;</span></span></span><span data-slate-object="text" data-key="7376"><span data-slate-leaf="true" data-offset-key="7376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7377"><span data-slate-leaf="true" data-offset-key="7377:0" data-first-offset="true"><span data-slate-string="true">&gt;();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7378"><span data-slate-object="text" data-key="7379"><span data-slate-leaf="true" data-offset-key="7379:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7380"><span data-slate-leaf="true" data-offset-key="7380:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7381"><span data-slate-leaf="true" data-offset-key="7381:0" data-first-offset="true"><span data-slate-string="true">.clusterAddrTable.put(clusterName, brokerNames);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7382"><span data-slate-object="text" data-key="7383"><span data-slate-leaf="true" data-offset-key="7383:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7384"><span data-slate-object="text" data-key="7385"><span data-slate-leaf="true" data-offset-key="7385:0" data-first-offset="true"><span data-slate-string="true">            brokerNames.add(brokerName);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7386"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7387"><span data-slate-object="text" data-key="7388"><span data-slate-leaf="true" data-offset-key="7388:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7389"><span data-slate-leaf="true" data-offset-key="7389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 brokerAddrTable</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7390"><span data-slate-object="text" data-key="7391"><span data-slate-leaf="true" data-offset-key="7391:0" data-first-offset="true"><span data-slate-string="true">            boolean registerFirst = </span></span></span><span data-slate-object="text" data-key="7392"><span data-slate-leaf="true" data-offset-key="7392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="7393"><span data-slate-leaf="true" data-offset-key="7393:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7394"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7395"><span data-slate-object="text" data-key="7396"><span data-slate-leaf="true" data-offset-key="7396:0" data-first-offset="true"><span data-slate-string="true">            BrokerData brokerData = </span></span></span><span data-slate-object="text" data-key="7397"><span data-slate-leaf="true" data-offset-key="7397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7398"><span data-slate-leaf="true" data-offset-key="7398:0" data-first-offset="true"><span data-slate-string="true">.brokerAddrTable.</span></span></span><span data-slate-object="text" data-key="7399"><span data-slate-leaf="true" data-offset-key="7399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7400"><span data-slate-leaf="true" data-offset-key="7400:0" data-first-offset="true"><span data-slate-string="true">(brokerName);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7401"><span data-slate-object="text" data-key="7402"><span data-slate-leaf="true" data-offset-key="7402:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7403"><span data-slate-leaf="true" data-offset-key="7403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7404"><span data-slate-leaf="true" data-offset-key="7404:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7405"><span data-slate-leaf="true" data-offset-key="7405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7406"><span data-slate-leaf="true" data-offset-key="7406:0" data-first-offset="true"><span data-slate-string="true"> == brokerData) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7407"><span data-slate-object="text" data-key="7408"><span data-slate-leaf="true" data-offset-key="7408:0" data-first-offset="true"><span data-slate-string="true">                registerFirst = </span></span></span><span data-slate-object="text" data-key="7409"><span data-slate-leaf="true" data-offset-key="7409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="7410"><span data-slate-leaf="true" data-offset-key="7410:0" data-first-offset="true"><span data-slate-string="true">; </span></span></span><span data-slate-object="text" data-key="7411"><span data-slate-leaf="true" data-offset-key="7411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 标识需要先注册</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7412"><span data-slate-object="text" data-key="7413"><span data-slate-leaf="true" data-offset-key="7413:0" data-first-offset="true"><span data-slate-string="true">                brokerData = </span></span></span><span data-slate-object="text" data-key="7414"><span data-slate-leaf="true" data-offset-key="7414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7415"><span data-slate-leaf="true" data-offset-key="7415:0" data-first-offset="true"><span data-slate-string="true"> BrokerData(clusterName, brokerName, </span></span></span><span data-slate-object="text" data-key="7416"><span data-slate-leaf="true" data-offset-key="7416:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7417"><span data-slate-leaf="true" data-offset-key="7417:0" data-first-offset="true"><span data-slate-string="true"> HashMap&lt;Long, </span></span></span><span data-slate-object="text" data-key="7418"><span data-slate-leaf="true" data-offset-key="7418:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7419"><span data-slate-leaf="true" data-offset-key="7419:0" data-first-offset="true"><span data-slate-string="true">&gt;());</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7420"><span data-slate-object="text" data-key="7421"><span data-slate-leaf="true" data-offset-key="7421:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7422"><span data-slate-leaf="true" data-offset-key="7422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7423"><span data-slate-leaf="true" data-offset-key="7423:0" data-first-offset="true"><span data-slate-string="true">.brokerAddrTable.put(brokerName, brokerData);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7424"><span data-slate-object="text" data-key="7425"><span data-slate-leaf="true" data-offset-key="7425:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7426"><span data-slate-object="text" data-key="7427"><span data-slate-leaf="true" data-offset-key="7427:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7428"><span data-slate-leaf="true" data-offset-key="7428:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="7429"><span data-slate-leaf="true" data-offset-key="7429:0" data-first-offset="true"><span data-slate-string="true">&lt;Long, </span></span></span><span data-slate-object="text" data-key="7430"><span data-slate-leaf="true" data-offset-key="7430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7431"><span data-slate-leaf="true" data-offset-key="7431:0" data-first-offset="true"><span data-slate-string="true">&gt; brokerAddrsMap = brokerData.getBrokerAddrs();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7432"><span data-slate-object="text" data-key="7433"><span data-slate-leaf="true" data-offset-key="7433:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7434"><span data-slate-leaf="true" data-offset-key="7434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 brokerAddrTable 中的 brokerData</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7435"><span data-slate-object="text" data-key="7436"><span data-slate-leaf="true" data-offset-key="7436:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7437"><span data-slate-leaf="true" data-offset-key="7437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Iterator</span></span></span></span><span data-slate-object="text" data-key="7438"><span data-slate-leaf="true" data-offset-key="7438:0" data-first-offset="true"><span data-slate-string="true">&lt;Entry&lt;Long, </span></span></span><span data-slate-object="text" data-key="7439"><span data-slate-leaf="true" data-offset-key="7439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7440"><span data-slate-leaf="true" data-offset-key="7440:0" data-first-offset="true"><span data-slate-string="true">&gt;&gt; it = brokerAddrsMap.entrySet().iterator();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7441"><span data-slate-object="text" data-key="7442"><span data-slate-leaf="true" data-offset-key="7442:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7443"><span data-slate-leaf="true" data-offset-key="7443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="7444"><span data-slate-leaf="true" data-offset-key="7444:0" data-first-offset="true"><span data-slate-string="true"> (it.hasNext()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7445"><span data-slate-object="text" data-key="7446"><span data-slate-leaf="true" data-offset-key="7446:0" data-first-offset="true"><span data-slate-string="true">                Entry&lt;Long, </span></span></span><span data-slate-object="text" data-key="7447"><span data-slate-leaf="true" data-offset-key="7447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7448"><span data-slate-leaf="true" data-offset-key="7448:0" data-first-offset="true"><span data-slate-string="true">&gt; item = it.next();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7449"><span data-slate-object="text" data-key="7450"><span data-slate-leaf="true" data-offset-key="7450:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7451"><span data-slate-leaf="true" data-offset-key="7451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7452"><span data-slate-leaf="true" data-offset-key="7452:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7453"><span data-slate-leaf="true" data-offset-key="7453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7454"><span data-slate-leaf="true" data-offset-key="7454:0" data-first-offset="true"><span data-slate-string="true"> != brokerAddr &amp;&amp; brokerAddr.equals(item.getValue()) &amp;&amp; brokerId != item.getKey()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7455"><span data-slate-object="text" data-key="7456"><span data-slate-leaf="true" data-offset-key="7456:0" data-first-offset="true"><span data-slate-string="true">                    it.remove();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7457"><span data-slate-object="text" data-key="7458"><span data-slate-leaf="true" data-offset-key="7458:0" data-first-offset="true"><span data-slate-string="true">                }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7459"><span data-slate-object="text" data-key="7460"><span data-slate-leaf="true" data-offset-key="7460:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7461"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7462"><span data-slate-object="text" data-key="7463"><span data-slate-leaf="true" data-offset-key="7463:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7464"><span data-slate-leaf="true" data-offset-key="7464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是新注册的 Master Broker，或者 Broker 中的路由信息变了，需要更新 topicQueueTable</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7465"><span data-slate-object="text" data-key="7466"><span data-slate-leaf="true" data-offset-key="7466:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7467"><span data-slate-leaf="true" data-offset-key="7467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7468"><span data-slate-leaf="true" data-offset-key="7468:0" data-first-offset="true"><span data-slate-string="true"> oldAddr = brokerData.getBrokerAddrs().put(brokerId, brokerAddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7469"><span data-slate-object="text" data-key="7470"><span data-slate-leaf="true" data-offset-key="7470:0" data-first-offset="true"><span data-slate-string="true">            registerFirst = registerFirst || (</span></span></span><span data-slate-object="text" data-key="7471"><span data-slate-leaf="true" data-offset-key="7471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7472"><span data-slate-leaf="true" data-offset-key="7472:0" data-first-offset="true"><span data-slate-string="true"> == oldAddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7473"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7474"><span data-slate-object="text" data-key="7475"><span data-slate-leaf="true" data-offset-key="7475:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7476"><span data-slate-leaf="true" data-offset-key="7476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7477"><span data-slate-leaf="true" data-offset-key="7477:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7478"><span data-slate-leaf="true" data-offset-key="7478:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7479"><span data-slate-leaf="true" data-offset-key="7479:0" data-first-offset="true"><span data-slate-string="true"> != topicConfigWrapper</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7480"><span data-slate-object="text" data-key="7481"><span data-slate-leaf="true" data-offset-key="7481:0" data-first-offset="true"><span data-slate-string="true">                &amp;&amp; MixAll.MASTER_ID == brokerId) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7482"><span data-slate-object="text" data-key="7483"><span data-slate-leaf="true" data-offset-key="7483:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7484"><span data-slate-leaf="true" data-offset-key="7484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7485"><span data-slate-leaf="true" data-offset-key="7485:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7486"><span data-slate-leaf="true" data-offset-key="7486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7487"><span data-slate-leaf="true" data-offset-key="7487:0" data-first-offset="true"><span data-slate-string="true">.isBrokerTopicConfigChanged(brokerAddr, topicConfigWrapper.getDataVersion())</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7488"><span data-slate-object="text" data-key="7489"><span data-slate-leaf="true" data-offset-key="7489:0" data-first-offset="true"><span data-slate-string="true">                    || registerFirst) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7490"><span data-slate-object="text" data-key="7491"><span data-slate-leaf="true" data-offset-key="7491:0" data-first-offset="true"><span data-slate-string="true">                    ConcurrentMap&lt;</span></span></span><span data-slate-object="text" data-key="7492"><span data-slate-leaf="true" data-offset-key="7492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7493"><span data-slate-leaf="true" data-offset-key="7493:0" data-first-offset="true"><span data-slate-string="true">, TopicConfig&gt; tcTable =</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7494"><span data-slate-object="text" data-key="7495"><span data-slate-leaf="true" data-offset-key="7495:0" data-first-offset="true"><span data-slate-string="true">                        topicConfigWrapper.getTopicConfigTable();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7496"><span data-slate-object="text" data-key="7497"><span data-slate-leaf="true" data-offset-key="7497:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="7498"><span data-slate-leaf="true" data-offset-key="7498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7499"><span data-slate-leaf="true" data-offset-key="7499:0" data-first-offset="true"><span data-slate-string="true"> (tcTable != </span></span></span><span data-slate-object="text" data-key="7500"><span data-slate-leaf="true" data-offset-key="7500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7501"><span data-slate-leaf="true" data-offset-key="7501:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7502"><span data-slate-object="text" data-key="7503"><span data-slate-leaf="true" data-offset-key="7503:0" data-first-offset="true"><span data-slate-string="true">                        </span></span></span><span data-slate-object="text" data-key="7504"><span data-slate-leaf="true" data-offset-key="7504:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="7505"><span data-slate-leaf="true" data-offset-key="7505:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7506"><span data-slate-leaf="true" data-offset-key="7506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Map</span></span></span></span><span data-slate-object="text" data-key="7507"><span data-slate-leaf="true" data-offset-key="7507:0" data-first-offset="true"><span data-slate-string="true">.Entry&lt;</span></span></span><span data-slate-object="text" data-key="7508"><span data-slate-leaf="true" data-offset-key="7508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7509"><span data-slate-leaf="true" data-offset-key="7509:0" data-first-offset="true"><span data-slate-string="true">, TopicConfig&gt; entry : tcTable.entrySet()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7510"><span data-slate-object="text" data-key="7511"><span data-slate-leaf="true" data-offset-key="7511:0" data-first-offset="true"><span data-slate-string="true">                            </span></span></span><span data-slate-object="text" data-key="7512"><span data-slate-leaf="true" data-offset-key="7512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7513"><span data-slate-leaf="true" data-offset-key="7513:0" data-first-offset="true"><span data-slate-string="true">.createAndUpdateQueueData(brokerName, entry.getValue());</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7514"><span data-slate-object="text" data-key="7515"><span data-slate-leaf="true" data-offset-key="7515:0" data-first-offset="true"><span data-slate-string="true">                        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7516"><span data-slate-object="text" data-key="7517"><span data-slate-leaf="true" data-offset-key="7517:0" data-first-offset="true"><span data-slate-string="true">                    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7518"><span data-slate-object="text" data-key="7519"><span data-slate-leaf="true" data-offset-key="7519:0" data-first-offset="true"><span data-slate-string="true">                }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7520"><span data-slate-object="text" data-key="7521"><span data-slate-leaf="true" data-offset-key="7521:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7522"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7523"><span data-slate-object="text" data-key="7524"><span data-slate-leaf="true" data-offset-key="7524:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7525"><span data-slate-leaf="true" data-offset-key="7525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 brokerLiveTable</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7526"><span data-slate-object="text" data-key="7527"><span data-slate-leaf="true" data-offset-key="7527:0" data-first-offset="true"><span data-slate-string="true">            BrokerLiveInfo prevBrokerLiveInfo = </span></span></span><span data-slate-object="text" data-key="7528"><span data-slate-leaf="true" data-offset-key="7528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7529"><span data-slate-leaf="true" data-offset-key="7529:0" data-first-offset="true"><span data-slate-string="true">.brokerLiveTable.put(brokerAddr,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7530"><span data-slate-object="text" data-key="7531"><span data-slate-leaf="true" data-offset-key="7531:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7532"><span data-slate-leaf="true" data-offset-key="7532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7533"><span data-slate-leaf="true" data-offset-key="7533:0" data-first-offset="true"><span data-slate-string="true"> BrokerLiveInfo(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7534"><span data-slate-object="text" data-key="7535"><span data-slate-leaf="true" data-offset-key="7535:0" data-first-offset="true"><span data-slate-string="true">                    System.currentTimeMillis(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7536"><span data-slate-object="text" data-key="7537"><span data-slate-leaf="true" data-offset-key="7537:0" data-first-offset="true"><span data-slate-string="true">                    topicConfigWrapper.getDataVersion(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7538"><span data-slate-object="text" data-key="7539"><span data-slate-leaf="true" data-offset-key="7539:0" data-first-offset="true"><span data-slate-string="true">                    channel,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7540"><span data-slate-object="text" data-key="7541"><span data-slate-leaf="true" data-offset-key="7541:0" data-first-offset="true"><span data-slate-string="true">                    haServerAddr));</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7542"><span data-slate-object="text" data-key="7543"><span data-slate-leaf="true" data-offset-key="7543:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7544"><span data-slate-leaf="true" data-offset-key="7544:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7545"><span data-slate-leaf="true" data-offset-key="7545:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7546"><span data-slate-leaf="true" data-offset-key="7546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7547"><span data-slate-leaf="true" data-offset-key="7547:0" data-first-offset="true"><span data-slate-string="true"> == prevBrokerLiveInfo) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7548"><span data-slate-object="text" data-key="7549"><span data-slate-leaf="true" data-offset-key="7549:0" data-first-offset="true"><span data-slate-string="true">                log.info(</span></span></span><span data-slate-object="text" data-key="7550"><span data-slate-leaf="true" data-offset-key="7550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"new broker registered, {} HAServer: {}"</span></span></span></span><span data-slate-object="text" data-key="7551"><span data-slate-leaf="true" data-offset-key="7551:0" data-first-offset="true"><span data-slate-string="true">, brokerAddr, haServerAddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7552"><span data-slate-object="text" data-key="7553"><span data-slate-leaf="true" data-offset-key="7553:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7554"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7555"><span data-slate-object="text" data-key="7556"><span data-slate-leaf="true" data-offset-key="7556:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7557"><span data-slate-leaf="true" data-offset-key="7557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新 filterServerTable</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7558"><span data-slate-object="text" data-key="7559"><span data-slate-leaf="true" data-offset-key="7559:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7560"><span data-slate-leaf="true" data-offset-key="7560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7561"><span data-slate-leaf="true" data-offset-key="7561:0" data-first-offset="true"><span data-slate-string="true"> (filterServerList != </span></span></span><span data-slate-object="text" data-key="7562"><span data-slate-leaf="true" data-offset-key="7562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7563"><span data-slate-leaf="true" data-offset-key="7563:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7564"><span data-slate-object="text" data-key="7565"><span data-slate-leaf="true" data-offset-key="7565:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7566"><span data-slate-leaf="true" data-offset-key="7566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7567"><span data-slate-leaf="true" data-offset-key="7567:0" data-first-offset="true"><span data-slate-string="true"> (filterServerList.isEmpty()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7568"><span data-slate-object="text" data-key="7569"><span data-slate-leaf="true" data-offset-key="7569:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="7570"><span data-slate-leaf="true" data-offset-key="7570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7571"><span data-slate-leaf="true" data-offset-key="7571:0" data-first-offset="true"><span data-slate-string="true">.filterServerTable.remove(brokerAddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7572"><span data-slate-object="text" data-key="7573"><span data-slate-leaf="true" data-offset-key="7573:0" data-first-offset="true"><span data-slate-string="true">                } </span></span></span><span data-slate-object="text" data-key="7574"><span data-slate-leaf="true" data-offset-key="7574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="7575"><span data-slate-leaf="true" data-offset-key="7575:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7576"><span data-slate-object="text" data-key="7577"><span data-slate-leaf="true" data-offset-key="7577:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="7578"><span data-slate-leaf="true" data-offset-key="7578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7579"><span data-slate-leaf="true" data-offset-key="7579:0" data-first-offset="true"><span data-slate-string="true">.filterServerTable.put(brokerAddr, filterServerList);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7580"><span data-slate-object="text" data-key="7581"><span data-slate-leaf="true" data-offset-key="7581:0" data-first-offset="true"><span data-slate-string="true">                }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7582"><span data-slate-object="text" data-key="7583"><span data-slate-leaf="true" data-offset-key="7583:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7584"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7585"><span data-slate-object="text" data-key="7586"><span data-slate-leaf="true" data-offset-key="7586:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7587"><span data-slate-leaf="true" data-offset-key="7587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是 Slave Broker，需要在返回的信息中带上 master 的相关信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7588"><span data-slate-object="text" data-key="7589"><span data-slate-leaf="true" data-offset-key="7589:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7590"><span data-slate-leaf="true" data-offset-key="7590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7591"><span data-slate-leaf="true" data-offset-key="7591:0" data-first-offset="true"><span data-slate-string="true"> (MixAll.MASTER_ID != brokerId) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7592"><span data-slate-object="text" data-key="7593"><span data-slate-leaf="true" data-offset-key="7593:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7594"><span data-slate-leaf="true" data-offset-key="7594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7595"><span data-slate-leaf="true" data-offset-key="7595:0" data-first-offset="true"><span data-slate-string="true"> masterAddr = brokerData.getBrokerAddrs().</span></span></span><span data-slate-object="text" data-key="7596"><span data-slate-leaf="true" data-offset-key="7596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7597"><span data-slate-leaf="true" data-offset-key="7597:0" data-first-offset="true"><span data-slate-string="true">(MixAll.MASTER_ID);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7598"><span data-slate-object="text" data-key="7599"><span data-slate-leaf="true" data-offset-key="7599:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7600"><span data-slate-leaf="true" data-offset-key="7600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7601"><span data-slate-leaf="true" data-offset-key="7601:0" data-first-offset="true"><span data-slate-string="true"> (masterAddr != </span></span></span><span data-slate-object="text" data-key="7602"><span data-slate-leaf="true" data-offset-key="7602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7603"><span data-slate-leaf="true" data-offset-key="7603:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7604"><span data-slate-object="text" data-key="7605"><span data-slate-leaf="true" data-offset-key="7605:0" data-first-offset="true"><span data-slate-string="true">                    BrokerLiveInfo brokerLiveInfo = </span></span></span><span data-slate-object="text" data-key="7606"><span data-slate-leaf="true" data-offset-key="7606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7607"><span data-slate-leaf="true" data-offset-key="7607:0" data-first-offset="true"><span data-slate-string="true">.brokerLiveTable.</span></span></span><span data-slate-object="text" data-key="7608"><span data-slate-leaf="true" data-offset-key="7608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7609"><span data-slate-leaf="true" data-offset-key="7609:0" data-first-offset="true"><span data-slate-string="true">(masterAddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7610"><span data-slate-object="text" data-key="7611"><span data-slate-leaf="true" data-offset-key="7611:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="7612"><span data-slate-leaf="true" data-offset-key="7612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7613"><span data-slate-leaf="true" data-offset-key="7613:0" data-first-offset="true"><span data-slate-string="true"> (brokerLiveInfo != </span></span></span><span data-slate-object="text" data-key="7614"><span data-slate-leaf="true" data-offset-key="7614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7615"><span data-slate-leaf="true" data-offset-key="7615:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7616"><span data-slate-object="text" data-key="7617"><span data-slate-leaf="true" data-offset-key="7617:0" data-first-offset="true"><span data-slate-string="true">                        result.setHaServerAddr(brokerLiveInfo.getHaServerAddr());</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7618"><span data-slate-object="text" data-key="7619"><span data-slate-leaf="true" data-offset-key="7619:0" data-first-offset="true"><span data-slate-string="true">                        result.setMasterAddr(masterAddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7620"><span data-slate-object="text" data-key="7621"><span data-slate-leaf="true" data-offset-key="7621:0" data-first-offset="true"><span data-slate-string="true">                    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7622"><span data-slate-object="text" data-key="7623"><span data-slate-leaf="true" data-offset-key="7623:0" data-first-offset="true"><span data-slate-string="true">                }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7624"><span data-slate-object="text" data-key="7625"><span data-slate-leaf="true" data-offset-key="7625:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7626"><span data-slate-object="text" data-key="7627"><span data-slate-leaf="true" data-offset-key="7627:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="7628"><span data-slate-leaf="true" data-offset-key="7628:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">finally</span></span></span></span><span data-slate-object="text" data-key="7629"><span data-slate-leaf="true" data-offset-key="7629:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7630"><span data-slate-object="text" data-key="7631"><span data-slate-leaf="true" data-offset-key="7631:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7632"><span data-slate-leaf="true" data-offset-key="7632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放写锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7633"><span data-slate-object="text" data-key="7634"><span data-slate-leaf="true" data-offset-key="7634:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7635"><span data-slate-leaf="true" data-offset-key="7635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7636"><span data-slate-leaf="true" data-offset-key="7636:0" data-first-offset="true"><span data-slate-string="true">.lock.writeLock().unlock();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7637"><span data-slate-object="text" data-key="7638"><span data-slate-leaf="true" data-offset-key="7638:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7639"><span data-slate-object="text" data-key="7640"><span data-slate-leaf="true" data-offset-key="7640:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="7641"><span data-slate-leaf="true" data-offset-key="7641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="7642"><span data-slate-leaf="true" data-offset-key="7642:0" data-first-offset="true"><span data-slate-string="true"> (Exception e) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7643"><span data-slate-object="text" data-key="7644"><span data-slate-leaf="true" data-offset-key="7644:0" data-first-offset="true"><span data-slate-string="true">        log.error(</span></span></span><span data-slate-object="text" data-key="7645"><span data-slate-leaf="true" data-offset-key="7645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"registerBroker Exception"</span></span></span></span><span data-slate-object="text" data-key="7646"><span data-slate-leaf="true" data-offset-key="7646:0" data-first-offset="true"><span data-slate-string="true">, e);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7647"><span data-slate-object="text" data-key="7648"><span data-slate-leaf="true" data-offset-key="7648:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7649"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7650"><span data-slate-object="text" data-key="7651"><span data-slate-leaf="true" data-offset-key="7651:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7652"><span data-slate-leaf="true" data-offset-key="7652:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7653"><span data-slate-leaf="true" data-offset-key="7653:0" data-first-offset="true"><span data-slate-string="true"> result;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7654"><span data-slate-object="text" data-key="7655"><span data-slate-leaf="true" data-offset-key="7655:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7656"><span data-slate-object="text" data-key="7657"><span data-slate-leaf="true" data-offset-key="7657:0" data-first-offset="true"><span data-slate-string="true">上面这段代码比较长，但总体结构很简单，就是根据 Broker 请求过来的路由信息，依次对比并更新 clusterAddrTable、brokerAddrTable、topicQueueTable、brokerLiveTable 和 filterServerTable 这 5 个保存集群信息和路由信息的 Map 对象中的数据。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7658"><span data-slate-object="text" data-key="7659"><span data-slate-leaf="true" data-offset-key="7659:0" data-first-offset="true"><span data-slate-string="true">另外，在 RouteInfoManager 中，这 5 个 Map 作为一个整体资源，使用了一个读写锁来做并发控制，避免并发更新和更新过程中读到不一致的数据问题。这个读写锁的使用方法，和我们在之前的课程《</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="7660"><span data-slate-object="text" data-key="7661"><span data-slate-leaf="true" data-offset-key="7661:0" data-first-offset="true"><span data-slate-string="true">17 | 如何正确使用锁保护共享数据，协调异步线程？</span></span></span></a><span data-slate-object="text" data-key="7662"><span data-slate-leaf="true" data-offset-key="7662:0" data-first-offset="true"><span data-slate-string="true">》中讲到的方法是一样的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7663" id="sr-toc-4"><span data-slate-object="text" data-key="7664"><span data-slate-leaf="true" data-offset-key="7664:0" data-first-offset="true"><span data-slate-string="true">客户端如何寻找 Broker？</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7665"><span data-slate-object="text" data-key="7666"><span data-slate-leaf="true" data-offset-key="7666:0" data-first-offset="true"><span data-slate-string="true">下面我们来看一下，NameServer 如何帮助客户端来找到对应的 Broker。对于客户端来说，无论是生产者还是消费者，通过主题来寻找 Broker 的流程是一样的，使用的也是同一份实现。客户端在启动后，会启动一个定时器，定期从 NameServer 上拉取相关主题的路由信息，然后缓存在本地内存中，在需要的时候使用。每个主题的路由信息用一个 TopicRouteData 对象来表示：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="7667"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7668"><span data-slate-object="text" data-key="7669"><span data-slate-leaf="true" data-offset-key="7669:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">public</span></span></span></span><span data-slate-object="text" data-key="7670"><span data-slate-leaf="true" data-offset-key="7670:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7671"><span data-slate-leaf="true" data-offset-key="7671:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="7672"><span data-slate-leaf="true" data-offset-key="7672:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7673"><span data-slate-leaf="true" data-offset-key="7673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">TopicRouteData</span></span></span></span><span data-slate-object="text" data-key="7674"><span data-slate-leaf="true" data-offset-key="7674:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7675"><span data-slate-leaf="true" data-offset-key="7675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="7676"><span data-slate-leaf="true" data-offset-key="7676:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7677"><span data-slate-leaf="true" data-offset-key="7677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RemotingSerializable</span></span></span></span><span data-slate-object="text" data-key="7678"><span data-slate-leaf="true" data-offset-key="7678:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7679"><span data-slate-object="text" data-key="7680"><span data-slate-leaf="true" data-offset-key="7680:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7681"><span data-slate-leaf="true" data-offset-key="7681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7682"><span data-slate-object="text" data-key="7683"><span data-slate-leaf="true" data-offset-key="7683:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7684"><span data-slate-leaf="true" data-offset-key="7684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7685"><span data-slate-leaf="true" data-offset-key="7685:0" data-first-offset="true"><span data-slate-string="true"> List&lt;QueueData&gt; queueDatas;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7686"><span data-slate-object="text" data-key="7687"><span data-slate-leaf="true" data-offset-key="7687:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7688"><span data-slate-leaf="true" data-offset-key="7688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="7689"><span data-slate-leaf="true" data-offset-key="7689:0" data-first-offset="true"><span data-slate-string="true"> List&lt;BrokerData&gt; brokerDatas;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7690"><span data-slate-object="text" data-key="7691"><span data-slate-leaf="true" data-offset-key="7691:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7692"><span data-slate-leaf="true" data-offset-key="7692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7693"><span data-slate-object="text" data-key="7694"><span data-slate-leaf="true" data-offset-key="7694:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7695"><span data-slate-object="text" data-key="7696"><span data-slate-leaf="true" data-offset-key="7696:0" data-first-offset="true"><span data-slate-string="true">其中，queueDatas 保存了主题中的所有队列信息，brokerDatas 中保存了主题相关的所有 Broker 信息。客户端选定了队列后，可以在对应的 QueueData 中找到对应的 BrokerName，然后用这个 BrokerName 找到对应的 BrokerData 对象，最终找到对应的 Master Broker 的物理地址。这部分代码在 org.apache.rocketmq.client.impl.factory.MQClientInstance 这个类中，你可以自行查看。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7697"><span data-slate-object="text" data-key="7698"><span data-slate-leaf="true" data-offset-key="7698:0" data-first-offset="true"><span data-slate-string="true">下面我们看一下在 NameServer 中，是如何实现根据主题来查询 TopicRouteData 的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7699"><span data-slate-object="text" data-key="7700"><span data-slate-leaf="true" data-offset-key="7700:0" data-first-offset="true"><span data-slate-string="true">NameServer 处理客户端请求和处理 Broker 请求的流程是一样的，都是通过路由分发器将请求分发的对应的处理方法中，我们直接看具体的实现方法 RouteInfoManager#pickupTopicRouteData：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="7701"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="7702"><span data-slate-object="text" data-key="7703"><span data-slate-leaf="true" data-offset-key="7703:0" data-first-offset="true"><span data-slate-string="true">public TopicRouteData pickupTopicRouteData(</span></span></span><span data-slate-object="text" data-key="7704"><span data-slate-leaf="true" data-offset-key="7704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7705"><span data-slate-leaf="true" data-offset-key="7705:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7706"><span data-slate-leaf="true" data-offset-key="7706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7707"><span data-slate-leaf="true" data-offset-key="7707:0" data-first-offset="true"><span data-slate-string="true"> topic) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7708"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7709"><span data-slate-object="text" data-key="7710"><span data-slate-leaf="true" data-offset-key="7710:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7711"><span data-slate-leaf="true" data-offset-key="7711:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化返回数据 topicRouteData</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7712"><span data-slate-object="text" data-key="7713"><span data-slate-leaf="true" data-offset-key="7713:0" data-first-offset="true"><span data-slate-string="true">    TopicRouteData topicRouteData = </span></span></span><span data-slate-object="text" data-key="7714"><span data-slate-leaf="true" data-offset-key="7714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7715"><span data-slate-leaf="true" data-offset-key="7715:0" data-first-offset="true"><span data-slate-string="true"> TopicRouteData();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7716"><span data-slate-object="text" data-key="7717"><span data-slate-leaf="true" data-offset-key="7717:0" data-first-offset="true"><span data-slate-string="true">    boolean foundQueueData = </span></span></span><span data-slate-object="text" data-key="7718"><span data-slate-leaf="true" data-offset-key="7718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="7719"><span data-slate-leaf="true" data-offset-key="7719:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7720"><span data-slate-object="text" data-key="7721"><span data-slate-leaf="true" data-offset-key="7721:0" data-first-offset="true"><span data-slate-string="true">    boolean foundBrokerData = </span></span></span><span data-slate-object="text" data-key="7722"><span data-slate-leaf="true" data-offset-key="7722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="7723"><span data-slate-leaf="true" data-offset-key="7723:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7724"><span data-slate-object="text" data-key="7725"><span data-slate-leaf="true" data-offset-key="7725:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7726"><span data-slate-leaf="true" data-offset-key="7726:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Set</span></span></span></span><span data-slate-object="text" data-key="7727"><span data-slate-leaf="true" data-offset-key="7727:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7728"><span data-slate-leaf="true" data-offset-key="7728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7729"><span data-slate-leaf="true" data-offset-key="7729:0" data-first-offset="true"><span data-slate-string="true">&gt; brokerNameSet = </span></span></span><span data-slate-object="text" data-key="7730"><span data-slate-leaf="true" data-offset-key="7730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7731"><span data-slate-leaf="true" data-offset-key="7731:0" data-first-offset="true"><span data-slate-string="true"> HashSet&lt;</span></span></span><span data-slate-object="text" data-key="7732"><span data-slate-leaf="true" data-offset-key="7732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7733"><span data-slate-leaf="true" data-offset-key="7733:0" data-first-offset="true"><span data-slate-string="true">&gt;();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7734"><span data-slate-object="text" data-key="7735"><span data-slate-leaf="true" data-offset-key="7735:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7736"><span data-slate-leaf="true" data-offset-key="7736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="7737"><span data-slate-leaf="true" data-offset-key="7737:0" data-first-offset="true"><span data-slate-string="true">&lt;BrokerData&gt; brokerDataList = </span></span></span><span data-slate-object="text" data-key="7738"><span data-slate-leaf="true" data-offset-key="7738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7739"><span data-slate-leaf="true" data-offset-key="7739:0" data-first-offset="true"><span data-slate-string="true"> LinkedList&lt;BrokerData&gt;();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7740"><span data-slate-object="text" data-key="7741"><span data-slate-leaf="true" data-offset-key="7741:0" data-first-offset="true"><span data-slate-string="true">    topicRouteData.setBrokerDatas(brokerDataList);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7742"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7743"><span data-slate-object="text" data-key="7744"><span data-slate-leaf="true" data-offset-key="7744:0" data-first-offset="true"><span data-slate-string="true">    HashMap&lt;</span></span></span><span data-slate-object="text" data-key="7745"><span data-slate-leaf="true" data-offset-key="7745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7746"><span data-slate-leaf="true" data-offset-key="7746:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7747"><span data-slate-leaf="true" data-offset-key="7747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="7748"><span data-slate-leaf="true" data-offset-key="7748:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7749"><span data-slate-leaf="true" data-offset-key="7749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7750"><span data-slate-leaf="true" data-offset-key="7750:0" data-first-offset="true"><span data-slate-string="true">&gt;&gt; filterServerMap = </span></span></span><span data-slate-object="text" data-key="7751"><span data-slate-leaf="true" data-offset-key="7751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7752"><span data-slate-leaf="true" data-offset-key="7752:0" data-first-offset="true"><span data-slate-string="true"> HashMap&lt;</span></span></span><span data-slate-object="text" data-key="7753"><span data-slate-leaf="true" data-offset-key="7753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7754"><span data-slate-leaf="true" data-offset-key="7754:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="7755"><span data-slate-leaf="true" data-offset-key="7755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="7756"><span data-slate-leaf="true" data-offset-key="7756:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7757"><span data-slate-leaf="true" data-offset-key="7757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7758"><span data-slate-leaf="true" data-offset-key="7758:0" data-first-offset="true"><span data-slate-string="true">&gt;&gt;();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7759"><span data-slate-object="text" data-key="7760"><span data-slate-leaf="true" data-offset-key="7760:0" data-first-offset="true"><span data-slate-string="true">    topicRouteData.setFilterServerTable(filterServerMap);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7761"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7762"><span data-slate-object="text" data-key="7763"><span data-slate-leaf="true" data-offset-key="7763:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7764"><span data-slate-leaf="true" data-offset-key="7764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="7765"><span data-slate-leaf="true" data-offset-key="7765:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7766"><span data-slate-object="text" data-key="7767"><span data-slate-leaf="true" data-offset-key="7767:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7768"><span data-slate-leaf="true" data-offset-key="7768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="7769"><span data-slate-leaf="true" data-offset-key="7769:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7770"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7771"><span data-slate-object="text" data-key="7772"><span data-slate-leaf="true" data-offset-key="7772:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7773"><span data-slate-leaf="true" data-offset-key="7773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加读锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7774"><span data-slate-object="text" data-key="7775"><span data-slate-leaf="true" data-offset-key="7775:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7776"><span data-slate-leaf="true" data-offset-key="7776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7777"><span data-slate-leaf="true" data-offset-key="7777:0" data-first-offset="true"><span data-slate-string="true">.lock.readLock().lockInterruptibly();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7778"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7779"><span data-slate-object="text" data-key="7780"><span data-slate-leaf="true" data-offset-key="7780:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7781"><span data-slate-leaf="true" data-offset-key="7781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 先获取主题对应的队列信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7782"><span data-slate-object="text" data-key="7783"><span data-slate-leaf="true" data-offset-key="7783:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7784"><span data-slate-leaf="true" data-offset-key="7784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="7785"><span data-slate-leaf="true" data-offset-key="7785:0" data-first-offset="true"><span data-slate-string="true">&lt;QueueData&gt; queueDataList = </span></span></span><span data-slate-object="text" data-key="7786"><span data-slate-leaf="true" data-offset-key="7786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7787"><span data-slate-leaf="true" data-offset-key="7787:0" data-first-offset="true"><span data-slate-string="true">.topicQueueTable.</span></span></span><span data-slate-object="text" data-key="7788"><span data-slate-leaf="true" data-offset-key="7788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7789"><span data-slate-leaf="true" data-offset-key="7789:0" data-first-offset="true"><span data-slate-string="true">(topic);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7790"><span data-slate-object="text" data-key="7791"><span data-slate-leaf="true" data-offset-key="7791:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7792"><span data-slate-leaf="true" data-offset-key="7792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7793"><span data-slate-leaf="true" data-offset-key="7793:0" data-first-offset="true"><span data-slate-string="true"> (queueDataList != </span></span></span><span data-slate-object="text" data-key="7794"><span data-slate-leaf="true" data-offset-key="7794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7795"><span data-slate-leaf="true" data-offset-key="7795:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7796"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7797"><span data-slate-object="text" data-key="7798"><span data-slate-leaf="true" data-offset-key="7798:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7799"><span data-slate-leaf="true" data-offset-key="7799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把队列信息返回值中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7800"><span data-slate-object="text" data-key="7801"><span data-slate-leaf="true" data-offset-key="7801:0" data-first-offset="true"><span data-slate-string="true">                topicRouteData.setQueueDatas(queueDataList);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7802"><span data-slate-object="text" data-key="7803"><span data-slate-leaf="true" data-offset-key="7803:0" data-first-offset="true"><span data-slate-string="true">                foundQueueData = </span></span></span><span data-slate-object="text" data-key="7804"><span data-slate-leaf="true" data-offset-key="7804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="7805"><span data-slate-leaf="true" data-offset-key="7805:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7806"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7807"><span data-slate-object="text" data-key="7808"><span data-slate-leaf="true" data-offset-key="7808:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7809"><span data-slate-leaf="true" data-offset-key="7809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历队列，找出相关的所有 BrokerName</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7810"><span data-slate-object="text" data-key="7811"><span data-slate-leaf="true" data-offset-key="7811:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7812"><span data-slate-leaf="true" data-offset-key="7812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Iterator</span></span></span></span><span data-slate-object="text" data-key="7813"><span data-slate-leaf="true" data-offset-key="7813:0" data-first-offset="true"><span data-slate-string="true">&lt;QueueData&gt; it = queueDataList.iterator();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7814"><span data-slate-object="text" data-key="7815"><span data-slate-leaf="true" data-offset-key="7815:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7816"><span data-slate-leaf="true" data-offset-key="7816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="7817"><span data-slate-leaf="true" data-offset-key="7817:0" data-first-offset="true"><span data-slate-string="true"> (it.hasNext()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7818"><span data-slate-object="text" data-key="7819"><span data-slate-leaf="true" data-offset-key="7819:0" data-first-offset="true"><span data-slate-string="true">                    QueueData qd = it.next();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7820"><span data-slate-object="text" data-key="7821"><span data-slate-leaf="true" data-offset-key="7821:0" data-first-offset="true"><span data-slate-string="true">                    brokerNameSet.add(qd.getBrokerName());</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7822"><span data-slate-object="text" data-key="7823"><span data-slate-leaf="true" data-offset-key="7823:0" data-first-offset="true"><span data-slate-string="true">                }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7824"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7825"><span data-slate-object="text" data-key="7826"><span data-slate-leaf="true" data-offset-key="7826:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7827"><span data-slate-leaf="true" data-offset-key="7827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历这些 BrokerName，找到对应的 BrokerData，并写入返回结果中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7828"><span data-slate-object="text" data-key="7829"><span data-slate-leaf="true" data-offset-key="7829:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="7830"><span data-slate-leaf="true" data-offset-key="7830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="7831"><span data-slate-leaf="true" data-offset-key="7831:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7832"><span data-slate-leaf="true" data-offset-key="7832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7833"><span data-slate-leaf="true" data-offset-key="7833:0" data-first-offset="true"><span data-slate-string="true"> brokerName : brokerNameSet) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7834"><span data-slate-object="text" data-key="7835"><span data-slate-leaf="true" data-offset-key="7835:0" data-first-offset="true"><span data-slate-string="true">                    BrokerData brokerData = </span></span></span><span data-slate-object="text" data-key="7836"><span data-slate-leaf="true" data-offset-key="7836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7837"><span data-slate-leaf="true" data-offset-key="7837:0" data-first-offset="true"><span data-slate-string="true">.brokerAddrTable.</span></span></span><span data-slate-object="text" data-key="7838"><span data-slate-leaf="true" data-offset-key="7838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7839"><span data-slate-leaf="true" data-offset-key="7839:0" data-first-offset="true"><span data-slate-string="true">(brokerName);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7840"><span data-slate-object="text" data-key="7841"><span data-slate-leaf="true" data-offset-key="7841:0" data-first-offset="true"><span data-slate-string="true">                    </span></span></span><span data-slate-object="text" data-key="7842"><span data-slate-leaf="true" data-offset-key="7842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7843"><span data-slate-leaf="true" data-offset-key="7843:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7844"><span data-slate-leaf="true" data-offset-key="7844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7845"><span data-slate-leaf="true" data-offset-key="7845:0" data-first-offset="true"><span data-slate-string="true"> != brokerData) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7846"><span data-slate-object="text" data-key="7847"><span data-slate-leaf="true" data-offset-key="7847:0" data-first-offset="true"><span data-slate-string="true">                        BrokerData brokerDataClone = </span></span></span><span data-slate-object="text" data-key="7848"><span data-slate-leaf="true" data-offset-key="7848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="7849"><span data-slate-leaf="true" data-offset-key="7849:0" data-first-offset="true"><span data-slate-string="true"> BrokerData(brokerData.getCluster(), brokerData.getBrokerName(), (HashMap&lt;Long, </span></span></span><span data-slate-object="text" data-key="7850"><span data-slate-leaf="true" data-offset-key="7850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7851"><span data-slate-leaf="true" data-offset-key="7851:0" data-first-offset="true"><span data-slate-string="true">&gt;) brokerData</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7852"><span data-slate-object="text" data-key="7853"><span data-slate-leaf="true" data-offset-key="7853:0" data-first-offset="true"><span data-slate-string="true">                            .getBrokerAddrs().clone());</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7854"><span data-slate-object="text" data-key="7855"><span data-slate-leaf="true" data-offset-key="7855:0" data-first-offset="true"><span data-slate-string="true">                        brokerDataList.add(brokerDataClone);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7856"><span data-slate-object="text" data-key="7857"><span data-slate-leaf="true" data-offset-key="7857:0" data-first-offset="true"><span data-slate-string="true">                        foundBrokerData = </span></span></span><span data-slate-object="text" data-key="7858"><span data-slate-leaf="true" data-offset-key="7858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="7859"><span data-slate-leaf="true" data-offset-key="7859:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7860"><span data-slate-object="text" data-key="7861"><span data-slate-leaf="true" data-offset-key="7861:0" data-first-offset="true"><span data-slate-string="true">                        </span></span></span><span data-slate-object="text" data-key="7862"><span data-slate-leaf="true" data-offset-key="7862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="7863"><span data-slate-leaf="true" data-offset-key="7863:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="7864"><span data-slate-leaf="true" data-offset-key="7864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">final</span></span></span></span><span data-slate-object="text" data-key="7865"><span data-slate-leaf="true" data-offset-key="7865:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7866"><span data-slate-leaf="true" data-offset-key="7866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7867"><span data-slate-leaf="true" data-offset-key="7867:0" data-first-offset="true"><span data-slate-string="true"> brokerAddr : brokerDataClone.getBrokerAddrs().values()) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7868"><span data-slate-object="text" data-key="7869"><span data-slate-leaf="true" data-offset-key="7869:0" data-first-offset="true"><span data-slate-string="true">                            </span></span></span><span data-slate-object="text" data-key="7870"><span data-slate-leaf="true" data-offset-key="7870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">List</span></span></span></span><span data-slate-object="text" data-key="7871"><span data-slate-leaf="true" data-offset-key="7871:0" data-first-offset="true"><span data-slate-string="true">&lt;</span></span></span><span data-slate-object="text" data-key="7872"><span data-slate-leaf="true" data-offset-key="7872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="7873"><span data-slate-leaf="true" data-offset-key="7873:0" data-first-offset="true"><span data-slate-string="true">&gt; filterServerList = </span></span></span><span data-slate-object="text" data-key="7874"><span data-slate-leaf="true" data-offset-key="7874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7875"><span data-slate-leaf="true" data-offset-key="7875:0" data-first-offset="true"><span data-slate-string="true">.filterServerTable.</span></span></span><span data-slate-object="text" data-key="7876"><span data-slate-leaf="true" data-offset-key="7876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="7877"><span data-slate-leaf="true" data-offset-key="7877:0" data-first-offset="true"><span data-slate-string="true">(brokerAddr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7878"><span data-slate-object="text" data-key="7879"><span data-slate-leaf="true" data-offset-key="7879:0" data-first-offset="true"><span data-slate-string="true">                            filterServerMap.put(brokerAddr, filterServerList);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7880"><span data-slate-object="text" data-key="7881"><span data-slate-leaf="true" data-offset-key="7881:0" data-first-offset="true"><span data-slate-string="true">                        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7882"><span data-slate-object="text" data-key="7883"><span data-slate-leaf="true" data-offset-key="7883:0" data-first-offset="true"><span data-slate-string="true">                    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7884"><span data-slate-object="text" data-key="7885"><span data-slate-leaf="true" data-offset-key="7885:0" data-first-offset="true"><span data-slate-string="true">                }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7886"><span data-slate-object="text" data-key="7887"><span data-slate-leaf="true" data-offset-key="7887:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7888"><span data-slate-object="text" data-key="7889"><span data-slate-leaf="true" data-offset-key="7889:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="7890"><span data-slate-leaf="true" data-offset-key="7890:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">finally</span></span></span></span><span data-slate-object="text" data-key="7891"><span data-slate-leaf="true" data-offset-key="7891:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7892"><span data-slate-object="text" data-key="7893"><span data-slate-leaf="true" data-offset-key="7893:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7894"><span data-slate-leaf="true" data-offset-key="7894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放读锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7895"><span data-slate-object="text" data-key="7896"><span data-slate-leaf="true" data-offset-key="7896:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="7897"><span data-slate-leaf="true" data-offset-key="7897:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">this</span></span></span></span><span data-slate-object="text" data-key="7898"><span data-slate-leaf="true" data-offset-key="7898:0" data-first-offset="true"><span data-slate-string="true">.lock.readLock().unlock();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7899"><span data-slate-object="text" data-key="7900"><span data-slate-leaf="true" data-offset-key="7900:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7901"><span data-slate-object="text" data-key="7902"><span data-slate-leaf="true" data-offset-key="7902:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span><span data-slate-object="text" data-key="7903"><span data-slate-leaf="true" data-offset-key="7903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="7904"><span data-slate-leaf="true" data-offset-key="7904:0" data-first-offset="true"><span data-slate-string="true"> (Exception e) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7905"><span data-slate-object="text" data-key="7906"><span data-slate-leaf="true" data-offset-key="7906:0" data-first-offset="true"><span data-slate-string="true">        log.error(</span></span></span><span data-slate-object="text" data-key="7907"><span data-slate-leaf="true" data-offset-key="7907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pickupTopicRouteData Exception"</span></span></span></span><span data-slate-object="text" data-key="7908"><span data-slate-leaf="true" data-offset-key="7908:0" data-first-offset="true"><span data-slate-string="true">, e);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7909"><span data-slate-object="text" data-key="7910"><span data-slate-leaf="true" data-offset-key="7910:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7911"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7912"><span data-slate-object="text" data-key="7913"><span data-slate-leaf="true" data-offset-key="7913:0" data-first-offset="true"><span data-slate-string="true">    log.debug(</span></span></span><span data-slate-object="text" data-key="7914"><span data-slate-leaf="true" data-offset-key="7914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pickupTopicRouteData {} {}"</span></span></span></span><span data-slate-object="text" data-key="7915"><span data-slate-leaf="true" data-offset-key="7915:0" data-first-offset="true"><span data-slate-string="true">, topic, topicRouteData);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7916"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7917"><span data-slate-object="text" data-key="7918"><span data-slate-leaf="true" data-offset-key="7918:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7919"><span data-slate-leaf="true" data-offset-key="7919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="7920"><span data-slate-leaf="true" data-offset-key="7920:0" data-first-offset="true"><span data-slate-string="true"> (foundBrokerData &amp;&amp; foundQueueData) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7921"><span data-slate-object="text" data-key="7922"><span data-slate-leaf="true" data-offset-key="7922:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="7923"><span data-slate-leaf="true" data-offset-key="7923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7924"><span data-slate-leaf="true" data-offset-key="7924:0" data-first-offset="true"><span data-slate-string="true"> topicRouteData;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7925"><span data-slate-object="text" data-key="7926"><span data-slate-leaf="true" data-offset-key="7926:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7927"></div><div data-slate-type="code-line" data-slate-object="block" data-key="7928"><span data-slate-object="text" data-key="7929"><span data-slate-leaf="true" data-offset-key="7929:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="7930"><span data-slate-leaf="true" data-offset-key="7930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="7931"><span data-slate-leaf="true" data-offset-key="7931:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="7932"><span data-slate-leaf="true" data-offset-key="7932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="7933"><span data-slate-leaf="true" data-offset-key="7933:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="7934"><span data-slate-object="text" data-key="7935"><span data-slate-leaf="true" data-offset-key="7935:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7936"><span data-slate-object="text" data-key="7937"><span data-slate-leaf="true" data-offset-key="7937:0" data-first-offset="true"><span data-slate-string="true">这个方法的实现流程是这样的：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="7938"><div data-slate-type="list-line" data-slate-object="block" data-key="7939"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="7940"><span data-slate-leaf="true" data-offset-key="7940:0" data-first-offset="true"><span data-slate-string="true">初始化返回的 topicRouteData 后，获取读锁。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="7941"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="7942"><span data-slate-leaf="true" data-offset-key="7942:0" data-first-offset="true"><span data-slate-string="true">在 topicQueueTable 中获取主题对应的队列信息，并写入返回结果中。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="7943"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="7944"><span data-slate-leaf="true" data-offset-key="7944:0" data-first-offset="true"><span data-slate-string="true">遍历队列，找出相关的所有 BrokerName。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="7945"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="7946"><span data-slate-leaf="true" data-offset-key="7946:0" data-first-offset="true"><span data-slate-string="true">遍历这些 BrokerName，从 brokerAddrTable 中找到对应的 BrokerData，并写入返回结果中。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="7947"><div data-code-line-number="5"></div><div><span data-slate-object="text" data-key="7948"><span data-slate-leaf="true" data-offset-key="7948:0" data-first-offset="true"><span data-slate-string="true">释放读锁并返回结果。</span></span></span></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7949" id="sr-toc-5"><span data-slate-object="text" data-key="7950"><span data-slate-leaf="true" data-offset-key="7950:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7951"><span data-slate-object="text" data-key="7952"><span data-slate-leaf="true" data-offset-key="7952:0" data-first-offset="true"><span data-slate-string="true">这节课我们一起分析了 RocketMQ NameServer 的源代码，NameServer 在集群中起到的一个核心作用就是，为客户端提供路由信息，帮助客户端找到对应的 Broker。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7953"><span data-slate-object="text" data-key="7954"><span data-slate-leaf="true" data-offset-key="7954:0" data-first-offset="true"><span data-slate-string="true">每个 NameServer 节点上都保存了集群所有 Broker 的路由信息，可以独立提供服务。Broker 会与所有 NameServer 节点建立长连接，定期上报 Broker 的路由信息。客户端会选择连接某一个 NameServer 节点，定期获取订阅主题的路由信息，用于 Broker 寻址。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7955"><span data-slate-object="text" data-key="7956"><span data-slate-leaf="true" data-offset-key="7956:0" data-first-offset="true"><span data-slate-string="true">NameServer 的所有核心功能都是在 RouteInfoManager 这个类中实现的，这类中使用了几个 Map 来在内存中保存集群中所有 Broker 的路由信息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7957"><span data-slate-object="text" data-key="7958"><span data-slate-leaf="true" data-offset-key="7958:0" data-first-offset="true"><span data-slate-string="true">我们还一起分析了 RouteInfoManager 中的两个比较关键的方法：注册 Broker 路由信息的方法 registerBroker，以及查询 Broker 路由信息的方法 pickupTopicRouteData。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7959"><span data-slate-object="text" data-key="7960"><span data-slate-leaf="true" data-offset-key="7960:0" data-first-offset="true"><span data-slate-string="true">建议你仔细读一下这两个方法的代码，结合保存路由信息的几个 Map 的数据结构，体会一下 RocketMQ NameServer 这种简洁的设计。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7961"><span data-slate-object="text" data-key="7962"><span data-slate-leaf="true" data-offset-key="7962:0" data-first-offset="true"><span data-slate-string="true">把以上的这些 NameServer 的设计和实现方法抽象一下，我们就可以总结出通用的 NamingService 的设计思想。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7963"><span data-slate-object="text" data-key="7964"><span data-slate-leaf="true" data-offset-key="7964:0" data-first-offset="true"><span data-slate-string="true">NamingService 负责保存集群内所有节点的路由信息，NamingService 本身也是一个小集群，由多个 NamingService 节点组成。这里我们所说的 “路由信息” 也是一种通用的抽象，含义是：“客户端需要访问的某个特定服务在哪个节点上”。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7965"><span data-slate-object="text" data-key="7966"><span data-slate-leaf="true" data-offset-key="7966:0" data-first-offset="true"><span data-slate-string="true">集群中的节点主动连接 NamingService 服务，注册自身的路由信息。给客户端提供路由寻址服务的方式可以有两种，一种是客户端直接连接 NamingService 服务查询路由信息，另一种是，客户端连接集群内任意节点查询路由信息，节点再从自身的缓存或者从 NamingService 上进行查询。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7967"><span data-slate-object="text" data-key="7968"><span data-slate-leaf="true" data-offset-key="7968:0" data-first-offset="true"><span data-slate-string="true">掌握了以上这些 NamingService 的设计方法，将会非常有助于你理解其他分布式系统的架构，当然，你也可以把这些方法应用到分布式系统的设计中去。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="7969" id="sr-toc-6"><span data-slate-object="text" data-key="7970"><span data-slate-leaf="true" data-offset-key="7970:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="7971"><span data-slate-object="text" data-key="7972"><span data-slate-leaf="true" data-offset-key="7972:0" data-first-offset="true"><span data-slate-string="true">今天的思考题是这样的，在 RocketMQ 的 NameServer 集群中，各节点之间不需要互相通信，每个节点都可以独立的提供服务。课后请你想一想，这种独特的集群架构有什么优势，又有什么不足？欢迎在评论区留言写下你的想法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7973"><span data-slate-object="text" data-key="7974"><span data-slate-leaf="true" data-offset-key="7974:0" data-first-offset="true"><span data-slate-string="true">感谢阅读，如果你觉得这篇文章对你有一些启发，也欢迎把它分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png" style="width: auto;"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-7">精选留言 (26)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/0f/4b/4d/0239bc19.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>益军</span></div></div><div>优点:  nameserver 本身设计为无状态，实现简单，
缺点: broker 客户端通信成本复杂，适合在客户端环境完全可控的情况下设计。namesrv 一致性无法保证，需要定时幂等性心跳保持最终一致性。</div><div><div>2019-09-20</div><div><div><i></i><span>1</span></div><div><i></i><span>27</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/30/8a/b5ca7286.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 业余草</span></div></div><div>线上环境突发消息延迟 2 个小时，该如何尽快解决？以及后期如何避免这类问题？说说你的思路和经验！</div><div><p>作者回复：这个我在之前的课程中讲到过，首先需要先看一下是消费慢还是生产慢，如果是生产慢，一般需要扩容 Producer 的节点数量，如果是消费慢，需要扩容队列数和 Consumer 数量。</p></div><div><div>2019-09-17</div><div><div><i></i><span>2</span></div><div><i></i><span>14</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/9c/9b/eec0d41f.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 康师傅</span></div></div><div>对于 rocketmq 和 kafka 而言，都有自己的 “注册中心”，但对于 rabbitmq 而言，它的集群允许你连接到集群中的任何一台进行生产消费，即便队列 master 所在节点并不是你连接的这台，rabbitmq 内部会帮你进行中转，但这会有一个很大的弊端，就是节点间会有较大的流量并且不可控，并且整体的性能会受影响

想请问下，这种时候，是否有较好的优化方式？
想到的一个办法是，自行做一个 NameServer，按队列进行注册分流，生产者消费者先与 NameServer 交互得到真实的节点 ip，然后直接连接到队列 master 所在节点进行生产消费</div><div><p>作者回复：理论上是可以的，但权衡工作量来说，最好还是换一个 MQ 吧。</p></div><div><div>2019-09-19</div><div><div><i></i></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 饭粒</span></div></div><div>优点：实现简单，集群节点平等，比较容易的水平扩展节点数量提供高可用性。路由数据读写都是内存，QPS 比较高。
缺点：每个 broker 需要与所有 nameserver 节点心跳通信，通信成本较大，无法保证强一致性。</div><div><div>2019-11-17</div><div><div><i></i><span></span></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/d0/42/6fd01fb9.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 我已经设置了昵称</span></div></div><div>老师，我们生产环境。同一个 group，多台机器消费同一个 topic 消息，遇到了某几个实例消费的分区延迟特别高，导致消息堆积的情况。但另外几个实例消费的分区并没有堆积。这通过扩容 consumer 也没法解决。而且很难排查，有什么好的方式吗</div><div><p>作者回复：一是查一下每个分区入队速度是不是均匀，另外在消费者加一个消费监控（记录每次消费的时延）看一下消费速度是不是有问题。</p></div><div><div>2019-10-25</div><div><div><i></i></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/99/af/d29273e2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 饭粒</span></div></div><div>请问下老师，如果 nameserver 有节点重启了或是新加了一个节点，恢复内存中的路由数据过程是通过 broker 的心跳上报路由信息重新注册一遍吗？</div><div><p>作者回复：是的，RocketMQ 的 NameServer 数据是以 Broker 上的为准，并且是从 Broker 上同步过来的。</p></div><div><div>2019-11-17</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/41/87/46d7e1c2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Better me</span></div></div><div>NamingService 集群有点像去中心化的结构设计，每个节点保存所有数据，很好的保证了节点的可用性，但每个节点之间不互相通信，很难确保节点间的数据一致性。想问下老师主题 (和其中队列) 在 broker 节点的分布情况是怎样的</div><div><p>作者回复：主题和队列是分散到所有 Broker 节点上的，每个 Broker 只保存自己负责的那部分主题和队列信息。并且实际上在集群中，元数据最终是以 Broker 上保存的信息为准的。</p></div><div><div>2019-09-19</div><div><div><i></i><span>2</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/34/df/64e3d533.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>leslie</span></div></div><div>    老师最近的课都是在啃代码且非常整体性：学习上是越来越辛苦了，总要翻阅和梳理知识才能明白题目可能的问题。
    节点之间不互相通信其实减少了网络开销以及相互的等待确认的过程从而节约了时间，不会互相影响互相继承：换个角度来思考这个问题其实就像是我们用虚拟化一样，RocketMQ 的这种 NameServer 就像是 docker/Kubernetes，各自出了问题不会影响其它的 docker/K8。
   优势就是减少了节点之间的通信以及等待的代价，不足就是出了问题如何发现以及通知系统 / 服务端。等待老师对于这个问题的答案的公布：等待明天老师继续的分享，谢谢。</div><div><div>2019-09-18</div><div><div><i></i><span></span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/10/cf/b5/d1ec6a7d.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Stalary</span></div></div><div>老师，我想问一下，如果起了很多个 NameServer，都保持长连接的话是不是开销会较大呢，为什么没有采用订阅发布的模式去更新 broker 呢，是因为即时性吗</div><div><p>作者回复：这又是一个设计选择而已，NameServer 只是负责存储一下元数据，数据量不大，处理请求的 TPS 也不高，所以没必要启动很多个 NameServer，所以并不会存在你说的很多个 NameServer 的情况。</p></div><div><div>2019-09-17</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/10/7d/a9b5d5f0.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 糖醋🏀</span></div></div><div>nnameserver 各个节点独立不通信，是 ap 的思路。
各个节点总是可用，但是节点之间不通信，有可能由于网络原因，某个节点的路由信息可能会不一致。
客户端拉去所有节点的路由信息，可以弥补某个节点路由信息不一致的情况。</div><div><div>2019-09-17</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/2c/73/7f/9088256b.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 莫名其妙的人</span></div></div><div>文章没有提到客户端与哪个 NameServer 节点通信，看了一些网上说法，应该是客户端只需要链接 NameServer 集群地址，然后产生一个随机数取模（失败则轮训即可）。这种随机选择策略不会产生一些不均衡吗？为什么不适用负载均衡，动态路由等方式呢？
</div><div><div>2022-08-09</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/19/d9/ff/b23018a6.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Heaven</span></div></div><div>1. 越简单的设计，健壮性越好，越单一的功能，性能越好，这样设计必然提供了更高的性能
2, 但是容易出现无法保证一致性的问题，但是我想，可能 RMQ 也不在乎</div><div><div>2021-02-18</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/15/e0/6b/f61d7466.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>prader26</span></div></div><div> rocketmq 如何在集群中找到正确的节点。
 
 核心是利用的 NameServer 和 broker 联合实现的。
 1 每个 broker 都和全部的 NameServer 进行通信。
 2 当 broker 上 Topic 信息发生改变的时候，会通知所有的 NameServer 更新路由信息，同时 broker 也会定时把信息
   上报到所有的 NameServer 节点。这个就起到了 NameServer 对 broker 进行健康检测的作用。
3  每台 NameServer 都能单独提供服务。当 NameServer 和 broker 之间的通信断掉，消费者会重新去 NameServer 上拉
  取别的 broker 信息，这样就起到了自动切换失效 Broker 的作用。   </div><div><div>2020-12-08</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>信大捷安</span></div></div><div>看了留言中，nameServer 可以做一个集群，topic 是散列在 nameServer 集群中的一个服务中，那么是如何保证 topic 正确的散列的其中的一个 nameServer 中的，很好奇？</div><div><div>2020-09-18</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/0f/8c/5c/3f164f66.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>亚林</span></div></div><div>牺牲一致性，提高可用性</div><div><div>2020-09-14</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/15/a0/08/065b3cf5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Yippee</span></div></div><div>想问下老师文中讲的代码是基于 RocketMQ 的哪个版本啊，我在 4.5.1 和 4.7.0 中找不到 RouteInfoManager 等类</div><div><p>作者回复：我们使用当前最新的 release 版本 release-4.5.1 进行分析，使用 Git 在 GitHub 上直接下载源码到本地：

git clone git@github.com:apache/rocketmq.git
cd rocketmq
git checkout release-4.5.1</p></div><div><div>2020-05-11</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/6d/46/e16291f8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>丁小明</span></div></div><div>老师你好，有个疑问就是如果客户端链接的那个 nameserver 不可用了怎么办呢，如果 broker 也恰好有变动，那这些客户端是不是也都不可用了。且无法自动恢复</div><div><p>作者回复：所以一般生产环境都使用多个 NameServer 节点来避免单点故障。</p></div><div><div>2020-05-06</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/2d/ca/02b0e397.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>fomy</span></div></div><div>假如其中一台 NameServer 挂了，客户端会自动切换到其他的吗？</div><div><p>作者回复：是的。</p></div><div><div>2020-02-17</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/57/f6/2c7ac1ad.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Peter</span></div></div><div>优点是性能高，Broker 只需关心单个节点，而不需要关注集群状态，客户端只需要和一个 NameServer 打交道，不用关心集群状态。
缺点是不能保证一致性</div><div><div>2019-11-01</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/14/cf/7a/51951b07.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>微笑</span></div></div><div>nameserver 服务感觉跟注册中心有点像</div><div><div>2019-10-25</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".22"><outline class="toc-level-h1" data-reactid=".22.0" style="width: 175px;"><active data-reactid=".22.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".22.0.1"><span data-reactid=".22.0.1.0">23 | RocketMQ 客户端如何在集群中找到正确的节点？</span></a></outline><outline class="toc-level-h2" data-reactid=".22.1" style="width: 165px;"><active data-reactid=".22.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".22.1.1"><span data-reactid=".22.1.1.0">NameServer 是如何提供服务的？</span></a></outline><outline class="toc-level-h2" data-reactid=".22.2" style="width: 165px;"><active data-reactid=".22.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".22.2.1"><span data-reactid=".22.2.1.0">NameServer 的总体结构</span></a></outline><outline class="toc-level-h2" data-reactid=".22.3" style="width: 165px;"><active data-reactid=".22.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".22.3.1"><span data-reactid=".22.3.1.0">NameServer 如何处理 Broker 注册的路由信息？</span></a></outline><outline class="toc-level-h2" data-reactid=".22.4" style="width: 165px;"><active data-reactid=".22.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".22.4.1"><span data-reactid=".22.4.1.0">客户端如何寻找 Broker？</span></a></outline><outline class="toc-level-h2" data-reactid=".22.5" style="width: 165px;"><active data-reactid=".22.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".22.5.1"><span data-reactid=".22.5.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".22.6" style="width: 165px;"><active data-reactid=".22.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".22.6.1"><span data-reactid=".22.6.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".22.7" style="width: 165px;"><active data-reactid=".22.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".22.7.1"><span data-reactid=".22.7.1.0">精选留言 (26)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/136802" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>