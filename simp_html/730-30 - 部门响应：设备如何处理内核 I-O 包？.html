
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAMAAAANIilAAAAA7VBMVEUAAAD///8ZGRnw8PBWVlb4+PgeHh719fVEREQlJSUODg6Ojo7Ly8v9/f1NTU2VlZUFBQV6enrCwsLy8vLh4eE0NDQLCwu8vLyXl5dxcXHa2trAwMCFhYVDQ0OysrKampo7OzssLCwICAioqKjJyckhISHu7u4/Pz9TU1NQUFBLS0tAQED6+vrS0tKRkZFISEgvLy+goKB+fn5vb29nZ2fm5uYbGxvk5OTX19d2dnZaWlre3t5hYWEyMjK5ubkoKCgVFRXQ0NDMzMzFxcW0tLSsrKykpKSMjIzq6urU1NSAgICvr6+cnJyHh4dsbGyfc25QAAAFkElEQVRIx4WXB3faMBCA74wHxgMMGAOh1MyyVyBAmtVmd/3/n1OdDtWstt/Li5JD35MtnU4CMnCIlkLEOpSKuMPhuI4FE444L9+dyv3zciad/rAjfU/yOPpGcjWS1NKSGsk29WTSD1IeYsIPkvsAJF+C5BIZkieYMNjJnsF4+JHk61wOSlVDyOIPqKBgZIxYTrqy/AmNtC1ps7yqlgE6dgYa1WqD5aV9SbKDbe6ZNnCq5A5ILlhGjEASIoawJdmHHo98AZLOnmxzKM9yK9Aht63FoAWBBmEgsEHnkfMgsZU8PJbpbXJd3MIep/Lg/MjbRqMRRuNtQ4Tthga5RiNzfmSWD97ZExQ64HhtgLb3CmbBGyj54vixjyeMsKjnV4AvOAHTwsHphKnH9toXki7Li3jLsgswizskv+c3PHKXe7ZHu5E/YMKcM2yqZIJkAclZTPClbJezivI1yTr4f+TeMib5qXxHsr7XtUFJDIc8pLAHA7Su4JXkd8ySnKZddQXH2NohswIutRu0Qu0jyS46JPugU+gISB1R8NBKWegVUsahTKEjAP9Bm5bKAc3DPlzjKaDvscE7PeEJu63WUg9a82tdA1O/ESupL9Cr6C1cXetjIe9zgQ4kvKLgHi6xC5LcGq9hhmiK0AYgUvLQtzm3n/x0jnum/Vo9j1jxg/pL3/f9W8isMOsv6/Ubf47rvl+u17nnZ1xQ+4iIXa6IpRVeimEEE3pnxO8kIz4CbFDyidVSpooBCCLLsj5noFlqUg2rwK0l+Anmm+VhCzKfrRHtqjGOLANxUKIUiYvFEcuaaZpXANniD5ZzpiBDTSRkuDJfWM6awxGuikUArp7fIOE7RlB6OygGTyhfsMyrtwDNIAkcp1YRhKC9Oh2IHUFQ6UPupnLL3icODaD5zVlUto7zhm1n7kmZ5kDSQBxykfZhD66eaQBoWriEGPcA182C4Crst90Z9NwvHgahDTALw/Ae4D500Pjq3oj/4sjtwcwVrCkkgB01HB8cdM0iIlWSr6IpNqFO+1mDHQFWORtO5EIi08b4jxy6giBsgKDnRnEYYdd9nIYvaLmuhS/h9DF5bEFr/7HTKAjUqWY1oUUBKgYEZdgIP6gJE2xQIWVvLhZBcAWx843kz87PDDi4cgR92s8/1FLpAGNeKiUbGtRQEIPkGb9TM1EF8MpCVEni7pIkkUdDs1ZcI/ZUer6YZg4WxTtqMmYsZJWebbOzEekZV4sCKaNhBaXQQ0NtjL71ZooNE1vWLfyyyFUbw7MsD0fWOFMSqAnbwj1Kuk0Aqp4aJ91MZhhvyS7+oQoMy5v63Jfoz/UYfPSiep2KQb5e4/gt1Ycdc7Se6jNyVbpuQNI08FrICQ6ccKnSXddrKCnqkqWFupJFAewKudSTBVAyBEjrLSXjCYnc5rrdQVl6VaiKqOTToi/kaSrlcW5fpGpgrlJTLvoGVxKDOg7PHzc6NLXOmuUHTZQhTWvS4T7T5ixPqGPz/EHXp/azkMeQoGOqBBOSq1gD4vwRe1culz8W8HlZKQt6Sjbm5XeS9eWizJw73HcsOW8mSpa0eT8zfK1w85LdtWKTf5dWfCPzMg5J+MBdsvvy6Q2QD/d91sfzouRz9zAdBp6HCcUzskccyBdKzjTC9ZE8HT8+JHLxtiE4d33Ud0uleOObvpXZk4E4/9h2sKD9t6oxgaCFxs9AHiI3wYJCndMbIMs9lLi7vEHFLxAUURyciOnTyzrLH6qSJwo+8CWuQIFL2wSoVyvQea/qtk2yvPtb4mekZMhJQkPwyvIzBbJGJD+jX3eGcfIFhWVmxsVAG5FMgSzm9y4wKL8aJdzvyctoTqEgep6K5lckWGM3uuuA5DadFvIhiTzBL1xzVtT0UDEDxd9ldeutcJLoyvUaoPgNdiqckZLamd0AAAAASUVORK5CYII=")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 30 | 部门响应：设备如何处理内核 I/O 包？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>30 | 部门响应：设备如何处理内核 I/O 包？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">这节课我会带你实现分配和释放内存页面，达到内存管理的目的。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">30 | 部门响应：设备如何处理内核 I/O 包？</h1><div><span>LMOS</span> <span>2021-07-16</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/30/78/30c3b042a22fcc9bac08bd2e75dd8278.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：13.97M</span><span> 时长：15:18</span></div></div><audio title="30 | 部门响应：设备如何处理内核I/O包？" src="https://res001.geekbang.org/media/audio/39/f0/39ae42717b2cebef3257bca34fd6e9f0/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="19481" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="19482"><span data-slate-object="text" data-key="19483"><span data-slate-leaf="true" data-offset-key="19483:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19484"><span data-slate-object="text" data-key="19485"><span data-slate-leaf="true" data-offset-key="19485:0" data-first-offset="true"><span data-slate-string="true">在上一课中，我们实现了建立设备的接口，这相当于制定了部门的相关法规，只要遵守这些法规就能建立一个部门。当然，建立了一个部门，是为了干活的，吃空饷可不行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19486"><span data-slate-object="text" data-key="19487"><span data-slate-leaf="true" data-offset-key="19487:0" data-first-offset="true"><span data-slate-string="true">其实一个部门的职责不难确定，它应该能对上级下发的任务作出响应，并完成相关工作，而这对应到设备，就是如何处理内核的 I/O 包，这节课我们就来解决这个问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19488"><span data-slate-object="text" data-key="19489"><span data-slate-leaf="true" data-offset-key="19489:0" data-first-offset="true"><span data-slate-string="true">首先，我们需要搞清楚什么是 I/O 包，然后实现内核向设备发送 I/O 包的工作。最后，我还会带你一起来完成一个驱动实例，用于处理 I/O 包，这样你就能真正理解这里的来龙去脉了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19490"><span data-slate-object="text" data-key="19491"><span data-slate-leaf="true" data-offset-key="19491:0" data-first-offset="true"><span data-slate-string="true">好，让我们开始今天的学习吧！代码你可以从</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="19492"><span data-slate-object="text" data-key="19493"><span data-slate-leaf="true" data-offset-key="19493:0" data-first-offset="true"><span data-slate-string="true">这里</span></span></span></a><span data-slate-object="text" data-key="19494"><span data-slate-leaf="true" data-offset-key="19494:0" data-first-offset="true"><span data-slate-string="true">下载。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19495" id="sr-toc-1"><span data-slate-object="text" data-key="19496"><span data-slate-leaf="true" data-offset-key="19496:0" data-first-offset="true"><span data-slate-string="true">什么是 I/O 包</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19497"><span data-slate-object="text" data-key="19498"><span data-slate-leaf="true" data-offset-key="19498:0" data-first-offset="true"><span data-slate-string="true">就像你要给部门下达任务时，需要准备材料报表之类的东西。同样，内核要求设备做什么事情，完成什么功能，必须要告诉设备的驱动程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19499"><span data-slate-object="text" data-key="19500"><span data-slate-leaf="true" data-offset-key="19500:0" data-first-offset="true"><span data-slate-string="true">内核要求设备完成任务，无非是调用设备的驱动程序函数，把完成任务的细节用参数的形式传递给设备的驱动程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19501"><span data-slate-object="text" data-key="19502"><span data-slate-leaf="true" data-offset-key="19502:0" data-first-offset="true"><span data-slate-string="true">由于参数很多，而且各种操作所需的参数又不相同，所以我们就想到了更高效的管理方法，也就是把各种操作所需的各种参数封装在一个数据结构中，称为 I/O 包，这样就可以统一驱动程序功能函数的形式了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19503"><span data-slate-object="text" data-key="19504"><span data-slate-leaf="true" data-offset-key="19504:0" data-first-offset="true"><span data-slate-string="true">思路理清以后，现在我们来设计这个数据结构，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="19505"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19506"><span data-slate-object="text" data-key="19507"><span data-slate-leaf="true" data-offset-key="19507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="19508"><span data-slate-leaf="true" data-offset-key="19508:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19509"><span data-slate-leaf="true" data-offset-key="19509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="19510"><span data-slate-leaf="true" data-offset-key="19510:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19511"><span data-slate-leaf="true" data-offset-key="19511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">s_OBJNODE</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19512"><span data-slate-object="text" data-key="19513"><span data-slate-leaf="true" data-offset-key="19513:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19514"><span data-slate-object="text" data-key="19515"><span data-slate-leaf="true" data-offset-key="19515:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19516"><span data-slate-leaf="true" data-offset-key="19516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="19517"><span data-slate-leaf="true" data-offset-key="19517:0" data-first-offset="true"><span data-slate-string="true">  on_lock;        </span></span></span><span data-slate-object="text" data-key="19518"><span data-slate-leaf="true" data-offset-key="19518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19519"><span data-slate-object="text" data-key="19520"><span data-slate-leaf="true" data-offset-key="19520:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19521"><span data-slate-leaf="true" data-offset-key="19521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_h_t</span></span></span></span><span data-slate-object="text" data-key="19522"><span data-slate-leaf="true" data-offset-key="19522:0" data-first-offset="true"><span data-slate-string="true">    on_list;        </span></span></span><span data-slate-object="text" data-key="19523"><span data-slate-leaf="true" data-offset-key="19523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19524"><span data-slate-object="text" data-key="19525"><span data-slate-leaf="true" data-offset-key="19525:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19526"><span data-slate-leaf="true" data-offset-key="19526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sem_t</span></span></span></span><span data-slate-object="text" data-key="19527"><span data-slate-leaf="true" data-offset-key="19527:0" data-first-offset="true"><span data-slate-string="true">       on_complesem;   </span></span></span><span data-slate-object="text" data-key="19528"><span data-slate-leaf="true" data-offset-key="19528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 完成信号量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19529"><span data-slate-object="text" data-key="19530"><span data-slate-leaf="true" data-offset-key="19530:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19531"><span data-slate-leaf="true" data-offset-key="19531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19532"><span data-slate-leaf="true" data-offset-key="19532:0" data-first-offset="true"><span data-slate-string="true">      on_flgs;        </span></span></span><span data-slate-object="text" data-key="19533"><span data-slate-leaf="true" data-offset-key="19533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19534"><span data-slate-object="text" data-key="19535"><span data-slate-leaf="true" data-offset-key="19535:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19536"><span data-slate-leaf="true" data-offset-key="19536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19537"><span data-slate-leaf="true" data-offset-key="19537:0" data-first-offset="true"><span data-slate-string="true">      on_stus;        </span></span></span><span data-slate-object="text" data-key="19538"><span data-slate-leaf="true" data-offset-key="19538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19539"><span data-slate-object="text" data-key="19540"><span data-slate-leaf="true" data-offset-key="19540:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19541"><span data-slate-leaf="true" data-offset-key="19541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sint_t</span></span></span></span><span data-slate-object="text" data-key="19542"><span data-slate-leaf="true" data-offset-key="19542:0" data-first-offset="true"><span data-slate-string="true">      on_opercode;    </span></span></span><span data-slate-object="text" data-key="19543"><span data-slate-leaf="true" data-offset-key="19543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 操作码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19544"><span data-slate-object="text" data-key="19545"><span data-slate-leaf="true" data-offset-key="19545:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19546"><span data-slate-leaf="true" data-offset-key="19546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19547"><span data-slate-leaf="true" data-offset-key="19547:0" data-first-offset="true"><span data-slate-string="true">      on_objtype;     </span></span></span><span data-slate-object="text" data-key="19548"><span data-slate-leaf="true" data-offset-key="19548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对象类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19549"><span data-slate-object="text" data-key="19550"><span data-slate-leaf="true" data-offset-key="19550:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19551"><span data-slate-leaf="true" data-offset-key="19551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="19552"><span data-slate-leaf="true" data-offset-key="19552:0" data-first-offset="true"><span data-slate-string="true">*       on_objadr;      </span></span></span><span data-slate-object="text" data-key="19553"><span data-slate-leaf="true" data-offset-key="19553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对象地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19554"><span data-slate-object="text" data-key="19555"><span data-slate-leaf="true" data-offset-key="19555:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19556"><span data-slate-leaf="true" data-offset-key="19556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19557"><span data-slate-leaf="true" data-offset-key="19557:0" data-first-offset="true"><span data-slate-string="true">      on_acsflgs;     </span></span></span><span data-slate-object="text" data-key="19558"><span data-slate-leaf="true" data-offset-key="19558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 访问设备、文件标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19559"><span data-slate-object="text" data-key="19560"><span data-slate-leaf="true" data-offset-key="19560:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19561"><span data-slate-leaf="true" data-offset-key="19561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19562"><span data-slate-leaf="true" data-offset-key="19562:0" data-first-offset="true"><span data-slate-string="true">      on_acsstus;     </span></span></span><span data-slate-object="text" data-key="19563"><span data-slate-leaf="true" data-offset-key="19563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 访问设备、文件状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19564"><span data-slate-object="text" data-key="19565"><span data-slate-leaf="true" data-offset-key="19565:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19566"><span data-slate-leaf="true" data-offset-key="19566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19567"><span data-slate-leaf="true" data-offset-key="19567:0" data-first-offset="true"><span data-slate-string="true">      on_currops;     </span></span></span><span data-slate-object="text" data-key="19568"><span data-slate-leaf="true" data-offset-key="19568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于读写数据的当前位置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19569"><span data-slate-object="text" data-key="19570"><span data-slate-leaf="true" data-offset-key="19570:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19571"><span data-slate-leaf="true" data-offset-key="19571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19572"><span data-slate-leaf="true" data-offset-key="19572:0" data-first-offset="true"><span data-slate-string="true">      on_len;         </span></span></span><span data-slate-object="text" data-key="19573"><span data-slate-leaf="true" data-offset-key="19573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于读写数据的长度</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19574"><span data-slate-object="text" data-key="19575"><span data-slate-leaf="true" data-offset-key="19575:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19576"><span data-slate-leaf="true" data-offset-key="19576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19577"><span data-slate-leaf="true" data-offset-key="19577:0" data-first-offset="true"><span data-slate-string="true">      on_ioctrd;      </span></span></span><span data-slate-object="text" data-key="19578"><span data-slate-leaf="true" data-offset-key="19578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//IO 控制码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19579"><span data-slate-object="text" data-key="19580"><span data-slate-leaf="true" data-offset-key="19580:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19581"><span data-slate-leaf="true" data-offset-key="19581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">buf_t</span></span></span></span><span data-slate-object="text" data-key="19582"><span data-slate-leaf="true" data-offset-key="19582:0" data-first-offset="true"><span data-slate-string="true">       on_buf;         </span></span></span><span data-slate-object="text" data-key="19583"><span data-slate-leaf="true" data-offset-key="19583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于读写数据的缓冲区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19584"><span data-slate-object="text" data-key="19585"><span data-slate-leaf="true" data-offset-key="19585:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19586"><span data-slate-leaf="true" data-offset-key="19586:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19587"><span data-slate-leaf="true" data-offset-key="19587:0" data-first-offset="true"><span data-slate-string="true">      on_bufcurops;   </span></span></span><span data-slate-object="text" data-key="19588"><span data-slate-leaf="true" data-offset-key="19588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于读写数据的缓冲区的当前位置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19589"><span data-slate-object="text" data-key="19590"><span data-slate-leaf="true" data-offset-key="19590:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19591"><span data-slate-leaf="true" data-offset-key="19591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="19592"><span data-slate-leaf="true" data-offset-key="19592:0" data-first-offset="true"><span data-slate-string="true">      on_bufsz;       </span></span></span><span data-slate-object="text" data-key="19593"><span data-slate-leaf="true" data-offset-key="19593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于读写数据的缓冲区的大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19594"><span data-slate-object="text" data-key="19595"><span data-slate-leaf="true" data-offset-key="19595:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19596"><span data-slate-leaf="true" data-offset-key="19596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span><span data-slate-object="text" data-key="19597"><span data-slate-leaf="true" data-offset-key="19597:0" data-first-offset="true"><span data-slate-string="true">      on_count;       </span></span></span><span data-slate-object="text" data-key="19598"><span data-slate-leaf="true" data-offset-key="19598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于对象节点的计数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19599"><span data-slate-object="text" data-key="19600"><span data-slate-leaf="true" data-offset-key="19600:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19601"><span data-slate-leaf="true" data-offset-key="19601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="19602"><span data-slate-leaf="true" data-offset-key="19602:0" data-first-offset="true"><span data-slate-string="true">*       on_safedsc;     </span></span></span><span data-slate-object="text" data-key="19603"><span data-slate-leaf="true" data-offset-key="19603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于对象节点的安全描述符</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19604"><span data-slate-object="text" data-key="19605"><span data-slate-leaf="true" data-offset-key="19605:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19606"><span data-slate-leaf="true" data-offset-key="19606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="19607"><span data-slate-leaf="true" data-offset-key="19607:0" data-first-offset="true"><span data-slate-string="true">*       on_fname;       </span></span></span><span data-slate-object="text" data-key="19608"><span data-slate-leaf="true" data-offset-key="19608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于访问数据文件的名称</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19609"><span data-slate-object="text" data-key="19610"><span data-slate-leaf="true" data-offset-key="19610:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19611"><span data-slate-leaf="true" data-offset-key="19611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="19612"><span data-slate-leaf="true" data-offset-key="19612:0" data-first-offset="true"><span data-slate-string="true">*       on_finode;      </span></span></span><span data-slate-object="text" data-key="19613"><span data-slate-leaf="true" data-offset-key="19613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对应于访问数据文件的结点</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19614"><span data-slate-object="text" data-key="19615"><span data-slate-leaf="true" data-offset-key="19615:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19616"><span data-slate-leaf="true" data-offset-key="19616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="19617"><span data-slate-leaf="true" data-offset-key="19617:0" data-first-offset="true"><span data-slate-string="true">*       on_extp;        </span></span></span><span data-slate-object="text" data-key="19618"><span data-slate-leaf="true" data-offset-key="19618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用于扩展</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19619"><span data-slate-object="text" data-key="19620"><span data-slate-leaf="true" data-offset-key="19620:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="19621"><span data-slate-leaf="true" data-offset-key="19621:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span><span data-slate-object="text" data-key="19622"><span data-slate-leaf="true" data-offset-key="19622:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19623"><span data-slate-object="text" data-key="19624"><span data-slate-leaf="true" data-offset-key="19624:0" data-first-offset="true"><span data-slate-string="true">现在你可能还无法从 objnode_t 这个名字看出它跟 I/O 包的关系。但你从刚才的代码里可以看出，objnode_t 的数据结构中包括了各个驱动程序功能函数的所有参数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19625"><span data-slate-object="text" data-key="19626"><span data-slate-leaf="true" data-offset-key="19626:0" data-first-offset="true"><span data-slate-string="true">等我们后面讲到 API 接口时，你会发现，objnode_t 结构不单是完成了 I/O 包传递参数的功能，它在整个 I/O 生命周期中，都起着重要的作用。这里为了好理解，我们就暂且把 objnode_t 结构当作 I/O 包来看。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="19627" id="sr-toc-2"><span data-slate-object="text" data-key="19628"><span data-slate-leaf="true" data-offset-key="19628:0" data-first-offset="true"><span data-slate-string="true">创建和删除 I/O 包</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="19629"><span data-slate-object="text" data-key="19630"><span data-slate-leaf="true" data-offset-key="19630:0" data-first-offset="true"><span data-slate-string="true">刚才，我们已经定义了 I/O 包也就是 objnode_t 结构，但若是要使用它，就必须先把它建立好。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19631"><span data-slate-object="text" data-key="19632"><span data-slate-leaf="true" data-offset-key="19632:0" data-first-offset="true"><span data-slate-string="true">根据以往的经验，你应该已经猜到了，这里创建 I/O 包就是在内存中建立 objnode_t 结构的实例变量并初始化它。由于这是一个全新的模块，所以我们要先在 cosmos/kernel/ 目录下建立一个新的 krlobjnode.c 文件，在这个文件中写代码，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="19633"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19634"><span data-slate-object="text" data-key="19635"><span data-slate-leaf="true" data-offset-key="19635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立 objnode_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19636"><span data-slate-object="text" data-key="19637"><span data-slate-leaf="true" data-offset-key="19637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span></span><span data-slate-object="text" data-key="19638"><span data-slate-leaf="true" data-offset-key="19638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *</span></span></span></span><span data-slate-object="text" data-key="19639"><span data-slate-leaf="true" data-offset-key="19639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_objnode</span></span></span></span></span><span data-slate-object="text" data-key="19640"><span data-slate-leaf="true" data-offset-key="19640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19641"><span data-slate-object="text" data-key="19642"><span data-slate-leaf="true" data-offset-key="19642:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19643"><span data-slate-object="text" data-key="19644"><span data-slate-leaf="true" data-offset-key="19644:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19645"><span data-slate-leaf="true" data-offset-key="19645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span><span data-slate-object="text" data-key="19646"><span data-slate-leaf="true" data-offset-key="19646:0" data-first-offset="true"><span data-slate-string="true"> *ondp = (</span></span></span><span data-slate-object="text" data-key="19647"><span data-slate-leaf="true" data-offset-key="19647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span><span data-slate-object="text" data-key="19648"><span data-slate-leaf="true" data-offset-key="19648:0" data-first-offset="true"><span data-slate-string="true"> *)</span></span></span><span data-slate-object="text" data-key="19649"><span data-slate-leaf="true" data-offset-key="19649:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew</span></span></span></span><span data-slate-object="text" data-key="19650"><span data-slate-leaf="true" data-offset-key="19650:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="19651"><span data-slate-leaf="true" data-offset-key="19651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="19652"><span data-slate-leaf="true" data-offset-key="19652:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span><span data-slate-object="text" data-key="19653"><span data-slate-leaf="true" data-offset-key="19653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="19654"><span data-slate-leaf="true" data-offset-key="19654:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19655"><span data-slate-leaf="true" data-offset-key="19655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span><span data-slate-object="text" data-key="19656"><span data-slate-leaf="true" data-offset-key="19656:0" data-first-offset="true"><span data-slate-string="true">));</span></span></span><span data-slate-object="text" data-key="19657"><span data-slate-leaf="true" data-offset-key="19657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 分配 objnode_t 结构的内存空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19658"><span data-slate-object="text" data-key="19659"><span data-slate-leaf="true" data-offset-key="19659:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19660"><span data-slate-leaf="true" data-offset-key="19660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19661"><span data-slate-leaf="true" data-offset-key="19661:0" data-first-offset="true"><span data-slate-string="true"> (ondp == </span></span></span><span data-slate-object="text" data-key="19662"><span data-slate-leaf="true" data-offset-key="19662:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19663"><span data-slate-leaf="true" data-offset-key="19663:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19664"><span data-slate-object="text" data-key="19665"><span data-slate-leaf="true" data-offset-key="19665:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19666"><span data-slate-object="text" data-key="19667"><span data-slate-leaf="true" data-offset-key="19667:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19668"><span data-slate-leaf="true" data-offset-key="19668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19669"><span data-slate-leaf="true" data-offset-key="19669:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19670"><span data-slate-leaf="true" data-offset-key="19670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19671"><span data-slate-leaf="true" data-offset-key="19671:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19672"><span data-slate-object="text" data-key="19673"><span data-slate-leaf="true" data-offset-key="19673:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19674"><span data-slate-object="text" data-key="19675"><span data-slate-leaf="true" data-offset-key="19675:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19676"><span data-slate-leaf="true" data-offset-key="19676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t_init</span></span></span></span><span data-slate-object="text" data-key="19677"><span data-slate-leaf="true" data-offset-key="19677:0" data-first-offset="true"><span data-slate-string="true">(ondp);</span></span></span><span data-slate-object="text" data-key="19678"><span data-slate-leaf="true" data-offset-key="19678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化 objnode_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19679"><span data-slate-object="text" data-key="19680"><span data-slate-leaf="true" data-offset-key="19680:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19681"><span data-slate-leaf="true" data-offset-key="19681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19682"><span data-slate-leaf="true" data-offset-key="19682:0" data-first-offset="true"><span data-slate-string="true"> ondp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19683"><span data-slate-object="text" data-key="19684"><span data-slate-leaf="true" data-offset-key="19684:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19685"><span data-slate-object="text" data-key="19686"><span data-slate-leaf="true" data-offset-key="19686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除 objnode_t 结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19687"><span data-slate-object="text" data-key="19688"><span data-slate-leaf="true" data-offset-key="19688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool_t</span></span></span></span></span><span data-slate-object="text" data-key="19689"><span data-slate-leaf="true" data-offset-key="19689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19690"><span data-slate-leaf="true" data-offset-key="19690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldel_objnode</span></span></span></span></span><span data-slate-object="text" data-key="19691"><span data-slate-leaf="true" data-offset-key="19691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19692"><span data-slate-leaf="true" data-offset-key="19692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19693"><span data-slate-leaf="true" data-offset-key="19693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *onodep)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19694"><span data-slate-object="text" data-key="19695"><span data-slate-leaf="true" data-offset-key="19695:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19696"><span data-slate-object="text" data-key="19697"><span data-slate-leaf="true" data-offset-key="19697:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19698"><span data-slate-leaf="true" data-offset-key="19698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19699"><span data-slate-leaf="true" data-offset-key="19699:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="19700"><span data-slate-leaf="true" data-offset-key="19700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldelete</span></span></span></span><span data-slate-object="text" data-key="19701"><span data-slate-leaf="true" data-offset-key="19701:0" data-first-offset="true"><span data-slate-string="true">((</span></span></span><span data-slate-object="text" data-key="19702"><span data-slate-leaf="true" data-offset-key="19702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">adr_t</span></span></span></span><span data-slate-object="text" data-key="19703"><span data-slate-leaf="true" data-offset-key="19703:0" data-first-offset="true"><span data-slate-string="true">)onodep, (</span></span></span><span data-slate-object="text" data-key="19704"><span data-slate-leaf="true" data-offset-key="19704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">size_t</span></span></span></span><span data-slate-object="text" data-key="19705"><span data-slate-leaf="true" data-offset-key="19705:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span><span data-slate-object="text" data-key="19706"><span data-slate-leaf="true" data-offset-key="19706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sizeof</span></span></span></span><span data-slate-object="text" data-key="19707"><span data-slate-leaf="true" data-offset-key="19707:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19708"><span data-slate-leaf="true" data-offset-key="19708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span><span data-slate-object="text" data-key="19709"><span data-slate-leaf="true" data-offset-key="19709:0" data-first-offset="true"><span data-slate-string="true">)) == FALSE)</span></span></span><span data-slate-object="text" data-key="19710"><span data-slate-leaf="true" data-offset-key="19710:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除 objnode_t 结构的内存空间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19711"><span data-slate-object="text" data-key="19712"><span data-slate-leaf="true" data-offset-key="19712:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19713"><span data-slate-object="text" data-key="19714"><span data-slate-leaf="true" data-offset-key="19714:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19715"><span data-slate-leaf="true" data-offset-key="19715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">hal_sysdie</span></span></span></span><span data-slate-object="text" data-key="19716"><span data-slate-leaf="true" data-offset-key="19716:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="19717"><span data-slate-leaf="true" data-offset-key="19717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"krldel_objnode err"</span></span></span></span><span data-slate-object="text" data-key="19718"><span data-slate-leaf="true" data-offset-key="19718:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19719"><span data-slate-object="text" data-key="19720"><span data-slate-leaf="true" data-offset-key="19720:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19721"><span data-slate-leaf="true" data-offset-key="19721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19722"><span data-slate-leaf="true" data-offset-key="19722:0" data-first-offset="true"><span data-slate-string="true"> FALSE;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19723"><span data-slate-object="text" data-key="19724"><span data-slate-leaf="true" data-offset-key="19724:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19725"><span data-slate-object="text" data-key="19726"><span data-slate-leaf="true" data-offset-key="19726:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19727"><span data-slate-leaf="true" data-offset-key="19727:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19728"><span data-slate-leaf="true" data-offset-key="19728:0" data-first-offset="true"><span data-slate-string="true"> TRUE;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19729"><span data-slate-object="text" data-key="19730"><span data-slate-leaf="true" data-offset-key="19730:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19731"><span data-slate-object="text" data-key="19732"><span data-slate-leaf="true" data-offset-key="19732:0" data-first-offset="true"><span data-slate-string="true">上述代码非常简单，主要完成了建立、删除 objnode_t 结构这两件事，其实说白了就是分配和释放 objnode_t 结构的内存空间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19733"><span data-slate-object="text" data-key="19734"><span data-slate-leaf="true" data-offset-key="19734:0" data-first-offset="true"><span data-slate-string="true">这里再一次体现了</span></span></span><span data-slate-object="text" data-key="19735"><span data-slate-leaf="true" data-offset-key="19735:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">内存管理组件在操作系统内核之中的重要性</span></span></span></span><span data-slate-object="text" data-key="19736"><span data-slate-leaf="true" data-offset-key="19736:0" data-first-offset="true"><span data-slate-string="true">，objnode_t_init 函数会初始化 objnode_t 结构中的字段，因为其中有自旋锁、链表、信号量，而这些结构并不能简单地初始为 0，否则可以直接使用 memset 之类的函数把那个内存空间清零就行了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19737" id="sr-toc-3"><span data-slate-object="text" data-key="19738"><span data-slate-leaf="true" data-offset-key="19738:0" data-first-offset="true"><span data-slate-string="true">向设备发送 I/O 包</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19739"><span data-slate-object="text" data-key="19740"><span data-slate-leaf="true" data-offset-key="19740:0" data-first-offset="true"><span data-slate-string="true">现在我们假定在上层接口函数中，已经建立了一个 I/O 包（即 objnode_t 结构），并且把操作码、操作对象和相关的参数信息填写到了 objnode_t 结构之中。那么下一步，就需要把这个 I/O 发送给具体设备的驱动程序，以便驱动程序完成具体工作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19741"><span data-slate-object="text" data-key="19742"><span data-slate-leaf="true" data-offset-key="19742:0" data-first-offset="true"><span data-slate-string="true">我们需要定义实现一个函数，专门用于完成这个功能，它标志着一个设备驱动程序开始运行，经它之后内核就实际的控制权交给驱动程序，由驱动程序代表内核操控设备。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19743"><span data-slate-object="text" data-key="19744"><span data-slate-leaf="true" data-offset-key="19744:0" data-first-offset="true"><span data-slate-string="true">下面，我们就来写好这个函数，不过这个函数属于驱动模型函数，所以要在 krldevice.c 文件中实现这个函数。代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="19745"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19746"><span data-slate-object="text" data-key="19747"><span data-slate-leaf="true" data-offset-key="19747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 发送设备 IO</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19748"><span data-slate-object="text" data-key="19749"><span data-slate-leaf="true" data-offset-key="19749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19750"><span data-slate-leaf="true" data-offset-key="19750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19751"><span data-slate-leaf="true" data-offset-key="19751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldev_io</span></span></span></span></span><span data-slate-object="text" data-key="19752"><span data-slate-leaf="true" data-offset-key="19752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19753"><span data-slate-leaf="true" data-offset-key="19753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">objnode_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19754"><span data-slate-leaf="true" data-offset-key="19754:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *nodep)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19755"><span data-slate-object="text" data-key="19756"><span data-slate-leaf="true" data-offset-key="19756:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19757"><span data-slate-object="text" data-key="19758"><span data-slate-leaf="true" data-offset-key="19758:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19759"><span data-slate-leaf="true" data-offset-key="19759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取设备对象 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19760"><span data-slate-object="text" data-key="19761"><span data-slate-leaf="true" data-offset-key="19761:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19762"><span data-slate-leaf="true" data-offset-key="19762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span><span data-slate-object="text" data-key="19763"><span data-slate-leaf="true" data-offset-key="19763:0" data-first-offset="true"><span data-slate-string="true"> *devp = (</span></span></span><span data-slate-object="text" data-key="19764"><span data-slate-leaf="true" data-offset-key="19764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span><span data-slate-object="text" data-key="19765"><span data-slate-leaf="true" data-offset-key="19765:0" data-first-offset="true"><span data-slate-string="true"> *)(nodep-&gt;on_objadr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19766"><span data-slate-object="text" data-key="19767"><span data-slate-leaf="true" data-offset-key="19767:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19768"><span data-slate-leaf="true" data-offset-key="19768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19769"><span data-slate-leaf="true" data-offset-key="19769:0" data-first-offset="true"><span data-slate-string="true"> ((nodep-&gt;on_objtype != OBJN_TY_DEV &amp;&amp; nodep-&gt;on_objtype != OBJN_TY_FIL) || nodep-&gt;on_objadr == </span></span></span><span data-slate-object="text" data-key="19770"><span data-slate-leaf="true" data-offset-key="19770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19771"><span data-slate-leaf="true" data-offset-key="19771:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19772"><span data-slate-object="text" data-key="19773"><span data-slate-leaf="true" data-offset-key="19773:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="19774"><span data-slate-leaf="true" data-offset-key="19774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查操作对象类型是不是文件或者设备，对象地址是不是为空</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19775"><span data-slate-object="text" data-key="19776"><span data-slate-leaf="true" data-offset-key="19776:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19777"><span data-slate-leaf="true" data-offset-key="19777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19778"><span data-slate-leaf="true" data-offset-key="19778:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19779"><span data-slate-object="text" data-key="19780"><span data-slate-leaf="true" data-offset-key="19780:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19781"><span data-slate-object="text" data-key="19782"><span data-slate-leaf="true" data-offset-key="19782:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19783"><span data-slate-leaf="true" data-offset-key="19783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19784"><span data-slate-leaf="true" data-offset-key="19784:0" data-first-offset="true"><span data-slate-string="true"> (nodep-&gt;on_opercode &lt; </span></span></span><span data-slate-object="text" data-key="19785"><span data-slate-leaf="true" data-offset-key="19785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19786"><span data-slate-leaf="true" data-offset-key="19786:0" data-first-offset="true"><span data-slate-string="true"> || nodep-&gt;on_opercode &gt;= IOIF_CODE_MAX)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19787"><span data-slate-object="text" data-key="19788"><span data-slate-leaf="true" data-offset-key="19788:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="19789"><span data-slate-leaf="true" data-offset-key="19789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查 IO 操作码是不是合乎要求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19790"><span data-slate-object="text" data-key="19791"><span data-slate-leaf="true" data-offset-key="19791:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19792"><span data-slate-leaf="true" data-offset-key="19792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19793"><span data-slate-leaf="true" data-offset-key="19793:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19794"><span data-slate-object="text" data-key="19795"><span data-slate-leaf="true" data-offset-key="19795:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19796"><span data-slate-object="text" data-key="19797"><span data-slate-leaf="true" data-offset-key="19797:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19798"><span data-slate-leaf="true" data-offset-key="19798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19799"><span data-slate-leaf="true" data-offset-key="19799:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="19800"><span data-slate-leaf="true" data-offset-key="19800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldev_call_driver</span></span></span></span><span data-slate-object="text" data-key="19801"><span data-slate-leaf="true" data-offset-key="19801:0" data-first-offset="true"><span data-slate-string="true">(devp, nodep-&gt;on_opercode, </span></span></span><span data-slate-object="text" data-key="19802"><span data-slate-leaf="true" data-offset-key="19802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19803"><span data-slate-leaf="true" data-offset-key="19803:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="19804"><span data-slate-leaf="true" data-offset-key="19804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="19805"><span data-slate-leaf="true" data-offset-key="19805:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="19806"><span data-slate-leaf="true" data-offset-key="19806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19807"><span data-slate-leaf="true" data-offset-key="19807:0" data-first-offset="true"><span data-slate-string="true">, nodep);</span></span></span><span data-slate-object="text" data-key="19808"><span data-slate-leaf="true" data-offset-key="19808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用设备驱动</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19809"><span data-slate-object="text" data-key="19810"><span data-slate-leaf="true" data-offset-key="19810:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19811"><span data-slate-object="text" data-key="19812"><span data-slate-leaf="true" data-offset-key="19812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用设备驱动</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19813"><span data-slate-object="text" data-key="19814"><span data-slate-leaf="true" data-offset-key="19814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19815"><span data-slate-leaf="true" data-offset-key="19815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19816"><span data-slate-leaf="true" data-offset-key="19816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldev_call_driver</span></span></span></span></span><span data-slate-object="text" data-key="19817"><span data-slate-leaf="true" data-offset-key="19817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19818"><span data-slate-leaf="true" data-offset-key="19818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19819"><span data-slate-leaf="true" data-offset-key="19819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="19820"><span data-slate-leaf="true" data-offset-key="19820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19821"><span data-slate-leaf="true" data-offset-key="19821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> iocode, </span></span></span></span></span><span data-slate-object="text" data-key="19822"><span data-slate-leaf="true" data-offset-key="19822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19823"><span data-slate-leaf="true" data-offset-key="19823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> val1, </span></span></span></span></span><span data-slate-object="text" data-key="19824"><span data-slate-leaf="true" data-offset-key="19824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19825"><span data-slate-leaf="true" data-offset-key="19825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> val2, </span></span></span></span></span><span data-slate-object="text" data-key="19826"><span data-slate-leaf="true" data-offset-key="19826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19827"><span data-slate-leaf="true" data-offset-key="19827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *p1, </span></span></span></span></span><span data-slate-object="text" data-key="19828"><span data-slate-leaf="true" data-offset-key="19828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19829"><span data-slate-leaf="true" data-offset-key="19829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *p2)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19830"><span data-slate-object="text" data-key="19831"><span data-slate-leaf="true" data-offset-key="19831:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19832"><span data-slate-object="text" data-key="19833"><span data-slate-leaf="true" data-offset-key="19833:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19834"><span data-slate-leaf="true" data-offset-key="19834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">driver_t</span></span></span></span><span data-slate-object="text" data-key="19835"><span data-slate-leaf="true" data-offset-key="19835:0" data-first-offset="true"><span data-slate-string="true"> *drvp = </span></span></span><span data-slate-object="text" data-key="19836"><span data-slate-leaf="true" data-offset-key="19836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19837"><span data-slate-leaf="true" data-offset-key="19837:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19838"><span data-slate-object="text" data-key="19839"><span data-slate-leaf="true" data-offset-key="19839:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19840"><span data-slate-leaf="true" data-offset-key="19840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19841"><span data-slate-leaf="true" data-offset-key="19841:0" data-first-offset="true"><span data-slate-string="true"> (devp == </span></span></span><span data-slate-object="text" data-key="19842"><span data-slate-leaf="true" data-offset-key="19842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19843"><span data-slate-leaf="true" data-offset-key="19843:0" data-first-offset="true"><span data-slate-string="true"> || iocode &gt;= IOIF_CODE_MAX)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19844"><span data-slate-object="text" data-key="19845"><span data-slate-leaf="true" data-offset-key="19845:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span><span data-slate-object="text" data-key="19846"><span data-slate-leaf="true" data-offset-key="19846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查设备和 IO 操作码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19847"><span data-slate-object="text" data-key="19848"><span data-slate-leaf="true" data-offset-key="19848:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19849"><span data-slate-leaf="true" data-offset-key="19849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19850"><span data-slate-leaf="true" data-offset-key="19850:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19851"><span data-slate-object="text" data-key="19852"><span data-slate-leaf="true" data-offset-key="19852:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19853"><span data-slate-object="text" data-key="19854"><span data-slate-leaf="true" data-offset-key="19854:0" data-first-offset="true"><span data-slate-string="true">    drvp = devp-&gt;dev_drv;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19855"><span data-slate-object="text" data-key="19856"><span data-slate-leaf="true" data-offset-key="19856:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19857"><span data-slate-leaf="true" data-offset-key="19857:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="19858"><span data-slate-leaf="true" data-offset-key="19858:0" data-first-offset="true"><span data-slate-string="true"> (drvp == </span></span></span><span data-slate-object="text" data-key="19859"><span data-slate-leaf="true" data-offset-key="19859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="19860"><span data-slate-leaf="true" data-offset-key="19860:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span><span data-slate-object="text" data-key="19861"><span data-slate-leaf="true" data-offset-key="19861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 检查设备是否有驱动程序</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19862"><span data-slate-object="text" data-key="19863"><span data-slate-leaf="true" data-offset-key="19863:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19864"><span data-slate-object="text" data-key="19865"><span data-slate-leaf="true" data-offset-key="19865:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="19866"><span data-slate-leaf="true" data-offset-key="19866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19867"><span data-slate-leaf="true" data-offset-key="19867:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19868"><span data-slate-object="text" data-key="19869"><span data-slate-leaf="true" data-offset-key="19869:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19870"><span data-slate-object="text" data-key="19871"><span data-slate-leaf="true" data-offset-key="19871:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19872"><span data-slate-leaf="true" data-offset-key="19872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用 IO 操作码为索引调用驱动程序功能分派函数数组中的函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19873"><span data-slate-object="text" data-key="19874"><span data-slate-leaf="true" data-offset-key="19874:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19875"><span data-slate-leaf="true" data-offset-key="19875:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19876"><span data-slate-leaf="true" data-offset-key="19876:0" data-first-offset="true"><span data-slate-string="true"> drvp-&gt;drv_dipfun[iocode](devp, p2);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19877"><span data-slate-object="text" data-key="19878"><span data-slate-leaf="true" data-offset-key="19878:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19879"><span data-slate-object="text" data-key="19880"><span data-slate-leaf="true" data-offset-key="19880:0" data-first-offset="true"><span data-slate-string="true">krldev_io 函数，只接受一个参数，也就是 objnode_t 结构的指针。它会首先检查 objnode_t 结构中的 IO 操作码是不是合乎要求的，还要检查被操作的对象即设备是不是为空，然后调用 krldev_call_driver 函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19881"><span data-slate-object="text" data-key="19882"><span data-slate-leaf="true" data-offset-key="19882:0" data-first-offset="true"><span data-slate-string="true">这个 krldev_call_driver 函数会再次确认传递进来的设备和 IO 操作码，然后重点检查设备有没有驱动程序。这一切检查通过之后，我们就用 IO 操作码为索引调用驱动程序功能分派函数数组中的函数，并把设备和 objnode_t 结构传递进去。有没有觉得眼熟？没错，这正是我们</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="19883"><span data-slate-object="text" data-key="19884"><span data-slate-leaf="true" data-offset-key="19884:0" data-first-offset="true"><span data-slate-string="true">前面课程</span></span></span></a><span data-slate-object="text" data-key="19885"><span data-slate-leaf="true" data-offset-key="19885:0" data-first-offset="true"><span data-slate-string="true">中对驱动程序的设计。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19886"><span data-slate-object="text" data-key="19887"><span data-slate-leaf="true" data-offset-key="19887:0" data-first-offset="true"><span data-slate-string="true">好了，现在一个设备的驱动程序就能正式开始工作，开始响应处理内核发来的 I/O 包了。可是我们还没有驱动呢，所以下面我们就去实现一个驱动程序。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="19888" id="sr-toc-4"><span data-slate-object="text" data-key="19889"><span data-slate-leaf="true" data-offset-key="19889:0" data-first-offset="true"><span data-slate-string="true">驱动程序实例</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="19890"><span data-slate-object="text" data-key="19891"><span data-slate-leaf="true" data-offset-key="19891:0" data-first-offset="true"><span data-slate-string="true">现在我们一起来实现一个真实而且简单的设备驱动程序，就是 systick 设备驱动，它是我们 Cosmos 系统的心跳，systick 设备的主要功能和作用是每隔 1ms 产生一个中断，相当于一个定时器，每次时间到达就产生一个中断向系统报告又过了 1ms，相当于千分之一秒，即每秒钟内产生 1000 次中断。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19892"><span data-slate-object="text" data-key="19893"><span data-slate-leaf="true" data-offset-key="19893:0" data-first-offset="true"><span data-slate-string="true">对于现代 CPU 的速度来说，这个中断频率不算太快。x86 平台上有没有这样的定时器呢？当然有，其中 8254 就是一个古老且常用的定时器，对它进行编程设定，它就可以周期的产生定时器中断。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19894"><span data-slate-object="text" data-key="19895"><span data-slate-leaf="true" data-offset-key="19895:0" data-first-offset="true"><span data-slate-string="true">这里我们就以 8254 定时器为基础，实现 Cosmos 系统的 systick 设备。我们先从 systick 设备驱动程序的整体框架入手，然后建立 systick 设备，最后一步一步实现 systick 设备驱动程序。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="19896" id="sr-toc-5"><span data-slate-object="text" data-key="19897"><span data-slate-leaf="true" data-offset-key="19897:0" data-first-offset="true"><span data-slate-string="true">systick 设备驱动程序的整体框架</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="19898"><span data-slate-object="text" data-key="19899"><span data-slate-leaf="true" data-offset-key="19899:0" data-first-offset="true"><span data-slate-string="true">在前面的课程中，我们已经了解了在 Cosmos 系统下，一个设备驱动程序的基本框架，但是我们没有深入具体化。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="19900"><span data-slate-object="text" data-key="19901"><span data-slate-leaf="true" data-offset-key="19901:0" data-first-offset="true"><span data-slate-string="true">所以，这里我会带你从全局好好了解一个真实的设备，它的驱动程序应该至少有哪些函数。由于这是个驱动程序，我们需要在 cosmos/drivers/ 目录下建立一个 drvtick.c 文件，在 drvtick.c 文件中写入以下代码，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="19902"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="19903"><span data-slate-object="text" data-key="19904"><span data-slate-leaf="true" data-offset-key="19904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 驱动程序入口和退出函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19905"><span data-slate-object="text" data-key="19906"><span data-slate-leaf="true" data-offset-key="19906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19907"><span data-slate-leaf="true" data-offset-key="19907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19908"><span data-slate-leaf="true" data-offset-key="19908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_entry</span></span></span></span></span><span data-slate-object="text" data-key="19909"><span data-slate-leaf="true" data-offset-key="19909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19910"><span data-slate-leaf="true" data-offset-key="19910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">driver_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19911"><span data-slate-leaf="true" data-offset-key="19911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *drvp, </span></span></span></span></span><span data-slate-object="text" data-key="19912"><span data-slate-leaf="true" data-offset-key="19912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19913"><span data-slate-leaf="true" data-offset-key="19913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> val, </span></span></span></span></span><span data-slate-object="text" data-key="19914"><span data-slate-leaf="true" data-offset-key="19914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19915"><span data-slate-leaf="true" data-offset-key="19915:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *p)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19916"><span data-slate-object="text" data-key="19917"><span data-slate-leaf="true" data-offset-key="19917:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19918"><span data-slate-object="text" data-key="19919"><span data-slate-leaf="true" data-offset-key="19919:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19920"><span data-slate-leaf="true" data-offset-key="19920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19921"><span data-slate-leaf="true" data-offset-key="19921:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19922"><span data-slate-object="text" data-key="19923"><span data-slate-leaf="true" data-offset-key="19923:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19924"><span data-slate-object="text" data-key="19925"><span data-slate-leaf="true" data-offset-key="19925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19926"><span data-slate-leaf="true" data-offset-key="19926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19927"><span data-slate-leaf="true" data-offset-key="19927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_exit</span></span></span></span></span><span data-slate-object="text" data-key="19928"><span data-slate-leaf="true" data-offset-key="19928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19929"><span data-slate-leaf="true" data-offset-key="19929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">driver_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19930"><span data-slate-leaf="true" data-offset-key="19930:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *drvp, </span></span></span></span></span><span data-slate-object="text" data-key="19931"><span data-slate-leaf="true" data-offset-key="19931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19932"><span data-slate-leaf="true" data-offset-key="19932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> val, </span></span></span></span></span><span data-slate-object="text" data-key="19933"><span data-slate-leaf="true" data-offset-key="19933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19934"><span data-slate-leaf="true" data-offset-key="19934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *p)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19935"><span data-slate-object="text" data-key="19936"><span data-slate-leaf="true" data-offset-key="19936:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19937"><span data-slate-object="text" data-key="19938"><span data-slate-leaf="true" data-offset-key="19938:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19939"><span data-slate-leaf="true" data-offset-key="19939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19940"><span data-slate-leaf="true" data-offset-key="19940:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19941"><span data-slate-object="text" data-key="19942"><span data-slate-leaf="true" data-offset-key="19942:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19943"><span data-slate-object="text" data-key="19944"><span data-slate-leaf="true" data-offset-key="19944:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备中断处理函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19945"><span data-slate-object="text" data-key="19946"><span data-slate-leaf="true" data-offset-key="19946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19947"><span data-slate-leaf="true" data-offset-key="19947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19948"><span data-slate-leaf="true" data-offset-key="19948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_handle</span></span></span></span></span><span data-slate-object="text" data-key="19949"><span data-slate-leaf="true" data-offset-key="19949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19950"><span data-slate-leaf="true" data-offset-key="19950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19951"><span data-slate-leaf="true" data-offset-key="19951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ift_nr, </span></span></span></span></span><span data-slate-object="text" data-key="19952"><span data-slate-leaf="true" data-offset-key="19952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19953"><span data-slate-leaf="true" data-offset-key="19953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="19954"><span data-slate-leaf="true" data-offset-key="19954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19955"><span data-slate-leaf="true" data-offset-key="19955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *sframe)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19956"><span data-slate-object="text" data-key="19957"><span data-slate-leaf="true" data-offset-key="19957:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19958"><span data-slate-object="text" data-key="19959"><span data-slate-leaf="true" data-offset-key="19959:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19960"><span data-slate-leaf="true" data-offset-key="19960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19961"><span data-slate-leaf="true" data-offset-key="19961:0" data-first-offset="true"><span data-slate-string="true"> DFCEERSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19962"><span data-slate-object="text" data-key="19963"><span data-slate-leaf="true" data-offset-key="19963:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19964"><span data-slate-object="text" data-key="19965"><span data-slate-leaf="true" data-offset-key="19965:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 打开、关闭设备函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19966"><span data-slate-object="text" data-key="19967"><span data-slate-leaf="true" data-offset-key="19967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19968"><span data-slate-leaf="true" data-offset-key="19968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19969"><span data-slate-leaf="true" data-offset-key="19969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_open</span></span></span></span></span><span data-slate-object="text" data-key="19970"><span data-slate-leaf="true" data-offset-key="19970:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19971"><span data-slate-leaf="true" data-offset-key="19971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19972"><span data-slate-leaf="true" data-offset-key="19972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="19973"><span data-slate-leaf="true" data-offset-key="19973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19974"><span data-slate-leaf="true" data-offset-key="19974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19975"><span data-slate-object="text" data-key="19976"><span data-slate-leaf="true" data-offset-key="19976:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19977"><span data-slate-object="text" data-key="19978"><span data-slate-leaf="true" data-offset-key="19978:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19979"><span data-slate-leaf="true" data-offset-key="19979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19980"><span data-slate-leaf="true" data-offset-key="19980:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19981"><span data-slate-object="text" data-key="19982"><span data-slate-leaf="true" data-offset-key="19982:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19983"><span data-slate-object="text" data-key="19984"><span data-slate-leaf="true" data-offset-key="19984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="19985"><span data-slate-leaf="true" data-offset-key="19985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="19986"><span data-slate-leaf="true" data-offset-key="19986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_close</span></span></span></span></span><span data-slate-object="text" data-key="19987"><span data-slate-leaf="true" data-offset-key="19987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="19988"><span data-slate-leaf="true" data-offset-key="19988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="19989"><span data-slate-leaf="true" data-offset-key="19989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="19990"><span data-slate-leaf="true" data-offset-key="19990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="19991"><span data-slate-leaf="true" data-offset-key="19991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19992"><span data-slate-object="text" data-key="19993"><span data-slate-leaf="true" data-offset-key="19993:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19994"><span data-slate-object="text" data-key="19995"><span data-slate-leaf="true" data-offset-key="19995:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="19996"><span data-slate-leaf="true" data-offset-key="19996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="19997"><span data-slate-leaf="true" data-offset-key="19997:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="19998"><span data-slate-object="text" data-key="19999"><span data-slate-leaf="true" data-offset-key="19999:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20000"><span data-slate-object="text" data-key="20001"><span data-slate-leaf="true" data-offset-key="20001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读、写设备数据函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20002"><span data-slate-object="text" data-key="20003"><span data-slate-leaf="true" data-offset-key="20003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20004"><span data-slate-leaf="true" data-offset-key="20004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20005"><span data-slate-leaf="true" data-offset-key="20005:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_read</span></span></span></span></span><span data-slate-object="text" data-key="20006"><span data-slate-leaf="true" data-offset-key="20006:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20007"><span data-slate-leaf="true" data-offset-key="20007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20008"><span data-slate-leaf="true" data-offset-key="20008:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20009"><span data-slate-leaf="true" data-offset-key="20009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20010"><span data-slate-leaf="true" data-offset-key="20010:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20011"><span data-slate-object="text" data-key="20012"><span data-slate-leaf="true" data-offset-key="20012:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20013"><span data-slate-object="text" data-key="20014"><span data-slate-leaf="true" data-offset-key="20014:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20015"><span data-slate-leaf="true" data-offset-key="20015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20016"><span data-slate-leaf="true" data-offset-key="20016:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20017"><span data-slate-object="text" data-key="20018"><span data-slate-leaf="true" data-offset-key="20018:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20019"><span data-slate-object="text" data-key="20020"><span data-slate-leaf="true" data-offset-key="20020:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20021"><span data-slate-leaf="true" data-offset-key="20021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20022"><span data-slate-leaf="true" data-offset-key="20022:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_write</span></span></span></span></span><span data-slate-object="text" data-key="20023"><span data-slate-leaf="true" data-offset-key="20023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20024"><span data-slate-leaf="true" data-offset-key="20024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20025"><span data-slate-leaf="true" data-offset-key="20025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20026"><span data-slate-leaf="true" data-offset-key="20026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20027"><span data-slate-leaf="true" data-offset-key="20027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20028"><span data-slate-object="text" data-key="20029"><span data-slate-leaf="true" data-offset-key="20029:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20030"><span data-slate-object="text" data-key="20031"><span data-slate-leaf="true" data-offset-key="20031:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20032"><span data-slate-leaf="true" data-offset-key="20032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20033"><span data-slate-leaf="true" data-offset-key="20033:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20034"><span data-slate-object="text" data-key="20035"><span data-slate-leaf="true" data-offset-key="20035:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20036"><span data-slate-object="text" data-key="20037"><span data-slate-leaf="true" data-offset-key="20037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调整读写设备数据位置函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20038"><span data-slate-object="text" data-key="20039"><span data-slate-leaf="true" data-offset-key="20039:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20040"><span data-slate-leaf="true" data-offset-key="20040:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20041"><span data-slate-leaf="true" data-offset-key="20041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_lseek</span></span></span></span></span><span data-slate-object="text" data-key="20042"><span data-slate-leaf="true" data-offset-key="20042:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20043"><span data-slate-leaf="true" data-offset-key="20043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20044"><span data-slate-leaf="true" data-offset-key="20044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20045"><span data-slate-leaf="true" data-offset-key="20045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20046"><span data-slate-leaf="true" data-offset-key="20046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20047"><span data-slate-object="text" data-key="20048"><span data-slate-leaf="true" data-offset-key="20048:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20049"><span data-slate-object="text" data-key="20050"><span data-slate-leaf="true" data-offset-key="20050:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20051"><span data-slate-leaf="true" data-offset-key="20051:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20052"><span data-slate-leaf="true" data-offset-key="20052:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20053"><span data-slate-object="text" data-key="20054"><span data-slate-leaf="true" data-offset-key="20054:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20055"><span data-slate-object="text" data-key="20056"><span data-slate-leaf="true" data-offset-key="20056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 控制设备函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20057"><span data-slate-object="text" data-key="20058"><span data-slate-leaf="true" data-offset-key="20058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20059"><span data-slate-leaf="true" data-offset-key="20059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20060"><span data-slate-leaf="true" data-offset-key="20060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_ioctrl</span></span></span></span></span><span data-slate-object="text" data-key="20061"><span data-slate-leaf="true" data-offset-key="20061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20062"><span data-slate-leaf="true" data-offset-key="20062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20063"><span data-slate-leaf="true" data-offset-key="20063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20064"><span data-slate-leaf="true" data-offset-key="20064:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20065"><span data-slate-leaf="true" data-offset-key="20065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20066"><span data-slate-object="text" data-key="20067"><span data-slate-leaf="true" data-offset-key="20067:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20068"><span data-slate-object="text" data-key="20069"><span data-slate-leaf="true" data-offset-key="20069:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20070"><span data-slate-leaf="true" data-offset-key="20070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20071"><span data-slate-leaf="true" data-offset-key="20071:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20072"><span data-slate-object="text" data-key="20073"><span data-slate-leaf="true" data-offset-key="20073:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20074"><span data-slate-object="text" data-key="20075"><span data-slate-leaf="true" data-offset-key="20075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 开启、停止设备函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20076"><span data-slate-object="text" data-key="20077"><span data-slate-leaf="true" data-offset-key="20077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20078"><span data-slate-leaf="true" data-offset-key="20078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20079"><span data-slate-leaf="true" data-offset-key="20079:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_dev_start</span></span></span></span></span><span data-slate-object="text" data-key="20080"><span data-slate-leaf="true" data-offset-key="20080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20081"><span data-slate-leaf="true" data-offset-key="20081:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20082"><span data-slate-leaf="true" data-offset-key="20082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20083"><span data-slate-leaf="true" data-offset-key="20083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20084"><span data-slate-leaf="true" data-offset-key="20084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20085"><span data-slate-object="text" data-key="20086"><span data-slate-leaf="true" data-offset-key="20086:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20087"><span data-slate-object="text" data-key="20088"><span data-slate-leaf="true" data-offset-key="20088:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20089"><span data-slate-leaf="true" data-offset-key="20089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20090"><span data-slate-leaf="true" data-offset-key="20090:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20091"><span data-slate-object="text" data-key="20092"><span data-slate-leaf="true" data-offset-key="20092:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20093"><span data-slate-object="text" data-key="20094"><span data-slate-leaf="true" data-offset-key="20094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20095"><span data-slate-leaf="true" data-offset-key="20095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20096"><span data-slate-leaf="true" data-offset-key="20096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_dev_stop</span></span></span></span></span><span data-slate-object="text" data-key="20097"><span data-slate-leaf="true" data-offset-key="20097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20098"><span data-slate-leaf="true" data-offset-key="20098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20099"><span data-slate-leaf="true" data-offset-key="20099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20100"><span data-slate-leaf="true" data-offset-key="20100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20101"><span data-slate-leaf="true" data-offset-key="20101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20102"><span data-slate-object="text" data-key="20103"><span data-slate-leaf="true" data-offset-key="20103:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20104"><span data-slate-object="text" data-key="20105"><span data-slate-leaf="true" data-offset-key="20105:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20106"><span data-slate-leaf="true" data-offset-key="20106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20107"><span data-slate-leaf="true" data-offset-key="20107:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20108"><span data-slate-object="text" data-key="20109"><span data-slate-leaf="true" data-offset-key="20109:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20110"><span data-slate-object="text" data-key="20111"><span data-slate-leaf="true" data-offset-key="20111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置设备电源函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20112"><span data-slate-object="text" data-key="20113"><span data-slate-leaf="true" data-offset-key="20113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20114"><span data-slate-leaf="true" data-offset-key="20114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20115"><span data-slate-leaf="true" data-offset-key="20115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_set_powerstus</span></span></span></span></span><span data-slate-object="text" data-key="20116"><span data-slate-leaf="true" data-offset-key="20116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20117"><span data-slate-leaf="true" data-offset-key="20117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20118"><span data-slate-leaf="true" data-offset-key="20118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20119"><span data-slate-leaf="true" data-offset-key="20119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20120"><span data-slate-leaf="true" data-offset-key="20120:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20121"><span data-slate-object="text" data-key="20122"><span data-slate-leaf="true" data-offset-key="20122:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20123"><span data-slate-object="text" data-key="20124"><span data-slate-leaf="true" data-offset-key="20124:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20125"><span data-slate-leaf="true" data-offset-key="20125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20126"><span data-slate-leaf="true" data-offset-key="20126:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20127"><span data-slate-object="text" data-key="20128"><span data-slate-leaf="true" data-offset-key="20128:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20129"><span data-slate-object="text" data-key="20130"><span data-slate-leaf="true" data-offset-key="20130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 枚举设备函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20131"><span data-slate-object="text" data-key="20132"><span data-slate-leaf="true" data-offset-key="20132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20133"><span data-slate-leaf="true" data-offset-key="20133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20134"><span data-slate-leaf="true" data-offset-key="20134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_enum_dev</span></span></span></span></span><span data-slate-object="text" data-key="20135"><span data-slate-leaf="true" data-offset-key="20135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20136"><span data-slate-leaf="true" data-offset-key="20136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20137"><span data-slate-leaf="true" data-offset-key="20137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20138"><span data-slate-leaf="true" data-offset-key="20138:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20139"><span data-slate-leaf="true" data-offset-key="20139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20140"><span data-slate-object="text" data-key="20141"><span data-slate-leaf="true" data-offset-key="20141:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20142"><span data-slate-object="text" data-key="20143"><span data-slate-leaf="true" data-offset-key="20143:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20144"><span data-slate-leaf="true" data-offset-key="20144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20145"><span data-slate-leaf="true" data-offset-key="20145:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20146"><span data-slate-object="text" data-key="20147"><span data-slate-leaf="true" data-offset-key="20147:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20148"><span data-slate-object="text" data-key="20149"><span data-slate-leaf="true" data-offset-key="20149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 刷新设备缓存函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20150"><span data-slate-object="text" data-key="20151"><span data-slate-leaf="true" data-offset-key="20151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20152"><span data-slate-leaf="true" data-offset-key="20152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20153"><span data-slate-leaf="true" data-offset-key="20153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_flush</span></span></span></span></span><span data-slate-object="text" data-key="20154"><span data-slate-leaf="true" data-offset-key="20154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20155"><span data-slate-leaf="true" data-offset-key="20155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20156"><span data-slate-leaf="true" data-offset-key="20156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20157"><span data-slate-leaf="true" data-offset-key="20157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20158"><span data-slate-leaf="true" data-offset-key="20158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20159"><span data-slate-object="text" data-key="20160"><span data-slate-leaf="true" data-offset-key="20160:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20161"><span data-slate-object="text" data-key="20162"><span data-slate-leaf="true" data-offset-key="20162:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20163"><span data-slate-leaf="true" data-offset-key="20163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20164"><span data-slate-leaf="true" data-offset-key="20164:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20165"><span data-slate-object="text" data-key="20166"><span data-slate-leaf="true" data-offset-key="20166:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20167"><span data-slate-object="text" data-key="20168"><span data-slate-leaf="true" data-offset-key="20168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备关机函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20169"><span data-slate-object="text" data-key="20170"><span data-slate-leaf="true" data-offset-key="20170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20171"><span data-slate-leaf="true" data-offset-key="20171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20172"><span data-slate-leaf="true" data-offset-key="20172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_shutdown</span></span></span></span></span><span data-slate-object="text" data-key="20173"><span data-slate-leaf="true" data-offset-key="20173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20174"><span data-slate-leaf="true" data-offset-key="20174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20175"><span data-slate-leaf="true" data-offset-key="20175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20176"><span data-slate-leaf="true" data-offset-key="20176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20177"><span data-slate-leaf="true" data-offset-key="20177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20178"><span data-slate-object="text" data-key="20179"><span data-slate-leaf="true" data-offset-key="20179:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20180"><span data-slate-object="text" data-key="20181"><span data-slate-leaf="true" data-offset-key="20181:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20182"><span data-slate-leaf="true" data-offset-key="20182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20183"><span data-slate-leaf="true" data-offset-key="20183:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20184"><span data-slate-object="text" data-key="20185"><span data-slate-leaf="true" data-offset-key="20185:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20186"><span data-slate-object="text" data-key="20187"><span data-slate-leaf="true" data-offset-key="20187:0" data-first-offset="true"><span data-slate-string="true">以上就是一个驱动程序必不可少的函数，</span></span></span><span data-slate-object="text" data-key="20188"><span data-slate-leaf="true" data-offset-key="20188:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在各个函数可以返回一个错误状态，而不做任何实际工作，但是必须要有这个函数。</span></span></span></span><span data-slate-object="text" data-key="20189"><span data-slate-leaf="true" data-offset-key="20189:0" data-first-offset="true"><span data-slate-string="true">这样在内核发来任何设备功能请求时，驱动程序才能给予适当的响应。这样，一个驱动程序的整体框架就确定了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20190"><span data-slate-object="text" data-key="20191"><span data-slate-leaf="true" data-offset-key="20191:0" data-first-offset="true"><span data-slate-string="true">写好了驱动程序的整体框架，我们这个驱动就完成了一半。下面我们来一步一步来实现它。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="20192" id="sr-toc-6"><span data-slate-object="text" data-key="20193"><span data-slate-leaf="true" data-offset-key="20193:0" data-first-offset="true"><span data-slate-string="true">systick 设备驱动程序的入口</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="20194"><span data-slate-object="text" data-key="20195"><span data-slate-leaf="true" data-offset-key="20195:0" data-first-offset="true"><span data-slate-string="true">我们先来写好 systick 设备驱动程序的入口函数。那这个函数用来做什么呢？其实我们在上一节课就详细讨论过，无非是建立设备，向内核注册设备，安装中断回调函数等操作，所以这里不再赘述。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20196"><span data-slate-object="text" data-key="20197"><span data-slate-leaf="true" data-offset-key="20197:0" data-first-offset="true"><span data-slate-string="true">我们直接写出这个函数，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="20198"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="20199"><span data-slate-object="text" data-key="20200"><span data-slate-leaf="true" data-offset-key="20200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20201"><span data-slate-leaf="true" data-offset-key="20201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20202"><span data-slate-leaf="true" data-offset-key="20202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_entry</span></span></span></span></span><span data-slate-object="text" data-key="20203"><span data-slate-leaf="true" data-offset-key="20203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20204"><span data-slate-leaf="true" data-offset-key="20204:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">driver_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20205"><span data-slate-leaf="true" data-offset-key="20205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* drvp,</span></span></span></span></span><span data-slate-object="text" data-key="20206"><span data-slate-leaf="true" data-offset-key="20206:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20207"><span data-slate-leaf="true" data-offset-key="20207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> val,</span></span></span></span></span><span data-slate-object="text" data-key="20208"><span data-slate-leaf="true" data-offset-key="20208:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20209"><span data-slate-leaf="true" data-offset-key="20209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">* p)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20210"><span data-slate-object="text" data-key="20211"><span data-slate-leaf="true" data-offset-key="20211:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20212"><span data-slate-object="text" data-key="20213"><span data-slate-leaf="true" data-offset-key="20213:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20214"><span data-slate-leaf="true" data-offset-key="20214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="20215"><span data-slate-leaf="true" data-offset-key="20215:0" data-first-offset="true"><span data-slate-string="true">(drvp==</span></span></span><span data-slate-object="text" data-key="20216"><span data-slate-leaf="true" data-offset-key="20216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="20217"><span data-slate-leaf="true" data-offset-key="20217:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="20218"><span data-slate-leaf="true" data-offset-key="20218:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//drvp 是内核传递进来的参数，不能为 NULL</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20219"><span data-slate-object="text" data-key="20220"><span data-slate-leaf="true" data-offset-key="20220:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20221"><span data-slate-object="text" data-key="20222"><span data-slate-leaf="true" data-offset-key="20222:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="20223"><span data-slate-leaf="true" data-offset-key="20223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20224"><span data-slate-leaf="true" data-offset-key="20224:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20225"><span data-slate-object="text" data-key="20226"><span data-slate-leaf="true" data-offset-key="20226:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20227"><span data-slate-object="text" data-key="20228"><span data-slate-leaf="true" data-offset-key="20228:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20229"><span data-slate-leaf="true" data-offset-key="20229:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span><span data-slate-object="text" data-key="20230"><span data-slate-leaf="true" data-offset-key="20230:0" data-first-offset="true"><span data-slate-string="true">* devp=</span></span></span><span data-slate-object="text" data-key="20231"><span data-slate-leaf="true" data-offset-key="20231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new_device_dsc</span></span></span></span><span data-slate-object="text" data-key="20232"><span data-slate-leaf="true" data-offset-key="20232:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="20233"><span data-slate-leaf="true" data-offset-key="20233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 建立设备描述符结构的变量实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20234"><span data-slate-object="text" data-key="20235"><span data-slate-leaf="true" data-offset-key="20235:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20236"><span data-slate-leaf="true" data-offset-key="20236:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="20237"><span data-slate-leaf="true" data-offset-key="20237:0" data-first-offset="true"><span data-slate-string="true">(devp==</span></span></span><span data-slate-object="text" data-key="20238"><span data-slate-leaf="true" data-offset-key="20238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="20239"><span data-slate-leaf="true" data-offset-key="20239:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span><span data-slate-object="text" data-key="20240"><span data-slate-leaf="true" data-offset-key="20240:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不能失败</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20241"><span data-slate-object="text" data-key="20242"><span data-slate-leaf="true" data-offset-key="20242:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20243"><span data-slate-object="text" data-key="20244"><span data-slate-leaf="true" data-offset-key="20244:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="20245"><span data-slate-leaf="true" data-offset-key="20245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20246"><span data-slate-leaf="true" data-offset-key="20246:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20247"><span data-slate-object="text" data-key="20248"><span data-slate-leaf="true" data-offset-key="20248:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20249"><span data-slate-object="text" data-key="20250"><span data-slate-leaf="true" data-offset-key="20250:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20251"><span data-slate-leaf="true" data-offset-key="20251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_set_driver</span></span></span></span><span data-slate-object="text" data-key="20252"><span data-slate-leaf="true" data-offset-key="20252:0" data-first-offset="true"><span data-slate-string="true">(drvp);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20253"><span data-slate-object="text" data-key="20254"><span data-slate-leaf="true" data-offset-key="20254:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20255"><span data-slate-leaf="true" data-offset-key="20255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_set_device</span></span></span></span><span data-slate-object="text" data-key="20256"><span data-slate-leaf="true" data-offset-key="20256:0" data-first-offset="true"><span data-slate-string="true">(devp,drvp);</span></span></span><span data-slate-object="text" data-key="20257"><span data-slate-leaf="true" data-offset-key="20257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 驱动程序的功能函数设置到 driver_t 结构中的 drv_dipfun 数组中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20258"><span data-slate-object="text" data-key="20259"><span data-slate-leaf="true" data-offset-key="20259:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20260"><span data-slate-leaf="true" data-offset-key="20260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="20261"><span data-slate-leaf="true" data-offset-key="20261:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20262"><span data-slate-leaf="true" data-offset-key="20262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldev_add_driver</span></span></span></span><span data-slate-object="text" data-key="20263"><span data-slate-leaf="true" data-offset-key="20263:0" data-first-offset="true"><span data-slate-string="true">(devp,drvp)==DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="20264"><span data-slate-leaf="true" data-offset-key="20264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将设备挂载到驱动中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20265"><span data-slate-object="text" data-key="20266"><span data-slate-leaf="true" data-offset-key="20266:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20267"><span data-slate-object="text" data-key="20268"><span data-slate-leaf="true" data-offset-key="20268:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="20269"><span data-slate-leaf="true" data-offset-key="20269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="20270"><span data-slate-leaf="true" data-offset-key="20270:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20271"><span data-slate-leaf="true" data-offset-key="20271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">del_device_dsc</span></span></span></span><span data-slate-object="text" data-key="20272"><span data-slate-leaf="true" data-offset-key="20272:0" data-first-offset="true"><span data-slate-string="true">(devp)==DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="20273"><span data-slate-leaf="true" data-offset-key="20273:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注意释放资源。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20274"><span data-slate-object="text" data-key="20275"><span data-slate-leaf="true" data-offset-key="20275:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20276"><span data-slate-object="text" data-key="20277"><span data-slate-leaf="true" data-offset-key="20277:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="20278"><span data-slate-leaf="true" data-offset-key="20278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20279"><span data-slate-leaf="true" data-offset-key="20279:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20280"><span data-slate-object="text" data-key="20281"><span data-slate-leaf="true" data-offset-key="20281:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20282"><span data-slate-object="text" data-key="20283"><span data-slate-leaf="true" data-offset-key="20283:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="20284"><span data-slate-leaf="true" data-offset-key="20284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20285"><span data-slate-leaf="true" data-offset-key="20285:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20286"><span data-slate-object="text" data-key="20287"><span data-slate-leaf="true" data-offset-key="20287:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20288"><span data-slate-object="text" data-key="20289"><span data-slate-leaf="true" data-offset-key="20289:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20290"><span data-slate-leaf="true" data-offset-key="20290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="20291"><span data-slate-leaf="true" data-offset-key="20291:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20292"><span data-slate-leaf="true" data-offset-key="20292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_device</span></span></span></span><span data-slate-object="text" data-key="20293"><span data-slate-leaf="true" data-offset-key="20293:0" data-first-offset="true"><span data-slate-string="true">(devp)==DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="20294"><span data-slate-leaf="true" data-offset-key="20294:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 向内核注册设备</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20295"><span data-slate-object="text" data-key="20296"><span data-slate-leaf="true" data-offset-key="20296:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20297"><span data-slate-object="text" data-key="20298"><span data-slate-leaf="true" data-offset-key="20298:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="20299"><span data-slate-leaf="true" data-offset-key="20299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="20300"><span data-slate-leaf="true" data-offset-key="20300:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20301"><span data-slate-leaf="true" data-offset-key="20301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">del_device_dsc</span></span></span></span><span data-slate-object="text" data-key="20302"><span data-slate-leaf="true" data-offset-key="20302:0" data-first-offset="true"><span data-slate-string="true">(devp)==DFCERRSTUS)</span></span></span><span data-slate-object="text" data-key="20303"><span data-slate-leaf="true" data-offset-key="20303:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注意释放资源</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20304"><span data-slate-object="text" data-key="20305"><span data-slate-leaf="true" data-offset-key="20305:0" data-first-offset="true"><span data-slate-string="true">        {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20306"><span data-slate-object="text" data-key="20307"><span data-slate-leaf="true" data-offset-key="20307:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="20308"><span data-slate-leaf="true" data-offset-key="20308:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20309"><span data-slate-leaf="true" data-offset-key="20309:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20310"><span data-slate-object="text" data-key="20311"><span data-slate-leaf="true" data-offset-key="20311:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20312"><span data-slate-object="text" data-key="20313"><span data-slate-leaf="true" data-offset-key="20313:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="20314"><span data-slate-leaf="true" data-offset-key="20314:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20315"><span data-slate-leaf="true" data-offset-key="20315:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20316"><span data-slate-object="text" data-key="20317"><span data-slate-leaf="true" data-offset-key="20317:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20318"><span data-slate-object="text" data-key="20319"><span data-slate-leaf="true" data-offset-key="20319:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20320"><span data-slate-leaf="true" data-offset-key="20320:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 安装中断回调函数 systick_handle</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20321"><span data-slate-object="text" data-key="20322"><span data-slate-leaf="true" data-offset-key="20322:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20323"><span data-slate-leaf="true" data-offset-key="20323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="20324"><span data-slate-leaf="true" data-offset-key="20324:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20325"><span data-slate-leaf="true" data-offset-key="20325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlnew_devhandle</span></span></span></span><span data-slate-object="text" data-key="20326"><span data-slate-leaf="true" data-offset-key="20326:0" data-first-offset="true"><span data-slate-string="true">(devp,systick_handle,</span></span></span><span data-slate-object="text" data-key="20327"><span data-slate-leaf="true" data-offset-key="20327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20</span></span></span></span><span data-slate-object="text" data-key="20328"><span data-slate-leaf="true" data-offset-key="20328:0" data-first-offset="true"><span data-slate-string="true">)==DFCERRSTUS)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20329"><span data-slate-object="text" data-key="20330"><span data-slate-leaf="true" data-offset-key="20330:0" data-first-offset="true"><span data-slate-string="true">    {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20331"><span data-slate-object="text" data-key="20332"><span data-slate-leaf="true" data-offset-key="20332:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="20333"><span data-slate-leaf="true" data-offset-key="20333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20334"><span data-slate-leaf="true" data-offset-key="20334:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;  </span></span></span><span data-slate-object="text" data-key="20335"><span data-slate-leaf="true" data-offset-key="20335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 注意释放资源。</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20336"><span data-slate-object="text" data-key="20337"><span data-slate-leaf="true" data-offset-key="20337:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20338"><span data-slate-object="text" data-key="20339"><span data-slate-leaf="true" data-offset-key="20339:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20340"><span data-slate-leaf="true" data-offset-key="20340:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_8254</span></span></span></span><span data-slate-object="text" data-key="20341"><span data-slate-leaf="true" data-offset-key="20341:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="20342"><span data-slate-leaf="true" data-offset-key="20342:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化物理设备 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20343"><span data-slate-object="text" data-key="20344"><span data-slate-leaf="true" data-offset-key="20344:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20345"><span data-slate-leaf="true" data-offset-key="20345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="20346"><span data-slate-leaf="true" data-offset-key="20346:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20347"><span data-slate-leaf="true" data-offset-key="20347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlenable_intline</span></span></span></span><span data-slate-object="text" data-key="20348"><span data-slate-leaf="true" data-offset-key="20348:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20349"><span data-slate-leaf="true" data-offset-key="20349:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x20</span></span></span></span><span data-slate-object="text" data-key="20350"><span data-slate-leaf="true" data-offset-key="20350:0" data-first-offset="true"><span data-slate-string="true">)==DFCERRSTUS)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20351"><span data-slate-object="text" data-key="20352"><span data-slate-leaf="true" data-offset-key="20352:0" data-first-offset="true"><span data-slate-string="true">    { </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20353"><span data-slate-object="text" data-key="20354"><span data-slate-leaf="true" data-offset-key="20354:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="20355"><span data-slate-leaf="true" data-offset-key="20355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20356"><span data-slate-leaf="true" data-offset-key="20356:0" data-first-offset="true"><span data-slate-string="true"> DFCERRSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20357"><span data-slate-object="text" data-key="20358"><span data-slate-leaf="true" data-offset-key="20358:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20359"><span data-slate-object="text" data-key="20360"><span data-slate-leaf="true" data-offset-key="20360:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20361"><span data-slate-leaf="true" data-offset-key="20361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20362"><span data-slate-leaf="true" data-offset-key="20362:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20363"><span data-slate-object="text" data-key="20364"><span data-slate-leaf="true" data-offset-key="20364:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20365"><span data-slate-object="text" data-key="20366"><span data-slate-leaf="true" data-offset-key="20366:0" data-first-offset="true"><span data-slate-string="true">你可能非常熟悉这部分代码，没错，这正是上节课中，我们的那个驱动程序入口函数的实例。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20367"><span data-slate-object="text" data-key="20368"><span data-slate-leaf="true" data-offset-key="20368:0" data-first-offset="true"><span data-slate-string="true">不过在上节课里，我们主要是要展示一个驱动程序入口函数的流程。这里却是要投入工作的真实设备驱动。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20369"><span data-slate-object="text" data-key="20370"><span data-slate-leaf="true" data-offset-key="20370:0" data-first-offset="true"><span data-slate-string="true">最后的 </span></span></span><span data-slate-object="text" data-key="20371"><span data-slate-leaf="true" data-offset-key="20371:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">krlenable_intline 函数</span></span></span></span><span data-slate-object="text" data-key="20372"><span data-slate-leaf="true" data-offset-key="20372:0" data-first-offset="true"><span data-slate-string="true">，它的主要功能是开启一个中断源上的中断。而 init_8254 函数则是为了初始化 8254，它就是一个古老且常用的定时器。这两个函数非常简单，我已经帮写好了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20373"><span data-slate-object="text" data-key="20374"><span data-slate-leaf="true" data-offset-key="20374:0" data-first-offset="true"><span data-slate-string="true">但是这样还不够，有了驱动程序入口函数，驱动程序并不会自动运行。根据前面我们的设计，需要把这个驱动程序入口函数放入驱动表中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20375"><span data-slate-object="text" data-key="20376"><span data-slate-leaf="true" data-offset-key="20376:0" data-first-offset="true"><span data-slate-string="true">下面我们就把这个 systick_entry 函数，放到驱动表里，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="20377"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="20378"><span data-slate-object="text" data-key="20379"><span data-slate-leaf="true" data-offset-key="20379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//cosmos/kernel/krlglobal.c</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20380"><span data-slate-object="text" data-key="20381"><span data-slate-leaf="true" data-offset-key="20381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KRL_DEFGLOB_VARIABLE</span></span></span></span><span data-slate-object="text" data-key="20382"><span data-slate-leaf="true" data-offset-key="20382:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20383"><span data-slate-leaf="true" data-offset-key="20383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drventyexit_t</span></span></span></span><span data-slate-object="text" data-key="20384"><span data-slate-leaf="true" data-offset-key="20384:0" data-first-offset="true"><span data-slate-string="true">,osdrvetytabl)[]={systick_entry,</span></span></span><span data-slate-object="text" data-key="20385"><span data-slate-leaf="true" data-offset-key="20385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NULL</span></span></span></span><span data-slate-object="text" data-key="20386"><span data-slate-leaf="true" data-offset-key="20386:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20387"><span data-slate-object="text" data-key="20388"><span data-slate-leaf="true" data-offset-key="20388:0" data-first-offset="true"><span data-slate-string="true">有了刚才这步操作之后，Cosmos 在启动的时候，就会执行初始驱动初始化 init_krldriver 函数，接着这个函数就会启动运行 systick 设备驱动程序入口函数。我们的 systick_entry 函数一旦执行，就会建立 systick 设备，不断的产生时钟中断。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="20389" id="sr-toc-7"><span data-slate-object="text" data-key="20390"><span data-slate-leaf="true" data-offset-key="20390:0" data-first-offset="true"><span data-slate-string="true">配置设备和驱动</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="20391"><span data-slate-object="text" data-key="20392"><span data-slate-leaf="true" data-offset-key="20392:0" data-first-offset="true"><span data-slate-string="true">在驱动程序入口函数中，除了那些标准的流程之外，我们还要对设备和驱动进行适当的配置，就是设置一些标志、状态、名称、驱动功能派发函数等等。有了这些信息，设备才能加入到驱动程序中，然后注册到内核，这样才能被内核所识别。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20393"><span data-slate-object="text" data-key="20394"><span data-slate-leaf="true" data-offset-key="20394:0" data-first-offset="true"><span data-slate-string="true">好，让我们先来实现设置驱动程序的函数，它主要设置设备驱动程序的名称、功能派发函数，代码如下。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="20395"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="20396"><span data-slate-object="text" data-key="20397"><span data-slate-leaf="true" data-offset-key="20397:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="20398"><span data-slate-leaf="true" data-offset-key="20398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_set_driver</span></span></span></span><span data-slate-object="text" data-key="20399"><span data-slate-leaf="true" data-offset-key="20399:0" data-first-offset="true"><span data-slate-string="true">(driver_t *drvp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20400"><span data-slate-object="text" data-key="20401"><span data-slate-leaf="true" data-offset-key="20401:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20402"><span data-slate-object="text" data-key="20403"><span data-slate-leaf="true" data-offset-key="20403:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20404"><span data-slate-leaf="true" data-offset-key="20404:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置驱动程序功能派发函数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20405"><span data-slate-object="text" data-key="20406"><span data-slate-leaf="true" data-offset-key="20406:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20407"><span data-slate-leaf="true" data-offset-key="20407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20408"><span data-slate-leaf="true" data-offset-key="20408:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_OPEN] = systick_open;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20409"><span data-slate-object="text" data-key="20410"><span data-slate-leaf="true" data-offset-key="20410:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20411"><span data-slate-leaf="true" data-offset-key="20411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20412"><span data-slate-leaf="true" data-offset-key="20412:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_CLOSE] = systick_close;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20413"><span data-slate-object="text" data-key="20414"><span data-slate-leaf="true" data-offset-key="20414:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20415"><span data-slate-leaf="true" data-offset-key="20415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20416"><span data-slate-leaf="true" data-offset-key="20416:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_READ] = systick_read;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20417"><span data-slate-object="text" data-key="20418"><span data-slate-leaf="true" data-offset-key="20418:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20419"><span data-slate-leaf="true" data-offset-key="20419:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20420"><span data-slate-leaf="true" data-offset-key="20420:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_WRITE] = systick_write;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20421"><span data-slate-object="text" data-key="20422"><span data-slate-leaf="true" data-offset-key="20422:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20423"><span data-slate-leaf="true" data-offset-key="20423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20424"><span data-slate-leaf="true" data-offset-key="20424:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_LSEEK] = systick_lseek;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20425"><span data-slate-object="text" data-key="20426"><span data-slate-leaf="true" data-offset-key="20426:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20427"><span data-slate-leaf="true" data-offset-key="20427:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20428"><span data-slate-leaf="true" data-offset-key="20428:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_IOCTRL] = systick_ioctrl;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20429"><span data-slate-object="text" data-key="20430"><span data-slate-leaf="true" data-offset-key="20430:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20431"><span data-slate-leaf="true" data-offset-key="20431:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20432"><span data-slate-leaf="true" data-offset-key="20432:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_DEV_START] = systick_dev_start;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20433"><span data-slate-object="text" data-key="20434"><span data-slate-leaf="true" data-offset-key="20434:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20435"><span data-slate-leaf="true" data-offset-key="20435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20436"><span data-slate-leaf="true" data-offset-key="20436:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_DEV_STOP] = systick_dev_stop;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20437"><span data-slate-object="text" data-key="20438"><span data-slate-leaf="true" data-offset-key="20438:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20439"><span data-slate-leaf="true" data-offset-key="20439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20440"><span data-slate-leaf="true" data-offset-key="20440:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_SET_POWERSTUS] = systick_set_powerstus;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20441"><span data-slate-object="text" data-key="20442"><span data-slate-leaf="true" data-offset-key="20442:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20443"><span data-slate-leaf="true" data-offset-key="20443:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20444"><span data-slate-leaf="true" data-offset-key="20444:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_ENUM_DEV] = systick_enum_dev;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20445"><span data-slate-object="text" data-key="20446"><span data-slate-leaf="true" data-offset-key="20446:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20447"><span data-slate-leaf="true" data-offset-key="20447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20448"><span data-slate-leaf="true" data-offset-key="20448:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_FLUSH] = systick_flush;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20449"><span data-slate-object="text" data-key="20450"><span data-slate-leaf="true" data-offset-key="20450:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20451"><span data-slate-leaf="true" data-offset-key="20451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20452"><span data-slate-leaf="true" data-offset-key="20452:0" data-first-offset="true"><span data-slate-string="true">drv_dipfun[IOIF_CODE_SHUTDOWN] = systick_shutdown;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20453"><span data-slate-object="text" data-key="20454"><span data-slate-leaf="true" data-offset-key="20454:0" data-first-offset="true"><span data-slate-string="true">    drvp</span></span></span><span data-slate-object="text" data-key="20455"><span data-slate-leaf="true" data-offset-key="20455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20456"><span data-slate-leaf="true" data-offset-key="20456:0" data-first-offset="true"><span data-slate-string="true">drv_name = </span></span></span><span data-slate-object="text" data-key="20457"><span data-slate-leaf="true" data-offset-key="20457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"systick0drv"</span></span></span></span><span data-slate-object="text" data-key="20458"><span data-slate-leaf="true" data-offset-key="20458:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span><span data-slate-object="text" data-key="20459"><span data-slate-leaf="true" data-offset-key="20459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置驱动程序名称</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20460"><span data-slate-object="text" data-key="20461"><span data-slate-leaf="true" data-offset-key="20461:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20462"><span data-slate-leaf="true" data-offset-key="20462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20463"><span data-slate-leaf="true" data-offset-key="20463:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20464"><span data-slate-object="text" data-key="20465"><span data-slate-leaf="true" data-offset-key="20465:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20466"><span data-slate-object="text" data-key="20467"><span data-slate-leaf="true" data-offset-key="20467:0" data-first-offset="true"><span data-slate-string="true">上述代码的功能并不复杂，我一说你就能领会。systick_set_driver 函数，无非就是将 12 个驱动功能函数的地址，分别设置到 driver_t 结构的 drv_dipfun 数组中。其中，驱动功能函数在该数组中的元素位置，正好与 IO 操作码一一对应，当内核用 IO 操作码调用驱动时，就是调用了这个数据中的函数。最后，我们将驱动程序的名称设置为 systick0drv。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20468"><span data-slate-object="text" data-key="20469"><span data-slate-leaf="true" data-offset-key="20469:0" data-first-offset="true"><span data-slate-string="true">新建的设备也需要配置相关的信息才能工作，比如需要指定设备，设备状态与标志，设备类型、设备名称这些信息。尤其要注意的是，设备类型非常重要，内核正是通过类型来区分各种设备的，下面我们写个函数，完成这些功能，代码如下所示。</span></span></span></div><div data-code-language="rust" data-slate-type="pre" data-slate-object="block" data-key="20470"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="20471"><span data-slate-object="text" data-key="20472"><span data-slate-leaf="true" data-offset-key="20472:0" data-first-offset="true"><span data-slate-string="true">void </span></span></span><span data-slate-object="text" data-key="20473"><span data-slate-leaf="true" data-offset-key="20473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_set_device</span></span></span></span><span data-slate-object="text" data-key="20474"><span data-slate-leaf="true" data-offset-key="20474:0" data-first-offset="true"><span data-slate-string="true">(device_t *devp, driver_t *drvp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20475"><span data-slate-object="text" data-key="20476"><span data-slate-leaf="true" data-offset-key="20476:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20477"><span data-slate-object="text" data-key="20478"><span data-slate-leaf="true" data-offset-key="20478:0" data-first-offset="true"><span data-slate-string="true">    devp</span></span></span><span data-slate-object="text" data-key="20479"><span data-slate-leaf="true" data-offset-key="20479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20480"><span data-slate-leaf="true" data-offset-key="20480:0" data-first-offset="true"><span data-slate-string="true">dev_flgs = DEVFLG_SHARE;</span></span></span><span data-slate-object="text" data-key="20481"><span data-slate-leaf="true" data-offset-key="20481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备可共享访问</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20482"><span data-slate-object="text" data-key="20483"><span data-slate-leaf="true" data-offset-key="20483:0" data-first-offset="true"><span data-slate-string="true">    devp</span></span></span><span data-slate-object="text" data-key="20484"><span data-slate-leaf="true" data-offset-key="20484:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20485"><span data-slate-leaf="true" data-offset-key="20485:0" data-first-offset="true"><span data-slate-string="true">dev_stus = DEVSTS_NORML;</span></span></span><span data-slate-object="text" data-key="20486"><span data-slate-leaf="true" data-offset-key="20486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备正常状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20487"><span data-slate-object="text" data-key="20488"><span data-slate-leaf="true" data-offset-key="20488:0" data-first-offset="true"><span data-slate-string="true">    devp</span></span></span><span data-slate-object="text" data-key="20489"><span data-slate-leaf="true" data-offset-key="20489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20490"><span data-slate-leaf="true" data-offset-key="20490:0" data-first-offset="true"><span data-slate-string="true">dev_id.dev_mtype = SYSTICK_DEVICE;</span></span></span><span data-slate-object="text" data-key="20491"><span data-slate-leaf="true" data-offset-key="20491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备主类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20492"><span data-slate-object="text" data-key="20493"><span data-slate-leaf="true" data-offset-key="20493:0" data-first-offset="true"><span data-slate-string="true">    devp</span></span></span><span data-slate-object="text" data-key="20494"><span data-slate-leaf="true" data-offset-key="20494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20495"><span data-slate-leaf="true" data-offset-key="20495:0" data-first-offset="true"><span data-slate-string="true">dev_id.dev_stype = </span></span></span><span data-slate-object="text" data-key="20496"><span data-slate-leaf="true" data-offset-key="20496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="20497"><span data-slate-leaf="true" data-offset-key="20497:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span><span data-slate-object="text" data-key="20498"><span data-slate-leaf="true" data-offset-key="20498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备子类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20499"><span data-slate-object="text" data-key="20500"><span data-slate-leaf="true" data-offset-key="20500:0" data-first-offset="true"><span data-slate-string="true">    devp</span></span></span><span data-slate-object="text" data-key="20501"><span data-slate-leaf="true" data-offset-key="20501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20502"><span data-slate-leaf="true" data-offset-key="20502:0" data-first-offset="true"><span data-slate-string="true">dev_id.dev_nr = </span></span></span><span data-slate-object="text" data-key="20503"><span data-slate-leaf="true" data-offset-key="20503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="20504"><span data-slate-leaf="true" data-offset-key="20504:0" data-first-offset="true"><span data-slate-string="true">; </span></span></span><span data-slate-object="text" data-key="20505"><span data-slate-leaf="true" data-offset-key="20505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设备号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20506"><span data-slate-object="text" data-key="20507"><span data-slate-leaf="true" data-offset-key="20507:0" data-first-offset="true"><span data-slate-string="true">    devp</span></span></span><span data-slate-object="text" data-key="20508"><span data-slate-leaf="true" data-offset-key="20508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">-&gt;</span></span></span></span><span data-slate-object="text" data-key="20509"><span data-slate-leaf="true" data-offset-key="20509:0" data-first-offset="true"><span data-slate-string="true">dev_name = </span></span></span><span data-slate-object="text" data-key="20510"><span data-slate-leaf="true" data-offset-key="20510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"systick0"</span></span></span></span><span data-slate-object="text" data-key="20511"><span data-slate-leaf="true" data-offset-key="20511:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span><span data-slate-object="text" data-key="20512"><span data-slate-leaf="true" data-offset-key="20512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置设备名称</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20513"><span data-slate-object="text" data-key="20514"><span data-slate-leaf="true" data-offset-key="20514:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20515"><span data-slate-leaf="true" data-offset-key="20515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20516"><span data-slate-leaf="true" data-offset-key="20516:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20517"><span data-slate-object="text" data-key="20518"><span data-slate-leaf="true" data-offset-key="20518:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20519"><span data-slate-object="text" data-key="20520"><span data-slate-leaf="true" data-offset-key="20520:0" data-first-offset="true"><span data-slate-string="true">上述代码中，systick_set_device 函数需要两个参数，但是第二个参数暂时没起作用，而第一个参数其实是一个 device_t 结构的指针，在 systick_entry 函数中调用 new_device_dsc 函数的时候，就会返回这个指针。后面我们会把设备加载到内核中，那时这个指针指向的设备才会被注册。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="20521" id="sr-toc-8"><span data-slate-object="text" data-key="20522"><span data-slate-leaf="true" data-offset-key="20522:0" data-first-offset="true"><span data-slate-string="true">打开与关闭设备</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="20523"><span data-slate-object="text" data-key="20524"><span data-slate-leaf="true" data-offset-key="20524:0" data-first-offset="true"><span data-slate-string="true">其实对于 systick 这样设备，主要功能是定时中断，还不能支持读、写、控制、刷新、电源相关的功能，就算内核对 systick 设备发起了这样的 I/O 包，systick 设备驱动程序相关的功能函数也只能返回一个错误码，表示不支持这样的功能请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20525"><span data-slate-object="text" data-key="20526"><span data-slate-leaf="true" data-offset-key="20526:0" data-first-offset="true"><span data-slate-string="true">但是，打开与关闭设备这样的功能还是应该要实现。下面我们就来实现这两个功能请求函数，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="20527"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="20528"><span data-slate-object="text" data-key="20529"><span data-slate-leaf="true" data-offset-key="20529:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 打开设备</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20530"><span data-slate-object="text" data-key="20531"><span data-slate-leaf="true" data-offset-key="20531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20532"><span data-slate-leaf="true" data-offset-key="20532:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20533"><span data-slate-leaf="true" data-offset-key="20533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_open</span></span></span></span></span><span data-slate-object="text" data-key="20534"><span data-slate-leaf="true" data-offset-key="20534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20535"><span data-slate-leaf="true" data-offset-key="20535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20536"><span data-slate-leaf="true" data-offset-key="20536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20537"><span data-slate-leaf="true" data-offset-key="20537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20538"><span data-slate-leaf="true" data-offset-key="20538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20539"><span data-slate-object="text" data-key="20540"><span data-slate-leaf="true" data-offset-key="20540:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20541"><span data-slate-object="text" data-key="20542"><span data-slate-leaf="true" data-offset-key="20542:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20543"><span data-slate-leaf="true" data-offset-key="20543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldev_inc_devcount</span></span></span></span><span data-slate-object="text" data-key="20544"><span data-slate-leaf="true" data-offset-key="20544:0" data-first-offset="true"><span data-slate-string="true">(devp);</span></span></span><span data-slate-object="text" data-key="20545"><span data-slate-leaf="true" data-offset-key="20545:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 增加设备计数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20546"><span data-slate-object="text" data-key="20547"><span data-slate-leaf="true" data-offset-key="20547:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20548"><span data-slate-leaf="true" data-offset-key="20548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20549"><span data-slate-leaf="true" data-offset-key="20549:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span><span data-slate-object="text" data-key="20550"><span data-slate-leaf="true" data-offset-key="20550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回成功完成的状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20551"><span data-slate-object="text" data-key="20552"><span data-slate-leaf="true" data-offset-key="20552:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20553"><span data-slate-object="text" data-key="20554"><span data-slate-leaf="true" data-offset-key="20554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭设备</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20555"><span data-slate-object="text" data-key="20556"><span data-slate-leaf="true" data-offset-key="20556:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20557"><span data-slate-leaf="true" data-offset-key="20557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20558"><span data-slate-leaf="true" data-offset-key="20558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_close</span></span></span></span></span><span data-slate-object="text" data-key="20559"><span data-slate-leaf="true" data-offset-key="20559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20560"><span data-slate-leaf="true" data-offset-key="20560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20561"><span data-slate-leaf="true" data-offset-key="20561:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20562"><span data-slate-leaf="true" data-offset-key="20562:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20563"><span data-slate-leaf="true" data-offset-key="20563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *iopack)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20564"><span data-slate-object="text" data-key="20565"><span data-slate-leaf="true" data-offset-key="20565:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20566"><span data-slate-object="text" data-key="20567"><span data-slate-leaf="true" data-offset-key="20567:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20568"><span data-slate-leaf="true" data-offset-key="20568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krldev_dec_devcount</span></span></span></span><span data-slate-object="text" data-key="20569"><span data-slate-leaf="true" data-offset-key="20569:0" data-first-offset="true"><span data-slate-string="true">(devp);</span></span></span><span data-slate-object="text" data-key="20570"><span data-slate-leaf="true" data-offset-key="20570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 减少设备计数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20571"><span data-slate-object="text" data-key="20572"><span data-slate-leaf="true" data-offset-key="20572:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20573"><span data-slate-leaf="true" data-offset-key="20573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20574"><span data-slate-leaf="true" data-offset-key="20574:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span><span data-slate-object="text" data-key="20575"><span data-slate-leaf="true" data-offset-key="20575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回成功完成的状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20576"><span data-slate-object="text" data-key="20577"><span data-slate-leaf="true" data-offset-key="20577:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20578"><span data-slate-object="text" data-key="20579"><span data-slate-leaf="true" data-offset-key="20579:0" data-first-offset="true"><span data-slate-string="true">这样，打开与关闭设备的功能就实现了，只是简单地增加与减少设备的引用计数，然后返回成功完成的状态就行了。而增加与减少设备的引用计数，是为了统计有多少个进程打开了这个设备，当设备引用计数为 0 时，就说明没有进程使用该设备。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="20580" id="sr-toc-9"><span data-slate-object="text" data-key="20581"><span data-slate-leaf="true" data-offset-key="20581:0" data-first-offset="true"><span data-slate-string="true">systick 设备中断回调函数</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="20582"><span data-slate-object="text" data-key="20583"><span data-slate-leaf="true" data-offset-key="20583:0" data-first-offset="true"><span data-slate-string="true">对于 systick 设备来说，重要的并不是打开、关闭，读写等操作，而是 systick 设备产生的中断，以及在中断回调函数中执行的操作，即周期性的执行系统中的某些动作，比如更新系统时间，比如控制一个进程占用 CPU 的运行时间等，这些操作都需要在 systick 设备中断回调函数中执行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20584"><span data-slate-object="text" data-key="20585"><span data-slate-leaf="true" data-offset-key="20585:0" data-first-offset="true"><span data-slate-string="true">按照前面的设计，systick 设备每秒钟产生 1000 次中断，那么 1 秒钟就会调用 1000 次这个中断回调函数，这里我们只要写出这个函数就行了，因为安装中断回调函数的思路，我们在前面的课程中已经说过了（可以回顾上节课），现在我们直接实现这个中断函数，代码可以像后面这样写。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="20586"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="20587"><span data-slate-object="text" data-key="20588"><span data-slate-leaf="true" data-offset-key="20588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20589"><span data-slate-leaf="true" data-offset-key="20589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20590"><span data-slate-leaf="true" data-offset-key="20590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_handle</span></span></span></span></span><span data-slate-object="text" data-key="20591"><span data-slate-leaf="true" data-offset-key="20591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20592"><span data-slate-leaf="true" data-offset-key="20592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20593"><span data-slate-leaf="true" data-offset-key="20593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ift_nr, </span></span></span></span></span><span data-slate-object="text" data-key="20594"><span data-slate-leaf="true" data-offset-key="20594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20595"><span data-slate-leaf="true" data-offset-key="20595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20596"><span data-slate-leaf="true" data-offset-key="20596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20597"><span data-slate-leaf="true" data-offset-key="20597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *sframe)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20598"><span data-slate-object="text" data-key="20599"><span data-slate-leaf="true" data-offset-key="20599:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20600"><span data-slate-object="text" data-key="20601"><span data-slate-leaf="true" data-offset-key="20601:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20602"><span data-slate-leaf="true" data-offset-key="20602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">kprint</span></span></span></span><span data-slate-object="text" data-key="20603"><span data-slate-leaf="true" data-offset-key="20603:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20604"><span data-slate-leaf="true" data-offset-key="20604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"systick_handle run devname:%s intptnr:%d\n"</span></span></span></span><span data-slate-object="text" data-key="20605"><span data-slate-leaf="true" data-offset-key="20605:0" data-first-offset="true"><span data-slate-string="true">, ((</span></span></span><span data-slate-object="text" data-key="20606"><span data-slate-leaf="true" data-offset-key="20606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">device_t</span></span></span></span><span data-slate-object="text" data-key="20607"><span data-slate-leaf="true" data-offset-key="20607:0" data-first-offset="true"><span data-slate-string="true"> *)devp)-&gt;dev_name, ift_nr);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20608"><span data-slate-object="text" data-key="20609"><span data-slate-leaf="true" data-offset-key="20609:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20610"><span data-slate-leaf="true" data-offset-key="20610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20611"><span data-slate-leaf="true" data-offset-key="20611:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20612"><span data-slate-object="text" data-key="20613"><span data-slate-leaf="true" data-offset-key="20613:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20614"><span data-slate-object="text" data-key="20615"><span data-slate-leaf="true" data-offset-key="20615:0" data-first-offset="true"><span data-slate-string="true">这个中断回调函数，暂时什么也没干，就输出一条信息，让我们知道它运行了，为了直观观察它运行了，我们要对内核层初始化函数修改一下，禁止进程运行，以免进程输出的信息打扰我们观察结果，修改的代码如下所示。</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="20616"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="20617"><span data-slate-object="text" data-key="20618"><span data-slate-leaf="true" data-offset-key="20618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="20619"><span data-slate-leaf="true" data-offset-key="20619:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="20620"><span data-slate-leaf="true" data-offset-key="20620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krl</span></span></span></span><span data-slate-object="text" data-key="20621"><span data-slate-leaf="true" data-offset-key="20621:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20622"><span data-slate-leaf="true" data-offset-key="20622:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20623"><span data-slate-object="text" data-key="20624"><span data-slate-leaf="true" data-offset-key="20624:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20625"><span data-slate-object="text" data-key="20626"><span data-slate-leaf="true" data-offset-key="20626:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20627"><span data-slate-leaf="true" data-offset-key="20627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlmm</span></span></span></span><span data-slate-object="text" data-key="20628"><span data-slate-leaf="true" data-offset-key="20628:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20629"><span data-slate-object="text" data-key="20630"><span data-slate-leaf="true" data-offset-key="20630:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20631"><span data-slate-leaf="true" data-offset-key="20631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krldevice</span></span></span></span><span data-slate-object="text" data-key="20632"><span data-slate-leaf="true" data-offset-key="20632:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="20633"><span data-slate-leaf="true" data-offset-key="20633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化设备</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20634"><span data-slate-object="text" data-key="20635"><span data-slate-leaf="true" data-offset-key="20635:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20636"><span data-slate-leaf="true" data-offset-key="20636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krldriver</span></span></span></span><span data-slate-object="text" data-key="20637"><span data-slate-leaf="true" data-offset-key="20637:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="20638"><span data-slate-leaf="true" data-offset-key="20638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化驱动程序</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20639"><span data-slate-object="text" data-key="20640"><span data-slate-leaf="true" data-offset-key="20640:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20641"><span data-slate-leaf="true" data-offset-key="20641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">init_krlsched</span></span></span></span><span data-slate-object="text" data-key="20642"><span data-slate-leaf="true" data-offset-key="20642:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20643"><span data-slate-object="text" data-key="20644"><span data-slate-leaf="true" data-offset-key="20644:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20645"><span data-slate-leaf="true" data-offset-key="20645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//init_krlcpuidle (); 禁止进程运行</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20646"><span data-slate-object="text" data-key="20647"><span data-slate-leaf="true" data-offset-key="20647:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20648"><span data-slate-leaf="true" data-offset-key="20648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">STI</span></span></span></span><span data-slate-object="text" data-key="20649"><span data-slate-leaf="true" data-offset-key="20649:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="20650"><span data-slate-leaf="true" data-offset-key="20650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 打开 CPU 响应中断的能力</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20651"><span data-slate-object="text" data-key="20652"><span data-slate-leaf="true" data-offset-key="20652:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20653"><span data-slate-leaf="true" data-offset-key="20653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">die</span></span></span></span><span data-slate-object="text" data-key="20654"><span data-slate-leaf="true" data-offset-key="20654:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20655"><span data-slate-leaf="true" data-offset-key="20655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="20656"><span data-slate-leaf="true" data-offset-key="20656:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span><span data-slate-object="text" data-key="20657"><span data-slate-leaf="true" data-offset-key="20657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进入死循环</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20658"><span data-slate-object="text" data-key="20659"><span data-slate-leaf="true" data-offset-key="20659:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20660"><span data-slate-leaf="true" data-offset-key="20660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20661"><span data-slate-leaf="true" data-offset-key="20661:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20662"><span data-slate-object="text" data-key="20663"><span data-slate-leaf="true" data-offset-key="20663:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20664"><span data-slate-object="text" data-key="20665"><span data-slate-leaf="true" data-offset-key="20665:0" data-first-offset="true"><span data-slate-string="true">下面，我们打开终端切到 Cosmos 目录下，执行 make vboxtest 指令，如果不出意外，我们将会中看到如下界面。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="20666"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/84/e9/84c7837a89eb56b2863c8b30eb1217e9.jpg?wh=1044x921"></div><div>测试中断回调函数</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20667"><span data-slate-object="text" data-key="20668"><span data-slate-leaf="true" data-offset-key="20668:0" data-first-offset="true"><span data-slate-string="true">上图中的信息，会不断地滚动出现，信息中包含设备名称和中断号，这标志着我们中断回调函数的运行正确无误。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20669"><span data-slate-object="text" data-key="20670"><span data-slate-leaf="true" data-offset-key="20670:0" data-first-offset="true"><span data-slate-string="true">当然，如果我们费了这么功夫搞了中断回调函数，就只是为了输出信息，那也太不划算了，我们当然有更重要的事情要做，你还记得之前讲过的进程知识吗？这里我再帮你理一理思路。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20671"><span data-slate-object="text" data-key="20672"><span data-slate-leaf="true" data-offset-key="20672:0" data-first-offset="true"><span data-slate-string="true">我们在每个进程中都要主动调用进程调度器函数，否则进程就会永远霸占 CPU，永远运行下去。这是因为，我们没有定时器可以周期性地检查进程运行了多长时间，如果进程的运行时间超过了，就应该强制调度，让别的进程开始运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20673"><span data-slate-object="text" data-key="20674"><span data-slate-leaf="true" data-offset-key="20674:0" data-first-offset="true"><span data-slate-string="true">更新进程运行时间的代码，我已经帮你写好了，你只需要在这个中断回调函数中调用就好了，代码如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="20675"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="20676"><span data-slate-object="text" data-key="20677"><span data-slate-leaf="true" data-offset-key="20677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">drvstus_t</span></span></span></span></span><span data-slate-object="text" data-key="20678"><span data-slate-leaf="true" data-offset-key="20678:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="20679"><span data-slate-leaf="true" data-offset-key="20679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">systick_handle</span></span></span></span></span><span data-slate-object="text" data-key="20680"><span data-slate-leaf="true" data-offset-key="20680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="20681"><span data-slate-leaf="true" data-offset-key="20681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint_t</span></span></span></span></span></span><span data-slate-object="text" data-key="20682"><span data-slate-leaf="true" data-offset-key="20682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> ift_nr, </span></span></span></span></span><span data-slate-object="text" data-key="20683"><span data-slate-leaf="true" data-offset-key="20683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20684"><span data-slate-leaf="true" data-offset-key="20684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *devp, </span></span></span></span></span><span data-slate-object="text" data-key="20685"><span data-slate-leaf="true" data-offset-key="20685:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="20686"><span data-slate-leaf="true" data-offset-key="20686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *sframe)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20687"><span data-slate-object="text" data-key="20688"><span data-slate-leaf="true" data-offset-key="20688:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20689"><span data-slate-object="text" data-key="20690"><span data-slate-leaf="true" data-offset-key="20690:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20691"><span data-slate-leaf="true" data-offset-key="20691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlthd_inc_tick</span></span></span></span><span data-slate-object="text" data-key="20692"><span data-slate-leaf="true" data-offset-key="20692:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="20693"><span data-slate-leaf="true" data-offset-key="20693:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">krlsched_retn_currthread</span></span></span></span><span data-slate-object="text" data-key="20694"><span data-slate-leaf="true" data-offset-key="20694:0" data-first-offset="true"><span data-slate-string="true">());</span></span></span><span data-slate-object="text" data-key="20695"><span data-slate-leaf="true" data-offset-key="20695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新当前进程的 tick</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20696"><span data-slate-object="text" data-key="20697"><span data-slate-leaf="true" data-offset-key="20697:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="20698"><span data-slate-leaf="true" data-offset-key="20698:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="20699"><span data-slate-leaf="true" data-offset-key="20699:0" data-first-offset="true"><span data-slate-string="true"> DFCOKSTUS;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20700"><span data-slate-object="text" data-key="20701"><span data-slate-leaf="true" data-offset-key="20701:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20702"><span data-slate-object="text" data-key="20703"><span data-slate-leaf="true" data-offset-key="20703:0" data-first-offset="true"><span data-slate-string="true">这里的 krlthd_inc_tick 函数需要一个进程指针的参数，而 krlsched_retn_currthread 函数是返回当前正在运行进程的指针。在 krlthd_inc_tick 函数中对进程的 tick 值加 1，如果大于 20（也就是 20 毫秒）就重新置 0，并进行调度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20704"><span data-slate-object="text" data-key="20705"><span data-slate-leaf="true" data-offset-key="20705:0" data-first-offset="true"><span data-slate-string="true">下面，我们把内核层初始化函数恢复到原样，重新打开终端切到 cosmos 目录下，执行 make vboxtest 指令，我们就将会看到如下界面。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="20706"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/75/47/75647910ba0529e6c80ba127bbe9c247.jpg?wh=1044x921"></div><div>测试进程运行时间更新</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20707"><span data-slate-object="text" data-key="20708"><span data-slate-leaf="true" data-offset-key="20708:0" data-first-offset="true"><span data-slate-string="true">我们可以看到，进程 A、进程 B，还有调度器交替输出的信息。这已经证明我们更新进程运行时间，检查其时间是否用完并进行调度的代码逻辑，都是完全正确的，恭喜你走到了这一步！</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20709"><span data-slate-object="text" data-key="20710"><span data-slate-leaf="true" data-offset-key="20710:0" data-first-offset="true"><span data-slate-string="true">至此，我们的 systick 驱动程序就实现了，它非常简单，但却包含了一个驱动程序完整实现。同时，这个过程也一步步验证了我们对驱动模型的设计是正确的。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="20711" id="sr-toc-10"><span data-slate-object="text" data-key="20712"><span data-slate-leaf="true" data-offset-key="20712:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="20713"><span data-slate-object="text" data-key="20714"><span data-slate-leaf="true" data-offset-key="20714:0" data-first-offset="true"><span data-slate-string="true">又到课程的结尾，到此为止，我们了解了实现一个驱动程序完整过程，虽然我们只是驱动了一个定时器设备，使之周期性的产生定时中断。在定时器设备的中断回调函数中，我们调用了更新进程时间的函数，达到了这样的目的：在进程运行超时的情况下，内核有能力夺回 CPU，调度别的进程运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20715"><span data-slate-object="text" data-key="20716"><span data-slate-leaf="true" data-offset-key="20716:0" data-first-offset="true"><span data-slate-string="true">现在我来为你梳理一下重点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20717"><span data-slate-object="text" data-key="20718"><span data-slate-leaf="true" data-offset-key="20718:0" data-first-offset="true"><span data-slate-string="true">1. 为了搞清楚设备如何处理 I/O 包，我们了解了什么是 I/O 包，写好了处理建立、删除 I/O 包的代码。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20719"><span data-slate-object="text" data-key="20720"><span data-slate-leaf="true" data-offset-key="20720:0" data-first-offset="true"><span data-slate-string="true">2. 要使设备完成相应的功能，内核就必须向设备驱动发送相应的 I/O 包，在 I/O 包提供相应 IO 操作码和适当的参数。所以，我们动手实现了向设备发送 I/O 包并调用设备驱动程序的机制。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20721"><span data-slate-object="text" data-key="20722"><span data-slate-leaf="true" data-offset-key="20722:0" data-first-offset="true"><span data-slate-string="true">3. 一切准备就绪之后，我们建立了 systick 驱动程序实例，这是一个完整的驱动程序，它支持打开关闭和周期性产生中断的功能请求。通过这个实例，让我们了解了一个真实设备驱动的实现以及它处理内核 I/O 包的过程。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20723"><span data-slate-object="text" data-key="20724"><span data-slate-leaf="true" data-offset-key="20724:0" data-first-offset="true"><span data-slate-string="true">你可能对这样简单的驱动程序不够满意，也不能肯定我们的驱动模型是不是能适应大多数场景，请不要着急，在后面讲到文件系统时，我们会实现一个更为复杂的驱动程序。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="20725" id="sr-toc-11"><span data-slate-object="text" data-key="20726"><span data-slate-leaf="true" data-offset-key="20726:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="20727"><span data-slate-object="text" data-key="20728"><span data-slate-leaf="true" data-offset-key="20728:0" data-first-offset="true"><span data-slate-string="true">请你想一想，为什么没有 systick 设备这样周期性的产生中断，进程就有可能霸占 CPU 呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20729"><span data-slate-object="text" data-key="20730"><span data-slate-leaf="true" data-offset-key="20730:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区跟我交流互动，也欢迎你把这节课分享给身边的同事、朋友，一起实践驱动程序的实例。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="20731"><span data-slate-object="text" data-key="20732"><span data-slate-leaf="true" data-offset-key="20732:0" data-first-offset="true"><span data-slate-string="true">好，我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-12">精选留言 (8)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ec/13/49e98289.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>neohope</span></div><span>置顶</span></div><div>一、数据结构
objnode_t 表示一个 IO 包，包括了各种操作所需的各种参数

二、 向设备发送 I/O 包
krldev_io-&gt;krldev_call_driver-&gt; 通过函数指针，调用设备驱动指定功能编号的功能函数
所有驱动功能函数，都会传入 objnode_t 参数

三、 8254 初始化
在上一节中，完成了 8254 设备的初始化及驱动的初始化，并启用了 8254 硬件中断
其中，在初始化驱动时：
systick_entry-&gt;krlnew_devhandle-&gt;krladd_irqhandle-&gt;hal_add_ihandle
将 intserdsc_t 结构【包括驱动回调函数】，挂载到了 intfltdsc_t.i_serlist 中

四、8254 中断调用链
1、8254 产生硬件中断
2、CPU 收到中断，通过中断处理表 IDT，找到中断门，通过门检查后，会找到中断处理入口，然后找到硬件中断分发函数 hal_hwint_allocator
【第一个参数为中断编号，在 rdi；第二个参数为中断发生时的栈指针，在 rsi】
调用硬件中断处理函数 hal_do_hwint
3、hal_do_hwint
如有必要，结束硬件中断
调用中断回调函数 hal_do_hwint-&gt;hal_run_intflthandle
4、hal_run_intflthandle
先获取 intfltdsc_t 中断异常表
然后调用 intfltdsc_t 中，i_serlist 上所有挂载 intserdsc_t 结构中的中断处理的回调函数 s_handle
5、8254 回调函数为 systick_handle
6、systick_handle
更新进程的 tick，如果超出 20 毫秒，让出 CPU 使用权限，进行进程调度
</div><div><p>作者回复：对的，老哥总结到位</p></div><div><div>2021-07-21</div><div><div><i></i></div><div><i></i><span>7</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>springXu</span></div></div><div>因为内核的调度器也要被激活。如果没定时器中断，调度器的激活貌似只能靠其他中断，比如用户结束进程，或者进程抢占了其他被锁资源，才能激活进程调度器。</div><div><p>作者回复：正确 正确 </p></div><div><div>2021-07-16</div><div><div><i></i></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/f8/2c/92969c48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 青玉白露</span></div></div><div>因为进程根本不知道自己执行了多久的 CPU，所以需要时钟来提醒他，并且在超时的时候强制进行进程调度。</div><div><p>作者回复：是的 是的</p></div><div><div>2021-08-27</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/21/7e/fb725950.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 罗 乾 林</span></div></div><div>进程调度发生在用户态和内核态切换，如果一个应用程序只在用户态做计算不进行系统调用，系统将没有机会完成进程调度。定时器的出现就能打破这一问题，使系统进入中断处理程序，进而完成进程调度</div><div><p>作者回复：正确 老铁</p></div><div><div>2021-07-16</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/23/66/413c0bb5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>LDxy</span></div></div><div> I/O 包这个概念第一次听说</div><div><p>作者回复：我搞 很多 新名词概念 哈哈</p></div><div><div>2021-07-16</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2d/06/30/c26ea06a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 艾恩凝</span></div></div><div>打卡，看简单，调程序 又花了点时间</div><div><p>作者回复：哈哈 </p></div><div><div>2022-05-08</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/10/49/01657245.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Entropy</span></div></div><div>如果产生时钟中断，那么此时 cpu 不是要切换上下文来执行中断回调函数 systick_handle 吗？ 如果是，那么调用 krlsched_retn_currthread () 是不是返回的是中断处理函数所在的进程，所以之前被切换的进程计时不会加 1？</div><div><p>作者回复：只有进程上下文</p></div><div><div>2021-08-25</div><div><div><i></i><span>3</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>因为之前实现的调度主要看优先级和运行时间，如果没有 systick 中断来记录运行时间，那么调度器就无法根据运行时间来强制休眠高优先级进程，高优先级进程将会霸占 CPU。</div><div><p>作者回复：是的 铁汁</p></div><div><div>2021-07-16</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".11"><outline class="toc-level-h1" data-reactid=".11.0" style="width: 175px;"><active data-reactid=".11.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".11.0.1"><span data-reactid=".11.0.1.0">30 | 部门响应：设备如何处理内核 I/O 包？</span></a></outline><outline class="toc-level-h2" data-reactid=".11.1" style="width: 165px;"><active data-reactid=".11.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".11.1.1"><span data-reactid=".11.1.1.0">什么是 I/O 包</span></a></outline><outline class="toc-level-h3" data-reactid=".11.2" style="width: 155px;"><active data-reactid=".11.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".11.2.1"><span data-reactid=".11.2.1.0">创建和删除 I/O 包</span></a></outline><outline class="toc-level-h2" data-reactid=".11.3" style="width: 165px;"><active data-reactid=".11.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".11.3.1"><span data-reactid=".11.3.1.0">向设备发送 I/O 包</span></a></outline><outline class="toc-level-h2" data-reactid=".11.4" style="width: 165px;"><active data-reactid=".11.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".11.4.1"><span data-reactid=".11.4.1.0">驱动程序实例</span></a></outline><outline class="toc-level-h3" data-reactid=".11.5" style="width: 155px;"><active data-reactid=".11.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".11.5.1"><span data-reactid=".11.5.1.0">systick 设备驱动程序的整体框架</span></a></outline><outline class="toc-level-h3" data-reactid=".11.6" style="width: 155px;"><active data-reactid=".11.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".11.6.1"><span data-reactid=".11.6.1.0">systick 设备驱动程序的入口</span></a></outline><outline class="toc-level-h3" data-reactid=".11.7" style="width: 155px;"><active data-reactid=".11.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".11.7.1"><span data-reactid=".11.7.1.0">配置设备和驱动</span></a></outline><outline class="toc-level-h3" data-reactid=".11.8" style="width: 155px;"><active data-reactid=".11.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".11.8.1"><span data-reactid=".11.8.1.0">打开与关闭设备</span></a></outline><outline class="toc-level-h3" data-reactid=".11.9" style="width: 155px;"><active data-reactid=".11.9.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".11.9.1"><span data-reactid=".11.9.1.0">systick 设备中断回调函数</span></a></outline><outline class="toc-level-h2" data-reactid=".11.a" style="width: 165px;"><active data-reactid=".11.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".11.a.1"><span data-reactid=".11.a.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".11.b" style="width: 165px;"><active data-reactid=".11.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".11.b.1"><span data-reactid=".11.b.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".11.c" style="width: 165px;"><active data-reactid=".11.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".11.c.1"><span data-reactid=".11.c.1.0">精选留言 (8)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/395772" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>