
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,R0lGODlhMAAwAPcAAAAAABMTExUVFRsbGx0dHSYmJikpKS8vLzAwMDc3Nz4+PkJCQkRERElJSVBQUFdXV1hYWFxcXGNjY2RkZGhoaGxsbHFxcXZ2dnl5eX9/f4GBgYaGhoiIiI6OjpKSkpaWlpubm56enqKioqWlpampqa6urrCwsLe3t7q6ur6+vsHBwcfHx8vLy8zMzNLS0tXV1dnZ2dzc3OHh4eXl5erq6u7u7vLy8vf39/n5+f///wEBAQQEBA4ODhkZGSEhIS0tLTk5OUNDQ0pKSk1NTV9fX2lpaXBwcHd3d35+foKCgoSEhIuLi4yMjJGRkZWVlZ2dnaSkpKysrLOzs7u7u7y8vMPDw8bGxsnJydvb293d3eLi4ubm5uvr6+zs7Pb29gYGBg8PDyAgICcnJzU1NTs7O0ZGRkxMTFRUVFpaWmFhYWVlZWtra21tbXNzc3V1dXh4eIeHh4qKipCQkJSUlJiYmJycnKampqqqqrW1tcTExMrKys7OztPT09fX19jY2Ojo6PPz8/r6+hwcHCUlJTQ0NDg4OEFBQU9PT11dXWBgYGZmZm9vb3Jycnp6en19fYCAgIWFhaurq8DAwMjIyM3NzdHR0dTU1ODg4OTk5Onp6fDw8PX19fv7+xgYGB8fHz8/P0VFRVZWVl5eXmpqanR0dImJiaCgoKenp6+vr9/f3+fn5+3t7fHx8QUFBQgICBYWFioqKlVVVWJiYo+Pj5eXl6ioqLa2trm5udbW1vT09C4uLkdHR1FRUVtbW3x8fJmZmcXFxc/Pz42Njb+/v+/v7/j4+EtLS5qamri4uL29vdDQ0N7e3jIyMpOTk6Ojo7GxscLCwisrK1NTU1lZWW5ubkhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/i1NYWRlIGJ5IEtyYXNpbWlyYSBOZWpjaGV2YSAod3d3LmxvYWRpbmZvLm5ldCkAIfkEAAoA/wAsAAAAADAAMAAABv/AnHBILBqPyKRySXyNSC+mdFqEAAARqpaIux0dVwduq2VJLN7iI3ys0cZkosogIJSKODBAXLzJYjJpcTkuCAIBDTRceg5GNDGAcIM5GwKWHkWMkjk2kDI1k0MzCwEBCTBEeg9cM5AzoUQjAwECF5KaQzWQMYKwNhClBStDjEM4fzGKZCxRRioFpRA2OXlsQrqAvUM300gsCgofr0UWhwMjQhgHBxhjfpCgeDMtLtpCOBYG+g4lvS8JAQZoEHKjRg042GZsylHjBYuHMY7gyHBAn4EDE1ZI8tCAhL1tNLoJsQGDxYoVEJHcOPHAooEEGSLmKKjlWIuHKF/ES0IjxAL/lwxCfFRCwwVKlC4UTomxIYFFaVtKomzBi8yKCetMkKnxEIZIMjdKdBi6ZIYyWAthSZGUVu0RGRsyyJ07V0SoGC3yutCrN40KcIADK6hAlgmLE4hNIF58QlmKBYIDV2g75bBixouVydCAAUOGzp87h6AsBQa9vfTy0uuFA86Y1m5jyyaDQwUJ0kpexMC95AWHBw9YkJlBYoSKs1RmhJDgoIGDDIWN1BZBvUSLr0psmKDgoLuDCSZ4G4FhgrqIESZeFMbBAsOD7g0ifJBxT7wkGyxImB+Bgr7EEA8418ADGrhARAodtKCEDNYRQYNt+wl3RAfNOWBBCr3MkMEEFZxg3YwkLXjQQQg7URPDCSNQN8wRMEggwQjICUECBRNQoIIQKYAAQgpCvOABBx2ksNANLpRQQolFuCBTETBYQOMHaYxwwQV2UVMCkPO1MY4WN3wwwQQWNJPDCJ2hI4QMH3TQQXixsVDBlyNIIiUGZuKopgdihmLDBjVisOWYGFxQJ0MhADkCdnGcQCMFHsZyAQZVDhEikCtOIsMFNXKAHZmQ9kFCBxyAEGNUmFYgIREiTDmoEDCICMKfccQAgghpiRDoqtSkcAKsk7RlK51IiAcLCZ2RMJsWRbkw6rHMFhEEACH5BAAKAP8ALAAAAAAwADAAAAf/gDmCg4SFhoeIiYqLhFhRUViMkpOFEwICE5SahDg4hjgSAQJEh16em4ctRklehkQBAaSFXhMPVaiFVwoGPyeFOK+xp4MkOzoCVLiDL7sGEF2cwbKDW0A6Oj0tyoNOBt5PhUQCwoRL1zpI29QO3gxZhNLDLz7XP1rqg1E/3kmDwLDTcBS5tgMcPkG0vCW4MkjaICoBrgmxgcrFO0NWEnib0OofORtDrvGYcqhTIhcOHIjgYgiJtx9RcuBQEiSIEkFPjOnIZMiGFi3DCiVRQFTClFaDsDDg1UQQDhs2kB4x1uPFrC1ZsrL8tCQIUQVBMLgY9uSBFKSGvEABwoSQFy5Z/7NqgVZqygSvRIU0uSeTrqIuSHF00RI3yxa0iLqIePBVwYMoQSX5LKyF4qQsTIR8NYJYEla5XSIzwnHFSBAGtzZ5IcylsyYvJ564lmz5oO3buAttabKEie/fS5bE3LYFi/Hjx7MgtZKyefMhQzCIpvTiipUr2LNjp8vcuXck0ydVt649O90tTIIrUbKEfXsS4T0jn6+ck0x/8XPr34/Dyon8iRimDhZOFFGBC6hwMcUULfhFCRckGFHEBEUwAeAvLUhxwglUYDFbXRgUMeEEGExxYSFaULHhhlUApQgOLSwh4gQTGCECXyYtMowNL6i44hVcTIcDCRXQOEEFTVg1SPAVT0SSyBZVKClIFy1MIYWGUzhpyBM0FpGEFYhxscQRSKTmiTwkiCBFbTJt4d+GCB6CxRFHROGgTFLQiYQ2OVxBAgkM5ZAFFCKIECgnWVBBBZuFvMBXIVkkcQQGIpwiRXBSOFVFoSRsVYgNd0qCwxMYHJHERTlcykSmgkBYaBUnStICEhhgIMUwly7BqiBXFAoFqurY0ASdS3iaam+75mCDFIWe8KEmVJSKQWqD5JpsDi8QCoWUymwxJgZOMGrtL1QUaqc6WShBJreCjItimlEYi4sWUNxqiLu5WCHvNtPhu98iJ/hG0r+MdGFcqAQTHAgAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDALHjxZGEqcWNCNAQNvKGokGCjQQTYX2Ry84XHjQT4a5JQk2CakwRtu1OQxWXCPAwVlqhQMBNJAm5UCoxAIcEAnTYF+bipYU4NjSwNsgP5pEIAon6MD6yjYeqdgzzYF5QgIIAAO1oF/0mxFI4NgT5ED/YypuqDtWYFSFmyVMzDQ06gCA7kZO8DO3YGA2mw1c1Xg24FVxIxFA8hkH7sF9TTY+uZGDr8XweYAhKaqGCoH96BG2CeNmihNOTLZugCFQCYOHDARaGcAWdEEZ2QYIMCoQTlmcrep4nlgljM4RQQGBKi5Bt9j+hAEVAcBgO9ngAb/pnMmt4MzcLQPtMOmiviBN6KU4RuYSoMv3wF8UdN8ZxU35jkQAR0zCHRDZQvVUFIfaoCRHwBk3PEeQTVEoUaAa+AxYUI3xEHAg2HE8cdEM8yBRm5mZNCfRDWQkR8Ya6inEUoOoKGHSXZ88UUDVGzI0A0oSGgSIG/UseJhG/k4kZJIolUHHXQ8CeWUGmIFyB9YZvlHDVuWpMcaa6ihRphgihkHkwr9kcWabLbZ3B5hihnnmGowgWZCM7SpZxYIzkDHHHP8CeigUpzFpZaIirfSnU026ihHexi30QyxHZVFHW9k4IdJNeyhhx8IalSDFHC8YWodjA7Uhx6s7iEDozdU/8HEG26YGoekE/3hKat68FGgQoHwMYeptGogxYiBaXRDFp7mwSqoCAUiRQbEZiBCRAPtIQW2CP2hB2aj+cErq+ASZAexcuwBVA11MJFuXytlgQIezBX0x6qscltQFnDEQUWoA1HBhLvq8YECCurNMC8Km+40wx57HNnQrwXJMMfAUngUSBUiiGBUIHs8REWl2wG8pBRMxDEHZhx7XFINVOCBgrpN9iHHwJK2LGkfD6FA8Vk32DFwHSTrTNANMeOhR6oJ6THwuwQZ3VDP+tL0Bx0D33Gk1H3p8VAVJm8kA9ZyVJ0DFR3jmoPCUox81x94rFYQx3WonYMffIR91IRcPxHKUB522DGT3xIBsqbehCceEAAh+QQACgD/ACwAAAAAMAAwAAAI/wBzCBxIsKDBgwgTKlxI8BIVSZcYSpxIkNMjBQo4UNxYkNNBRxgfHdzkkeNBLB3qlBzIqRFGRwY5OVpEyWRBS4kcPJjU0aUCmAXxIDCggKdNgVkQOXDgSFNFn0AHdkFjgKilowOhLHUgpaBPkQTrVDUwB+vATIuWrsHE8itBLAyqOmBrViCVpYfqEITK8lHVH13rCtz0aCmiqzlahhy4olBVRU45YqFbsBKapZA8KlYAdtOaqoRWHKwkaWVBLG7c4IlMcI6DQw8kCQSxaI0IgSV+VI06EBOHHz9EHwShqDikSaYvKYIdSSAnkiU76GaAheAmKIYECAigyLRzKGuKK/9aMwfLyhKOkCPcJOWBXueS0AgKEECAIEbenU+CFL44IyiZOLcJQ5oMmAMWjAxCn3YMSGEgQprg0Yh4azQyRX4KceIBIdvVR4gHAUqECRSMiNcBhgl1IUSHgzBSHUeWeLAGTSZFIoggaKyAIkObSCLFjgkRJgJrghVpJEeaJaakaV1EIgIUUD4JhQgiUIFVS4dspaUDaCBWSSNugNnImGG6AQKQCnWBgA5stulmczl8KWaYYjZy5lFquqmnDnA2KSWUU05p5VFY4rVllxkeyUlJSaJ5ZF2cWEKJowcVaBYmUngwRxYmbXLJJZk8SJEmVMzBQQcclEApQZlk4eolXVD/tMkkdXRgqwd11MSRJp++egmRCGURiQeocjCHJLEmtqpzXVziahagiloQFR5wcKoHUkQ0EBZUUFbpZBVh8iy0yRqEx6kdQIHYQJpIIUIk6yopECaUTFKJtJuI62q5BWECAgiTAJsDJYBymkMWK6xgcBf1UqJtRbxesiOoB2XipAilCUQJHnjoeuAk9krr3LIsSUJlJCHGybHHmtQ7yYtFXjKlCB6r3HFDIFPCL1ab4EGlFERujEcl1lUCcrxYWRIo0pWs3C/Ik3hrUxclUHlhZU5XhEW995qVSdWRPDyQ0EQX1AXIlQjMUSYrGFUQ2Qc5KzKho3Fc9qMTNY0H0ngrCrRJJqH2LXhCAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSFBVlTyqGEqcSJBTBwdmPFDcWJDTwVIOHHQ4yMkjx4Op6pwySXBDyFIGvZTS8OJkQRikFFXY0xGkA5gFpxj6ZIaPzYGXcioqxaqiS5EFVyn6ZCgUjKMDTShSNGpKQZ9AB5r6RLYO1oGrNGx1FFEgJ58jB6ZyQFYRjbMDq4zaGokgSDMdTFokC8orXoFePGy1cDUHp6dxc7BoQPZNU46p2hZ8YWHrBy8C4SK2QLYBT4MvWLAsmGpDqRSXB3IytXcUC4GR3rzpm8OEoaEaC9L4QPb2wVO633jYs1rVG50m3HopKbAOqE+hUhFkhcqBge8VVrv/NeEouSNTqVie6MBHvOwqFXg7zqPowHcDCRy5d8znQ/I3GqByl2OgLTSdQKloUMh9BoRyQoEIsVJFB/+Vksd+CXFShyEMGlLHKhPRYIIGydWBIUKriHJfAhpoh5kpjtB0EioHHKCIakd5sceFJ7HSASoQHibkkBx5ZKRjSKJ1gglLMumkCcbZ5MUGolRppZWKNAZDBx2UUkqXXX4ZyYkLsQJKAGimKQCaAqAi0JZfesllmPKdtIoha66ZJptu5rDKFCYw2WSgJ+SB1WNXJpqlQmRuZOSjbhEpqUGcpFJTj2/UEdtJNFRxyimaUWTKF1+YkUKjBrGyRySmtJoCR6t8/wLArAGMcilDXrxgwimtnmLCrRPJ5Mmss3pSyoAIcXLJFLzyGgkLsaFK0AuK8EAsAIVEEiRBe/DaaxXI5pAKC+HGpEq0KTTwBbFfKLKtQFX0ekJ626VwwhQupnpJKpesxkodBxAbyn40oIIKH+++cMK9bV3ywgttsZLKxCAWdIkGnXRSRUI0VCycvSeclgMMeeSRryoTX/JuDnucehILC6fg8bgsNJaDF/umUu5ZqgB6gs0js1AzQaukvPJJXuSxcBWbwsCCyRXtC4Mq0i6UysInXHKT0PkKVPTEm9rEir1Qiud0HkALhDK/VaNYhQlT7Oz00AVJzO/RFK3CR9pvPhndNVo0tG0TyXRPKhHNfxue4Sqr4K244QEBACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwBgsWNBhKnFjwiRo1pihqLMjpIK2LdA7m6rjxoJYRJkgS/KgmZMFctGZhKVkwy4Y3jnBxZOmS4IpYh2TppClwxs03dDQV/Eihp8BVRxw4UKOF6MAUb7KuIMiJliw1TwqikuqgltWBmjxknRVRYFeQBLXIknpk1dmBlBxlNbHyYtiBtKTGUnF3ICdTR45oyAL4a08XaKRuyFVyRtuaGrI+6fgWrMBcGqRGGFoQF6WEM2jRWUFZbFZHp3OYWLKEb44UQB04FUiDjlQXCG3RnjUCl8ocNJbgJJyDk/OBtWI5oFB1YC4TsgwpULABYQoPS2aF/0dVXaCKJzMRcmLhyJZhFm20bzfk4bhhLLXEi6eVwm5z+yKRlMUSQmyngCEUqAAgQblQ8oR44dFByYIJcTKCAwYqgEYtSkm0Sgq0hDcLKhQilMsi8h3iQXkUzWDCLB4wtpEKZRjyBnBEcWJaiRWacktrhQUpZEmcNefWcwJpsoIKS6rApJMqkEbkLItUaWUbbSxyhIwnmWLKCF6G6aNVmjgAy5kFoHkmLO7l0KWXYIp5C5lmrmnnmW0qCeWTT+JIEydUWiloG1sOuRCSziFp6KKGzSDjRppoMAKQJa1CyS23XEYRKoIIgoaCkGKRgi2ksgCpEAGkWsARUirESRYqkP9KqgosSgQTAq+kGkACHmhqECcOyXpLClgAyeNTrWHRRgG6viKECZQShMUtwlLiH2+4XGtQLiMksIRhKqAhiK6CtLGgC6TessIMxzXIAiUzIPRGKwD44GcOmoxgSK4ByLLgKk5mAaAWD7Hg3yozzODfE/QCoIZ9Rh1wwFYIrdJhQZaysEJ6yGWRRVuaHAIAAGCkcJALzG2ExUOUXEyDx5elAMbIQlx81yoas8Diyx8bpsbIrfx1FycurMCCC5TyrCkuPoyMQK00zWA0RAU52jNBS4wMgCN35eKCxsYVpHTVQIzcQ2xEaULJQ9ryBrNBtbgCwCsmn5VLFlB3fDWDFAwUxihBY297bGGB/31oLiMZrnhBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSDCTCxeZGEqcWPDOmzd3KGosyOmgnQtv7Bzk1HHjQVW2qJQk+PGCyII3RPxKZbKgql9MmtAsaOeiCIMs2Ci64KfmwEw4mdy5UVDExZcDWUFSNFSV0YEsmGhlQZDTxzc/CdqiusbW1ah2tIqowfIpQVVvqEJidXbgiyZaqbAEKaIkJxFU2QCrO5CTCa1OLg38CvWFBapOVlLMxNbgJSdaTXT06jYHpyZULbw4mMpFwkwlSrhgWpCK1iajc1D59UtvDhVrqEIdWEOEBAlFDwITIcKOrVSSe+cMVnilCaG+rA68QYUNrwa8miBkYYd4cRURBwb/K7FzZDAmtgW60PCA1/UHvyQTvISiO/E7LOh6ln+QdY7LETSA3QNvsMBfVy+Y4J0dJvhxYEKclCCBe+4pYoJ+DLESzB3epTfRDb5gx0sEv0inUSYq2HGHYhux0B4TsdXESSoxahShCv4RpuOOJpHk2Y+S3eBCMEMGY2SR5dUUAkhv+HKRk29owGImKJhggi1YYnklMA8ydAMbCoQp5gJhLmAbSlnacqWatgxm1JdixlmmbUIaeeSdSW70ly++aNCnn3wywSKPhBZaVyYmanQDEyVgaBIrfgTDQmUamaCLLooYuNENqUjKAjDBUVRDLwaUmoAGeUKoigufAsMCRJuG/7BLqaXuEkJ4CdXwAgutBnNJlwfVwJofGiRAqwEPoJAjQanw6ioLqTjKiirLEnTDHbtoJxAnwCiiC60I+HJgs66+UINknFySSrQC3cDKuQJpMEAACdR4gwkN0GrBgaw8pAp/mazLLidvXHqBQHbMK4AFBqniRJhcIcRKtTncoG4q4XHCCwAA8CIQK70EEIAYKhy0K7AIBZzKrwNt3HFJKoghci+OnsXKupdQqjHHHg9kgQABDLDbWar4sfJKO3dMkB8JiLxAokbVILCjSfc8UBNAB8BEXemm4gfUVUuWSQMi68LcVRavvGzYBZVAgAC6lHwWJ5Qd5LLV01kggZuGehZ2d38oE9YLxxH0LdELdthRo+GM5xAQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEiQGAwYxBhKnFgQhTBhKChqLFjsoIklwkwc7LgRYSZgVw7iuSiSowk7l0oWzFRCBEyDJlga5JMBg5IsMgcSMyFCBAqSA3OGLGjjiRufM4IO5GPHJq6CSvEUlISh6zCpA3OhKGrCBsGcS1oKzLSkqxyzYAVeqiqCEkE8ILUmdeMmg924AotJKloi08CVS/TmyKKk6xOkFInBnRmpqCSSaFsWE9E1CVCDl2AkJCZpWBbIAq8UtfP5SqRIKXNQyvBUrVATfD/vxMMb2AzINohGuhoYqaSeSwwPFJxEkfPHB2Gg4I0HBaWIA2FIioqwGIwnkgji/5JTxLmiIpESZroynfcwXLmWM0Q6t4L5IksooeZ4SRJ1FJLEtBEKbtyHwTCTLZQLDMO0d8V+ChUjjHmM2KGcRsRQggIKF1JESQUVOKGbTJmMSFExeAADIWAstjgRSTBCVkwWD2VBIww3cidTMZEoscQSPgL5oxzcEXPFkUgmSdyOGTgwhANQRvkkMAIZmeSVS5ZUDAZRSjnEEKFQmcOMONqIY406yhQJSBe1CRKRLkq0Ypx0DmRDgic+YUJ8QeWSySWX8KmRJAww4IZ+GxVDzCU2ZpGmRLm4ocCkQixhYkLF2DBDo47iOV8koUw6aSgiYJdQLps2egkxJOXiqUE28P95iRxDiBqEIigIWtCiqmYCmTCFiKArQcWYEMoTBFGCQRC2LgFhiTbOMCwuPejQihsCuWoDScL8YAADI4olgahJdDfDJZ4Wo4gO1iKbgxJBBKGEQCV4a0ASqBEjApRZcgQhCjywOwRcRAQQABHZKmKAAQmIWVAWf2lkgxDsBvBVDrkUfDBJVySwsCLDSvVEK+wWAaPGRCCVxMI/lMDiJT+w60OWKBOUBQMLO/CoTBmwq8MSxBb8CsIEPbGwAU7ERckr7BbSYQ4oQ0YMEQsr0O9GwzDdSnpBG0z0WQgYoEBsUkkSiiKeRl1QLhkwQjZYxYRcDBGvHDzSnC0qUrcieNcLmV0JJYjm9+AGBQQAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSBCQlmWAGEqcWHAFFBErKGqUKEmECEkHA21MCEhZn4OSLoI0mOzElpEFa7RE9rJgx48Gl8lZcqwmzByAJJ04sUIkwZsrB3qpxYTnn58Dlw09scymx4wEW8hhwuQK1IGBVpyQIsnLUY9Jc9R4whWK2a8C/yAbenIgUoLJuMqpCzdHoBZDkdUYuALtQC20mpYwqhHQ24KAWp5oYfQm1kBSuNLScnBLVYQllW1hPLDP1JrKkCFTJrDPTibJDEbesIHzwWVXcisbTNCLUGSfDV5J/IS3wL9yMCiHglBL7ucQCTp/mlBLiRYEl4lAohwDEimkCdb/gPH8SotljyUy/iMliRs3ymkpC2/wj7Lyyv7QXyhpSXcMS5Q1USBatLBCbjBsFMgTGMCXhBTUNYZbC8ZR1AcSSIgQHEw1RLiRJFfs19eIJKoH1nGkBfLHiiy2WOFIJdAioxwy1vhETV4so+OOPPo0UiBLKCLkkERil4MXD/HYI1RAEulkEUaq2OKUL2oUyAm0HHNMllweI4KHJYYp5k+AMBiRgrUkk56VyRjzxRcijHTFA7wkwdpGfRQBBgB8klGlQl4kwcugEBxjG0N/LOEDn3x6ssSaC12pCC9mUCpBCX8qVQsZjAIAhiJ1eZFpb0ZtcQwElFbqhiT7eaHIF4x+/2EMMozJYUwJkB4nCRvMlbYEnYM+cAx9gTzAKAJPnNnaGAF0ksRxgABilAigKPDAhr4ZQSkvTOwnSSedIOGjX0YIEIAnzAXCxKBMCITMAgoosER4NZQggQQJIpSMkTYVEEAAEJxphAEGsCGQFxjEawxWBS3DF0WAQPBvAQwPbIARRiljRrxG5AoTFJ0IIIAbRgVisREEyRHvAieMuMUCIo+Rr0AnSwdBvBGACdMS/wogR0E1E1RLvAo8AZcyB/xrjIcmE4yxeGzEy8vMMElygACelFBQ0xeHJ0m1vPD70woSdGxQ0AQFIoedIwaSKxsEG2xQICKWiEEBBmAw5kRSSQex4d6ADxQQACH5BAAKAP8ALAAAAAAwADAAAAj/AHMIHEiwoMGDCBMqXEhwE5ctmxhKnFgQFx48lShqlEjpYkaDxTYm3JQly8FKFymBpGSFi8iCmihdoVTDYEc8KgtqseMMlcuXAjdVunIFV0iCNz8OLIbCWc+aQAVyIXrl58CkBf04taM0ajFcRCtFHIgSJ8Eaz5ziGRtVYA2ZV7Qg9Yh0q8m2BLMQpaSJLF2pkZwOO6qxGGGCMYn6ufq32DCnkawS5CIXYTEtWvoa1LL3p94ri3Nk4eksZ0MrIEBsQcilZJYtmpcOpbRa4GFcgZ/FzvHVTocOHPAgrKHFdRYubHNwwQUV4ZZhuAhuQdWMA/Bmw0ZuMa6lxmGGhGtA/5vDwXqHSFm+G9S03XV3kZSe/Lb+hFJyhcWIu65NsRgq83MM0xxFDmF2n0RZNNPMM/y9tMluGhWlHl4UWmYbb7xN+NKEhOGCBi8ghhhiIwdS9BhPKDpjhx2RCRSJDjDGKCMzAxYGQiMX4Ihjjjl+ZIeMQOpAI1DFgMCjjhfk2MhHHooo4iGNaCgRNE5tpSJkkhmGYYYVdumlSJrYkUSJCxWDBzRkTomGIIJEAt8iozQT3UZ+XDBIAHgKUWOZzUzgZxt2NKgQF80QIgCeAhAyR5oHOdbIKH5O0AgeezaECigCHCrAIG2E9iBDmxzFhR1tRDqKEldweIEgmQYgyAPQEP/2xAPPkFnMFY6gQpAfcywyAaSjONPoBIgaYsdufoACywEd2BbqUZE8wMsEldl2hRKQTgDChFYccAAHguaQBCyDHKBrDs4sssgTAkHzwCGHzPFdDXjkeNdB0HQ1kBWEwALLBGM5ooACUfLGAS+HoKGvQFuEppEmE/hbyBUDCUzwQLhEAOKYXaLCjL9JEJbEwI0Q9ESI2VG4BS/+gnJvDhYXzPAEh/CyiGRAzeEvLOwSNPLFBOGBMC924IWLAv4+gLPFjhymSSMgRvCySFYgfYBwBcX83RXSprHwRlcswnHWJIMEQgcOt6WlQTE3+iVCHAwc8tsTaTHMMNXSrbdBAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSPDGqlWcGEqcWDDLlStZKGqUaPEKlo0bOWXKdBDLFSsfDWJRZgNkwRtasmi5ofJkSoKZUOBRscrlQE4xs5AsaNJjQU5X8OBJ0dKnQBtZovYkWPSmQC1KUWR0KpDTlqhaIg6s2lCFUis0uT6NmmWqQLJjleLZohYn2LQ54OawkUIKnmBiNaYIdhBoVLpvL95UpjSFW4Krhh5U0amTBi0GV7FNu8WSJcRbdOKxZPCGshIlHv8MBaC1rhBNu37VonpgFp0q8ObglAUPFCjOrBy8oehLawBfGqQIbGOLboOZrmAemEkFcGfOoBAeXqvQcQA8FJH/psj8Si3s2FGEVZiplI/vPko9Z2hJCvYQUKRYCrzQkqIAxyVQm0KcqIBeLVfERlEKDXzxhTMgbVELFCpIBpINIbyhIEWWbKUWf3UlxMmIu0VEYogLYaGIKKKsyOKLkICo0RVS1FgjHjbiMZUUAfTo44+gDDhRLaUU2UGRpRzZQUol/OhkAKBsSF4tRxqJZAdLvuUiixO8KAok802ElI1k3uiWiSWSKCOKbLaJ0A0ldBDmQgUC5pQViugSjRQgWaJBBiF4SBEWGiRgQDTRTCMlgRm+8YYGUljIXghBGHBoNEGEMGdCVpTiqKMdqLDoQDfgMQ2iiCaQwU2bkipWJlJo//DpG07YaRAnGegZjQG6KGJFYLVQo8KauwXTAR4EZRFCBqQ4moEUMnLCCKoNlKAbFtOAkmlXuw2EBzWKvDFdV8E0IesbUCCkDBmFOCFpDk2wGwSfOUDxBinp5mAFuIo4AyJfkEAyrkFWKHNQMA2QAQopaXUgjTQx5nCDE4oowojBBn0F0g1vFFJIA1cMVIoZ0pQyFiMVN9GqRiiA4nETgZUijRkmDwRFxWsIV1cmiigciqAdkByxQJlkULEGQmrkjMug5Cvyw0MLlMIaFdPrVBbSeKyIpA6bAUlBNpRSMSmCgqRMKIWAgoJBI5dsUDBrUMOIVS4po0EpMsoMMYicQB7hRNk+nVhQ11/f6uZBTZDcweETbWGFFQMzLvlAAQEAIfkEAAoA/wAsAAAAADAAMAAACP8AcwgcSLCgwYMIEypcSLDYjRvFGEqcWPBPqlR/KGpseOOgRYwbN6oINaFjxYsZDWpJZTLkwGQEALiqZfBjSoJd9kyqBMjlwD2CAAAAclPgR0wGYUyatKelTyRCAXA4CZIgJp2TkPocqAWBUB8wCNpsWGmppYhbBz5pJZQC2hxjuS7d0yUtQUDVhAZINjBujhtYw4bMU+lgMh5Ch/SEi3JgqqWTFhe8URfhpB8/OGgdWIyC0FZPBHbBhKnyH8ipDBZLlUyF5IYTAgR4tcDO60oxWzVCiKlsJadw89gaXlh1GwKyAxCAoOItByC2EwKCUbRLpVvDbd2yhPCGiWqvkg//ciOYssYbMJJlv5V1IaZmhMLPJvTh7UQtKtarSGVfIQw3g4T3SjWVTVTMHtklYwlwDBWjAgQECELTRn/ccgtdWwFihwYMSpQKJv25FKJdCkX01ogkGpSKG9RQ04aLL7Y4S4cTWaLCjTjimMdithjg44+D/CjNaxvdIsKRSCJphxYC9fjjkz6GQiRFxSST5JVLCpRKIy3G2KKMNEpkY4457thQDvahmOKabCp0g5FhJnTgWVtV0sgCDKgQkhbNNGPCZhTxWc0nhLYRp2qozMLBLB8kU+BCgNQCAaGESmOHmgjtccwsis7yRFMlqkDBApRWw0FqaGIq0FtdJPNBp7PU/8LfQcU0wwClC7QxCUEmILFrQjA8oedAmJjQzKIcNMOXahpQGoEtr2lBgTShTGjiQCog0QgHRRVjiQiccnALQpVIM8QTRQl0zBDSSDNuDrZwwIEJAu2hbSP0TpbHMccAWtAe3BlkSQTscqguBRN8sKoIjbihAaoVMbnRDRu0C0FxORwzQcJopaKBG26IcChFI7GrsFoTUHCyQCY00ggSe6TYhRvsyiKxuhsfI9YsbjTSzJQh1WKuNKgUdAzCKwukgsuNLLuVFhOY68ajGW+c9F8f9KxZWpbIMkQowxKkMccFWYKEGxvc7BMMsxwT4thXo2lCliQWM6LGKtPaJkIipA8c2t4T/bHHHv4CbjhBAQEAOw==)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 15 | 内存：为什么你的 etcd 内存占用那么高？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>15 | 内存：为什么你的 etcd 内存占用那么高？</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">我希望你能够用最低的学习成本，掌握 etcd 核心原理和最佳实践，让 etcd 为你所用。</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">15 | 内存：为什么你的 etcd 内存占用那么高？</h1><div><span>唐聪</span> <span> 2021-02-22</span></div><div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/a8/88/a87d20bc0ae5dcf031dea7b3946bb288.jpg" style="width: auto;"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：王超凡</span><span>大小：15.33M</span><span> 时长：16:47</span></div></div><audio title="15 | 内存：为什么你的etcd内存占用那么高？" src="https://res001.geekbang.org/media/audio/09/a9/0970df599e44da98ee3cb32b4c7393a9/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="5643" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="5644"><span data-slate-object="text" data-key="5645"><span data-slate-leaf="true" data-offset-key="5645:0" data-first-offset="true"><span data-slate-string="true">你好，我是唐聪。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5646"><span data-slate-object="text" data-key="5647"><span data-slate-leaf="true" data-offset-key="5647:0" data-first-offset="true"><span data-slate-string="true">在使用 etcd 的过程中，你是否被异常内存占用等现象困扰过？比如 etcd 中只保存了 1 个 1MB 的 key-value，但是经过若干次修改后，最终 etcd 内存可能达到数 G。它是由什么原因导致的？如何分析呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5648"><span data-slate-object="text" data-key="5649"><span data-slate-leaf="true" data-offset-key="5649:0" data-first-offset="true"><span data-slate-string="true">这就是我今天要和你分享的主题：etcd 的内存。 希望通过这节课，帮助你掌握 etcd 内存抖动、异常背后的常见原因和分析方法，当你遇到类似问题时，能独立定位、解决。同时，帮助你在实际业务场景中，为集群节点配置充足的内存资源，遵循最佳实践，尽量减少 expensive request，避免 etcd 内存出现突增，导致 OOM。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5650" id="sr-toc-1"><span data-slate-object="text" data-key="5651"><span data-slate-leaf="true" data-offset-key="5651:0" data-first-offset="true"><span data-slate-string="true">分析整体思路</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5652"><span data-slate-object="text" data-key="5653"><span data-slate-leaf="true" data-offset-key="5653:0" data-first-offset="true"><span data-slate-string="true">当你遇到 etcd 内存占用较高的案例时，你脑海中第一反应是什么呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5654"><span data-slate-object="text" data-key="5655"><span data-slate-leaf="true" data-offset-key="5655:0" data-first-offset="true"><span data-slate-string="true">也许你会立刻重启 etcd 进程，尝试将内存降低到合理水平，避免线上服务出问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5656"><span data-slate-object="text" data-key="5657"><span data-slate-leaf="true" data-offset-key="5657:0" data-first-offset="true"><span data-slate-string="true">也许你会开启 etcd debug 模式，重启 etcd 进程等复现，然后采集 heap profile 分析内存占用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5658"><span data-slate-object="text" data-key="5659"><span data-slate-leaf="true" data-offset-key="5659:0" data-first-offset="true"><span data-slate-string="true">以上措施都有其合理性。但作为团队内 etcd 高手的你，在集群稳定性还不影响业务的前提下，能否先通过内存异常的现场，结合 etcd 的读写流程、各核心模块中可能会使用较多内存的关键数据结构，推测出内存异常的可能原因？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5660"><span data-slate-object="text" data-key="5661"><span data-slate-leaf="true" data-offset-key="5661:0" data-first-offset="true"><span data-slate-string="true">全方位的分析内存异常现场，可以帮助我们节省大量复现和定位时间，也是你专业性的体现。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5662"><span data-slate-object="text" data-key="5663"><span data-slate-leaf="true" data-offset-key="5663:0" data-first-offset="true"><span data-slate-string="true">下图是我以 etcd 写请求流程为例，给你总结的可能导致 etcd 内存占用较高的核心模块与其数据结构。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5664"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/c2/49/c2673ebb2db4b555a9fbe229ed1bda49.png?wh=1920*1056"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5665"><span data-slate-object="text" data-key="5666"><span data-slate-leaf="true" data-offset-key="5666:0" data-first-offset="true"><span data-slate-string="true">从图中你可以看到，当 etcd 收到一个写请求后，gRPC Server 会和你建立连接。连接数越多，会导致 etcd 进程的 fd、goroutine 等资源上涨，因此会使用越来越多的内存。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5667"><span data-slate-object="text" data-key="5668"><span data-slate-leaf="true" data-offset-key="5668:0" data-first-offset="true"><span data-slate-string="true">其次，基于我们 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5669"><span data-slate-object="text" data-key="5670"><span data-slate-leaf="true" data-offset-key="5670:0" data-first-offset="true"><span data-slate-string="true">04</span></span></span></a><span data-slate-object="text" data-key="5671"><span data-slate-leaf="true" data-offset-key="5671:0" data-first-offset="true"><span data-slate-string="true"> 介绍的 Raft 知识背景，它需要将此请求的日志条目保存在 raftLog 里面。etcd raftLog 后端实现是内存存储，核心就是数组。因此 raftLog 使用的内存与其保存的日志条目成正比，它也是内存分析过程中最容易被忽视的一个数据结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5672"><span data-slate-object="text" data-key="5673"><span data-slate-leaf="true" data-offset-key="5673:0" data-first-offset="true"><span data-slate-string="true">然后当此日志条目被集群多数节点确认后，在应用到状态机的过程中，会在内存 treeIndex 模块的 B-tree 中创建、更新 key 与版本号信息。 在这过程中 treeIndex 模块的 B-tree 使用的内存与 key、历史版本号数量成正比。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5674"><span data-slate-object="text" data-key="5675"><span data-slate-leaf="true" data-offset-key="5675:0" data-first-offset="true"><span data-slate-string="true">更新完 treeIndex 模块的索引信息后，etcd 将 key-value 数据持久化存储到 boltdb。boltdb 使用了 mmap 技术，将 db 文件映射到操作系统内存中。因此在未触发操作系统将 db 对应的内存 page 换出的情况下，etcd 的 db 文件越大，使用的内存也就越大。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5676"><span data-slate-object="text" data-key="5677"><span data-slate-leaf="true" data-offset-key="5677:0" data-first-offset="true"><span data-slate-string="true">同时，在这个过程中还有两个注意事项。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5678"><span data-slate-object="text" data-key="5679"><span data-slate-leaf="true" data-offset-key="5679:0" data-first-offset="true"><span data-slate-string="true">一方面，其他 client 可能会创建若干 watcher、监听这个写请求涉及的 key， etcd 也需要使用一定的内存维护 watcher、推送 key 变化监听的事件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5680"><span data-slate-object="text" data-key="5681"><span data-slate-leaf="true" data-offset-key="5681:0" data-first-offset="true"><span data-slate-string="true">另一方面，如果这个写请求的 key 还关联了 Lease，Lease 模块会在内存中使用数据结构 Heap 来快速淘汰过期的 Lease，因此 Heap 也是一个占用一定内存的数据结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5682"><span data-slate-object="text" data-key="5683"><span data-slate-leaf="true" data-offset-key="5683:0" data-first-offset="true"><span data-slate-string="true">最后，不仅仅是写请求流程会占用内存，读请求本身也会导致内存上升。尤其是 expensive request，当产生大包查询时，MVCC 模块需要使用内存保存查询的结果，很容易导致内存突增。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5684"><span data-slate-object="text" data-key="5685"><span data-slate-leaf="true" data-offset-key="5685:0" data-first-offset="true"><span data-slate-string="true">基于以上读写流程图对核心数据结构使用内存的分析，我们定位问题时就有线索、方法可循了。那如何确定是哪个模块、场景导致的内存异常呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5686"><span data-slate-object="text" data-key="5687"><span data-slate-leaf="true" data-offset-key="5687:0" data-first-offset="true"><span data-slate-string="true">接下来我就通过一个实际案例，和你深入介绍下内存异常的分析方法。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5688" id="sr-toc-2"><span data-slate-object="text" data-key="5689"><span data-slate-leaf="true" data-offset-key="5689:0" data-first-offset="true"><span data-slate-string="true">一个 key 使用数 G 内存的案例</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5690"><span data-slate-object="text" data-key="5691"><span data-slate-leaf="true" data-offset-key="5691:0" data-first-offset="true"><span data-slate-string="true">我们通过 goreman 启动一个 3 节点 etcd 集群 (linux/etcd v3.4.9)，db quota 为 6G，执行如下的命令并观察 etcd 内存占用情况：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5692"><div data-slate-type="list-line" data-slate-object="block" data-key="5693"><span data-slate-object="text" data-key="5694"><span data-slate-leaf="true" data-offset-key="5694:0" data-first-offset="true"><span data-slate-string="true">执行 1000 次的 put 同一个 key 操作，value 为 1MB；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5695"><span data-slate-object="text" data-key="5696"><span data-slate-leaf="true" data-offset-key="5696:0" data-first-offset="true"><span data-slate-string="true">更新完后并进行 compact、defrag 操作；</span></span></span></div></div><div data-code-language="bash" data-slate-type="pre" data-slate-object="block" data-key="5697"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5698"><span data-slate-object="text" data-key="5699"><span data-slate-leaf="true" data-offset-key="5699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># put 同一个 key，执行 1000 次</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5700"><span data-slate-object="text" data-key="5701"><span data-slate-leaf="true" data-offset-key="5701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5702"><span data-slate-leaf="true" data-offset-key="5702:0" data-first-offset="true"><span data-slate-string="true"> i </span></span></span><span data-slate-object="text" data-key="5703"><span data-slate-leaf="true" data-offset-key="5703:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">in</span></span></span></span><span data-slate-object="text" data-key="5704"><span data-slate-leaf="true" data-offset-key="5704:0" data-first-offset="true"><span data-slate-string="true"> {1..1000}; </span></span></span><span data-slate-object="text" data-key="5705"><span data-slate-leaf="true" data-offset-key="5705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">do</span></span></span></span><span data-slate-object="text" data-key="5706"><span data-slate-leaf="true" data-offset-key="5706:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5707"><span data-slate-leaf="true" data-offset-key="5707:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">dd</span></span></span></span><span data-slate-object="text" data-key="5708"><span data-slate-leaf="true" data-offset-key="5708:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5709"><span data-slate-leaf="true" data-offset-key="5709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5710"><span data-slate-leaf="true" data-offset-key="5710:0" data-first-offset="true"><span data-slate-string="true">=/dev/urandom bs=1024 </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5711"><span data-slate-object="text" data-key="5712"><span data-slate-leaf="true" data-offset-key="5712:0" data-first-offset="true"><span data-slate-string="true">count=1024  | ETCDCTL_API=3 etcdctl put key  || </span></span></span><span data-slate-object="text" data-key="5713"><span data-slate-leaf="true" data-offset-key="5713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">break</span></span></span></span><span data-slate-object="text" data-key="5714"><span data-slate-leaf="true" data-offset-key="5714:0" data-first-offset="true"><span data-slate-string="true">; </span></span></span><span data-slate-object="text" data-key="5715"><span data-slate-leaf="true" data-offset-key="5715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">done</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5716"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5717"><span data-slate-object="text" data-key="5718"><span data-slate-leaf="true" data-offset-key="5718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 获取最新 revision，并压缩</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5719"><span data-slate-object="text" data-key="5720"><span data-slate-leaf="true" data-offset-key="5720:0" data-first-offset="true"><span data-slate-string="true">etcdctl compact `(etcdctl endpoint status --write-out=</span></span></span><span data-slate-object="text" data-key="5721"><span data-slate-leaf="true" data-offset-key="5721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"json"</span></span></span></span><span data-slate-object="text" data-key="5722"><span data-slate-leaf="true" data-offset-key="5722:0" data-first-offset="true"><span data-slate-string="true"> | egrep -o </span></span></span><span data-slate-object="text" data-key="5723"><span data-slate-leaf="true" data-offset-key="5723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'"revision":[0-9]*'</span></span></span></span><span data-slate-object="text" data-key="5724"><span data-slate-leaf="true" data-offset-key="5724:0" data-first-offset="true"><span data-slate-string="true"> | egrep -o </span></span></span><span data-slate-object="text" data-key="5725"><span data-slate-leaf="true" data-offset-key="5725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">'[0-9].*'</span></span></span></span><span data-slate-object="text" data-key="5726"><span data-slate-leaf="true" data-offset-key="5726:0" data-first-offset="true"><span data-slate-string="true">)`</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5727"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5728"><span data-slate-object="text" data-key="5729"><span data-slate-leaf="true" data-offset-key="5729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"># 对集群所有节点进行碎片整理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5730"><span data-slate-object="text" data-key="5731"><span data-slate-leaf="true" data-offset-key="5731:0" data-first-offset="true"><span data-slate-string="true">etcdctl defrag --cluster</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5732"><span data-slate-object="text" data-key="5733"><span data-slate-leaf="true" data-offset-key="5733:0" data-first-offset="true"><span data-slate-string="true">在执行操作前，空集群 etcd db size 20KB，etcd 进程内存 36M 左右，分别如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5734"><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/c1/e6/c1fb89ae1d6218a66cf1db30c41d9be6.png?wh=1164*358"></div></div><div data-slate-type="image" data-slate-object="block" data-key="5735"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/6c/6d/6ce074583f39cd9a19bdcb392133426d.png?wh=1318*420"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5736"><span data-slate-object="text" data-key="5737"><span data-slate-leaf="true" data-offset-key="5737:0" data-first-offset="true"><span data-slate-string="true">你预测执行 1000 次同样 key 更新后，etcd 进程占用了多少内存呢？约 37M？ 1G？ 2G？3G？ 还是其他呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5738"><span data-slate-object="text" data-key="5739"><span data-slate-leaf="true" data-offset-key="5739:0" data-first-offset="true"><span data-slate-string="true">执行 1000 次的 put 操作后，db 大小和 etcd 内存占用分别如下图所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5740"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/d6/45/d6dc86f76f52dfed73ab1771ebbbf545.png?wh=1302*348"></div></div><div data-slate-type="image" data-slate-object="block" data-key="5741"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/9d/70/9d97762851c18a0c4cd89aa5a7bb0270.png?wh=1310*404"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5742"><span data-slate-object="text" data-key="5743"><span data-slate-leaf="true" data-offset-key="5743:0" data-first-offset="true"><span data-slate-string="true">当我们执行 compact、defrag 命令后，如下图所示，db 大小只有 1M 左右，但是你会发现 etcd 进程实际却仍占用了 2G 左右内存。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5744"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/93/bd/937c3fb0bf12595928e8ae4b05b7a5bd.png?wh=1260*354"></div></div><div data-slate-type="image" data-slate-object="block" data-key="5745"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/8d/58/8d2d9fb3c0193745d80fe68b0cb4a758.png?wh=1276*406"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5746"><span data-slate-object="text" data-key="5747"><span data-slate-leaf="true" data-offset-key="5747:0" data-first-offset="true"><span data-slate-string="true">整个集群只有一个 key，为什么 etcd 占用了这么多的内存呢？是 etcd 发生了内存泄露吗？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5748" id="sr-toc-3"><span data-slate-object="text" data-key="5749"><span data-slate-leaf="true" data-offset-key="5749:0" data-first-offset="true"><span data-slate-string="true">raftLog</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5750"><span data-slate-object="text" data-key="5751"><span data-slate-leaf="true" data-offset-key="5751:0" data-first-offset="true"><span data-slate-string="true">当你发起一个 put 请求的时候，etcd 需通过 Raft 模块将此请求同步到其他节点，详细流程你可结合下图再次了解下。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5752"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/df/2c/df9yy18a1e28e18295cfc15a28cd342c.png?wh=1920*1328"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5753"><span data-slate-object="text" data-key="5754"><span data-slate-leaf="true" data-offset-key="5754:0" data-first-offset="true"><span data-slate-string="true">从图中你可以看到，Raft 模块的输入是一个消息 /Msg，输出统一为 Ready 结构。etcd 会把此请求封装成一个消息，提交到 Raft 模块。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5755"><span data-slate-object="text" data-key="5756"><span data-slate-leaf="true" data-offset-key="5756:0" data-first-offset="true"><span data-slate-string="true">Raft 模块收到此请求后，会把此消息追加到 raftLog 的 unstable 存储的 entry 内存数组中（图中流程 2），并且将待持久化的此消息封装到 Ready 结构内，通过管道通知到 etcdserver（图中流程 3）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5757"><span data-slate-object="text" data-key="5758"><span data-slate-leaf="true" data-offset-key="5758:0" data-first-offset="true"><span data-slate-string="true">etcdserver 取出消息，持久化到 WAL 中，并追加到 raftLog 的内存存储 storage 的 entry 数组中（图中流程 5）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5759"><span data-slate-object="text" data-key="5760"><span data-slate-leaf="true" data-offset-key="5760:0" data-first-offset="true"><span data-slate-string="true">下面是 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5761"><span data-slate-object="text" data-key="5762"><span data-slate-leaf="true" data-offset-key="5762:0" data-first-offset="true"><span data-slate-string="true">raftLog</span></span></span></a><span data-slate-object="text" data-key="5763"><span data-slate-leaf="true" data-offset-key="5763:0" data-first-offset="true"><span data-slate-string="true"> 的核心数据结构，它由 storage、unstable、committed、applied 等组成。storage 存储已经持久化到 WAL 中的日志条目，unstable 存储未持久化的条目和快照，一旦持久化会及时删除日志条目，因此不存在过多内存占用的问题。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5764"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5765"><span data-slate-object="text" data-key="5766"><span data-slate-leaf="true" data-offset-key="5766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="5767"><span data-slate-leaf="true" data-offset-key="5767:0" data-first-offset="true"><span data-slate-string="true"> raftLog </span></span></span><span data-slate-object="text" data-key="5768"><span data-slate-leaf="true" data-offset-key="5768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5769"><span data-slate-leaf="true" data-offset-key="5769:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5770"><span data-slate-object="text" data-key="5771"><span data-slate-leaf="true" data-offset-key="5771:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5772"><span data-slate-leaf="true" data-offset-key="5772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// storage contains all stable entries since the last snapshot.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5773"><span data-slate-object="text" data-key="5774"><span data-slate-leaf="true" data-offset-key="5774:0" data-first-offset="true"><span data-slate-string="true">   storage Storage</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5775"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5776"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5777"><span data-slate-object="text" data-key="5778"><span data-slate-leaf="true" data-offset-key="5778:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5779"><span data-slate-leaf="true" data-offset-key="5779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// unstable contains all unstable entries and snapshot.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5780"><span data-slate-object="text" data-key="5781"><span data-slate-leaf="true" data-offset-key="5781:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5782"><span data-slate-leaf="true" data-offset-key="5782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// they will be saved into storage.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5783"><span data-slate-object="text" data-key="5784"><span data-slate-leaf="true" data-offset-key="5784:0" data-first-offset="true"><span data-slate-string="true">   unstable unstable</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5785"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5786"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5787"><span data-slate-object="text" data-key="5788"><span data-slate-leaf="true" data-offset-key="5788:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5789"><span data-slate-leaf="true" data-offset-key="5789:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// committed is the highest log position that is known to be in</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5790"><span data-slate-object="text" data-key="5791"><span data-slate-leaf="true" data-offset-key="5791:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5792"><span data-slate-leaf="true" data-offset-key="5792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// stable storage on a quorum of nodes.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5793"><span data-slate-object="text" data-key="5794"><span data-slate-leaf="true" data-offset-key="5794:0" data-first-offset="true"><span data-slate-string="true">   committed </span></span></span><span data-slate-object="text" data-key="5795"><span data-slate-leaf="true" data-offset-key="5795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5796"><span data-slate-object="text" data-key="5797"><span data-slate-leaf="true" data-offset-key="5797:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5798"><span data-slate-leaf="true" data-offset-key="5798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// applied is the highest log position that the application has</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5799"><span data-slate-object="text" data-key="5800"><span data-slate-leaf="true" data-offset-key="5800:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5801"><span data-slate-leaf="true" data-offset-key="5801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// been instructed to apply to its state machine.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5802"><span data-slate-object="text" data-key="5803"><span data-slate-leaf="true" data-offset-key="5803:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5804"><span data-slate-leaf="true" data-offset-key="5804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Invariant: applied &lt;= committed</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5805"><span data-slate-object="text" data-key="5806"><span data-slate-leaf="true" data-offset-key="5806:0" data-first-offset="true"><span data-slate-string="true">   applied </span></span></span><span data-slate-object="text" data-key="5807"><span data-slate-leaf="true" data-offset-key="5807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5808"><span data-slate-object="text" data-key="5809"><span data-slate-leaf="true" data-offset-key="5809:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5810"><span data-slate-object="text" data-key="5811"><span data-slate-leaf="true" data-offset-key="5811:0" data-first-offset="true"><span data-slate-string="true">从上面 raftLog 结构体中，你可以看到，存储稳定的日志条目的 storage 类型是 Storage，Storage 定义了存储 Raft 日志条目的核心 API 接口，业务应用层可根据实际场景进行定制化实现。etcd 使用的是 Raft 算法库本身提供的 MemoryStorage，其定义如下，核心是使用了一个数组来存储已经持久化后的日志条目。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5812"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5813"><span data-slate-object="text" data-key="5814"><span data-slate-leaf="true" data-offset-key="5814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// MemoryStorage implements the Storage interface backed</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5815"><span data-slate-object="text" data-key="5816"><span data-slate-leaf="true" data-offset-key="5816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// by an in-memory array.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5817"><span data-slate-object="text" data-key="5818"><span data-slate-leaf="true" data-offset-key="5818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="5819"><span data-slate-leaf="true" data-offset-key="5819:0" data-first-offset="true"><span data-slate-string="true"> MemoryStorage </span></span></span><span data-slate-object="text" data-key="5820"><span data-slate-leaf="true" data-offset-key="5820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5821"><span data-slate-leaf="true" data-offset-key="5821:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5822"><span data-slate-object="text" data-key="5823"><span data-slate-leaf="true" data-offset-key="5823:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5824"><span data-slate-leaf="true" data-offset-key="5824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Protects access to all fields. Most methods of MemoryStorage are</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5825"><span data-slate-object="text" data-key="5826"><span data-slate-leaf="true" data-offset-key="5826:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5827"><span data-slate-leaf="true" data-offset-key="5827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// run on the raft goroutine， but Append() is run on an application</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5828"><span data-slate-object="text" data-key="5829"><span data-slate-leaf="true" data-offset-key="5829:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5830"><span data-slate-leaf="true" data-offset-key="5830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// goroutine.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5831"><span data-slate-object="text" data-key="5832"><span data-slate-leaf="true" data-offset-key="5832:0" data-first-offset="true"><span data-slate-string="true">   sync.Mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5833"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5834"><span data-slate-object="text" data-key="5835"><span data-slate-leaf="true" data-offset-key="5835:0" data-first-offset="true"><span data-slate-string="true">   hardState pb.HardState</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5836"><span data-slate-object="text" data-key="5837"><span data-slate-leaf="true" data-offset-key="5837:0" data-first-offset="true"><span data-slate-string="true">   snapshot  pb.Snapshot</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5838"><span data-slate-object="text" data-key="5839"><span data-slate-leaf="true" data-offset-key="5839:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="5840"><span data-slate-leaf="true" data-offset-key="5840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ents[i] has raftLog position i+snapshot.Metadata.Index</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5841"><span data-slate-object="text" data-key="5842"><span data-slate-leaf="true" data-offset-key="5842:0" data-first-offset="true"><span data-slate-string="true">   ents []pb.Entry</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5843"><span data-slate-object="text" data-key="5844"><span data-slate-leaf="true" data-offset-key="5844:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5845"><span data-slate-object="text" data-key="5846"><span data-slate-leaf="true" data-offset-key="5846:0" data-first-offset="true"><span data-slate-string="true">那么随着写请求增多，内存中保留的 Raft 日志条目会越来越多，如何防止 etcd 出现 OOM 呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5847"><span data-slate-object="text" data-key="5848"><span data-slate-leaf="true" data-offset-key="5848:0" data-first-offset="true"><span data-slate-string="true">etcd 提供了快照和压缩功能来解决这个问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5849"><span data-slate-object="text" data-key="5850"><span data-slate-leaf="true" data-offset-key="5850:0" data-first-offset="true"><span data-slate-string="true">首先你可以通过调整 --snapshot-count 参数来控制生成快照的频率，其值默认是 100000（etcd v3.4.9，早期 etcd 版本是 10000），也就是每 10 万个写请求触发一次快照生成操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5851"><span data-slate-object="text" data-key="5852"><span data-slate-leaf="true" data-offset-key="5852:0" data-first-offset="true"><span data-slate-string="true">快照生成完之后，etcd 会通过压缩来删除旧的日志条目。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5853"><span data-slate-object="text" data-key="5854"><span data-slate-leaf="true" data-offset-key="5854:0" data-first-offset="true"><span data-slate-string="true">那么是全部删除日志条目还是保留一小部分呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5855"><span data-slate-object="text" data-key="5856"><span data-slate-leaf="true" data-offset-key="5856:0" data-first-offset="true"><span data-slate-string="true">答案是保留一小部分 Raft 日志条目。数量由 DefaultSnapshotCatchUpEntries 参数控制，默认 5000，目前不支持自定义配置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5857"><span data-slate-object="text" data-key="5858"><span data-slate-leaf="true" data-offset-key="5858:0" data-first-offset="true"><span data-slate-string="true">保留一小部分日志条目其实是为了帮助慢的 Follower 以较低的开销向 Leader 获取 Raft 日志条目，以尽快追上 Leader 进度。若 raftLog 中不保留任何日志条目，就只能发送快照给慢的 Follower，这开销就非常大了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5859"><span data-slate-object="text" data-key="5860"><span data-slate-leaf="true" data-offset-key="5860:0" data-first-offset="true"><span data-slate-string="true">通过以上分析可知，如果你的请求 key-value 比较大，比如上面我们的案例中是 1M，1000 次修改，那么 etcd raftLog 至少会消耗 1G 的内存。这就是为什么内存随着写请求修改次数不断增长的原因。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5861"><span data-slate-object="text" data-key="5862"><span data-slate-leaf="true" data-offset-key="5862:0" data-first-offset="true"><span data-slate-string="true">除了 raftLog 占用内存外，MVCC 模块的 treeIndex/boltdb 模块又是如何使用内存的呢？</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5863" id="sr-toc-4"><span data-slate-object="text" data-key="5864"><span data-slate-leaf="true" data-offset-key="5864:0" data-first-offset="true"><span data-slate-string="true">treeIndex</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5865"><span data-slate-object="text" data-key="5866"><span data-slate-leaf="true" data-offset-key="5866:0" data-first-offset="true"><span data-slate-string="true">一个 put 写请求的日志条目被集群多数节点确认提交后，这时 etcdserver 就会从 Raft 模块获取已提交的日志条目，应用到 MVCC 模块的 treeIndex 和 boltdb。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5867"><span data-slate-object="text" data-key="5868"><span data-slate-leaf="true" data-offset-key="5868:0" data-first-offset="true"><span data-slate-string="true">我们知道 treeIndex 是基于 google 内存 btree 库实现的一个索引管理模块，在 etcd 中每个 key 都会在 treeIndex 中保存一个索引项 (keyIndex)，记录你的 key 和版本号等信息，如下面的数据结构所示。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5869"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5870"><span data-slate-object="text" data-key="5871"><span data-slate-leaf="true" data-offset-key="5871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="5872"><span data-slate-leaf="true" data-offset-key="5872:0" data-first-offset="true"><span data-slate-string="true"> keyIndex </span></span></span><span data-slate-object="text" data-key="5873"><span data-slate-leaf="true" data-offset-key="5873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5874"><span data-slate-leaf="true" data-offset-key="5874:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5875"><span data-slate-object="text" data-key="5876"><span data-slate-leaf="true" data-offset-key="5876:0" data-first-offset="true"><span data-slate-string="true">   key         []</span></span></span><span data-slate-object="text" data-key="5877"><span data-slate-leaf="true" data-offset-key="5877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">byte</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5878"><span data-slate-object="text" data-key="5879"><span data-slate-leaf="true" data-offset-key="5879:0" data-first-offset="true"><span data-slate-string="true">   modified    revision </span></span></span><span data-slate-object="text" data-key="5880"><span data-slate-leaf="true" data-offset-key="5880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// the main rev of the last modification</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5881"><span data-slate-object="text" data-key="5882"><span data-slate-leaf="true" data-offset-key="5882:0" data-first-offset="true"><span data-slate-string="true">   generations []generation</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5883"><span data-slate-object="text" data-key="5884"><span data-slate-leaf="true" data-offset-key="5884:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5885"><span data-slate-object="text" data-key="5886"><span data-slate-leaf="true" data-offset-key="5886:0" data-first-offset="true"><span data-slate-string="true">同时，你每次对 key 的修改、删除操作都会在 key 的索引项中追加一条修改记录 (revision)。因此，随着修改次数的增加，etcd 内存会一直增加。那么如何清理旧版本，防止过多的内存占用呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5887"><span data-slate-object="text" data-key="5888"><span data-slate-leaf="true" data-offset-key="5888:0" data-first-offset="true"><span data-slate-string="true">答案也是压缩。正如我在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5889"><span data-slate-object="text" data-key="5890"><span data-slate-leaf="true" data-offset-key="5890:0" data-first-offset="true"><span data-slate-string="true">11</span></span></span></a><span data-slate-object="text" data-key="5891"><span data-slate-leaf="true" data-offset-key="5891:0" data-first-offset="true"><span data-slate-string="true"> 压缩篇和你介绍的，当你执行 compact 命令时，etcd 会遍历 treeIndex 中的各个 keyIndex，清理历史版本号记录与已删除的 key，释放内存。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5892"><span data-slate-object="text" data-key="5893"><span data-slate-leaf="true" data-offset-key="5893:0" data-first-offset="true"><span data-slate-string="true">从上面的 keyIndex 数据结构我们可知，一个 key 的索引项内存开销跟你的 key 大小、保存的历史版本数、compact 策略有关。为了避免内存索引项占用过多的内存，key 的长度不应过长，同时你需要配置好合理的压缩策略。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5894" id="sr-toc-5"><span data-slate-object="text" data-key="5895"><span data-slate-leaf="true" data-offset-key="5895:0" data-first-offset="true"><span data-slate-string="true">boltdb</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5896"><span data-slate-object="text" data-key="5897"><span data-slate-leaf="true" data-offset-key="5897:0" data-first-offset="true"><span data-slate-string="true">在 treeIndex 模块中创建、更新完 keyIndex 数据结构后，你的 key-value 数据、各种版本号、lease 等相关信息会保存到如下的一个 mvccpb.keyValue 结构体中。它是 boltdb 的 value，key 则是 treeIndex 中保存的版本号，然后通过 boltdb 的写接口保存到 db 文件中。</span></span></span></div><div data-code-language="css" data-slate-type="pre" data-slate-object="block" data-key="5898"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5899"><span data-slate-object="text" data-key="5900"><span data-slate-leaf="true" data-offset-key="5900:0" data-first-offset="true"><span data-slate-string="true">kv := mvccpb.KeyValue{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5901"><span data-slate-object="text" data-key="5902"><span data-slate-leaf="true" data-offset-key="5902:0" data-first-offset="true"><span data-slate-string="true">   Key:            key，</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5903"><span data-slate-object="text" data-key="5904"><span data-slate-leaf="true" data-offset-key="5904:0" data-first-offset="true"><span data-slate-string="true">   Value:          value，</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5905"><span data-slate-object="text" data-key="5906"><span data-slate-leaf="true" data-offset-key="5906:0" data-first-offset="true"><span data-slate-string="true">   CreateRevision: c，</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5907"><span data-slate-object="text" data-key="5908"><span data-slate-leaf="true" data-offset-key="5908:0" data-first-offset="true"><span data-slate-string="true">   ModRevision:    rev，</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5909"><span data-slate-object="text" data-key="5910"><span data-slate-leaf="true" data-offset-key="5910:0" data-first-offset="true"><span data-slate-string="true">   Version:        ver，</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5911"><span data-slate-object="text" data-key="5912"><span data-slate-leaf="true" data-offset-key="5912:0" data-first-offset="true"><span data-slate-string="true">   Lease:          </span></span></span><span data-slate-object="text" data-key="5913"><span data-slate-leaf="true" data-offset-key="5913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="5914"><span data-slate-leaf="true" data-offset-key="5914:0" data-first-offset="true"><span data-slate-string="true">(leaseID)，</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5915"><span data-slate-object="text" data-key="5916"><span data-slate-leaf="true" data-offset-key="5916:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5917"><span data-slate-object="text" data-key="5918"><span data-slate-leaf="true" data-offset-key="5918:0" data-first-offset="true"><span data-slate-string="true">前面我们在介绍 boltdb 时，提到过 etcd 在启动时会通过 mmap 机制，将 etcd db 文件映射到 etcd 进程地址空间，并设置 mmap 的 MAP_POPULATE flag，它会告诉 Linux 内核预读文件，让 Linux 内核将文件内容拷贝到物理内存中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5919"><span data-slate-object="text" data-key="5920"><span data-slate-leaf="true" data-offset-key="5920:0" data-first-offset="true"><span data-slate-string="true">在节点内存足够的情况下，后续读请求可直接从内存中获取。相比 read 系统调用，mmap 少了一次从 page cache 拷贝到进程内存地址空间的操作，因此具备更好的性能。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5921"><span data-slate-object="text" data-key="5922"><span data-slate-leaf="true" data-offset-key="5922:0" data-first-offset="true"><span data-slate-string="true">若 etcd 节点内存不足，可能会导致 db 文件对应的内存页被换出。当读请求命中的页未在内存中时，就会产生缺页异常，导致读过程中产生磁盘 IO。这样虽然避免了 etcd 进程 OOM，但是此过程会产生较大的延时。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5923"><span data-slate-object="text" data-key="5924"><span data-slate-leaf="true" data-offset-key="5924:0" data-first-offset="true"><span data-slate-string="true">从以上 boltdb 的 key-value 和 mmap 机制介绍中我们可知，我们应控制 boltdb 文件大小，优化 key-value 大小，配置合理的压缩策略，回收旧版本，避免过多内存占用。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5925" id="sr-toc-6"><span data-slate-object="text" data-key="5926"><span data-slate-leaf="true" data-offset-key="5926:0" data-first-offset="true"><span data-slate-string="true">watcher</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5927"><span data-slate-object="text" data-key="5928"><span data-slate-leaf="true" data-offset-key="5928:0" data-first-offset="true"><span data-slate-string="true">在你写入 key 的时候，其他 client 还可通过 etcd 的 Watch 监听机制，获取到 key 的变化事件。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5929"><span data-slate-object="text" data-key="5930"><span data-slate-leaf="true" data-offset-key="5930:0" data-first-offset="true"><span data-slate-string="true">那创建一个 watcher 耗费的内存跟哪些因素有关呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5931"><span data-slate-object="text" data-key="5932"><span data-slate-leaf="true" data-offset-key="5932:0" data-first-offset="true"><span data-slate-string="true">在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5933"><span data-slate-object="text" data-key="5934"><span data-slate-leaf="true" data-offset-key="5934:0" data-first-offset="true"><span data-slate-string="true">08</span></span></span></a><span data-slate-object="text" data-key="5935"><span data-slate-leaf="true" data-offset-key="5935:0" data-first-offset="true"><span data-slate-string="true">Watch 机制设计与实现分析中，我和你介绍过创建 watcher 的整体流程与架构，如下图所示。当你创建一个 watcher 时，client 与 server 建立连接后，会创建一个 gRPC Watch Stream，随后通过这个 gRPC Watch Stream 发送创建 watcher 请求。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5936"><span data-slate-object="text" data-key="5937"><span data-slate-leaf="true" data-offset-key="5937:0" data-first-offset="true"><span data-slate-string="true">每个 gRPC Watch Stream 中 etcd WatchServer 会分配两个 goroutine 处理，一个是 sendLoop，它负责 Watch 事件的推送。一个是 recvLoop，负责接收 client 的创建、取消 watcher 请求消息。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5938"><span data-slate-object="text" data-key="5939"><span data-slate-leaf="true" data-offset-key="5939:0" data-first-offset="true"><span data-slate-string="true">同时对每个 watcher 来说，etcd 的 WatchableKV 模块需将其保存到相应的内存管理数据结构中，实现可靠的 Watch 事件推送。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5940"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/42/bf/42575d8d0a034e823b8e48d4ca0a49bf.png?wh=1920*1075"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5941"><span data-slate-object="text" data-key="5942"><span data-slate-leaf="true" data-offset-key="5942:0" data-first-offset="true"><span data-slate-string="true">因此 watch 监听机制耗费的内存跟 client 连接数、gRPC Stream、watcher 数 (watching) 有关，如下面公式所示：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5943"><div data-slate-type="list-line" data-slate-object="block" data-key="5944"><span data-slate-object="text" data-key="5945"><span data-slate-leaf="true" data-offset-key="5945:0" data-first-offset="true"><span data-slate-string="true">c1 表示每个连接耗费的内存；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5946"><span data-slate-object="text" data-key="5947"><span data-slate-leaf="true" data-offset-key="5947:0" data-first-offset="true"><span data-slate-string="true">c2 表示每个 gRPC Stream 耗费的内存；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5948"><span data-slate-object="text" data-key="5949"><span data-slate-leaf="true" data-offset-key="5949:0" data-first-offset="true"><span data-slate-string="true">c3 表示每个 watcher 耗费的内存。</span></span></span></div></div><div data-slate-type="pre" data-slate-object="block" data-key="5950"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5951"><span data-slate-object="text" data-key="5952"><span data-slate-leaf="true" data-offset-key="5952:0" data-first-offset="true"><span data-slate-string="true">memory = c1 * number_of_conn + c2 * </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5953"><span data-slate-object="text" data-key="5954"><span data-slate-leaf="true" data-offset-key="5954:0" data-first-offset="true"><span data-slate-string="true">avg_number_of_stream_per_conn + c3 * </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5955"><span data-slate-object="text" data-key="5956"><span data-slate-leaf="true" data-offset-key="5956:0" data-first-offset="true"><span data-slate-string="true">avg_number_of_watch_stream</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5957"><span data-slate-object="text" data-key="5958"><span data-slate-leaf="true" data-offset-key="5958:0" data-first-offset="true"><span data-slate-string="true">根据 etcd 社区的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5959"><span data-slate-object="text" data-key="5960"><span data-slate-leaf="true" data-offset-key="5960:0" data-first-offset="true"><span data-slate-string="true">压测报告</span></span></span></a><span data-slate-object="text" data-key="5961"><span data-slate-leaf="true" data-offset-key="5961:0" data-first-offset="true"><span data-slate-string="true">，大概估算出 Watch 机制中 c1、c2、c3 占用的内存分别如下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="5962"><div data-slate-type="list-line" data-slate-object="block" data-key="5963"><span data-slate-object="text" data-key="5964"><span data-slate-leaf="true" data-offset-key="5964:0" data-first-offset="true"><span data-slate-string="true">每个 client 连接消耗大约 17kb 的内存 (c1)；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5965"><span data-slate-object="text" data-key="5966"><span data-slate-leaf="true" data-offset-key="5966:0" data-first-offset="true"><span data-slate-string="true">每个 gRPC Stream 消耗大约 18kb 的内存 (c2)；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="5967"><span data-slate-object="text" data-key="5968"><span data-slate-leaf="true" data-offset-key="5968:0" data-first-offset="true"><span data-slate-string="true">每个 watcher 消耗大约 350 个字节 (c3)；</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5969"><span data-slate-object="text" data-key="5970"><span data-slate-leaf="true" data-offset-key="5970:0" data-first-offset="true"><span data-slate-string="true">当你的业务场景大量使用 watcher 的时候，应提前估算下内存容量大小，选择合适的内存配置节点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5971"><span data-slate-object="text" data-key="5972"><span data-slate-leaf="true" data-offset-key="5972:0" data-first-offset="true"><span data-slate-string="true">注意以上估算并不包括 watch 事件堆积的开销。变更事件较多，服务端、客户端高负载，网络阻塞等情况都可能导致事件堆积。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5973"><span data-slate-object="text" data-key="5974"><span data-slate-leaf="true" data-offset-key="5974:0" data-first-offset="true"><span data-slate-string="true">在 etcd 3.4.9 版本中，每个 watcher 默认 buffer 是 1024。buffer 内保存 watch 响应结果，如 watchID、watch 事件（watch 事件包含 key、value）等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5975"><span data-slate-object="text" data-key="5976"><span data-slate-leaf="true" data-offset-key="5976:0" data-first-offset="true"><span data-slate-string="true">若大量事件堆积，将产生较高昂的内存的开销。你可以通过 etcd_debugging_mvcc_pending_events_total 指标监控堆积的事件数，etcd_debugging_slow_watcher_total 指标监控慢的 watcher 数，来及时发现异常。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5977" id="sr-toc-7"><span data-slate-object="text" data-key="5978"><span data-slate-leaf="true" data-offset-key="5978:0" data-first-offset="true"><span data-slate-string="true">expensive request</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5979"><span data-slate-object="text" data-key="5980"><span data-slate-leaf="true" data-offset-key="5980:0" data-first-offset="true"><span data-slate-string="true">当你写入比较大的 key-value 后，如果 client 频繁查询它，也会产生高昂的内存开销。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5981"><span data-slate-object="text" data-key="5982"><span data-slate-leaf="true" data-offset-key="5982:0" data-first-offset="true"><span data-slate-string="true">假设我们写入了 100 个这样 1M 大小的 key， 通过 Range 接口一次查询 100 个 key， 那么 boltdb 遍历、反序列化过程将花费至少 100MB 的内存。如下面代码所示，它会遍历整个 key-value，将 key-value 保存到数组 kvs 中。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="5983"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5984"><span data-slate-object="text" data-key="5985"><span data-slate-leaf="true" data-offset-key="5985:0" data-first-offset="true"><span data-slate-string="true">kvs := </span></span></span><span data-slate-object="text" data-key="5986"><span data-slate-leaf="true" data-offset-key="5986:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="5987"><span data-slate-leaf="true" data-offset-key="5987:0" data-first-offset="true"><span data-slate-string="true">([]mvccpb.KeyValue， limit)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5988"><span data-slate-object="text" data-key="5989"><span data-slate-leaf="true" data-offset-key="5989:0" data-first-offset="true"><span data-slate-string="true">revBytes := newRevBytes()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5990"><span data-slate-object="text" data-key="5991"><span data-slate-leaf="true" data-offset-key="5991:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5992"><span data-slate-leaf="true" data-offset-key="5992:0" data-first-offset="true"><span data-slate-string="true"> i， revpair := </span></span></span><span data-slate-object="text" data-key="5993"><span data-slate-leaf="true" data-offset-key="5993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="5994"><span data-slate-leaf="true" data-offset-key="5994:0" data-first-offset="true"><span data-slate-string="true"> revpairs[:</span></span></span><span data-slate-object="text" data-key="5995"><span data-slate-leaf="true" data-offset-key="5995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="5996"><span data-slate-leaf="true" data-offset-key="5996:0" data-first-offset="true"><span data-slate-string="true">(kvs)] {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5997"><span data-slate-object="text" data-key="5998"><span data-slate-leaf="true" data-offset-key="5998:0" data-first-offset="true"><span data-slate-string="true">   revToBytes(revpair， revBytes)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5999"><span data-slate-object="text" data-key="6000"><span data-slate-leaf="true" data-offset-key="6000:0" data-first-offset="true"><span data-slate-string="true">   _， vs := tr.tx.UnsafeRange(keyBucketName， revBytes， </span></span></span><span data-slate-object="text" data-key="6001"><span data-slate-leaf="true" data-offset-key="6001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6002"><span data-slate-leaf="true" data-offset-key="6002:0" data-first-offset="true"><span data-slate-string="true">， </span></span></span><span data-slate-object="text" data-key="6003"><span data-slate-leaf="true" data-offset-key="6003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6004"><span data-slate-leaf="true" data-offset-key="6004:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6005"><span data-slate-object="text" data-key="6006"><span data-slate-leaf="true" data-offset-key="6006:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6007"><span data-slate-leaf="true" data-offset-key="6007:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6008"><span data-slate-leaf="true" data-offset-key="6008:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6009"><span data-slate-leaf="true" data-offset-key="6009:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">len</span></span></span></span><span data-slate-object="text" data-key="6010"><span data-slate-leaf="true" data-offset-key="6010:0" data-first-offset="true"><span data-slate-string="true">(vs) != </span></span></span><span data-slate-object="text" data-key="6011"><span data-slate-leaf="true" data-offset-key="6011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="6012"><span data-slate-leaf="true" data-offset-key="6012:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6013"><span data-slate-object="text" data-key="6014"><span data-slate-leaf="true" data-offset-key="6014:0" data-first-offset="true"><span data-slate-string="true">        ......    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6015"><span data-slate-object="text" data-key="6016"><span data-slate-leaf="true" data-offset-key="6016:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6017"><span data-slate-object="text" data-key="6018"><span data-slate-leaf="true" data-offset-key="6018:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="6019"><span data-slate-leaf="true" data-offset-key="6019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="6020"><span data-slate-leaf="true" data-offset-key="6020:0" data-first-offset="true"><span data-slate-string="true"> err := kvs[i].Unmarshal(vs[</span></span></span><span data-slate-object="text" data-key="6021"><span data-slate-leaf="true" data-offset-key="6021:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="6022"><span data-slate-leaf="true" data-offset-key="6022:0" data-first-offset="true"><span data-slate-string="true">]); err != </span></span></span><span data-slate-object="text" data-key="6023"><span data-slate-leaf="true" data-offset-key="6023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="6024"><span data-slate-leaf="true" data-offset-key="6024:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6025"><span data-slate-object="text" data-key="6026"><span data-slate-leaf="true" data-offset-key="6026:0" data-first-offset="true"><span data-slate-string="true">        .......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6027"><span data-slate-object="text" data-key="6028"><span data-slate-leaf="true" data-offset-key="6028:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6029"><span data-slate-object="text" data-key="6030"><span data-slate-leaf="true" data-offset-key="6030:0" data-first-offset="true"><span data-slate-string="true">也就是说，一次查询就耗费了至少 100MB 的内存、产生了至少 100MB 的流量，随着你 QPS 增大后，很容易 OOM、网卡出现丢包。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6031"><span data-slate-object="text" data-key="6032"><span data-slate-leaf="true" data-offset-key="6032:0" data-first-offset="true"><span data-slate-string="true">count-only、limit 查询在 key 百万级以上时，也会产生非常大的内存开销。因为它们在遍历 treeIndex 的过程中，会将相关 key 保存在数组里面。当 key 多时，此开销不容忽视。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6033"><span data-slate-object="text" data-key="6034"><span data-slate-leaf="true" data-offset-key="6034:0" data-first-offset="true"><span data-slate-string="true">正如我在 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6035"><span data-slate-object="text" data-key="6036"><span data-slate-leaf="true" data-offset-key="6036:0" data-first-offset="true"><span data-slate-string="true">13</span></span></span></a><span data-slate-object="text" data-key="6037"><span data-slate-leaf="true" data-offset-key="6037:0" data-first-offset="true"><span data-slate-string="true">  db 大小中讲到的，在 master 分支，我已提交相关 PR 解决 count-only 和 limit 查询导致内存占用突增的问题。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6038" id="sr-toc-8"><span data-slate-object="text" data-key="6039"><span data-slate-leaf="true" data-offset-key="6039:0" data-first-offset="true"><span data-slate-string="true">etcd v2/goroutines/bug</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6040"><span data-slate-object="text" data-key="6041"><span data-slate-leaf="true" data-offset-key="6041:0" data-first-offset="true"><span data-slate-string="true">除了以上介绍的核心模块、expensive request 场景可能导致较高的内存开销外，还有以下场景也会导致 etcd 内存使用较高。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6042"><span data-slate-object="text" data-key="6043"><span data-slate-leaf="true" data-offset-key="6043:0" data-first-offset="true"><span data-slate-string="true">首先是 </span></span></span><span data-slate-object="text" data-key="6044"><span data-slate-leaf="true" data-offset-key="6044:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">etcd 中使用了 v2 的 API 写入了大量的 key-value 数据</span></span></span></span><span data-slate-object="text" data-key="6045"><span data-slate-leaf="true" data-offset-key="6045:0" data-first-offset="true"><span data-slate-string="true">，这会导致内存飙高。我们知道 etcd v2 的 key-value 都是存储在内存树中的，同时 v2 的 watcher 不支持多路复用，内存开销相比 v3 多了一个数量级。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6046"><span data-slate-object="text" data-key="6047"><span data-slate-leaf="true" data-offset-key="6047:0" data-first-offset="true"><span data-slate-string="true">在 etcd 3.4 版本之前，etcd 默认同时支持 etcd v2/v3 API，etcd 3.4 版本默认关闭了 v2 API。 你可以通过 etcd v2 API 和 etcd v2 内存存储模块的 metrics 前缀 etcd_debugging_store，观察集群中是否有 v2 数据导致的内存占用高。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6048"><span data-slate-object="text" data-key="6049"><span data-slate-leaf="true" data-offset-key="6049:0" data-first-offset="true"><span data-slate-string="true">其次是 </span></span></span><span data-slate-object="text" data-key="6050"><span data-slate-leaf="true" data-offset-key="6050:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">goroutines 泄露</span></span></span></span><span data-slate-object="text" data-key="6051"><span data-slate-leaf="true" data-offset-key="6051:0" data-first-offset="true"><span data-slate-string="true">导致内存占用高。此问题可能会在容器化场景中遇到。etcd 在打印日志的时候，若出现阻塞则可能会导致 goroutine 阻塞并持续泄露，最终导致内存泄露。你可以通过观察、监控 go_goroutines 来发现这个问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6052"><span data-slate-object="text" data-key="6053"><span data-slate-leaf="true" data-offset-key="6053:0" data-first-offset="true"><span data-slate-string="true">最后是 </span></span></span><span data-slate-object="text" data-key="6054"><span data-slate-leaf="true" data-offset-key="6054:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">etcd bug</span></span></span></span><span data-slate-object="text" data-key="6055"><span data-slate-leaf="true" data-offset-key="6055:0" data-first-offset="true"><span data-slate-string="true"> 导致的内存泄露。当你基本排除以上场景导致的内存占用高后，则很可能是 etcd bug 导致的内存泄露。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6056"><span data-slate-object="text" data-key="6057"><span data-slate-leaf="true" data-offset-key="6057:0" data-first-offset="true"><span data-slate-string="true">比如早期 etcd clientv3 的 lease keepalive 租约频繁续期 bug，它会导致 Leader 高负载、内存泄露，此 bug 已在 3.2.24/3.3.9 版本中修复。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6058"><span data-slate-object="text" data-key="6059"><span data-slate-leaf="true" data-offset-key="6059:0" data-first-offset="true"><span data-slate-string="true">还有最近我修复的 etcd 3.4 版本的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="6060"><span data-slate-object="text" data-key="6061"><span data-slate-leaf="true" data-offset-key="6061:0" data-first-offset="true"><span data-slate-string="true">Follower 节点内存泄露</span></span></span></a><span data-slate-object="text" data-key="6062"><span data-slate-leaf="true" data-offset-key="6062:0" data-first-offset="true"><span data-slate-string="true">。具体表现是两个 Follower 节点内存一直升高，Leader 节点正常，已在 3.4.6 版本中修复。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6063"><span data-slate-object="text" data-key="6064"><span data-slate-leaf="true" data-offset-key="6064:0" data-first-offset="true"><span data-slate-string="true">若内存泄露并不是已知的 etcd bug 导致，那你可以开启 pprof， 尝试复现，通过分析 pprof heap 文件来确定消耗大量内存的模块和数据结构。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6065" id="sr-toc-9"><span data-slate-object="text" data-key="6066"><span data-slate-leaf="true" data-offset-key="6066:0" data-first-offset="true"><span data-slate-string="true">小节</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6067"><span data-slate-object="text" data-key="6068"><span data-slate-leaf="true" data-offset-key="6068:0" data-first-offset="true"><span data-slate-string="true">今天我通过一个写入 1MB  key 的实际案例，给你介绍了可能导致 etcd 内存占用高的核心数据结构、场景，同时我将可能导致内存占用较高的因素总结为了下面这幅图，你可以参考一下。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6069"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/aa/90/aaf7b4f5f6f568dc70c1a0964fb92790.png?wh=1920*684"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6070"><span data-slate-object="text" data-key="6071"><span data-slate-leaf="true" data-offset-key="6071:0" data-first-offset="true"><span data-slate-string="true">首先是 raftLog。为了帮助 slow Follower 同步数据，它至少要保留 5000 条最近收到的写请求在内存中。若你的 key 非常大，你更新 5000 次会产生较大的内存开销。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6072"><span data-slate-object="text" data-key="6073"><span data-slate-leaf="true" data-offset-key="6073:0" data-first-offset="true"><span data-slate-string="true">其次是 treeIndex。 每个 key-value 会在内存中保留一个索引项。索引项的开销跟 key 长度、保留的历史版本有关，你可以通过 compact 命令压缩。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6074"><span data-slate-object="text" data-key="6075"><span data-slate-leaf="true" data-offset-key="6075:0" data-first-offset="true"><span data-slate-string="true">然后是 boltdb。etcd 启动的时候，会通过 mmap 系统调用，将文件映射到虚拟内存中。你可以通过 compact 命令回收旧版本，defrag 命令进行碎片整理。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6076"><span data-slate-object="text" data-key="6077"><span data-slate-leaf="true" data-offset-key="6077:0" data-first-offset="true"><span data-slate-string="true">接着是 watcher。它的内存占用跟连接数、gRPC Watch Stream 数、watcher 数有关。watch 机制一个不可忽视的内存开销其实是事件堆积的占用缓存，你可以通过相关 metrics 及时发现堆积的事件以及 slow watcher。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6078"><span data-slate-object="text" data-key="6079"><span data-slate-leaf="true" data-offset-key="6079:0" data-first-offset="true"><span data-slate-string="true">最后我介绍了一些典型的场景导致的内存异常，如大包查询等 expensive request，etcd 中存储了 v2 API 写入的 key， goroutines 泄露以及 etcd lease bug 等。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6080"><span data-slate-object="text" data-key="6081"><span data-slate-leaf="true" data-offset-key="6081:0" data-first-offset="true"><span data-slate-string="true">希望今天的内容，能够帮助你从容应对 etcd 内存占用高的问题，合理配置你的集群，优化业务 expensive request，让 etcd 跑得更稳。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6082" id="sr-toc-10"><span data-slate-object="text" data-key="6083"><span data-slate-leaf="true" data-offset-key="6083:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6084"><span data-slate-object="text" data-key="6085"><span data-slate-leaf="true" data-offset-key="6085:0" data-first-offset="true"><span data-slate-string="true">在一个 key 使用数 G 内存的案例中，最后执行 compact 和 defrag 后的结果是 2G，为什么不是 1G 左右呢？在 macOS 下行为是否一样呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6086"><span data-slate-object="text" data-key="6087"><span data-slate-leaf="true" data-offset-key="6087:0" data-first-offset="true"><span data-slate-string="true">欢迎你动手做下这个小实验，分析下原因，分享你的观点。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6088"><span data-slate-object="text" data-key="6089"><span data-slate-leaf="true" data-offset-key="6089:0" data-first-offset="true"><span data-slate-string="true">感谢你的阅读，如果你认为这节课的内容有收获，也欢迎把它分享给你的朋友，谢谢。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>10</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png" style="width: auto;"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-11">精选留言 (7)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/e0/4e/c266bdb4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>[小狗]</span></div></div><div>大佬，我想阅读下 etcd 的源码，有什么建议吗？ 目前只是为了简历好看些，以后会深度学习下</div><div><p>作者回复：建议可以先从早期的 v2 代码看起，那时逻辑最简单，https://github.com/etcd-io/etcd/blob/release-0.4/server/v2/get_handler.go, 然后再看 etcd v3 的代码，在这个过程中，我给你几个小建议：
1. 抓住主次，比如核心读写流程是怎样的，忽略一些特殊细节
2. 看看测试用例如何使用核心模块的 API 的，比如 etcd v3 mvcc 的模块测试文件
https://github.com/etcd-io/etcd/blob/v3.4.9/mvcc/kv_test.go
3. 自己可动手写写源码分析
4. 自己多实践下，部署个单机 etcd 集群，至少要把 etcdctl 各个命令给操作下
5. 日志级别可以改成 debug, 更加方便观察</p></div><div><div>2021-03-24</div><div><div><i></i><span>3</span></div><div><i></i><span>10</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep075ibtmxMf3eOYlBJ96CE9TEelLUwePaLqp8M75gWHEcM3za0voylA0oe9y3NiaboPB891rypRt7w/132"></div></div><div><div><div><span>shuff1e</span></div></div><div>etcd v2 的 key-value 都是存储在内存树中，具体指的是什么呢</div><div><p>作者回复：是指 etcd v2 的 key-value 数据存储在内存中的，如果你 etcd v3 里面存储了大量的 etcd v2 key-value 数据，就会导致内存占用较高。
你可以参考下 etcd v2 store 的定义，etcd v2 的 key-value 数据就是直接存储在这个结构哈
https://github.com/etcd-io/etcd/blob/release-3.3/store/store.go#L73:L83</p></div><div><div>2021-02-22</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/a2/94/ae0a60d8.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 江山未</span></div></div><div>老师，想问下。工作中有用到 etcd，如果想通过看 etcd 源码提升了解的话，建议从哪里入手呢。
如果可能的话，也希望能像你一样，为社区做一些贡献。
直接从启动命令看下去吗？还有就是 treeindex 和 bbolt 有必要看吗。</div><div><p>作者回复：在上一个问题，我给了一些要点，建议可以先从早期的 v2 代码看起，那时逻辑最简单，https://github.com/etcd-io/etcd/blob/release-0.4/server/v2/get_handler.go, 然后再看 etcd v3 的代码，在这个过程中，我给你几个小建议：
1. 抓住主次，比如核心读写流程是怎样的，忽略一些特殊细节
2. 看看测试用例如何使用核心模块的 API 的，比如 etcd v3 mvcc 的模块测试文件
https://github.com/etcd-io/etcd/blob/v3.4.9/mvcc/kv_test.go
3. 自己可动手写写源码分析
4. 自己多实践下，部署个单机 etcd 集群，至少要把 etcdctl 各个命令给操作下
5. 日志级别可以改成 debug, 更加方便观察
如果给社区做贡献，可以多关注下社区正在讨论的 issue 和 PR，寻找切入点，比如文档完善、拼写错误、不稳定的测试用例修复等开始，有时候大家会标注 label help wanted, https://github.com/etcd-io/etcd/issues?q=is%3Aopen+is%3Aissue+label%3A%22Help+Wanted%22

treeIndex 核心是 btree,boltdb 核心是 b+ tree, 早期不建议你看，了解它的功能即可，当你对 etcd 有一定掌握后，可以详细看看，了解下生产级的 btree 及 b+ tree 实现，相信你会收货很多。</p></div><div><div>2021-03-24</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/account/avatar/00/1b/65/b7/058276dc.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>i_chase</span></div></div><div>这一期的思考题有答案吗</div><div><p>作者回复：主要原因是 etcd 3.4 版本是使用 go 1.12 编译的，go runtime 的默认内存管理策略是 MADV_FREE, 它的性能较好，但是会导致你看到的 etcd 内存虚高，监控指标异常、用户体验不佳等问题，原因是这种策略，在系统内存有压力的时候，内核才会释放占用的内存。
从 go v1.16 起，Go 在 Linux 下的默认内存管理策略变成了 MADV_DONTNEED 策略。MADV_DONTNEED 虽然效率相比 MADV_FREE 策略较低，但是会让 rss 内存下降较快，更加符合直观感受，能避免 MADV_FREE 相关的副作用。
更详细的可以参考 golang issue 和 etcd 3.5 blog.
https://github.com/golang/go/issues/42330
https://etcd.io/blog/2021/announcing-etcd-3.5 Monitoring 部分</p></div><div><div>2022-05-01</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>HelloBug</span></div></div><div>一个客户端是一个 Client，watch 一个 key 是一个 watcher，gRPC Watch Stream 数如何确定呢？</div><div><div>2021-11-19</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/11/3e/925aa996.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>HelloBug</span></div></div><div>&gt; 其次是 goroutines 泄露导致内存占用高。此问题可能会在容器化场景中遇到。etcd 在打印日志的时候，若出现阻塞则可能会导致 goroutine 阻塞并持续泄露，最终导致内存泄露
老师，这里不太明白，为什么打印日志阻塞会导致内存泄露呢？</div><div><div>2021-11-19</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/60/ff/cbe8fb58.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>sxfworks</span></div></div><div>这几天看了 etcd 的源码，最开始一直好奇 leader 和 follower 怎么只同步一次 snapshot，是我看错了，还是真的这么粗暴😂</div><div><div>2021-05-29</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1a"><outline class="toc-level-h1" data-reactid=".1a.0" style="width: 175px;"><active data-reactid=".1a.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1a.0.1"><span data-reactid=".1a.0.1.0">15 | 内存：为什么你的 etcd 内存占用那么高？</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.1" style="width: 165px;"><active data-reactid=".1a.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1a.1.1"><span data-reactid=".1a.1.1.0">分析整体思路</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.2" style="width: 165px;"><active data-reactid=".1a.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1a.2.1"><span data-reactid=".1a.2.1.0">一个 key 使用数 G 内存的案例</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.3" style="width: 165px;"><active data-reactid=".1a.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1a.3.1"><span data-reactid=".1a.3.1.0">raftLog</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.4" style="width: 165px;"><active data-reactid=".1a.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1a.4.1"><span data-reactid=".1a.4.1.0">treeIndex</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.5" style="width: 165px;"><active data-reactid=".1a.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1a.5.1"><span data-reactid=".1a.5.1.0">boltdb</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.6" style="width: 165px;"><active data-reactid=".1a.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1a.6.1"><span data-reactid=".1a.6.1.0">watcher</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.7" style="width: 165px;"><active data-reactid=".1a.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1a.7.1"><span data-reactid=".1a.7.1.0">expensive request</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.8" style="width: 165px;"><active data-reactid=".1a.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1a.8.1"><span data-reactid=".1a.8.1.0">etcd v2/goroutines/bug</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.9" style="width: 165px;"><active data-reactid=".1a.9.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1a.9.1"><span data-reactid=".1a.9.1.0">小节</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.a" style="width: 165px;"><active data-reactid=".1a.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1a.a.1"><span data-reactid=".1a.a.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1a.b" style="width: 165px;"><active data-reactid=".1a.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1a.b.1"><span data-reactid=".1a.b.1.0">精选留言 (7)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/344621" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>