
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 09 | 瞧一瞧 Linux：Linux 的自旋锁和信号量如何实现？</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>09 | 瞧一瞧 Linux：Linux 的自旋锁和信号量如何实现？</sr-rd-title>
                    
                    <sr-rd-content><h1 id="sr-toc-0">09 | 瞧一瞧 Linux：Linux 的自旋锁和信号量如何实现？</h1><div><span>LMOS</span> <span>2021-05-28</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/0e/5a/0eee29c509606fd1ef9ae561851a175a.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：陈晨</span><span>大小：15.55M</span><span> 时长：17:02</span></div></div><audio title="09 | 瞧一瞧Linux：Linux的自旋锁和信号量如何实现？" src="https://res001.geekbang.org/media/audio/5d/ce/5d1yy957aeae0829cbfb06deee8929ce/ld/ld.m3u8" __idm_id__="942093"></audio></div><div><div><div><div data-slate-editor="true" data-key="4434" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="4435"><span data-slate-object="text" data-key="4436"><span data-slate-leaf="true" data-offset-key="4436:0" data-first-offset="true"><span data-slate-string="true">你好，我是 LMOS。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4437"><span data-slate-object="text" data-key="4438"><span data-slate-leaf="true" data-offset-key="4438:0" data-first-offset="true"><span data-slate-string="true">上节课，我们学习了解决数据同步问题的思路与方法。Linux 作为成熟的操作系统内核，当然也有很多数据同步的机制，它也有原子变量、开启和关闭中断、自旋锁、信号量。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4439"><span data-slate-object="text" data-key="4440"><span data-slate-leaf="true" data-offset-key="4440:0" data-first-offset="true"><span data-slate-string="true">那今天我们就来探讨一下这些机制在 Linux 中的实现。看看 Linux 的实现和前面我们自己的实现有什么区别，以及 Linux 为什么要这么实现，这么实现背后的机理是什么。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4441" id="sr-toc-1"><span data-slate-object="text" data-key="4442"><span data-slate-leaf="true" data-offset-key="4442:0" data-first-offset="true"><span data-slate-string="true">Linux 的原子变量</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4443"><span data-slate-object="text" data-key="4444"><span data-slate-leaf="true" data-offset-key="4444:0" data-first-offset="true"><span data-slate-string="true">首先，我们一起来看看 Linux 下的原子变量的实现，在 Linux 中，有许多共享的资源可能只是一个简单的整型数值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4445"><span data-slate-object="text" data-key="4446"><span data-slate-leaf="true" data-offset-key="4446:0" data-first-offset="true"><span data-slate-string="true">例如在文件描述符中，需要包含一个简单的计数器。这个计数器表示有多少个应用程序打开了文件。在文件系统的 open 函数中，将这个计数器变量加 1；在 close 函数中，将这个计数器变量减 1。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4447"><span data-slate-object="text" data-key="4448"><span data-slate-leaf="true" data-offset-key="4448:0" data-first-offset="true"><span data-slate-string="true">如果单个进程执行打开和关闭操作，那么这个计数器变量不会出现问题，但是 Linux 是支持多进程的系统，如果有多个进程同时打开或者关闭文件，那么就可能导致这个计数器变量多加或者少加，出现错误。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4449"><span data-slate-object="text" data-key="4450"><span data-slate-leaf="true" data-offset-key="4450:0" data-first-offset="true"><span data-slate-string="true">为了避免这个问题，Linux 提供了</span></span></span><span data-slate-object="text" data-key="4451"><span data-slate-leaf="true" data-offset-key="4451:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">一个原子类型变量 atomic_t</span></span></span></span><span data-slate-object="text" data-key="4452"><span data-slate-leaf="true" data-offset-key="4452:0" data-first-offset="true"><span data-slate-string="true">。该变量的定义如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="4453"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4454"><span data-slate-object="text" data-key="4455"><span data-slate-leaf="true" data-offset-key="4455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="4456"><span data-slate-leaf="true" data-offset-key="4456:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4457"><span data-slate-leaf="true" data-offset-key="4457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="4458"><span data-slate-leaf="true" data-offset-key="4458:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4459"><span data-slate-object="text" data-key="4460"><span data-slate-leaf="true" data-offset-key="4460:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4461"><span data-slate-leaf="true" data-offset-key="4461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4462"><span data-slate-leaf="true" data-offset-key="4462:0" data-first-offset="true"><span data-slate-string="true"> counter;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4463"><span data-slate-object="text" data-key="4464"><span data-slate-leaf="true" data-offset-key="4464:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span><span data-slate-object="text" data-key="4465"><span data-slate-leaf="true" data-offset-key="4465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span><span data-slate-object="text" data-key="4466"><span data-slate-leaf="true" data-offset-key="4466:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span><span data-slate-object="text" data-key="4467"><span data-slate-leaf="true" data-offset-key="4467:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 常用的 32 位的原子变量类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4468"><span data-slate-object="text" data-key="4469"><span data-slate-leaf="true" data-offset-key="4469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="4470"><span data-slate-leaf="true" data-offset-key="4470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ifdef</span></span></span></span></span><span data-slate-object="text" data-key="4471"><span data-slate-leaf="true" data-offset-key="4471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> CONFIG_64BIT</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4472"><span data-slate-object="text" data-key="4473"><span data-slate-leaf="true" data-offset-key="4473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="4474"><span data-slate-leaf="true" data-offset-key="4474:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4475"><span data-slate-leaf="true" data-offset-key="4475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="4476"><span data-slate-leaf="true" data-offset-key="4476:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4477"><span data-slate-object="text" data-key="4478"><span data-slate-leaf="true" data-offset-key="4478:0" data-first-offset="true"><span data-slate-string="true">    s64 counter;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4479"><span data-slate-object="text" data-key="4480"><span data-slate-leaf="true" data-offset-key="4480:0" data-first-offset="true"><span data-slate-string="true">} </span></span></span><span data-slate-object="text" data-key="4481"><span data-slate-leaf="true" data-offset-key="4481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic64_t</span></span></span></span><span data-slate-object="text" data-key="4482"><span data-slate-leaf="true" data-offset-key="4482:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span><span data-slate-object="text" data-key="4483"><span data-slate-leaf="true" data-offset-key="4483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//64 位的原子变量类型</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4484"><span data-slate-object="text" data-key="4485"><span data-slate-leaf="true" data-offset-key="4485:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="4486"><span data-slate-leaf="true" data-offset-key="4486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">endif</span></span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4487"><span data-slate-object="text" data-key="4488"><span data-slate-leaf="true" data-offset-key="4488:0" data-first-offset="true"><span data-slate-string="true">上述代码自然不能用普通的代码去读写加减，而是要用 Linux 专门提供的接口函数去操作，否则就不能保证原子性了，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="4489"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4490"><span data-slate-object="text" data-key="4491"><span data-slate-leaf="true" data-offset-key="4491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子读取变量中的值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4492"><span data-slate-object="text" data-key="4493"><span data-slate-leaf="true" data-offset-key="4493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4494"><span data-slate-leaf="true" data-offset-key="4494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4495"><span data-slate-leaf="true" data-offset-key="4495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span><span data-slate-object="text" data-key="4496"><span data-slate-leaf="true" data-offset-key="4496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4497"><span data-slate-leaf="true" data-offset-key="4497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_atomic_read</span></span></span></span></span><span data-slate-object="text" data-key="4498"><span data-slate-leaf="true" data-offset-key="4498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4499"><span data-slate-leaf="true" data-offset-key="4499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span></span></span><span data-slate-object="text" data-key="4500"><span data-slate-leaf="true" data-offset-key="4500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="4501"><span data-slate-leaf="true" data-offset-key="4501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span></span></span><span data-slate-object="text" data-key="4502"><span data-slate-leaf="true" data-offset-key="4502:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *v)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4503"><span data-slate-object="text" data-key="4504"><span data-slate-leaf="true" data-offset-key="4504:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4505"><span data-slate-object="text" data-key="4506"><span data-slate-leaf="true" data-offset-key="4506:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4507"><span data-slate-leaf="true" data-offset-key="4507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4508"><span data-slate-leaf="true" data-offset-key="4508:0" data-first-offset="true"><span data-slate-string="true"> __READ_ONCE((v)-&gt;counter);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4509"><span data-slate-object="text" data-key="4510"><span data-slate-leaf="true" data-offset-key="4510:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4511"><span data-slate-object="text" data-key="4512"><span data-slate-leaf="true" data-offset-key="4512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子写入一个具体的值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4513"><span data-slate-object="text" data-key="4514"><span data-slate-leaf="true" data-offset-key="4514:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4515"><span data-slate-leaf="true" data-offset-key="4515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4516"><span data-slate-leaf="true" data-offset-key="4516:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4517"><span data-slate-leaf="true" data-offset-key="4517:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4518"><span data-slate-leaf="true" data-offset-key="4518:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_atomic_set</span></span></span></span></span><span data-slate-object="text" data-key="4519"><span data-slate-leaf="true" data-offset-key="4519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4520"><span data-slate-leaf="true" data-offset-key="4520:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span></span></span><span data-slate-object="text" data-key="4521"><span data-slate-leaf="true" data-offset-key="4521:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *v, </span></span></span></span></span><span data-slate-object="text" data-key="4522"><span data-slate-leaf="true" data-offset-key="4522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="4523"><span data-slate-leaf="true" data-offset-key="4523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> i)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4524"><span data-slate-object="text" data-key="4525"><span data-slate-leaf="true" data-offset-key="4525:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4526"><span data-slate-object="text" data-key="4527"><span data-slate-leaf="true" data-offset-key="4527:0" data-first-offset="true"><span data-slate-string="true">    __WRITE_ONCE(v-&gt;counter, i);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4528"><span data-slate-object="text" data-key="4529"><span data-slate-leaf="true" data-offset-key="4529:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4530"><span data-slate-object="text" data-key="4531"><span data-slate-leaf="true" data-offset-key="4531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子加上一个具体的值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4532"><span data-slate-object="text" data-key="4533"><span data-slate-leaf="true" data-offset-key="4533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4534"><span data-slate-leaf="true" data-offset-key="4534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4535"><span data-slate-leaf="true" data-offset-key="4535:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4536"><span data-slate-leaf="true" data-offset-key="4536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4537"><span data-slate-leaf="true" data-offset-key="4537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_atomic_add</span></span></span></span></span><span data-slate-object="text" data-key="4538"><span data-slate-leaf="true" data-offset-key="4538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4539"><span data-slate-leaf="true" data-offset-key="4539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="4540"><span data-slate-leaf="true" data-offset-key="4540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> i, </span></span></span></span></span><span data-slate-object="text" data-key="4541"><span data-slate-leaf="true" data-offset-key="4541:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span></span></span><span data-slate-object="text" data-key="4542"><span data-slate-leaf="true" data-offset-key="4542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *v)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4543"><span data-slate-object="text" data-key="4544"><span data-slate-leaf="true" data-offset-key="4544:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4545"><span data-slate-object="text" data-key="4546"><span data-slate-leaf="true" data-offset-key="4546:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4547"><span data-slate-leaf="true" data-offset-key="4547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="4548"><span data-slate-leaf="true" data-offset-key="4548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4549"><span data-slate-leaf="true" data-offset-key="4549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="4550"><span data-slate-leaf="true" data-offset-key="4550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(LOCK_PREFIX </span></span></span></span></span><span data-slate-object="text" data-key="4551"><span data-slate-leaf="true" data-offset-key="4551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"addl %1,%0"</span></span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4552"><span data-slate-object="text" data-key="4553"><span data-slate-leaf="true" data-offset-key="4553:0" data-first-offset="true"><span data-slate-string="true">             : </span></span></span><span data-slate-object="text" data-key="4554"><span data-slate-leaf="true" data-offset-key="4554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="4555"><span data-slate-leaf="true" data-offset-key="4555:0" data-first-offset="true"><span data-slate-string="true"> (v-&gt;counter)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4556"><span data-slate-object="text" data-key="4557"><span data-slate-leaf="true" data-offset-key="4557:0" data-first-offset="true"><span data-slate-string="true">             : </span></span></span><span data-slate-object="text" data-key="4558"><span data-slate-leaf="true" data-offset-key="4558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"ir"</span></span></span></span><span data-slate-object="text" data-key="4559"><span data-slate-leaf="true" data-offset-key="4559:0" data-first-offset="true"><span data-slate-string="true"> (i) : </span></span></span><span data-slate-object="text" data-key="4560"><span data-slate-leaf="true" data-offset-key="4560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="4561"><span data-slate-leaf="true" data-offset-key="4561:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4562"><span data-slate-object="text" data-key="4563"><span data-slate-leaf="true" data-offset-key="4563:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4564"><span data-slate-object="text" data-key="4565"><span data-slate-leaf="true" data-offset-key="4565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子减去一个具体的值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4566"><span data-slate-object="text" data-key="4567"><span data-slate-leaf="true" data-offset-key="4567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4568"><span data-slate-leaf="true" data-offset-key="4568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4569"><span data-slate-leaf="true" data-offset-key="4569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4570"><span data-slate-leaf="true" data-offset-key="4570:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4571"><span data-slate-leaf="true" data-offset-key="4571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_atomic_sub</span></span></span></span></span><span data-slate-object="text" data-key="4572"><span data-slate-leaf="true" data-offset-key="4572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4573"><span data-slate-leaf="true" data-offset-key="4573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span></span></span><span data-slate-object="text" data-key="4574"><span data-slate-leaf="true" data-offset-key="4574:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> i, </span></span></span></span></span><span data-slate-object="text" data-key="4575"><span data-slate-leaf="true" data-offset-key="4575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span></span></span><span data-slate-object="text" data-key="4576"><span data-slate-leaf="true" data-offset-key="4576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *v)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4577"><span data-slate-object="text" data-key="4578"><span data-slate-leaf="true" data-offset-key="4578:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4579"><span data-slate-object="text" data-key="4580"><span data-slate-leaf="true" data-offset-key="4580:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4581"><span data-slate-leaf="true" data-offset-key="4581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="4582"><span data-slate-leaf="true" data-offset-key="4582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4583"><span data-slate-leaf="true" data-offset-key="4583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="4584"><span data-slate-leaf="true" data-offset-key="4584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(LOCK_PREFIX </span></span></span></span></span><span data-slate-object="text" data-key="4585"><span data-slate-leaf="true" data-offset-key="4585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"subl %1,%0"</span></span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4586"><span data-slate-object="text" data-key="4587"><span data-slate-leaf="true" data-offset-key="4587:0" data-first-offset="true"><span data-slate-string="true">             : </span></span></span><span data-slate-object="text" data-key="4588"><span data-slate-leaf="true" data-offset-key="4588:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="4589"><span data-slate-leaf="true" data-offset-key="4589:0" data-first-offset="true"><span data-slate-string="true"> (v-&gt;counter)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4590"><span data-slate-object="text" data-key="4591"><span data-slate-leaf="true" data-offset-key="4591:0" data-first-offset="true"><span data-slate-string="true">             : </span></span></span><span data-slate-object="text" data-key="4592"><span data-slate-leaf="true" data-offset-key="4592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"ir"</span></span></span></span><span data-slate-object="text" data-key="4593"><span data-slate-leaf="true" data-offset-key="4593:0" data-first-offset="true"><span data-slate-string="true"> (i) : </span></span></span><span data-slate-object="text" data-key="4594"><span data-slate-leaf="true" data-offset-key="4594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="4595"><span data-slate-leaf="true" data-offset-key="4595:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4596"><span data-slate-object="text" data-key="4597"><span data-slate-leaf="true" data-offset-key="4597:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4598"><span data-slate-object="text" data-key="4599"><span data-slate-leaf="true" data-offset-key="4599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子加 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4600"><span data-slate-object="text" data-key="4601"><span data-slate-leaf="true" data-offset-key="4601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4602"><span data-slate-leaf="true" data-offset-key="4602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4603"><span data-slate-leaf="true" data-offset-key="4603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4604"><span data-slate-leaf="true" data-offset-key="4604:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4605"><span data-slate-leaf="true" data-offset-key="4605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_atomic_inc</span></span></span></span></span><span data-slate-object="text" data-key="4606"><span data-slate-leaf="true" data-offset-key="4606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4607"><span data-slate-leaf="true" data-offset-key="4607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span></span></span><span data-slate-object="text" data-key="4608"><span data-slate-leaf="true" data-offset-key="4608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *v)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4609"><span data-slate-object="text" data-key="4610"><span data-slate-leaf="true" data-offset-key="4610:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4611"><span data-slate-object="text" data-key="4612"><span data-slate-leaf="true" data-offset-key="4612:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4613"><span data-slate-leaf="true" data-offset-key="4613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="4614"><span data-slate-leaf="true" data-offset-key="4614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4615"><span data-slate-leaf="true" data-offset-key="4615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="4616"><span data-slate-leaf="true" data-offset-key="4616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(LOCK_PREFIX </span></span></span></span></span><span data-slate-object="text" data-key="4617"><span data-slate-leaf="true" data-offset-key="4617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"incl %0"</span></span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4618"><span data-slate-object="text" data-key="4619"><span data-slate-leaf="true" data-offset-key="4619:0" data-first-offset="true"><span data-slate-string="true">             : </span></span></span><span data-slate-object="text" data-key="4620"><span data-slate-leaf="true" data-offset-key="4620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="4621"><span data-slate-leaf="true" data-offset-key="4621:0" data-first-offset="true"><span data-slate-string="true"> (v-&gt;counter) :: </span></span></span><span data-slate-object="text" data-key="4622"><span data-slate-leaf="true" data-offset-key="4622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="4623"><span data-slate-leaf="true" data-offset-key="4623:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4624"><span data-slate-object="text" data-key="4625"><span data-slate-leaf="true" data-offset-key="4625:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4626"><span data-slate-object="text" data-key="4627"><span data-slate-leaf="true" data-offset-key="4627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子减 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4628"><span data-slate-object="text" data-key="4629"><span data-slate-leaf="true" data-offset-key="4629:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4630"><span data-slate-leaf="true" data-offset-key="4630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4631"><span data-slate-leaf="true" data-offset-key="4631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4632"><span data-slate-leaf="true" data-offset-key="4632:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4633"><span data-slate-leaf="true" data-offset-key="4633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_atomic_dec</span></span></span></span></span><span data-slate-object="text" data-key="4634"><span data-slate-leaf="true" data-offset-key="4634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4635"><span data-slate-leaf="true" data-offset-key="4635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">atomic_t</span></span></span></span></span></span><span data-slate-object="text" data-key="4636"><span data-slate-leaf="true" data-offset-key="4636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> *v)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4637"><span data-slate-object="text" data-key="4638"><span data-slate-leaf="true" data-offset-key="4638:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4639"><span data-slate-object="text" data-key="4640"><span data-slate-leaf="true" data-offset-key="4640:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4641"><span data-slate-leaf="true" data-offset-key="4641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="4642"><span data-slate-leaf="true" data-offset-key="4642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4643"><span data-slate-leaf="true" data-offset-key="4643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="4644"><span data-slate-leaf="true" data-offset-key="4644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(LOCK_PREFIX </span></span></span></span></span><span data-slate-object="text" data-key="4645"><span data-slate-leaf="true" data-offset-key="4645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"decl %0"</span></span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4646"><span data-slate-object="text" data-key="4647"><span data-slate-leaf="true" data-offset-key="4647:0" data-first-offset="true"><span data-slate-string="true">             : </span></span></span><span data-slate-object="text" data-key="4648"><span data-slate-leaf="true" data-offset-key="4648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="4649"><span data-slate-leaf="true" data-offset-key="4649:0" data-first-offset="true"><span data-slate-string="true"> (v-&gt;counter) :: </span></span></span><span data-slate-object="text" data-key="4650"><span data-slate-leaf="true" data-offset-key="4650:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="4651"><span data-slate-leaf="true" data-offset-key="4651:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4652"><span data-slate-object="text" data-key="4653"><span data-slate-leaf="true" data-offset-key="4653:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4654"><span data-slate-object="text" data-key="4655"><span data-slate-leaf="true" data-offset-key="4655:0" data-first-offset="true"><span data-slate-string="true">Linux 原子类型变量的操作函数有很多，这里我只是介绍了最基础的几个函数，</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="4656"><span data-slate-object="text" data-key="4657"><span data-slate-leaf="true" data-offset-key="4657:0" data-first-offset="true"><span data-slate-string="true">其它的原子类型变量操作</span></span></span></a><span data-slate-object="text" data-key="4658"><span data-slate-leaf="true" data-offset-key="4658:0" data-first-offset="true"><span data-slate-string="true">也依赖于上述几个基础的函数。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4659"><span data-slate-object="text" data-key="4660"><span data-slate-leaf="true" data-offset-key="4660:0" data-first-offset="true"><span data-slate-string="true">你会发现，Linux 的实现也同样采用了 x86 CPU 的原子指令，LOCK_PREFIX 是一个宏，根据需要展开成 “lock;” 或者空串。</span></span></span><span data-slate-object="text" data-key="4661"><span data-slate-leaf="true" data-offset-key="4661:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_173589c3" data-attr-id="23151" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">单核心 CPU 是不需要 lock 前缀的，只要在多核心 CPU 下才需要加上 lock 前缀。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4662"><span data-slate-object="text" data-key="4663"><span data-slate-leaf="true" data-offset-key="4663:0" data-first-offset="true"><span data-slate-string="true">剩下 __READ_ONCE，__WRITE_ONCE 两个宏，我们来看看它们分别做了什么，如下所示。</span></span></span></div><div data-code-language="python" data-slate-type="pre" data-slate-object="block" data-key="4664"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4665"><span data-slate-object="text" data-key="4666"><span data-slate-leaf="true" data-offset-key="4666:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#define __READ_ONCE(x)  \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4667"><span data-slate-object="text" data-key="4668"><span data-slate-leaf="true" data-offset-key="4668:0" data-first-offset="true"><span data-slate-string="true">(*(const volatile __unqual_scalar_typeof(x) *)&amp;(x))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4669"><span data-slate-object="text" data-key="4670"><span data-slate-leaf="true" data-offset-key="4670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#define __WRITE_ONCE(x, val) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4671"><span data-slate-object="text" data-key="4672"><span data-slate-leaf="true" data-offset-key="4672:0" data-first-offset="true"><span data-slate-string="true">do {*(volatile typeof(x) *)&amp;(x) = (val);} </span></span></span><span data-slate-object="text" data-key="4673"><span data-slate-leaf="true" data-offset-key="4673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="4674"><span data-slate-leaf="true" data-offset-key="4674:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="4675"><span data-slate-leaf="true" data-offset-key="4675:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4676"><span data-slate-leaf="true" data-offset-key="4676:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4677"><span data-slate-object="text" data-key="4678"><span data-slate-leaf="true" data-offset-key="4678:0" data-first-offset="true"><span data-slate-string="true">//__unqual_scalar_typeof 表示声明一个非限定的标量类型，非标量类型保持不变。说人话就是返回 x 变量的类型，这是 GCC 的功能，typeof 只是纯粹返回 x 的类型。</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4679"><span data-slate-object="text" data-key="4680"><span data-slate-leaf="true" data-offset-key="4680:0" data-first-offset="true"><span data-slate-string="true">// 如果 x 是</span></span></span><span data-slate-object="text" data-key="4681"><span data-slate-leaf="true" data-offset-key="4681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> int</span></span></span></span><span data-slate-object="text" data-key="4682"><span data-slate-leaf="true" data-offset-key="4682:0" data-first-offset="true"><span data-slate-string="true"> 类型则返回 “</span></span></span><span data-slate-object="text" data-key="4683"><span data-slate-leaf="true" data-offset-key="4683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4684"><span data-slate-leaf="true" data-offset-key="4684:0" data-first-offset="true"><span data-slate-string="true">” </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4685"><span data-slate-object="text" data-key="4686"><span data-slate-leaf="true" data-offset-key="4686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#define __READ_ONCE(x)  \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4687"><span data-slate-object="text" data-key="4688"><span data-slate-leaf="true" data-offset-key="4688:0" data-first-offset="true"><span data-slate-string="true">(*(const volatile </span></span></span><span data-slate-object="text" data-key="4689"><span data-slate-leaf="true" data-offset-key="4689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4690"><span data-slate-leaf="true" data-offset-key="4690:0" data-first-offset="true"><span data-slate-string="true"> *)&amp;(x))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4691"><span data-slate-object="text" data-key="4692"><span data-slate-leaf="true" data-offset-key="4692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#define __WRITE_ONCE(x, val) \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4693"><span data-slate-object="text" data-key="4694"><span data-slate-leaf="true" data-offset-key="4694:0" data-first-offset="true"><span data-slate-string="true">do {*(volatile </span></span></span><span data-slate-object="text" data-key="4695"><span data-slate-leaf="true" data-offset-key="4695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="4696"><span data-slate-leaf="true" data-offset-key="4696:0" data-first-offset="true"><span data-slate-string="true"> *)&amp;(x) = (val);} </span></span></span><span data-slate-object="text" data-key="4697"><span data-slate-leaf="true" data-offset-key="4697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="4698"><span data-slate-leaf="true" data-offset-key="4698:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="4699"><span data-slate-leaf="true" data-offset-key="4699:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="4700"><span data-slate-leaf="true" data-offset-key="4700:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4701"><span data-slate-object="text" data-key="4702"><span data-slate-leaf="true" data-offset-key="4702:0" data-first-offset="true"><span data-slate-string="true">结合刚才的代码，我给你做个解读。Linux 定义了 __READ_ONCE，__WRITE_ONCE 这两个宏，是对代码封装并利用 GCC 的特性对代码进行检查，把让错误显现在编译阶段。</span></span><span data-slate-leaf="true" data-offset-key="4702:1"><span data-slate-object="annotation" data-annotation-key="gkann_e5489603" data-attr-id="23417" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">其中的 “volatile int *” 是为了提醒编译器：</span></span></span></span><span data-slate-object="text" data-key="4703"><span data-slate-leaf="true" data-offset-key="4703:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_e5489603" data-attr-id="23417" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">这是对内存地址读写，不要有优化动作，每次都必须强制写入内存或从内存读取。</span></span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="4704" id="sr-toc-2"><span data-slate-object="text" data-key="4705"><span data-slate-leaf="true" data-offset-key="4705:0" data-first-offset="true"><span data-slate-string="true">Linux 控制中断</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="4706"><span data-slate-object="text" data-key="4707"><span data-slate-leaf="true" data-offset-key="4707:0" data-first-offset="true"><span data-slate-string="true">Linux 中有很多场景，需要在关中断下才可以安全执行一些操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4708"><span data-slate-object="text" data-key="4709"><span data-slate-leaf="true" data-offset-key="4709:0" data-first-offset="true"><span data-slate-string="true">比如，多个中断处理程序需要访问一些共享数据，一个中断程序在访问数据时必须保证自身（中断嵌套）和其它中断处理程序互斥，否则就会出错。再比如，设备驱动程序在设置设备寄存器时，也必须让 CPU 停止响应中断。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="4710"><span data-slate-object="text" data-key="4711"><span data-slate-leaf="true" data-offset-key="4711:0" data-first-offset="true"><span data-slate-string="true">Linux 控制 CPU 响应中断的函数如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="4712"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div><div data-code-line-number="72"></div><div data-code-line-number="73"></div><div data-code-line-number="74"></div><div data-code-line-number="75"></div><div data-code-line-number="76"></div><div data-code-line-number="77"></div><div data-code-line-number="78"></div><div data-code-line-number="79"></div><div data-code-line-number="80"></div><div data-code-line-number="81"></div><div data-code-line-number="82"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="4713"><span data-slate-object="text" data-key="4714"><span data-slate-leaf="true" data-offset-key="4714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际保存 eflags 寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4715"><span data-slate-object="text" data-key="4716"><span data-slate-leaf="true" data-offset-key="4716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span></span><span data-slate-object="text" data-key="4717"><span data-slate-leaf="true" data-offset-key="4717:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4718"><span data-slate-leaf="true" data-offset-key="4718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span><span data-slate-object="text" data-key="4719"><span data-slate-leaf="true" data-offset-key="4719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4720"><span data-slate-leaf="true" data-offset-key="4720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span><span data-slate-object="text" data-key="4721"><span data-slate-leaf="true" data-offset-key="4721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4722"><span data-slate-leaf="true" data-offset-key="4722:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">native_save_fl</span></span></span></span></span><span data-slate-object="text" data-key="4723"><span data-slate-leaf="true" data-offset-key="4723:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4724"><span data-slate-leaf="true" data-offset-key="4724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="4725"><span data-slate-leaf="true" data-offset-key="4725:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4726"><span data-slate-leaf="true" data-offset-key="4726:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4727"><span data-slate-object="text" data-key="4728"><span data-slate-leaf="true" data-offset-key="4728:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4729"><span data-slate-leaf="true" data-offset-key="4729:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="4730"><span data-slate-leaf="true" data-offset-key="4730:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4731"><span data-slate-leaf="true" data-offset-key="4731:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="4732"><span data-slate-leaf="true" data-offset-key="4732:0" data-first-offset="true"><span data-slate-string="true"> flags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4733"><span data-slate-object="text" data-key="4734"><span data-slate-leaf="true" data-offset-key="4734:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4735"><span data-slate-leaf="true" data-offset-key="4735:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="4736"><span data-slate-leaf="true" data-offset-key="4736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4737"><span data-slate-leaf="true" data-offset-key="4737:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="4738"><span data-slate-leaf="true" data-offset-key="4738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4739"><span data-slate-leaf="true" data-offset-key="4739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"# __raw_save_flags\n\t"</span></span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4740"><span data-slate-object="text" data-key="4741"><span data-slate-leaf="true" data-offset-key="4741:0" data-first-offset="true"><span data-slate-string="true">                 </span></span></span><span data-slate-object="text" data-key="4742"><span data-slate-leaf="true" data-offset-key="4742:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"pushf ; pop %0"</span></span></span></span><span data-slate-object="text" data-key="4743"><span data-slate-leaf="true" data-offset-key="4743:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="4744"><span data-slate-leaf="true" data-offset-key="4744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=rm"</span></span></span></span><span data-slate-object="text" data-key="4745"><span data-slate-leaf="true" data-offset-key="4745:0" data-first-offset="true"><span data-slate-string="true">(flags)::</span></span></span><span data-slate-object="text" data-key="4746"><span data-slate-leaf="true" data-offset-key="4746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="4747"><span data-slate-leaf="true" data-offset-key="4747:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4748"><span data-slate-object="text" data-key="4749"><span data-slate-leaf="true" data-offset-key="4749:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4750"><span data-slate-leaf="true" data-offset-key="4750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4751"><span data-slate-leaf="true" data-offset-key="4751:0" data-first-offset="true"><span data-slate-string="true"> flags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4752"><span data-slate-object="text" data-key="4753"><span data-slate-leaf="true" data-offset-key="4753:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4754"><span data-slate-object="text" data-key="4755"><span data-slate-leaf="true" data-offset-key="4755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际恢复 eflags 寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4756"><span data-slate-object="text" data-key="4757"><span data-slate-leaf="true" data-offset-key="4757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extern</span></span></span></span></span><span data-slate-object="text" data-key="4758"><span data-slate-leaf="true" data-offset-key="4758:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4759"><span data-slate-leaf="true" data-offset-key="4759:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span></span><span data-slate-object="text" data-key="4760"><span data-slate-leaf="true" data-offset-key="4760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4761"><span data-slate-leaf="true" data-offset-key="4761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4762"><span data-slate-leaf="true" data-offset-key="4762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4763"><span data-slate-leaf="true" data-offset-key="4763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">native_restore_fl</span></span></span></span></span><span data-slate-object="text" data-key="4764"><span data-slate-leaf="true" data-offset-key="4764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4765"><span data-slate-leaf="true" data-offset-key="4765:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="4766"><span data-slate-leaf="true" data-offset-key="4766:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="4767"><span data-slate-leaf="true" data-offset-key="4767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="4768"><span data-slate-leaf="true" data-offset-key="4768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> flags)</span></span></span></span></span><span data-slate-object="text" data-key="4769"><span data-slate-leaf="true" data-offset-key="4769:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4770"><span data-slate-object="text" data-key="4771"><span data-slate-leaf="true" data-offset-key="4771:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4772"><span data-slate-leaf="true" data-offset-key="4772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="4773"><span data-slate-leaf="true" data-offset-key="4773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4774"><span data-slate-leaf="true" data-offset-key="4774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="4775"><span data-slate-leaf="true" data-offset-key="4775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4776"><span data-slate-leaf="true" data-offset-key="4776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"push %0 ; popf"</span></span></span></span></span></span><span data-slate-object="text" data-key="4777"><span data-slate-leaf="true" data-offset-key="4777:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">::</span></span></span></span></span><span data-slate-object="text" data-key="4778"><span data-slate-leaf="true" data-offset-key="4778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"g"</span></span></span></span></span></span><span data-slate-object="text" data-key="4779"><span data-slate-leaf="true" data-offset-key="4779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(flags):</span></span></span></span></span><span data-slate-object="text" data-key="4780"><span data-slate-leaf="true" data-offset-key="4780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span></span></span><span data-slate-object="text" data-key="4781"><span data-slate-leaf="true" data-offset-key="4781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">,</span></span></span></span></span><span data-slate-object="text" data-key="4782"><span data-slate-leaf="true" data-offset-key="4782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cc"</span></span></span></span></span></span><span data-slate-object="text" data-key="4783"><span data-slate-leaf="true" data-offset-key="4783:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4784"><span data-slate-leaf="true" data-offset-key="4784:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4785"><span data-slate-object="text" data-key="4786"><span data-slate-leaf="true" data-offset-key="4786:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4787"><span data-slate-object="text" data-key="4788"><span data-slate-leaf="true" data-offset-key="4788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际关中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4789"><span data-slate-object="text" data-key="4790"><span data-slate-leaf="true" data-offset-key="4790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4791"><span data-slate-leaf="true" data-offset-key="4791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4792"><span data-slate-leaf="true" data-offset-key="4792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4793"><span data-slate-leaf="true" data-offset-key="4793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4794"><span data-slate-leaf="true" data-offset-key="4794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">native_irq_disable</span></span></span></span></span><span data-slate-object="text" data-key="4795"><span data-slate-leaf="true" data-offset-key="4795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4796"><span data-slate-leaf="true" data-offset-key="4796:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="4797"><span data-slate-leaf="true" data-offset-key="4797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4798"><span data-slate-leaf="true" data-offset-key="4798:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4799"><span data-slate-object="text" data-key="4800"><span data-slate-leaf="true" data-offset-key="4800:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4801"><span data-slate-leaf="true" data-offset-key="4801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="4802"><span data-slate-leaf="true" data-offset-key="4802:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4803"><span data-slate-leaf="true" data-offset-key="4803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="4804"><span data-slate-leaf="true" data-offset-key="4804:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4805"><span data-slate-leaf="true" data-offset-key="4805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cli"</span></span></span></span></span></span><span data-slate-object="text" data-key="4806"><span data-slate-leaf="true" data-offset-key="4806:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">:::</span></span></span></span></span><span data-slate-object="text" data-key="4807"><span data-slate-leaf="true" data-offset-key="4807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span></span></span><span data-slate-object="text" data-key="4808"><span data-slate-leaf="true" data-offset-key="4808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4809"><span data-slate-leaf="true" data-offset-key="4809:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4810"><span data-slate-object="text" data-key="4811"><span data-slate-leaf="true" data-offset-key="4811:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4812"><span data-slate-object="text" data-key="4813"><span data-slate-leaf="true" data-offset-key="4813:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际开启中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4814"><span data-slate-object="text" data-key="4815"><span data-slate-leaf="true" data-offset-key="4815:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4816"><span data-slate-leaf="true" data-offset-key="4816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4817"><span data-slate-leaf="true" data-offset-key="4817:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4818"><span data-slate-leaf="true" data-offset-key="4818:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4819"><span data-slate-leaf="true" data-offset-key="4819:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">native_irq_enable</span></span></span></span></span><span data-slate-object="text" data-key="4820"><span data-slate-leaf="true" data-offset-key="4820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4821"><span data-slate-leaf="true" data-offset-key="4821:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="4822"><span data-slate-leaf="true" data-offset-key="4822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4823"><span data-slate-leaf="true" data-offset-key="4823:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4824"><span data-slate-object="text" data-key="4825"><span data-slate-leaf="true" data-offset-key="4825:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4826"><span data-slate-leaf="true" data-offset-key="4826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="4827"><span data-slate-leaf="true" data-offset-key="4827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4828"><span data-slate-leaf="true" data-offset-key="4828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="4829"><span data-slate-leaf="true" data-offset-key="4829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4830"><span data-slate-leaf="true" data-offset-key="4830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"sti"</span></span></span></span></span></span><span data-slate-object="text" data-key="4831"><span data-slate-leaf="true" data-offset-key="4831:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">:::</span></span></span></span></span><span data-slate-object="text" data-key="4832"><span data-slate-leaf="true" data-offset-key="4832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span></span></span><span data-slate-object="text" data-key="4833"><span data-slate-leaf="true" data-offset-key="4833:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4834"><span data-slate-leaf="true" data-offset-key="4834:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4835"><span data-slate-object="text" data-key="4836"><span data-slate-leaf="true" data-offset-key="4836:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4837"><span data-slate-object="text" data-key="4838"><span data-slate-leaf="true" data-offset-key="4838:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//arch 层关中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4839"><span data-slate-object="text" data-key="4840"><span data-slate-leaf="true" data-offset-key="4840:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4841"><span data-slate-leaf="true" data-offset-key="4841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4842"><span data-slate-leaf="true" data-offset-key="4842:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4843"><span data-slate-leaf="true" data-offset-key="4843:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4844"><span data-slate-leaf="true" data-offset-key="4844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_local_irq_disable</span></span></span></span></span><span data-slate-object="text" data-key="4845"><span data-slate-leaf="true" data-offset-key="4845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4846"><span data-slate-leaf="true" data-offset-key="4846:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="4847"><span data-slate-leaf="true" data-offset-key="4847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4848"><span data-slate-leaf="true" data-offset-key="4848:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4849"><span data-slate-object="text" data-key="4850"><span data-slate-leaf="true" data-offset-key="4850:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4851"><span data-slate-leaf="true" data-offset-key="4851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">native_irq_disable</span></span></span></span><span data-slate-object="text" data-key="4852"><span data-slate-leaf="true" data-offset-key="4852:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4853"><span data-slate-object="text" data-key="4854"><span data-slate-leaf="true" data-offset-key="4854:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4855"><span data-slate-object="text" data-key="4856"><span data-slate-leaf="true" data-offset-key="4856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//arch 层开启中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4857"><span data-slate-object="text" data-key="4858"><span data-slate-leaf="true" data-offset-key="4858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4859"><span data-slate-leaf="true" data-offset-key="4859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4860"><span data-slate-leaf="true" data-offset-key="4860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4861"><span data-slate-leaf="true" data-offset-key="4861:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4862"><span data-slate-leaf="true" data-offset-key="4862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_local_irq_enable</span></span></span></span></span><span data-slate-object="text" data-key="4863"><span data-slate-leaf="true" data-offset-key="4863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4864"><span data-slate-leaf="true" data-offset-key="4864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="4865"><span data-slate-leaf="true" data-offset-key="4865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4866"><span data-slate-leaf="true" data-offset-key="4866:0" data-first-offset="true"><span data-slate-string="true">{ </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4867"><span data-slate-object="text" data-key="4868"><span data-slate-leaf="true" data-offset-key="4868:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4869"><span data-slate-leaf="true" data-offset-key="4869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">native_irq_enable</span></span></span></span><span data-slate-object="text" data-key="4870"><span data-slate-leaf="true" data-offset-key="4870:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4871"><span data-slate-object="text" data-key="4872"><span data-slate-leaf="true" data-offset-key="4872:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4873"><span data-slate-object="text" data-key="4874"><span data-slate-leaf="true" data-offset-key="4874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//arch 层保存 eflags 寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4875"><span data-slate-object="text" data-key="4876"><span data-slate-leaf="true" data-offset-key="4876:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4877"><span data-slate-leaf="true" data-offset-key="4877:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4878"><span data-slate-leaf="true" data-offset-key="4878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span><span data-slate-object="text" data-key="4879"><span data-slate-leaf="true" data-offset-key="4879:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4880"><span data-slate-leaf="true" data-offset-key="4880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span><span data-slate-object="text" data-key="4881"><span data-slate-leaf="true" data-offset-key="4881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">           </span></span></span></span><span data-slate-object="text" data-key="4882"><span data-slate-leaf="true" data-offset-key="4882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_local_save_flags</span></span></span></span></span><span data-slate-object="text" data-key="4883"><span data-slate-leaf="true" data-offset-key="4883:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4884"><span data-slate-leaf="true" data-offset-key="4884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="4885"><span data-slate-leaf="true" data-offset-key="4885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4886"><span data-slate-leaf="true" data-offset-key="4886:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4887"><span data-slate-object="text" data-key="4888"><span data-slate-leaf="true" data-offset-key="4888:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4889"><span data-slate-leaf="true" data-offset-key="4889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4890"><span data-slate-leaf="true" data-offset-key="4890:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4891"><span data-slate-leaf="true" data-offset-key="4891:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">native_save_fl</span></span></span></span><span data-slate-object="text" data-key="4892"><span data-slate-leaf="true" data-offset-key="4892:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4893"><span data-slate-object="text" data-key="4894"><span data-slate-leaf="true" data-offset-key="4894:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4895"><span data-slate-object="text" data-key="4896"><span data-slate-leaf="true" data-offset-key="4896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//arch 层恢复 eflags 寄存器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4897"><span data-slate-object="text" data-key="4898"><span data-slate-leaf="true" data-offset-key="4898:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4899"><span data-slate-leaf="true" data-offset-key="4899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">  __always_inline </span></span></span></span><span data-slate-object="text" data-key="4900"><span data-slate-leaf="true" data-offset-key="4900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="4901"><span data-slate-leaf="true" data-offset-key="4901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4902"><span data-slate-leaf="true" data-offset-key="4902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_local_irq_restore</span></span></span></span></span><span data-slate-object="text" data-key="4903"><span data-slate-leaf="true" data-offset-key="4903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4904"><span data-slate-leaf="true" data-offset-key="4904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span></span><span data-slate-object="text" data-key="4905"><span data-slate-leaf="true" data-offset-key="4905:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span></span><span data-slate-object="text" data-key="4906"><span data-slate-leaf="true" data-offset-key="4906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span></span><span data-slate-object="text" data-key="4907"><span data-slate-leaf="true" data-offset-key="4907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> flags)</span></span></span></span></span><span data-slate-object="text" data-key="4908"><span data-slate-leaf="true" data-offset-key="4908:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4909"><span data-slate-object="text" data-key="4910"><span data-slate-leaf="true" data-offset-key="4910:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4911"><span data-slate-leaf="true" data-offset-key="4911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">native_restore_fl</span></span></span></span><span data-slate-object="text" data-key="4912"><span data-slate-leaf="true" data-offset-key="4912:0" data-first-offset="true"><span data-slate-string="true">(flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4913"><span data-slate-object="text" data-key="4914"><span data-slate-leaf="true" data-offset-key="4914:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4915"><span data-slate-object="text" data-key="4916"><span data-slate-leaf="true" data-offset-key="4916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际保存 eflags 寄存器并关中断</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4917"><span data-slate-object="text" data-key="4918"><span data-slate-leaf="true" data-offset-key="4918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="4919"><span data-slate-leaf="true" data-offset-key="4919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> __always_inline </span></span></span></span><span data-slate-object="text" data-key="4920"><span data-slate-leaf="true" data-offset-key="4920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span></span><span data-slate-object="text" data-key="4921"><span data-slate-leaf="true" data-offset-key="4921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4922"><span data-slate-leaf="true" data-offset-key="4922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span></span><span data-slate-object="text" data-key="4923"><span data-slate-leaf="true" data-offset-key="4923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="4924"><span data-slate-leaf="true" data-offset-key="4924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_local_irq_save</span></span></span></span></span><span data-slate-object="text" data-key="4925"><span data-slate-leaf="true" data-offset-key="4925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="4926"><span data-slate-leaf="true" data-offset-key="4926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="4927"><span data-slate-leaf="true" data-offset-key="4927:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="4928"><span data-slate-leaf="true" data-offset-key="4928:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4929"><span data-slate-object="text" data-key="4930"><span data-slate-leaf="true" data-offset-key="4930:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4931"><span data-slate-leaf="true" data-offset-key="4931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="4932"><span data-slate-leaf="true" data-offset-key="4932:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="4933"><span data-slate-leaf="true" data-offset-key="4933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="4934"><span data-slate-leaf="true" data-offset-key="4934:0" data-first-offset="true"><span data-slate-string="true"> flags = </span></span></span><span data-slate-object="text" data-key="4935"><span data-slate-leaf="true" data-offset-key="4935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_local_save_flags</span></span></span></span><span data-slate-object="text" data-key="4936"><span data-slate-leaf="true" data-offset-key="4936:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4937"><span data-slate-object="text" data-key="4938"><span data-slate-leaf="true" data-offset-key="4938:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4939"><span data-slate-leaf="true" data-offset-key="4939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_local_irq_disable</span></span></span></span><span data-slate-object="text" data-key="4940"><span data-slate-leaf="true" data-offset-key="4940:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4941"><span data-slate-object="text" data-key="4942"><span data-slate-leaf="true" data-offset-key="4942:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="4943"><span data-slate-leaf="true" data-offset-key="4943:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="4944"><span data-slate-leaf="true" data-offset-key="4944:0" data-first-offset="true"><span data-slate-string="true"> flags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4945"><span data-slate-object="text" data-key="4946"><span data-slate-leaf="true" data-offset-key="4946:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4947"><span data-slate-object="text" data-key="4948"><span data-slate-leaf="true" data-offset-key="4948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//raw 层关闭开启中断宏</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4949"><span data-slate-object="text" data-key="4950"><span data-slate-leaf="true" data-offset-key="4950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="4951"><span data-slate-leaf="true" data-offset-key="4951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="4952"><span data-slate-leaf="true" data-offset-key="4952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> raw_local_irq_disable()     arch_local_irq_disable()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4953"><span data-slate-object="text" data-key="4954"><span data-slate-leaf="true" data-offset-key="4954:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="4955"><span data-slate-leaf="true" data-offset-key="4955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="4956"><span data-slate-leaf="true" data-offset-key="4956:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> raw_local_irq_enable()      arch_local_irq_enable()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4957"><span data-slate-object="text" data-key="4958"><span data-slate-leaf="true" data-offset-key="4958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//raw 层保存恢复 eflags 寄存器宏</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4959"><span data-slate-object="text" data-key="4960"><span data-slate-leaf="true" data-offset-key="4960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="4961"><span data-slate-leaf="true" data-offset-key="4961:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="4962"><span data-slate-leaf="true" data-offset-key="4962:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> raw_local_irq_save(flags)           \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4963"><span data-slate-object="text" data-key="4964"><span data-slate-leaf="true" data-offset-key="4964:0" data-first-offset="true"><span data-slate-string="true">    do {                        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4965"><span data-slate-object="text" data-key="4966"><span data-slate-leaf="true" data-offset-key="4966:0" data-first-offset="true"><span data-slate-string="true">        typecheck(unsigned long, flags);    \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4967"><span data-slate-object="text" data-key="4968"><span data-slate-leaf="true" data-offset-key="4968:0" data-first-offset="true"><span data-slate-string="true">        flags = arch_local_irq_save();      \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4969"><span data-slate-object="text" data-key="4970"><span data-slate-leaf="true" data-offset-key="4970:0" data-first-offset="true"><span data-slate-string="true">    } while (0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4971"><span data-slate-object="text" data-key="4972"><span data-slate-leaf="true" data-offset-key="4972:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4973"><span data-slate-object="text" data-key="4974"><span data-slate-leaf="true" data-offset-key="4974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="4975"><span data-slate-leaf="true" data-offset-key="4975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="4976"><span data-slate-leaf="true" data-offset-key="4976:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> raw_local_irq_restore(flags)            \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4977"><span data-slate-object="text" data-key="4978"><span data-slate-leaf="true" data-offset-key="4978:0" data-first-offset="true"><span data-slate-string="true">    do {                        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4979"><span data-slate-object="text" data-key="4980"><span data-slate-leaf="true" data-offset-key="4980:0" data-first-offset="true"><span data-slate-string="true">        typecheck(unsigned long, flags);    \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4981"><span data-slate-object="text" data-key="4982"><span data-slate-leaf="true" data-offset-key="4982:0" data-first-offset="true"><span data-slate-string="true">        arch_local_irq_restore(flags);      \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4983"><span data-slate-object="text" data-key="4984"><span data-slate-leaf="true" data-offset-key="4984:0" data-first-offset="true"><span data-slate-string="true">    } while (0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4985"><span data-slate-object="text" data-key="4986"><span data-slate-leaf="true" data-offset-key="4986:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4987"><span data-slate-object="text" data-key="4988"><span data-slate-leaf="true" data-offset-key="4988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="4989"><span data-slate-leaf="true" data-offset-key="4989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="4990"><span data-slate-leaf="true" data-offset-key="4990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> raw_local_save_flags(flags)         \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4991"><span data-slate-object="text" data-key="4992"><span data-slate-leaf="true" data-offset-key="4992:0" data-first-offset="true"><span data-slate-string="true">    do {                        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4993"><span data-slate-object="text" data-key="4994"><span data-slate-leaf="true" data-offset-key="4994:0" data-first-offset="true"><span data-slate-string="true">        typecheck(unsigned long, flags);    \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4995"><span data-slate-object="text" data-key="4996"><span data-slate-leaf="true" data-offset-key="4996:0" data-first-offset="true"><span data-slate-string="true">        flags = arch_local_save_flags();    \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4997"><span data-slate-object="text" data-key="4998"><span data-slate-leaf="true" data-offset-key="4998:0" data-first-offset="true"><span data-slate-string="true">    } while (0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="4999"><span data-slate-object="text" data-key="5000"><span data-slate-leaf="true" data-offset-key="5000:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 通用层接口宏 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5001"><span data-slate-object="text" data-key="5002"><span data-slate-leaf="true" data-offset-key="5002:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5003"><span data-slate-leaf="true" data-offset-key="5003:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5004"><span data-slate-leaf="true" data-offset-key="5004:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> local_irq_enable()              \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5005"><span data-slate-object="text" data-key="5006"><span data-slate-leaf="true" data-offset-key="5006:0" data-first-offset="true"><span data-slate-string="true">    do { \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5007"><span data-slate-object="text" data-key="5008"><span data-slate-leaf="true" data-offset-key="5008:0" data-first-offset="true"><span data-slate-string="true">        raw_local_irq_enable();         \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5009"><span data-slate-object="text" data-key="5010"><span data-slate-leaf="true" data-offset-key="5010:0" data-first-offset="true"><span data-slate-string="true">    } while (0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5011"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5012"><span data-slate-object="text" data-key="5013"><span data-slate-leaf="true" data-offset-key="5013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5014"><span data-slate-leaf="true" data-offset-key="5014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5015"><span data-slate-leaf="true" data-offset-key="5015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> local_irq_disable()             \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5016"><span data-slate-object="text" data-key="5017"><span data-slate-leaf="true" data-offset-key="5017:0" data-first-offset="true"><span data-slate-string="true">    do {                        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5018"><span data-slate-object="text" data-key="5019"><span data-slate-leaf="true" data-offset-key="5019:0" data-first-offset="true"><span data-slate-string="true">        raw_local_irq_disable();        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5020"><span data-slate-object="text" data-key="5021"><span data-slate-leaf="true" data-offset-key="5021:0" data-first-offset="true"><span data-slate-string="true">    } while (0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5022"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5023"><span data-slate-object="text" data-key="5024"><span data-slate-leaf="true" data-offset-key="5024:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5025"><span data-slate-leaf="true" data-offset-key="5025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5026"><span data-slate-leaf="true" data-offset-key="5026:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> local_irq_save(flags)               \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5027"><span data-slate-object="text" data-key="5028"><span data-slate-leaf="true" data-offset-key="5028:0" data-first-offset="true"><span data-slate-string="true">    do {                        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5029"><span data-slate-object="text" data-key="5030"><span data-slate-leaf="true" data-offset-key="5030:0" data-first-offset="true"><span data-slate-string="true">        raw_local_irq_save(flags);      \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5031"><span data-slate-object="text" data-key="5032"><span data-slate-leaf="true" data-offset-key="5032:0" data-first-offset="true"><span data-slate-string="true">    } while (0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5033"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5034"><span data-slate-object="text" data-key="5035"><span data-slate-leaf="true" data-offset-key="5035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5036"><span data-slate-leaf="true" data-offset-key="5036:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5037"><span data-slate-leaf="true" data-offset-key="5037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> local_irq_restore(flags)            \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5038"><span data-slate-object="text" data-key="5039"><span data-slate-leaf="true" data-offset-key="5039:0" data-first-offset="true"><span data-slate-string="true">    do {                        \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5040"><span data-slate-object="text" data-key="5041"><span data-slate-leaf="true" data-offset-key="5041:0" data-first-offset="true"><span data-slate-string="true">        raw_local_irq_restore(flags);       \</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5042"><span data-slate-object="text" data-key="5043"><span data-slate-leaf="true" data-offset-key="5043:0" data-first-offset="true"><span data-slate-string="true">    } while (0)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5044"><span data-slate-object="text" data-key="5045"><span data-slate-leaf="true" data-offset-key="5045:0" data-first-offset="true"><span data-slate-string="true">可以发现，Linux 中通过定义的方式对一些底层函数进行了一些包装，为了让你抓住重点，前面这些宏我去掉了和中断控制无关的额外操作，详细信息你可以参阅</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="5046"><span data-slate-object="text" data-key="5047"><span data-slate-leaf="true" data-offset-key="5047:0" data-first-offset="true"><span data-slate-string="true">相关代码</span></span></span></a><span data-slate-object="text" data-key="5048"><span data-slate-leaf="true" data-offset-key="5048:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5049"><span data-slate-object="text" data-key="5050"><span data-slate-leaf="true" data-offset-key="5050:0" data-first-offset="true"><span data-slate-string="true">编译 Linux 代码时，编译器自动对宏进行展开。其中，</span></span></span><span data-slate-object="text" data-key="5051"><span data-slate-leaf="true" data-offset-key="5051:0" data-first-offset="true"><span data-slate-type="primary" data-slate-object="mark"><span data-slate-string="true">do{}while(0)</span></span></span></span><span data-slate-object="text" data-key="5052"><span data-slate-leaf="true" data-offset-key="5052:0" data-first-offset="true"><span data-slate-string="true"> 是 Linux 代码中一种常用的技巧，do {} while (0) 表达式会保证 {} 中的代码片段执行一次，保证宏展开时这个代码片段是一个整体。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5053"><span data-slate-object="text" data-key="5054"><span data-slate-leaf="true" data-offset-key="5054:0" data-first-offset="true"><span data-slate-string="true">带 native_ 前缀之类的函数则跟我们之前实现的 hal_ 前缀对应，而 Linux 为了支持不同的硬件平台，做了多层封装。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5055" id="sr-toc-3"><span data-slate-object="text" data-key="5056"><span data-slate-leaf="true" data-offset-key="5056:0" data-first-offset="true"><span data-slate-string="true">Linux 自旋锁</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5057"><span data-slate-object="text" data-key="5058"><span data-slate-leaf="true" data-offset-key="5058:0" data-first-offset="true"><span data-slate-string="true">Linux 也是支持多核心 CPU 的操作系统内核，因此 Linux 也需要自旋锁来对系统中的共享资源进行保护。同一时刻，只有获取了锁的进程才能使用共享资源。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5059"><span data-slate-object="text" data-key="5060"><span data-slate-leaf="true" data-offset-key="5060:0" data-first-offset="true"><span data-slate-string="true">根据上节课对自旋锁算法的理解，自旋锁不会引起加锁进程睡眠，如果自旋锁已经被别的进程持有，加锁进程就需要一直循环在那里，查看是否该自旋锁的持有者已经释放了锁，"自旋" 一词就是因此而得名。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5061"><span data-slate-object="text" data-key="5062"><span data-slate-leaf="true" data-offset-key="5062:0" data-first-offset="true"><span data-slate-string="true">Linux 有多种自旋锁，我们这里只介绍两种，</span></span></span><span data-slate-object="text" data-key="5063"><span data-slate-leaf="true" data-offset-key="5063:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">原始自旋锁和排队自旋锁</span></span></span></span><span data-slate-object="text" data-key="5064"><span data-slate-leaf="true" data-offset-key="5064:0" data-first-offset="true"><span data-slate-string="true">，它们底层原理和我们之前实现的没什么不同，但多了一些优化和改进，下面我们一起去看看。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="5065" id="sr-toc-4"><span data-slate-object="text" data-key="5066"><span data-slate-leaf="true" data-offset-key="5066:0" data-first-offset="true"><span data-slate-string="true">Linux 原始自旋锁</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="5067"><span data-slate-object="text" data-key="5068"><span data-slate-leaf="true" data-offset-key="5068:0" data-first-offset="true"><span data-slate-string="true">我们先看看 Linux 原始的自旋锁，Linux 的原始自旋锁本质上用一个整数来表示，值为 1 代表锁未被占用，为 0 或者负数则表示被占用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5069"><span data-slate-object="text" data-key="5070"><span data-slate-leaf="true" data-offset-key="5070:0" data-first-offset="true"><span data-slate-string="true">你可以结合上节课的这张图，理解后面的内容。当某个 CPU 核心执行进程请求加锁时，如果锁是未加锁状态，则加锁，然后操作共享资源，最后释放锁；如果锁已被加锁，则进程并不会转入睡眠状态，而是循环等待该锁，一旦锁被释放，则第一个感知此信息的进程将获得锁。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="5071"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/a2/24/a2968832f3f1055cc7ba68628a25d924.jpg?wh=2195*2405"></div><div>自旋锁原理示意图</div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5072"><span data-slate-object="text" data-key="5073"><span data-slate-leaf="true" data-offset-key="5073:0" data-first-offset="true"><span data-slate-string="true">我们先来看看 Linux 原始自旋锁的数据结构，为方便你阅读，我删除了用于调试的数据字段，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="5074"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5075"><span data-slate-object="text" data-key="5076"><span data-slate-leaf="true" data-offset-key="5076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 最底层的自旋锁数据结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5077"><span data-slate-object="text" data-key="5078"><span data-slate-leaf="true" data-offset-key="5078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="5079"><span data-slate-leaf="true" data-offset-key="5079:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5080"><span data-slate-leaf="true" data-offset-key="5080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5081"><span data-slate-leaf="true" data-offset-key="5081:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5082"><span data-slate-object="text" data-key="5083"><span data-slate-leaf="true" data-offset-key="5083:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span><span data-slate-object="text" data-key="5084"><span data-slate-leaf="true" data-offset-key="5084:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5085"><span data-slate-leaf="true" data-offset-key="5085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="5086"><span data-slate-leaf="true" data-offset-key="5086:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5087"><span data-slate-leaf="true" data-offset-key="5087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="5088"><span data-slate-leaf="true" data-offset-key="5088:0" data-first-offset="true"><span data-slate-string="true"> lock;</span></span></span><span data-slate-object="text" data-key="5089"><span data-slate-leaf="true" data-offset-key="5089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 真正的锁值变量，用 volatile 标识</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5090"><span data-slate-object="text" data-key="5091"><span data-slate-leaf="true" data-offset-key="5091:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="5092"><span data-slate-leaf="true" data-offset-key="5092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5093"><span data-slate-leaf="true" data-offset-key="5093:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5094"><span data-slate-object="text" data-key="5095"><span data-slate-leaf="true" data-offset-key="5095:0" data-first-offset="true"><span data-slate-string="true">Linux 原始自旋锁数据结构封装了一个 unsigned long 类型的变量。有了数据结构，我们再来看看操作这个数据结构的函数，即自旋锁接口，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="5096"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5097"><span data-slate-object="text" data-key="5098"><span data-slate-leaf="true" data-offset-key="5098:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5099"><span data-slate-leaf="true" data-offset-key="5099:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5100"><span data-slate-leaf="true" data-offset-key="5100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> spin_unlock_string \  </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5101"><span data-slate-object="text" data-key="5102"><span data-slate-leaf="true" data-offset-key="5102:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5103"><span data-slate-leaf="true" data-offset-key="5103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movb $1,%0"</span></span></span></span><span data-slate-object="text" data-key="5104"><span data-slate-leaf="true" data-offset-key="5104:0" data-first-offset="true"><span data-slate-string="true"> \ </span></span></span><span data-slate-object="text" data-key="5105"><span data-slate-leaf="true" data-offset-key="5105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 写入 1 表示解锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5106"><span data-slate-object="text" data-key="5107"><span data-slate-leaf="true" data-offset-key="5107:0" data-first-offset="true"><span data-slate-string="true">    :</span></span></span><span data-slate-object="text" data-key="5108"><span data-slate-leaf="true" data-offset-key="5108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=m"</span></span></span></span><span data-slate-object="text" data-key="5109"><span data-slate-leaf="true" data-offset-key="5109:0" data-first-offset="true"><span data-slate-string="true"> (lock-&gt;lock) : : </span></span></span><span data-slate-object="text" data-key="5110"><span data-slate-leaf="true" data-offset-key="5110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5111"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5112"><span data-slate-object="text" data-key="5113"><span data-slate-leaf="true" data-offset-key="5113:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5114"><span data-slate-leaf="true" data-offset-key="5114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5115"><span data-slate-leaf="true" data-offset-key="5115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> spin_lock_string \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5116"><span data-slate-object="text" data-key="5117"><span data-slate-leaf="true" data-offset-key="5117:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5118"><span data-slate-leaf="true" data-offset-key="5118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"\n1:\t"</span></span></span></span><span data-slate-object="text" data-key="5119"><span data-slate-leaf="true" data-offset-key="5119:0" data-first-offset="true"><span data-slate-string="true"> \  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5120"><span data-slate-object="text" data-key="5121"><span data-slate-leaf="true" data-offset-key="5121:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1996a546" data-attr-id="23302" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="5122"><span data-slate-leaf="true" data-offset-key="5122:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1996a546" data-attr-id="23302" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"lock ; decb %0\n\t"</span></span></span></span></span><span data-slate-object="text" data-key="5123"><span data-slate-leaf="true" data-offset-key="5123:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1996a546" data-attr-id="23302" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> \ </span></span></span></span><span data-slate-object="text" data-key="5124"><span data-slate-leaf="true" data-offset-key="5124:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1996a546" data-attr-id="23302" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子减 1</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5125"><span data-slate-object="text" data-key="5126"><span data-slate-leaf="true" data-offset-key="5126:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_b9bb0cf0" data-attr-id="25551" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">  </span></span></span></span><span data-slate-object="text" data-key="5127"><span data-slate-leaf="true" data-offset-key="5127:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_b9bb0cf0" data-attr-id="25551" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"js 2f\n"</span></span></span></span></span><span data-slate-object="text" data-key="5128"><span data-slate-leaf="true" data-offset-key="5128:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_b9bb0cf0" data-attr-id="25551" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> \    </span></span></span></span><span data-slate-object="text" data-key="5129"><span data-slate-leaf="true" data-offset-key="5129:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_b9bb0cf0" data-attr-id="25551" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 当结果小于 0 则跳转到标号 2 处，</span></span></span></span><span data-slate-leaf="true" data-offset-key="5129:1"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">表示加锁失败</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5130"><span data-slate-object="text" data-key="5131"><span data-slate-leaf="true" data-offset-key="5131:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5132"><span data-slate-leaf="true" data-offset-key="5132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">".section .text.lock,\"ax\"\n"</span></span></span></span><span data-slate-object="text" data-key="5133"><span data-slate-leaf="true" data-offset-key="5133:0" data-first-offset="true"><span data-slate-string="true"> \ </span></span></span><span data-slate-object="text" data-key="5134"><span data-slate-leaf="true" data-offset-key="5134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 重新定义一个代码段，这是优化技术，避免后面的代码填充 cache，因为大部分情况会加锁成功，链接器会处理好这个代码段的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5135"><span data-slate-object="text" data-key="5136"><span data-slate-leaf="true" data-offset-key="5136:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="5137"><span data-slate-leaf="true" data-offset-key="5137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2:\t"</span></span></span></span><span data-slate-object="text" data-key="5138"><span data-slate-leaf="true" data-offset-key="5138:0" data-first-offset="true"><span data-slate-string="true"> \  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5139"><span data-slate-object="text" data-key="5140"><span data-slate-leaf="true" data-offset-key="5140:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_7f5d3fa8" data-attr-id="25750" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="5141"><span data-slate-leaf="true" data-offset-key="5141:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_7f5d3fa8" data-attr-id="25750" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cmpb $0,%0\n\t"</span></span></span></span></span><span data-slate-object="text" data-key="5142"><span data-slate-leaf="true" data-offset-key="5142:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_7f5d3fa8" data-attr-id="25750" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> \  </span></span></span></span><span data-slate-object="text" data-key="5143"><span data-slate-leaf="true" data-offset-key="5143:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_7f5d3fa8" data-attr-id="25750" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 和 0 比较</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5144"><span data-slate-object="text" data-key="5145"><span data-slate-leaf="true" data-offset-key="5145:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_8dc5eacc" data-attr-id="25751" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="5146"><span data-slate-leaf="true" data-offset-key="5146:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_8dc5eacc" data-attr-id="25751" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rep;nop\n\t"</span></span></span></span></span><span data-slate-object="text" data-key="5147"><span data-slate-leaf="true" data-offset-key="5147:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_8dc5eacc" data-attr-id="25751" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> \  </span></span></span></span><span data-slate-object="text" data-key="5148"><span data-slate-leaf="true" data-offset-key="5148:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_8dc5eacc" data-attr-id="25751" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 空指令</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5149"><span data-slate-object="text" data-key="5150"><span data-slate-leaf="true" data-offset-key="5150:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6d3340dc" data-attr-id="25752" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="5151"><span data-slate-leaf="true" data-offset-key="5151:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6d3340dc" data-attr-id="25752" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jle 2b\n\t"</span></span></span></span></span><span data-slate-object="text" data-key="5152"><span data-slate-leaf="true" data-offset-key="5152:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6d3340dc" data-attr-id="25752" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> \   </span></span></span></span><span data-slate-object="text" data-key="5153"><span data-slate-leaf="true" data-offset-key="5153:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_6d3340dc" data-attr-id="25752" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 小于或等于 0 跳转到标号 2</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5154"><span data-slate-object="text" data-key="5155"><span data-slate-leaf="true" data-offset-key="5155:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f93885fe" data-attr-id="25753" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="5156"><span data-slate-leaf="true" data-offset-key="5156:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f93885fe" data-attr-id="25753" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jmp 1b\n"</span></span></span></span></span><span data-slate-object="text" data-key="5157"><span data-slate-leaf="true" data-offset-key="5157:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f93885fe" data-attr-id="25753" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> \   </span></span></span></span><span data-slate-object="text" data-key="5158"><span data-slate-leaf="true" data-offset-key="5158:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_f93885fe" data-attr-id="25753" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 跳转到标号 1  </span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5159"><span data-slate-object="text" data-key="5160"><span data-slate-leaf="true" data-offset-key="5160:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5161"><span data-slate-leaf="true" data-offset-key="5161:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">".previous"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5162"><span data-slate-object="text" data-key="5163"><span data-slate-leaf="true" data-offset-key="5163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5164"><span data-slate-object="text" data-key="5165"><span data-slate-leaf="true" data-offset-key="5165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="5166"><span data-slate-leaf="true" data-offset-key="5166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5167"><span data-slate-leaf="true" data-offset-key="5167:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span></span><span data-slate-object="text" data-key="5168"><span data-slate-leaf="true" data-offset-key="5168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5169"><span data-slate-leaf="true" data-offset-key="5169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="5170"><span data-slate-leaf="true" data-offset-key="5170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5171"><span data-slate-leaf="true" data-offset-key="5171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spin_lock</span></span></span></span></span><span data-slate-object="text" data-key="5172"><span data-slate-leaf="true" data-offset-key="5172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="5173"><span data-slate-leaf="true" data-offset-key="5173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span></span></span><span data-slate-object="text" data-key="5174"><span data-slate-leaf="true" data-offset-key="5174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">*lock)</span></span></span></span></span><span data-slate-object="text" data-key="5175"><span data-slate-leaf="true" data-offset-key="5175:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5176"><span data-slate-object="text" data-key="5177"><span data-slate-leaf="true" data-offset-key="5177:0" data-first-offset="true"><span data-slate-string="true">    __asm__ __volatile__(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5178"><span data-slate-object="text" data-key="5179"><span data-slate-leaf="true" data-offset-key="5179:0" data-first-offset="true"><span data-slate-string="true">    spin_lock_string</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5180"><span data-slate-object="text" data-key="5181"><span data-slate-leaf="true" data-offset-key="5181:0" data-first-offset="true"><span data-slate-string="true">    :</span></span></span><span data-slate-object="text" data-key="5182"><span data-slate-leaf="true" data-offset-key="5182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=m"</span></span></span></span><span data-slate-object="text" data-key="5183"><span data-slate-leaf="true" data-offset-key="5183:0" data-first-offset="true"><span data-slate-string="true">(lock-&gt;lock)::</span></span></span><span data-slate-object="text" data-key="5184"><span data-slate-leaf="true" data-offset-key="5184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5185"><span data-slate-object="text" data-key="5186"><span data-slate-leaf="true" data-offset-key="5186:0" data-first-offset="true"><span data-slate-string="true">    );</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5187"><span data-slate-object="text" data-key="5188"><span data-slate-leaf="true" data-offset-key="5188:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5189"><span data-slate-object="text" data-key="5190"><span data-slate-leaf="true" data-offset-key="5190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5191"><span data-slate-object="text" data-key="5192"><span data-slate-leaf="true" data-offset-key="5192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="5193"><span data-slate-leaf="true" data-offset-key="5193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5194"><span data-slate-leaf="true" data-offset-key="5194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span></span><span data-slate-object="text" data-key="5195"><span data-slate-leaf="true" data-offset-key="5195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5196"><span data-slate-leaf="true" data-offset-key="5196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="5197"><span data-slate-leaf="true" data-offset-key="5197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5198"><span data-slate-leaf="true" data-offset-key="5198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spin_unlock</span></span></span></span></span><span data-slate-object="text" data-key="5199"><span data-slate-leaf="true" data-offset-key="5199:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="5200"><span data-slate-leaf="true" data-offset-key="5200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span></span></span><span data-slate-object="text" data-key="5201"><span data-slate-leaf="true" data-offset-key="5201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">*lock)</span></span></span></span></span><span data-slate-object="text" data-key="5202"><span data-slate-leaf="true" data-offset-key="5202:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5203"><span data-slate-object="text" data-key="5204"><span data-slate-leaf="true" data-offset-key="5204:0" data-first-offset="true"><span data-slate-string="true">__asm__ __volatile__(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5205"><span data-slate-object="text" data-key="5206"><span data-slate-leaf="true" data-offset-key="5206:0" data-first-offset="true"><span data-slate-string="true">    spin_unlock_string</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5207"><span data-slate-object="text" data-key="5208"><span data-slate-leaf="true" data-offset-key="5208:0" data-first-offset="true"><span data-slate-string="true">    );</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5209"><span data-slate-object="text" data-key="5210"><span data-slate-leaf="true" data-offset-key="5210:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5211"><span data-slate-object="text" data-key="5212"><span data-slate-leaf="true" data-offset-key="5212:0" data-first-offset="true"><span data-slate-string="true">上述代码中用 spin_lock_string、spin_unlock_string 两个宏，定义了获取、释放自旋锁的汇编指令。</span></span><span data-slate-leaf="true" data-offset-key="5212:1"><span data-slate-object="annotation" data-annotation-key="gkann_80ab36d2" data-attr-id="39005" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">spin_unlock_string 只是简单将锁值变量设置成 1，</span></span></span><span data-slate-leaf="true" data-offset-key="5212:2"><span data-slate-string="true">表示释放自旋锁，</span></span><span data-slate-leaf="true" data-offset-key="5212:3"><span data-slate-object="annotation" data-annotation-key="gkann_ab0b66d8" data-attr-id="39006" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">spin_lock_string 中并没有像我们 Cosmos 一样使用 xchg 指令，而是使用了 decb 指令，这条指令也能原子地执行减 1 操作。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5213"><span data-slate-object="text" data-key="5214"><span data-slate-leaf="true" data-offset-key="5214:0" data-first-offset="true"><span data-slate-string="true">开始锁值变量为 1 时，执行 decb 指令就变成了 0，0 就表示加锁成功。如果小于 0，则表示有其它进程已经加锁了，就会导致循环比较。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="5215" id="sr-toc-5"><span data-slate-object="text" data-key="5216"><span data-slate-leaf="true" data-offset-key="5216:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5d2ca6c3" data-attr-id="29700" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Linux 排队自旋锁</span></span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="5217"><span data-slate-object="text" data-key="5218"><span data-slate-leaf="true" data-offset-key="5218:0" data-first-offset="true"><span data-slate-string="true">现在我们再来看看 100 个进程获取同一个自旋锁的情况，开始 1 个进程获取了自旋锁 L，后面继续来了 99 个进程，它们都要获取自旋锁 L，但是它们必须等待，这时第 1 进程释放了自旋锁 L。请问，这 99 个进程中谁能先获取自旋锁 L 呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5219"><span data-slate-object="text" data-key="5220"><span data-slate-leaf="true" data-offset-key="5220:0" data-first-offset="true"><span data-slate-string="true">答案是不确定，因为这个次序依赖于哪个 CPU 核心能最先访问内存，而哪个 CPU 核心可以访问内存是由</span></span></span><span data-slate-object="text" data-key="5221"><span data-slate-leaf="true" data-offset-key="5221:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">总线仲裁协议</span></span></span></span><span data-slate-object="text" data-key="5222"><span data-slate-leaf="true" data-offset-key="5222:0" data-first-offset="true"><span data-slate-string="true">决定的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5223"><span data-slate-object="text" data-key="5224"><span data-slate-leaf="true" data-offset-key="5224:0" data-first-offset="true"><span data-slate-string="true">很有可能最后来的进程最先获取自旋锁 L，这对其它等待的进程极其不公平，为了解决获取自旋锁的</span></span></span><span data-slate-object="text" data-key="5225"><span data-slate-leaf="true" data-offset-key="5225:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">公平性</span></span></span></span><span data-slate-object="text" data-key="5226"><span data-slate-leaf="true" data-offset-key="5226:0" data-first-offset="true"><span data-slate-string="true">，Linux 开发出了排队自旋锁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5227"><span data-slate-object="text" data-key="5228"><span data-slate-leaf="true" data-offset-key="5228:0" data-first-offset="true"><span data-slate-string="true">你可以这样理解，想要给进程排好队，就需要确定顺序，也就是进程申请获取锁的先后次序，Linux 的排队自旋锁通过保存这个信息，就能更公平地调度进程了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5229"><span data-slate-object="text" data-key="5230"><span data-slate-leaf="true" data-offset-key="5230:0" data-first-offset="true"><span data-slate-string="true">为了保存顺序信息，排队自旋锁重新定义了数据结构。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="5231"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5232"><span data-slate-object="text" data-key="5233"><span data-slate-leaf="true" data-offset-key="5233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//RAW 层的自旋锁数据结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5234"><span data-slate-object="text" data-key="5235"><span data-slate-leaf="true" data-offset-key="5235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="5236"><span data-slate-leaf="true" data-offset-key="5236:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5237"><span data-slate-leaf="true" data-offset-key="5237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5238"><span data-slate-leaf="true" data-offset-key="5238:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5239"><span data-slate-leaf="true" data-offset-key="5239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock</span></span></span></span><span data-slate-object="text" data-key="5240"><span data-slate-leaf="true" data-offset-key="5240:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5241"><span data-slate-object="text" data-key="5242"><span data-slate-leaf="true" data-offset-key="5242:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5243"><span data-slate-leaf="true" data-offset-key="5243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="5244"><span data-slate-leaf="true" data-offset-key="5244:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5245"><span data-slate-leaf="true" data-offset-key="5245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5246"><span data-slate-leaf="true" data-offset-key="5246:0" data-first-offset="true"><span data-slate-string="true"> slock;</span></span></span><span data-slate-object="text" data-key="5247"><span data-slate-leaf="true" data-offset-key="5247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 真正的锁值变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5248"><span data-slate-object="text" data-key="5249"><span data-slate-leaf="true" data-offset-key="5249:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="5250"><span data-slate-leaf="true" data-offset-key="5250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5251"><span data-slate-leaf="true" data-offset-key="5251:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5252"><span data-slate-object="text" data-key="5253"><span data-slate-leaf="true" data-offset-key="5253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 最上层的自旋锁数据结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5254"><span data-slate-object="text" data-key="5255"><span data-slate-leaf="true" data-offset-key="5255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="5256"><span data-slate-leaf="true" data-offset-key="5256:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5257"><span data-slate-leaf="true" data-offset-key="5257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5258"><span data-slate-leaf="true" data-offset-key="5258:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5259"><span data-slate-leaf="true" data-offset-key="5259:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock</span></span></span></span><span data-slate-object="text" data-key="5260"><span data-slate-leaf="true" data-offset-key="5260:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5261"><span data-slate-object="text" data-key="5262"><span data-slate-leaf="true" data-offset-key="5262:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5263"><span data-slate-leaf="true" data-offset-key="5263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5264"><span data-slate-leaf="true" data-offset-key="5264:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5265"><span data-slate-leaf="true" data-offset-key="5265:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock</span></span></span></span><span data-slate-object="text" data-key="5266"><span data-slate-leaf="true" data-offset-key="5266:0" data-first-offset="true"><span data-slate-string="true"> rlock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5267"><span data-slate-object="text" data-key="5268"><span data-slate-leaf="true" data-offset-key="5268:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="5269"><span data-slate-leaf="true" data-offset-key="5269:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5270"><span data-slate-leaf="true" data-offset-key="5270:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5271"><span data-slate-object="text" data-key="5272"><span data-slate-leaf="true" data-offset-key="5272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//Linux 没有这样的结构，这只是为了描述方便</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5273"><span data-slate-object="text" data-key="5274"><span data-slate-leaf="true" data-offset-key="5274:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="5275"><span data-slate-leaf="true" data-offset-key="5275:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5276"><span data-slate-leaf="true" data-offset-key="5276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5277"><span data-slate-leaf="true" data-offset-key="5277:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5278"><span data-slate-leaf="true" data-offset-key="5278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock</span></span></span></span><span data-slate-object="text" data-key="5279"><span data-slate-leaf="true" data-offset-key="5279:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5280"><span data-slate-object="text" data-key="5281"><span data-slate-leaf="true" data-offset-key="5281:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5282"><span data-slate-leaf="true" data-offset-key="5282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">union</span></span></span></span><span data-slate-object="text" data-key="5283"><span data-slate-leaf="true" data-offset-key="5283:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5284"><span data-slate-object="text" data-key="5285"><span data-slate-leaf="true" data-offset-key="5285:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5286"><span data-slate-leaf="true" data-offset-key="5286:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="5287"><span data-slate-leaf="true" data-offset-key="5287:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5288"><span data-slate-leaf="true" data-offset-key="5288:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5289"><span data-slate-leaf="true" data-offset-key="5289:0" data-first-offset="true"><span data-slate-string="true"> slock;</span></span></span><span data-slate-object="text" data-key="5290"><span data-slate-leaf="true" data-offset-key="5290:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 真正的锁值变量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5291"><span data-slate-object="text" data-key="5292"><span data-slate-leaf="true" data-offset-key="5292:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5293"><span data-slate-leaf="true" data-offset-key="5293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5294"><span data-slate-leaf="true" data-offset-key="5294:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5295"><span data-slate-object="text" data-key="5296"><span data-slate-leaf="true" data-offset-key="5296:0" data-first-offset="true"><span data-slate-string="true">        u16 owner;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5297"><span data-slate-object="text" data-key="5298"><span data-slate-leaf="true" data-offset-key="5298:0" data-first-offset="true"><span data-slate-string="true">        u16 next;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5299"><span data-slate-object="text" data-key="5300"><span data-slate-leaf="true" data-offset-key="5300:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5301"><span data-slate-object="text" data-key="5302"><span data-slate-leaf="true" data-offset-key="5302:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5303"><span data-slate-object="text" data-key="5304"><span data-slate-leaf="true" data-offset-key="5304:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="5305"><span data-slate-leaf="true" data-offset-key="5305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5306"><span data-slate-leaf="true" data-offset-key="5306:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5307"><span data-slate-object="text" data-key="5308"><span data-slate-leaf="true" data-offset-key="5308:0" data-first-offset="true"><span data-slate-string="true">slock 域被分成两部分，分别保存</span></span></span><span data-slate-object="text" data-key="5309"><span data-slate-leaf="true" data-offset-key="5309:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">锁持有者</span></span></span></span><span data-slate-object="text" data-key="5310"><span data-slate-leaf="true" data-offset-key="5310:0" data-first-offset="true"><span data-slate-string="true">和</span></span></span><span data-slate-object="text" data-key="5311"><span data-slate-leaf="true" data-offset-key="5311:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">未来锁申请者</span></span></span></span><span data-slate-object="text" data-key="5312"><span data-slate-leaf="true" data-offset-key="5312:0" data-first-offset="true"><span data-slate-string="true">的序号，如上述代码 10～16 行所示。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5313"><span data-slate-object="text" data-key="5314"><span data-slate-leaf="true" data-offset-key="5314:0" data-first-offset="true"><span data-slate-string="true">只有 next 域与 owner 域相等时，才表示自旋锁处于未使用的状态（此时也没有进程申请该锁）。</span></span><span data-slate-leaf="true" data-offset-key="5314:1"><span data-slate-object="annotation" data-annotation-key="gkann_2609c6d4" data-attr-id="41037" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">在排队自旋锁初始化时，slock 被置为 0，即 next 和 owner 被置为 0，Linux 进程执行申请自旋锁时，原子地将 next 域加 1，并将原值返回作为自己的序号。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5315"><span data-slate-object="text" data-key="5316"><span data-slate-leaf="true" data-offset-key="5316:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_876c59eb" data-attr-id="38429" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果返回的序号等于申请时的 owner 值，说明自旋锁处于未使用的状态，则进程直接获得锁；否则，该进程循环检查 owner 域是否等于自己持有的序号，一旦相等，则表明锁轮到自己获取。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5317"><span data-slate-object="text" data-key="5318"><span data-slate-leaf="true" data-offset-key="5318:0" data-first-offset="true"><span data-slate-string="true">进程释放自旋锁时，原子地将 owner 域加 1 即可，下一个进程将会发现这一变化，从循环状态中退出。进程将严格地按照申请顺序依次获取排队自旋锁。这样一来，原先进程无序竞争的乱象就迎刃而解了。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="5319"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5320"><span data-slate-object="text" data-key="5321"><span data-slate-leaf="true" data-offset-key="5321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5322"><span data-slate-leaf="true" data-offset-key="5322:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5323"><span data-slate-leaf="true" data-offset-key="5323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span><span data-slate-object="text" data-key="5324"><span data-slate-leaf="true" data-offset-key="5324:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5325"><span data-slate-leaf="true" data-offset-key="5325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="5326"><span data-slate-leaf="true" data-offset-key="5326:0" data-first-offset="true"><span data-slate-string="true"> __raw_spin_lock(</span></span></span><span data-slate-object="text" data-key="5327"><span data-slate-leaf="true" data-offset-key="5327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5328"><span data-slate-leaf="true" data-offset-key="5328:0" data-first-offset="true"><span data-slate-string="true">*lock){</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5329"><span data-slate-object="text" data-key="5330"><span data-slate-leaf="true" data-offset-key="5330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5331"><span data-slate-leaf="true" data-offset-key="5331:0" data-first-offset="true"><span data-slate-string="true"> inc = </span></span></span><span data-slate-object="text" data-key="5332"><span data-slate-leaf="true" data-offset-key="5332:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0x00010000</span></span></span></span><span data-slate-object="text" data-key="5333"><span data-slate-leaf="true" data-offset-key="5333:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5334"><span data-slate-object="text" data-key="5335"><span data-slate-leaf="true" data-offset-key="5335:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5336"><span data-slate-leaf="true" data-offset-key="5336:0" data-first-offset="true"><span data-slate-string="true"> tmp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5337"><span data-slate-object="text" data-key="5338"><span data-slate-leaf="true" data-offset-key="5338:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_9dd0cff4" data-attr-id="39007" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">__asm__ __volatile__(</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5339"><span data-slate-object="text" data-key="5340"><span data-slate-leaf="true" data-offset-key="5340:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d056d8f9" data-attr-id="43151" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"lock ; xaddl %0, %1\n"</span></span></span></span></span><span data-slate-object="text" data-key="5341"><span data-slate-leaf="true" data-offset-key="5341:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d056d8f9" data-attr-id="43151" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5342"><span data-slate-leaf="true" data-offset-key="5342:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d056d8f9" data-attr-id="43151" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 inc 和 slock 交换，</span></span></span></span><span data-slate-leaf="true" data-offset-key="5342:1"><span data-slate-object="annotation" data-annotation-key="gkann_d056d8f9" data-attr-id="43151" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_436b9b50" data-attr-id="25754" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">然后 inc=inc+slock</span></span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5343"><span data-slate-object="text" data-key="5344"><span data-slate-leaf="true" data-offset-key="5344:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_49c55b8d" data-attr-id="41038" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_5850c98f" data-attr-id="25755" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">                        </span></span></span></span></span><span data-slate-object="text" data-key="5345"><span data-slate-leaf="true" data-offset-key="5345:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_49c55b8d" data-attr-id="41038" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_5850c98f" data-attr-id="25755" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 相当于原子读取 next 和 owner 并对 next+1</span></span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5346"><span data-slate-object="text" data-key="5347"><span data-slate-leaf="true" data-offset-key="5347:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movzwl %w0, %2\n\t"</span></span></span></span><span data-slate-object="text" data-key="5348"><span data-slate-leaf="true" data-offset-key="5348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 inc 的低 16 位做 0 扩展后送 tmp tmp=(u16) inc</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5349"><span data-slate-object="text" data-key="5350"><span data-slate-leaf="true" data-offset-key="5350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"shrl $16, %0\n\t"</span></span></span></span><span data-slate-object="text" data-key="5351"><span data-slate-leaf="true" data-offset-key="5351:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5352"><span data-slate-leaf="true" data-offset-key="5352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 inc 右移 16 位 inc=inc&gt;&gt;16</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5353"><span data-slate-object="text" data-key="5354"><span data-slate-leaf="true" data-offset-key="5354:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"1:\t"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5355"><span data-slate-object="text" data-key="5356"><span data-slate-leaf="true" data-offset-key="5356:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cmpl %0, %2\n\t"</span></span></span></span><span data-slate-object="text" data-key="5357"><span data-slate-leaf="true" data-offset-key="5357:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5358"><span data-slate-leaf="true" data-offset-key="5358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 比较 inc 和 tmp，即比较 next 和 owner </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5359"><span data-slate-object="text" data-key="5360"><span data-slate-leaf="true" data-offset-key="5360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"je 2f\n\t"</span></span></span></span><span data-slate-object="text" data-key="5361"><span data-slate-leaf="true" data-offset-key="5361:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5362"><span data-slate-leaf="true" data-offset-key="5362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 相等则跳转到标号 2 处返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5363"><span data-slate-object="text" data-key="5364"><span data-slate-leaf="true" data-offset-key="5364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rep ; nop\n\t"</span></span></span></span><span data-slate-object="text" data-key="5365"><span data-slate-leaf="true" data-offset-key="5365:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5366"><span data-slate-leaf="true" data-offset-key="5366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 空指令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5367"><span data-slate-object="text" data-key="5368"><span data-slate-leaf="true" data-offset-key="5368:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movzwl %1, %2\n\t"</span></span></span></span><span data-slate-object="text" data-key="5369"><span data-slate-leaf="true" data-offset-key="5369:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5370"><span data-slate-leaf="true" data-offset-key="5370:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 slock 的低 16 位做 0 扩展后送 tmp 即 tmp=owner</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5371"><span data-slate-object="text" data-key="5372"><span data-slate-leaf="true" data-offset-key="5372:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jmp 1b\n"</span></span></span></span><span data-slate-object="text" data-key="5373"><span data-slate-leaf="true" data-offset-key="5373:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5374"><span data-slate-leaf="true" data-offset-key="5374:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 跳转到标号 1 处继续比较</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5375"><span data-slate-object="text" data-key="5376"><span data-slate-leaf="true" data-offset-key="5376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"2:"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5377"><span data-slate-object="text" data-key="5378"><span data-slate-leaf="true" data-offset-key="5378:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="5379"><span data-slate-leaf="true" data-offset-key="5379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+Q"</span></span></span></span><span data-slate-object="text" data-key="5380"><span data-slate-leaf="true" data-offset-key="5380:0" data-first-offset="true"><span data-slate-string="true">(inc),</span></span></span><span data-slate-object="text" data-key="5381"><span data-slate-leaf="true" data-offset-key="5381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="5382"><span data-slate-leaf="true" data-offset-key="5382:0" data-first-offset="true"><span data-slate-string="true">(lock-&gt;slock),</span></span></span><span data-slate-object="text" data-key="5383"><span data-slate-leaf="true" data-offset-key="5383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=r"</span></span></span></span><span data-slate-object="text" data-key="5384"><span data-slate-leaf="true" data-offset-key="5384:0" data-first-offset="true"><span data-slate-string="true">(tmp)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5385"><span data-slate-object="text" data-key="5386"><span data-slate-leaf="true" data-offset-key="5386:0" data-first-offset="true"><span data-slate-string="true">::</span></span></span><span data-slate-object="text" data-key="5387"><span data-slate-leaf="true" data-offset-key="5387:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="5388"><span data-slate-leaf="true" data-offset-key="5388:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="5389"><span data-slate-leaf="true" data-offset-key="5389:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cc"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5390"><span data-slate-object="text" data-key="5391"><span data-slate-leaf="true" data-offset-key="5391:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5392"><span data-slate-object="text" data-key="5393"><span data-slate-leaf="true" data-offset-key="5393:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5394"><span data-slate-object="text" data-key="5395"><span data-slate-leaf="true" data-offset-key="5395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5396"><span data-slate-leaf="true" data-offset-key="5396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5397"><span data-slate-leaf="true" data-offset-key="5397:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> UNLOCK_LOCK_PREFIX LOCK_PREFIX</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5398"><span data-slate-object="text" data-key="5399"><span data-slate-leaf="true" data-offset-key="5399:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5400"><span data-slate-leaf="true" data-offset-key="5400:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5401"><span data-slate-leaf="true" data-offset-key="5401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span><span data-slate-object="text" data-key="5402"><span data-slate-leaf="true" data-offset-key="5402:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5403"><span data-slate-leaf="true" data-offset-key="5403:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="5404"><span data-slate-leaf="true" data-offset-key="5404:0" data-first-offset="true"><span data-slate-string="true"> __raw_spin_unlock(</span></span></span><span data-slate-object="text" data-key="5405"><span data-slate-leaf="true" data-offset-key="5405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5406"><span data-slate-leaf="true" data-offset-key="5406:0" data-first-offset="true"><span data-slate-string="true">*lock){</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5407"><span data-slate-object="text" data-key="5408"><span data-slate-leaf="true" data-offset-key="5408:0" data-first-offset="true"><span data-slate-string="true">__asm__ __volatile__(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5409"><span data-slate-object="text" data-key="5410"><span data-slate-leaf="true" data-offset-key="5410:0" data-first-offset="true"><span data-slate-string="true">UNLOCK_LOCK_PREFIX</span></span></span><span data-slate-object="text" data-key="5411"><span data-slate-leaf="true" data-offset-key="5411:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"incw %0"</span></span></span></span><span data-slate-object="text" data-key="5412"><span data-slate-leaf="true" data-offset-key="5412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 slock 的低 16 位加 1 即 owner+1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5413"><span data-slate-object="text" data-key="5414"><span data-slate-leaf="true" data-offset-key="5414:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="5415"><span data-slate-leaf="true" data-offset-key="5415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="5416"><span data-slate-leaf="true" data-offset-key="5416:0" data-first-offset="true"><span data-slate-string="true">(lock-&gt;slock)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5417"><span data-slate-object="text" data-key="5418"><span data-slate-leaf="true" data-offset-key="5418:0" data-first-offset="true"><span data-slate-string="true">::</span></span></span><span data-slate-object="text" data-key="5419"><span data-slate-leaf="true" data-offset-key="5419:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="5420"><span data-slate-leaf="true" data-offset-key="5420:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="5421"><span data-slate-leaf="true" data-offset-key="5421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cc"</span></span></span></span><span data-slate-object="text" data-key="5422"><span data-slate-leaf="true" data-offset-key="5422:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5423"><span data-slate-object="text" data-key="5424"><span data-slate-leaf="true" data-offset-key="5424:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5425"><span data-slate-object="text" data-key="5426"><span data-slate-leaf="true" data-offset-key="5426:0" data-first-offset="true"><span data-slate-string="true">上述代码中的注释已经描述得很清楚了，每条指令都有注解，供你参考。这里需要注意的是 Linux 为了避免差异性，在 spinlock_t 结构体中包含了 raw_spinlock_t，而在 raw_spinlock_t 结构体中并没使用 next 和 owner 字段，而是在代码中直接操作 slock 的高 16 位和低 16 位来实现的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5427"><span data-slate-object="text" data-key="5428"><span data-slate-leaf="true" data-offset-key="5428:0" data-first-offset="true"><span data-slate-string="true">不知道你有没有过这样的经历？当你去银行办事，又发现人很多时，你很可能会选择先去处理一些别的事情，等过一会人比较少了，再来办理我们自己的业务。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5429"><span data-slate-object="text" data-key="5430"><span data-slate-leaf="true" data-offset-key="5430:0" data-first-offset="true"><span data-slate-string="true">其实，在使用自旋锁时也有同样的情况，当一个进程发现另一个进程已经拥有自己所请求的自旋锁时，就自愿放弃，转而做其它别的工作，并不想在这里循环等待，浪费自己的时间。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5431"><span data-slate-object="text" data-key="5432"><span data-slate-leaf="true" data-offset-key="5432:0" data-first-offset="true"><span data-slate-string="true">对于这种情况，Linux 同样提供了相应的自旋锁接口，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="5433"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5434"><span data-slate-object="text" data-key="5435"><span data-slate-leaf="true" data-offset-key="5435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5436"><span data-slate-leaf="true" data-offset-key="5436:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5437"><span data-slate-leaf="true" data-offset-key="5437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span><span data-slate-object="text" data-key="5438"><span data-slate-leaf="true" data-offset-key="5438:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5439"><span data-slate-leaf="true" data-offset-key="5439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5440"><span data-slate-leaf="true" data-offset-key="5440:0" data-first-offset="true"><span data-slate-string="true"> __raw_spin_trylock(</span></span></span><span data-slate-object="text" data-key="5441"><span data-slate-leaf="true" data-offset-key="5441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5442"><span data-slate-leaf="true" data-offset-key="5442:0" data-first-offset="true"><span data-slate-string="true">*lock){</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5443"><span data-slate-object="text" data-key="5444"><span data-slate-leaf="true" data-offset-key="5444:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5445"><span data-slate-leaf="true" data-offset-key="5445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5446"><span data-slate-leaf="true" data-offset-key="5446:0" data-first-offset="true"><span data-slate-string="true"> tmp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5447"><span data-slate-object="text" data-key="5448"><span data-slate-leaf="true" data-offset-key="5448:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5449"><span data-slate-leaf="true" data-offset-key="5449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5450"><span data-slate-leaf="true" data-offset-key="5450:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5451"><span data-slate-leaf="true" data-offset-key="5451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="5452"><span data-slate-leaf="true" data-offset-key="5452:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5453"><span data-slate-object="text" data-key="5454"><span data-slate-leaf="true" data-offset-key="5454:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5455"><span data-slate-leaf="true" data-offset-key="5455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="5456"><span data-slate-leaf="true" data-offset-key="5456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5457"><span data-slate-leaf="true" data-offset-key="5457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="5458"><span data-slate-leaf="true" data-offset-key="5458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5459"><span data-slate-object="text" data-key="5460"><span data-slate-leaf="true" data-offset-key="5460:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5461"><span data-slate-leaf="true" data-offset-key="5461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movl %2,%0\n\t"</span></span></span></span><span data-slate-object="text" data-key="5462"><span data-slate-leaf="true" data-offset-key="5462:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//tmp=slock</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5463"><span data-slate-object="text" data-key="5464"><span data-slate-leaf="true" data-offset-key="5464:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5465"><span data-slate-leaf="true" data-offset-key="5465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movl %0,%1\n\t"</span></span></span></span><span data-slate-object="text" data-key="5466"><span data-slate-leaf="true" data-offset-key="5466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//new=tmp</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5467"><span data-slate-object="text" data-key="5468"><span data-slate-leaf="true" data-offset-key="5468:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5469"><span data-slate-leaf="true" data-offset-key="5469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"roll $16, %0\n\t"</span></span></span></span><span data-slate-object="text" data-key="5470"><span data-slate-leaf="true" data-offset-key="5470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//tmp 循环左移 16 位，即 next 和 owner 交换了</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5471"><span data-slate-object="text" data-key="5472"><span data-slate-leaf="true" data-offset-key="5472:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5473"><span data-slate-leaf="true" data-offset-key="5473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cmpl %0,%1\n\t"</span></span></span></span><span data-slate-object="text" data-key="5474"><span data-slate-leaf="true" data-offset-key="5474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 比较 tmp 和 new 即（owner、next）？=（next、owner）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5475"><span data-slate-object="text" data-key="5476"><span data-slate-leaf="true" data-offset-key="5476:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5477"><span data-slate-leaf="true" data-offset-key="5477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jne 1f\n\t"</span></span></span></span><span data-slate-object="text" data-key="5478"><span data-slate-leaf="true" data-offset-key="5478:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5479"><span data-slate-leaf="true" data-offset-key="5479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不等则跳转到标号 1 处 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5480"><span data-slate-object="text" data-key="5481"><span data-slate-leaf="true" data-offset-key="5481:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5482"><span data-slate-leaf="true" data-offset-key="5482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"addl $0x00010000, %1\n\t"</span></span></span></span><span data-slate-object="text" data-key="5483"><span data-slate-leaf="true" data-offset-key="5483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 相当于 next+1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5484"><span data-slate-object="text" data-key="5485"><span data-slate-leaf="true" data-offset-key="5485:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5486"><span data-slate-leaf="true" data-offset-key="5486:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"lock ; cmpxchgl %1,%2\n\t"</span></span></span></span><span data-slate-object="text" data-key="5487"><span data-slate-leaf="true" data-offset-key="5487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//new 和 slock 交换比较    </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5488"><span data-slate-object="text" data-key="5489"><span data-slate-leaf="true" data-offset-key="5489:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5490"><span data-slate-leaf="true" data-offset-key="5490:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"1:"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5491"><span data-slate-object="text" data-key="5492"><span data-slate-leaf="true" data-offset-key="5492:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5493"><span data-slate-leaf="true" data-offset-key="5493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"sete %b1\n\t"</span></span></span></span><span data-slate-object="text" data-key="5494"><span data-slate-leaf="true" data-offset-key="5494:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5495"><span data-slate-leaf="true" data-offset-key="5495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//new = eflags.ZF 位，ZF 取决于前面的判断是否相等</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5496"><span data-slate-object="text" data-key="5497"><span data-slate-leaf="true" data-offset-key="5497:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5498"><span data-slate-leaf="true" data-offset-key="5498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"movzbl %b1,%0\n\t"</span></span></span></span><span data-slate-object="text" data-key="5499"><span data-slate-leaf="true" data-offset-key="5499:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5500"><span data-slate-leaf="true" data-offset-key="5500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//tmp = new</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5501"><span data-slate-object="text" data-key="5502"><span data-slate-leaf="true" data-offset-key="5502:0" data-first-offset="true"><span data-slate-string="true">    :</span></span></span><span data-slate-object="text" data-key="5503"><span data-slate-leaf="true" data-offset-key="5503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=&amp;a"</span></span></span></span><span data-slate-object="text" data-key="5504"><span data-slate-leaf="true" data-offset-key="5504:0" data-first-offset="true"><span data-slate-string="true">(tmp),</span></span></span><span data-slate-object="text" data-key="5505"><span data-slate-leaf="true" data-offset-key="5505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"=Q"</span></span></span></span><span data-slate-object="text" data-key="5506"><span data-slate-leaf="true" data-offset-key="5506:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="5507"><span data-slate-leaf="true" data-offset-key="5507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="5508"><span data-slate-leaf="true" data-offset-key="5508:0" data-first-offset="true"><span data-slate-string="true">),</span></span></span><span data-slate-object="text" data-key="5509"><span data-slate-leaf="true" data-offset-key="5509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="5510"><span data-slate-leaf="true" data-offset-key="5510:0" data-first-offset="true"><span data-slate-string="true">(lock-&gt;slock)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5511"><span data-slate-object="text" data-key="5512"><span data-slate-leaf="true" data-offset-key="5512:0" data-first-offset="true"><span data-slate-string="true">    ::</span></span></span><span data-slate-object="text" data-key="5513"><span data-slate-leaf="true" data-offset-key="5513:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="5514"><span data-slate-leaf="true" data-offset-key="5514:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="5515"><span data-slate-leaf="true" data-offset-key="5515:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"cc"</span></span></span></span><span data-slate-object="text" data-key="5516"><span data-slate-leaf="true" data-offset-key="5516:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5517"><span data-slate-object="text" data-key="5518"><span data-slate-leaf="true" data-offset-key="5518:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5519"><span data-slate-leaf="true" data-offset-key="5519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5520"><span data-slate-leaf="true" data-offset-key="5520:0" data-first-offset="true"><span data-slate-string="true"> tmp;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5521"><span data-slate-object="text" data-key="5522"><span data-slate-leaf="true" data-offset-key="5522:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5523"><span data-slate-object="text" data-key="5524"><span data-slate-leaf="true" data-offset-key="5524:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5525"><span data-slate-leaf="true" data-offset-key="5525:0" data-first-offset="true"><span data-slate-string="true"> __lockfunc _spin_trylock(</span></span></span><span data-slate-object="text" data-key="5526"><span data-slate-leaf="true" data-offset-key="5526:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5527"><span data-slate-leaf="true" data-offset-key="5527:0" data-first-offset="true"><span data-slate-string="true">*lock){ </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5528"><span data-slate-object="text" data-key="5529"><span data-slate-leaf="true" data-offset-key="5529:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5530"><span data-slate-leaf="true" data-offset-key="5530:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">preempt_disable</span></span></span></span><span data-slate-object="text" data-key="5531"><span data-slate-leaf="true" data-offset-key="5531:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5532"><span data-slate-object="text" data-key="5533"><span data-slate-leaf="true" data-offset-key="5533:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5534"><span data-slate-leaf="true" data-offset-key="5534:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5535"><span data-slate-leaf="true" data-offset-key="5535:0" data-first-offset="true"><span data-slate-string="true">(_raw_spin_trylock(lock)){</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5536"><span data-slate-object="text" data-key="5537"><span data-slate-leaf="true" data-offset-key="5537:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5538"><span data-slate-leaf="true" data-offset-key="5538:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">spin_acquire</span></span></span></span><span data-slate-object="text" data-key="5539"><span data-slate-leaf="true" data-offset-key="5539:0" data-first-offset="true"><span data-slate-string="true">(&amp;lock-&gt;dep_map,</span></span></span><span data-slate-object="text" data-key="5540"><span data-slate-leaf="true" data-offset-key="5540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5541"><span data-slate-leaf="true" data-offset-key="5541:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span><span data-slate-object="text" data-key="5542"><span data-slate-leaf="true" data-offset-key="5542:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="5543"><span data-slate-leaf="true" data-offset-key="5543:0" data-first-offset="true"><span data-slate-string="true">,_RET_IP_);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5544"><span data-slate-object="text" data-key="5545"><span data-slate-leaf="true" data-offset-key="5545:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5546"><span data-slate-leaf="true" data-offset-key="5546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5547"><span data-slate-leaf="true" data-offset-key="5547:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5548"><span data-slate-leaf="true" data-offset-key="5548:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="5549"><span data-slate-leaf="true" data-offset-key="5549:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5550"><span data-slate-object="text" data-key="5551"><span data-slate-leaf="true" data-offset-key="5551:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5552"><span data-slate-object="text" data-key="5553"><span data-slate-leaf="true" data-offset-key="5553:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5554"><span data-slate-leaf="true" data-offset-key="5554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">preempt_enable</span></span></span></span><span data-slate-object="text" data-key="5555"><span data-slate-leaf="true" data-offset-key="5555:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5556"><span data-slate-object="text" data-key="5557"><span data-slate-leaf="true" data-offset-key="5557:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5558"><span data-slate-leaf="true" data-offset-key="5558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5559"><span data-slate-leaf="true" data-offset-key="5559:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5560"><span data-slate-leaf="true" data-offset-key="5560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5561"><span data-slate-leaf="true" data-offset-key="5561:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5562"><span data-slate-object="text" data-key="5563"><span data-slate-leaf="true" data-offset-key="5563:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5564"><span data-slate-object="text" data-key="5565"><span data-slate-leaf="true" data-offset-key="5565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5566"><span data-slate-leaf="true" data-offset-key="5566:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5567"><span data-slate-leaf="true" data-offset-key="5567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> spin_trylock(lock) __cond_lock(lock, _spin_trylock(lock))</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5568"><span data-slate-object="text" data-key="5569"><span data-slate-leaf="true" data-offset-key="5569:0" data-first-offset="true"><span data-slate-string="true">_cond_lock 只用代码静态检查工作，一定要明白 _spin_trylock 返回 1 表示尝试加锁成功，可以安全的地问共享资源了；返回值为 0 则表示尝试加锁失败，不能操作共享资源，应该等一段时间，再次尝试加锁。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5570" id="sr-toc-6"><span data-slate-object="text" data-key="5571"><span data-slate-leaf="true" data-offset-key="5571:0" data-first-offset="true"><span data-slate-string="true">Linux 信号量</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5572"><span data-slate-object="text" data-key="5573"><span data-slate-leaf="true" data-offset-key="5573:0" data-first-offset="true"><span data-slate-string="true">Linux 中的信号量同样是用来保护共享资源，能保证资源在一个时刻只有一个进程使用，这是单值信号量。也可以作为资源计数器，比如一种资源有五份，同时最多可以有五个进程，这是多值信号量。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5574"><span data-slate-object="text" data-key="5575"><span data-slate-leaf="true" data-offset-key="5575:0" data-first-offset="true"><span data-slate-string="true">单值信号量，类比于私人空间一次只进去一个人，其信号量的值初始值为 1，而多值信号量，相当于是客厅，可同时容纳多个人。其信号量的值初始值为 5，就可容纳 5 个人。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5576"><span data-slate-object="text" data-key="5577"><span data-slate-leaf="true" data-offset-key="5577:0" data-first-offset="true"><span data-slate-string="true">信号量的值为正的时候。所申请的进程可以锁定使用它。若为 0，说明它被其它进程占用，申请的进程要进入睡眠队列中，等待被唤醒。所以信号量最大的优势是既</span></span></span><span data-slate-object="text" data-key="5578"><span data-slate-leaf="true" data-offset-key="5578:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">可以使申请失败的进程睡眠，还可以作为资源计数器使用。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5579"><span data-slate-object="text" data-key="5580"><span data-slate-leaf="true" data-offset-key="5580:0" data-first-offset="true"><span data-slate-string="true">我们先来看看 Linux 实现信号量所使用的数据结构，如下所示：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="5581"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5582"><span data-slate-object="text" data-key="5583"><span data-slate-leaf="true" data-offset-key="5583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5584"><span data-slate-leaf="true" data-offset-key="5584:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5585"><span data-slate-leaf="true" data-offset-key="5585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">semaphore</span></span></span></span><span data-slate-object="text" data-key="5586"><span data-slate-leaf="true" data-offset-key="5586:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5587"><span data-slate-object="text" data-key="5588"><span data-slate-leaf="true" data-offset-key="5588:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5589"><span data-slate-leaf="true" data-offset-key="5589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spinlock_t</span></span></span></span><span data-slate-object="text" data-key="5590"><span data-slate-leaf="true" data-offset-key="5590:0" data-first-offset="true"><span data-slate-string="true"> lock;</span></span></span><span data-slate-object="text" data-key="5591"><span data-slate-leaf="true" data-offset-key="5591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 保护信号量自身的自旋锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5592"><span data-slate-object="text" data-key="5593"><span data-slate-leaf="true" data-offset-key="5593:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5594"><span data-slate-leaf="true" data-offset-key="5594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="5595"><span data-slate-leaf="true" data-offset-key="5595:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5596"><span data-slate-leaf="true" data-offset-key="5596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5597"><span data-slate-leaf="true" data-offset-key="5597:0" data-first-offset="true"><span data-slate-string="true"> count;</span></span></span><span data-slate-object="text" data-key="5598"><span data-slate-leaf="true" data-offset-key="5598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 信号量值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5599"><span data-slate-object="text" data-key="5600"><span data-slate-leaf="true" data-offset-key="5600:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5601"><span data-slate-leaf="true" data-offset-key="5601:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5602"><span data-slate-leaf="true" data-offset-key="5602:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5603"><span data-slate-leaf="true" data-offset-key="5603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_head</span></span></span></span><span data-slate-object="text" data-key="5604"><span data-slate-leaf="true" data-offset-key="5604:0" data-first-offset="true"><span data-slate-string="true"> wait_list;</span></span></span><span data-slate-object="text" data-key="5605"><span data-slate-leaf="true" data-offset-key="5605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 挂载睡眠等待进程的链表</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5606"><span data-slate-object="text" data-key="5607"><span data-slate-leaf="true" data-offset-key="5607:0" data-first-offset="true"><span data-slate-string="true">};</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5608"><span data-slate-object="text" data-key="5609"><span data-slate-leaf="true" data-offset-key="5609:0" data-first-offset="true"><span data-slate-string="true">下面我们就跟着 Linux 信号量接口函数，一步步探索 Linux 信号量工作原理，和它对进程状态的影响，先来看看 Linux 信号量的使用案例，如下所示。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="5610"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5611"><span data-slate-object="text" data-key="5612"><span data-slate-leaf="true" data-offset-key="5612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5613"><span data-slate-leaf="true" data-offset-key="5613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5614"><span data-slate-leaf="true" data-offset-key="5614:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> down_console_sem() do { \</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5615"><span data-slate-object="text" data-key="5616"><span data-slate-leaf="true" data-offset-key="5616:0" data-first-offset="true"><span data-slate-string="true">    down(&amp;console_sem);\</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5617"><span data-slate-object="text" data-key="5618"><span data-slate-leaf="true" data-offset-key="5618:0" data-first-offset="true"><span data-slate-string="true">} while (0)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5619"><span data-slate-object="text" data-key="5620"><span data-slate-leaf="true" data-offset-key="5620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5621"><span data-slate-leaf="true" data-offset-key="5621:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5622"><span data-slate-leaf="true" data-offset-key="5622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="5623"><span data-slate-leaf="true" data-offset-key="5623:0" data-first-offset="true"><span data-slate-string="true"> __up_console_sem(</span></span></span><span data-slate-object="text" data-key="5624"><span data-slate-leaf="true" data-offset-key="5624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="5625"><span data-slate-leaf="true" data-offset-key="5625:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5626"><span data-slate-leaf="true" data-offset-key="5626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="5627"><span data-slate-leaf="true" data-offset-key="5627:0" data-first-offset="true"><span data-slate-string="true"> ip) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5628"><span data-slate-object="text" data-key="5629"><span data-slate-leaf="true" data-offset-key="5629:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5630"><span data-slate-leaf="true" data-offset-key="5630:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">up</span></span></span></span><span data-slate-object="text" data-key="5631"><span data-slate-leaf="true" data-offset-key="5631:0" data-first-offset="true"><span data-slate-string="true">(&amp;console_sem);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5632"><span data-slate-object="text" data-key="5633"><span data-slate-leaf="true" data-offset-key="5633:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5634"><span data-slate-object="text" data-key="5635"><span data-slate-leaf="true" data-offset-key="5635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="5636"><span data-slate-leaf="true" data-offset-key="5636:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="5637"><span data-slate-leaf="true" data-offset-key="5637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> up_console_sem() __up_console_sem(_RET_IP_)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5638"><span data-slate-object="text" data-key="5639"><span data-slate-leaf="true" data-offset-key="5639:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加锁 console</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5640"><span data-slate-object="text" data-key="5641"><span data-slate-leaf="true" data-offset-key="5641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="5642"><span data-slate-leaf="true" data-offset-key="5642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5643"><span data-slate-leaf="true" data-offset-key="5643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">console_lock</span></span></span></span></span><span data-slate-object="text" data-key="5644"><span data-slate-leaf="true" data-offset-key="5644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="5645"><span data-slate-leaf="true" data-offset-key="5645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="5646"><span data-slate-leaf="true" data-offset-key="5646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5647"><span data-slate-object="text" data-key="5648"><span data-slate-leaf="true" data-offset-key="5648:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5649"><span data-slate-object="text" data-key="5650"><span data-slate-leaf="true" data-offset-key="5650:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5651"><span data-slate-leaf="true" data-offset-key="5651:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">might_sleep</span></span></span></span><span data-slate-object="text" data-key="5652"><span data-slate-leaf="true" data-offset-key="5652:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5653"><span data-slate-object="text" data-key="5654"><span data-slate-leaf="true" data-offset-key="5654:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5655"><span data-slate-leaf="true" data-offset-key="5655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">down_console_sem</span></span></span></span><span data-slate-object="text" data-key="5656"><span data-slate-leaf="true" data-offset-key="5656:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="5657"><span data-slate-leaf="true" data-offset-key="5657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取信号量 console_sem</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5658"><span data-slate-object="text" data-key="5659"><span data-slate-leaf="true" data-offset-key="5659:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5660"><span data-slate-leaf="true" data-offset-key="5660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5661"><span data-slate-leaf="true" data-offset-key="5661:0" data-first-offset="true"><span data-slate-string="true"> (console_suspended)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5662"><span data-slate-object="text" data-key="5663"><span data-slate-leaf="true" data-offset-key="5663:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5664"><span data-slate-leaf="true" data-offset-key="5664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5665"><span data-slate-leaf="true" data-offset-key="5665:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5666"><span data-slate-object="text" data-key="5667"><span data-slate-leaf="true" data-offset-key="5667:0" data-first-offset="true"><span data-slate-string="true">    console_locked = </span></span></span><span data-slate-object="text" data-key="5668"><span data-slate-leaf="true" data-offset-key="5668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="5669"><span data-slate-leaf="true" data-offset-key="5669:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5670"><span data-slate-object="text" data-key="5671"><span data-slate-leaf="true" data-offset-key="5671:0" data-first-offset="true"><span data-slate-string="true">    console_may_schedule = </span></span></span><span data-slate-object="text" data-key="5672"><span data-slate-leaf="true" data-offset-key="5672:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="5673"><span data-slate-leaf="true" data-offset-key="5673:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5674"><span data-slate-object="text" data-key="5675"><span data-slate-leaf="true" data-offset-key="5675:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5676"><span data-slate-object="text" data-key="5677"><span data-slate-leaf="true" data-offset-key="5677:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 解锁 console</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5678"><span data-slate-object="text" data-key="5679"><span data-slate-leaf="true" data-offset-key="5679:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="5680"><span data-slate-leaf="true" data-offset-key="5680:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5681"><span data-slate-leaf="true" data-offset-key="5681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">console_unlock</span></span></span></span></span><span data-slate-object="text" data-key="5682"><span data-slate-leaf="true" data-offset-key="5682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="5683"><span data-slate-leaf="true" data-offset-key="5683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span></span><span data-slate-object="text" data-key="5684"><span data-slate-leaf="true" data-offset-key="5684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5685"><span data-slate-object="text" data-key="5686"><span data-slate-leaf="true" data-offset-key="5686:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5687"><span data-slate-object="text" data-key="5688"><span data-slate-leaf="true" data-offset-key="5688:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5689"><span data-slate-leaf="true" data-offset-key="5689:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5690"><span data-slate-leaf="true" data-offset-key="5690:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5691"><span data-slate-leaf="true" data-offset-key="5691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="5692"><span data-slate-leaf="true" data-offset-key="5692:0" data-first-offset="true"><span data-slate-string="true"> ext_text[CONSOLE_EXT_LOG_MAX];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5693"><span data-slate-object="text" data-key="5694"><span data-slate-leaf="true" data-offset-key="5694:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5695"><span data-slate-leaf="true" data-offset-key="5695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5696"><span data-slate-leaf="true" data-offset-key="5696:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5697"><span data-slate-leaf="true" data-offset-key="5697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">char</span></span></span></span><span data-slate-object="text" data-key="5698"><span data-slate-leaf="true" data-offset-key="5698:0" data-first-offset="true"><span data-slate-string="true"> text[LOG_LINE_MAX + PREFIX_MAX];</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5699"><span data-slate-object="text" data-key="5700"><span data-slate-leaf="true" data-offset-key="5700:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5701"><span data-slate-leaf="true" data-offset-key="5701:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//…… 删除了很多代码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5702"><span data-slate-object="text" data-key="5703"><span data-slate-leaf="true" data-offset-key="5703:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5704"><span data-slate-leaf="true" data-offset-key="5704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">up_console_sem</span></span></span></span><span data-slate-object="text" data-key="5705"><span data-slate-leaf="true" data-offset-key="5705:0" data-first-offset="true"><span data-slate-string="true">();</span></span></span><span data-slate-object="text" data-key="5706"><span data-slate-leaf="true" data-offset-key="5706:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放信号量 console_sem</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5707"><span data-slate-object="text" data-key="5708"><span data-slate-leaf="true" data-offset-key="5708:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5709"><span data-slate-leaf="true" data-offset-key="5709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spin_lock</span></span></span></span><span data-slate-object="text" data-key="5710"><span data-slate-leaf="true" data-offset-key="5710:0" data-first-offset="true"><span data-slate-string="true">(&amp;logbuf_lock);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5711"><span data-slate-object="text" data-key="5712"><span data-slate-leaf="true" data-offset-key="5712:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5713"><span data-slate-leaf="true" data-offset-key="5713:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//…… 删除了很多代码   </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5714"><span data-slate-object="text" data-key="5715"><span data-slate-leaf="true" data-offset-key="5715:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5716"><span data-slate-object="text" data-key="5717"><span data-slate-leaf="true" data-offset-key="5717:0" data-first-offset="true"><span data-slate-string="true">为了简单说明问题，我删除了很多代码，上面代码中以 console 驱动为例说明了信号量的使用。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5718"><span data-slate-object="text" data-key="5719"><span data-slate-leaf="true" data-offset-key="5719:0" data-first-offset="true"><span data-slate-string="true">在 Linux 源代码的 kernel/printk.c 中，使用宏 DEFINE_SEMAPHORE 声明了一个单值信号量 console_sem，也可以说是</span></span></span><span data-slate-object="text" data-key="5720"><span data-slate-leaf="true" data-offset-key="5720:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">互斥锁</span></span></span></span><span data-slate-object="text" data-key="5721"><span data-slate-leaf="true" data-offset-key="5721:0" data-first-offset="true"><span data-slate-string="true">，它用于保护 console 驱动列表 console_drivers 以及同步对整个 console 驱动的访问。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5722"><span data-slate-object="text" data-key="5723"><span data-slate-leaf="true" data-offset-key="5723:0" data-first-offset="true"><span data-slate-string="true">其中定义了宏 down_console_sem () 来获得信号量 console_sem，定义了宏 up_console_sem () 来释放信号量 console_sem，console_lock 和 console_unlock 函数是用于互斥访问 console 驱动的，核心操作就是调用前面定义两个宏。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5724"><span data-slate-object="text" data-key="5725"><span data-slate-leaf="true" data-offset-key="5725:0" data-first-offset="true"><span data-slate-string="true">上面的情景中，down_console_sem () 和 up_console_sem () 宏的核心主要是调用了信号量的接口函数 down、up 函数，完成获取、释放信号量的核心操作，代码如下。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="5726"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="5727"><span data-slate-object="text" data-key="5728"><span data-slate-leaf="true" data-offset-key="5728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5729"><span data-slate-leaf="true" data-offset-key="5729:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5730"><span data-slate-leaf="true" data-offset-key="5730:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span><span data-slate-object="text" data-key="5731"><span data-slate-leaf="true" data-offset-key="5731:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5732"><span data-slate-leaf="true" data-offset-key="5732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="5733"><span data-slate-leaf="true" data-offset-key="5733:0" data-first-offset="true"><span data-slate-string="true"> __sched __down_common(</span></span></span><span data-slate-object="text" data-key="5734"><span data-slate-leaf="true" data-offset-key="5734:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5735"><span data-slate-leaf="true" data-offset-key="5735:0" data-first-offset="true"><span data-slate-string="true"> semaphore *sem, </span></span></span><span data-slate-object="text" data-key="5736"><span data-slate-leaf="true" data-offset-key="5736:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="5737"><span data-slate-leaf="true" data-offset-key="5737:0" data-first-offset="true"><span data-slate-string="true"> state,</span></span></span><span data-slate-object="text" data-key="5738"><span data-slate-leaf="true" data-offset-key="5738:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="5739"><span data-slate-leaf="true" data-offset-key="5739:0" data-first-offset="true"><span data-slate-string="true"> timeout)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5740"><span data-slate-object="text" data-key="5741"><span data-slate-leaf="true" data-offset-key="5741:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5742"><span data-slate-object="text" data-key="5743"><span data-slate-leaf="true" data-offset-key="5743:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5744"><span data-slate-leaf="true" data-offset-key="5744:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5745"><span data-slate-leaf="true" data-offset-key="5745:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5746"><span data-slate-leaf="true" data-offset-key="5746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">semaphore_waiter</span></span></span></span><span data-slate-object="text" data-key="5747"><span data-slate-leaf="true" data-offset-key="5747:0" data-first-offset="true"><span data-slate-string="true"> waiter;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5748"><span data-slate-object="text" data-key="5749"><span data-slate-leaf="true" data-offset-key="5749:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5750"><span data-slate-leaf="true" data-offset-key="5750:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 把 waiter 加入 sem-&gt;wait_list 的头部</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5751"><span data-slate-object="text" data-key="5752"><span data-slate-leaf="true" data-offset-key="5752:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5753"><span data-slate-leaf="true" data-offset-key="5753:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_add_tail</span></span></span></span><span data-slate-object="text" data-key="5754"><span data-slate-leaf="true" data-offset-key="5754:0" data-first-offset="true"><span data-slate-string="true">(&amp;waiter.list, &amp;sem-&gt;wait_list);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5755"><span data-slate-object="text" data-key="5756"><span data-slate-leaf="true" data-offset-key="5756:0" data-first-offset="true"><span data-slate-string="true">    waiter.task = current;</span></span></span><span data-slate-object="text" data-key="5757"><span data-slate-leaf="true" data-offset-key="5757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//current 表示当前进程，即调用该函数的进程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5758"><span data-slate-object="text" data-key="5759"><span data-slate-leaf="true" data-offset-key="5759:0" data-first-offset="true"><span data-slate-string="true">    waiter.up = </span></span></span><span data-slate-object="text" data-key="5760"><span data-slate-leaf="true" data-offset-key="5760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span><span data-slate-object="text" data-key="5761"><span data-slate-leaf="true" data-offset-key="5761:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5762"><span data-slate-object="text" data-key="5763"><span data-slate-leaf="true" data-offset-key="5763:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5764"><span data-slate-leaf="true" data-offset-key="5764:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="5765"><span data-slate-leaf="true" data-offset-key="5765:0" data-first-offset="true"><span data-slate-string="true"> (;;) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5766"><span data-slate-object="text" data-key="5767"><span data-slate-leaf="true" data-offset-key="5767:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5768"><span data-slate-leaf="true" data-offset-key="5768:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5769"><span data-slate-leaf="true" data-offset-key="5769:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="5770"><span data-slate-leaf="true" data-offset-key="5770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">signal_pending_state</span></span></span></span><span data-slate-object="text" data-key="5771"><span data-slate-leaf="true" data-offset-key="5771:0" data-first-offset="true"><span data-slate-string="true">(state, current))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5772"><span data-slate-object="text" data-key="5773"><span data-slate-leaf="true" data-offset-key="5773:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="5774"><span data-slate-leaf="true" data-offset-key="5774:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="5775"><span data-slate-leaf="true" data-offset-key="5775:0" data-first-offset="true"><span data-slate-string="true"> interrupted;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5776"><span data-slate-object="text" data-key="5777"><span data-slate-leaf="true" data-offset-key="5777:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5778"><span data-slate-leaf="true" data-offset-key="5778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5779"><span data-slate-leaf="true" data-offset-key="5779:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="5780"><span data-slate-leaf="true" data-offset-key="5780:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unlikely</span></span></span></span><span data-slate-object="text" data-key="5781"><span data-slate-leaf="true" data-offset-key="5781:0" data-first-offset="true"><span data-slate-string="true">(timeout &lt;= </span></span></span><span data-slate-object="text" data-key="5782"><span data-slate-leaf="true" data-offset-key="5782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5783"><span data-slate-leaf="true" data-offset-key="5783:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5784"><span data-slate-object="text" data-key="5785"><span data-slate-leaf="true" data-offset-key="5785:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="5786"><span data-slate-leaf="true" data-offset-key="5786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">goto</span></span></span></span><span data-slate-object="text" data-key="5787"><span data-slate-leaf="true" data-offset-key="5787:0" data-first-offset="true"><span data-slate-string="true"> timed_out;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5788"><span data-slate-object="text" data-key="5789"><span data-slate-leaf="true" data-offset-key="5789:0" data-first-offset="true"><span data-slate-string="true">        __set_current_state(state);</span></span></span><span data-slate-object="text" data-key="5790"><span data-slate-leaf="true" data-offset-key="5790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置当前进程的状态，进程睡眠，即先前__down 函数中传入的 TASK_UNINTERRUPTIBLE：该状态是等待资源有效时唤醒（比如等待键盘输入、socket 连接、信号（signal）等等），但不可以被中断唤醒</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5791"><span data-slate-object="text" data-key="5792"><span data-slate-leaf="true" data-offset-key="5792:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5793"><span data-slate-leaf="true" data-offset-key="5793:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spin_unlock_irq</span></span></span></span><span data-slate-object="text" data-key="5794"><span data-slate-leaf="true" data-offset-key="5794:0" data-first-offset="true"><span data-slate-string="true">(&amp;sem-&gt;lock);</span></span></span><span data-slate-object="text" data-key="5795"><span data-slate-leaf="true" data-offset-key="5795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放在 down 函数中加的锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5796"><span data-slate-object="text" data-key="5797"><span data-slate-leaf="true" data-offset-key="5797:0" data-first-offset="true"><span data-slate-string="true">        timeout = </span></span></span><span data-slate-object="text" data-key="5798"><span data-slate-leaf="true" data-offset-key="5798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">schedule_timeout</span></span></span></span><span data-slate-object="text" data-key="5799"><span data-slate-leaf="true" data-offset-key="5799:0" data-first-offset="true"><span data-slate-string="true">(timeout);</span></span></span><span data-slate-object="text" data-key="5800"><span data-slate-leaf="true" data-offset-key="5800:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 真正进入睡眠</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5801"><span data-slate-object="text" data-key="5802"><span data-slate-leaf="true" data-offset-key="5802:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5803"><span data-slate-leaf="true" data-offset-key="5803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spin_lock_irq</span></span></span></span><span data-slate-object="text" data-key="5804"><span data-slate-leaf="true" data-offset-key="5804:0" data-first-offset="true"><span data-slate-string="true">(&amp;sem-&gt;lock);</span></span></span><span data-slate-object="text" data-key="5805"><span data-slate-leaf="true" data-offset-key="5805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进程下次运行会回到这里，所以要加锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5806"><span data-slate-object="text" data-key="5807"><span data-slate-leaf="true" data-offset-key="5807:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="5808"><span data-slate-leaf="true" data-offset-key="5808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5809"><span data-slate-leaf="true" data-offset-key="5809:0" data-first-offset="true"><span data-slate-string="true"> (waiter.up)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5810"><span data-slate-object="text" data-key="5811"><span data-slate-leaf="true" data-offset-key="5811:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="5812"><span data-slate-leaf="true" data-offset-key="5812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5813"><span data-slate-leaf="true" data-offset-key="5813:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5814"><span data-slate-leaf="true" data-offset-key="5814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5815"><span data-slate-leaf="true" data-offset-key="5815:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5816"><span data-slate-object="text" data-key="5817"><span data-slate-leaf="true" data-offset-key="5817:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5818"><span data-slate-object="text" data-key="5819"><span data-slate-leaf="true" data-offset-key="5819:0" data-first-offset="true"><span data-slate-string="true"> timed_out:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5820"><span data-slate-object="text" data-key="5821"><span data-slate-leaf="true" data-offset-key="5821:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5822"><span data-slate-leaf="true" data-offset-key="5822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_del</span></span></span></span><span data-slate-object="text" data-key="5823"><span data-slate-leaf="true" data-offset-key="5823:0" data-first-offset="true"><span data-slate-string="true">(&amp;waiter.list);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5824"><span data-slate-object="text" data-key="5825"><span data-slate-leaf="true" data-offset-key="5825:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5826"><span data-slate-leaf="true" data-offset-key="5826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5827"><span data-slate-leaf="true" data-offset-key="5827:0" data-first-offset="true"><span data-slate-string="true"> -ETIME;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5828"><span data-slate-object="text" data-key="5829"><span data-slate-leaf="true" data-offset-key="5829:0" data-first-offset="true"><span data-slate-string="true"> interrupted:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5830"><span data-slate-object="text" data-key="5831"><span data-slate-leaf="true" data-offset-key="5831:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5832"><span data-slate-leaf="true" data-offset-key="5832:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_del</span></span></span></span><span data-slate-object="text" data-key="5833"><span data-slate-leaf="true" data-offset-key="5833:0" data-first-offset="true"><span data-slate-string="true">(&amp;waiter.list);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5834"><span data-slate-object="text" data-key="5835"><span data-slate-leaf="true" data-offset-key="5835:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5836"><span data-slate-leaf="true" data-offset-key="5836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="5837"><span data-slate-leaf="true" data-offset-key="5837:0" data-first-offset="true"><span data-slate-string="true"> -EINTR;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5838"></div><div data-slate-type="code-line" data-slate-object="block" data-key="5839"><span data-slate-object="text" data-key="5840"><span data-slate-leaf="true" data-offset-key="5840:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5841"><span data-slate-leaf="true" data-offset-key="5841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为了简单起见处理进程信号（signal）和超时的逻辑代码我已经删除</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5842"><span data-slate-object="text" data-key="5843"><span data-slate-leaf="true" data-offset-key="5843:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5844"><span data-slate-object="text" data-key="5845"><span data-slate-leaf="true" data-offset-key="5845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 进入睡眠等待</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5846"><span data-slate-object="text" data-key="5847"><span data-slate-leaf="true" data-offset-key="5847:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5848"><span data-slate-leaf="true" data-offset-key="5848:0" data-first-offset="true"><span data-slate-string="true"> noinline </span></span></span><span data-slate-object="text" data-key="5849"><span data-slate-leaf="true" data-offset-key="5849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="5850"><span data-slate-leaf="true" data-offset-key="5850:0" data-first-offset="true"><span data-slate-string="true"> __sched __down(</span></span></span><span data-slate-object="text" data-key="5851"><span data-slate-leaf="true" data-offset-key="5851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5852"><span data-slate-leaf="true" data-offset-key="5852:0" data-first-offset="true"><span data-slate-string="true"> semaphore *sem)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5853"><span data-slate-object="text" data-key="5854"><span data-slate-leaf="true" data-offset-key="5854:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5855"><span data-slate-object="text" data-key="5856"><span data-slate-leaf="true" data-offset-key="5856:0" data-first-offset="true"><span data-slate-string="true">    __down_common(sem, TASK_UNINTERRUPTIBLE, MAX_SCHEDULE_TIMEOUT);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5857"><span data-slate-object="text" data-key="5858"><span data-slate-leaf="true" data-offset-key="5858:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5859"><span data-slate-object="text" data-key="5860"><span data-slate-leaf="true" data-offset-key="5860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取信号量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5861"><span data-slate-object="text" data-key="5862"><span data-slate-leaf="true" data-offset-key="5862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="5863"><span data-slate-leaf="true" data-offset-key="5863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5864"><span data-slate-leaf="true" data-offset-key="5864:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">down</span></span></span></span></span><span data-slate-object="text" data-key="5865"><span data-slate-leaf="true" data-offset-key="5865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="5866"><span data-slate-leaf="true" data-offset-key="5866:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="5867"><span data-slate-leaf="true" data-offset-key="5867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> semaphore *sem)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5868"><span data-slate-object="text" data-key="5869"><span data-slate-leaf="true" data-offset-key="5869:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5870"><span data-slate-object="text" data-key="5871"><span data-slate-leaf="true" data-offset-key="5871:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5872"><span data-slate-leaf="true" data-offset-key="5872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="5873"><span data-slate-leaf="true" data-offset-key="5873:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5874"><span data-slate-leaf="true" data-offset-key="5874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="5875"><span data-slate-leaf="true" data-offset-key="5875:0" data-first-offset="true"><span data-slate-string="true"> flags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5876"><span data-slate-object="text" data-key="5877"><span data-slate-leaf="true" data-offset-key="5877:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5878"><span data-slate-leaf="true" data-offset-key="5878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对信号量本身加锁并关中断，也许另一段代码也在操作该信号量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5879"><span data-slate-object="text" data-key="5880"><span data-slate-leaf="true" data-offset-key="5880:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5881"><span data-slate-leaf="true" data-offset-key="5881:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spin_lock_irqsave</span></span></span></span><span data-slate-object="text" data-key="5882"><span data-slate-leaf="true" data-offset-key="5882:0" data-first-offset="true"><span data-slate-string="true">(&amp;sem-&gt;lock, flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5883"><span data-slate-object="text" data-key="5884"><span data-slate-leaf="true" data-offset-key="5884:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5885"><span data-slate-leaf="true" data-offset-key="5885:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5886"><span data-slate-leaf="true" data-offset-key="5886:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="5887"><span data-slate-leaf="true" data-offset-key="5887:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">likely</span></span></span></span><span data-slate-object="text" data-key="5888"><span data-slate-leaf="true" data-offset-key="5888:0" data-first-offset="true"><span data-slate-string="true">(sem-&gt;count &gt; </span></span></span><span data-slate-object="text" data-key="5889"><span data-slate-leaf="true" data-offset-key="5889:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="5890"><span data-slate-leaf="true" data-offset-key="5890:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5891"><span data-slate-object="text" data-key="5892"><span data-slate-leaf="true" data-offset-key="5892:0" data-first-offset="true"><span data-slate-string="true">        sem-&gt;count--;</span></span></span><span data-slate-object="text" data-key="5893"><span data-slate-leaf="true" data-offset-key="5893:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果信号量值大于 0, 则对其减 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5894"><span data-slate-object="text" data-key="5895"><span data-slate-leaf="true" data-offset-key="5895:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5896"><span data-slate-leaf="true" data-offset-key="5896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5897"><span data-slate-object="text" data-key="5898"><span data-slate-leaf="true" data-offset-key="5898:0" data-first-offset="true"><span data-slate-string="true">        __down(sem);</span></span></span><span data-slate-object="text" data-key="5899"><span data-slate-leaf="true" data-offset-key="5899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 否则让当前进程进入睡眠</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5900"><span data-slate-object="text" data-key="5901"><span data-slate-leaf="true" data-offset-key="5901:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5902"><span data-slate-leaf="true" data-offset-key="5902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spin_unlock_irqrestore</span></span></span></span><span data-slate-object="text" data-key="5903"><span data-slate-leaf="true" data-offset-key="5903:0" data-first-offset="true"><span data-slate-string="true">(&amp;sem-&gt;lock, flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5904"><span data-slate-object="text" data-key="5905"><span data-slate-leaf="true" data-offset-key="5905:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5906"><span data-slate-object="text" data-key="5907"><span data-slate-leaf="true" data-offset-key="5907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实际唤醒进程 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5908"><span data-slate-object="text" data-key="5909"><span data-slate-leaf="true" data-offset-key="5909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="5910"><span data-slate-leaf="true" data-offset-key="5910:0" data-first-offset="true"><span data-slate-string="true"> noinline </span></span></span><span data-slate-object="text" data-key="5911"><span data-slate-leaf="true" data-offset-key="5911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="5912"><span data-slate-leaf="true" data-offset-key="5912:0" data-first-offset="true"><span data-slate-string="true"> __sched __up(</span></span></span><span data-slate-object="text" data-key="5913"><span data-slate-leaf="true" data-offset-key="5913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5914"><span data-slate-leaf="true" data-offset-key="5914:0" data-first-offset="true"><span data-slate-string="true"> semaphore *sem)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5915"><span data-slate-object="text" data-key="5916"><span data-slate-leaf="true" data-offset-key="5916:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5917"><span data-slate-object="text" data-key="5918"><span data-slate-leaf="true" data-offset-key="5918:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5919"><span data-slate-leaf="true" data-offset-key="5919:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5920"><span data-slate-leaf="true" data-offset-key="5920:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5921"><span data-slate-leaf="true" data-offset-key="5921:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">semaphore_waiter</span></span></span></span><span data-slate-object="text" data-key="5922"><span data-slate-leaf="true" data-offset-key="5922:0" data-first-offset="true"><span data-slate-string="true"> *waiter = </span></span></span><span data-slate-object="text" data-key="5923"><span data-slate-leaf="true" data-offset-key="5923:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_first_entry</span></span></span></span><span data-slate-object="text" data-key="5924"><span data-slate-leaf="true" data-offset-key="5924:0" data-first-offset="true"><span data-slate-string="true">(&amp;sem-&gt;wait_list, </span></span></span><span data-slate-object="text" data-key="5925"><span data-slate-leaf="true" data-offset-key="5925:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="5926"><span data-slate-leaf="true" data-offset-key="5926:0" data-first-offset="true"><span data-slate-string="true"> semaphore_waiter, list);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5927"><span data-slate-object="text" data-key="5928"><span data-slate-leaf="true" data-offset-key="5928:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5929"><span data-slate-leaf="true" data-offset-key="5929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取信号量等待链表中的第一个数据结构 semaphore_waiter，它里面保存着睡眠进程的指针</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5930"><span data-slate-object="text" data-key="5931"><span data-slate-leaf="true" data-offset-key="5931:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5932"><span data-slate-leaf="true" data-offset-key="5932:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_del</span></span></span></span><span data-slate-object="text" data-key="5933"><span data-slate-leaf="true" data-offset-key="5933:0" data-first-offset="true"><span data-slate-string="true">(&amp;waiter-&gt;list);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5934"><span data-slate-object="text" data-key="5935"><span data-slate-leaf="true" data-offset-key="5935:0" data-first-offset="true"><span data-slate-string="true">    waiter-&gt;up = </span></span></span><span data-slate-object="text" data-key="5936"><span data-slate-leaf="true" data-offset-key="5936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="5937"><span data-slate-leaf="true" data-offset-key="5937:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5938"><span data-slate-object="text" data-key="5939"><span data-slate-leaf="true" data-offset-key="5939:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5940"><span data-slate-leaf="true" data-offset-key="5940:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">wake_up_process</span></span></span></span><span data-slate-object="text" data-key="5941"><span data-slate-leaf="true" data-offset-key="5941:0" data-first-offset="true"><span data-slate-string="true">(waiter-&gt;task);</span></span></span><span data-slate-object="text" data-key="5942"><span data-slate-leaf="true" data-offset-key="5942:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 唤醒进程重新加入调度队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5943"><span data-slate-object="text" data-key="5944"><span data-slate-leaf="true" data-offset-key="5944:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5945"><span data-slate-object="text" data-key="5946"><span data-slate-leaf="true" data-offset-key="5946:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放信号量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5947"><span data-slate-object="text" data-key="5948"><span data-slate-leaf="true" data-offset-key="5948:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="5949"><span data-slate-leaf="true" data-offset-key="5949:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="5950"><span data-slate-leaf="true" data-offset-key="5950:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">up</span></span></span></span></span><span data-slate-object="text" data-key="5951"><span data-slate-leaf="true" data-offset-key="5951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="5952"><span data-slate-leaf="true" data-offset-key="5952:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span></span></span><span data-slate-object="text" data-key="5953"><span data-slate-leaf="true" data-offset-key="5953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> semaphore *sem)</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5954"><span data-slate-object="text" data-key="5955"><span data-slate-leaf="true" data-offset-key="5955:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5956"><span data-slate-object="text" data-key="5957"><span data-slate-leaf="true" data-offset-key="5957:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5958"><span data-slate-leaf="true" data-offset-key="5958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="5959"><span data-slate-leaf="true" data-offset-key="5959:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="5960"><span data-slate-leaf="true" data-offset-key="5960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">long</span></span></span></span><span data-slate-object="text" data-key="5961"><span data-slate-leaf="true" data-offset-key="5961:0" data-first-offset="true"><span data-slate-string="true"> flags;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5962"><span data-slate-object="text" data-key="5963"><span data-slate-leaf="true" data-offset-key="5963:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5964"><span data-slate-leaf="true" data-offset-key="5964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 对信号量本身加锁并关中断，必须另一段代码也在操作该信号量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5965"><span data-slate-object="text" data-key="5966"><span data-slate-leaf="true" data-offset-key="5966:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5967"><span data-slate-leaf="true" data-offset-key="5967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spin_lock_irqsave</span></span></span></span><span data-slate-object="text" data-key="5968"><span data-slate-leaf="true" data-offset-key="5968:0" data-first-offset="true"><span data-slate-string="true">(&amp;sem-&gt;lock, flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5969"><span data-slate-object="text" data-key="5970"><span data-slate-leaf="true" data-offset-key="5970:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5971"><span data-slate-leaf="true" data-offset-key="5971:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="5972"><span data-slate-leaf="true" data-offset-key="5972:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="5973"><span data-slate-leaf="true" data-offset-key="5973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">likely</span></span></span></span><span data-slate-object="text" data-key="5974"><span data-slate-leaf="true" data-offset-key="5974:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="5975"><span data-slate-leaf="true" data-offset-key="5975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">list_empty</span></span></span></span><span data-slate-object="text" data-key="5976"><span data-slate-leaf="true" data-offset-key="5976:0" data-first-offset="true"><span data-slate-string="true">(&amp;sem-&gt;wait_list)))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5977"><span data-slate-object="text" data-key="5978"><span data-slate-leaf="true" data-offset-key="5978:0" data-first-offset="true"><span data-slate-string="true">        sem-&gt;count++;</span></span></span><span data-slate-object="text" data-key="5979"><span data-slate-leaf="true" data-offset-key="5979:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果信号量等待链表中为空，则对信号量值加 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5980"><span data-slate-object="text" data-key="5981"><span data-slate-leaf="true" data-offset-key="5981:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5982"><span data-slate-leaf="true" data-offset-key="5982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5983"><span data-slate-object="text" data-key="5984"><span data-slate-leaf="true" data-offset-key="5984:0" data-first-offset="true"><span data-slate-string="true">        __up(sem);</span></span></span><span data-slate-object="text" data-key="5985"><span data-slate-leaf="true" data-offset-key="5985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 否则执行唤醒进程相关的操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5986"><span data-slate-object="text" data-key="5987"><span data-slate-leaf="true" data-offset-key="5987:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="5988"><span data-slate-leaf="true" data-offset-key="5988:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">raw_spin_unlock_irqrestore</span></span></span></span><span data-slate-object="text" data-key="5989"><span data-slate-leaf="true" data-offset-key="5989:0" data-first-offset="true"><span data-slate-string="true">(&amp;sem-&gt;lock, flags);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="5990"><span data-slate-object="text" data-key="5991"><span data-slate-leaf="true" data-offset-key="5991:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5992"><span data-slate-object="text" data-key="5993"><span data-slate-leaf="true" data-offset-key="5993:0" data-first-offset="true"><span data-slate-string="true">上述代码中的逻辑，已经描述了信号量的工作原理。需要注意的是，一个进程进入了 __down 函数中，设置了一个不可中断的等待状态，然后执行了 schedule_timeout 函数。这个执行了进程的调度器，就直接调度到别的进程运行了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5994"><span data-slate-object="text" data-key="5995"><span data-slate-leaf="true" data-offset-key="5995:0" data-first-offset="true"><span data-slate-string="true">这时，这个进程就不会返回了，直到下一次它被 up 函数唤醒。执行了 wake_up_process 函数以后，重新调度它就会回到 schedule_timeout 函数下一行代码，沿着调用路经返回，最后从 __down 函数中出来，即进程睡醒了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="5996" id="sr-toc-7"><span data-slate-object="text" data-key="5997"><span data-slate-leaf="true" data-offset-key="5997:0" data-first-offset="true"><span data-slate-string="true">Linux 读写锁</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="5998"><span data-slate-object="text" data-key="5999"><span data-slate-leaf="true" data-offset-key="5999:0" data-first-offset="true"><span data-slate-string="true">在操作系统中，有很多共享数据，进程对这些共享数据要进行修改的情况很少，而读取的情况却是非常多的，这些共享数据的操作基本都是在读取。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6000"><span data-slate-object="text" data-key="6001"><span data-slate-leaf="true" data-offset-key="6001:0" data-first-offset="true"><span data-slate-string="true">如果每次读取这些共享数据都加锁的话，那就太浪费时间了，会降低进程的运行效率。因为读操作不会导致修改数据，所以在读取数据的时候不用加锁了，而是可以共享的访问，只有涉及到对共享数据修改的时候，才需要加锁互斥访问。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6002"><span data-slate-object="text" data-key="6003"><span data-slate-leaf="true" data-offset-key="6003:0" data-first-offset="true"><span data-slate-string="true">想像一下 100 个进程同时读取一个共享数据，而每个进程都要加锁解锁，剩下的进程只能等待，这会大大降低整个系统性能，这时候就需要使用一种新的锁了 —— 读写锁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6004"><span data-slate-object="text" data-key="6005"><span data-slate-leaf="true" data-offset-key="6005:0" data-first-offset="true"><span data-slate-string="true">读写锁也称为共享 - 独占（shared-exclusive）锁，当读写锁用读取模式加锁时，它是以共享模式上锁的，当以写入修改模式加锁时，它是以独占模式上锁的（互斥）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6006"><span data-slate-object="text" data-key="6007"><span data-slate-leaf="true" data-offset-key="6007:0" data-first-offset="true"><span data-slate-string="true">读写锁非常适合</span></span></span><span data-slate-object="text" data-key="6008"><span data-slate-leaf="true" data-offset-key="6008:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">读取数据的频率远大于修改数据的频率</span></span></span></span><span data-slate-object="text" data-key="6009"><span data-slate-leaf="true" data-offset-key="6009:0" data-first-offset="true"><span data-slate-string="true">的场景中。这样可以在任何时刻，保证多个进程的读取操作并发地执行，给系统带来了更高的并发度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6010"><span data-slate-object="text" data-key="6011"><span data-slate-leaf="true" data-offset-key="6011:0" data-first-offset="true"><span data-slate-string="true">那读写锁是怎么工作的呢？读写之间是互斥的，读取的时候不能写入，写入的时候不能读取，而且读取和写入操作在竞争锁的时候，写会优先得到锁，步骤如下。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6012"><span data-slate-object="text" data-key="6013"><span data-slate-leaf="true" data-offset-key="6013:0" data-first-offset="true"><span data-slate-string="true">1. 当共享数据没有锁的时候，读取的加锁操作和写入的加锁操作都可以满足。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6014"><span data-slate-object="text" data-key="6015"><span data-slate-leaf="true" data-offset-key="6015:0" data-first-offset="true"><span data-slate-string="true">2. 当共享数据有读锁的时候，所有的读取加锁操作都可以满足，写入的加锁操作不能满足，读写是互斥的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6016"><span data-slate-object="text" data-key="6017"><span data-slate-leaf="true" data-offset-key="6017:0" data-first-offset="true"><span data-slate-string="true">3. 当共享数据有写锁的时候，所有的读取的加锁操作都不能满足，所有的写入的加锁操作也不能满足，读与写之间是互斥的，写与写之间也是互斥的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6018"><span data-slate-object="text" data-key="6019"><span data-slate-leaf="true" data-offset-key="6019:0" data-first-offset="true"><span data-slate-string="true">如果你感觉刚才说的步骤还是太复杂，那我再给你画一个表，你就清楚了，如下所示。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6020"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/70/08/70c2d2580e8ec4b138db2f2807ba9f08.jpg?wh=1625*848"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6021"><span data-slate-object="text" data-key="6022"><span data-slate-leaf="true" data-offset-key="6022:0" data-first-offset="true"><span data-slate-string="true">好了，我们明白了读写锁的加锁规则，现在就去看看 Linux 中的读写锁的实现，</span></span></span><span data-slate-object="text" data-key="6023"><span data-slate-leaf="true" data-offset-key="6023:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Linux 中的读写锁本质上是自旋锁的变种。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6024"><span data-slate-object="text" data-key="6025"><span data-slate-leaf="true" data-offset-key="6025:0" data-first-offset="true"><span data-slate-string="true">后面这段代码是 Linux 中读写锁的核心代码，请你注意，</span></span></span><span data-slate-object="text" data-key="6026"><span data-slate-leaf="true" data-offset-key="6026:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">实际操作的时候，我们不是直接使用上面的函数和数据结构，而是应该使用 Linux 提供的标准接口，如 read_lock、write_lock 等。</span></span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="6027"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="6028"><span data-slate-object="text" data-key="6029"><span data-slate-leaf="true" data-offset-key="6029:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读写锁初始化锁值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6030"><span data-slate-object="text" data-key="6031"><span data-slate-leaf="true" data-offset-key="6031:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">#</span></span></span></span><span data-slate-object="text" data-key="6032"><span data-slate-leaf="true" data-offset-key="6032:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">define</span></span></span></span></span><span data-slate-object="text" data-key="6033"><span data-slate-leaf="true" data-offset-key="6033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> RW_LOCK_BIAS     0x01000000</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6034"><span data-slate-object="text" data-key="6035"><span data-slate-leaf="true" data-offset-key="6035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读写锁的底层数据结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6036"><span data-slate-object="text" data-key="6037"><span data-slate-leaf="true" data-offset-key="6037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">typedef</span></span></span></span><span data-slate-object="text" data-key="6038"><span data-slate-leaf="true" data-offset-key="6038:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6039"><span data-slate-leaf="true" data-offset-key="6039:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="6040"><span data-slate-leaf="true" data-offset-key="6040:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6041"><span data-slate-object="text" data-key="6042"><span data-slate-leaf="true" data-offset-key="6042:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6043"><span data-slate-leaf="true" data-offset-key="6043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">unsigned</span></span></span></span><span data-slate-object="text" data-key="6044"><span data-slate-leaf="true" data-offset-key="6044:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6045"><span data-slate-leaf="true" data-offset-key="6045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="6046"><span data-slate-leaf="true" data-offset-key="6046:0" data-first-offset="true"><span data-slate-string="true"> lock;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6047"><span data-slate-object="text" data-key="6048"><span data-slate-leaf="true" data-offset-key="6048:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span><span data-slate-object="text" data-key="6049"><span data-slate-leaf="true" data-offset-key="6049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_rwlock_t</span></span></span></span><span data-slate-object="text" data-key="6050"><span data-slate-leaf="true" data-offset-key="6050:0" data-first-offset="true"><span data-slate-string="true">;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6051"><span data-slate-object="text" data-key="6052"><span data-slate-leaf="true" data-offset-key="6052:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放读锁 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6053"><span data-slate-object="text" data-key="6054"><span data-slate-leaf="true" data-offset-key="6054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="6055"><span data-slate-leaf="true" data-offset-key="6055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6056"><span data-slate-leaf="true" data-offset-key="6056:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span></span><span data-slate-object="text" data-key="6057"><span data-slate-leaf="true" data-offset-key="6057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6058"><span data-slate-leaf="true" data-offset-key="6058:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="6059"><span data-slate-leaf="true" data-offset-key="6059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6060"><span data-slate-leaf="true" data-offset-key="6060:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_read_unlock</span></span></span></span></span><span data-slate-object="text" data-key="6061"><span data-slate-leaf="true" data-offset-key="6061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="6062"><span data-slate-leaf="true" data-offset-key="6062:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_rwlock_t</span></span></span></span></span></span><span data-slate-object="text" data-key="6063"><span data-slate-leaf="true" data-offset-key="6063:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">*rw)</span></span></span></span></span><span data-slate-object="text" data-key="6064"><span data-slate-leaf="true" data-offset-key="6064:0" data-first-offset="true"><span data-slate-string="true">{ </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6065"><span data-slate-object="text" data-key="6066"><span data-slate-leaf="true" data-offset-key="6066:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6067"><span data-slate-leaf="true" data-offset-key="6067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="6068"><span data-slate-leaf="true" data-offset-key="6068:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6069"><span data-slate-leaf="true" data-offset-key="6069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="6070"><span data-slate-leaf="true" data-offset-key="6070:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6071"><span data-slate-object="text" data-key="6072"><span data-slate-leaf="true" data-offset-key="6072:0" data-first-offset="true"><span data-slate-string="true">        LOCK_PREFIX</span></span></span><span data-slate-object="text" data-key="6073"><span data-slate-leaf="true" data-offset-key="6073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"incl %0"</span></span></span></span><span data-slate-object="text" data-key="6074"><span data-slate-leaf="true" data-offset-key="6074:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6075"><span data-slate-leaf="true" data-offset-key="6075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子对 lock 加 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6076"><span data-slate-object="text" data-key="6077"><span data-slate-leaf="true" data-offset-key="6077:0" data-first-offset="true"><span data-slate-string="true">        :</span></span></span><span data-slate-object="text" data-key="6078"><span data-slate-leaf="true" data-offset-key="6078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="6079"><span data-slate-leaf="true" data-offset-key="6079:0" data-first-offset="true"><span data-slate-string="true">(rw-&gt;lock)::</span></span></span><span data-slate-object="text" data-key="6080"><span data-slate-leaf="true" data-offset-key="6080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="6081"><span data-slate-leaf="true" data-offset-key="6081:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6082"><span data-slate-object="text" data-key="6083"><span data-slate-leaf="true" data-offset-key="6083:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6084"><span data-slate-object="text" data-key="6085"><span data-slate-leaf="true" data-offset-key="6085:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放写锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6086"><span data-slate-object="text" data-key="6087"><span data-slate-leaf="true" data-offset-key="6087:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="6088"><span data-slate-leaf="true" data-offset-key="6088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6089"><span data-slate-leaf="true" data-offset-key="6089:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span></span><span data-slate-object="text" data-key="6090"><span data-slate-leaf="true" data-offset-key="6090:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6091"><span data-slate-leaf="true" data-offset-key="6091:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="6092"><span data-slate-leaf="true" data-offset-key="6092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6093"><span data-slate-leaf="true" data-offset-key="6093:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_write_unlock</span></span></span></span></span><span data-slate-object="text" data-key="6094"><span data-slate-leaf="true" data-offset-key="6094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="6095"><span data-slate-leaf="true" data-offset-key="6095:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_rwlock_t</span></span></span></span></span></span><span data-slate-object="text" data-key="6096"><span data-slate-leaf="true" data-offset-key="6096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">*rw)</span></span></span></span></span><span data-slate-object="text" data-key="6097"><span data-slate-leaf="true" data-offset-key="6097:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6098"><span data-slate-object="text" data-key="6099"><span data-slate-leaf="true" data-offset-key="6099:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6100"><span data-slate-leaf="true" data-offset-key="6100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="6101"><span data-slate-leaf="true" data-offset-key="6101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6102"><span data-slate-leaf="true" data-offset-key="6102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="6103"><span data-slate-leaf="true" data-offset-key="6103:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6104"><span data-slate-object="text" data-key="6105"><span data-slate-leaf="true" data-offset-key="6105:0" data-first-offset="true"><span data-slate-string="true">        LOCK_PREFIX</span></span></span><span data-slate-object="text" data-key="6106"><span data-slate-leaf="true" data-offset-key="6106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"addl %1, %0"</span></span></span></span><span data-slate-object="text" data-key="6107"><span data-slate-leaf="true" data-offset-key="6107:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子对 lock 加上 RW_LOCK_BIAS</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6108"><span data-slate-object="text" data-key="6109"><span data-slate-leaf="true" data-offset-key="6109:0" data-first-offset="true"><span data-slate-string="true">        :</span></span></span><span data-slate-object="text" data-key="6110"><span data-slate-leaf="true" data-offset-key="6110:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"+m"</span></span></span></span><span data-slate-object="text" data-key="6111"><span data-slate-leaf="true" data-offset-key="6111:0" data-first-offset="true"><span data-slate-string="true">(rw-&gt;lock):</span></span></span><span data-slate-object="text" data-key="6112"><span data-slate-leaf="true" data-offset-key="6112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"i"</span></span></span></span><span data-slate-object="text" data-key="6113"><span data-slate-leaf="true" data-offset-key="6113:0" data-first-offset="true"><span data-slate-string="true">(RW_LOCK_BIAS):</span></span></span><span data-slate-object="text" data-key="6114"><span data-slate-leaf="true" data-offset-key="6114:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="6115"><span data-slate-leaf="true" data-offset-key="6115:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6116"><span data-slate-object="text" data-key="6117"><span data-slate-leaf="true" data-offset-key="6117:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6118"><span data-slate-object="text" data-key="6119"><span data-slate-leaf="true" data-offset-key="6119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取写锁失败时调用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6120"><span data-slate-object="text" data-key="6121"><span data-slate-leaf="true" data-offset-key="6121:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ENTRY</span></span></span></span><span data-slate-object="text" data-key="6122"><span data-slate-leaf="true" data-offset-key="6122:0" data-first-offset="true"><span data-slate-string="true">(__write_lock_failed)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6123"><span data-slate-object="text" data-key="6124"><span data-slate-leaf="true" data-offset-key="6124:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6125"><span data-slate-leaf="true" data-offset-key="6125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//(% eax) 表示由 eax 指向的内存空间是调用者传进来的 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6126"><span data-slate-object="text" data-key="6127"><span data-slate-leaf="true" data-offset-key="6127:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a5c7da30" data-attr-id="37823" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">    </span></span></span></span><span data-slate-object="text" data-key="6128"><span data-slate-leaf="true" data-offset-key="6128:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a5c7da30" data-attr-id="37823" data-attr-name="public" data-annotation-type="public"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span></span><span data-slate-object="text" data-key="6129"><span data-slate-leaf="true" data-offset-key="6129:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_a5c7da30" data-attr-id="37823" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">:LOCK_PREFIX addl  $ RW_LOCK_BIAS,(%eax)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6130"><span data-slate-object="text" data-key="6131"><span data-slate-leaf="true" data-offset-key="6131:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6132"><span data-slate-leaf="true" data-offset-key="6132:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="6133"><span data-slate-leaf="true" data-offset-key="6133:0" data-first-offset="true"><span data-slate-string="true">:rep;nop</span></span></span><span data-slate-object="text" data-key="6134"><span data-slate-leaf="true" data-offset-key="6134:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 空指令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6135"><span data-slate-object="text" data-key="6136"><span data-slate-leaf="true" data-offset-key="6136:0" data-first-offset="true"><span data-slate-string="true">    cmpl $RW_LOCK_BIAS,(%eax)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6137"><span data-slate-object="text" data-key="6138"><span data-slate-leaf="true" data-offset-key="6138:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6139"><span data-slate-leaf="true" data-offset-key="6139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不等于初始值则循环比较，相等则表示有进程释放了写锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6140"><span data-slate-object="text" data-key="6141"><span data-slate-leaf="true" data-offset-key="6141:0" data-first-offset="true"><span data-slate-string="true">    jne   </span></span></span><span data-slate-object="text" data-key="6142"><span data-slate-leaf="true" data-offset-key="6142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1b</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6143"><span data-slate-object="text" data-key="6144"><span data-slate-leaf="true" data-offset-key="6144:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6145"><span data-slate-leaf="true" data-offset-key="6145:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 执行加写锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6146"><span data-slate-object="text" data-key="6147"><span data-slate-leaf="true" data-offset-key="6147:0" data-first-offset="true"><span data-slate-string="true">    LOCK_PREFIX subl  $ RW_LOCK_BIAS,(%eax)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6148"><span data-slate-object="text" data-key="6149"><span data-slate-leaf="true" data-offset-key="6149:0" data-first-offset="true"><span data-slate-string="true">    jnz </span></span></span><span data-slate-object="text" data-key="6150"><span data-slate-leaf="true" data-offset-key="6150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2b</span></span></span></span><span data-slate-object="text" data-key="6151"><span data-slate-leaf="true" data-offset-key="6151:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6152"><span data-slate-leaf="true" data-offset-key="6152:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不为 0 则继续测试，为 0 则表示加写锁成功</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6153"><span data-slate-object="text" data-key="6154"><span data-slate-leaf="true" data-offset-key="6154:0" data-first-offset="true"><span data-slate-string="true">    ret </span></span></span><span data-slate-object="text" data-key="6155"><span data-slate-leaf="true" data-offset-key="6155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6156"><span data-slate-object="text" data-key="6157"><span data-slate-leaf="true" data-offset-key="6157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ENDPROC</span></span></span></span><span data-slate-object="text" data-key="6158"><span data-slate-leaf="true" data-offset-key="6158:0" data-first-offset="true"><span data-slate-string="true">(__write_lock_failed)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6159"><span data-slate-object="text" data-key="6160"><span data-slate-leaf="true" data-offset-key="6160:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取读锁失败时调用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6161"><span data-slate-object="text" data-key="6162"><span data-slate-leaf="true" data-offset-key="6162:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ENTRY</span></span></span></span><span data-slate-object="text" data-key="6163"><span data-slate-leaf="true" data-offset-key="6163:0" data-first-offset="true"><span data-slate-string="true">(__read_lock_failed)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6164"><span data-slate-object="text" data-key="6165"><span data-slate-leaf="true" data-offset-key="6165:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6166"><span data-slate-leaf="true" data-offset-key="6166:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//(% eax) 表示由 eax 指向的内存空间是调用者传进来的 </span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6167"><span data-slate-object="text" data-key="6168"><span data-slate-leaf="true" data-offset-key="6168:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6169"><span data-slate-leaf="true" data-offset-key="6169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="6170"><span data-slate-leaf="true" data-offset-key="6170:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span><span data-slate-object="text" data-key="6171"><span data-slate-leaf="true" data-offset-key="6171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">LOCK_PREFIX </span></span></span></span><span data-slate-object="text" data-key="6172"><span data-slate-leaf="true" data-offset-key="6172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">incl</span></span></span></span></span><span data-slate-object="text" data-key="6173"><span data-slate-leaf="true" data-offset-key="6173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(%eax)</span></span></span></span></span><span data-slate-object="text" data-key="6174"><span data-slate-leaf="true" data-offset-key="6174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子加 1</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6175"><span data-slate-object="text" data-key="6176"><span data-slate-leaf="true" data-offset-key="6176:0" data-first-offset="true"><span data-slate-string="true">    1:  rep; nop</span></span></span><span data-slate-object="text" data-key="6177"><span data-slate-leaf="true" data-offset-key="6177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 空指令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6178"><span data-slate-object="text" data-key="6179"><span data-slate-leaf="true" data-offset-key="6179:0" data-first-offset="true"><span data-slate-string="true">    cmpl  $</span></span></span><span data-slate-object="text" data-key="6180"><span data-slate-leaf="true" data-offset-key="6180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="6181"><span data-slate-leaf="true" data-offset-key="6181:0" data-first-offset="true"><span data-slate-string="true">,(%eax) </span></span></span><span data-slate-object="text" data-key="6182"><span data-slate-leaf="true" data-offset-key="6182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 和 1 比较 小于 0 则</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6183"><span data-slate-object="text" data-key="6184"><span data-slate-leaf="true" data-offset-key="6184:0" data-first-offset="true"><span data-slate-string="true">    js </span></span></span><span data-slate-object="text" data-key="6185"><span data-slate-leaf="true" data-offset-key="6185:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1b</span></span></span></span><span data-slate-object="text" data-key="6186"><span data-slate-leaf="true" data-offset-key="6186:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6187"><span data-slate-leaf="true" data-offset-key="6187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为负则继续循环比较</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6188"><span data-slate-object="text" data-key="6189"><span data-slate-leaf="true" data-offset-key="6189:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6190"><span data-slate-leaf="true" data-offset-key="6190:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">LOCK_PREFIX </span></span></span></span><span data-slate-object="text" data-key="6191"><span data-slate-leaf="true" data-offset-key="6191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">decl</span></span></span></span></span><span data-slate-object="text" data-key="6192"><span data-slate-leaf="true" data-offset-key="6192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(%eax)</span></span></span></span></span><span data-slate-object="text" data-key="6193"><span data-slate-leaf="true" data-offset-key="6193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6194"><span data-slate-leaf="true" data-offset-key="6194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加读锁</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6195"><span data-slate-object="text" data-key="6196"><span data-slate-leaf="true" data-offset-key="6196:0" data-first-offset="true"><span data-slate-string="true">    js  2b  </span></span></span><span data-slate-object="text" data-key="6197"><span data-slate-leaf="true" data-offset-key="6197:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为负则继续加 1 并比较，否则返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6198"><span data-slate-object="text" data-key="6199"><span data-slate-leaf="true" data-offset-key="6199:0" data-first-offset="true"><span data-slate-string="true">    ret </span></span></span><span data-slate-object="text" data-key="6200"><span data-slate-leaf="true" data-offset-key="6200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 返回</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6201"><span data-slate-object="text" data-key="6202"><span data-slate-leaf="true" data-offset-key="6202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ENDPROC</span></span></span></span><span data-slate-object="text" data-key="6203"><span data-slate-leaf="true" data-offset-key="6203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(__read_lock_failed)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6204"><span data-slate-object="text" data-key="6205"><span data-slate-leaf="true" data-offset-key="6205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取读锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6206"><span data-slate-object="text" data-key="6207"><span data-slate-leaf="true" data-offset-key="6207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span><span data-slate-object="text" data-key="6208"><span data-slate-leaf="true" data-offset-key="6208:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6209"><span data-slate-leaf="true" data-offset-key="6209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span><span data-slate-object="text" data-key="6210"><span data-slate-leaf="true" data-offset-key="6210:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6211"><span data-slate-leaf="true" data-offset-key="6211:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span><span data-slate-object="text" data-key="6212"><span data-slate-leaf="true" data-offset-key="6212:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="6213"><span data-slate-leaf="true" data-offset-key="6213:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_read_lock</span></span></span></span><span data-slate-object="text" data-key="6214"><span data-slate-leaf="true" data-offset-key="6214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span><span data-slate-object="text" data-key="6215"><span data-slate-leaf="true" data-offset-key="6215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_rwlock_t</span></span></span></span></span><span data-slate-object="text" data-key="6216"><span data-slate-leaf="true" data-offset-key="6216:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">*rw)</span></span></span></span><span data-slate-object="text" data-key="6217"><span data-slate-leaf="true" data-offset-key="6217:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6218"><span data-slate-object="text" data-key="6219"><span data-slate-leaf="true" data-offset-key="6219:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6220"><span data-slate-leaf="true" data-offset-key="6220:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="6221"><span data-slate-leaf="true" data-offset-key="6221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6222"><span data-slate-leaf="true" data-offset-key="6222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="6223"><span data-slate-leaf="true" data-offset-key="6223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6224"><span data-slate-object="text" data-key="6225"><span data-slate-leaf="true" data-offset-key="6225:0" data-first-offset="true"><span data-slate-string="true">        LOCK_PREFIX</span></span></span><span data-slate-object="text" data-key="6226"><span data-slate-leaf="true" data-offset-key="6226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"subl $1,(%0)\n\t"</span></span></span></span><span data-slate-object="text" data-key="6227"><span data-slate-leaf="true" data-offset-key="6227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子对 lock 减 1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6228"><span data-slate-object="text" data-key="6229"><span data-slate-leaf="true" data-offset-key="6229:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="6230"><span data-slate-leaf="true" data-offset-key="6230:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jns 1f\n"</span></span></span></span><span data-slate-object="text" data-key="6231"><span data-slate-leaf="true" data-offset-key="6231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不为小于 0 则跳转标号 1 处，表示获取读锁成功</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6232"><span data-slate-object="text" data-key="6233"><span data-slate-leaf="true" data-offset-key="6233:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="6234"><span data-slate-leaf="true" data-offset-key="6234:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"call __read_lock_failed\n\t"</span></span></span></span><span data-slate-object="text" data-key="6235"><span data-slate-leaf="true" data-offset-key="6235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用__read_lock_failed</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6236"><span data-slate-object="text" data-key="6237"><span data-slate-leaf="true" data-offset-key="6237:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="6238"><span data-slate-leaf="true" data-offset-key="6238:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"1:\n"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6239"><span data-slate-object="text" data-key="6240"><span data-slate-leaf="true" data-offset-key="6240:0" data-first-offset="true"><span data-slate-string="true">        ::LOCK_PTR_REG(rw):</span></span></span><span data-slate-object="text" data-key="6241"><span data-slate-leaf="true" data-offset-key="6241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="6242"><span data-slate-leaf="true" data-offset-key="6242:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6243"><span data-slate-object="text" data-key="6244"><span data-slate-leaf="true" data-offset-key="6244:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6245"><span data-slate-object="text" data-key="6246"><span data-slate-leaf="true" data-offset-key="6246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取写锁</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6247"><span data-slate-object="text" data-key="6248"><span data-slate-leaf="true" data-offset-key="6248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">static</span></span></span></span></span><span data-slate-object="text" data-key="6249"><span data-slate-leaf="true" data-offset-key="6249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6250"><span data-slate-leaf="true" data-offset-key="6250:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">inline</span></span></span></span></span><span data-slate-object="text" data-key="6251"><span data-slate-leaf="true" data-offset-key="6251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6252"><span data-slate-leaf="true" data-offset-key="6252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">void</span></span></span></span></span><span data-slate-object="text" data-key="6253"><span data-slate-leaf="true" data-offset-key="6253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6254"><span data-slate-leaf="true" data-offset-key="6254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_write_lock</span></span></span></span></span><span data-slate-object="text" data-key="6255"><span data-slate-leaf="true" data-offset-key="6255:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span><span data-slate-object="text" data-key="6256"><span data-slate-leaf="true" data-offset-key="6256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">arch_rwlock_t</span></span></span></span></span></span><span data-slate-object="text" data-key="6257"><span data-slate-leaf="true" data-offset-key="6257:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">*rw)</span></span></span></span></span><span data-slate-object="text" data-key="6258"><span data-slate-leaf="true" data-offset-key="6258:0" data-first-offset="true"><span data-slate-string="true">{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6259"><span data-slate-object="text" data-key="6260"><span data-slate-leaf="true" data-offset-key="6260:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="6261"><span data-slate-leaf="true" data-offset-key="6261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">asm</span></span></span></span></span><span data-slate-object="text" data-key="6262"><span data-slate-leaf="true" data-offset-key="6262:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="6263"><span data-slate-leaf="true" data-offset-key="6263:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">volatile</span></span></span></span></span><span data-slate-object="text" data-key="6264"><span data-slate-leaf="true" data-offset-key="6264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6265"><span data-slate-object="text" data-key="6266"><span data-slate-leaf="true" data-offset-key="6266:0" data-first-offset="true"><span data-slate-string="true">        LOCK_PREFIX</span></span></span><span data-slate-object="text" data-key="6267"><span data-slate-leaf="true" data-offset-key="6267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"subl %1,(%0)\n\t"</span></span></span></span><span data-slate-object="text" data-key="6268"><span data-slate-leaf="true" data-offset-key="6268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 原子对 lock 减去 RW_LOCK_BIAS</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6269"><span data-slate-object="text" data-key="6270"><span data-slate-leaf="true" data-offset-key="6270:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="6271"><span data-slate-leaf="true" data-offset-key="6271:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"jz 1f\n"</span></span></span></span><span data-slate-object="text" data-key="6272"><span data-slate-leaf="true" data-offset-key="6272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 为 0 则跳转标号 1 处</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6273"><span data-slate-object="text" data-key="6274"><span data-slate-leaf="true" data-offset-key="6274:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="6275"><span data-slate-leaf="true" data-offset-key="6275:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"call __write_lock_failed\n\t"</span></span></span></span><span data-slate-object="text" data-key="6276"><span data-slate-leaf="true" data-offset-key="6276:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用__write_lock_failed</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6277"><span data-slate-object="text" data-key="6278"><span data-slate-leaf="true" data-offset-key="6278:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="6279"><span data-slate-leaf="true" data-offset-key="6279:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"1:\n"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6280"><span data-slate-object="text" data-key="6281"><span data-slate-leaf="true" data-offset-key="6281:0" data-first-offset="true"><span data-slate-string="true">        ::LOCK_PTR_REG(rw),</span></span></span><span data-slate-object="text" data-key="6282"><span data-slate-leaf="true" data-offset-key="6282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"i"</span></span></span></span><span data-slate-object="text" data-key="6283"><span data-slate-leaf="true" data-offset-key="6283:0" data-first-offset="true"><span data-slate-string="true">(RW_LOCK_BIAS):</span></span></span><span data-slate-object="text" data-key="6284"><span data-slate-leaf="true" data-offset-key="6284:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"memory"</span></span></span></span><span data-slate-object="text" data-key="6285"><span data-slate-leaf="true" data-offset-key="6285:0" data-first-offset="true"><span data-slate-string="true">);</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="6286"><span data-slate-object="text" data-key="6287"><span data-slate-leaf="true" data-offset-key="6287:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6288"><span data-slate-object="text" data-key="6289"><span data-slate-leaf="true" data-offset-key="6289:0" data-first-offset="true"><span data-slate-string="true">Linux 读写锁的原理本质是基于计数器，初始值为 0x01000000，获取读锁时对其减 1，结果不小于 0 则表示获取读锁成功，获取写锁时直接减去 0x01000000。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6290"><span data-slate-object="text" data-key="6291"><span data-slate-leaf="true" data-offset-key="6291:0" data-first-offset="true"><span data-slate-string="true">说到这里你可能要问了，为何要减去初始值呢？这是因为只有当锁值为初始值时，减去初始值结果才可以是 0，这是唯一没有进程持有任何锁的情况，这样才能保证获取写锁时是互斥的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6292"><span data-slate-object="text" data-key="6293"><span data-slate-leaf="true" data-offset-key="6293:0" data-first-offset="true"><span data-slate-string="true">__read_lock_failed、__write_lock_failed 是两个汇编函数，注释写得很详细了，和前面自旋锁的套路是一样的。我们可以看出，读写锁其实是带计数的特殊自旋锁，能同时被多个读取数据的进程占有或一个修改数据的进程占有，但不能同时被读取数据的进程和修改数据的进程占有。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6294"><span data-slate-object="text" data-key="6295"><span data-slate-leaf="true" data-offset-key="6295:0" data-first-offset="true"><span data-slate-string="true">我们再次梳理一下获取、释放读写锁的流程，如下所示。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6296"><span data-slate-object="text" data-key="6297"><span data-slate-leaf="true" data-offset-key="6297:0" data-first-offset="true"><span data-slate-string="true">1. 获取读锁时，锁值变量 lock 计数减去 1，判断结果的符号位是否为 1。若结果符号位为 0 时，获取读锁成功，即表示 lock 大于 0。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6298"><span data-slate-object="text" data-key="6299"><span data-slate-leaf="true" data-offset-key="6299:0" data-first-offset="true"><span data-slate-string="true">2. 获取读锁时，锁值变量 lock 计数减去 1，判断结果的符号位是否为 1。若结果符号位为 1 时，获取读锁失败，表示此时读写锁被修改数据的进程占有，此时调用 __read_lock_failed 失败处理函数，</span></span><span data-slate-leaf="true" data-offset-key="6299:1"><span data-slate-object="annotation" data-annotation-key="gkann_e2b05042" data-attr-id="41044" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">循环测试 lock+1 的值，直到结果的值大于等于 1。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6300"><span data-slate-object="text" data-key="6301"><span data-slate-leaf="true" data-offset-key="6301:0" data-first-offset="true"><span data-slate-string="true">3. 获取写锁时，锁值变量 lock 计数减去 RW_LOCK_BIAS_STR，即 lock-0x01000000，判断结果是否为 0。若结果为 0 时，表示获取写锁成功。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6302"><span data-slate-object="text" data-key="6303"><span data-slate-leaf="true" data-offset-key="6303:0" data-first-offset="true"><span data-slate-string="true">4. 获取写锁时，锁值变量 lock 计数减去 RW_LOCK_BIAS_STR，即 lock-0x01000000，判断结果是否为 0。若结果不为 0 时，获取写锁失败，表示此时有读取数据的进程占有读锁或有修改数据的进程占有写锁，此时调用 __write_lock_failed 失败处理函数，循环测试 lock+0x01000000，直到结果的值等于 0x01000000。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6304" id="sr-toc-8"><span data-slate-object="text" data-key="6305"><span data-slate-leaf="true" data-offset-key="6305:0" data-first-offset="true"><span data-slate-string="true">重点回顾</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6306"><span data-slate-object="text" data-key="6307"><span data-slate-leaf="true" data-offset-key="6307:0" data-first-offset="true"><span data-slate-string="true">好了，这节课的内容讲完了。我们一起学习了 Linux 上实现数据同步的五大利器，分别是 Linux 原子变量、Linux 中断控制、Linux 自旋锁、Linux 信号量、Linux 读写锁。我把重点给你梳理一下。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="6308"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/7f/a9/7fd3abc144bb40331ca2aeb05ab5b7a9.jpg?wh=3145*2137"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6309"><span data-slate-object="text" data-key="6310"><span data-slate-leaf="true" data-offset-key="6310:0" data-first-offset="true"><span data-slate-string="true">锁，保证了数据的安全访问，但是它给程序的并行性能造成了巨大损害，所以在设计一个算法时应尽量避免使用锁。若无法避免，则应根据实际情况使用相应类型的锁，以降低锁的不当使用带来的性能损失。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="6311" id="sr-toc-9"><span data-slate-object="text" data-key="6312"><span data-slate-leaf="true" data-offset-key="6312:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="6313"><span data-slate-object="text" data-key="6314"><span data-slate-leaf="true" data-offset-key="6314:0" data-first-offset="true"><span data-slate-string="true">请试着回答：上述 Linux 的读写锁，支持多少个进程并发读取共享数据？这样的读写锁有什么不足？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6315"><span data-slate-object="text" data-key="6316"><span data-slate-leaf="true" data-offset-key="6316:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区和我交流，相信通过积极参与，你将更好地理解这节课的内容。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="6317"><span data-slate-object="text" data-key="6318"><span data-slate-leaf="true" data-offset-key="6318:0" data-first-offset="true"><span data-slate-string="true">我是 LMOS，我们下节课见！</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>22</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-10">精选留言 (56)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/4f/b2/1e8b5616.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>老男孩</span></div><span>置顶</span></div><div>这个排队自旋锁的实现方式感觉很风骚啊。关于读锁最大支持进程数是 0x01000000（学友们都已经解答了）关于写饥饿的问题，既然写锁和读锁在同时获取锁状态时候写锁优先，那么就应该对读锁做一个限制，不能让读锁朝着最大数奔去。比如，系统检测到有写锁在等待，那么就限制新的读锁加入，等已经存在的读锁都释放了，写锁马上加锁更新资源。然后等待的读锁再开始加锁读取。这个等待的队列要分为读锁队列和写锁队列。优先处理写锁队列，在没有写锁的时候才能继续加读锁，如果有写锁等待，那么新的读锁不管超没超出那个最大数，都要进入读锁队列等待写锁完成后再开始自己的表演。</div><div><p>作者回复：嗯嗯见解独到</p></div><div><div>2021-05-28</div><div><div><i></i><span>4</span></div><div><i></i><span>28</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>springXu</span></div><span>置顶</span></div><div>同步与锁
操作系统是让应用程序认为当前有超大的内存空间和强大的 cpu 来工作的硬件环境，但其实硬件没有这么强大。那如何解决呢？比如在单核 cpu 上可以用分时技术，让进程交替执行。对于一个进程来说，我们可以把一个进程变成了多个线程来执行。但这样就产生了同一个资源可以是内存的某一具体地址，可以是鼠标可以是磁盘上的某一文件被多个线程访问和修改的问题。这两节课提供了解决思路，一个是 cosmos 操作系统的方案，一个是 linux 的方案。
1. 原子性。就是硬件执行指令时不被打断。对于 x86 是复杂指令集。一条指令可以做读修改内存值的操作，指令集中直接支持锁定操作。对于精简指令集，就相对麻烦些，硬件会提供 bitband 的操作。
2. 中断控制是在执行时，防止中断信号突然来了把当前执行的过程打断了。 解决方法就是关闭中断。让中断信号等到可以通知时，才发起通知。
3. 自旋锁。在多核的 cpu 环境下，当前核心的 cpu 要访问的资源是有可能被其他核的 cpu 来访问的。如果产生这种情况，那就让其他核的 cpu 自己执行空转。一直到当前核心的 cpu 把访问资源让出后，其他核的 cpu 通过检测到了可以访问资源，不在空转执行相关操作恢复正常运行。而这个过程就是自旋锁。这里会有一点浪费 cpu 的运行效率。毕竟有个 cpu 在空转。当空转时间过长时，浪费的效能更大。我们需要更好的利用 cpu 核的方式来解决这个问题。那就是互斥。
4. 信号量
对于单一资源的信号量也可以说是互斥锁。  互斥锁和自旋锁的区别就是原来那个空转的核不再空转，而是把当前运行的线程或者进程睡眠去执行其他的线程或者进程了。  当资源被适当后，去通知睡眠线程或者进程。这就是信号量。linux 下新版本的信号量在被移除。</div><div><p>作者回复：你好，铁子总结 到位</p></div><div><div>2021-05-30</div><div><div><i></i><span>3</span></div><div><i></i><span>15</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/5f/09/2ec44412.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Qfeng</span></div><span>置顶</span></div><div>回答思考题：Linux 的读写锁，因为每次读锁加锁计数 - 1，所以最多支持 0x01000000 个进程并发读取共享数据。
这样的读写锁的不足：读或者写锁拿不到时忙等，可以优化成 trylock，拿不到可以先干其他的，等一段时间再尝试拿锁。（不知道回答的对不对）

感悟：不论是单值信号量还是多值信号量，亦或是原始自旋锁、trylock 版本自旋锁还是读写锁，各种机制的设计和优化都是为了资源（CPU 等）的更合理更高效的使用而优化。互斥机制有很多，理解每种锁机制重要，但是理解我们的业务更重要，这样才能因地制宜选择合适的锁。

老师简明扼要，点到即止的文风太赞了，谢谢。</div><div><p>作者回复：是的 </p></div><div><div>2022-03-29</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/52/40/e57a736e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pedro</span></div></div><div>以后我就是第一东吹了😁！
像这样的清晰明了，言简意赅的 Linux 内核源码解读实在是太少了，这样的文章读起来实在是太爽了，强烈小编安排一下东哥的下一个专栏叫做 《纵览 Linux 源码，小白也能学透》。

对于思考题答案，读并发进程的最大个数就是 0x01000000，只要 lock 大于 0 都是可以共享数据的。
至于读写锁的不足，我个人觉得最不友好的点在于读写互斥上，由于读锁对写锁是互斥的，如果一直有人读，那么计数器一直小于 0x01000000，加写锁时也一直小于 0，写锁一直也不会成功，会陷入长时间的写饥饿状态，并且一直自旋，浪费 CPU 资源。
所以改进点就在于，给写进程配上一个休眠队列，待加锁失败进入队列休眠等待，待解读锁时判断计数器，决定是否唤醒队列中的写进程。
当然还有很多其它的优化点，欢迎大家集思广益～</div><div><p>作者回复：哈哈 欢迎</p></div><div><div>2021-05-28</div><div><div><i></i><span>2</span></div><div><i></i><span>28</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/3e/e7/261711a5.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>blentle</span></div></div><div>回答一下思考题
1. 理论上可以支持 x01000000 这么多进程，但实际上受限于文件句炳也就是文件描述符的限制，还有考虑多个线程的问题等等，注定最终远远小于这个值
2. 读写锁造成写饥饿的情况是不是可以参考 jdk 的读写锁的实现，在条件等待队列中判断队列第一个元素是不是一个写进程，如果是写进程，让其直接优先获取锁.</div><div><p>作者回复：嗯嗯</p></div><div><div>2021-05-28</div><div><div><i></i></div><div><i></i><span>14</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div></div><div><div><div><span>Geek_8c4220</span></div></div><div>为什么这节里实现自旋锁的时候都没有关中断了呢？</div><div><p>作者回复：因为我没有讲</p></div><div><div>2021-06-09</div><div><div><i></i></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/4f/9d/72461b25.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 子青</span></div></div><div>老师，我有两个问题想请教
1 。Linux 自旋锁，如果一个进程在获取锁之后挂了怎么办，没人给 owner +1 了，后面排队的进程岂不是永远等不到锁释放？
2。信号量那里，down 是在链表的头部插入，up 是唤醒链表的头部，这样不会有饥饿问题吗，链表后面的可能永远拿不到资源？</div><div><p>作者回复: 1. 进程调用自旋锁，是在内核态运行的内核代码，如果在这个代码路径上挂了，那就说明内核有 BUG 需要修正
2. up 之后会对进程的优先级进行处理的，不会后面的进程没机会的</p></div><div><div>2021-09-23</div><div><div><i></i><span>2</span></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/vQiadbkZYR239J80hjekw7jzY9vy6otLKPNDSuz2lruDiaXlKGkcsX5wwiaFevicgqV8odlRG4UITiadDF3fgicrHPcw/132"></div></div><div><div><div><span> 疯码</span></div></div><div>请问下为什么保存和恢复 eflags 那段代码用 push pop 而不是 mov 呢</div><div><p>作者回复: eflags 寄存器不能使用 mov 指令访问</p></div><div><div>2022-01-18</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/sOuSC65kXWdWBAIIs6uXAD41Ed8Wo8tib81LLVOQJ2oK23TgPDy6x0PGmp7rXwLR3BHOicaKx1zib1DyfpCITK3dw/132"></div></div><div><div><div><span>GeekYanger</span></div></div><div>文中：
“//Linux 没有这样的结构，这只是为了描述方便
typedef struct raw_spinlock
{ 
        union 
                { 
                        unsigned int slock;// 真正的锁值变量 
                        u16 owner; 
                        u16 next; 
                }
} raw_spinlock_t;”
这里老师为了帮助我们理解汇编代码构造了一个这样的结构体，我觉得，这个 owner 和 next 要被包在一个 struct 中才是老师想要表述的意思，不然 owner 和 next 的取值是一样的，都是低 16 位。</div><div><p>作者回复：对 对 对 我大意了</p></div><div><div>2021-12-13</div><div><div><i></i><span>3</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1a/46/27/eb318d12.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Geek_4b6813</span></div></div><div>最多支持同时有 2^24 个进程共享读锁 (计算机常驻的进程基本上是不可能达到这个数的)
存在的问题，写饥饿，只要有读进程存在，写进程就永远没机会获得锁。</div><div><p>作者回复：是的 </p></div><div><div>2021-07-06</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div></div><div><div><div><span>K 菌无惨</span></div></div><div>请问 “_cond_lock 只用代码静态检查工作” 这句话时什么意思？</div><div><p>作者回复：这是 Linux 那一套，它有一个检查工具，对代码进行静态检查，能及早发现问题</p></div><div><div>2021-06-13</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJWFdKjyLOXtCzowmdCUFHezNlnux4NPWmYsqETjiaHNbnmb7xdzibDncZqP06nNbpN4AhmD76cpicfw/132"></div></div><div><div><div><span>fhs</span></div></div><div>读写锁部分中。假设 t1 时候 1 号写线程获取到了锁且不释放：lock=0，t2 时刻 2 号写线程尝试获取：lock=-(0x0100 0000)，t3 时刻 1 号读尝试获取：lock=-(0x0100 0001)。
之后 1 号写即便释放了锁，此时 lock = -1。但是 2 号写的比较成功的条件是："lock+0x01000000，直到结果的值等于 0x01000000"。1 号读的比较条件是 "循环测试 lock+1 的值，直到结果的值大于等于 1"。
即在 1 号写释放之后，2 号写和 1 号读因为 lock 是 - 1 永远达不到各自退出循环的条件，一直在自旋？</div><div><p>作者回复：不是这样的哦 多看看课程</p></div><div><div>2021-05-30</div><div><div><i></i><span>2</span></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/50/d5/73334a95.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>doos</span></div></div><div>感觉不学习汇编和 c 很多都看不懂</div><div><p>编辑回复：看你的目的，为了理解这门课，很多内容可以现搜的。汇编到初始化那里，后面都是 C。具体有啥不懂之处，你可以再留言提问。</p></div><div><div>2022-04-21</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/ef/18/6a620733.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 王子玉</span></div></div><div>关于小弟问的那个关于排队自旋锁的问题，好像是因为 gcc 汇编的源 目的和 intel 手册上的顺序是反的。关于 xaddl，intel 手册上说源是寄存器，目的是寄存器或内存。而 slock 是内存，不可能是源。所以小弟觉得源是 %0  inc，目的是 %1 slock, 所以 xaddl 相当于 temp = inc + slock,  inc = slock,  slock = slock + inc。 否则的话，每次调用 slock 都会被设成 inc 的初值 0001000，不合理。不知道彭东大神觉得如何</div><div><p>作者回复：点赞</p></div><div><div>2021-11-28</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/28/60/81/38b00111.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Feen</span></div></div><div>到第 9 课的时候，发现留言的数量少了很多，感觉操作系统（或者计算机原理）的淘汰率真的很高，能出师的太少了。关于最后的问题，应该说读锁最大支持的进程数是 0x01000000，写锁最大的进程数人为的设置为 1。写锁也可以设置为 0x01000000，因为对于计算机来说，到底有多少进程写对它来说无关，数据对计算机没有意义，数据只对于人能不能正确使用有关。所以才有上写锁的时候直接减去 0x01000000 这个初始值，目的是控制只有一个进程可以写，而不是为了 1 而设置 1。不管是中断，信号量，各种锁，最后都要靠 CPU 硬件的集成指令支持才能完成，就是原子操作，计算机上的各种软件，应用，服务都是靠原子操作完成自己的事务，手段就是在操作的时候不受打断，目的是完成一件事。怎么样能玩好原子操作，就能出师了。哈哈</div><div><p>作者回复：这只能表明你理解了计算机中的同步机制，但是操作系统需要知道的东西还有很多 </p></div><div><div>2021-06-17</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTIBV8Deuz0Ys4omVlErUvTeRLt7xYRPd8nxhSZ1C2Q9Nice7icHnndsHmyT3KBenxLGw7xghlDzfIuA/132"></div></div><div><div><div><span>LT</span></div></div><div>static inline int __raw_spin_trylock (raw_spinlock_t*lock){    int tmp;    int new;    asm volatile (    "movl %2,%0\n\t"//tmp=slock    "movl %0,%1\n\t"//new=tmp    "roll $16, %0\n\t"//tmp 循环左移 16 位，即 next 和 owner 交换了    "cmpl %0,%1\n\t"// 比较 tmp 和 new 即（owner、next）？=（next、owner）    "jne 1f\n\t" // 不等则跳转到标号 1 处     "addl $0x00010000, %1\n\t"// 相当于 next+1    "lock ; cmpxchgl %1,%2\n\t"//new 和 slock 交换比较        "1:"    "sete % b1\n\t" //new = eflags.ZF 位，ZF 取决于前面的判断是否相等    "movzbl % b1,%0\n\t" //tmp = new    :"=&amp;a"(tmp),"=Q"(new),"+m"(lock-&gt;slock)    ::"memory","cc");    return tmp;}

这段代码我看懂了，但是在 linux 代码树中我没有找到，甚至是用 grep.
我看 linux 代码经常会有这种情况，找不到相关的 ASM 代码的实现。LMOS，这段代码在那个文件中？

建议以后相关代码，标注下 linux 下的文件路径。</div><div><p>作者回复：这是旧版 linux 的 新版本中没有了 </p></div><div><div>2021-06-06</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/ea/dc/aa699264.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 宏典</span></div></div><div>重新定义一个代码段，避免后面的代码填充 cache。因为大部分加锁都是成功的。
这个可以理解。
但是为何重新重新定义一个代码段，就可以保证后面的代码不填充 cache?</div><div><p>作者回复：是的是的 </p></div><div><div>2021-05-31</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Paul Shan</span></div></div><div>请问老师，四种解决并发的方法中里是不是只有关中断是只和 CPU 的状态有关，也就是关闭了 CPU 接受中断调用的服务，其他的原子操作，自旋锁，信号量都需要内存和 CPU 各自的原子操作来配合？</div><div><p>作者回复：是的 是的 </p></div><div><div>2021-05-30</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJWFdKjyLOXtCzowmdCUFHezNlnux4NPWmYsqETjiaHNbnmb7xdzibDncZqP06nNbpN4AhmD76cpicfw/132"></div></div><div><div><div><span>fhs</span></div></div><div>请问下，Linux 的读写锁实现中，写锁每次获取的时候都减 0x0100 0000，那么如果有超过 128 个线程同时写，不是就可能会溢出么？即这个实现中最多只能支持 128 个写线程？</div><div><p>作者回复：为什么 只有 128 </p></div><div><div>2021-05-29</div><div><div><i></i><span>7</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Paul Shan</span></div></div><div>请问老师，原子变量的本质是不是只是对寄存器和内存操作，跳过了其他所有中间缓存，是一种用速度换一致性的方法？</div><div><p>作者回复：不是哦  是由硬件控制的 </p></div><div><div>2021-05-29</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".v"><outline class="toc-level-h1" data-reactid=".v.0" style="width: 175px;"><active data-reactid=".v.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".v.0.1"><span data-reactid=".v.0.1.0">09 | 瞧一瞧 Linux：Linux 的自旋锁和信号量如何实现？</span></a></outline><outline class="toc-level-h2" data-reactid=".v.1" style="width: 165px;"><active data-reactid=".v.1.0"></active><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".v.1.1"><span data-reactid=".v.1.1.0">Linux 的原子变量</span></a></outline><outline class="toc-level-h2" data-reactid=".v.2" style="width: 165px;"><active data-reactid=".v.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".v.2.1"><span data-reactid=".v.2.1.0">Linux 控制中断</span></a></outline><outline class="toc-level-h2" data-reactid=".v.3" style="width: 165px;"><active data-reactid=".v.3.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".v.3.1"><span data-reactid=".v.3.1.0">Linux 自旋锁</span></a></outline><outline class="toc-level-h3" data-reactid=".v.4" style="width: 155px;"><active data-reactid=".v.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".v.4.1"><span data-reactid=".v.4.1.0">Linux 原始自旋锁</span></a></outline><outline class="toc-level-h3" data-reactid=".v.5" style="width: 155px;"><active data-reactid=".v.5.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".v.5.1"><span data-reactid=".v.5.1.0">Linux 排队自旋锁</span></a></outline><outline class="toc-level-h2" data-reactid=".v.6" style="width: 165px;"><active data-reactid=".v.6.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".v.6.1"><span data-reactid=".v.6.1.0">Linux 信号量</span></a></outline><outline class="toc-level-h2" data-reactid=".v.7" style="width: 165px;"><active data-reactid=".v.7.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".v.7.1"><span data-reactid=".v.7.1.0">Linux 读写锁</span></a></outline><outline class="toc-level-h2" data-reactid=".v.8" style="width: 165px;"><active data-reactid=".v.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".v.8.1"><span data-reactid=".v.8.1.0">重点回顾</span></a></outline><outline class="toc-level-h2" data-reactid=".v.9" style="width: 165px;"><active data-reactid=".v.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".v.9.1"><span data-reactid=".v.9.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".v.a" style="width: 165px;"><active data-reactid=".v.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".v.a.1"><span data-reactid=".v.a.1.0">精选留言 (56)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/378870" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>