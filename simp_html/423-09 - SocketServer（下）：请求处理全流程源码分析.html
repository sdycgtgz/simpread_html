
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 09 | SocketServer（下）：请求处理全流程源码分析</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>09 | SocketServer（下）：请求处理全流程源码分析</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">为什么读源码逐渐成为了必选项？它究竟有什么作用呢？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">09 | SocketServer（下）：请求处理全流程源码分析</h1><div><span>胡夕</span> <span> 2020-05-07</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/5e/c7/5e7ae704dccc94c126dfcae6f34c0cc7.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：胡夕</span><span>大小：18.44M</span><span> 时长：20:09</span></div></div><audio title="09 | SocketServer（下）：请求处理全流程源码分析" src="https://res001.geekbang.org//media/audio/ba/74/baed9c709c9de3f084d51aedeeb93f74/ld/ld.m3u8" __idm_id__="49164"></audio></div><div><div><div><div data-slate-editor="true" data-key="10392" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="10393"><span data-slate-object="text" data-key="10394"><span data-slate-leaf="true" data-offset-key="10394:0" data-first-offset="true"><span data-slate-string="true">你好，我是胡夕。前几节课，我们花了很多时间学习 SocketServer 核心组件的源代码，包括 Acceptor 线程、Processor 线程，也研究了 Data plane 和 Control plane 针对不同类型请求的处理方案。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10395"><span data-slate-object="text" data-key="10396"><span data-slate-leaf="true" data-offset-key="10396:0" data-first-offset="true"><span data-slate-string="true">今天，我带你完整地梳理一下 Kafka 请求处理的全流程。这个全流程涉及到多个源码文件，为了弄懂其中的原理，我们必须在不同的方法间 “跳来跳去”。比起学习单个源码文件，将多个文件中的方法组合在一起串成完整流程要难得多，因此，你最好多花一些时间，仔细研读一下跟这套流程相关的所有方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10397"><span data-slate-object="text" data-key="10398"><span data-slate-leaf="true" data-offset-key="10398:0" data-first-offset="true"><span data-slate-string="true">当然了，你可能有这样的疑问：“我为什么要关心请求被处理的流程呢？阅读这部分源码的意义是什么呢？” 其实，</span></span></span><span data-slate-object="text" data-key="10399"><span data-slate-leaf="true" data-offset-key="10399:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">弄明白这部分原理，非常有助于我们有针对性地调优 Broker 端请求处理的性能</span></span></span></span><span data-slate-object="text" data-key="10400"><span data-slate-leaf="true" data-offset-key="10400:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10401"><span data-slate-object="text" data-key="10402"><span data-slate-leaf="true" data-offset-key="10402:0" data-first-offset="true"><span data-slate-string="true">举个例子，Broker 端有两个参数与这个流程相关，分别是 num.network.threads 和 num.io.threads。如果我们不掌握请求被处理的流程，是没有办法有的放矢地调整这些参数的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10403"><span data-slate-object="text" data-key="10404"><span data-slate-leaf="true" data-offset-key="10404:0" data-first-offset="true"><span data-slate-string="true">要知道，Kafka 官网可没有告诉我们，什么是网络线程和 I/O 线程。如果不明白 “请求是被网络线程接收并放入请求队列的” 这件事，我们就很可能犯这样的错误 —— 当请求队列快满了的时候，我们会以为是网络线程处理能力不够，进而盲目地增加 num.network.threads 值，但最终效果很可能是适得其反的。我相信，在今天的课程结束之后，你就会知道，碰到这种情况的时候，我们更应该增加的是 num.io.threads 的值。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10405"><span data-slate-object="text" data-key="10406"><span data-slate-leaf="true" data-offset-key="10406:0" data-first-offset="true"><span data-slate-string="true">num.io.threads 参数表征的就是 I/O 线程池的大小。所谓的 I/O 线程池，即 KafkaRequestHandlerPool，也称请求处理线程池。这节课我会先讲解 </span></span></span><span data-slate-object="text" data-key="10407"><span data-slate-leaf="true" data-offset-key="10407:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">KafkaRequestHandlerPool 源码</span></span></span></span><span data-slate-object="text" data-key="10408"><span data-slate-leaf="true" data-offset-key="10408:0" data-first-offset="true"><span data-slate-string="true">，再具体解析</span></span></span><span data-slate-object="text" data-key="10409"><span data-slate-leaf="true" data-offset-key="10409:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">请求处理全流程的代码</span></span></span></span><span data-slate-object="text" data-key="10410"><span data-slate-leaf="true" data-offset-key="10410:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="10411" id="sr-toc-1"><span data-slate-object="text" data-key="10412"><span data-slate-leaf="true" data-offset-key="10412:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandlerPool</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="10413"><span data-slate-object="text" data-key="10414"><span data-slate-leaf="true" data-offset-key="10414:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">KafkaRequestHandlerPool 是真正处理 Kafka 请求的地方</span></span></span></span><span data-slate-object="text" data-key="10415"><span data-slate-leaf="true" data-offset-key="10415:0" data-first-offset="true"><span data-slate-string="true">。切记，Kafka 中处理请求的类不是 SocketServer，也不是 RequestChannel，而是 KafkaRequestHandlerPool。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10416"><span data-slate-object="text" data-key="10417"><span data-slate-leaf="true" data-offset-key="10417:0" data-first-offset="true"><span data-slate-string="true">它所在的文件是 KafkaRequestHandler.scala，位于 core 包的 src/main/scala/kafka/server 下。这是一个不到 400 行的小文件，掌握起来并不难。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10418"><span data-slate-object="text" data-key="10419"><span data-slate-leaf="true" data-offset-key="10419:0" data-first-offset="true"><span data-slate-string="true">我先用一张图给你展示下这个文件里都有哪些组件：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10420"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/d3/f9/d3e7713bab984782dec557c534c558f9.jpg?wh=2284*1738"></div></div><div data-slate-type="list" data-slate-object="block" data-key="10421"><div data-slate-type="list-line" data-slate-object="block" data-key="10422"><span data-slate-object="text" data-key="10423"><span data-slate-leaf="true" data-offset-key="10423:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">KafkaRequestHandler</span></span></span></span><span data-slate-object="text" data-key="10424"><span data-slate-leaf="true" data-offset-key="10424:0" data-first-offset="true"><span data-slate-string="true">：请求处理线程类。每个请求处理线程实例，负责从 SocketServer 的 RequestChannel 的请求队列中获取请求对象，并进行处理。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10425"><span data-slate-object="text" data-key="10426"><span data-slate-leaf="true" data-offset-key="10426:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">KafkaRequestHandlerPool</span></span></span></span><span data-slate-object="text" data-key="10427"><span data-slate-leaf="true" data-offset-key="10427:0" data-first-offset="true"><span data-slate-string="true">：请求处理线程池，负责创建、维护、管理和销毁下辖的请求处理线程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10428"><span data-slate-object="text" data-key="10429"><span data-slate-leaf="true" data-offset-key="10429:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">BrokerTopicMetrics</span></span></span></span><span data-slate-object="text" data-key="10430"><span data-slate-leaf="true" data-offset-key="10430:0" data-first-offset="true"><span data-slate-string="true">：Broker 端与主题相关的监控指标的管理类。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10431"><span data-slate-object="text" data-key="10432"><span data-slate-leaf="true" data-offset-key="10432:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">BrokerTopicStats（C）</span></span></span></span><span data-slate-object="text" data-key="10433"><span data-slate-leaf="true" data-offset-key="10433:0" data-first-offset="true"><span data-slate-string="true">：定义 Broker 端与主题相关的监控指标的管理操作。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10434"><span data-slate-object="text" data-key="10435"><span data-slate-leaf="true" data-offset-key="10435:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">BrokerTopicStats（O）</span></span></span></span><span data-slate-object="text" data-key="10436"><span data-slate-leaf="true" data-offset-key="10436:0" data-first-offset="true"><span data-slate-string="true">：BrokerTopicStats 的伴生对象类，定义 Broker 端与主题相关的监控指标，比如常见的 MessagesInPerSec 和 MessagesOutPerSec 等。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10437"><span data-slate-object="text" data-key="10438"><span data-slate-leaf="true" data-offset-key="10438:0" data-first-offset="true"><span data-slate-string="true">我们重点看前两个组件的代码。后面的三个类或对象都是与监控指标相关的，代码多为一些工具类方法或定义常量，非常容易理解。所以，我们不必在它们身上花费太多时间，要把主要精力放在 KafkaRequestHandler 及其相关管理类的学习上。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="10439" id="sr-toc-2"><span data-slate-object="text" data-key="10440"><span data-slate-leaf="true" data-offset-key="10440:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandler</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="10441"><span data-slate-object="text" data-key="10442"><span data-slate-leaf="true" data-offset-key="10442:0" data-first-offset="true"><span data-slate-string="true">首先，我们来看下它的定义：</span></span></span></div><div data-code-language="javascript" data-slate-type="pre" data-slate-object="block" data-key="10443"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10444"><span data-slate-object="text" data-key="10445"><span data-slate-leaf="true" data-offset-key="10445:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关键字段说明</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10446"><span data-slate-object="text" data-key="10447"><span data-slate-leaf="true" data-offset-key="10447:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//id: I/O 线程序号</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10448"><span data-slate-object="text" data-key="10449"><span data-slate-leaf="true" data-offset-key="10449:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//brokerId：所在 Broker 序号，即 broker.id 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10450"><span data-slate-object="text" data-key="10451"><span data-slate-leaf="true" data-offset-key="10451:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//totalHandlerThreads：I/O 线程池大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10452"><span data-slate-object="text" data-key="10453"><span data-slate-leaf="true" data-offset-key="10453:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//requestChannel：请求处理通道</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10454"><span data-slate-object="text" data-key="10455"><span data-slate-leaf="true" data-offset-key="10455:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//apis：KafkaApis 类，用于真正实现请求处理逻辑的类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10456"><span data-slate-object="text" data-key="10457"><span data-slate-leaf="true" data-offset-key="10457:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="10458"><span data-slate-leaf="true" data-offset-key="10458:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10459"><span data-slate-leaf="true" data-offset-key="10459:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaRequestHandler</span></span></span></span><span data-slate-object="text" data-key="10460"><span data-slate-leaf="true" data-offset-key="10460:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10461"><span data-slate-object="text" data-key="10462"><span data-slate-leaf="true" data-offset-key="10462:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10463"><span data-slate-leaf="true" data-offset-key="10463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">id</span></span></span></span><span data-slate-object="text" data-key="10464"><span data-slate-leaf="true" data-offset-key="10464:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10465"><span data-slate-leaf="true" data-offset-key="10465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="10466"><span data-slate-leaf="true" data-offset-key="10466:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10467"><span data-slate-object="text" data-key="10468"><span data-slate-leaf="true" data-offset-key="10468:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10469"><span data-slate-leaf="true" data-offset-key="10469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">brokerId</span></span></span></span><span data-slate-object="text" data-key="10470"><span data-slate-leaf="true" data-offset-key="10470:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10471"><span data-slate-leaf="true" data-offset-key="10471:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="10472"><span data-slate-leaf="true" data-offset-key="10472:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10473"><span data-slate-object="text" data-key="10474"><span data-slate-leaf="true" data-offset-key="10474:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="10475"><span data-slate-leaf="true" data-offset-key="10475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">aggregateIdleMeter</span></span></span></span><span data-slate-object="text" data-key="10476"><span data-slate-leaf="true" data-offset-key="10476:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10477"><span data-slate-leaf="true" data-offset-key="10477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Meter</span></span></span></span><span data-slate-object="text" data-key="10478"><span data-slate-leaf="true" data-offset-key="10478:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10479"><span data-slate-object="text" data-key="10480"><span data-slate-leaf="true" data-offset-key="10480:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="10481"><span data-slate-leaf="true" data-offset-key="10481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">totalHandlerThreads</span></span></span></span><span data-slate-object="text" data-key="10482"><span data-slate-leaf="true" data-offset-key="10482:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10483"><span data-slate-leaf="true" data-offset-key="10483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AtomicInteger</span></span></span></span><span data-slate-object="text" data-key="10484"><span data-slate-leaf="true" data-offset-key="10484:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10485"><span data-slate-object="text" data-key="10486"><span data-slate-leaf="true" data-offset-key="10486:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="10487"><span data-slate-leaf="true" data-offset-key="10487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestChannel</span></span></span></span><span data-slate-object="text" data-key="10488"><span data-slate-leaf="true" data-offset-key="10488:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10489"><span data-slate-leaf="true" data-offset-key="10489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestChannel</span></span></span></span><span data-slate-object="text" data-key="10490"><span data-slate-leaf="true" data-offset-key="10490:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10491"><span data-slate-object="text" data-key="10492"><span data-slate-leaf="true" data-offset-key="10492:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10493"><span data-slate-leaf="true" data-offset-key="10493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">apis</span></span></span></span><span data-slate-object="text" data-key="10494"><span data-slate-leaf="true" data-offset-key="10494:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10495"><span data-slate-leaf="true" data-offset-key="10495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaApis</span></span></span></span><span data-slate-object="text" data-key="10496"><span data-slate-leaf="true" data-offset-key="10496:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10497"><span data-slate-object="text" data-key="10498"><span data-slate-leaf="true" data-offset-key="10498:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10499"><span data-slate-leaf="true" data-offset-key="10499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">time</span></span></span></span><span data-slate-object="text" data-key="10500"><span data-slate-leaf="true" data-offset-key="10500:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10501"><span data-slate-leaf="true" data-offset-key="10501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Time</span></span></span></span><span data-slate-object="text" data-key="10502"><span data-slate-leaf="true" data-offset-key="10502:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span><span data-slate-object="text" data-key="10503"><span data-slate-leaf="true" data-offset-key="10503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="10504"><span data-slate-leaf="true" data-offset-key="10504:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10505"><span data-slate-leaf="true" data-offset-key="10505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Runnable</span></span></span></span><span data-slate-object="text" data-key="10506"><span data-slate-leaf="true" data-offset-key="10506:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10507"><span data-slate-leaf="true" data-offset-key="10507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">with</span></span></span></span><span data-slate-object="text" data-key="10508"><span data-slate-leaf="true" data-offset-key="10508:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10509"><span data-slate-leaf="true" data-offset-key="10509:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Logging</span></span></span></span><span data-slate-object="text" data-key="10510"><span data-slate-leaf="true" data-offset-key="10510:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10511"><span data-slate-object="text" data-key="10512"><span data-slate-leaf="true" data-offset-key="10512:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10513"><span data-slate-object="text" data-key="10514"><span data-slate-leaf="true" data-offset-key="10514:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10515"><span data-slate-object="text" data-key="10516"><span data-slate-leaf="true" data-offset-key="10516:0" data-first-offset="true"><span data-slate-string="true">从定义可知，KafkaRequestHandler 是一个 Runnable 对象，因此，你可以把它当成是一个线程。每个 KafkaRequestHandler 实例，都有 4 个关键的属性。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10517"><div data-slate-type="list-line" data-slate-object="block" data-key="10518"><span data-slate-object="text" data-key="10519"><span data-slate-leaf="true" data-offset-key="10519:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">id</span></span></span></span><span data-slate-object="text" data-key="10520"><span data-slate-leaf="true" data-offset-key="10520:0" data-first-offset="true"><span data-slate-string="true">：请求处理线程的序号，类似于 Processor 线程的 ID 序号，仅仅用于标识这是线程池中的第几个线程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10521"><span data-slate-object="text" data-key="10522"><span data-slate-leaf="true" data-offset-key="10522:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">brokerId</span></span></span></span><span data-slate-object="text" data-key="10523"><span data-slate-leaf="true" data-offset-key="10523:0" data-first-offset="true"><span data-slate-string="true">：Broker 序号，用于标识这是哪个 Broker 上的请求处理线程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10524"><span data-slate-object="text" data-key="10525"><span data-slate-leaf="true" data-offset-key="10525:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">requestChannel</span></span></span></span><span data-slate-object="text" data-key="10526"><span data-slate-leaf="true" data-offset-key="10526:0" data-first-offset="true"><span data-slate-string="true">：SocketServer 中的请求通道对象。KafkaRequestHandler 对象为什么要定义这个字段呢？我们说过，它是负责处理请求的类，那请求保存在什么地方呢？实际上，请求恰恰是保存在 RequestChannel 中的请求队列中，因此，Kafka 在构造 KafkaRequestHandler 实例时，必须关联 SocketServer 组件中的 RequestChannel 实例，也就是说，要让 I/O 线程能够找到请求被保存的地方。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10527"><span data-slate-object="text" data-key="10528"><span data-slate-leaf="true" data-offset-key="10528:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">apis</span></span></span></span><span data-slate-object="text" data-key="10529"><span data-slate-leaf="true" data-offset-key="10529:0" data-first-offset="true"><span data-slate-string="true">：这是一个 KafkaApis 类。如果说 KafkaRequestHandler 是真正处理请求的，那么，KafkaApis 类就是真正执行请求处理逻辑的地方。在第 10 节课，我会具体讲解 KafkaApis 的代码。目前，你需要知道的是，它有个 handle 方法，用于执行请求处理逻辑。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10530"><span data-slate-object="text" data-key="10531"><span data-slate-leaf="true" data-offset-key="10531:0" data-first-offset="true"><span data-slate-string="true">既然 KafkaRequestHandler 是一个线程类，那么，除去常规的 close、stop、initiateShutdown 和 awaitShutdown 方法，最重要的当属 run 方法实现了，如下所示：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="10532"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10533"><span data-slate-object="text" data-key="10534"><span data-slate-leaf="true" data-offset-key="10534:0" data-first-offset="true"><span data-slate-string="true">def run(): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10535"><span data-slate-object="text" data-key="10536"><span data-slate-leaf="true" data-offset-key="10536:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10537"><span data-slate-leaf="true" data-offset-key="10537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 只要该线程尚未关闭，循环运行处理逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10538"><span data-slate-object="text" data-key="10539"><span data-slate-leaf="true" data-offset-key="10539:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10540"><span data-slate-leaf="true" data-offset-key="10540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="10541"><span data-slate-leaf="true" data-offset-key="10541:0" data-first-offset="true"><span data-slate-string="true"> (!stopped) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10542"><span data-slate-object="text" data-key="10543"><span data-slate-leaf="true" data-offset-key="10543:0" data-first-offset="true"><span data-slate-string="true">    val startSelectTime = time.nanoseconds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10544"><span data-slate-object="text" data-key="10545"><span data-slate-leaf="true" data-offset-key="10545:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10546"><span data-slate-leaf="true" data-offset-key="10546:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从请求队列中获取下一个待处理的请求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10547"><span data-slate-object="text" data-key="10548"><span data-slate-leaf="true" data-offset-key="10548:0" data-first-offset="true"><span data-slate-string="true">    val req = requestChannel.receiveRequest(</span></span></span><span data-slate-object="text" data-key="10549"><span data-slate-leaf="true" data-offset-key="10549:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">300</span></span></span></span><span data-slate-object="text" data-key="10550"><span data-slate-leaf="true" data-offset-key="10550:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10551"><span data-slate-object="text" data-key="10552"><span data-slate-leaf="true" data-offset-key="10552:0" data-first-offset="true"><span data-slate-string="true">    val endTime = time.nanoseconds</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10553"><span data-slate-object="text" data-key="10554"><span data-slate-leaf="true" data-offset-key="10554:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10555"><span data-slate-leaf="true" data-offset-key="10555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 统计线程空闲时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10556"><span data-slate-object="text" data-key="10557"><span data-slate-leaf="true" data-offset-key="10557:0" data-first-offset="true"><span data-slate-string="true">    val idleTime = endTime - startSelectTime</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10558"><span data-slate-object="text" data-key="10559"><span data-slate-leaf="true" data-offset-key="10559:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10560"><span data-slate-leaf="true" data-offset-key="10560:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新线程空闲百分比指标</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10561"><span data-slate-object="text" data-key="10562"><span data-slate-leaf="true" data-offset-key="10562:0" data-first-offset="true"><span data-slate-string="true">    aggregateIdleMeter.mark(idleTime / totalHandlerThreads.</span></span></span><span data-slate-object="text" data-key="10563"><span data-slate-leaf="true" data-offset-key="10563:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="10564"><span data-slate-leaf="true" data-offset-key="10564:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10565"><span data-slate-object="text" data-key="10566"><span data-slate-leaf="true" data-offset-key="10566:0" data-first-offset="true"><span data-slate-string="true">    req match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10567"><span data-slate-object="text" data-key="10568"><span data-slate-leaf="true" data-offset-key="10568:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10569"><span data-slate-leaf="true" data-offset-key="10569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭线程请求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10570"><span data-slate-object="text" data-key="10571"><span data-slate-leaf="true" data-offset-key="10571:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10572"><span data-slate-leaf="true" data-offset-key="10572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="10573"><span data-slate-leaf="true" data-offset-key="10573:0" data-first-offset="true"><span data-slate-string="true"> RequestChannel.ShutdownRequest =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10574"><span data-slate-object="text" data-key="10575"><span data-slate-leaf="true" data-offset-key="10575:0" data-first-offset="true"><span data-slate-string="true">        debug(s</span></span></span><span data-slate-object="text" data-key="10576"><span data-slate-leaf="true" data-offset-key="10576:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Kafka request handler </span></span></span></span><span data-slate-object="text" data-key="10577"><span data-slate-leaf="true" data-offset-key="10577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$id</span></span></span></span></span><span data-slate-object="text" data-key="10578"><span data-slate-leaf="true" data-offset-key="10578:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> on broker </span></span></span></span><span data-slate-object="text" data-key="10579"><span data-slate-leaf="true" data-offset-key="10579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$brokerId</span></span></span></span></span><span data-slate-object="text" data-key="10580"><span data-slate-leaf="true" data-offset-key="10580:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> received shut down command"</span></span></span></span><span data-slate-object="text" data-key="10581"><span data-slate-leaf="true" data-offset-key="10581:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10582"><span data-slate-object="text" data-key="10583"><span data-slate-leaf="true" data-offset-key="10583:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10584"><span data-slate-leaf="true" data-offset-key="10584:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关闭线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10585"><span data-slate-object="text" data-key="10586"><span data-slate-leaf="true" data-offset-key="10586:0" data-first-offset="true"><span data-slate-string="true">        shutdownComplete.countDown()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10587"><span data-slate-object="text" data-key="10588"><span data-slate-leaf="true" data-offset-key="10588:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10589"><span data-slate-leaf="true" data-offset-key="10589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10590"><span data-slate-object="text" data-key="10591"><span data-slate-leaf="true" data-offset-key="10591:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10592"><span data-slate-leaf="true" data-offset-key="10592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 普通请求</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10593"><span data-slate-object="text" data-key="10594"><span data-slate-leaf="true" data-offset-key="10594:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10595"><span data-slate-leaf="true" data-offset-key="10595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="10596"><span data-slate-leaf="true" data-offset-key="10596:0" data-first-offset="true"><span data-slate-string="true"> request: RequestChannel.Request =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10597"><span data-slate-object="text" data-key="10598"><span data-slate-leaf="true" data-offset-key="10598:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="10599"><span data-slate-leaf="true" data-offset-key="10599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="10600"><span data-slate-leaf="true" data-offset-key="10600:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10601"><span data-slate-object="text" data-key="10602"><span data-slate-leaf="true" data-offset-key="10602:0" data-first-offset="true"><span data-slate-string="true">          request.requestDequeueTimeNanos = endTime</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10603"><span data-slate-object="text" data-key="10604"><span data-slate-leaf="true" data-offset-key="10604:0" data-first-offset="true"><span data-slate-string="true">          trace(s</span></span></span><span data-slate-object="text" data-key="10605"><span data-slate-leaf="true" data-offset-key="10605:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Kafka request handler </span></span></span></span><span data-slate-object="text" data-key="10606"><span data-slate-leaf="true" data-offset-key="10606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$id</span></span></span></span></span><span data-slate-object="text" data-key="10607"><span data-slate-leaf="true" data-offset-key="10607:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> on broker </span></span></span></span><span data-slate-object="text" data-key="10608"><span data-slate-leaf="true" data-offset-key="10608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$brokerId</span></span></span></span></span><span data-slate-object="text" data-key="10609"><span data-slate-leaf="true" data-offset-key="10609:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> handling request </span></span></span></span><span data-slate-object="text" data-key="10610"><span data-slate-leaf="true" data-offset-key="10610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">$request</span></span></span></span></span><span data-slate-object="text" data-key="10611"><span data-slate-leaf="true" data-offset-key="10611:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="10612"><span data-slate-leaf="true" data-offset-key="10612:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10613"><span data-slate-object="text" data-key="10614"><span data-slate-leaf="true" data-offset-key="10614:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10615"><span data-slate-leaf="true" data-offset-key="10615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 由 KafkaApis.handle 方法执行相应处理逻辑</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10616"><span data-slate-object="text" data-key="10617"><span data-slate-leaf="true" data-offset-key="10617:0" data-first-offset="true"><span data-slate-string="true">          apis.handle(request)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10618"><span data-slate-object="text" data-key="10619"><span data-slate-leaf="true" data-offset-key="10619:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="10620"><span data-slate-leaf="true" data-offset-key="10620:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="10621"><span data-slate-leaf="true" data-offset-key="10621:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10622"><span data-slate-object="text" data-key="10623"><span data-slate-leaf="true" data-offset-key="10623:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10624"><span data-slate-leaf="true" data-offset-key="10624:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果出现严重错误，立即关闭线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10625"><span data-slate-object="text" data-key="10626"><span data-slate-leaf="true" data-offset-key="10626:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10627"><span data-slate-leaf="true" data-offset-key="10627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="10628"><span data-slate-leaf="true" data-offset-key="10628:0" data-first-offset="true"><span data-slate-string="true"> e: FatalExitError =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10629"><span data-slate-object="text" data-key="10630"><span data-slate-leaf="true" data-offset-key="10630:0" data-first-offset="true"><span data-slate-string="true">            shutdownComplete.countDown()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10631"><span data-slate-object="text" data-key="10632"><span data-slate-leaf="true" data-offset-key="10632:0" data-first-offset="true"><span data-slate-string="true">            Exit.exit(e.statusCode)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10633"><span data-slate-object="text" data-key="10634"><span data-slate-leaf="true" data-offset-key="10634:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10635"><span data-slate-leaf="true" data-offset-key="10635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果是普通异常，记录错误日志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10636"><span data-slate-object="text" data-key="10637"><span data-slate-leaf="true" data-offset-key="10637:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10638"><span data-slate-leaf="true" data-offset-key="10638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="10639"><span data-slate-leaf="true" data-offset-key="10639:0" data-first-offset="true"><span data-slate-string="true"> e: Throwable =&gt; error(</span></span></span><span data-slate-object="text" data-key="10640"><span data-slate-leaf="true" data-offset-key="10640:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Exception when handling request"</span></span></span></span><span data-slate-object="text" data-key="10641"><span data-slate-leaf="true" data-offset-key="10641:0" data-first-offset="true"><span data-slate-string="true">, e)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10642"><span data-slate-object="text" data-key="10643"><span data-slate-leaf="true" data-offset-key="10643:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="10644"><span data-slate-leaf="true" data-offset-key="10644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">finally</span></span></span></span><span data-slate-object="text" data-key="10645"><span data-slate-leaf="true" data-offset-key="10645:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10646"><span data-slate-object="text" data-key="10647"><span data-slate-leaf="true" data-offset-key="10647:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="10648"><span data-slate-leaf="true" data-offset-key="10648:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 释放请求对象占用的内存缓冲区资源</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10649"><span data-slate-object="text" data-key="10650"><span data-slate-leaf="true" data-offset-key="10650:0" data-first-offset="true"><span data-slate-string="true">          request.releaseBuffer()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10651"><span data-slate-object="text" data-key="10652"><span data-slate-leaf="true" data-offset-key="10652:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10653"><span data-slate-object="text" data-key="10654"><span data-slate-leaf="true" data-offset-key="10654:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10655"><span data-slate-leaf="true" data-offset-key="10655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="10656"><span data-slate-leaf="true" data-offset-key="10656:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10657"><span data-slate-leaf="true" data-offset-key="10657:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="10658"><span data-slate-leaf="true" data-offset-key="10658:0" data-first-offset="true"><span data-slate-string="true"> =&gt; </span></span></span><span data-slate-object="text" data-key="10659"><span data-slate-leaf="true" data-offset-key="10659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 继续</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10660"><span data-slate-object="text" data-key="10661"><span data-slate-leaf="true" data-offset-key="10661:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10662"><span data-slate-object="text" data-key="10663"><span data-slate-leaf="true" data-offset-key="10663:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10664"><span data-slate-object="text" data-key="10665"><span data-slate-leaf="true" data-offset-key="10665:0" data-first-offset="true"><span data-slate-string="true">  shutdownComplete.countDown()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10666"><span data-slate-object="text" data-key="10667"><span data-slate-leaf="true" data-offset-key="10667:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10668"><span data-slate-object="text" data-key="10669"><span data-slate-leaf="true" data-offset-key="10669:0" data-first-offset="true"><span data-slate-string="true">虽然我给一些主要的代码都标记了注释，但为了方便你更好地理解，我画一张图，借助它来展示下 KafkaRequestHandler 线程的处理逻辑：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="10670"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/b5/4d/b5f6d3b4ecea86a3e66a29953034dc4d.jpg?wh=4456*3842"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10671"><span data-slate-object="text" data-key="10672"><span data-slate-leaf="true" data-offset-key="10672:0" data-first-offset="true"><span data-slate-string="true">我来解释下 run 方法的主要运行逻辑。它的所有执行逻辑都在 while 循环之下，因此，只要标志线程关闭状态的 stopped 为 false，run 方法将一直循环执行 while 下的语句。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10673"><span data-slate-object="text" data-key="10674"><span data-slate-leaf="true" data-offset-key="10674:0" data-first-offset="true"><span data-slate-string="true">那，第 1 步是从请求队列中获取下一个待处理的请求，同时更新一些相关的统计指标。如果本次循环没取到，那么本轮循环结束，进入到下一轮。如果是 ShutdownRequest 请求，则说明该 Broker 发起了关闭操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10675"><span data-slate-object="text" data-key="10676"><span data-slate-leaf="true" data-offset-key="10676:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_349735d9" data-attr-id="27952" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">而 Broker 关闭时会调用 KafkaRequestHandler 的 shutdown 方法，进而调用 initiateShutdown 方法，以及 RequestChannel 的 sendShutdownRequest 方法，而后者就是将 ShutdownRequest 写入到请求队列。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10677"><span data-slate-object="text" data-key="10678"><span data-slate-leaf="true" data-offset-key="10678:0" data-first-offset="true"><span data-slate-string="true">一旦从请求队列中获取到 ShutdownRequest，run 方法代码会调用 shutdownComplete 的 countDown 方法，正式完成对 KafkaRequestHandler 线程的关闭操作。你看看 KafkaRequestHandlerPool 的 shutdown 方法代码，就能明白这是怎么回事了。</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="10679"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10680"><span data-slate-object="text" data-key="10681"><span data-slate-leaf="true" data-offset-key="10681:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def </span></span></span></span><span data-slate-object="text" data-key="10682"><span data-slate-leaf="true" data-offset-key="10682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">shutdown</span></span></span></span></span><span data-slate-object="text" data-key="10683"><span data-slate-leaf="true" data-offset-key="10683:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="10684"><span data-slate-leaf="true" data-offset-key="10684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="10685"><span data-slate-leaf="true" data-offset-key="10685:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10686"><span data-slate-leaf="true" data-offset-key="10686:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="10687"><span data-slate-leaf="true" data-offset-key="10687:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10688"><span data-slate-object="text" data-key="10689"><span data-slate-leaf="true" data-offset-key="10689:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10690"><span data-slate-leaf="true" data-offset-key="10690:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">info</span></span></span></span><span data-slate-object="text" data-key="10691"><span data-slate-leaf="true" data-offset-key="10691:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10692"><span data-slate-leaf="true" data-offset-key="10692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"shutting down"</span></span></span></span><span data-slate-object="text" data-key="10693"><span data-slate-leaf="true" data-offset-key="10693:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10694"><span data-slate-object="text" data-key="10695"><span data-slate-leaf="true" data-offset-key="10695:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10696"><span data-slate-leaf="true" data-offset-key="10696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10697"><span data-slate-leaf="true" data-offset-key="10697:0" data-first-offset="true"><span data-slate-string="true"> (handler &lt;- runnables)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10698"><span data-slate-object="text" data-key="10699"><span data-slate-leaf="true" data-offset-key="10699:0" data-first-offset="true"><span data-slate-string="true">      handler.</span></span></span><span data-slate-object="text" data-key="10700"><span data-slate-leaf="true" data-offset-key="10700:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">initiateShutdown</span></span></span></span><span data-slate-object="text" data-key="10701"><span data-slate-leaf="true" data-offset-key="10701:0" data-first-offset="true"><span data-slate-string="true">() </span></span></span><span data-slate-object="text" data-key="10702"><span data-slate-leaf="true" data-offset-key="10702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用 initiateShutdown 方法发起关闭</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10703"><span data-slate-object="text" data-key="10704"><span data-slate-leaf="true" data-offset-key="10704:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10705"><span data-slate-leaf="true" data-offset-key="10705:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10706"><span data-slate-leaf="true" data-offset-key="10706:0" data-first-offset="true"><span data-slate-string="true"> (handler &lt;- runnables)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10707"><span data-slate-object="text" data-key="10708"><span data-slate-leaf="true" data-offset-key="10708:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10709"><span data-slate-leaf="true" data-offset-key="10709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 调用 awaitShutdown 方法等待关闭完成</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10710"><span data-slate-object="text" data-key="10711"><span data-slate-leaf="true" data-offset-key="10711:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="10712"><span data-slate-leaf="true" data-offset-key="10712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//run 方法一旦调用 countDown 方法，这里将解除等待状态</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10713"><span data-slate-object="text" data-key="10714"><span data-slate-leaf="true" data-offset-key="10714:0" data-first-offset="true"><span data-slate-string="true">      handler.</span></span></span><span data-slate-object="text" data-key="10715"><span data-slate-leaf="true" data-offset-key="10715:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">awaitShutdown</span></span></span></span><span data-slate-object="text" data-key="10716"><span data-slate-leaf="true" data-offset-key="10716:0" data-first-offset="true"><span data-slate-string="true">() </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10717"><span data-slate-object="text" data-key="10718"><span data-slate-leaf="true" data-offset-key="10718:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10719"><span data-slate-leaf="true" data-offset-key="10719:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">info</span></span></span></span><span data-slate-object="text" data-key="10720"><span data-slate-leaf="true" data-offset-key="10720:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="10721"><span data-slate-leaf="true" data-offset-key="10721:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"shut down completely"</span></span></span></span><span data-slate-object="text" data-key="10722"><span data-slate-leaf="true" data-offset-key="10722:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10723"><span data-slate-object="text" data-key="10724"><span data-slate-leaf="true" data-offset-key="10724:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10725"><span data-slate-object="text" data-key="10726"><span data-slate-leaf="true" data-offset-key="10726:0" data-first-offset="true"><span data-slate-string="true">就像代码注释中写的那样，一旦 run 方法执行了 countDown 方法，程序流解除在 awaitShutdown 方法这里的等待，从而完成整个线程的关闭操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10727"><span data-slate-object="text" data-key="10728"><span data-slate-leaf="true" data-offset-key="10728:0" data-first-offset="true"><span data-slate-string="true">我们继续说回 run 方法。如果从请求队列中获取的是普通请求，那么，首先更新请求移出队列的时间戳，然后交由 KafkaApis 的 handle 方法执行实际的请求处理逻辑代码。待请求处理完成，并被释放缓冲区资源后，代码进入到下一轮循环，周而复始地执行以上所说的逻辑。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="10729" id="sr-toc-3"><span data-slate-object="text" data-key="10730"><span data-slate-leaf="true" data-offset-key="10730:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandlerPool</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="10731"><span data-slate-object="text" data-key="10732"><span data-slate-leaf="true" data-offset-key="10732:0" data-first-offset="true"><span data-slate-string="true">从上面的分析来看，KafkaRequestHandler 逻辑大体上还是比较简单的。下面我们来看下 KafkaRequestHandlerPool 线程池的实现。它是管理 I/O 线程池的，实现逻辑也不复杂。它的 shutdown 方法前面我讲过了，这里我们重点学习下，</span></span></span><span data-slate-object="text" data-key="10733"><span data-slate-leaf="true" data-offset-key="10733:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">它是如何创建这些线程的，以及创建它们的时机</span></span></span></span><span data-slate-object="text" data-key="10734"><span data-slate-leaf="true" data-offset-key="10734:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10735"><span data-slate-object="text" data-key="10736"><span data-slate-leaf="true" data-offset-key="10736:0" data-first-offset="true"><span data-slate-string="true">首先看它的定义：</span></span></span></div><div data-code-language="typescript" data-slate-type="pre" data-slate-object="block" data-key="10737"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10738"><span data-slate-object="text" data-key="10739"><span data-slate-leaf="true" data-offset-key="10739:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 关键字段说明</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10740"><span data-slate-object="text" data-key="10741"><span data-slate-leaf="true" data-offset-key="10741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//brokerId：所属 Broker 的序号，即 broker.id 值</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10742"><span data-slate-object="text" data-key="10743"><span data-slate-leaf="true" data-offset-key="10743:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//requestChannel：SocketServer 组件下的 RequestChannel 对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10744"><span data-slate-object="text" data-key="10745"><span data-slate-leaf="true" data-offset-key="10745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//api：KafkaApis 类，实际请求处理逻辑类</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10746"><span data-slate-object="text" data-key="10747"><span data-slate-leaf="true" data-offset-key="10747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//numThreads：I/O 线程池初始大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10748"><span data-slate-object="text" data-key="10749"><span data-slate-leaf="true" data-offset-key="10749:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">class</span></span></span></span><span data-slate-object="text" data-key="10750"><span data-slate-leaf="true" data-offset-key="10750:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10751"><span data-slate-leaf="true" data-offset-key="10751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaRequestHandlerPool</span></span></span></span><span data-slate-object="text" data-key="10752"><span data-slate-leaf="true" data-offset-key="10752:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10753"><span data-slate-object="text" data-key="10754"><span data-slate-leaf="true" data-offset-key="10754:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="10755"><span data-slate-leaf="true" data-offset-key="10755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">brokerId</span></span></span></span><span data-slate-object="text" data-key="10756"><span data-slate-leaf="true" data-offset-key="10756:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10757"><span data-slate-leaf="true" data-offset-key="10757:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="10758"><span data-slate-leaf="true" data-offset-key="10758:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10759"><span data-slate-object="text" data-key="10760"><span data-slate-leaf="true" data-offset-key="10760:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="10761"><span data-slate-leaf="true" data-offset-key="10761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestChannel</span></span></span></span><span data-slate-object="text" data-key="10762"><span data-slate-leaf="true" data-offset-key="10762:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10763"><span data-slate-leaf="true" data-offset-key="10763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestChannel</span></span></span></span><span data-slate-object="text" data-key="10764"><span data-slate-leaf="true" data-offset-key="10764:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10765"><span data-slate-object="text" data-key="10766"><span data-slate-leaf="true" data-offset-key="10766:0" data-first-offset="true"><span data-slate-string="true">  val </span></span></span><span data-slate-object="text" data-key="10767"><span data-slate-leaf="true" data-offset-key="10767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">apis</span></span></span></span><span data-slate-object="text" data-key="10768"><span data-slate-leaf="true" data-offset-key="10768:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10769"><span data-slate-leaf="true" data-offset-key="10769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaApis</span></span></span></span><span data-slate-object="text" data-key="10770"><span data-slate-leaf="true" data-offset-key="10770:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10771"><span data-slate-object="text" data-key="10772"><span data-slate-leaf="true" data-offset-key="10772:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10773"><span data-slate-leaf="true" data-offset-key="10773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">time</span></span></span></span><span data-slate-object="text" data-key="10774"><span data-slate-leaf="true" data-offset-key="10774:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10775"><span data-slate-leaf="true" data-offset-key="10775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Time</span></span></span></span><span data-slate-object="text" data-key="10776"><span data-slate-leaf="true" data-offset-key="10776:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10777"><span data-slate-object="text" data-key="10778"><span data-slate-leaf="true" data-offset-key="10778:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10779"><span data-slate-leaf="true" data-offset-key="10779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">numThreads</span></span></span></span><span data-slate-object="text" data-key="10780"><span data-slate-leaf="true" data-offset-key="10780:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10781"><span data-slate-leaf="true" data-offset-key="10781:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Int</span></span></span></span><span data-slate-object="text" data-key="10782"><span data-slate-leaf="true" data-offset-key="10782:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10783"><span data-slate-object="text" data-key="10784"><span data-slate-leaf="true" data-offset-key="10784:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10785"><span data-slate-leaf="true" data-offset-key="10785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">requestHandlerAvgIdleMetricName</span></span></span></span><span data-slate-object="text" data-key="10786"><span data-slate-leaf="true" data-offset-key="10786:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10787"><span data-slate-leaf="true" data-offset-key="10787:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="10788"><span data-slate-leaf="true" data-offset-key="10788:0" data-first-offset="true"><span data-slate-string="true">,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10789"><span data-slate-object="text" data-key="10790"><span data-slate-leaf="true" data-offset-key="10790:0" data-first-offset="true"><span data-slate-string="true">  logAndThreadNamePrefix : </span></span></span><span data-slate-object="text" data-key="10791"><span data-slate-leaf="true" data-offset-key="10791:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">String</span></span></span></span><span data-slate-object="text" data-key="10792"><span data-slate-leaf="true" data-offset-key="10792:0" data-first-offset="true"><span data-slate-string="true">) </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10793"><span data-slate-object="text" data-key="10794"><span data-slate-leaf="true" data-offset-key="10794:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10795"><span data-slate-leaf="true" data-offset-key="10795:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">extends</span></span></span></span><span data-slate-object="text" data-key="10796"><span data-slate-leaf="true" data-offset-key="10796:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10797"><span data-slate-leaf="true" data-offset-key="10797:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Logging</span></span></span></span><span data-slate-object="text" data-key="10798"><span data-slate-leaf="true" data-offset-key="10798:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10799"><span data-slate-leaf="true" data-offset-key="10799:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">with</span></span></span></span><span data-slate-object="text" data-key="10800"><span data-slate-leaf="true" data-offset-key="10800:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10801"><span data-slate-leaf="true" data-offset-key="10801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaMetricsGroup</span></span></span></span><span data-slate-object="text" data-key="10802"><span data-slate-leaf="true" data-offset-key="10802:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10803"><span data-slate-object="text" data-key="10804"><span data-slate-leaf="true" data-offset-key="10804:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10805"><span data-slate-leaf="true" data-offset-key="10805:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// I/O 线程池大小</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10806"><span data-slate-object="text" data-key="10807"><span data-slate-leaf="true" data-offset-key="10807:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10808"><span data-slate-leaf="true" data-offset-key="10808:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="10809"><span data-slate-leaf="true" data-offset-key="10809:0" data-first-offset="true"><span data-slate-string="true"> val </span></span></span><span data-slate-object="text" data-key="10810"><span data-slate-leaf="true" data-offset-key="10810:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">threadPoolSize</span></span></span></span><span data-slate-object="text" data-key="10811"><span data-slate-leaf="true" data-offset-key="10811:0" data-first-offset="true"><span data-slate-string="true">: </span></span></span><span data-slate-object="text" data-key="10812"><span data-slate-leaf="true" data-offset-key="10812:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AtomicInteger</span></span></span></span><span data-slate-object="text" data-key="10813"><span data-slate-leaf="true" data-offset-key="10813:0" data-first-offset="true"><span data-slate-string="true"> = </span></span></span><span data-slate-object="text" data-key="10814"><span data-slate-leaf="true" data-offset-key="10814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10815"><span data-slate-leaf="true" data-offset-key="10815:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10816"><span data-slate-leaf="true" data-offset-key="10816:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">AtomicInteger</span></span></span></span><span data-slate-object="text" data-key="10817"><span data-slate-leaf="true" data-offset-key="10817:0" data-first-offset="true"><span data-slate-string="true">(numThreads)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10818"><span data-slate-object="text" data-key="10819"><span data-slate-leaf="true" data-offset-key="10819:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10820"><span data-slate-leaf="true" data-offset-key="10820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// I/O 线程池</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10821"><span data-slate-object="text" data-key="10822"><span data-slate-leaf="true" data-offset-key="10822:0" data-first-offset="true"><span data-slate-string="true">  val runnables = </span></span></span><span data-slate-object="text" data-key="10823"><span data-slate-leaf="true" data-offset-key="10823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10824"><span data-slate-leaf="true" data-offset-key="10824:0" data-first-offset="true"><span data-slate-string="true"> mutable.</span></span></span><span data-slate-object="text" data-key="10825"><span data-slate-leaf="true" data-offset-key="10825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ArrayBuffer</span></span></span></span><span data-slate-object="text" data-key="10826"><span data-slate-leaf="true" data-offset-key="10826:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="10827"><span data-slate-leaf="true" data-offset-key="10827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaRequestHandler</span></span></span></span><span data-slate-object="text" data-key="10828"><span data-slate-leaf="true" data-offset-key="10828:0" data-first-offset="true"><span data-slate-string="true">](numThreads)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10829"><span data-slate-object="text" data-key="10830"><span data-slate-leaf="true" data-offset-key="10830:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10831"><span data-slate-object="text" data-key="10832"><span data-slate-leaf="true" data-offset-key="10832:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10833"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10834"><span data-slate-object="text" data-key="10835"><span data-slate-leaf="true" data-offset-key="10835:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandlerPool 对象定义了 7 个属性，其中比较关键的有 4 个，我分别来解释下。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10836"><div data-slate-type="list-line" data-slate-object="block" data-key="10837"><span data-slate-object="text" data-key="10838"><span data-slate-leaf="true" data-offset-key="10838:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">brokerId</span></span></span></span><span data-slate-object="text" data-key="10839"><span data-slate-leaf="true" data-offset-key="10839:0" data-first-offset="true"><span data-slate-string="true">：和 KafkaRequestHandler 中的一样，保存 Broker 的序号。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10840"><span data-slate-object="text" data-key="10841"><span data-slate-leaf="true" data-offset-key="10841:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">requestChannel</span></span></span></span><span data-slate-object="text" data-key="10842"><span data-slate-leaf="true" data-offset-key="10842:0" data-first-offset="true"><span data-slate-string="true">：SocketServer 的请求处理通道，它下辖的请求队列为所有 I/O 线程所共享。requestChannel 字段也是 KafkaRequestHandler 类的一个重要属性。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10843"><span data-slate-object="text" data-key="10844"><span data-slate-leaf="true" data-offset-key="10844:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">apis</span></span></span></span><span data-slate-object="text" data-key="10845"><span data-slate-leaf="true" data-offset-key="10845:0" data-first-offset="true"><span data-slate-string="true">：KafkaApis 实例，执行实际的请求处理逻辑。它同时也是 KafkaRequestHandler 类的一个重要属性。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="10846"><span data-slate-object="text" data-key="10847"><span data-slate-leaf="true" data-offset-key="10847:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">numThreads</span></span></span></span><span data-slate-object="text" data-key="10848"><span data-slate-leaf="true" data-offset-key="10848:0" data-first-offset="true"><span data-slate-string="true">：线程池中的初始线程数量。它是 Broker 端参数 num.io.threads 的值。目前，Kafka 支持动态修改 I/O 线程池的大小，因此，这里的 numThreads 是初始线程数，调整后的 I/O 线程池的实际大小可以和 numThreads 不一致。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10849"><span data-slate-object="text" data-key="10850"><span data-slate-leaf="true" data-offset-key="10850:0" data-first-offset="true"><span data-slate-string="true">这里我再详细解释一下 numThreads 属性和实际线程池中线程数的关系。就像我刚刚说过的，I/O 线程池的大小是可以修改的。如果你查看 KafkaServer.scala 中的 startup 方法，你会看到以下这两行代码：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="10851"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10852"><span data-slate-object="text" data-key="10853"><span data-slate-leaf="true" data-offset-key="10853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// KafkaServer.scala</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10854"><span data-slate-object="text" data-key="10855"><span data-slate-leaf="true" data-offset-key="10855:0" data-first-offset="true"><span data-slate-string="true">dataPlaneRequestHandlerPool = </span></span></span><span data-slate-object="text" data-key="10856"><span data-slate-leaf="true" data-offset-key="10856:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10857"><span data-slate-leaf="true" data-offset-key="10857:0" data-first-offset="true"><span data-slate-string="true"> KafkaRequestHandlerPool(config.brokerId, socketServer.dataPlaneRequestChannel, dataPlaneRequestProcessor, time, config.numIoThreads, s</span></span></span><span data-slate-object="text" data-key="10858"><span data-slate-leaf="true" data-offset-key="10858:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="10859"><span data-slate-leaf="true" data-offset-key="10859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${SocketServer.DataPlaneMetricPrefix}</span></span></span></span></span><span data-slate-object="text" data-key="10860"><span data-slate-leaf="true" data-offset-key="10860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestHandlerAvgIdlePercent"</span></span></span></span><span data-slate-object="text" data-key="10861"><span data-slate-leaf="true" data-offset-key="10861:0" data-first-offset="true"><span data-slate-string="true">, SocketServer.DataPlaneThreadPrefix)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10862"></div><div data-slate-type="code-line" data-slate-object="block" data-key="10863"><span data-slate-object="text" data-key="10864"><span data-slate-leaf="true" data-offset-key="10864:0" data-first-offset="true"><span data-slate-string="true">controlPlaneRequestHandlerPool = </span></span></span><span data-slate-object="text" data-key="10865"><span data-slate-leaf="true" data-offset-key="10865:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10866"><span data-slate-leaf="true" data-offset-key="10866:0" data-first-offset="true"><span data-slate-string="true"> KafkaRequestHandlerPool(config.brokerId, socketServer.controlPlaneRequestChannelOpt.</span></span></span><span data-slate-object="text" data-key="10867"><span data-slate-leaf="true" data-offset-key="10867:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">get</span></span></span></span><span data-slate-object="text" data-key="10868"><span data-slate-leaf="true" data-offset-key="10868:0" data-first-offset="true"><span data-slate-string="true">, controlPlaneRequestProcessor, time, </span></span></span><span data-slate-object="text" data-key="10869"><span data-slate-leaf="true" data-offset-key="10869:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="10870"><span data-slate-leaf="true" data-offset-key="10870:0" data-first-offset="true"><span data-slate-string="true">, s</span></span></span><span data-slate-object="text" data-key="10871"><span data-slate-leaf="true" data-offset-key="10871:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"</span></span></span></span><span data-slate-object="text" data-key="10872"><span data-slate-leaf="true" data-offset-key="10872:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">${SocketServer.ControlPlaneMetricPrefix}</span></span></span></span></span><span data-slate-object="text" data-key="10873"><span data-slate-leaf="true" data-offset-key="10873:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestHandlerAvgIdlePercent"</span></span></span></span><span data-slate-object="text" data-key="10874"><span data-slate-leaf="true" data-offset-key="10874:0" data-first-offset="true"><span data-slate-string="true">, SocketServer.ControlPlaneThreadPrefix)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10875"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10876"><span data-slate-object="text" data-key="10877"><span data-slate-leaf="true" data-offset-key="10877:0" data-first-offset="true"><span data-slate-string="true">由代码可知，Data plane 所属的 KafkaRequestHandlerPool 线程池的初始数量，就是 Broker 端的参数 nums.io.threads，即这里的 config.numIoThreads 值；而用于 Control plane 的线程池的数量，则硬编码为 1。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10878"><span data-slate-object="text" data-key="10879"><span data-slate-leaf="true" data-offset-key="10879:0" data-first-offset="true"><span data-slate-string="true">因此，你可以发现，Broker 端参数 num.io.threads 的值控制的是 Broker 启动时 KafkaRequestHandler 线程的数量。因此，</span></span></span><span data-slate-object="text" data-key="10880"><span data-slate-leaf="true" data-offset-key="10880:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">当你想要在一开始就提升 Broker 端请求处理能力的时候，不妨试着增加这个参数值</span></span></span></span><span data-slate-object="text" data-key="10881"><span data-slate-leaf="true" data-offset-key="10881:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10882"><span data-slate-object="text" data-key="10883"><span data-slate-leaf="true" data-offset-key="10883:0" data-first-offset="true"><span data-slate-string="true">除了上面那 4 个属性，该类还定义了一个 threadPoolSize 变量。本质上，它就是用 AtomicInteger 包了一层 numThreads 罢了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10884"><span data-slate-object="text" data-key="10885"><span data-slate-leaf="true" data-offset-key="10885:0" data-first-offset="true"><span data-slate-string="true">为什么要这么做呢？这是因为，目前 Kafka 支持动态调整 KafkaRequestHandlerPool 线程池的线程数量，但类定义中的 numThreads 一旦传入，就不可变更了，因此，需要单独创建一个支持更新操作的线程池数量的变量。至于为什么使用 AtomicInteger，你应该可以想到，这是为了保证多线程访问的线程安全性。毕竟，这个线程池大小的属性可能被多个线程访问到，而 AtomicInteger 本身提供的原子操作，能够有效地确保这种并发访问，同时还能提供必要的内存可见性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10886"><span data-slate-object="text" data-key="10887"><span data-slate-leaf="true" data-offset-key="10887:0" data-first-offset="true"><span data-slate-string="true">既然是管理 I/O 线程池的类，KafkaRequestHandlerPool 中最重要的字段当属线程池字段 runnables 了。就代码而言，Kafka 选择使用 Scala 的数组对象类实现 I/O 线程池。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10888"><span data-slate-object="text" data-key="10889"><span data-slate-leaf="true" data-offset-key="10889:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">createHandler 方法</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10890"><span data-slate-object="text" data-key="10891"><span data-slate-leaf="true" data-offset-key="10891:0" data-first-offset="true"><span data-slate-string="true">当线程池初始化时，Kafka 使用下面这段代码批量创建线程，并将它们添加到线程池中：</span></span></span></div><div data-code-language="cpp" data-slate-type="pre" data-slate-object="block" data-key="10892"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10893"><span data-slate-object="text" data-key="10894"><span data-slate-leaf="true" data-offset-key="10894:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10895"><span data-slate-leaf="true" data-offset-key="10895:0" data-first-offset="true"><span data-slate-string="true"> (i &lt;- </span></span></span><span data-slate-object="text" data-key="10896"><span data-slate-leaf="true" data-offset-key="10896:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="10897"><span data-slate-leaf="true" data-offset-key="10897:0" data-first-offset="true"><span data-slate-string="true"> until numThreads) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10898"><span data-slate-object="text" data-key="10899"><span data-slate-leaf="true" data-offset-key="10899:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10900"><span data-slate-leaf="true" data-offset-key="10900:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">createHandler</span></span></span></span><span data-slate-object="text" data-key="10901"><span data-slate-leaf="true" data-offset-key="10901:0" data-first-offset="true"><span data-slate-string="true">(i) </span></span></span><span data-slate-object="text" data-key="10902"><span data-slate-leaf="true" data-offset-key="10902:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建 numThreads 个 I/O 线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10903"><span data-slate-object="text" data-key="10904"><span data-slate-leaf="true" data-offset-key="10904:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10905"><span data-slate-object="text" data-key="10906"><span data-slate-leaf="true" data-offset-key="10906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建序号为指定 id 的 I/O 线程对象，并启动该线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10907"><span data-slate-object="text" data-key="10908"><span data-slate-leaf="true" data-offset-key="10908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">def </span></span></span></span><span data-slate-object="text" data-key="10909"><span data-slate-leaf="true" data-offset-key="10909:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">createHandler</span></span></span></span></span><span data-slate-object="text" data-key="10910"><span data-slate-leaf="true" data-offset-key="10910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(id: Int)</span></span></span></span></span><span data-slate-object="text" data-key="10911"><span data-slate-leaf="true" data-offset-key="10911:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">: Unit =</span></span></span></span><span data-slate-object="text" data-key="10912"><span data-slate-leaf="true" data-offset-key="10912:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10913"><span data-slate-leaf="true" data-offset-key="10913:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="10914"><span data-slate-leaf="true" data-offset-key="10914:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10915"><span data-slate-object="text" data-key="10916"><span data-slate-leaf="true" data-offset-key="10916:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10917"><span data-slate-leaf="true" data-offset-key="10917:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 创建 KafkaRequestHandler 实例并加入到 runnables 中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10918"><span data-slate-object="text" data-key="10919"><span data-slate-leaf="true" data-offset-key="10919:0" data-first-offset="true"><span data-slate-string="true">  runnables += </span></span></span><span data-slate-object="text" data-key="10920"><span data-slate-leaf="true" data-offset-key="10920:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="10921"><span data-slate-leaf="true" data-offset-key="10921:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10922"><span data-slate-leaf="true" data-offset-key="10922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">KafkaRequestHandler</span></span></span></span><span data-slate-object="text" data-key="10923"><span data-slate-leaf="true" data-offset-key="10923:0" data-first-offset="true"><span data-slate-string="true">(id, brokerId, aggregateIdleMeter, threadPoolSize, requestChannel, apis, time)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10924"><span data-slate-object="text" data-key="10925"><span data-slate-leaf="true" data-offset-key="10925:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10926"><span data-slate-leaf="true" data-offset-key="10926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 启动 KafkaRequestHandler 线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10927"><span data-slate-object="text" data-key="10928"><span data-slate-leaf="true" data-offset-key="10928:0" data-first-offset="true"><span data-slate-string="true">  KafkaThread.</span></span></span><span data-slate-object="text" data-key="10929"><span data-slate-leaf="true" data-offset-key="10929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">daemon</span></span></span></span><span data-slate-object="text" data-key="10930"><span data-slate-leaf="true" data-offset-key="10930:0" data-first-offset="true"><span data-slate-string="true">(logAndThreadNamePrefix + </span></span></span><span data-slate-object="text" data-key="10931"><span data-slate-leaf="true" data-offset-key="10931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"-kafka-request-handler-"</span></span></span></span><span data-slate-object="text" data-key="10932"><span data-slate-leaf="true" data-offset-key="10932:0" data-first-offset="true"><span data-slate-string="true"> + id, </span></span></span><span data-slate-object="text" data-key="10933"><span data-slate-leaf="true" data-offset-key="10933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">runnables</span></span></span></span><span data-slate-object="text" data-key="10934"><span data-slate-leaf="true" data-offset-key="10934:0" data-first-offset="true"><span data-slate-string="true">(id)).</span></span></span><span data-slate-object="text" data-key="10935"><span data-slate-leaf="true" data-offset-key="10935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">start</span></span></span></span><span data-slate-object="text" data-key="10936"><span data-slate-leaf="true" data-offset-key="10936:0" data-first-offset="true"><span data-slate-string="true">()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10937"><span data-slate-object="text" data-key="10938"><span data-slate-leaf="true" data-offset-key="10938:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10939"><span data-slate-object="text" data-key="10940"><span data-slate-leaf="true" data-offset-key="10940:0" data-first-offset="true"><span data-slate-string="true">我来解释下这段代码。源码使用 for 循环批量调用 createHandler 方法，创建多个 I/O 线程。createHandler 方法的主体逻辑分为三步：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="10941"><div data-slate-type="list-line" data-slate-object="block" data-key="10942"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="10943"><span data-slate-leaf="true" data-offset-key="10943:0" data-first-offset="true"><span data-slate-string="true">创建 KafkaRequestHandler 实例；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="10944"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="10945"><span data-slate-leaf="true" data-offset-key="10945:0" data-first-offset="true"><span data-slate-string="true">将创建的线程实例加入到线程池数组；</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="10946"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="10947"><span data-slate-leaf="true" data-offset-key="10947:0" data-first-offset="true"><span data-slate-string="true">启动该线程。</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10948"><span data-slate-object="text" data-key="10949"><span data-slate-leaf="true" data-offset-key="10949:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">resizeThreadPool 方法</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="10950"><span data-slate-object="text" data-key="10951"><span data-slate-leaf="true" data-offset-key="10951:0" data-first-offset="true"><span data-slate-string="true">下面我们说说 resizeThreadPool 方法的代码。这个方法的目的是，</span></span></span><span data-slate-object="text" data-key="10952"><span data-slate-leaf="true" data-offset-key="10952:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">把 I/O 线程池的线程数重设为指定的数值</span></span></span></span><span data-slate-object="text" data-key="10953"><span data-slate-leaf="true" data-offset-key="10953:0" data-first-offset="true"><span data-slate-string="true">。代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="10954"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="10955"><span data-slate-object="text" data-key="10956"><span data-slate-leaf="true" data-offset-key="10956:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="10957"><span data-slate-leaf="true" data-offset-key="10957:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">resizeThreadPool</span></span></span></span><span data-slate-object="text" data-key="10958"><span data-slate-leaf="true" data-offset-key="10958:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(newSize: Int)</span></span></span></span><span data-slate-object="text" data-key="10959"><span data-slate-leaf="true" data-offset-key="10959:0" data-first-offset="true"><span data-slate-string="true">: Unit = </span></span></span><span data-slate-object="text" data-key="10960"><span data-slate-leaf="true" data-offset-key="10960:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="10961"><span data-slate-leaf="true" data-offset-key="10961:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10962"><span data-slate-object="text" data-key="10963"><span data-slate-leaf="true" data-offset-key="10963:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10964"><span data-slate-leaf="true" data-offset-key="10964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="10965"><span data-slate-leaf="true" data-offset-key="10965:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10966"><span data-slate-leaf="true" data-offset-key="10966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">currentSize</span></span></span></span><span data-slate-object="text" data-key="10967"><span data-slate-leaf="true" data-offset-key="10967:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10968"><span data-slate-leaf="true" data-offset-key="10968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="10969"><span data-slate-leaf="true" data-offset-key="10969:0" data-first-offset="true"><span data-slate-string="true"> threadPoolSize.get</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10970"><span data-slate-object="text" data-key="10971"><span data-slate-leaf="true" data-offset-key="10971:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10972"><span data-slate-leaf="true" data-offset-key="10972:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">info</span></span></span></span><span data-slate-object="text" data-key="10973"><span data-slate-leaf="true" data-offset-key="10973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(s</span></span></span></span><span data-slate-object="text" data-key="10974"><span data-slate-leaf="true" data-offset-key="10974:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Resizing request handler thread pool size from $currentSize to $newSize"</span></span></span></span></span><span data-slate-object="text" data-key="10975"><span data-slate-leaf="true" data-offset-key="10975:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10976"><span data-slate-object="text" data-key="10977"><span data-slate-leaf="true" data-offset-key="10977:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="10978"><span data-slate-leaf="true" data-offset-key="10978:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10979"><span data-slate-leaf="true" data-offset-key="10979:0" data-first-offset="true"><span data-slate-string="true"> (newSize&gt; currentSize) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10980"><span data-slate-object="text" data-key="10981"><span data-slate-leaf="true" data-offset-key="10981:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10982"><span data-slate-leaf="true" data-offset-key="10982:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10983"><span data-slate-leaf="true" data-offset-key="10983:0" data-first-offset="true"><span data-slate-string="true"> (i &lt;- currentSize until newSize) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10984"><span data-slate-object="text" data-key="10985"><span data-slate-leaf="true" data-offset-key="10985:0" data-first-offset="true"><span data-slate-string="true">      createHandler(i)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10986"><span data-slate-object="text" data-key="10987"><span data-slate-leaf="true" data-offset-key="10987:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10988"><span data-slate-object="text" data-key="10989"><span data-slate-leaf="true" data-offset-key="10989:0" data-first-offset="true"><span data-slate-string="true">  } </span></span></span><span data-slate-object="text" data-key="10990"><span data-slate-leaf="true" data-offset-key="10990:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="10991"><span data-slate-leaf="true" data-offset-key="10991:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="10992"><span data-slate-leaf="true" data-offset-key="10992:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="10993"><span data-slate-leaf="true" data-offset-key="10993:0" data-first-offset="true"><span data-slate-string="true"> (newSize &lt; currentSize) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="10994"><span data-slate-object="text" data-key="10995"><span data-slate-leaf="true" data-offset-key="10995:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="10996"><span data-slate-leaf="true" data-offset-key="10996:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="10997"><span data-slate-leaf="true" data-offset-key="10997:0" data-first-offset="true"><span data-slate-string="true"> (i &lt;- </span></span></span><span data-slate-object="text" data-key="10998"><span data-slate-leaf="true" data-offset-key="10998:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="10999"><span data-slate-leaf="true" data-offset-key="10999:0" data-first-offset="true"><span data-slate-string="true"> to (currentSize - newSize)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11000"><span data-slate-object="text" data-key="11001"><span data-slate-leaf="true" data-offset-key="11001:0" data-first-offset="true"><span data-slate-string="true">      runnables.remove(currentSize - i).stop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11002"><span data-slate-object="text" data-key="11003"><span data-slate-leaf="true" data-offset-key="11003:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11004"><span data-slate-object="text" data-key="11005"><span data-slate-leaf="true" data-offset-key="11005:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11006"><span data-slate-object="text" data-key="11007"><span data-slate-leaf="true" data-offset-key="11007:0" data-first-offset="true"><span data-slate-string="true">  threadPoolSize.set(newSize)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11008"><span data-slate-object="text" data-key="11009"><span data-slate-leaf="true" data-offset-key="11009:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11010"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11011"><span data-slate-object="text" data-key="11012"><span data-slate-leaf="true" data-offset-key="11012:0" data-first-offset="true"><span data-slate-string="true">该方法首先获取当前线程数量。如果目标数量比当前数量大，就利用刚才说到的 createHandler 方法将线程数补齐到目标值 newSize；否则的话，就将多余的线程从线程池中移除，并停止它们。最后，把标识线程数量的变量 threadPoolSize 的值调整为目标值 newSize。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11013"><span data-slate-object="text" data-key="11014"><span data-slate-leaf="true" data-offset-key="11014:0" data-first-offset="true"><span data-slate-string="true">至此，KafkaRequestHandlerPool 类的 3 个方法 shutdown、createHandler 和 resizeThreadPool 我们就学完了。总体而言，它就是负责管理 I/O 线程池的类。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11015" id="sr-toc-4"><span data-slate-object="text" data-key="11016"><span data-slate-leaf="true" data-offset-key="11016:0" data-first-offset="true"><span data-slate-string="true">全处理流程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11017"><span data-slate-object="text" data-key="11018"><span data-slate-leaf="true" data-offset-key="11018:0" data-first-offset="true"><span data-slate-string="true">有了上面的这些铺垫，我们就可以来学习下 Kafka 请求处理全流程的代码路径了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11019"><span data-slate-object="text" data-key="11020"><span data-slate-leaf="true" data-offset-key="11020:0" data-first-offset="true"><span data-slate-string="true">我们再来看一下</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="11021"><span data-slate-object="text" data-key="11022"><span data-slate-leaf="true" data-offset-key="11022:0" data-first-offset="true"><span data-slate-string="true">第 7 讲</span></span></span></a><span data-slate-object="text" data-key="11023"><span data-slate-leaf="true" data-offset-key="11023:0" data-first-offset="true"><span data-slate-string="true">里的这张图。上一次，我主要是想借助它，让你对网络线程池有个整体的了解，今天，我来具体给你讲解下，这张图所展示的完整请求处理逻辑。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="11024"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/52/e8/52c3226ad4736751b4b1ccfcb2a09ee8.jpg?wh=2079*2053"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11025"><span data-slate-object="text" data-key="11026"><span data-slate-leaf="true" data-offset-key="11026:0" data-first-offset="true"><span data-slate-string="true">图中一共有 6 步。我分别解释一下，同时还会带你去找寻对应的源码。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11027" id="sr-toc-5"><span data-slate-object="text" data-key="11028"><span data-slate-leaf="true" data-offset-key="11028:0" data-first-offset="true"><span data-slate-string="true">第 1 步：Clients 或其他 Broker 发送请求给 Acceptor 线程</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11029"><span data-slate-object="text" data-key="11030"><span data-slate-leaf="true" data-offset-key="11030:0" data-first-offset="true"><span data-slate-string="true">我在第 7 节课讲过，Acceptor 线程实时接收来自外部的发送请求。一旦接收到了之后，就会创建对应的 Socket 通道，就像下面这段代码所示：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="11031"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11032"><span data-slate-object="text" data-key="11033"><span data-slate-leaf="true" data-offset-key="11033:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// SocketServer.scala 中 Acceptor 的 run 方法片段</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11034"><span data-slate-object="text" data-key="11035"><span data-slate-leaf="true" data-offset-key="11035:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读取底层通道上准备就绪 I/O 操作的数量</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11036"><span data-slate-object="text" data-key="11037"><span data-slate-leaf="true" data-offset-key="11037:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11038"><span data-slate-leaf="true" data-offset-key="11038:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11039"><span data-slate-leaf="true" data-offset-key="11039:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">ready</span></span></span></span><span data-slate-object="text" data-key="11040"><span data-slate-leaf="true" data-offset-key="11040:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11041"><span data-slate-leaf="true" data-offset-key="11041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11042"><span data-slate-leaf="true" data-offset-key="11042:0" data-first-offset="true"><span data-slate-string="true"> nioSelector.select(</span></span></span><span data-slate-object="text" data-key="11043"><span data-slate-leaf="true" data-offset-key="11043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="11044"><span data-slate-leaf="true" data-offset-key="11044:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11045"><span data-slate-object="text" data-key="11046"><span data-slate-leaf="true" data-offset-key="11046:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果存在准备就绪的 I/O 事件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11047"><span data-slate-object="text" data-key="11048"><span data-slate-leaf="true" data-offset-key="11048:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11049"><span data-slate-leaf="true" data-offset-key="11049:0" data-first-offset="true"><span data-slate-string="true"> (ready&gt; </span></span></span><span data-slate-object="text" data-key="11050"><span data-slate-leaf="true" data-offset-key="11050:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11051"><span data-slate-leaf="true" data-offset-key="11051:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11052"><span data-slate-object="text" data-key="11053"><span data-slate-leaf="true" data-offset-key="11053:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11054"><span data-slate-leaf="true" data-offset-key="11054:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 获取对应的 SelectionKey 集合</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11055"><span data-slate-object="text" data-key="11056"><span data-slate-leaf="true" data-offset-key="11056:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11057"><span data-slate-leaf="true" data-offset-key="11057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11058"><span data-slate-leaf="true" data-offset-key="11058:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11059"><span data-slate-leaf="true" data-offset-key="11059:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">keys</span></span></span></span><span data-slate-object="text" data-key="11060"><span data-slate-leaf="true" data-offset-key="11060:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11061"><span data-slate-leaf="true" data-offset-key="11061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11062"><span data-slate-leaf="true" data-offset-key="11062:0" data-first-offset="true"><span data-slate-string="true"> nioSelector.selectedKeys()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11063"><span data-slate-object="text" data-key="11064"><span data-slate-leaf="true" data-offset-key="11064:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11065"><span data-slate-leaf="true" data-offset-key="11065:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11066"><span data-slate-leaf="true" data-offset-key="11066:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11067"><span data-slate-leaf="true" data-offset-key="11067:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">iter</span></span></span></span><span data-slate-object="text" data-key="11068"><span data-slate-leaf="true" data-offset-key="11068:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11069"><span data-slate-leaf="true" data-offset-key="11069:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11070"><span data-slate-leaf="true" data-offset-key="11070:0" data-first-offset="true"><span data-slate-string="true"> keys.iterator()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11071"><span data-slate-object="text" data-key="11072"><span data-slate-leaf="true" data-offset-key="11072:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11073"><span data-slate-leaf="true" data-offset-key="11073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 遍历这些 SelectionKey</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11074"><span data-slate-object="text" data-key="11075"><span data-slate-leaf="true" data-offset-key="11075:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11076"><span data-slate-leaf="true" data-offset-key="11076:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="11077"><span data-slate-leaf="true" data-offset-key="11077:0" data-first-offset="true"><span data-slate-string="true"> (iter.hasNext &amp;&amp; isRunning) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11078"><span data-slate-object="text" data-key="11079"><span data-slate-leaf="true" data-offset-key="11079:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11080"><span data-slate-leaf="true" data-offset-key="11080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="11081"><span data-slate-leaf="true" data-offset-key="11081:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11082"><span data-slate-object="text" data-key="11083"><span data-slate-leaf="true" data-offset-key="11083:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11084"><span data-slate-leaf="true" data-offset-key="11084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11085"><span data-slate-leaf="true" data-offset-key="11085:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11086"><span data-slate-leaf="true" data-offset-key="11086:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">key</span></span></span></span><span data-slate-object="text" data-key="11087"><span data-slate-leaf="true" data-offset-key="11087:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11088"><span data-slate-leaf="true" data-offset-key="11088:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11089"><span data-slate-leaf="true" data-offset-key="11089:0" data-first-offset="true"><span data-slate-string="true"> iter.next</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11090"><span data-slate-object="text" data-key="11091"><span data-slate-leaf="true" data-offset-key="11091:0" data-first-offset="true"><span data-slate-string="true">      iter.remove()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11092"><span data-slate-object="text" data-key="11093"><span data-slate-leaf="true" data-offset-key="11093:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11094"><span data-slate-leaf="true" data-offset-key="11094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 测试 SelectionKey 的底层通道是否能够接受新 Socket 连接</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11095"><span data-slate-object="text" data-key="11096"><span data-slate-leaf="true" data-offset-key="11096:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11097"><span data-slate-leaf="true" data-offset-key="11097:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11098"><span data-slate-leaf="true" data-offset-key="11098:0" data-first-offset="true"><span data-slate-string="true"> (key.isAcceptable) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11099"><span data-slate-object="text" data-key="11100"><span data-slate-leaf="true" data-offset-key="11100:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11101"><span data-slate-leaf="true" data-offset-key="11101:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 接受此连接并分配对应的 Processor 线程</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11102"><span data-slate-object="text" data-key="11103"><span data-slate-leaf="true" data-offset-key="11103:0" data-first-offset="true"><span data-slate-string="true">        accept(key).foreach { socketChannel =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11104"><span data-slate-object="text" data-key="11105"><span data-slate-leaf="true" data-offset-key="11105:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="11106"><span data-slate-leaf="true" data-offset-key="11106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="11107"><span data-slate-leaf="true" data-offset-key="11107:0" data-first-offset="true"><span data-slate-string="true"> processor: Processor = </span></span></span><span data-slate-object="text" data-key="11108"><span data-slate-leaf="true" data-offset-key="11108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11109"><span data-slate-object="text" data-key="11110"><span data-slate-leaf="true" data-offset-key="11110:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="11111"><span data-slate-leaf="true" data-offset-key="11111:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">do</span></span></span></span><span data-slate-object="text" data-key="11112"><span data-slate-leaf="true" data-offset-key="11112:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11113"><span data-slate-object="text" data-key="11114"><span data-slate-leaf="true" data-offset-key="11114:0" data-first-offset="true"><span data-slate-string="true">            retriesLeft -= </span></span></span><span data-slate-object="text" data-key="11115"><span data-slate-leaf="true" data-offset-key="11115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11116"><span data-slate-object="text" data-key="11117"><span data-slate-leaf="true" data-offset-key="11117:0" data-first-offset="true"><span data-slate-string="true">            processor = </span></span></span><span data-slate-object="text" data-key="11118"><span data-slate-leaf="true" data-offset-key="11118:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">synchronized</span></span></span></span><span data-slate-object="text" data-key="11119"><span data-slate-leaf="true" data-offset-key="11119:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11120"><span data-slate-object="text" data-key="11121"><span data-slate-leaf="true" data-offset-key="11121:0" data-first-offset="true"><span data-slate-string="true">              currentProcessorIndex = currentProcessorIndex % processors.length</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11122"><span data-slate-object="text" data-key="11123"><span data-slate-leaf="true" data-offset-key="11123:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="11124"><span data-slate-leaf="true" data-offset-key="11124:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processors</span></span></span></span><span data-slate-object="text" data-key="11125"><span data-slate-leaf="true" data-offset-key="11125:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(currentProcessorIndex)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11126"><span data-slate-object="text" data-key="11127"><span data-slate-leaf="true" data-offset-key="11127:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11128"><span data-slate-object="text" data-key="11129"><span data-slate-leaf="true" data-offset-key="11129:0" data-first-offset="true"><span data-slate-string="true">            currentProcessorIndex += </span></span></span><span data-slate-object="text" data-key="11130"><span data-slate-leaf="true" data-offset-key="11130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11131"><span data-slate-object="text" data-key="11132"><span data-slate-leaf="true" data-offset-key="11132:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="11133"><span data-slate-leaf="true" data-offset-key="11133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将新 Socket 连接加入到 Processor 线程待处理连接队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11134"><span data-slate-object="text" data-key="11135"><span data-slate-leaf="true" data-offset-key="11135:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="11136"><span data-slate-leaf="true" data-offset-key="11136:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 等待 Processor 线程后续处理</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11137"><span data-slate-object="text" data-key="11138"><span data-slate-leaf="true" data-offset-key="11138:0" data-first-offset="true"><span data-slate-string="true">          } </span></span></span><span data-slate-object="text" data-key="11139"><span data-slate-leaf="true" data-offset-key="11139:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="11140"><span data-slate-leaf="true" data-offset-key="11140:0" data-first-offset="true"><span data-slate-string="true"> (!assignNewConnection(socketChannel, processor, retriesLeft == </span></span></span><span data-slate-object="text" data-key="11141"><span data-slate-leaf="true" data-offset-key="11141:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="11142"><span data-slate-leaf="true" data-offset-key="11142:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11143"><span data-slate-object="text" data-key="11144"><span data-slate-leaf="true" data-offset-key="11144:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11145"><span data-slate-object="text" data-key="11146"><span data-slate-leaf="true" data-offset-key="11146:0" data-first-offset="true"><span data-slate-string="true">      } </span></span></span><span data-slate-object="text" data-key="11147"><span data-slate-leaf="true" data-offset-key="11147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="11148"><span data-slate-leaf="true" data-offset-key="11148:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11149"><span data-slate-object="text" data-key="11150"><span data-slate-leaf="true" data-offset-key="11150:0" data-first-offset="true"><span data-slate-string="true">        ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11151"><span data-slate-object="text" data-key="11152"><span data-slate-leaf="true" data-offset-key="11152:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11153"><span data-slate-object="text" data-key="11154"><span data-slate-leaf="true" data-offset-key="11154:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11155"><span data-slate-object="text" data-key="11156"><span data-slate-leaf="true" data-offset-key="11156:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11157"><span data-slate-object="text" data-key="11158"><span data-slate-leaf="true" data-offset-key="11158:0" data-first-offset="true"><span data-slate-string="true">可以看到，Acceptor 线程通过调用 accept 方法，创建对应的 SocketChannel，然后将该 Channel 实例传给 assignNewConnection 方法，等待 Processor 线程将该 Socket 连接请求，放入到它维护的待处理连接队列中。后续 Processor 线程的 run 方法会不断地从该队列中取出这些 Socket 连接请求，然后创建对应的 Socket 连接。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11159"><span data-slate-object="text" data-key="11160"><span data-slate-leaf="true" data-offset-key="11160:0" data-first-offset="true"><span data-slate-string="true">assignNewConnection 方法的主要作用是，将这个新建的 SocketChannel 对象存入 Processors 线程的 newConnections 队列中。之后，Processor 线程会不断轮询这个队列中的待处理 Channel（可以参考第 7 讲的 configureNewConnections 方法），并向这些 Channel 注册基于 Java NIO 的 Selector，用于真正的请求获取和响应发送 I/O 操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11161"><span data-slate-object="text" data-key="11162"><span data-slate-leaf="true" data-offset-key="11162:0" data-first-offset="true"><span data-slate-string="true">严格来说，Acceptor 线程处理的这一步并非真正意义上的获取请求，仅仅是 Acceptor 线程为后续 Processor 线程获取请求铺路而已，也就是把需要用到的 Socket 通道创建出来，传给下面的 Processor 线程使用。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11163" id="sr-toc-6"><span data-slate-object="text" data-key="11164"><span data-slate-leaf="true" data-offset-key="11164:0" data-first-offset="true"><span data-slate-string="true">第 2 &amp; 3 步：Processor 线程处理请求，并放入请求队列</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11165"><span data-slate-object="text" data-key="11166"><span data-slate-leaf="true" data-offset-key="11166:0" data-first-offset="true"><span data-slate-string="true">一旦 Processor 线程成功地向 SocketChannel 注册了 Selector，Clients 端或其他 Broker 端发送的请求就能通过该 SocketChannel 被获取到，具体的方法是 Processor 的 processCompleteReceives：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="11167"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11168"><span data-slate-object="text" data-key="11169"><span data-slate-leaf="true" data-offset-key="11169:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// SocketServer.scala</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11170"><span data-slate-object="text" data-key="11171"><span data-slate-leaf="true" data-offset-key="11171:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="11172"><span data-slate-leaf="true" data-offset-key="11172:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="11173"><span data-slate-leaf="true" data-offset-key="11173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processCompletedReceives</span></span></span></span><span data-slate-object="text" data-key="11174"><span data-slate-leaf="true" data-offset-key="11174:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="11175"><span data-slate-leaf="true" data-offset-key="11175:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11176"><span data-slate-object="text" data-key="11177"><span data-slate-leaf="true" data-offset-key="11177:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11178"><span data-slate-leaf="true" data-offset-key="11178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从 Selector 中提取已接收到的所有请求数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11179"><span data-slate-object="text" data-key="11180"><span data-slate-leaf="true" data-offset-key="11180:0" data-first-offset="true"><span data-slate-string="true">    selector.completedReceives.asScala.foreach {receive =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11181"><span data-slate-object="text" data-key="11182"><span data-slate-leaf="true" data-offset-key="11182:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11183"><span data-slate-leaf="true" data-offset-key="11183:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="11184"><span data-slate-leaf="true" data-offset-key="11184:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11185"><span data-slate-object="text" data-key="11186"><span data-slate-leaf="true" data-offset-key="11186:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11187"><span data-slate-leaf="true" data-offset-key="11187:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 打开与发送方对应的 Socket Channel，如果不存在可用的 Channel，抛出异常</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11188"><span data-slate-object="text" data-key="11189"><span data-slate-leaf="true" data-offset-key="11189:0" data-first-offset="true"><span data-slate-string="true">        openOrClosingChannel(receive.source) match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11190"><span data-slate-object="text" data-key="11191"><span data-slate-leaf="true" data-offset-key="11191:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="11192"><span data-slate-leaf="true" data-offset-key="11192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="11193"><span data-slate-leaf="true" data-offset-key="11193:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11194"><span data-slate-leaf="true" data-offset-key="11194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Some</span></span></span></span><span data-slate-object="text" data-key="11195"><span data-slate-leaf="true" data-offset-key="11195:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(channel)</span></span></span></span><span data-slate-object="text" data-key="11196"><span data-slate-leaf="true" data-offset-key="11196:0" data-first-offset="true"><span data-slate-string="true"> =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11197"><span data-slate-object="text" data-key="11198"><span data-slate-leaf="true" data-offset-key="11198:0" data-first-offset="true"><span data-slate-string="true">            ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11199"><span data-slate-object="text" data-key="11200"><span data-slate-leaf="true" data-offset-key="11200:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="11201"><span data-slate-leaf="true" data-offset-key="11201:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11202"><span data-slate-leaf="true" data-offset-key="11202:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11203"><span data-slate-leaf="true" data-offset-key="11203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">header</span></span></span></span><span data-slate-object="text" data-key="11204"><span data-slate-leaf="true" data-offset-key="11204:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11205"><span data-slate-leaf="true" data-offset-key="11205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11206"><span data-slate-leaf="true" data-offset-key="11206:0" data-first-offset="true"><span data-slate-string="true"> RequestHeader.parse(receive.payload)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11207"><span data-slate-object="text" data-key="11208"><span data-slate-leaf="true" data-offset-key="11208:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="11209"><span data-slate-leaf="true" data-offset-key="11209:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11210"><span data-slate-leaf="true" data-offset-key="11210:0" data-first-offset="true"><span data-slate-string="true"> (header.apiKey == ApiKeys.SASL_HANDSHAKE &amp;&amp; channel.maybeBeginServerReauthentication(receive, nowNanosSupplier))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11211"><span data-slate-object="text" data-key="11212"><span data-slate-leaf="true" data-offset-key="11212:0" data-first-offset="true"><span data-slate-string="true">              ……</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11213"><span data-slate-object="text" data-key="11214"><span data-slate-leaf="true" data-offset-key="11214:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="11215"><span data-slate-leaf="true" data-offset-key="11215:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="11216"><span data-slate-leaf="true" data-offset-key="11216:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11217"><span data-slate-object="text" data-key="11218"><span data-slate-leaf="true" data-offset-key="11218:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="11219"><span data-slate-leaf="true" data-offset-key="11219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11220"><span data-slate-leaf="true" data-offset-key="11220:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11221"><span data-slate-leaf="true" data-offset-key="11221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nowNanos</span></span></span></span><span data-slate-object="text" data-key="11222"><span data-slate-leaf="true" data-offset-key="11222:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11223"><span data-slate-leaf="true" data-offset-key="11223:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11224"><span data-slate-leaf="true" data-offset-key="11224:0" data-first-offset="true"><span data-slate-string="true"> time.nanoseconds()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11225"><span data-slate-object="text" data-key="11226"><span data-slate-leaf="true" data-offset-key="11226:0" data-first-offset="true"><span data-slate-string="true">              </span></span></span><span data-slate-object="text" data-key="11227"><span data-slate-leaf="true" data-offset-key="11227:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11228"><span data-slate-leaf="true" data-offset-key="11228:0" data-first-offset="true"><span data-slate-string="true"> (channel.serverAuthenticationSessionExpired(nowNanos)) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11229"><span data-slate-object="text" data-key="11230"><span data-slate-leaf="true" data-offset-key="11230:0" data-first-offset="true"><span data-slate-string="true">                ……</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11231"><span data-slate-object="text" data-key="11232"><span data-slate-leaf="true" data-offset-key="11232:0" data-first-offset="true"><span data-slate-string="true">              } </span></span></span><span data-slate-object="text" data-key="11233"><span data-slate-leaf="true" data-offset-key="11233:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="11234"><span data-slate-leaf="true" data-offset-key="11234:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11235"><span data-slate-object="text" data-key="11236"><span data-slate-leaf="true" data-offset-key="11236:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="11237"><span data-slate-leaf="true" data-offset-key="11237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11238"><span data-slate-leaf="true" data-offset-key="11238:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11239"><span data-slate-leaf="true" data-offset-key="11239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">connectionId</span></span></span></span><span data-slate-object="text" data-key="11240"><span data-slate-leaf="true" data-offset-key="11240:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11241"><span data-slate-leaf="true" data-offset-key="11241:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11242"><span data-slate-leaf="true" data-offset-key="11242:0" data-first-offset="true"><span data-slate-string="true"> receive.source</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11243"><span data-slate-object="text" data-key="11244"><span data-slate-leaf="true" data-offset-key="11244:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="11245"><span data-slate-leaf="true" data-offset-key="11245:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11246"><span data-slate-leaf="true" data-offset-key="11246:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11247"><span data-slate-leaf="true" data-offset-key="11247:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">context</span></span></span></span><span data-slate-object="text" data-key="11248"><span data-slate-leaf="true" data-offset-key="11248:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11249"><span data-slate-leaf="true" data-offset-key="11249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11250"><span data-slate-leaf="true" data-offset-key="11250:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11251"><span data-slate-leaf="true" data-offset-key="11251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="11252"><span data-slate-leaf="true" data-offset-key="11252:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11253"><span data-slate-leaf="true" data-offset-key="11253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestContext</span></span></span></span><span data-slate-object="text" data-key="11254"><span data-slate-leaf="true" data-offset-key="11254:0" data-first-offset="true"><span data-slate-string="true">(header, connectionId, channel.socketAddress,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11255"><span data-slate-object="text" data-key="11256"><span data-slate-leaf="true" data-offset-key="11256:0" data-first-offset="true"><span data-slate-string="true">                  channel.principal, listenerName, securityProtocol,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11257"><span data-slate-object="text" data-key="11258"><span data-slate-leaf="true" data-offset-key="11258:0" data-first-offset="true"><span data-slate-string="true">                  channel.channelMetadataRegistry.clientInformation)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11259"><span data-slate-object="text" data-key="11260"><span data-slate-leaf="true" data-offset-key="11260:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="11261"><span data-slate-leaf="true" data-offset-key="11261:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 根据 Channel 中获取的 Receive 对象，构建 Request 对象</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11262"><span data-slate-object="text" data-key="11263"><span data-slate-leaf="true" data-offset-key="11263:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="11264"><span data-slate-leaf="true" data-offset-key="11264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11265"><span data-slate-leaf="true" data-offset-key="11265:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11266"><span data-slate-leaf="true" data-offset-key="11266:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">req</span></span></span></span><span data-slate-object="text" data-key="11267"><span data-slate-leaf="true" data-offset-key="11267:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11268"><span data-slate-leaf="true" data-offset-key="11268:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11269"><span data-slate-leaf="true" data-offset-key="11269:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11270"><span data-slate-leaf="true" data-offset-key="11270:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">new</span></span></span></span><span data-slate-object="text" data-key="11271"><span data-slate-leaf="true" data-offset-key="11271:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11272"><span data-slate-leaf="true" data-offset-key="11272:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">RequestChannel</span></span></span></span><span data-slate-object="text" data-key="11273"><span data-slate-leaf="true" data-offset-key="11273:0" data-first-offset="true"><span data-slate-string="true">.Request(processor = id, context = context,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11274"><span data-slate-object="text" data-key="11275"><span data-slate-leaf="true" data-offset-key="11275:0" data-first-offset="true"><span data-slate-string="true">                  startTimeNanos = nowNanos, memoryPool, receive.payload, requestChannel.metrics)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11276"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11277"><span data-slate-object="text" data-key="11278"><span data-slate-leaf="true" data-offset-key="11278:0" data-first-offset="true"><span data-slate-string="true">                ……</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11279"><span data-slate-object="text" data-key="11280"><span data-slate-leaf="true" data-offset-key="11280:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="11281"><span data-slate-leaf="true" data-offset-key="11281:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将该请求放入请求队列</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11282"><span data-slate-object="text" data-key="11283"><span data-slate-leaf="true" data-offset-key="11283:0" data-first-offset="true"><span data-slate-string="true">                requestChannel.sendRequest(req)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11284"><span data-slate-object="text" data-key="11285"><span data-slate-leaf="true" data-offset-key="11285:0" data-first-offset="true"><span data-slate-string="true">                ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11286"><span data-slate-object="text" data-key="11287"><span data-slate-leaf="true" data-offset-key="11287:0" data-first-offset="true"><span data-slate-string="true">              }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11288"><span data-slate-object="text" data-key="11289"><span data-slate-leaf="true" data-offset-key="11289:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11290"><span data-slate-object="text" data-key="11291"><span data-slate-leaf="true" data-offset-key="11291:0" data-first-offset="true"><span data-slate-string="true">          ……</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11292"><span data-slate-object="text" data-key="11293"><span data-slate-leaf="true" data-offset-key="11293:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11294"><span data-slate-object="text" data-key="11295"><span data-slate-leaf="true" data-offset-key="11295:0" data-first-offset="true"><span data-slate-string="true">      } </span></span></span><span data-slate-object="text" data-key="11296"><span data-slate-leaf="true" data-offset-key="11296:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">catch</span></span></span></span><span data-slate-object="text" data-key="11297"><span data-slate-leaf="true" data-offset-key="11297:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11298"><span data-slate-object="text" data-key="11299"><span data-slate-leaf="true" data-offset-key="11299:0" data-first-offset="true"><span data-slate-string="true">        ……</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11300"><span data-slate-object="text" data-key="11301"><span data-slate-leaf="true" data-offset-key="11301:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11302"><span data-slate-object="text" data-key="11303"><span data-slate-leaf="true" data-offset-key="11303:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11304"><span data-slate-object="text" data-key="11305"><span data-slate-leaf="true" data-offset-key="11305:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11306"><span data-slate-object="text" data-key="11307"><span data-slate-leaf="true" data-offset-key="11307:0" data-first-offset="true"><span data-slate-string="true">因为代码很多，我进行了精简，只保留了最关键的逻辑。该方法会将 Selector 获取到的所有 Receive 对象转换成对应的 Request 对象，然后将这些 Request 实例放置到请求队列中，就像上图中第 2、3 步展示的那样。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11308"><span data-slate-object="text" data-key="11309"><span data-slate-leaf="true" data-offset-key="11309:0" data-first-offset="true"><span data-slate-string="true">所谓的 Processor 线程处理请求，就是指它从底层 I/O 获取到发送数据，将其转换成 Request 对象实例，并最终添加到请求队列的过程。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11310" id="sr-toc-7"><span data-slate-object="text" data-key="11311"><span data-slate-leaf="true" data-offset-key="11311:0" data-first-offset="true"><span data-slate-string="true">第 4 步：I/O 线程处理请求</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11312"><span data-slate-object="text" data-key="11313"><span data-slate-leaf="true" data-offset-key="11313:0" data-first-offset="true"><span data-slate-string="true">所谓的 I/O 线程，就是我们开头提到的 KafkaRequestHandler 线程，它的处理逻辑就在 KafkaRequestHandler 类的 run 方法中：</span></span></span></div><div data-code-language="dart" data-slate-type="pre" data-slate-object="block" data-key="11314"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11315"><span data-slate-object="text" data-key="11316"><span data-slate-leaf="true" data-offset-key="11316:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// KafkaRequestHandler.scala</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11317"><span data-slate-object="text" data-key="11318"><span data-slate-leaf="true" data-offset-key="11318:0" data-first-offset="true"><span data-slate-string="true">def run(): Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11319"><span data-slate-object="text" data-key="11320"><span data-slate-leaf="true" data-offset-key="11320:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11321"><span data-slate-leaf="true" data-offset-key="11321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="11322"><span data-slate-leaf="true" data-offset-key="11322:0" data-first-offset="true"><span data-slate-string="true"> (!stopped) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11323"><span data-slate-object="text" data-key="11324"><span data-slate-leaf="true" data-offset-key="11324:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11325"><span data-slate-object="text" data-key="11326"><span data-slate-leaf="true" data-offset-key="11326:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11327"><span data-slate-leaf="true" data-offset-key="11327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 从请求队列中获取 Request 实例</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11328"><span data-slate-object="text" data-key="11329"><span data-slate-leaf="true" data-offset-key="11329:0" data-first-offset="true"><span data-slate-string="true">    val req = requestChannel.receiveRequest(</span></span></span><span data-slate-object="text" data-key="11330"><span data-slate-leaf="true" data-offset-key="11330:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">300</span></span></span></span><span data-slate-object="text" data-key="11331"><span data-slate-leaf="true" data-offset-key="11331:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11332"><span data-slate-object="text" data-key="11333"><span data-slate-leaf="true" data-offset-key="11333:0" data-first-offset="true"><span data-slate-string="true">    ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11334"><span data-slate-object="text" data-key="11335"><span data-slate-leaf="true" data-offset-key="11335:0" data-first-offset="true"><span data-slate-string="true">    req match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11336"><span data-slate-object="text" data-key="11337"><span data-slate-leaf="true" data-offset-key="11337:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11338"><span data-slate-leaf="true" data-offset-key="11338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="11339"><span data-slate-leaf="true" data-offset-key="11339:0" data-first-offset="true"><span data-slate-string="true"> RequestChannel.ShutdownRequest =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11340"><span data-slate-object="text" data-key="11341"><span data-slate-leaf="true" data-offset-key="11341:0" data-first-offset="true"><span data-slate-string="true">        ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11342"><span data-slate-object="text" data-key="11343"><span data-slate-leaf="true" data-offset-key="11343:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11344"><span data-slate-leaf="true" data-offset-key="11344:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="11345"><span data-slate-leaf="true" data-offset-key="11345:0" data-first-offset="true"><span data-slate-string="true"> request: RequestChannel.Request =&gt;</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11346"><span data-slate-object="text" data-key="11347"><span data-slate-leaf="true" data-offset-key="11347:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="11348"><span data-slate-leaf="true" data-offset-key="11348:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="11349"><span data-slate-leaf="true" data-offset-key="11349:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11350"><span data-slate-object="text" data-key="11351"><span data-slate-leaf="true" data-offset-key="11351:0" data-first-offset="true"><span data-slate-string="true">          ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11352"><span data-slate-object="text" data-key="11353"><span data-slate-leaf="true" data-offset-key="11353:0" data-first-offset="true"><span data-slate-string="true">          apis.handle(request)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11354"><span data-slate-object="text" data-key="11355"><span data-slate-leaf="true" data-offset-key="11355:0" data-first-offset="true"><span data-slate-string="true">        } {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11356"><span data-slate-object="text" data-key="11357"><span data-slate-leaf="true" data-offset-key="11357:0" data-first-offset="true"><span data-slate-string="true">            ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11358"><span data-slate-object="text" data-key="11359"><span data-slate-leaf="true" data-offset-key="11359:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11360"><span data-slate-object="text" data-key="11361"><span data-slate-leaf="true" data-offset-key="11361:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11362"><span data-slate-leaf="true" data-offset-key="11362:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="11363"><span data-slate-leaf="true" data-offset-key="11363:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11364"><span data-slate-leaf="true" data-offset-key="11364:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="11365"><span data-slate-leaf="true" data-offset-key="11365:0" data-first-offset="true"><span data-slate-string="true"> =&gt; </span></span></span><span data-slate-object="text" data-key="11366"><span data-slate-leaf="true" data-offset-key="11366:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 什么也不做</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11367"><span data-slate-object="text" data-key="11368"><span data-slate-leaf="true" data-offset-key="11368:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11369"><span data-slate-object="text" data-key="11370"><span data-slate-leaf="true" data-offset-key="11370:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11371"><span data-slate-object="text" data-key="11372"><span data-slate-leaf="true" data-offset-key="11372:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11373"><span data-slate-object="text" data-key="11374"><span data-slate-leaf="true" data-offset-key="11374:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11375"><span data-slate-object="text" data-key="11376"><span data-slate-leaf="true" data-offset-key="11376:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandler 线程循环地从请求队列中获取 Request 实例，然后交由 KafkaApis 的 handle 方法，执行真正的请求处理逻辑。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11377" id="sr-toc-8"><span data-slate-object="text" data-key="11378"><span data-slate-leaf="true" data-offset-key="11378:0" data-first-offset="true"><span data-slate-string="true">第 5 步：KafkaRequestHandler 线程将 Response 放入 Processor 线程的 Response 队列</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11379"><span data-slate-object="text" data-key="11380"><span data-slate-leaf="true" data-offset-key="11380:0" data-first-offset="true"><span data-slate-string="true">这一步的工作由 KafkaApis 类完成。当然，这依然是由 KafkaRequestHandler 线程来完成的。KafkaApis.scala 中有个 sendResponse 方法，将 Request 的处理结果 Response 发送出去。本质上，它就是调用了 RequestChannel 的 sendResponse 方法，代码如下：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="11381"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11382"><span data-slate-object="text" data-key="11383"><span data-slate-leaf="true" data-offset-key="11383:0" data-first-offset="true"><span data-slate-string="true">def </span></span></span><span data-slate-object="text" data-key="11384"><span data-slate-leaf="true" data-offset-key="11384:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sendResponse</span></span></span></span><span data-slate-object="text" data-key="11385"><span data-slate-leaf="true" data-offset-key="11385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(response: RequestChannel.Response)</span></span></span></span><span data-slate-object="text" data-key="11386"><span data-slate-leaf="true" data-offset-key="11386:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11387"><span data-slate-object="text" data-key="11388"><span data-slate-leaf="true" data-offset-key="11388:0" data-first-offset="true"><span data-slate-string="true">  ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11389"><span data-slate-object="text" data-key="11390"><span data-slate-leaf="true" data-offset-key="11390:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11391"><span data-slate-leaf="true" data-offset-key="11391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 找到这个 Request 当初是由哪个 Processor 线程处理的</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11392"><span data-slate-object="text" data-key="11393"><span data-slate-leaf="true" data-offset-key="11393:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11394"><span data-slate-leaf="true" data-offset-key="11394:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11395"><span data-slate-leaf="true" data-offset-key="11395:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11396"><span data-slate-leaf="true" data-offset-key="11396:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processor</span></span></span></span><span data-slate-object="text" data-key="11397"><span data-slate-leaf="true" data-offset-key="11397:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11398"><span data-slate-leaf="true" data-offset-key="11398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11399"><span data-slate-leaf="true" data-offset-key="11399:0" data-first-offset="true"><span data-slate-string="true"> processors.get(response.processor)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11400"><span data-slate-object="text" data-key="11401"><span data-slate-leaf="true" data-offset-key="11401:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="11402"><span data-slate-leaf="true" data-offset-key="11402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="11403"><span data-slate-leaf="true" data-offset-key="11403:0" data-first-offset="true"><span data-slate-string="true"> (processor != </span></span></span><span data-slate-object="text" data-key="11404"><span data-slate-leaf="true" data-offset-key="11404:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="11405"><span data-slate-leaf="true" data-offset-key="11405:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11406"><span data-slate-object="text" data-key="11407"><span data-slate-leaf="true" data-offset-key="11407:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11408"><span data-slate-leaf="true" data-offset-key="11408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 Response 添加到该 Processor 线程的 Response 队列上</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11409"><span data-slate-object="text" data-key="11410"><span data-slate-leaf="true" data-offset-key="11410:0" data-first-offset="true"><span data-slate-string="true">    processor.enqueueResponse(response)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11411"><span data-slate-object="text" data-key="11412"><span data-slate-leaf="true" data-offset-key="11412:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11413"><span data-slate-object="text" data-key="11414"><span data-slate-leaf="true" data-offset-key="11414:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="11415" id="sr-toc-9"><span data-slate-object="text" data-key="11416"><span data-slate-leaf="true" data-offset-key="11416:0" data-first-offset="true"><span data-slate-string="true">第 6 步：Processor 线程发送 Response 给 Request 发送方</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="11417"><span data-slate-object="text" data-key="11418"><span data-slate-leaf="true" data-offset-key="11418:0" data-first-offset="true"><span data-slate-string="true">最后一步是，Processor 线程取出 Response 队列中的 Response，返还给 Request 发送方。具体代码位于 Processor 线程的 processNewResponses 方法中：</span></span></span></div><div data-code-language="java" data-slate-type="pre" data-slate-object="block" data-key="11419"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="11420"><span data-slate-object="text" data-key="11421"><span data-slate-leaf="true" data-offset-key="11421:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// SocketServer.scala</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11422"><span data-slate-object="text" data-key="11423"><span data-slate-leaf="true" data-offset-key="11423:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">private</span></span></span></span><span data-slate-object="text" data-key="11424"><span data-slate-leaf="true" data-offset-key="11424:0" data-first-offset="true"><span data-slate-string="true"> def </span></span></span><span data-slate-object="text" data-key="11425"><span data-slate-leaf="true" data-offset-key="11425:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">processNewResponses</span></span></span></span><span data-slate-object="text" data-key="11426"><span data-slate-leaf="true" data-offset-key="11426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span><span data-slate-object="text" data-key="11427"><span data-slate-leaf="true" data-offset-key="11427:0" data-first-offset="true"><span data-slate-string="true">: Unit = {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11428"><span data-slate-object="text" data-key="11429"><span data-slate-leaf="true" data-offset-key="11429:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11430"><span data-slate-leaf="true" data-offset-key="11430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="11431"><span data-slate-leaf="true" data-offset-key="11431:0" data-first-offset="true"><span data-slate-string="true"> currentResponse: RequestChannel.Response = </span></span></span><span data-slate-object="text" data-key="11432"><span data-slate-leaf="true" data-offset-key="11432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11433"><span data-slate-object="text" data-key="11434"><span data-slate-leaf="true" data-offset-key="11434:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="11435"><span data-slate-leaf="true" data-offset-key="11435:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">while</span></span></span></span><span data-slate-object="text" data-key="11436"><span data-slate-leaf="true" data-offset-key="11436:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11437"><span data-slate-leaf="true" data-offset-key="11437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">({currentResponse = dequeueResponse()</span></span></span></span><span data-slate-object="text" data-key="11438"><span data-slate-leaf="true" data-offset-key="11438:0" data-first-offset="true"><span data-slate-string="true">; currentResponse != </span></span></span><span data-slate-object="text" data-key="11439"><span data-slate-leaf="true" data-offset-key="11439:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">null</span></span></span></span><span data-slate-object="text" data-key="11440"><span data-slate-leaf="true" data-offset-key="11440:0" data-first-offset="true"><span data-slate-string="true">}) { </span></span></span><span data-slate-object="text" data-key="11441"><span data-slate-leaf="true" data-offset-key="11441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 循环获取 Response 队列中的 Response</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11442"><span data-slate-object="text" data-key="11443"><span data-slate-leaf="true" data-offset-key="11443:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11444"><span data-slate-leaf="true" data-offset-key="11444:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">val</span></span></span></span><span data-slate-object="text" data-key="11445"><span data-slate-leaf="true" data-offset-key="11445:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11446"><span data-slate-leaf="true" data-offset-key="11446:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">channelId</span></span></span></span><span data-slate-object="text" data-key="11447"><span data-slate-leaf="true" data-offset-key="11447:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="11448"><span data-slate-leaf="true" data-offset-key="11448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">=</span></span></span></span><span data-slate-object="text" data-key="11449"><span data-slate-leaf="true" data-offset-key="11449:0" data-first-offset="true"><span data-slate-string="true"> currentResponse.request.context.connectionId</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11450"><span data-slate-object="text" data-key="11451"><span data-slate-leaf="true" data-offset-key="11451:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="11452"><span data-slate-leaf="true" data-offset-key="11452:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">try</span></span></span></span><span data-slate-object="text" data-key="11453"><span data-slate-leaf="true" data-offset-key="11453:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11454"><span data-slate-object="text" data-key="11455"><span data-slate-leaf="true" data-offset-key="11455:0" data-first-offset="true"><span data-slate-string="true">        currentResponse match {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11456"><span data-slate-object="text" data-key="11457"><span data-slate-leaf="true" data-offset-key="11457:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="11458"><span data-slate-leaf="true" data-offset-key="11458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="11459"><span data-slate-leaf="true" data-offset-key="11459:0" data-first-offset="true"><span data-slate-string="true"> response: NoOpResponse =&gt; </span></span></span><span data-slate-object="text" data-key="11460"><span data-slate-leaf="true" data-offset-key="11460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 不需要发送 Response</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11461"><span data-slate-object="text" data-key="11462"><span data-slate-leaf="true" data-offset-key="11462:0" data-first-offset="true"><span data-slate-string="true">            updateRequestMetrics(response)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11463"><span data-slate-object="text" data-key="11464"><span data-slate-leaf="true" data-offset-key="11464:0" data-first-offset="true"><span data-slate-string="true">            trace(s</span></span></span><span data-slate-object="text" data-key="11465"><span data-slate-leaf="true" data-offset-key="11465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"Socket server received empty response to send, registering for read: $response"</span></span></span></span><span data-slate-object="text" data-key="11466"><span data-slate-leaf="true" data-offset-key="11466:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11467"><span data-slate-object="text" data-key="11468"><span data-slate-leaf="true" data-offset-key="11468:0" data-first-offset="true"><span data-slate-string="true">            handleChannelMuteEvent(channelId, ChannelMuteEvent.RESPONSE_SENT)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11469"><span data-slate-object="text" data-key="11470"><span data-slate-leaf="true" data-offset-key="11470:0" data-first-offset="true"><span data-slate-string="true">            tryUnmuteChannel(channelId)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11471"></div><div data-slate-type="code-line" data-slate-object="block" data-key="11472"><span data-slate-object="text" data-key="11473"><span data-slate-leaf="true" data-offset-key="11473:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="11474"><span data-slate-leaf="true" data-offset-key="11474:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="11475"><span data-slate-leaf="true" data-offset-key="11475:0" data-first-offset="true"><span data-slate-string="true"> response: SendResponse =&gt; </span></span></span><span data-slate-object="text" data-key="11476"><span data-slate-leaf="true" data-offset-key="11476:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 需要发送 Response</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11477"><span data-slate-object="text" data-key="11478"><span data-slate-leaf="true" data-offset-key="11478:0" data-first-offset="true"><span data-slate-string="true">            sendResponse(response, response.responseSend)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11479"><span data-slate-object="text" data-key="11480"><span data-slate-leaf="true" data-offset-key="11480:0" data-first-offset="true"><span data-slate-string="true">          ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11481"><span data-slate-object="text" data-key="11482"><span data-slate-leaf="true" data-offset-key="11482:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11483"><span data-slate-object="text" data-key="11484"><span data-slate-leaf="true" data-offset-key="11484:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11485"><span data-slate-object="text" data-key="11486"><span data-slate-leaf="true" data-offset-key="11486:0" data-first-offset="true"><span data-slate-string="true">      ......</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11487"><span data-slate-object="text" data-key="11488"><span data-slate-leaf="true" data-offset-key="11488:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11489"><span data-slate-object="text" data-key="11490"><span data-slate-leaf="true" data-offset-key="11490:0" data-first-offset="true"><span data-slate-string="true">  }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="11491"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11492"><span data-slate-object="text" data-key="11493"><span data-slate-leaf="true" data-offset-key="11493:0" data-first-offset="true"><span data-slate-string="true">从这段代码可知，最核心的部分是 sendResponse 方法来执行 Response 发送。该方法底层使用 Selector 实现真正的发送逻辑。至此，一个请求被完整处理的流程我就讲完了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11494"><span data-slate-object="text" data-key="11495"><span data-slate-leaf="true" data-offset-key="11495:0" data-first-offset="true"><span data-slate-string="true">最后，我想再补充一点，还记得我之前说过，有些 Response 是需要有回调逻辑的吗？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11496"><span data-slate-object="text" data-key="11497"><span data-slate-leaf="true" data-offset-key="11497:0" data-first-offset="true"><span data-slate-string="true">实际上，在第 6 步执行完毕之后，Processor 线程通常还会尝试执行 Response 中的回调逻辑，即 Processor 类的 processCompletedSends 方法。不过，并非所有 Request 或 Response 都指定了回调逻辑。事实上，只有很少的 Response 携带了回调逻辑。比如说，FETCH 请求在发送 Response 之后，就要求更新下 Broker 端与消息格式转换操作相关的统计指标。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11498" id="sr-toc-10"><span data-slate-object="text" data-key="11499"><span data-slate-leaf="true" data-offset-key="11499:0" data-first-offset="true"><span data-slate-string="true">总结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11500"><span data-slate-object="text" data-key="11501"><span data-slate-leaf="true" data-offset-key="11501:0" data-first-offset="true"><span data-slate-string="true">今天，我们学习了 KafkaRequestHandlerPool 线程池及其下辖的 KafkaRequestHandler 线程，该线程就是 Kafka 社区所称的 I/O 线程。另外，我结合源代码把 Kafka 的请求处理流程串讲了一遍。我们来回顾下这节课的重点。</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="11502"><div data-slate-type="list-line" data-slate-object="block" data-key="11503"><span data-slate-object="text" data-key="11504"><span data-slate-leaf="true" data-offset-key="11504:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandler：I/O 线程，负责处理 Processor 线程下发的 Request 对象。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="11505"><span data-slate-object="text" data-key="11506"><span data-slate-leaf="true" data-offset-key="11506:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandlerPool：创建和管理一组 KafkaRequestHandler 线程。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="11507"><span data-slate-object="text" data-key="11508"><span data-slate-leaf="true" data-offset-key="11508:0" data-first-offset="true"><span data-slate-string="true">请求处理流程：总共分为 6 步。</span></span></span></div></div><div data-slate-type="list" data-slate-object="block" data-key="11509"><div data-slate-type="list-line" data-slate-object="block" data-key="11510"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="11511"><span data-slate-leaf="true" data-offset-key="11511:0" data-first-offset="true"><span data-slate-string="true">Clients 或其他 Broker 通过 Selector 机制发起创建连接请求。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11512"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="11513"><span data-slate-leaf="true" data-offset-key="11513:0" data-first-offset="true"><span data-slate-string="true">Processor 线程接收请求，并将其转换成可处理的 Request 对象。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11514"><div data-code-line-number="3"></div><div><span data-slate-object="text" data-key="11515"><span data-slate-leaf="true" data-offset-key="11515:0" data-first-offset="true"><span data-slate-string="true">Processor 线程将 Request 对象放入 Request 队列。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11516"><div data-code-line-number="4"></div><div><span data-slate-object="text" data-key="11517"><span data-slate-leaf="true" data-offset-key="11517:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandler 线程从 Request 队列中取出待处理请求，并进行处理。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11518"><div data-code-line-number="5"></div><div><span data-slate-object="text" data-key="11519"><span data-slate-leaf="true" data-offset-key="11519:0" data-first-offset="true"><span data-slate-string="true">KafkaRequestHandler 线程将 Response 放回到对应 Processor 线程的 Response 队列。</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="11520"><div data-code-line-number="6"></div><div><span data-slate-object="text" data-key="11521"><span data-slate-leaf="true" data-offset-key="11521:0" data-first-offset="true"><span data-slate-string="true">Processor 线程发送 Response 给 Request 发送方。</span></span></span></div></div></div><div data-slate-type="image" data-slate-object="block" data-key="11522"><div class="sr-rd-content-center"><img class="sr-rd-content-img-load" src="https://static001.geekbang.org/resource/image/45/c4/458e65efcab7964911bb6a1755fa89c4.jpg?wh=2449*1499"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11523"><span data-slate-object="text" data-key="11524"><span data-slate-leaf="true" data-offset-key="11524:0" data-first-offset="true"><span data-slate-string="true">其实，今天在谈到 Request 逻辑执行的时候，我卖了个关子 —— 我提到，KafkaApis 是请求逻辑的真正处理方法。也就是说，所有类型的请求处理逻辑都封装在 KafkaApis 文件下，但我并没有深入地去讲它。下节课，我会重点和你聊聊这个 KafkaApis 类。我一直认为，该类是查看所有 Kafka 源码的首要入口类，绝对值得我们花一整节课的时间去学习。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="11525" id="sr-toc-11"><span data-slate-object="text" data-key="11526"><span data-slate-leaf="true" data-offset-key="11526:0" data-first-offset="true"><span data-slate-string="true">课后讨论</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="11527"><span data-slate-object="text" data-key="11528"><span data-slate-leaf="true" data-offset-key="11528:0" data-first-offset="true"><span data-slate-string="true">最后，请你结合今天的内容思考一个问题：你觉得，请求处理流程的哪些部分应用了经典的 “生产者 - 消费者” 模式？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="11529"><span data-slate-object="text" data-key="11530"><span data-slate-leaf="true" data-offset-key="11530:0" data-first-offset="true"><span data-slate-string="true">欢迎你在留言区畅所欲言，跟我交流讨论，也欢迎你把今天的内容分享给你的朋友。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-12">精选留言 (10)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/a7/9a/495cb99a.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>胡夕</span></div><span>置顶</span></div><div>你好，我是胡夕。我来公布上节课的 “课后讨论” 题答案啦～

上节课，咱们重点了解了 Kafka 请求区分优先级的方案。课后，我请你思考排除多套资源之外的替代方案，比如将请求队列改造成支持优先级队列。下面我说说这个方案的特点。这个方案的好处在于源码不用做这么大的变动。多套资源的方案对源码的改动程度很大，且不说新增了一些参数，很多处理逻辑几乎原封不动地 copy 了一组。但这个方案的一个弊端在于它依然无法解决队列已满的场景。如果大量队列堆积在优先级队列后，新入场的控制类请求只能等待，依然无法得到快速处理。

okay，你同意这个说法吗？或者说你有其他的看法吗？我们可以一起讨论下。</div><div><div>2020-05-19</div><div><div><i></i><span>1</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1d/ef/6b/5e8f6536.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 伯安知心</span></div></div><div>1，acceptor 和 processor 之间缓存 SocketChannel 队列，线程安全顺序。
2，processor 和 handle 之间缓存阻塞队列 requestChannel 的 request 全局队列和 response 局部队列，</div><div><p>作者回复: 👍</p></div><div><div>2020-05-07</div><div><div><i></i><span>2</span></div><div><i></i><span>5</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/25/7f/473d5a77.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 曾轼麟</span></div></div><div>从 Acceptor 到  Processor newConnections 队列，从 Processor 到 KafkaRequestHandler RequestChannel 队列。其实目前我在公司也有使用生成者消费者模型，使用的是 Disruptor 作为队列</div><div><p>作者回复：嗯，很多思想都是相同的～</p></div><div><div>2020-05-27</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/a0/cb/aab3b3e7.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 张三丰</span></div></div><div>是不是一个生产者只需要一个 process 线程？因为只有一个连接，一个连接对应一个 channel，一个 channel 对应一个 process，这个 process 和 netty 的 eventloop 是一个概念？</div><div><div>2022-05-21</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/21/63/6e/6b971571.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Z 宇锤锤</span></div></div><div>requestChannel 中的请求队列。Response 队列。这两个数据结构有对应的生产者和消费者。</div><div><div>2022-01-23</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTI34ZlT6HSOtJBeTvTvfNLfYECDdJXnHCMj2BHdrRaqRLnZiafnxmKQ2aXoQkW1RLQOyt0tlyzEWIA/132"></div></div><div><div><div><span>ahu0605</span></div></div><div>这个线程从哪里阻塞？requestChannel？</div><div><div>2022-01-18</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/b7/c2/196932c7.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>南琛一梦</span></div></div><div>因为之前对 netty 有过深入研究，因此对于请求处理模块理解起来感觉轻松很多，对于该课程的学习也渐入佳境了。继续加油！！！</div><div><div>2021-12-23</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/60/6d/3c2a5143.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>二进制傻瓜</span></div></div><div>胡大您好！我们生产上用 k8s 云化的 kafka 写数据时偶尔会报 “the server disconnected before a response was received”，发送时 ack=1, 这可能是什么原因导致的</div><div><p>作者回复：可能的原因是某个 TCP 通道长时间没有请求流过被单方面关闭了，之后对端再起启用时发现连接已经中断。偶发的错误没事</p></div><div><div>2020-07-06</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/12/ca/bd/a51ae4b2.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>吃饭饭</span></div></div><div>这里不太明白：【kafka.network.Processor#run】这个方法内部执行的方法 processNewResponses () 和 processCompletedReceives () 不能调换位置吗？先调用 processCompletedReceives (), 我理解的是肯定是请求先到，才会有 Response 啊</div><div><p>作者回复：个人感觉顺序不是很重要，毕竟都是循环执行</p></div><div><div>2020-06-17</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/7f/ef/73036441.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>LEO</span></div></div><div>老师，kafka 底层也是通过 NIO 进行通信，请问是如何解决 epoll 空轮询 bug 的，这块代码我一直没找到</div><div><p>作者回复: Kafka 不像 Netty 那样有相应的处理措施，毕竟属于 JDK bug，不属于 Kafka 操心的事情：）</p></div><div><div>2020-05-07</div><div><div><i></i><span>3</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".y"><outline class="toc-level-h1" data-reactid=".y.0" style="width: 175px;"><active data-reactid=".y.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".y.0.1"><span data-reactid=".y.0.1.0">09 | SocketServer（下）：请求处理全流程源码分析</span></a></outline><outline class="toc-level-h2" data-reactid=".y.1" style="width: 165px;"><active data-reactid=".y.1.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".y.1.1"><span data-reactid=".y.1.1.0">KafkaRequestHandlerPool</span></a></outline><outline class="toc-level-h3" data-reactid=".y.2" style="width: 155px;"><active data-reactid=".y.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".y.2.1"><span data-reactid=".y.2.1.0">KafkaRequestHandler</span></a></outline><outline class="toc-level-h3" data-reactid=".y.3" style="width: 155px;"><active data-reactid=".y.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".y.3.1"><span data-reactid=".y.3.1.0">KafkaRequestHandlerPool</span></a></outline><outline class="toc-level-h2" data-reactid=".y.4" style="width: 165px;"><active data-reactid=".y.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".y.4.1"><span data-reactid=".y.4.1.0">全处理流程</span></a></outline><outline class="toc-level-h3" data-reactid=".y.5" style="width: 155px;"><active data-reactid=".y.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".y.5.1"><span data-reactid=".y.5.1.0">第 1 步：Clients 或其他 Broker 发送请求给 Acceptor 线程</span></a></outline><outline class="toc-level-h3" data-reactid=".y.6" style="width: 155px;"><active data-reactid=".y.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".y.6.1"><span data-reactid=".y.6.1.0">第 2 &amp; 3 步：Processor 线程处理请求，并放入请求队列</span></a></outline><outline class="toc-level-h3" data-reactid=".y.7" style="width: 155px;"><active data-reactid=".y.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".y.7.1"><span data-reactid=".y.7.1.0">第 4 步：I/O 线程处理请求</span></a></outline><outline class="toc-level-h3" data-reactid=".y.8" style="width: 155px;"><active data-reactid=".y.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".y.8.1"><span data-reactid=".y.8.1.0">第 5 步：KafkaRequestHandler 线程将 Response 放入 Processor 线程的 Response 队列</span></a></outline><outline class="toc-level-h3" data-reactid=".y.9" style="width: 155px;"><active data-reactid=".y.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".y.9.1"><span data-reactid=".y.9.1.0">第 6 步：Processor 线程发送 Response 给 Request 发送方</span></a></outline><outline class="toc-level-h2" data-reactid=".y.a" style="width: 165px;"><active data-reactid=".y.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".y.a.1"><span data-reactid=".y.a.1.0">总结</span></a></outline><outline class="toc-level-h2" data-reactid=".y.b" style="width: 165px;"><active data-reactid=".y.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".y.b.1"><span data-reactid=".y.b.1.0">课后讨论</span></a></outline><outline class="toc-level-h2" data-reactid=".y.c" style="width: 165px;"><active data-reactid=".y.c.0"></active><a class="toc-outline-theme-github" href="#sr-toc-12" data-reactid=".y.c.1"><span data-reactid=".y.c.1.0">精选留言 (10)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/233233" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>