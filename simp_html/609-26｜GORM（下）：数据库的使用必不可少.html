
                <html lang="en" class="simpread-font simpread-theme-root" style='undefined'>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 26｜GORM（下）：数据库的使用必不可少</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>26｜GORM（下）：数据库的使用必不可少</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">如何把 Gorm 完美集成到 hade 框架，更好地支持业务对数据库频繁的增删改查操作？</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0">26｜GORM（下）：数据库的使用必不可少</h1><div><span>叶剑峰</span> <span> 2021-11-15</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/34/de/34d4c0d7ac4d8dyy43d388c55cac8cde.jpeg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;" one-link-mark="yes"> 1.0x <i><span></span></i></a></div><div><span>讲述：叶剑峰</span><span>大小：15.97M</span><span> 时长：17:29</span></div></div><audio title="26｜GORM（下）：数据库的使用必不可少" src="https://res001.geekbang.org/media/audio/a9/d4/a9dbf1b9437f4c8bfe9140c622fba0d4/ld/ld.m3u8" __idm_id__="712705"></audio></div><div><div><div><div data-slate-editor="true" data-key="0" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="1"><span data-slate-object="text" data-key="2"><span data-slate-leaf="true" data-offset-key="2:0" data-first-offset="true"><span data-slate-string="true">你好，我是轩脉刃。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="3"><span data-slate-object="text" data-key="4"><span data-slate-leaf="true" data-offset-key="4:0" data-first-offset="true"><span data-slate-string="true">上一节课，我们梳理了 Gorm 的核心逻辑，也通过思维导图，详细分析了 Gorm 的源码搞清楚它是如何封装 database/sql 的。这节课我们就要思考和操作，如何将 Gorm 融合进入 hade 框架了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="5"><span data-slate-object="text" data-key="6"><span data-slate-leaf="true" data-offset-key="6:0" data-first-offset="true"><span data-slate-string="true">Gorm 的使用分为两个部分，数据库的连接和数据库的操作。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="7"><span data-slate-object="text" data-key="8"><span data-slate-leaf="true" data-offset-key="8:0" data-first-offset="true"><span data-slate-string="true">对于数据库操作接口的封装，Gorm 已经做的非常好了，它在 gorm.DB 中定义了非常多的对数据库的操作接口，这些接口已经是非常易用了，而且每个操作接口在</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="9" one-link-mark="yes"><span data-slate-object="text" data-key="10"><span data-slate-leaf="true" data-offset-key="10:0" data-first-offset="true"><span data-slate-string="true">官方文档</span></span></span></a><span data-slate-object="text" data-key="11"><span data-slate-leaf="true" data-offset-key="11:0" data-first-offset="true"><span data-slate-string="true">中都有对应的说明和使用教程。比如在 DB 的操作接口列表中，我们可以看到常用的增删改查的逻辑：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="12"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="13"><span data-slate-object="text" data-key="14"><span data-slate-leaf="true" data-offset-key="14:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15"><span data-slate-leaf="true" data-offset-key="15:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="16"><span data-slate-leaf="true" data-offset-key="16:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(db *DB)</span></span></span></span></span><span data-slate-object="text" data-key="17"><span data-slate-leaf="true" data-offset-key="17:0" data-first-offset="true"><span data-slate-string="true"> Create(value </span></span></span><span data-slate-object="text" data-key="18"><span data-slate-leaf="true" data-offset-key="18:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="19"><span data-slate-leaf="true" data-offset-key="19:0" data-first-offset="true"><span data-slate-string="true">{}) (tx *DB)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="20"></div><div data-slate-type="code-line" data-slate-object="block" data-key="21"><span data-slate-object="text" data-key="22"><span data-slate-leaf="true" data-offset-key="22:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="23"><span data-slate-leaf="true" data-offset-key="23:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="24"><span data-slate-leaf="true" data-offset-key="24:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(db *DB)</span></span></span></span></span><span data-slate-object="text" data-key="25"><span data-slate-leaf="true" data-offset-key="25:0" data-first-offset="true"><span data-slate-string="true"> Delete(value </span></span></span><span data-slate-object="text" data-key="26"><span data-slate-leaf="true" data-offset-key="26:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="27"><span data-slate-leaf="true" data-offset-key="27:0" data-first-offset="true"><span data-slate-string="true">{}, conds ...</span></span></span><span data-slate-object="text" data-key="28"><span data-slate-leaf="true" data-offset-key="28:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="29"><span data-slate-leaf="true" data-offset-key="29:0" data-first-offset="true"><span data-slate-string="true">{}) (tx *DB)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="30"></div><div data-slate-type="code-line" data-slate-object="block" data-key="31"><span data-slate-object="text" data-key="32"><span data-slate-leaf="true" data-offset-key="32:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="33"><span data-slate-leaf="true" data-offset-key="33:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="34"><span data-slate-leaf="true" data-offset-key="34:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(db *DB)</span></span></span></span></span><span data-slate-object="text" data-key="35"><span data-slate-leaf="true" data-offset-key="35:0" data-first-offset="true"><span data-slate-string="true"> Get(key </span></span></span><span data-slate-object="text" data-key="36"><span data-slate-leaf="true" data-offset-key="36:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="37"><span data-slate-leaf="true" data-offset-key="37:0" data-first-offset="true"><span data-slate-string="true">) (</span></span></span><span data-slate-object="text" data-key="38"><span data-slate-leaf="true" data-offset-key="38:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="39"><span data-slate-leaf="true" data-offset-key="39:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="40"><span data-slate-leaf="true" data-offset-key="40:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="41"><span data-slate-leaf="true" data-offset-key="41:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="42"></div><div data-slate-type="code-line" data-slate-object="block" data-key="43"><span data-slate-object="text" data-key="44"><span data-slate-leaf="true" data-offset-key="44:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="45"><span data-slate-leaf="true" data-offset-key="45:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="46"><span data-slate-leaf="true" data-offset-key="46:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(db *DB)</span></span></span></span></span><span data-slate-object="text" data-key="47"><span data-slate-leaf="true" data-offset-key="47:0" data-first-offset="true"><span data-slate-string="true"> Update(column </span></span></span><span data-slate-object="text" data-key="48"><span data-slate-leaf="true" data-offset-key="48:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="49"><span data-slate-leaf="true" data-offset-key="49:0" data-first-offset="true"><span data-slate-string="true">, value </span></span></span><span data-slate-object="text" data-key="50"><span data-slate-leaf="true" data-offset-key="50:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="51"><span data-slate-leaf="true" data-offset-key="51:0" data-first-offset="true"><span data-slate-string="true">{}) (tx *DB)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="52"><span data-slate-object="text" data-key="53"><span data-slate-leaf="true" data-offset-key="53:0" data-first-offset="true"><span data-slate-string="true">同时，</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="54" one-link-mark="yes"><span data-slate-object="text" data-key="55"><span data-slate-leaf="true" data-offset-key="55:0" data-first-offset="true"><span data-slate-string="true">官方首页</span></span></span></a><span data-slate-object="text" data-key="56"><span data-slate-leaf="true" data-offset-key="56:0" data-first-offset="true"><span data-slate-string="true">的例子也把获取到 DB 后的增删改查操作显示很清楚了，建议你在浏览器收藏这个 Gorm 的说明文档，因为在具体的应用开发中，你会经常参考使用它的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="57"><span data-slate-object="text" data-key="58"><span data-slate-leaf="true" data-offset-key="58:0" data-first-offset="true"><span data-slate-string="true">所以今天我们要做的事情，就是封装 Gorm 的数据库连接部分。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="59" id="sr-toc-1"><span data-slate-object="text" data-key="60"><span data-slate-leaf="true" data-offset-key="60:0" data-first-offset="true"><span data-slate-string="true">ORM 服务</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="61"><span data-slate-object="text" data-key="62"><span data-slate-leaf="true" data-offset-key="62:0" data-first-offset="true"><span data-slate-string="true">按照 “一切皆服务” 的思想，我们也计划将 Gorm 封装为一个服务。而服务三要素是服务接口、服务提供者、服务实例化。我们先来定义 ORM 服务接口。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="63" id="sr-toc-2"><span data-slate-object="text" data-key="64"><span data-slate-leaf="true" data-offset-key="64:0" data-first-offset="true"><span data-slate-string="true">服务接口</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="65"><span data-slate-object="text" data-key="66"><span data-slate-leaf="true" data-offset-key="66:0" data-first-offset="true"><span data-slate-string="true">这个服务接口并不复杂，它的唯一任务就是能够初始化出 gorm.DB 实例。回顾上节课说的 Gorm 初始化 gorm.DB 的方法：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="67"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="68"><span data-slate-object="text" data-key="69"><span data-slate-leaf="true" data-offset-key="69:0" data-first-offset="true"><span data-slate-string="true">  dsn := </span></span></span><span data-slate-object="text" data-key="70"><span data-slate-leaf="true" data-offset-key="70:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"xxxxxxx"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="71"><span data-slate-object="text" data-key="72"><span data-slate-leaf="true" data-offset-key="72:0" data-first-offset="true"><span data-slate-string="true">  db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="73"><span data-slate-object="text" data-key="74"><span data-slate-leaf="true" data-offset-key="74:0" data-first-offset="true"><span data-slate-string="true">参数看起来就这两个部分 DSN 和 gorm.Config。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="75"><span data-slate-object="text" data-key="76"><span data-slate-leaf="true" data-offset-key="76:0" data-first-offset="true"><span data-slate-string="true">不过我们希望设计一个 hade 框架自定义的配置结构，将所有创建连接需要的配置项整合起来。所以除了 DSN 和 gorm.Config 这两个配置项，其实还需要加上连接池的配置，就是上节课说的 database/sql 中提供的对连接池的配置信息。再回顾一下这四个影响底层创建连接池设置的配置信息：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="77"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="78"><span data-slate-object="text" data-key="79"><span data-slate-leaf="true" data-offset-key="79:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置连接的最大空闲时长</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="80"><span data-slate-object="text" data-key="81"><span data-slate-leaf="true" data-offset-key="81:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="82"><span data-slate-leaf="true" data-offset-key="82:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="83"><span data-slate-leaf="true" data-offset-key="83:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(db *DB)</span></span></span></span></span><span data-slate-object="text" data-key="84"><span data-slate-leaf="true" data-offset-key="84:0" data-first-offset="true"><span data-slate-string="true"> SetConnMaxIdleTime(d time.Duration)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="85"><span data-slate-object="text" data-key="86"><span data-slate-leaf="true" data-offset-key="86:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置连接的最大生命时长</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="87"><span data-slate-object="text" data-key="88"><span data-slate-leaf="true" data-offset-key="88:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="89"><span data-slate-leaf="true" data-offset-key="89:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="90"><span data-slate-leaf="true" data-offset-key="90:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(db *DB)</span></span></span></span></span><span data-slate-object="text" data-key="91"><span data-slate-leaf="true" data-offset-key="91:0" data-first-offset="true"><span data-slate-string="true"> SetConnMaxLifetime(d time.Duration)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="92"><span data-slate-object="text" data-key="93"><span data-slate-leaf="true" data-offset-key="93:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置最大空闲连接数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="94"><span data-slate-object="text" data-key="95"><span data-slate-leaf="true" data-offset-key="95:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="96"><span data-slate-leaf="true" data-offset-key="96:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="97"><span data-slate-leaf="true" data-offset-key="97:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(db *DB)</span></span></span></span></span><span data-slate-object="text" data-key="98"><span data-slate-leaf="true" data-offset-key="98:0" data-first-offset="true"><span data-slate-string="true"> SetMaxIdleConns(n </span></span></span><span data-slate-object="text" data-key="99"><span data-slate-leaf="true" data-offset-key="99:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="100"><span data-slate-leaf="true" data-offset-key="100:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="101"><span data-slate-object="text" data-key="102"><span data-slate-leaf="true" data-offset-key="102:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置最大打开连接数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="103"><span data-slate-object="text" data-key="104"><span data-slate-leaf="true" data-offset-key="104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="105"><span data-slate-leaf="true" data-offset-key="105:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="106"><span data-slate-leaf="true" data-offset-key="106:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(db *DB)</span></span></span></span></span><span data-slate-object="text" data-key="107"><span data-slate-leaf="true" data-offset-key="107:0" data-first-offset="true"><span data-slate-string="true"> SetMaxOpenConns(n </span></span></span><span data-slate-object="text" data-key="108"><span data-slate-leaf="true" data-offset-key="108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="109"><span data-slate-leaf="true" data-offset-key="109:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="110"><span data-slate-object="text" data-key="111"><span data-slate-leaf="true" data-offset-key="111:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">所以可以定义这么一个 DBConfig 结构，将所有的创建 DB 相关的配置都放在这里面</span></span></span></span><span data-slate-object="text" data-key="112"><span data-slate-leaf="true" data-offset-key="112:0" data-first-offset="true"><span data-slate-string="true">。代码在 framework/contract/orm.go 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="113"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="114"><span data-slate-object="text" data-key="115"><span data-slate-leaf="true" data-offset-key="115:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// DBConfig 代表数据库连接的所有配置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="116"><span data-slate-object="text" data-key="117"><span data-slate-leaf="true" data-offset-key="117:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="118"><span data-slate-leaf="true" data-offset-key="118:0" data-first-offset="true"><span data-slate-string="true"> DBConfig </span></span></span><span data-slate-object="text" data-key="119"><span data-slate-leaf="true" data-offset-key="119:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="120"><span data-slate-leaf="true" data-offset-key="120:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="121"><span data-slate-object="text" data-key="122"><span data-slate-leaf="true" data-offset-key="122:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="123"><span data-slate-leaf="true" data-offset-key="123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 以下配置关于 dsn</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="124"><span data-slate-object="text" data-key="125"><span data-slate-leaf="true" data-offset-key="125:0" data-first-offset="true"><span data-slate-string="true">   WriteTimeout </span></span></span><span data-slate-object="text" data-key="126"><span data-slate-leaf="true" data-offset-key="126:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="127"><span data-slate-leaf="true" data-offset-key="127:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="128"><span data-slate-leaf="true" data-offset-key="128:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"write_timeout"`</span></span></span></span><span data-slate-object="text" data-key="129"><span data-slate-leaf="true" data-offset-key="129:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="130"><span data-slate-leaf="true" data-offset-key="130:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 写超时时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="131"><span data-slate-object="text" data-key="132"><span data-slate-leaf="true" data-offset-key="132:0" data-first-offset="true"><span data-slate-string="true">   Loc          </span></span></span><span data-slate-object="text" data-key="133"><span data-slate-leaf="true" data-offset-key="133:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="134"><span data-slate-leaf="true" data-offset-key="134:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="135"><span data-slate-leaf="true" data-offset-key="135:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"loc"`</span></span></span></span><span data-slate-object="text" data-key="136"><span data-slate-leaf="true" data-offset-key="136:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="137"><span data-slate-leaf="true" data-offset-key="137:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 时区</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="138"><span data-slate-object="text" data-key="139"><span data-slate-leaf="true" data-offset-key="139:0" data-first-offset="true"><span data-slate-string="true">   Port         </span></span></span><span data-slate-object="text" data-key="140"><span data-slate-leaf="true" data-offset-key="140:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="141"><span data-slate-leaf="true" data-offset-key="141:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="142"><span data-slate-leaf="true" data-offset-key="142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"port"`</span></span></span></span><span data-slate-object="text" data-key="143"><span data-slate-leaf="true" data-offset-key="143:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="144"><span data-slate-leaf="true" data-offset-key="144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 端口</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="145"><span data-slate-object="text" data-key="146"><span data-slate-leaf="true" data-offset-key="146:0" data-first-offset="true"><span data-slate-string="true">   ReadTimeout  </span></span></span><span data-slate-object="text" data-key="147"><span data-slate-leaf="true" data-offset-key="147:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="148"><span data-slate-leaf="true" data-offset-key="148:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="149"><span data-slate-leaf="true" data-offset-key="149:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"read_timeout"`</span></span></span></span><span data-slate-object="text" data-key="150"><span data-slate-leaf="true" data-offset-key="150:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="151"><span data-slate-leaf="true" data-offset-key="151:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读超时时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="152"><span data-slate-object="text" data-key="153"><span data-slate-leaf="true" data-offset-key="153:0" data-first-offset="true"><span data-slate-string="true">   Charset      </span></span></span><span data-slate-object="text" data-key="154"><span data-slate-leaf="true" data-offset-key="154:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="155"><span data-slate-leaf="true" data-offset-key="155:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="156"><span data-slate-leaf="true" data-offset-key="156:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"charset"`</span></span></span></span><span data-slate-object="text" data-key="157"><span data-slate-leaf="true" data-offset-key="157:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="158"><span data-slate-leaf="true" data-offset-key="158:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 字符集</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="159"><span data-slate-object="text" data-key="160"><span data-slate-leaf="true" data-offset-key="160:0" data-first-offset="true"><span data-slate-string="true">   ParseTime    </span></span></span><span data-slate-object="text" data-key="161"><span data-slate-leaf="true" data-offset-key="161:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="162"><span data-slate-leaf="true" data-offset-key="162:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="163"><span data-slate-leaf="true" data-offset-key="163:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"parse_time"`</span></span></span></span><span data-slate-object="text" data-key="164"><span data-slate-leaf="true" data-offset-key="164:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="165"><span data-slate-leaf="true" data-offset-key="165:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 是否解析时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="166"><span data-slate-object="text" data-key="167"><span data-slate-leaf="true" data-offset-key="167:0" data-first-offset="true"><span data-slate-string="true">   Protocol     </span></span></span><span data-slate-object="text" data-key="168"><span data-slate-leaf="true" data-offset-key="168:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="169"><span data-slate-leaf="true" data-offset-key="169:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="170"><span data-slate-leaf="true" data-offset-key="170:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"protocol"`</span></span></span></span><span data-slate-object="text" data-key="171"><span data-slate-leaf="true" data-offset-key="171:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="172"><span data-slate-leaf="true" data-offset-key="172:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 传输协议</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="173"><span data-slate-object="text" data-key="174"><span data-slate-leaf="true" data-offset-key="174:0" data-first-offset="true"><span data-slate-string="true">   Dsn          </span></span></span><span data-slate-object="text" data-key="175"><span data-slate-leaf="true" data-offset-key="175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="176"><span data-slate-leaf="true" data-offset-key="176:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="177"><span data-slate-leaf="true" data-offset-key="177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"dsn"`</span></span></span></span><span data-slate-object="text" data-key="178"><span data-slate-leaf="true" data-offset-key="178:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="179"><span data-slate-leaf="true" data-offset-key="179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 直接传递 dsn，如果传递了，其他关于 dsn 的配置均无效</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="180"><span data-slate-object="text" data-key="181"><span data-slate-leaf="true" data-offset-key="181:0" data-first-offset="true"><span data-slate-string="true">   Database     </span></span></span><span data-slate-object="text" data-key="182"><span data-slate-leaf="true" data-offset-key="182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="183"><span data-slate-leaf="true" data-offset-key="183:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="184"><span data-slate-leaf="true" data-offset-key="184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"database"`</span></span></span></span><span data-slate-object="text" data-key="185"><span data-slate-leaf="true" data-offset-key="185:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="186"><span data-slate-leaf="true" data-offset-key="186:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 数据库</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="187"><span data-slate-object="text" data-key="188"><span data-slate-leaf="true" data-offset-key="188:0" data-first-offset="true"><span data-slate-string="true">   Collation    </span></span></span><span data-slate-object="text" data-key="189"><span data-slate-leaf="true" data-offset-key="189:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="190"><span data-slate-leaf="true" data-offset-key="190:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="191"><span data-slate-leaf="true" data-offset-key="191:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"collation"`</span></span></span></span><span data-slate-object="text" data-key="192"><span data-slate-leaf="true" data-offset-key="192:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="193"><span data-slate-leaf="true" data-offset-key="193:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 字符序</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="194"><span data-slate-object="text" data-key="195"><span data-slate-leaf="true" data-offset-key="195:0" data-first-offset="true"><span data-slate-string="true">   Timeout      </span></span></span><span data-slate-object="text" data-key="196"><span data-slate-leaf="true" data-offset-key="196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="197"><span data-slate-leaf="true" data-offset-key="197:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="198"><span data-slate-leaf="true" data-offset-key="198:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"timeout"`</span></span></span></span><span data-slate-object="text" data-key="199"><span data-slate-leaf="true" data-offset-key="199:0" data-first-offset="true"><span data-slate-string="true">       </span></span></span><span data-slate-object="text" data-key="200"><span data-slate-leaf="true" data-offset-key="200:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 连接超时时间</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="201"><span data-slate-object="text" data-key="202"><span data-slate-leaf="true" data-offset-key="202:0" data-first-offset="true"><span data-slate-string="true">   Username     </span></span></span><span data-slate-object="text" data-key="203"><span data-slate-leaf="true" data-offset-key="203:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="204"><span data-slate-leaf="true" data-offset-key="204:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="205"><span data-slate-leaf="true" data-offset-key="205:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"username"`</span></span></span></span><span data-slate-object="text" data-key="206"><span data-slate-leaf="true" data-offset-key="206:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="207"><span data-slate-leaf="true" data-offset-key="207:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 用户名</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="208"><span data-slate-object="text" data-key="209"><span data-slate-leaf="true" data-offset-key="209:0" data-first-offset="true"><span data-slate-string="true">   Password     </span></span></span><span data-slate-object="text" data-key="210"><span data-slate-leaf="true" data-offset-key="210:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="211"><span data-slate-leaf="true" data-offset-key="211:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="212"><span data-slate-leaf="true" data-offset-key="212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"password"`</span></span></span></span><span data-slate-object="text" data-key="213"><span data-slate-leaf="true" data-offset-key="213:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="214"><span data-slate-leaf="true" data-offset-key="214:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 密码</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="215"><span data-slate-object="text" data-key="216"><span data-slate-leaf="true" data-offset-key="216:0" data-first-offset="true"><span data-slate-string="true">   Driver       </span></span></span><span data-slate-object="text" data-key="217"><span data-slate-leaf="true" data-offset-key="217:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="218"><span data-slate-leaf="true" data-offset-key="218:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="219"><span data-slate-leaf="true" data-offset-key="219:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"driver"`</span></span></span></span><span data-slate-object="text" data-key="220"><span data-slate-leaf="true" data-offset-key="220:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="221"><span data-slate-leaf="true" data-offset-key="221:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 驱动</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="222"><span data-slate-object="text" data-key="223"><span data-slate-leaf="true" data-offset-key="223:0" data-first-offset="true"><span data-slate-string="true">   Host         </span></span></span><span data-slate-object="text" data-key="224"><span data-slate-leaf="true" data-offset-key="224:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="225"><span data-slate-leaf="true" data-offset-key="225:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="226"><span data-slate-leaf="true" data-offset-key="226:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"host"`</span></span></span></span><span data-slate-object="text" data-key="227"><span data-slate-leaf="true" data-offset-key="227:0" data-first-offset="true"><span data-slate-string="true">          </span></span></span><span data-slate-object="text" data-key="228"><span data-slate-leaf="true" data-offset-key="228:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 数据库地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="229"></div><div data-slate-type="code-line" data-slate-object="block" data-key="230"><span data-slate-object="text" data-key="231"><span data-slate-leaf="true" data-offset-key="231:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="232"><span data-slate-leaf="true" data-offset-key="232:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 以下配置关于连接池</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="233"><span data-slate-object="text" data-key="234"><span data-slate-leaf="true" data-offset-key="234:0" data-first-offset="true"><span data-slate-string="true">   ConnMaxIdle     </span></span></span><span data-slate-object="text" data-key="235"><span data-slate-leaf="true" data-offset-key="235:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="236"><span data-slate-leaf="true" data-offset-key="236:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="237"><span data-slate-leaf="true" data-offset-key="237:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"conn_max_idle"`</span></span></span></span><span data-slate-object="text" data-key="238"><span data-slate-leaf="true" data-offset-key="238:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="239"><span data-slate-leaf="true" data-offset-key="239:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 最大空闲连接数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="240"><span data-slate-object="text" data-key="241"><span data-slate-leaf="true" data-offset-key="241:0" data-first-offset="true"><span data-slate-string="true">   ConnMaxOpen     </span></span></span><span data-slate-object="text" data-key="242"><span data-slate-leaf="true" data-offset-key="242:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int</span></span></span></span><span data-slate-object="text" data-key="243"><span data-slate-leaf="true" data-offset-key="243:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="244"><span data-slate-leaf="true" data-offset-key="244:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"conn_max_open"`</span></span></span></span><span data-slate-object="text" data-key="245"><span data-slate-leaf="true" data-offset-key="245:0" data-first-offset="true"><span data-slate-string="true">     </span></span></span><span data-slate-object="text" data-key="246"><span data-slate-leaf="true" data-offset-key="246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 最大连接数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="247"><span data-slate-object="text" data-key="248"><span data-slate-leaf="true" data-offset-key="248:0" data-first-offset="true"><span data-slate-string="true">   ConnMaxLifetime </span></span></span><span data-slate-object="text" data-key="249"><span data-slate-leaf="true" data-offset-key="249:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="250"><span data-slate-leaf="true" data-offset-key="250:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="251"><span data-slate-leaf="true" data-offset-key="251:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"conn_max_lifetime"`</span></span></span></span><span data-slate-object="text" data-key="252"><span data-slate-leaf="true" data-offset-key="252:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="253"><span data-slate-leaf="true" data-offset-key="253:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 连接最大生命周期</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="254"><span data-slate-object="text" data-key="255"><span data-slate-leaf="true" data-offset-key="255:0" data-first-offset="true"><span data-slate-string="true">   ConnMaxIdletime </span></span></span><span data-slate-object="text" data-key="256"><span data-slate-leaf="true" data-offset-key="256:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="257"><span data-slate-leaf="true" data-offset-key="257:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="258"><span data-slate-leaf="true" data-offset-key="258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">`yaml:"conn_max_idletime"`</span></span></span></span><span data-slate-object="text" data-key="259"><span data-slate-leaf="true" data-offset-key="259:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="260"><span data-slate-leaf="true" data-offset-key="260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 空闲最大生命周期</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="261"></div><div data-slate-type="code-line" data-slate-object="block" data-key="262"><span data-slate-object="text" data-key="263"><span data-slate-leaf="true" data-offset-key="263:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="264"><span data-slate-leaf="true" data-offset-key="264:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 以下配置关于 gorm</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="265"><span data-slate-object="text" data-key="266"><span data-slate-leaf="true" data-offset-key="266:0" data-first-offset="true"><span data-slate-string="true">   *gorm.Config </span></span></span><span data-slate-object="text" data-key="267"><span data-slate-leaf="true" data-offset-key="267:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 集成 gorm 的配置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="268"><span data-slate-object="text" data-key="269"><span data-slate-leaf="true" data-offset-key="269:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="270"><span data-slate-object="text" data-key="271"><span data-slate-leaf="true" data-offset-key="271:0" data-first-offset="true"><span data-slate-string="true">其中 DSN 是一个复杂的字符串。但我们又不希望使用者直接设置这些复杂字符串来进行传递，所以这里设置了多个字段来生成这个 DSN。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="272"><span data-slate-object="text" data-key="273"><span data-slate-leaf="true" data-offset-key="273:0" data-first-offset="true"><span data-slate-string="true">另外上节课也说过，DSN 并没有一个标准的格式约定，不同的数据库可能有不同的解析，所以也同时保留直接设置 DSN 的权限，如果用户手动设置了 Dsn 字段，那么其他关于 Dsn 的字段设置均无效。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="274"><span data-slate-object="text" data-key="275"><span data-slate-leaf="true" data-offset-key="275:0" data-first-offset="true"><span data-slate-string="true">所以这里同时需要实现一个方法，使用 DBConfig 来生成最终使用的字符串 Dsn，使用上节课介绍的 github.com/go-sql-driver/mysql 库，就能很方便地实现了。我们继续写：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="276"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="277"><span data-slate-object="text" data-key="278"><span data-slate-leaf="true" data-offset-key="278:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="279"><span data-slate-leaf="true" data-offset-key="279:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="280"><span data-slate-object="text" data-key="281"><span data-slate-leaf="true" data-offset-key="281:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="282"><span data-slate-leaf="true" data-offset-key="282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"github.com/go-sql-driver/mysql"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="283"><span data-slate-object="text" data-key="284"><span data-slate-leaf="true" data-offset-key="284:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="285"><span data-slate-object="text" data-key="286"><span data-slate-leaf="true" data-offset-key="286:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="287"></div><div data-slate-type="code-line" data-slate-object="block" data-key="288"><span data-slate-object="text" data-key="289"><span data-slate-leaf="true" data-offset-key="289:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// FormatDsn 生成 dsn</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="290"><span data-slate-object="text" data-key="291"><span data-slate-leaf="true" data-offset-key="291:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="292"><span data-slate-leaf="true" data-offset-key="292:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="293"><span data-slate-leaf="true" data-offset-key="293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(conf *DBConfig)</span></span></span></span></span><span data-slate-object="text" data-key="294"><span data-slate-leaf="true" data-offset-key="294:0" data-first-offset="true"><span data-slate-string="true"> FormatDsn() (</span></span></span><span data-slate-object="text" data-key="295"><span data-slate-leaf="true" data-offset-key="295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="296"><span data-slate-leaf="true" data-offset-key="296:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="297"><span data-slate-leaf="true" data-offset-key="297:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="298"><span data-slate-leaf="true" data-offset-key="298:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="299"><span data-slate-object="text" data-key="300"><span data-slate-leaf="true" data-offset-key="300:0" data-first-offset="true"><span data-slate-string="true">   port := strconv.Itoa(conf.Port)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="301"><span data-slate-object="text" data-key="302"><span data-slate-leaf="true" data-offset-key="302:0" data-first-offset="true"><span data-slate-string="true">   timeout, err := time.ParseDuration(conf.Timeout)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="303"><span data-slate-object="text" data-key="304"><span data-slate-leaf="true" data-offset-key="304:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="305"><span data-slate-leaf="true" data-offset-key="305:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="306"><span data-slate-leaf="true" data-offset-key="306:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="307"><span data-slate-leaf="true" data-offset-key="307:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="308"><span data-slate-leaf="true" data-offset-key="308:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="309"><span data-slate-object="text" data-key="310"><span data-slate-leaf="true" data-offset-key="310:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="311"><span data-slate-leaf="true" data-offset-key="311:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="312"><span data-slate-leaf="true" data-offset-key="312:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="313"><span data-slate-leaf="true" data-offset-key="313:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="314"><span data-slate-leaf="true" data-offset-key="314:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="315"><span data-slate-object="text" data-key="316"><span data-slate-leaf="true" data-offset-key="316:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="317"><span data-slate-object="text" data-key="318"><span data-slate-leaf="true" data-offset-key="318:0" data-first-offset="true"><span data-slate-string="true">   readTimeout, err := time.ParseDuration(conf.ReadTimeout)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="319"><span data-slate-object="text" data-key="320"><span data-slate-leaf="true" data-offset-key="320:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="321"><span data-slate-leaf="true" data-offset-key="321:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="322"><span data-slate-leaf="true" data-offset-key="322:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="323"><span data-slate-leaf="true" data-offset-key="323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="324"><span data-slate-leaf="true" data-offset-key="324:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="325"><span data-slate-object="text" data-key="326"><span data-slate-leaf="true" data-offset-key="326:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="327"><span data-slate-leaf="true" data-offset-key="327:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="328"><span data-slate-leaf="true" data-offset-key="328:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="329"><span data-slate-leaf="true" data-offset-key="329:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="330"><span data-slate-leaf="true" data-offset-key="330:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="331"><span data-slate-object="text" data-key="332"><span data-slate-leaf="true" data-offset-key="332:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="333"><span data-slate-object="text" data-key="334"><span data-slate-leaf="true" data-offset-key="334:0" data-first-offset="true"><span data-slate-string="true">   writeTimeout, err := time.ParseDuration(conf.WriteTimeout)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="335"><span data-slate-object="text" data-key="336"><span data-slate-leaf="true" data-offset-key="336:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="337"><span data-slate-leaf="true" data-offset-key="337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="338"><span data-slate-leaf="true" data-offset-key="338:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="339"><span data-slate-leaf="true" data-offset-key="339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="340"><span data-slate-leaf="true" data-offset-key="340:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="341"><span data-slate-object="text" data-key="342"><span data-slate-leaf="true" data-offset-key="342:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="343"><span data-slate-leaf="true" data-offset-key="343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="344"><span data-slate-leaf="true" data-offset-key="344:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="345"><span data-slate-leaf="true" data-offset-key="345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="346"><span data-slate-leaf="true" data-offset-key="346:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="347"><span data-slate-object="text" data-key="348"><span data-slate-leaf="true" data-offset-key="348:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="349"><span data-slate-object="text" data-key="350"><span data-slate-leaf="true" data-offset-key="350:0" data-first-offset="true"><span data-slate-string="true">   location, err := time.LoadLocation(conf.Loc)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="351"><span data-slate-object="text" data-key="352"><span data-slate-leaf="true" data-offset-key="352:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="353"><span data-slate-leaf="true" data-offset-key="353:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="354"><span data-slate-leaf="true" data-offset-key="354:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="355"><span data-slate-leaf="true" data-offset-key="355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="356"><span data-slate-leaf="true" data-offset-key="356:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="357"><span data-slate-object="text" data-key="358"><span data-slate-leaf="true" data-offset-key="358:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="359"><span data-slate-leaf="true" data-offset-key="359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="360"><span data-slate-leaf="true" data-offset-key="360:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="361"><span data-slate-leaf="true" data-offset-key="361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="362"><span data-slate-leaf="true" data-offset-key="362:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="363"><span data-slate-object="text" data-key="364"><span data-slate-leaf="true" data-offset-key="364:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="365"><span data-slate-object="text" data-key="366"><span data-slate-leaf="true" data-offset-key="366:0" data-first-offset="true"><span data-slate-string="true">   driverConf := &amp;mysql.Config{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="367"><span data-slate-object="text" data-key="368"><span data-slate-leaf="true" data-offset-key="368:0" data-first-offset="true"><span data-slate-string="true">      User:         conf.Username,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="369"><span data-slate-object="text" data-key="370"><span data-slate-leaf="true" data-offset-key="370:0" data-first-offset="true"><span data-slate-string="true">      Passwd:       conf.Password,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="371"><span data-slate-object="text" data-key="372"><span data-slate-leaf="true" data-offset-key="372:0" data-first-offset="true"><span data-slate-string="true">      Net:          conf.Protocol,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="373"><span data-slate-object="text" data-key="374"><span data-slate-leaf="true" data-offset-key="374:0" data-first-offset="true"><span data-slate-string="true">      Addr:         net.JoinHostPort(conf.Host, port),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="375"><span data-slate-object="text" data-key="376"><span data-slate-leaf="true" data-offset-key="376:0" data-first-offset="true"><span data-slate-string="true">      DBName:       conf.Database,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="377"><span data-slate-object="text" data-key="378"><span data-slate-leaf="true" data-offset-key="378:0" data-first-offset="true"><span data-slate-string="true">      Collation:    conf.Collation,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="379"><span data-slate-object="text" data-key="380"><span data-slate-leaf="true" data-offset-key="380:0" data-first-offset="true"><span data-slate-string="true">      Loc:          location,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="381"><span data-slate-object="text" data-key="382"><span data-slate-leaf="true" data-offset-key="382:0" data-first-offset="true"><span data-slate-string="true">      Timeout:      timeout,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="383"><span data-slate-object="text" data-key="384"><span data-slate-leaf="true" data-offset-key="384:0" data-first-offset="true"><span data-slate-string="true">      ReadTimeout:  readTimeout,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="385"><span data-slate-object="text" data-key="386"><span data-slate-leaf="true" data-offset-key="386:0" data-first-offset="true"><span data-slate-string="true">      WriteTimeout: writeTimeout,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="387"><span data-slate-object="text" data-key="388"><span data-slate-leaf="true" data-offset-key="388:0" data-first-offset="true"><span data-slate-string="true">      ParseTime:    conf.ParseTime,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="389"><span data-slate-object="text" data-key="390"><span data-slate-leaf="true" data-offset-key="390:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="391"><span data-slate-object="text" data-key="392"><span data-slate-leaf="true" data-offset-key="392:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="393"><span data-slate-leaf="true" data-offset-key="393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="394"><span data-slate-leaf="true" data-offset-key="394:0" data-first-offset="true"><span data-slate-string="true"> driverConf.FormatDSN(), </span></span></span><span data-slate-object="text" data-key="395"><span data-slate-leaf="true" data-offset-key="395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="396"><span data-slate-object="text" data-key="397"><span data-slate-leaf="true" data-offset-key="397:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="398"><span data-slate-object="text" data-key="399"><span data-slate-leaf="true" data-offset-key="399:0" data-first-offset="true"><span data-slate-string="true">可以看到 Gorm 配置，我们使用结构嵌套的方式，将 gorm.Config 直接嵌套进入 DBConfig 中。你可以琢磨下这种写法，它有两个好处。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="400"><span data-slate-object="text" data-key="401"><span data-slate-leaf="true" data-offset-key="401:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">一是可以直接设置 DBConfig 来设置 gorm.Config</span></span></span></span><span data-slate-object="text" data-key="402"><span data-slate-leaf="true" data-offset-key="402:0" data-first-offset="true"><span data-slate-string="true">。比如这个函数是可行的，它直接设置 config.DryRun，就是直接设置 gorm.Config：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="403"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="404"><span data-slate-object="text" data-key="405"><span data-slate-leaf="true" data-offset-key="405:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="406"><span data-slate-leaf="true" data-offset-key="406:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(container framework.Container, config *contract.DBConfig)</span></span></span></span></span><span data-slate-object="text" data-key="407"><span data-slate-leaf="true" data-offset-key="407:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="408"><span data-slate-leaf="true" data-offset-key="408:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="409"><span data-slate-leaf="true" data-offset-key="409:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="410"><span data-slate-object="text" data-key="411"><span data-slate-leaf="true" data-offset-key="411:0" data-first-offset="true"><span data-slate-string="true">   config.DryRun = </span></span></span><span data-slate-object="text" data-key="412"><span data-slate-leaf="true" data-offset-key="412:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="413"><span data-slate-object="text" data-key="414"><span data-slate-leaf="true" data-offset-key="414:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="415"><span data-slate-leaf="true" data-offset-key="415:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="416"><span data-slate-leaf="true" data-offset-key="416:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="417"><span data-slate-leaf="true" data-offset-key="417:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="418"><span data-slate-object="text" data-key="419"><span data-slate-leaf="true" data-offset-key="419:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="420"><span data-slate-object="text" data-key="421"><span data-slate-leaf="true" data-offset-key="421:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">二是 DBConfig 继承了 *gorm.Config 的所有方法</span></span></span></span><span data-slate-object="text" data-key="422"><span data-slate-leaf="true" data-offset-key="422:0" data-first-offset="true"><span data-slate-string="true">。比如这段代码，我们来理解一下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="423"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="424"><span data-slate-object="text" data-key="425"><span data-slate-leaf="true" data-offset-key="425:0" data-first-offset="true"><span data-slate-string="true">config := &amp;contract.DBConfig{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="426"><span data-slate-object="text" data-key="427"><span data-slate-leaf="true" data-offset-key="427:0" data-first-offset="true"><span data-slate-string="true">db, err = gorm.Open(mysql.Open(config.Dsn), config)</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="428"><span data-slate-object="text" data-key="429"><span data-slate-leaf="true" data-offset-key="429:0" data-first-offset="true"><span data-slate-string="true">还记得 gorm.Open 的第二个参数是 Option 么，它是一个接口，需要实现 Apply 和 AfterInitialize 方法，而我们的 DBConfig 并没有显式实现这两个方法。但是它嵌套了实现了这两个方法的 *gorm.Config，所以，默认 DB.Config 也就实现了这两个方法。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="430"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="431"><span data-slate-object="text" data-key="432"><span data-slate-leaf="true" data-offset-key="432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="433"><span data-slate-leaf="true" data-offset-key="433:0" data-first-offset="true"><span data-slate-string="true"> Option </span></span></span><span data-slate-object="text" data-key="434"><span data-slate-leaf="true" data-offset-key="434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="435"><span data-slate-leaf="true" data-offset-key="435:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="436"><span data-slate-object="text" data-key="437"><span data-slate-leaf="true" data-offset-key="437:0" data-first-offset="true"><span data-slate-string="true">   Apply(*Config) </span></span></span><span data-slate-object="text" data-key="438"><span data-slate-leaf="true" data-offset-key="438:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="439"><span data-slate-object="text" data-key="440"><span data-slate-leaf="true" data-offset-key="440:0" data-first-offset="true"><span data-slate-string="true">   AfterInitialize(*DB) </span></span></span><span data-slate-object="text" data-key="441"><span data-slate-leaf="true" data-offset-key="441:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="442"><span data-slate-object="text" data-key="443"><span data-slate-leaf="true" data-offset-key="443:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="444"><span data-slate-object="text" data-key="445"><span data-slate-leaf="true" data-offset-key="445:0" data-first-offset="true"><span data-slate-string="true">现在，gorm.Open 的两个参数 DSN 和 gorm.Config 都封装在 DBConfig 中，而修改 DBConfig 的方法，我们封装为 DBOption。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="446"><span data-slate-object="text" data-key="447"><span data-slate-leaf="true" data-offset-key="447:0" data-first-offset="true"><span data-slate-string="true">如何让设置 DBOption 的方法更为优雅呢？这里就使用到上节课刚学到的 Option 可变参数的编程方法了。定义一个 DBOption 的结构，它代表一个可以对 DBConfig 进行设置的方法，这个结构作为获取 ORM 服务 GetDB 方法的参数。在 framework/contract/orm.go 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="448"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="449"><span data-slate-object="text" data-key="450"><span data-slate-leaf="true" data-offset-key="450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="451"><span data-slate-leaf="true" data-offset-key="451:0" data-first-offset="true"><span data-slate-string="true"> contract</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="452"></div><div data-slate-type="code-line" data-slate-object="block" data-key="453"><span data-slate-object="text" data-key="454"><span data-slate-leaf="true" data-offset-key="454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ORMKey 代表 ORM 的服务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="455"><span data-slate-object="text" data-key="456"><span data-slate-leaf="true" data-offset-key="456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="457"><span data-slate-leaf="true" data-offset-key="457:0" data-first-offset="true"><span data-slate-string="true"> ORMKey = </span></span></span><span data-slate-object="text" data-key="458"><span data-slate-leaf="true" data-offset-key="458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"hade:orm"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="459"></div><div data-slate-type="code-line" data-slate-object="block" data-key="460"><span data-slate-object="text" data-key="461"><span data-slate-leaf="true" data-offset-key="461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// ORMService 表示传入的参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="462"><span data-slate-object="text" data-key="463"><span data-slate-leaf="true" data-offset-key="463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="464"><span data-slate-leaf="true" data-offset-key="464:0" data-first-offset="true"><span data-slate-string="true"> ORMService </span></span></span><span data-slate-object="text" data-key="465"><span data-slate-leaf="true" data-offset-key="465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="466"><span data-slate-leaf="true" data-offset-key="466:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="467"><span data-slate-object="text" data-key="468"><span data-slate-leaf="true" data-offset-key="468:0" data-first-offset="true"><span data-slate-string="true">   GetDB(option ...DBOption) (*gorm.DB, </span></span></span><span data-slate-object="text" data-key="469"><span data-slate-leaf="true" data-offset-key="469:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="470"><span data-slate-leaf="true" data-offset-key="470:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="471"><span data-slate-object="text" data-key="472"><span data-slate-leaf="true" data-offset-key="472:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="473"></div><div data-slate-type="code-line" data-slate-object="block" data-key="474"><span data-slate-object="text" data-key="475"><span data-slate-leaf="true" data-offset-key="475:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// DBOption 代表初始化的时候的选项</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="476"><span data-slate-object="text" data-key="477"><span data-slate-leaf="true" data-offset-key="477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="478"><span data-slate-leaf="true" data-offset-key="478:0" data-first-offset="true"><span data-slate-string="true"> DBOption </span></span></span><span data-slate-object="text" data-key="479"><span data-slate-leaf="true" data-offset-key="479:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="480"><span data-slate-leaf="true" data-offset-key="480:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(container framework.Container, config *DBConfig)</span></span></span></span></span><span data-slate-object="text" data-key="481"><span data-slate-leaf="true" data-offset-key="481:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="482"><span data-slate-leaf="true" data-offset-key="482:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="483"><span data-slate-object="text" data-key="484"><span data-slate-leaf="true" data-offset-key="484:0" data-first-offset="true"><span data-slate-string="true">这样就能通过设置不同的方法来对 DBConfig 进行配置。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="485"><span data-slate-object="text" data-key="486"><span data-slate-leaf="true" data-offset-key="486:0" data-first-offset="true"><span data-slate-string="true">比如要设置 DBConfig 中 gorm.Config 的 DryRun 空跑字段，设计了这么一个方法在 framework/provider/orm/config.go 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="487"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="488"><span data-slate-object="text" data-key="489"><span data-slate-leaf="true" data-offset-key="489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// WithDryRun 设置空跑模式</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="490"><span data-slate-object="text" data-key="491"><span data-slate-leaf="true" data-offset-key="491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="492"><span data-slate-leaf="true" data-offset-key="492:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="493"><span data-slate-leaf="true" data-offset-key="493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WithDryRun</span></span></span></span></span><span data-slate-object="text" data-key="494"><span data-slate-leaf="true" data-offset-key="494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="495"><span data-slate-leaf="true" data-offset-key="495:0" data-first-offset="true"><span data-slate-string="true"> contract.DBOption {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="496"><span data-slate-object="text" data-key="497"><span data-slate-leaf="true" data-offset-key="497:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="498"><span data-slate-leaf="true" data-offset-key="498:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="499"><span data-slate-leaf="true" data-offset-key="499:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="500"><span data-slate-leaf="true" data-offset-key="500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="501"><span data-slate-leaf="true" data-offset-key="501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(container framework.Container, config *contract.DBConfig)</span></span></span></span></span><span data-slate-object="text" data-key="502"><span data-slate-leaf="true" data-offset-key="502:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="503"><span data-slate-leaf="true" data-offset-key="503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="504"><span data-slate-leaf="true" data-offset-key="504:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="505"><span data-slate-object="text" data-key="506"><span data-slate-leaf="true" data-offset-key="506:0" data-first-offset="true"><span data-slate-string="true">      config.DryRun = </span></span></span><span data-slate-object="text" data-key="507"><span data-slate-leaf="true" data-offset-key="507:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="508"><span data-slate-object="text" data-key="509"><span data-slate-leaf="true" data-offset-key="509:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="510"><span data-slate-leaf="true" data-offset-key="510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="511"><span data-slate-leaf="true" data-offset-key="511:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="512"><span data-slate-leaf="true" data-offset-key="512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="513"><span data-slate-object="text" data-key="514"><span data-slate-leaf="true" data-offset-key="514:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="515"><span data-slate-object="text" data-key="516"><span data-slate-leaf="true" data-offset-key="516:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="517"><span data-slate-object="text" data-key="518"><span data-slate-leaf="true" data-offset-key="518:0" data-first-offset="true"><span data-slate-string="true">之后，在使用 ORM 服务的时候，我们就可以这样设置：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="519"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="520"><span data-slate-object="text" data-key="521"><span data-slate-leaf="true" data-offset-key="521:0" data-first-offset="true"><span data-slate-string="true">gormService := c.MustMake(contract.ORMKey).(contract.ORMService)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="522"><span data-slate-object="text" data-key="523"><span data-slate-leaf="true" data-offset-key="523:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 可变参数为 WithDryRun ()</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="524"><span data-slate-object="text" data-key="525"><span data-slate-leaf="true" data-offset-key="525:0" data-first-offset="true"><span data-slate-string="true">db, err := gormService.GetDB(orm.WithDryRun())</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="526" id="sr-toc-3"><span data-slate-object="text" data-key="527"><span data-slate-leaf="true" data-offset-key="527:0" data-first-offset="true"><span data-slate-string="true">服务提供者</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="528"><span data-slate-object="text" data-key="529"><span data-slate-leaf="true" data-offset-key="529:0" data-first-offset="true"><span data-slate-string="true">下一步来完成服务提供者，我们也并不需要过于复杂的设计，只要注意一下两点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="530"><div data-slate-type="list-line" data-slate-object="block" data-key="531"><span data-slate-object="text" data-key="532"><span data-slate-leaf="true" data-offset-key="532:0" data-first-offset="true"><span data-slate-string="true">ORM 服务一定是要延迟加载的，因为这个服务并不是一个基础服务。如果设置为非延迟加载，在框架启动的时候就会去建立这个服务，这并不是我们想要的。所以我们设计 ORM 的 provider 的时候，需要将 IsDefer 函数设置为 true。</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="533"><span data-slate-object="text" data-key="534"><span data-slate-leaf="true" data-offset-key="534:0" data-first-offset="true"><span data-slate-string="true">第二点考虑到我们后续会使用 container 中的配置服务，来创建具体的 gorm.DB 实例，传递一个 container 是必要的。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="535"><span data-slate-object="text" data-key="536"><span data-slate-leaf="true" data-offset-key="536:0" data-first-offset="true"><span data-slate-string="true">所以具体的服务提供者代码如下，在 framework/provider/orm/provider.go 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="537"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="538"><span data-slate-object="text" data-key="539"><span data-slate-leaf="true" data-offset-key="539:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">package</span></span></span></span><span data-slate-object="text" data-key="540"><span data-slate-leaf="true" data-offset-key="540:0" data-first-offset="true"><span data-slate-string="true"> orm</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="541"></div><div data-slate-type="code-line" data-slate-object="block" data-key="542"><span data-slate-object="text" data-key="543"><span data-slate-leaf="true" data-offset-key="543:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">import</span></span></span></span><span data-slate-object="text" data-key="544"><span data-slate-leaf="true" data-offset-key="544:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="545"><span data-slate-object="text" data-key="546"><span data-slate-leaf="true" data-offset-key="546:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="547"><span data-slate-leaf="true" data-offset-key="547:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"github.com/gohade/hade/framework"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="548"><span data-slate-object="text" data-key="549"><span data-slate-leaf="true" data-offset-key="549:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="550"><span data-slate-leaf="true" data-offset-key="550:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"github.com/gohade/hade/framework/contract"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="551"><span data-slate-object="text" data-key="552"><span data-slate-leaf="true" data-offset-key="552:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="553"></div><div data-slate-type="code-line" data-slate-object="block" data-key="554"><span data-slate-object="text" data-key="555"><span data-slate-leaf="true" data-offset-key="555:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// GormProvider 提供 App 的具体实现方法</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="556"><span data-slate-object="text" data-key="557"><span data-slate-leaf="true" data-offset-key="557:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="558"><span data-slate-leaf="true" data-offset-key="558:0" data-first-offset="true"><span data-slate-string="true"> GormProvider </span></span></span><span data-slate-object="text" data-key="559"><span data-slate-leaf="true" data-offset-key="559:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="560"><span data-slate-leaf="true" data-offset-key="560:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="561"><span data-slate-object="text" data-key="562"><span data-slate-leaf="true" data-offset-key="562:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="563"></div><div data-slate-type="code-line" data-slate-object="block" data-key="564"><span data-slate-object="text" data-key="565"><span data-slate-leaf="true" data-offset-key="565:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Register 注册方法</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="566"><span data-slate-object="text" data-key="567"><span data-slate-leaf="true" data-offset-key="567:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="568"><span data-slate-leaf="true" data-offset-key="568:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="569"><span data-slate-leaf="true" data-offset-key="569:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(h *GormProvider)</span></span></span></span></span><span data-slate-object="text" data-key="570"><span data-slate-leaf="true" data-offset-key="570:0" data-first-offset="true"><span data-slate-string="true"> Register(container framework.Container) framework.NewInstance {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="571"><span data-slate-object="text" data-key="572"><span data-slate-leaf="true" data-offset-key="572:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="573"><span data-slate-leaf="true" data-offset-key="573:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="574"><span data-slate-leaf="true" data-offset-key="574:0" data-first-offset="true"><span data-slate-string="true"> NewHadeGorm</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="575"><span data-slate-object="text" data-key="576"><span data-slate-leaf="true" data-offset-key="576:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="577"></div><div data-slate-type="code-line" data-slate-object="block" data-key="578"><span data-slate-object="text" data-key="579"><span data-slate-leaf="true" data-offset-key="579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Boot 启动调用</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="580"><span data-slate-object="text" data-key="581"><span data-slate-leaf="true" data-offset-key="581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="582"><span data-slate-leaf="true" data-offset-key="582:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="583"><span data-slate-leaf="true" data-offset-key="583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(h *GormProvider)</span></span></span></span></span><span data-slate-object="text" data-key="584"><span data-slate-leaf="true" data-offset-key="584:0" data-first-offset="true"><span data-slate-string="true"> Boot(container framework.Container) </span></span></span><span data-slate-object="text" data-key="585"><span data-slate-leaf="true" data-offset-key="585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="586"><span data-slate-leaf="true" data-offset-key="586:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="587"><span data-slate-object="text" data-key="588"><span data-slate-leaf="true" data-offset-key="588:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="589"><span data-slate-leaf="true" data-offset-key="589:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="590"><span data-slate-leaf="true" data-offset-key="590:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="591"><span data-slate-leaf="true" data-offset-key="591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="592"><span data-slate-object="text" data-key="593"><span data-slate-leaf="true" data-offset-key="593:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="594"></div><div data-slate-type="code-line" data-slate-object="block" data-key="595"><span data-slate-object="text" data-key="596"><span data-slate-leaf="true" data-offset-key="596:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// IsDefer 是否延迟初始化</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="597"><span data-slate-object="text" data-key="598"><span data-slate-leaf="true" data-offset-key="598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="599"><span data-slate-leaf="true" data-offset-key="599:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="600"><span data-slate-leaf="true" data-offset-key="600:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(h *GormProvider)</span></span></span></span></span><span data-slate-object="text" data-key="601"><span data-slate-leaf="true" data-offset-key="601:0" data-first-offset="true"><span data-slate-string="true"> IsDefer() </span></span></span><span data-slate-object="text" data-key="602"><span data-slate-leaf="true" data-offset-key="602:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="603"><span data-slate-leaf="true" data-offset-key="603:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="604"><span data-slate-object="text" data-key="605"><span data-slate-leaf="true" data-offset-key="605:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="606"><span data-slate-leaf="true" data-offset-key="606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="607"><span data-slate-leaf="true" data-offset-key="607:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="608"><span data-slate-leaf="true" data-offset-key="608:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="609"><span data-slate-object="text" data-key="610"><span data-slate-leaf="true" data-offset-key="610:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="611"></div><div data-slate-type="code-line" data-slate-object="block" data-key="612"><span data-slate-object="text" data-key="613"><span data-slate-leaf="true" data-offset-key="613:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Params 获取初始化参数</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="614"><span data-slate-object="text" data-key="615"><span data-slate-leaf="true" data-offset-key="615:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="616"><span data-slate-leaf="true" data-offset-key="616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="617"><span data-slate-leaf="true" data-offset-key="617:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(h *GormProvider)</span></span></span></span></span><span data-slate-object="text" data-key="618"><span data-slate-leaf="true" data-offset-key="618:0" data-first-offset="true"><span data-slate-string="true"> Params(container framework.Container) []</span></span></span><span data-slate-object="text" data-key="619"><span data-slate-leaf="true" data-offset-key="619:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="620"><span data-slate-leaf="true" data-offset-key="620:0" data-first-offset="true"><span data-slate-string="true">{} {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="621"><span data-slate-object="text" data-key="622"><span data-slate-leaf="true" data-offset-key="622:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="623"><span data-slate-leaf="true" data-offset-key="623:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="624"><span data-slate-leaf="true" data-offset-key="624:0" data-first-offset="true"><span data-slate-string="true"> []</span></span></span><span data-slate-object="text" data-key="625"><span data-slate-leaf="true" data-offset-key="625:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="626"><span data-slate-leaf="true" data-offset-key="626:0" data-first-offset="true"><span data-slate-string="true">{}{container}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="627"><span data-slate-object="text" data-key="628"><span data-slate-leaf="true" data-offset-key="628:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="629"></div><div data-slate-type="code-line" data-slate-object="block" data-key="630"><span data-slate-object="text" data-key="631"><span data-slate-leaf="true" data-offset-key="631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Name 获取字符串凭证</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="632"><span data-slate-object="text" data-key="633"><span data-slate-leaf="true" data-offset-key="633:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="634"><span data-slate-leaf="true" data-offset-key="634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="635"><span data-slate-leaf="true" data-offset-key="635:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(h *GormProvider)</span></span></span></span></span><span data-slate-object="text" data-key="636"><span data-slate-leaf="true" data-offset-key="636:0" data-first-offset="true"><span data-slate-string="true"> Name() </span></span></span><span data-slate-object="text" data-key="637"><span data-slate-leaf="true" data-offset-key="637:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="638"><span data-slate-leaf="true" data-offset-key="638:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="639"><span data-slate-object="text" data-key="640"><span data-slate-leaf="true" data-offset-key="640:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="641"><span data-slate-leaf="true" data-offset-key="641:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="642"><span data-slate-leaf="true" data-offset-key="642:0" data-first-offset="true"><span data-slate-string="true"> contract.ORMKey</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="643"><span data-slate-object="text" data-key="644"><span data-slate-leaf="true" data-offset-key="644:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h2 data-slate-type="heading" data-slate-object="block" data-key="645" id="sr-toc-4"><span data-slate-object="text" data-key="646"><span data-slate-leaf="true" data-offset-key="646:0" data-first-offset="true"><span data-slate-string="true">服务实例化</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="647"><span data-slate-object="text" data-key="648"><span data-slate-leaf="true" data-offset-key="648:0" data-first-offset="true"><span data-slate-string="true">服务实例化是今天的重点内容，我们先把 Gorm 的配置结构和日志结构的准备工作完成，再写稍微复杂一点的具体 ORM 服务的实例 HadeGorm。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="649" id="sr-toc-5"><span data-slate-object="text" data-key="650"><span data-slate-leaf="true" data-offset-key="650:0" data-first-offset="true"><span data-slate-string="true">配置</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="651"><span data-slate-object="text" data-key="652"><span data-slate-leaf="true" data-offset-key="652:0" data-first-offset="true"><span data-slate-string="true">前面定义了 hade 框架专属的 DBConfig 配置结构，如何设置它是一个需要讲究的问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="653"><span data-slate-object="text" data-key="654"><span data-slate-leaf="true" data-offset-key="654:0" data-first-offset="true"><span data-slate-string="true">虽然已经设计了一种修改配置文件的方式，就是通过 GetDB 中的 Option 参数来设置。但是每个字段都这么设置又非常麻烦，我们自然会想到使用配置文件来配置这个结构。另外如果要连接多个数据库，每个数据库都进行同样的配置，还是颇为麻烦，是不是可以有个默认配置呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="655"><span data-slate-object="text" data-key="656"><span data-slate-leaf="true" data-offset-key="656:0" data-first-offset="true"><span data-slate-string="true">于是我们的配置文件可以这样设计：在 database.yaml 中保存数据库的默认值，如果想对某个数据库连接有单独的配置，可以用内嵌 yaml 结构的方式来进行配置。看下面这个配置例子：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="657"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="658"><span data-slate-object="text" data-key="659"><span data-slate-leaf="true" data-offset-key="659:0" data-first-offset="true"><span data-slate-string="true">conn_max_idle: </span></span></span><span data-slate-object="text" data-key="660"><span data-slate-leaf="true" data-offset-key="660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="661"><span data-slate-leaf="true" data-offset-key="661:0" data-first-offset="true"><span data-slate-string="true"> # 通用配置，连接池最大空闲连接数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="662"><span data-slate-object="text" data-key="663"><span data-slate-leaf="true" data-offset-key="663:0" data-first-offset="true"><span data-slate-string="true">conn_max_open: </span></span></span><span data-slate-object="text" data-key="664"><span data-slate-leaf="true" data-offset-key="664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">100</span></span></span></span><span data-slate-object="text" data-key="665"><span data-slate-leaf="true" data-offset-key="665:0" data-first-offset="true"><span data-slate-string="true"> # 通用配置，连接池最大连接数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="666"><span data-slate-object="text" data-key="667"><span data-slate-leaf="true" data-offset-key="667:0" data-first-offset="true"><span data-slate-string="true">conn_max_lifetime: </span></span></span><span data-slate-object="text" data-key="668"><span data-slate-leaf="true" data-offset-key="668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="669"><span data-slate-leaf="true" data-offset-key="669:0" data-first-offset="true"><span data-slate-string="true">h # 通用配置，连接数最大生命周期</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="670"><span data-slate-object="text" data-key="671"><span data-slate-leaf="true" data-offset-key="671:0" data-first-offset="true"><span data-slate-string="true">protocol: tcp # 通用配置，传输协议</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="672"><span data-slate-object="text" data-key="673"><span data-slate-leaf="true" data-offset-key="673:0" data-first-offset="true"><span data-slate-string="true">loc: Local # 通用配置，时区</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="674"></div><div data-slate-type="code-line" data-slate-object="block" data-key="675"><span data-slate-object="text" data-key="676"><span data-slate-leaf="true" data-offset-key="676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="677"><span data-slate-leaf="true" data-offset-key="677:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="678"><span data-slate-object="text" data-key="679"><span data-slate-leaf="true" data-offset-key="679:0" data-first-offset="true"><span data-slate-string="true">    driver: mysql # 连接驱动</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="680"><span data-slate-object="text" data-key="681"><span data-slate-leaf="true" data-offset-key="681:0" data-first-offset="true"><span data-slate-string="true">    dsn: </span></span></span><span data-slate-object="text" data-key="682"><span data-slate-leaf="true" data-offset-key="682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="683"><span data-slate-leaf="true" data-offset-key="683:0" data-first-offset="true"><span data-slate-string="true"> # dsn，如果设置了 dsn, 以下的所有设置都不生效</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="684"><span data-slate-object="text" data-key="685"><span data-slate-leaf="true" data-offset-key="685:0" data-first-offset="true"><span data-slate-string="true">    host: localhost # ip 地址</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="686"><span data-slate-object="text" data-key="687"><span data-slate-leaf="true" data-offset-key="687:0" data-first-offset="true"><span data-slate-string="true">    port: </span></span></span><span data-slate-object="text" data-key="688"><span data-slate-leaf="true" data-offset-key="688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3306</span></span></span></span><span data-slate-object="text" data-key="689"><span data-slate-leaf="true" data-offset-key="689:0" data-first-offset="true"><span data-slate-string="true"> # 端口</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="690"><span data-slate-object="text" data-key="691"><span data-slate-leaf="true" data-offset-key="691:0" data-first-offset="true"><span data-slate-string="true">    database: coredemo # 数据库</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="692"><span data-slate-object="text" data-key="693"><span data-slate-leaf="true" data-offset-key="693:0" data-first-offset="true"><span data-slate-string="true">    username: jianfengye # 用户名</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="694"><span data-slate-object="text" data-key="695"><span data-slate-leaf="true" data-offset-key="695:0" data-first-offset="true"><span data-slate-string="true">    password: </span></span></span><span data-slate-object="text" data-key="696"><span data-slate-leaf="true" data-offset-key="696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"123456789"</span></span></span></span><span data-slate-object="text" data-key="697"><span data-slate-leaf="true" data-offset-key="697:0" data-first-offset="true"><span data-slate-string="true"> # 密码</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="698"><span data-slate-object="text" data-key="699"><span data-slate-leaf="true" data-offset-key="699:0" data-first-offset="true"><span data-slate-string="true">    charset: utf8mb4 # 字符集</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="700"><span data-slate-object="text" data-key="701"><span data-slate-leaf="true" data-offset-key="701:0" data-first-offset="true"><span data-slate-string="true">    collation: utf8mb4_unicode_ci # 字符序</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="702"><span data-slate-object="text" data-key="703"><span data-slate-leaf="true" data-offset-key="703:0" data-first-offset="true"><span data-slate-string="true">    timeout: </span></span></span><span data-slate-object="text" data-key="704"><span data-slate-leaf="true" data-offset-key="704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="705"><span data-slate-leaf="true" data-offset-key="705:0" data-first-offset="true"><span data-slate-string="true">s # 连接超时</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="706"><span data-slate-object="text" data-key="707"><span data-slate-leaf="true" data-offset-key="707:0" data-first-offset="true"><span data-slate-string="true">    read_timeout: </span></span></span><span data-slate-object="text" data-key="708"><span data-slate-leaf="true" data-offset-key="708:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="709"><span data-slate-leaf="true" data-offset-key="709:0" data-first-offset="true"><span data-slate-string="true">s # 读超时</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="710"><span data-slate-object="text" data-key="711"><span data-slate-leaf="true" data-offset-key="711:0" data-first-offset="true"><span data-slate-string="true">    write_timeout: </span></span></span><span data-slate-object="text" data-key="712"><span data-slate-leaf="true" data-offset-key="712:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="713"><span data-slate-leaf="true" data-offset-key="713:0" data-first-offset="true"><span data-slate-string="true">s # 写超时</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="714"><span data-slate-object="text" data-key="715"><span data-slate-leaf="true" data-offset-key="715:0" data-first-offset="true"><span data-slate-string="true">    parse_time: </span></span></span><span data-slate-object="text" data-key="716"><span data-slate-leaf="true" data-offset-key="716:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="717"><span data-slate-leaf="true" data-offset-key="717:0" data-first-offset="true"><span data-slate-string="true"> # 是否解析时间</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="718"><span data-slate-object="text" data-key="719"><span data-slate-leaf="true" data-offset-key="719:0" data-first-offset="true"><span data-slate-string="true">    protocol: tcp # 传输协议</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="720"><span data-slate-object="text" data-key="721"><span data-slate-leaf="true" data-offset-key="721:0" data-first-offset="true"><span data-slate-string="true">    loc: Local # 时区</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="722"><span data-slate-object="text" data-key="723"><span data-slate-leaf="true" data-offset-key="723:0" data-first-offset="true"><span data-slate-string="true">    conn_max_idle: </span></span></span><span data-slate-object="text" data-key="724"><span data-slate-leaf="true" data-offset-key="724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="725"><span data-slate-leaf="true" data-offset-key="725:0" data-first-offset="true"><span data-slate-string="true"> # 连接池最大空闲连接数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="726"><span data-slate-object="text" data-key="727"><span data-slate-leaf="true" data-offset-key="727:0" data-first-offset="true"><span data-slate-string="true">    conn_max_open: </span></span></span><span data-slate-object="text" data-key="728"><span data-slate-leaf="true" data-offset-key="728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">20</span></span></span></span><span data-slate-object="text" data-key="729"><span data-slate-leaf="true" data-offset-key="729:0" data-first-offset="true"><span data-slate-string="true"> # 连接池最大连接数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="730"><span data-slate-object="text" data-key="731"><span data-slate-leaf="true" data-offset-key="731:0" data-first-offset="true"><span data-slate-string="true">    conn_max_lifetime: </span></span></span><span data-slate-object="text" data-key="732"><span data-slate-leaf="true" data-offset-key="732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="733"><span data-slate-leaf="true" data-offset-key="733:0" data-first-offset="true"><span data-slate-string="true">h # 连接数最大生命周期</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="734"></div><div data-slate-type="code-line" data-slate-object="block" data-key="735"><span data-slate-object="text" data-key="736"><span data-slate-leaf="true" data-offset-key="736:0" data-first-offset="true"><span data-slate-string="true">read:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="737"><span data-slate-object="text" data-key="738"><span data-slate-leaf="true" data-offset-key="738:0" data-first-offset="true"><span data-slate-string="true">    driver: mysql # 连接驱动</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="739"><span data-slate-object="text" data-key="740"><span data-slate-leaf="true" data-offset-key="740:0" data-first-offset="true"><span data-slate-string="true">    dsn: </span></span></span><span data-slate-object="text" data-key="741"><span data-slate-leaf="true" data-offset-key="741:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="742"><span data-slate-leaf="true" data-offset-key="742:0" data-first-offset="true"><span data-slate-string="true"> # dsn，如果设置了 dsn, 以下的所有设置都不生效</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="743"><span data-slate-object="text" data-key="744"><span data-slate-leaf="true" data-offset-key="744:0" data-first-offset="true"><span data-slate-string="true">    host: localhost # ip 地址</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="745"><span data-slate-object="text" data-key="746"><span data-slate-leaf="true" data-offset-key="746:0" data-first-offset="true"><span data-slate-string="true">    port: </span></span></span><span data-slate-object="text" data-key="747"><span data-slate-leaf="true" data-offset-key="747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3306</span></span></span></span><span data-slate-object="text" data-key="748"><span data-slate-leaf="true" data-offset-key="748:0" data-first-offset="true"><span data-slate-string="true"> # 端口</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="749"><span data-slate-object="text" data-key="750"><span data-slate-leaf="true" data-offset-key="750:0" data-first-offset="true"><span data-slate-string="true">    database: coredemo # 数据库</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="751"><span data-slate-object="text" data-key="752"><span data-slate-leaf="true" data-offset-key="752:0" data-first-offset="true"><span data-slate-string="true">    username: jianfengye # 用户名</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="753"><span data-slate-object="text" data-key="754"><span data-slate-leaf="true" data-offset-key="754:0" data-first-offset="true"><span data-slate-string="true">    password: </span></span></span><span data-slate-object="text" data-key="755"><span data-slate-leaf="true" data-offset-key="755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"123456789"</span></span></span></span><span data-slate-object="text" data-key="756"><span data-slate-leaf="true" data-offset-key="756:0" data-first-offset="true"><span data-slate-string="true"> # 密码</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="757"><span data-slate-object="text" data-key="758"><span data-slate-leaf="true" data-offset-key="758:0" data-first-offset="true"><span data-slate-string="true">    charset: utf8mb4 # 字符集</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="759"><span data-slate-object="text" data-key="760"><span data-slate-leaf="true" data-offset-key="760:0" data-first-offset="true"><span data-slate-string="true">    collation: utf8mb4_unicode_ci # 字符序</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="761"><span data-slate-object="text" data-key="762"><span data-slate-leaf="true" data-offset-key="762:0" data-first-offset="true"><span data-slate-string="true">在这个 database.yaml 中，我们配置了 database.default 和 database.read 两个数据源。database.read 数据源，并没有设置诸如时区 loc、连接池 conn_max_open 配置，这些缺省的配置要从 databse.yaml 的根结构中获取。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="763"><span data-slate-object="text" data-key="764"><span data-slate-leaf="true" data-offset-key="764:0" data-first-offset="true"><span data-slate-string="true">要实现这个也并不难，先在 framework/provider/orm/service.go 中实现一个 GetBaseConfig 方法，来读取 database.yaml 根目录的结构：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="765"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="766"><span data-slate-object="text" data-key="767"><span data-slate-leaf="true" data-offset-key="767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// GetBaseConfig 读取 database.yaml 根目录结构</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="768"><span data-slate-object="text" data-key="769"><span data-slate-leaf="true" data-offset-key="769:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="770"><span data-slate-leaf="true" data-offset-key="770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="771"><span data-slate-leaf="true" data-offset-key="771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">GetBaseConfig</span></span></span></span></span><span data-slate-object="text" data-key="772"><span data-slate-leaf="true" data-offset-key="772:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(c framework.Container)</span></span></span></span></span><span data-slate-object="text" data-key="773"><span data-slate-leaf="true" data-offset-key="773:0" data-first-offset="true"><span data-slate-string="true"> *contract.DBConfig {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="774"></div><div data-slate-type="code-line" data-slate-object="block" data-key="775"><span data-slate-object="text" data-key="776"><span data-slate-leaf="true" data-offset-key="776:0" data-first-offset="true"><span data-slate-string="true">   configService := c.MustMake(contract.ConfigKey).(contract.Config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="777"><span data-slate-object="text" data-key="778"><span data-slate-leaf="true" data-offset-key="778:0" data-first-offset="true"><span data-slate-string="true">   logService := c.MustMake(contract.LogKey).(contract.Log)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="779"><span data-slate-object="text" data-key="780"><span data-slate-leaf="true" data-offset-key="780:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="781"><span data-slate-object="text" data-key="782"><span data-slate-leaf="true" data-offset-key="782:0" data-first-offset="true"><span data-slate-string="true">   config := &amp;contract.DBConfig{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="783"><span data-slate-object="text" data-key="784"><span data-slate-leaf="true" data-offset-key="784:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="785"><span data-slate-leaf="true" data-offset-key="785:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 直接使用配置服务的 load 方法读取，yaml 文件</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="786"><span data-slate-object="text" data-key="787"><span data-slate-leaf="true" data-offset-key="787:0" data-first-offset="true"><span data-slate-string="true">   err := configService.Load(</span></span></span><span data-slate-object="text" data-key="788"><span data-slate-leaf="true" data-offset-key="788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"database"</span></span></span></span><span data-slate-object="text" data-key="789"><span data-slate-leaf="true" data-offset-key="789:0" data-first-offset="true"><span data-slate-string="true">, config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="790"><span data-slate-object="text" data-key="791"><span data-slate-leaf="true" data-offset-key="791:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="792"><span data-slate-leaf="true" data-offset-key="792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="793"><span data-slate-leaf="true" data-offset-key="793:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="794"><span data-slate-leaf="true" data-offset-key="794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="795"><span data-slate-leaf="true" data-offset-key="795:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="796"><span data-slate-object="text" data-key="797"><span data-slate-leaf="true" data-offset-key="797:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="798"><span data-slate-leaf="true" data-offset-key="798:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 直接使用 logService 来打印错误信息</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="799"><span data-slate-object="text" data-key="800"><span data-slate-leaf="true" data-offset-key="800:0" data-first-offset="true"><span data-slate-string="true">      logService.Error(context.Background(), </span></span></span><span data-slate-object="text" data-key="801"><span data-slate-leaf="true" data-offset-key="801:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"parse database config error"</span></span></span></span><span data-slate-object="text" data-key="802"><span data-slate-leaf="true" data-offset-key="802:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="803"><span data-slate-leaf="true" data-offset-key="803:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="804"><span data-slate-leaf="true" data-offset-key="804:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="805"><span data-slate-object="text" data-key="806"><span data-slate-leaf="true" data-offset-key="806:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="807"><span data-slate-leaf="true" data-offset-key="807:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="808"><span data-slate-leaf="true" data-offset-key="808:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="809"><span data-slate-leaf="true" data-offset-key="809:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="810"><span data-slate-object="text" data-key="811"><span data-slate-leaf="true" data-offset-key="811:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="812"><span data-slate-object="text" data-key="813"><span data-slate-leaf="true" data-offset-key="813:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="814"><span data-slate-leaf="true" data-offset-key="814:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="815"><span data-slate-leaf="true" data-offset-key="815:0" data-first-offset="true"><span data-slate-string="true"> config</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="816"><span data-slate-object="text" data-key="817"><span data-slate-leaf="true" data-offset-key="817:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="818"></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="819"><span data-slate-object="text" data-key="820"><span data-slate-leaf="true" data-offset-key="820:0" data-first-offset="true"><span data-slate-string="true">然后设计一个根据配置路径加载某个配置结构的方法。这里这个方法一定是在具体初始化某个 DB 实例的时候使用到，所以要封装为一个 Option 结构，写在 framework/provider/orm/config.go 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="821"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="822"><span data-slate-object="text" data-key="823"><span data-slate-leaf="true" data-offset-key="823:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// WithConfigPath 加载配置文件地址</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="824"><span data-slate-object="text" data-key="825"><span data-slate-leaf="true" data-offset-key="825:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="826"><span data-slate-leaf="true" data-offset-key="826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="827"><span data-slate-leaf="true" data-offset-key="827:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">WithConfigPath</span></span></span></span></span><span data-slate-object="text" data-key="828"><span data-slate-leaf="true" data-offset-key="828:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(configPath </span></span></span></span></span><span data-slate-object="text" data-key="829"><span data-slate-leaf="true" data-offset-key="829:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></span></span><span data-slate-object="text" data-key="830"><span data-slate-leaf="true" data-offset-key="830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="831"><span data-slate-leaf="true" data-offset-key="831:0" data-first-offset="true"><span data-slate-string="true"> contract.DBOption {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="832"><span data-slate-object="text" data-key="833"><span data-slate-leaf="true" data-offset-key="833:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="834"><span data-slate-leaf="true" data-offset-key="834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="835"><span data-slate-leaf="true" data-offset-key="835:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="836"><span data-slate-leaf="true" data-offset-key="836:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="837"><span data-slate-leaf="true" data-offset-key="837:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(container framework.Container, config *contract.DBConfig)</span></span></span></span></span><span data-slate-object="text" data-key="838"><span data-slate-leaf="true" data-offset-key="838:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="839"><span data-slate-leaf="true" data-offset-key="839:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="840"><span data-slate-leaf="true" data-offset-key="840:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="841"><span data-slate-object="text" data-key="842"><span data-slate-leaf="true" data-offset-key="842:0" data-first-offset="true"><span data-slate-string="true">      configService := container.MustMake(contract.ConfigKey).(contract.Config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="843"><span data-slate-object="text" data-key="844"><span data-slate-leaf="true" data-offset-key="844:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="845"><span data-slate-leaf="true" data-offset-key="845:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 加载 configPath 配置路径</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="846"><span data-slate-object="text" data-key="847"><span data-slate-leaf="true" data-offset-key="847:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="848"><span data-slate-leaf="true" data-offset-key="848:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="849"><span data-slate-leaf="true" data-offset-key="849:0" data-first-offset="true"><span data-slate-string="true"> err := configService.Load(configPath, config); err != </span></span></span><span data-slate-object="text" data-key="850"><span data-slate-leaf="true" data-offset-key="850:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="851"><span data-slate-leaf="true" data-offset-key="851:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="852"><span data-slate-object="text" data-key="853"><span data-slate-leaf="true" data-offset-key="853:0" data-first-offset="true"><span data-slate-string="true">         </span></span></span><span data-slate-object="text" data-key="854"><span data-slate-leaf="true" data-offset-key="854:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="855"><span data-slate-leaf="true" data-offset-key="855:0" data-first-offset="true"><span data-slate-string="true"> err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="856"><span data-slate-object="text" data-key="857"><span data-slate-leaf="true" data-offset-key="857:0" data-first-offset="true"><span data-slate-string="true">      }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="858"><span data-slate-object="text" data-key="859"><span data-slate-leaf="true" data-offset-key="859:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="860"><span data-slate-leaf="true" data-offset-key="860:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="861"><span data-slate-leaf="true" data-offset-key="861:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="862"><span data-slate-leaf="true" data-offset-key="862:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="863"><span data-slate-object="text" data-key="864"><span data-slate-leaf="true" data-offset-key="864:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="865"><span data-slate-object="text" data-key="866"><span data-slate-leaf="true" data-offset-key="866:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="867"><span data-slate-object="text" data-key="868"><span data-slate-leaf="true" data-offset-key="868:0" data-first-offset="true"><span data-slate-string="true">现在，对于使用者来说，要初始化一个配置路径为 database.default 的数据库，就可以这么使用：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="869"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="870"><span data-slate-object="text" data-key="871"><span data-slate-leaf="true" data-offset-key="871:0" data-first-offset="true"><span data-slate-string="true">gormService := c.MustMake(contract.ORMKey).(contract.ORMService)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="872"><span data-slate-object="text" data-key="873"><span data-slate-leaf="true" data-offset-key="873:0" data-first-offset="true"><span data-slate-string="true">db, err := gormService.GetDB(orm.WithConfigPath(</span></span></span><span data-slate-object="text" data-key="874"><span data-slate-leaf="true" data-offset-key="874:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"database.default"</span></span></span></span><span data-slate-object="text" data-key="875"><span data-slate-leaf="true" data-offset-key="875:0" data-first-offset="true"><span data-slate-string="true">), orm.WithDryRun())</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="876" id="sr-toc-6"><span data-slate-object="text" data-key="877"><span data-slate-leaf="true" data-offset-key="877:0" data-first-offset="true"><span data-slate-string="true">日志</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="878"><span data-slate-object="text" data-key="879"><span data-slate-leaf="true" data-offset-key="879:0" data-first-offset="true"><span data-slate-string="true">配置项设计清楚了，我们再来思考下日志这块。上一章介绍过了，Gorm 是有自己的输出规范的，在初始化参数 gorm.Config 中定义了一个日志输出接口 Interface。我们来仔细看下这个接口的定义：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="880"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="881"><span data-slate-object="text" data-key="882"><span data-slate-leaf="true" data-offset-key="882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="883"><span data-slate-leaf="true" data-offset-key="883:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="884"><span data-slate-object="text" data-key="885"><span data-slate-leaf="true" data-offset-key="885:0" data-first-offset="true"><span data-slate-string="true">   Silent LogLevel = </span></span></span><span data-slate-object="text" data-key="886"><span data-slate-leaf="true" data-offset-key="886:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">iota</span></span></span></span><span data-slate-object="text" data-key="887"><span data-slate-leaf="true" data-offset-key="887:0" data-first-offset="true"><span data-slate-string="true"> + </span></span></span><span data-slate-object="text" data-key="888"><span data-slate-leaf="true" data-offset-key="888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="889"><span data-slate-object="text" data-key="890"><span data-slate-leaf="true" data-offset-key="890:0" data-first-offset="true"><span data-slate-string="true">   Error</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="891"><span data-slate-object="text" data-key="892"><span data-slate-leaf="true" data-offset-key="892:0" data-first-offset="true"><span data-slate-string="true">   Warn</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="893"><span data-slate-object="text" data-key="894"><span data-slate-leaf="true" data-offset-key="894:0" data-first-offset="true"><span data-slate-string="true">   Info</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="895"><span data-slate-object="text" data-key="896"><span data-slate-leaf="true" data-offset-key="896:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="897"></div><div data-slate-type="code-line" data-slate-object="block" data-key="898"><span data-slate-object="text" data-key="899"><span data-slate-leaf="true" data-offset-key="899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Interface logger interface</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="900"><span data-slate-object="text" data-key="901"><span data-slate-leaf="true" data-offset-key="901:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="902"><span data-slate-leaf="true" data-offset-key="902:0" data-first-offset="true"><span data-slate-string="true"> Interface </span></span></span><span data-slate-object="text" data-key="903"><span data-slate-leaf="true" data-offset-key="903:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="904"><span data-slate-leaf="true" data-offset-key="904:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="905"><span data-slate-object="text" data-key="906"><span data-slate-leaf="true" data-offset-key="906:0" data-first-offset="true"><span data-slate-string="true">   LogMode(LogLevel) Interface </span></span></span><span data-slate-object="text" data-key="907"><span data-slate-leaf="true" data-offset-key="907:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 日志级别</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="908"><span data-slate-object="text" data-key="909"><span data-slate-leaf="true" data-offset-key="909:0" data-first-offset="true"><span data-slate-string="true">   Info(context.Context, </span></span></span><span data-slate-object="text" data-key="910"><span data-slate-leaf="true" data-offset-key="910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="911"><span data-slate-leaf="true" data-offset-key="911:0" data-first-offset="true"><span data-slate-string="true">, ...</span></span></span><span data-slate-object="text" data-key="912"><span data-slate-leaf="true" data-offset-key="912:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="913"><span data-slate-leaf="true" data-offset-key="913:0" data-first-offset="true"><span data-slate-string="true">{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="914"><span data-slate-object="text" data-key="915"><span data-slate-leaf="true" data-offset-key="915:0" data-first-offset="true"><span data-slate-string="true">   Warn(context.Context, </span></span></span><span data-slate-object="text" data-key="916"><span data-slate-leaf="true" data-offset-key="916:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="917"><span data-slate-leaf="true" data-offset-key="917:0" data-first-offset="true"><span data-slate-string="true">, ...</span></span></span><span data-slate-object="text" data-key="918"><span data-slate-leaf="true" data-offset-key="918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="919"><span data-slate-leaf="true" data-offset-key="919:0" data-first-offset="true"><span data-slate-string="true">{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="920"><span data-slate-object="text" data-key="921"><span data-slate-leaf="true" data-offset-key="921:0" data-first-offset="true"><span data-slate-string="true">   Error(context.Context, </span></span></span><span data-slate-object="text" data-key="922"><span data-slate-leaf="true" data-offset-key="922:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="923"><span data-slate-leaf="true" data-offset-key="923:0" data-first-offset="true"><span data-slate-string="true">, ...</span></span></span><span data-slate-object="text" data-key="924"><span data-slate-leaf="true" data-offset-key="924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="925"><span data-slate-leaf="true" data-offset-key="925:0" data-first-offset="true"><span data-slate-string="true">{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="926"><span data-slate-object="text" data-key="927"><span data-slate-leaf="true" data-offset-key="927:0" data-first-offset="true"><span data-slate-string="true">   Trace(ctx context.Context, begin time.Time, fc </span></span></span><span data-slate-object="text" data-key="928"><span data-slate-leaf="true" data-offset-key="928:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="929"><span data-slate-leaf="true" data-offset-key="929:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="930"><span data-slate-leaf="true" data-offset-key="930:0" data-first-offset="true"><span data-slate-string="true"> (sql </span></span></span><span data-slate-object="text" data-key="931"><span data-slate-leaf="true" data-offset-key="931:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="932"><span data-slate-leaf="true" data-offset-key="932:0" data-first-offset="true"><span data-slate-string="true">, rowsAffected </span></span></span><span data-slate-object="text" data-key="933"><span data-slate-leaf="true" data-offset-key="933:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="934"><span data-slate-leaf="true" data-offset-key="934:0" data-first-offset="true"><span data-slate-string="true">), err </span></span></span><span data-slate-object="text" data-key="935"><span data-slate-leaf="true" data-offset-key="935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="936"><span data-slate-leaf="true" data-offset-key="936:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="937"><span data-slate-object="text" data-key="938"><span data-slate-leaf="true" data-offset-key="938:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="939"><span data-slate-object="text" data-key="940"><span data-slate-leaf="true" data-offset-key="940:0" data-first-offset="true"><span data-slate-string="true">Gorm 接口的日志级别分类比较简单：Info、Warn、Error、Trace。恰巧，这几个日志级别都在我们 hade 框架定义的 7 个日志级别中，所以完全可以将 Gorm 的这几个级别，映射到 hade 的日志级别中。也就是说，Gorm 打印的 Info 级别日志输出到 hade 的 Info 日志中、error 日志输出到 hade 的 error 日志中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="941"><span data-slate-object="text" data-key="942"><span data-slate-leaf="true" data-offset-key="942:0" data-first-offset="true"><span data-slate-string="true">至于 Gorm 提供的一个 LogMode 来调整日志级别，由于我们的 hade 框架已经可以通过配置进行日志级别设置了，所以 LogMode 函数对我们来说是没有什么意义的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="943"><span data-slate-object="text" data-key="944"><span data-slate-leaf="true" data-offset-key="944:0" data-first-offset="true"><span data-slate-string="true">好，了解 Gorm 的日志接口之后，我们明确了接下来要做的事情：</span></span></span><span data-slate-object="text" data-key="945"><span data-slate-leaf="true" data-offset-key="945:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">实现一个 Gorm 的日志实现类，但是这个日志实现类中的每个方法都用 hade 的日志服务来实现</span></span></span></span><span data-slate-object="text" data-key="946"><span data-slate-leaf="true" data-offset-key="946:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="947"><span data-slate-object="text" data-key="948"><span data-slate-leaf="true" data-offset-key="948:0" data-first-offset="true"><span data-slate-string="true">我们在 framework/provider/orm/logger.go 中定义一个 OrmLogger 结构，它带有一个 logger 属性，这个 logger 属性存放的是 hade 容器中的 log 服务：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="949"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="950"><span data-slate-object="text" data-key="951"><span data-slate-leaf="true" data-offset-key="951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// OrmLogger orm 的日志实现类，实现了 gorm.Logger.Interface</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="952"><span data-slate-object="text" data-key="953"><span data-slate-leaf="true" data-offset-key="953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="954"><span data-slate-leaf="true" data-offset-key="954:0" data-first-offset="true"><span data-slate-string="true"> OrmLogger </span></span></span><span data-slate-object="text" data-key="955"><span data-slate-leaf="true" data-offset-key="955:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="956"><span data-slate-leaf="true" data-offset-key="956:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="957"><span data-slate-object="text" data-key="958"><span data-slate-leaf="true" data-offset-key="958:0" data-first-offset="true"><span data-slate-string="true">   logger contract.Log </span></span></span><span data-slate-object="text" data-key="959"><span data-slate-leaf="true" data-offset-key="959:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 有一个 logger 对象存放 hade 的 log 服务</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="960"><span data-slate-object="text" data-key="961"><span data-slate-leaf="true" data-offset-key="961:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="962"></div><div data-slate-type="code-line" data-slate-object="block" data-key="963"><span data-slate-object="text" data-key="964"><span data-slate-leaf="true" data-offset-key="964:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// NewOrmLogger 初始化一个 ormLogger,</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="965"><span data-slate-object="text" data-key="966"><span data-slate-leaf="true" data-offset-key="966:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="967"><span data-slate-leaf="true" data-offset-key="967:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="968"><span data-slate-leaf="true" data-offset-key="968:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NewOrmLogger</span></span></span></span></span><span data-slate-object="text" data-key="969"><span data-slate-leaf="true" data-offset-key="969:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(logger contract.Log)</span></span></span></span></span><span data-slate-object="text" data-key="970"><span data-slate-leaf="true" data-offset-key="970:0" data-first-offset="true"><span data-slate-string="true"> *OrmLogger {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="971"><span data-slate-object="text" data-key="972"><span data-slate-leaf="true" data-offset-key="972:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="973"><span data-slate-leaf="true" data-offset-key="973:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="974"><span data-slate-leaf="true" data-offset-key="974:0" data-first-offset="true"><span data-slate-string="true"> &amp;OrmLogger{logger: logger}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="975"><span data-slate-object="text" data-key="976"><span data-slate-leaf="true" data-offset-key="976:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="977"><span data-slate-object="text" data-key="978"><span data-slate-leaf="true" data-offset-key="978:0" data-first-offset="true"><span data-slate-string="true">它实现了 Gorm 的 Logger.Interface 接口。其中 LogMode 什么都不做，Info、Error、Warn、Trace 分别对应 hade 容器中 log 服务的 Info、Error、Warn、Trace 方法：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="979"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="980"><span data-slate-object="text" data-key="981"><span data-slate-leaf="true" data-offset-key="981:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Info 对接 hade 的 info 输出</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="982"><span data-slate-object="text" data-key="983"><span data-slate-leaf="true" data-offset-key="983:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="984"><span data-slate-leaf="true" data-offset-key="984:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="985"><span data-slate-leaf="true" data-offset-key="985:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(o *OrmLogger)</span></span></span></span></span><span data-slate-object="text" data-key="986"><span data-slate-leaf="true" data-offset-key="986:0" data-first-offset="true"><span data-slate-string="true"> Info(ctx context.Context, s </span></span></span><span data-slate-object="text" data-key="987"><span data-slate-leaf="true" data-offset-key="987:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="988"><span data-slate-leaf="true" data-offset-key="988:0" data-first-offset="true"><span data-slate-string="true">, i ...</span></span></span><span data-slate-object="text" data-key="989"><span data-slate-leaf="true" data-offset-key="989:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="990"><span data-slate-leaf="true" data-offset-key="990:0" data-first-offset="true"><span data-slate-string="true">{}) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="991"><span data-slate-object="text" data-key="992"><span data-slate-leaf="true" data-offset-key="992:0" data-first-offset="true"><span data-slate-string="true">   fields := </span></span></span><span data-slate-object="text" data-key="993"><span data-slate-leaf="true" data-offset-key="993:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="994"><span data-slate-leaf="true" data-offset-key="994:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="995"><span data-slate-leaf="true" data-offset-key="995:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="996"><span data-slate-leaf="true" data-offset-key="996:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="997"><span data-slate-leaf="true" data-offset-key="997:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="998"><span data-slate-leaf="true" data-offset-key="998:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="999"><span data-slate-object="text" data-key="1000"><span data-slate-leaf="true" data-offset-key="1000:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1001"><span data-slate-leaf="true" data-offset-key="1001:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fields"</span></span></span></span><span data-slate-object="text" data-key="1002"><span data-slate-leaf="true" data-offset-key="1002:0" data-first-offset="true"><span data-slate-string="true">: i,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1003"><span data-slate-object="text" data-key="1004"><span data-slate-leaf="true" data-offset-key="1004:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1005"><span data-slate-object="text" data-key="1006"><span data-slate-leaf="true" data-offset-key="1006:0" data-first-offset="true"><span data-slate-string="true">   o.logger.Info(ctx, s, fields)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1007"><span data-slate-object="text" data-key="1008"><span data-slate-leaf="true" data-offset-key="1008:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1009"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1010"><span data-slate-object="text" data-key="1011"><span data-slate-leaf="true" data-offset-key="1011:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Warn 对接 hade 的 Warn 输出</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1012"><span data-slate-object="text" data-key="1013"><span data-slate-leaf="true" data-offset-key="1013:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1014"><span data-slate-leaf="true" data-offset-key="1014:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1015"><span data-slate-leaf="true" data-offset-key="1015:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(o *OrmLogger)</span></span></span></span></span><span data-slate-object="text" data-key="1016"><span data-slate-leaf="true" data-offset-key="1016:0" data-first-offset="true"><span data-slate-string="true"> Warn(ctx context.Context, s </span></span></span><span data-slate-object="text" data-key="1017"><span data-slate-leaf="true" data-offset-key="1017:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1018"><span data-slate-leaf="true" data-offset-key="1018:0" data-first-offset="true"><span data-slate-string="true">, i ...</span></span></span><span data-slate-object="text" data-key="1019"><span data-slate-leaf="true" data-offset-key="1019:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1020"><span data-slate-leaf="true" data-offset-key="1020:0" data-first-offset="true"><span data-slate-string="true">{}) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1021"><span data-slate-object="text" data-key="1022"><span data-slate-leaf="true" data-offset-key="1022:0" data-first-offset="true"><span data-slate-string="true">   fields := </span></span></span><span data-slate-object="text" data-key="1023"><span data-slate-leaf="true" data-offset-key="1023:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1024"><span data-slate-leaf="true" data-offset-key="1024:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1025"><span data-slate-leaf="true" data-offset-key="1025:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1026"><span data-slate-leaf="true" data-offset-key="1026:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1027"><span data-slate-leaf="true" data-offset-key="1027:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1028"><span data-slate-leaf="true" data-offset-key="1028:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1029"><span data-slate-object="text" data-key="1030"><span data-slate-leaf="true" data-offset-key="1030:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1031"><span data-slate-leaf="true" data-offset-key="1031:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fields"</span></span></span></span><span data-slate-object="text" data-key="1032"><span data-slate-leaf="true" data-offset-key="1032:0" data-first-offset="true"><span data-slate-string="true">: i,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1033"><span data-slate-object="text" data-key="1034"><span data-slate-leaf="true" data-offset-key="1034:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1035"><span data-slate-object="text" data-key="1036"><span data-slate-leaf="true" data-offset-key="1036:0" data-first-offset="true"><span data-slate-string="true">   o.logger.Warn(ctx, s, fields)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1037"><span data-slate-object="text" data-key="1038"><span data-slate-leaf="true" data-offset-key="1038:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1039"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1040"><span data-slate-object="text" data-key="1041"><span data-slate-leaf="true" data-offset-key="1041:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Error 对接 hade 的 Error 输出</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1042"><span data-slate-object="text" data-key="1043"><span data-slate-leaf="true" data-offset-key="1043:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1044"><span data-slate-leaf="true" data-offset-key="1044:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1045"><span data-slate-leaf="true" data-offset-key="1045:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(o *OrmLogger)</span></span></span></span></span><span data-slate-object="text" data-key="1046"><span data-slate-leaf="true" data-offset-key="1046:0" data-first-offset="true"><span data-slate-string="true"> Error(ctx context.Context, s </span></span></span><span data-slate-object="text" data-key="1047"><span data-slate-leaf="true" data-offset-key="1047:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1048"><span data-slate-leaf="true" data-offset-key="1048:0" data-first-offset="true"><span data-slate-string="true">, i ...</span></span></span><span data-slate-object="text" data-key="1049"><span data-slate-leaf="true" data-offset-key="1049:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1050"><span data-slate-leaf="true" data-offset-key="1050:0" data-first-offset="true"><span data-slate-string="true">{}) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1051"><span data-slate-object="text" data-key="1052"><span data-slate-leaf="true" data-offset-key="1052:0" data-first-offset="true"><span data-slate-string="true">   fields := </span></span></span><span data-slate-object="text" data-key="1053"><span data-slate-leaf="true" data-offset-key="1053:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1054"><span data-slate-leaf="true" data-offset-key="1054:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1055"><span data-slate-leaf="true" data-offset-key="1055:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1056"><span data-slate-leaf="true" data-offset-key="1056:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1057"><span data-slate-leaf="true" data-offset-key="1057:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1058"><span data-slate-leaf="true" data-offset-key="1058:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1059"><span data-slate-object="text" data-key="1060"><span data-slate-leaf="true" data-offset-key="1060:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1061"><span data-slate-leaf="true" data-offset-key="1061:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"fields"</span></span></span></span><span data-slate-object="text" data-key="1062"><span data-slate-leaf="true" data-offset-key="1062:0" data-first-offset="true"><span data-slate-string="true">: i,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1063"><span data-slate-object="text" data-key="1064"><span data-slate-leaf="true" data-offset-key="1064:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1065"><span data-slate-object="text" data-key="1066"><span data-slate-leaf="true" data-offset-key="1066:0" data-first-offset="true"><span data-slate-string="true">   o.logger.Error(ctx, s, fields)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1067"><span data-slate-object="text" data-key="1068"><span data-slate-leaf="true" data-offset-key="1068:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1069"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1070"><span data-slate-object="text" data-key="1071"><span data-slate-leaf="true" data-offset-key="1071:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Trace 对接 hade 的 Trace 输出</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1072"><span data-slate-object="text" data-key="1073"><span data-slate-leaf="true" data-offset-key="1073:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1074"><span data-slate-leaf="true" data-offset-key="1074:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1075"><span data-slate-leaf="true" data-offset-key="1075:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(o *OrmLogger)</span></span></span></span></span><span data-slate-object="text" data-key="1076"><span data-slate-leaf="true" data-offset-key="1076:0" data-first-offset="true"><span data-slate-string="true"> Trace(ctx context.Context, begin time.Time, fc </span></span></span><span data-slate-object="text" data-key="1077"><span data-slate-leaf="true" data-offset-key="1077:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1078"><span data-slate-leaf="true" data-offset-key="1078:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="1079"><span data-slate-leaf="true" data-offset-key="1079:0" data-first-offset="true"><span data-slate-string="true"> (sql </span></span></span><span data-slate-object="text" data-key="1080"><span data-slate-leaf="true" data-offset-key="1080:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1081"><span data-slate-leaf="true" data-offset-key="1081:0" data-first-offset="true"><span data-slate-string="true">, rowsAffected </span></span></span><span data-slate-object="text" data-key="1082"><span data-slate-leaf="true" data-offset-key="1082:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="1083"><span data-slate-leaf="true" data-offset-key="1083:0" data-first-offset="true"><span data-slate-string="true">), err </span></span></span><span data-slate-object="text" data-key="1084"><span data-slate-leaf="true" data-offset-key="1084:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="1085"><span data-slate-leaf="true" data-offset-key="1085:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1086"><span data-slate-object="text" data-key="1087"><span data-slate-leaf="true" data-offset-key="1087:0" data-first-offset="true"><span data-slate-string="true">   sql, rows := fc()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1088"><span data-slate-object="text" data-key="1089"><span data-slate-leaf="true" data-offset-key="1089:0" data-first-offset="true"><span data-slate-string="true">   elapsed := time.Since(begin)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1090"><span data-slate-object="text" data-key="1091"><span data-slate-leaf="true" data-offset-key="1091:0" data-first-offset="true"><span data-slate-string="true">   fields := </span></span></span><span data-slate-object="text" data-key="1092"><span data-slate-leaf="true" data-offset-key="1092:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1093"><span data-slate-leaf="true" data-offset-key="1093:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1094"><span data-slate-leaf="true" data-offset-key="1094:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1095"><span data-slate-leaf="true" data-offset-key="1095:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1096"><span data-slate-leaf="true" data-offset-key="1096:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1097"><span data-slate-leaf="true" data-offset-key="1097:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1098"><span data-slate-object="text" data-key="1099"><span data-slate-leaf="true" data-offset-key="1099:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1100"><span data-slate-leaf="true" data-offset-key="1100:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"begin"</span></span></span></span><span data-slate-object="text" data-key="1101"><span data-slate-leaf="true" data-offset-key="1101:0" data-first-offset="true"><span data-slate-string="true">: begin,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1102"><span data-slate-object="text" data-key="1103"><span data-slate-leaf="true" data-offset-key="1103:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1104"><span data-slate-leaf="true" data-offset-key="1104:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"error"</span></span></span></span><span data-slate-object="text" data-key="1105"><span data-slate-leaf="true" data-offset-key="1105:0" data-first-offset="true"><span data-slate-string="true">: err,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1106"><span data-slate-object="text" data-key="1107"><span data-slate-leaf="true" data-offset-key="1107:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1108"><span data-slate-leaf="true" data-offset-key="1108:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"sql"</span></span></span></span><span data-slate-object="text" data-key="1109"><span data-slate-leaf="true" data-offset-key="1109:0" data-first-offset="true"><span data-slate-string="true">:   sql,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1110"><span data-slate-object="text" data-key="1111"><span data-slate-leaf="true" data-offset-key="1111:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1112"><span data-slate-leaf="true" data-offset-key="1112:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"rows"</span></span></span></span><span data-slate-object="text" data-key="1113"><span data-slate-leaf="true" data-offset-key="1113:0" data-first-offset="true"><span data-slate-string="true">:  rows,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1114"><span data-slate-object="text" data-key="1115"><span data-slate-leaf="true" data-offset-key="1115:0" data-first-offset="true"><span data-slate-string="true">      </span></span></span><span data-slate-object="text" data-key="1116"><span data-slate-leaf="true" data-offset-key="1116:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"time"</span></span></span></span><span data-slate-object="text" data-key="1117"><span data-slate-leaf="true" data-offset-key="1117:0" data-first-offset="true"><span data-slate-string="true">:  elapsed,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1118"><span data-slate-object="text" data-key="1119"><span data-slate-leaf="true" data-offset-key="1119:0" data-first-offset="true"><span data-slate-string="true">   }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1120"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1121"><span data-slate-object="text" data-key="1122"><span data-slate-leaf="true" data-offset-key="1122:0" data-first-offset="true"><span data-slate-string="true">   s := </span></span></span><span data-slate-object="text" data-key="1123"><span data-slate-leaf="true" data-offset-key="1123:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"orm trace sql"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1124"><span data-slate-object="text" data-key="1125"><span data-slate-leaf="true" data-offset-key="1125:0" data-first-offset="true"><span data-slate-string="true">   o.logger.Trace(ctx, s, fields)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1126"><span data-slate-object="text" data-key="1127"><span data-slate-leaf="true" data-offset-key="1127:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1128"><span data-slate-object="text" data-key="1129"><span data-slate-leaf="true" data-offset-key="1129:0" data-first-offset="true"><span data-slate-string="true">这里稍微注意下 Trace 方法，Gorm 的 Trace 方法的参数中有传递时间戳 begin，这个时间戳代表 SQL 执行的开始时间，而在函数中使用 time.Now 获取到当前时间之后，两个相减，我们可以获取到这个 SQL 的实际执行时间，然后作为 hade 日志服务的 fields map 的一个字段输出。除了 Trace，其他几个基本上简单封装 hade 的日志服务方法就好了。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1130" id="sr-toc-7"><span data-slate-object="text" data-key="1131"><span data-slate-leaf="true" data-offset-key="1131:0" data-first-offset="true"><span data-slate-string="true">服务实例</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1132"><span data-slate-object="text" data-key="1133"><span data-slate-leaf="true" data-offset-key="1133:0" data-first-offset="true"><span data-slate-string="true">好了，到现在 Gorm 的配置结构和日志结构也完成了。万事俱备，下面我们就开始写具体的 ORM 服务的实例 HadeGorm，在 framework/provider/orm/service.go 中。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1134"><span data-slate-object="text" data-key="1135"><span data-slate-leaf="true" data-offset-key="1135:0" data-first-offset="true"><span data-slate-string="true">首先，定义实现 contract.ORMService 的结构 HadeGorm。要明确一点，我们会使用这个结构来生成不同数据库的 gorm.DB 结构，</span></span></span><span data-slate-object="text" data-key="1136"><span data-slate-leaf="true" data-offset-key="1136:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">所以这个 HadeGorm 是一个与某个数据库设置无关的结构，而且它应该对单个数据库是一个单例模式</span></span></span></span><span data-slate-object="text" data-key="1137"><span data-slate-leaf="true" data-offset-key="1137:0" data-first-offset="true"><span data-slate-string="true">，即在一个服务中，我从 HadeGorm 两次获取到的 default 数据库的 gorm.DB 是同一个。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1138"><span data-slate-object="text" data-key="1139"><span data-slate-leaf="true" data-offset-key="1139:0" data-first-offset="true"><span data-slate-string="true">设置 HadeGrom 结构如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1140"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1141"><span data-slate-object="text" data-key="1142"><span data-slate-leaf="true" data-offset-key="1142:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// HadeGorm 代表 hade 框架的 orm 实现</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1143"><span data-slate-object="text" data-key="1144"><span data-slate-leaf="true" data-offset-key="1144:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="1145"><span data-slate-leaf="true" data-offset-key="1145:0" data-first-offset="true"><span data-slate-string="true"> HadeGorm </span></span></span><span data-slate-object="text" data-key="1146"><span data-slate-leaf="true" data-offset-key="1146:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1147"><span data-slate-leaf="true" data-offset-key="1147:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1148"><span data-slate-object="text" data-key="1149"><span data-slate-leaf="true" data-offset-key="1149:0" data-first-offset="true"><span data-slate-string="true">   container framework.Container </span></span></span><span data-slate-object="text" data-key="1150"><span data-slate-leaf="true" data-offset-key="1150:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 服务容器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1151"><span data-slate-object="text" data-key="1152"><span data-slate-leaf="true" data-offset-key="1152:0" data-first-offset="true"><span data-slate-string="true">   dbs       </span></span></span><span data-slate-object="text" data-key="1153"><span data-slate-leaf="true" data-offset-key="1153:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1154"><span data-slate-leaf="true" data-offset-key="1154:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1155"><span data-slate-leaf="true" data-offset-key="1155:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1156"><span data-slate-leaf="true" data-offset-key="1156:0" data-first-offset="true"><span data-slate-string="true">]*gorm.DB </span></span></span><span data-slate-object="text" data-key="1157"><span data-slate-leaf="true" data-offset-key="1157:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//key 为 dsn, value 为 gorm.DB（连接池）</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1158"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1159"><span data-slate-object="text" data-key="1160"><span data-slate-leaf="true" data-offset-key="1160:0" data-first-offset="true"><span data-slate-string="true">   lock *sync.RWMutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1161"><span data-slate-object="text" data-key="1162"><span data-slate-leaf="true" data-offset-key="1162:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1163"><span data-slate-object="text" data-key="1164"><span data-slate-leaf="true" data-offset-key="1164:0" data-first-offset="true"><span data-slate-string="true">dbs 就是为了单例存在，它的 key 直接设计为一个 string，也就是连接数据库的 DSN 字符串，而 value 就是 gorm.DB 结构。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1165"><span data-slate-object="text" data-key="1166"><span data-slate-leaf="true" data-offset-key="1166:0" data-first-offset="true"><span data-slate-string="true">这样我们在拿到一个 DSN 的时候，从这个 map 中就能判断出是否已经实例化过这个数据库对应的 gorm.DB 了；如果没有实例化过，就实例化一个 gorm.DB，并且将这个实例挂到这个 map 中。</span></span></span><span data-slate-object="text" data-key="1167"><span data-slate-leaf="true" data-offset-key="1167:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不过这个逻辑会对 dbs 有并发修改操作，所以这里要使用一个读写锁来锁住这个 dbs 的修改</span></span></span></span><span data-slate-object="text" data-key="1168"><span data-slate-leaf="true" data-offset-key="1168:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1169"><span data-slate-object="text" data-key="1170"><span data-slate-leaf="true" data-offset-key="1170:0" data-first-offset="true"><span data-slate-string="true">对应实例化 HadeGorm 的方法为 NewHadeGorm，它的具体实现就是初始化 HadeGorm 中的每个字段。继续写入这段：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1171"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1172"><span data-slate-object="text" data-key="1173"><span data-slate-leaf="true" data-offset-key="1173:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// NewHadeGorm 代表实例化 Gorm</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1174"><span data-slate-object="text" data-key="1175"><span data-slate-leaf="true" data-offset-key="1175:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1176"><span data-slate-leaf="true" data-offset-key="1176:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1177"><span data-slate-leaf="true" data-offset-key="1177:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">NewHadeGorm</span></span></span></span></span><span data-slate-object="text" data-key="1178"><span data-slate-leaf="true" data-offset-key="1178:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(params ...</span></span></span></span></span><span data-slate-object="text" data-key="1179"><span data-slate-leaf="true" data-offset-key="1179:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span></span></span><span data-slate-object="text" data-key="1180"><span data-slate-leaf="true" data-offset-key="1180:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">{})</span></span></span></span></span><span data-slate-object="text" data-key="1181"><span data-slate-leaf="true" data-offset-key="1181:0" data-first-offset="true"><span data-slate-string="true"> (</span></span></span><span data-slate-object="text" data-key="1182"><span data-slate-leaf="true" data-offset-key="1182:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1183"><span data-slate-leaf="true" data-offset-key="1183:0" data-first-offset="true"><span data-slate-string="true">{}, </span></span></span><span data-slate-object="text" data-key="1184"><span data-slate-leaf="true" data-offset-key="1184:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="1185"><span data-slate-leaf="true" data-offset-key="1185:0" data-first-offset="true"><span data-slate-string="true">) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1186"><span data-slate-object="text" data-key="1187"><span data-slate-leaf="true" data-offset-key="1187:0" data-first-offset="true"><span data-slate-string="true">   container := params[</span></span></span><span data-slate-object="text" data-key="1188"><span data-slate-leaf="true" data-offset-key="1188:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="1189"><span data-slate-leaf="true" data-offset-key="1189:0" data-first-offset="true"><span data-slate-string="true">].(framework.Container)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1190"><span data-slate-object="text" data-key="1191"><span data-slate-leaf="true" data-offset-key="1191:0" data-first-offset="true"><span data-slate-string="true">   dbs := </span></span></span><span data-slate-object="text" data-key="1192"><span data-slate-leaf="true" data-offset-key="1192:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">make</span></span></span></span><span data-slate-object="text" data-key="1193"><span data-slate-leaf="true" data-offset-key="1193:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1194"><span data-slate-leaf="true" data-offset-key="1194:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1195"><span data-slate-leaf="true" data-offset-key="1195:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1196"><span data-slate-leaf="true" data-offset-key="1196:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1197"><span data-slate-leaf="true" data-offset-key="1197:0" data-first-offset="true"><span data-slate-string="true">]*gorm.DB)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1198"><span data-slate-object="text" data-key="1199"><span data-slate-leaf="true" data-offset-key="1199:0" data-first-offset="true"><span data-slate-string="true">   lock := &amp;sync.RWMutex{}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1200"><span data-slate-object="text" data-key="1201"><span data-slate-leaf="true" data-offset-key="1201:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="1202"><span data-slate-leaf="true" data-offset-key="1202:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1203"><span data-slate-leaf="true" data-offset-key="1203:0" data-first-offset="true"><span data-slate-string="true"> &amp;HadeGorm{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1204"><span data-slate-object="text" data-key="1205"><span data-slate-leaf="true" data-offset-key="1205:0" data-first-offset="true"><span data-slate-string="true">      container: container,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1206"><span data-slate-object="text" data-key="1207"><span data-slate-leaf="true" data-offset-key="1207:0" data-first-offset="true"><span data-slate-string="true">      dbs:       dbs,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1208"><span data-slate-object="text" data-key="1209"><span data-slate-leaf="true" data-offset-key="1209:0" data-first-offset="true"><span data-slate-string="true">      lock:      lock,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1210"><span data-slate-object="text" data-key="1211"><span data-slate-leaf="true" data-offset-key="1211:0" data-first-offset="true"><span data-slate-string="true">   }, </span></span></span><span data-slate-object="text" data-key="1212"><span data-slate-leaf="true" data-offset-key="1212:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1213"><span data-slate-object="text" data-key="1214"><span data-slate-leaf="true" data-offset-key="1214:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1215"><span data-slate-object="text" data-key="1216"><span data-slate-leaf="true" data-offset-key="1216:0" data-first-offset="true"><span data-slate-string="true">重头戏在 GetDB 方法的实现上。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1217"><span data-slate-object="text" data-key="1218"><span data-slate-leaf="true" data-offset-key="1218:0" data-first-offset="true"><span data-slate-string="true">首先初始化 orm.Config，其中包括从配置中获取设置项，也包括初始化内部的 Gorm；然后将 GetDB 的 option 参数作用于初始化的 orm.Config，修改默认配置；通过 orm.Config 生成 DSN 字符串。</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1219"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1220"><span data-slate-object="text" data-key="1221"><span data-slate-leaf="true" data-offset-key="1221:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span><span data-slate-object="text" data-key="1222"><span data-slate-leaf="true" data-offset-key="1222:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 读取默认配置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1223"><span data-slate-object="text" data-key="1224"><span data-slate-leaf="true" data-offset-key="1224:0" data-first-offset="true"><span data-slate-string="true">    config := GetBaseConfig(app.container)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1225"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1226"><span data-slate-object="text" data-key="1227"><span data-slate-leaf="true" data-offset-key="1227:0" data-first-offset="true"><span data-slate-string="true">    logService := app.container.MustMake(contract.LogKey).(contract.Log)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1228"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1229"><span data-slate-object="text" data-key="1230"><span data-slate-leaf="true" data-offset-key="1230:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1231"><span data-slate-leaf="true" data-offset-key="1231:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置 Logger</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1232"><span data-slate-object="text" data-key="1233"><span data-slate-leaf="true" data-offset-key="1233:0" data-first-offset="true"><span data-slate-string="true">    ormLogger := NewOrmLogger(logService)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1234"><span data-slate-object="text" data-key="1235"><span data-slate-leaf="true" data-offset-key="1235:0" data-first-offset="true"><span data-slate-string="true">    config.Config = &amp;gorm.Config{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1236"><span data-slate-object="text" data-key="1237"><span data-slate-leaf="true" data-offset-key="1237:0" data-first-offset="true"><span data-slate-string="true">        Logger: ormLogger,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1238"><span data-slate-object="text" data-key="1239"><span data-slate-leaf="true" data-offset-key="1239:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1240"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1241"><span data-slate-object="text" data-key="1242"><span data-slate-leaf="true" data-offset-key="1242:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1243"><span data-slate-leaf="true" data-offset-key="1243:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//option 对 opt 进行修改</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1244"><span data-slate-object="text" data-key="1245"><span data-slate-leaf="true" data-offset-key="1245:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1246"><span data-slate-leaf="true" data-offset-key="1246:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="1247"><span data-slate-leaf="true" data-offset-key="1247:0" data-first-offset="true"><span data-slate-string="true"> _, opt := </span></span></span><span data-slate-object="text" data-key="1248"><span data-slate-leaf="true" data-offset-key="1248:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">range</span></span></span></span><span data-slate-object="text" data-key="1249"><span data-slate-leaf="true" data-offset-key="1249:0" data-first-offset="true"><span data-slate-string="true"> option {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1250"><span data-slate-object="text" data-key="1251"><span data-slate-leaf="true" data-offset-key="1251:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1252"><span data-slate-leaf="true" data-offset-key="1252:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1253"><span data-slate-leaf="true" data-offset-key="1253:0" data-first-offset="true"><span data-slate-string="true"> err := opt(app.container, config); err != </span></span></span><span data-slate-object="text" data-key="1254"><span data-slate-leaf="true" data-offset-key="1254:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1255"><span data-slate-leaf="true" data-offset-key="1255:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1256"><span data-slate-object="text" data-key="1257"><span data-slate-leaf="true" data-offset-key="1257:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="1258"><span data-slate-leaf="true" data-offset-key="1258:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1259"><span data-slate-leaf="true" data-offset-key="1259:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1260"><span data-slate-leaf="true" data-offset-key="1260:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1261"><span data-slate-leaf="true" data-offset-key="1261:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1262"><span data-slate-object="text" data-key="1263"><span data-slate-leaf="true" data-offset-key="1263:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1264"><span data-slate-object="text" data-key="1265"><span data-slate-leaf="true" data-offset-key="1265:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1266"><span data-slate-object="text" data-key="1267"><span data-slate-leaf="true" data-offset-key="1267:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">之后根据 dsn 字符串判断数据库实例 gorm.DB 是否已经存在了</span></span></span></span><span data-slate-object="text" data-key="1268"><span data-slate-leaf="true" data-offset-key="1268:0" data-first-offset="true"><span data-slate-string="true">。如果存在直接返回 gorm.DB，如果不存在需要实例化 gorm.DB，这一步逻辑稍微复杂一点：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="1269"><div data-slate-type="list-line" data-slate-object="block" data-key="1270"><span data-slate-object="text" data-key="1271"><span data-slate-leaf="true" data-offset-key="1271:0" data-first-offset="true"><span data-slate-string="true">根据配置项 orm.Config 中的不同驱动，来实例化 gorm.DB（支持 MySQL/Postgres/SQLite/SQL Server/ClickHouse）</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1272"><span data-slate-object="text" data-key="1273"><span data-slate-leaf="true" data-offset-key="1273:0" data-first-offset="true"><span data-slate-string="true">根据配置项 orm.Config 中的连接池配置，设置 gorm.DB 的连接池</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1274"><span data-slate-object="text" data-key="1275"><span data-slate-leaf="true" data-offset-key="1275:0" data-first-offset="true"><span data-slate-string="true">将实例化后的 gorm.DB 和 DSN 放入 map 映射中</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="1276"><span data-slate-object="text" data-key="1277"><span data-slate-leaf="true" data-offset-key="1277:0" data-first-offset="true"><span data-slate-string="true">返回实例化后的 gorm.DB</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1278"><span data-slate-object="text" data-key="1279"><span data-slate-leaf="true" data-offset-key="1279:0" data-first-offset="true"><span data-slate-string="true">代码如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1280"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div><div data-code-line-number="70"></div><div data-code-line-number="71"></div><div data-code-line-number="72"></div><div data-code-line-number="73"></div><div data-code-line-number="74"></div><div data-code-line-number="75"></div><div data-code-line-number="76"></div><div data-code-line-number="77"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1281"><span data-slate-object="text" data-key="1282"><span data-slate-leaf="true" data-offset-key="1282:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 如果最终的 config 没有设置 dsn, 就生成 dsn</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1283"><span data-slate-object="text" data-key="1284"><span data-slate-leaf="true" data-offset-key="1284:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1285"><span data-slate-leaf="true" data-offset-key="1285:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1286"><span data-slate-leaf="true" data-offset-key="1286:0" data-first-offset="true"><span data-slate-string="true"> config.Dsn == </span></span></span><span data-slate-object="text" data-key="1287"><span data-slate-leaf="true" data-offset-key="1287:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="1288"><span data-slate-leaf="true" data-offset-key="1288:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1289"><span data-slate-object="text" data-key="1290"><span data-slate-leaf="true" data-offset-key="1290:0" data-first-offset="true"><span data-slate-string="true">        dsn, err := config.FormatDsn()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1291"><span data-slate-object="text" data-key="1292"><span data-slate-leaf="true" data-offset-key="1292:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1293"><span data-slate-leaf="true" data-offset-key="1293:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1294"><span data-slate-leaf="true" data-offset-key="1294:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1295"><span data-slate-leaf="true" data-offset-key="1295:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1296"><span data-slate-leaf="true" data-offset-key="1296:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1297"><span data-slate-object="text" data-key="1298"><span data-slate-leaf="true" data-offset-key="1298:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="1299"><span data-slate-leaf="true" data-offset-key="1299:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1300"><span data-slate-leaf="true" data-offset-key="1300:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1301"><span data-slate-leaf="true" data-offset-key="1301:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1302"><span data-slate-leaf="true" data-offset-key="1302:0" data-first-offset="true"><span data-slate-string="true">, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1303"><span data-slate-object="text" data-key="1304"><span data-slate-leaf="true" data-offset-key="1304:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1305"><span data-slate-object="text" data-key="1306"><span data-slate-leaf="true" data-offset-key="1306:0" data-first-offset="true"><span data-slate-string="true">        config.Dsn = dsn</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1307"><span data-slate-object="text" data-key="1308"><span data-slate-leaf="true" data-offset-key="1308:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1309"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1310"><span data-slate-object="text" data-key="1311"><span data-slate-leaf="true" data-offset-key="1311:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1312"><span data-slate-leaf="true" data-offset-key="1312:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 判断是否已经实例化了 gorm.DB</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1313"><span data-slate-object="text" data-key="1314"><span data-slate-leaf="true" data-offset-key="1314:0" data-first-offset="true"><span data-slate-string="true">    app.lock.RLock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1315"><span data-slate-object="text" data-key="1316"><span data-slate-leaf="true" data-offset-key="1316:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1317"><span data-slate-leaf="true" data-offset-key="1317:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1318"><span data-slate-leaf="true" data-offset-key="1318:0" data-first-offset="true"><span data-slate-string="true"> db, ok := app.dbs[config.Dsn]; ok {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1319"><span data-slate-object="text" data-key="1320"><span data-slate-leaf="true" data-offset-key="1320:0" data-first-offset="true"><span data-slate-string="true">        app.lock.RUnlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1321"><span data-slate-object="text" data-key="1322"><span data-slate-leaf="true" data-offset-key="1322:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1323"><span data-slate-leaf="true" data-offset-key="1323:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1324"><span data-slate-leaf="true" data-offset-key="1324:0" data-first-offset="true"><span data-slate-string="true"> db, </span></span></span><span data-slate-object="text" data-key="1325"><span data-slate-leaf="true" data-offset-key="1325:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1326"><span data-slate-object="text" data-key="1327"><span data-slate-leaf="true" data-offset-key="1327:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1328"><span data-slate-object="text" data-key="1329"><span data-slate-leaf="true" data-offset-key="1329:0" data-first-offset="true"><span data-slate-string="true">    app.lock.RUnlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1330"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1331"><span data-slate-object="text" data-key="1332"><span data-slate-leaf="true" data-offset-key="1332:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1333"><span data-slate-leaf="true" data-offset-key="1333:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 没有实例化 gorm.DB，那么就要进行实例化操作</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1334"><span data-slate-object="text" data-key="1335"><span data-slate-leaf="true" data-offset-key="1335:0" data-first-offset="true"><span data-slate-string="true">    app.lock.Lock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1336"><span data-slate-object="text" data-key="1337"><span data-slate-leaf="true" data-offset-key="1337:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1338"><span data-slate-leaf="true" data-offset-key="1338:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">defer</span></span></span></span><span data-slate-object="text" data-key="1339"><span data-slate-leaf="true" data-offset-key="1339:0" data-first-offset="true"><span data-slate-string="true"> app.lock.Unlock()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1340"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1341"><span data-slate-object="text" data-key="1342"><span data-slate-leaf="true" data-offset-key="1342:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1343"><span data-slate-leaf="true" data-offset-key="1343:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 实例化 gorm.DB</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1344"><span data-slate-object="text" data-key="1345"><span data-slate-leaf="true" data-offset-key="1345:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1346"><span data-slate-leaf="true" data-offset-key="1346:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1347"><span data-slate-leaf="true" data-offset-key="1347:0" data-first-offset="true"><span data-slate-string="true"> db *gorm.DB</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1348"><span data-slate-object="text" data-key="1349"><span data-slate-leaf="true" data-offset-key="1349:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1350"><span data-slate-leaf="true" data-offset-key="1350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">var</span></span></span></span><span data-slate-object="text" data-key="1351"><span data-slate-leaf="true" data-offset-key="1351:0" data-first-offset="true"><span data-slate-string="true"> err </span></span></span><span data-slate-object="text" data-key="1352"><span data-slate-leaf="true" data-offset-key="1352:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1353"><span data-slate-object="text" data-key="1354"><span data-slate-leaf="true" data-offset-key="1354:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1355"><span data-slate-leaf="true" data-offset-key="1355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">switch</span></span></span></span><span data-slate-object="text" data-key="1356"><span data-slate-leaf="true" data-offset-key="1356:0" data-first-offset="true"><span data-slate-string="true"> config.Driver {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1357"><span data-slate-object="text" data-key="1358"><span data-slate-leaf="true" data-offset-key="1358:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1359"><span data-slate-leaf="true" data-offset-key="1359:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1360"><span data-slate-leaf="true" data-offset-key="1360:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1361"><span data-slate-leaf="true" data-offset-key="1361:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"mysql"</span></span></span></span><span data-slate-object="text" data-key="1362"><span data-slate-leaf="true" data-offset-key="1362:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1363"><span data-slate-object="text" data-key="1364"><span data-slate-leaf="true" data-offset-key="1364:0" data-first-offset="true"><span data-slate-string="true">        db, err = gorm.Open(mysql.Open(config.Dsn), config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1365"><span data-slate-object="text" data-key="1366"><span data-slate-leaf="true" data-offset-key="1366:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1367"><span data-slate-leaf="true" data-offset-key="1367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1368"><span data-slate-leaf="true" data-offset-key="1368:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1369"><span data-slate-leaf="true" data-offset-key="1369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"postgres"</span></span></span></span><span data-slate-object="text" data-key="1370"><span data-slate-leaf="true" data-offset-key="1370:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1371"><span data-slate-object="text" data-key="1372"><span data-slate-leaf="true" data-offset-key="1372:0" data-first-offset="true"><span data-slate-string="true">        db, err = gorm.Open(postgres.Open(config.Dsn), config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1373"><span data-slate-object="text" data-key="1374"><span data-slate-leaf="true" data-offset-key="1374:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1375"><span data-slate-leaf="true" data-offset-key="1375:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1376"><span data-slate-leaf="true" data-offset-key="1376:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1377"><span data-slate-leaf="true" data-offset-key="1377:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"sqlite"</span></span></span></span><span data-slate-object="text" data-key="1378"><span data-slate-leaf="true" data-offset-key="1378:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1379"><span data-slate-object="text" data-key="1380"><span data-slate-leaf="true" data-offset-key="1380:0" data-first-offset="true"><span data-slate-string="true">        db, err = gorm.Open(sqlite.Open(config.Dsn), config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1381"><span data-slate-object="text" data-key="1382"><span data-slate-leaf="true" data-offset-key="1382:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1383"><span data-slate-leaf="true" data-offset-key="1383:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1384"><span data-slate-leaf="true" data-offset-key="1384:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1385"><span data-slate-leaf="true" data-offset-key="1385:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"sqlserver"</span></span></span></span><span data-slate-object="text" data-key="1386"><span data-slate-leaf="true" data-offset-key="1386:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1387"><span data-slate-object="text" data-key="1388"><span data-slate-leaf="true" data-offset-key="1388:0" data-first-offset="true"><span data-slate-string="true">        db, err = gorm.Open(sqlserver.Open(config.Dsn), config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1389"><span data-slate-object="text" data-key="1390"><span data-slate-leaf="true" data-offset-key="1390:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1391"><span data-slate-leaf="true" data-offset-key="1391:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">case</span></span></span></span><span data-slate-object="text" data-key="1392"><span data-slate-leaf="true" data-offset-key="1392:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1393"><span data-slate-leaf="true" data-offset-key="1393:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"clickhouse"</span></span></span></span><span data-slate-object="text" data-key="1394"><span data-slate-leaf="true" data-offset-key="1394:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1395"><span data-slate-object="text" data-key="1396"><span data-slate-leaf="true" data-offset-key="1396:0" data-first-offset="true"><span data-slate-string="true">        db, err = gorm.Open(clickhouse.Open(config.Dsn), config)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1397"><span data-slate-object="text" data-key="1398"><span data-slate-leaf="true" data-offset-key="1398:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1399"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1400"><span data-slate-object="text" data-key="1401"><span data-slate-leaf="true" data-offset-key="1401:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1402"><span data-slate-leaf="true" data-offset-key="1402:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置对应的连接池配置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1403"><span data-slate-object="text" data-key="1404"><span data-slate-leaf="true" data-offset-key="1404:0" data-first-offset="true"><span data-slate-string="true">    sqlDB, err := db.DB()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1405"><span data-slate-object="text" data-key="1406"><span data-slate-leaf="true" data-offset-key="1406:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1407"><span data-slate-leaf="true" data-offset-key="1407:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1408"><span data-slate-leaf="true" data-offset-key="1408:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1409"><span data-slate-leaf="true" data-offset-key="1409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1410"><span data-slate-leaf="true" data-offset-key="1410:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1411"><span data-slate-object="text" data-key="1412"><span data-slate-leaf="true" data-offset-key="1412:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1413"><span data-slate-leaf="true" data-offset-key="1413:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1414"><span data-slate-leaf="true" data-offset-key="1414:0" data-first-offset="true"><span data-slate-string="true"> db, err</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1415"><span data-slate-object="text" data-key="1416"><span data-slate-leaf="true" data-offset-key="1416:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1417"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1418"><span data-slate-object="text" data-key="1419"><span data-slate-leaf="true" data-offset-key="1419:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1420"><span data-slate-leaf="true" data-offset-key="1420:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1421"><span data-slate-leaf="true" data-offset-key="1421:0" data-first-offset="true"><span data-slate-string="true"> config.ConnMaxIdle &gt; </span></span></span><span data-slate-object="text" data-key="1422"><span data-slate-leaf="true" data-offset-key="1422:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="1423"><span data-slate-leaf="true" data-offset-key="1423:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1424"><span data-slate-object="text" data-key="1425"><span data-slate-leaf="true" data-offset-key="1425:0" data-first-offset="true"><span data-slate-string="true">        sqlDB.SetMaxIdleConns(config.ConnMaxIdle)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1426"><span data-slate-object="text" data-key="1427"><span data-slate-leaf="true" data-offset-key="1427:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1428"><span data-slate-object="text" data-key="1429"><span data-slate-leaf="true" data-offset-key="1429:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1430"><span data-slate-leaf="true" data-offset-key="1430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1431"><span data-slate-leaf="true" data-offset-key="1431:0" data-first-offset="true"><span data-slate-string="true"> config.ConnMaxOpen &gt; </span></span></span><span data-slate-object="text" data-key="1432"><span data-slate-leaf="true" data-offset-key="1432:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="1433"><span data-slate-leaf="true" data-offset-key="1433:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1434"><span data-slate-object="text" data-key="1435"><span data-slate-leaf="true" data-offset-key="1435:0" data-first-offset="true"><span data-slate-string="true">        sqlDB.SetMaxOpenConns(config.ConnMaxOpen)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1436"><span data-slate-object="text" data-key="1437"><span data-slate-leaf="true" data-offset-key="1437:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1438"><span data-slate-object="text" data-key="1439"><span data-slate-leaf="true" data-offset-key="1439:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1440"><span data-slate-leaf="true" data-offset-key="1440:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1441"><span data-slate-leaf="true" data-offset-key="1441:0" data-first-offset="true"><span data-slate-string="true"> config.ConnMaxLifetime != </span></span></span><span data-slate-object="text" data-key="1442"><span data-slate-leaf="true" data-offset-key="1442:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="1443"><span data-slate-leaf="true" data-offset-key="1443:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1444"><span data-slate-object="text" data-key="1445"><span data-slate-leaf="true" data-offset-key="1445:0" data-first-offset="true"><span data-slate-string="true">        liftTime, err := time.ParseDuration(config.ConnMaxLifetime)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1446"><span data-slate-object="text" data-key="1447"><span data-slate-leaf="true" data-offset-key="1447:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1448"><span data-slate-leaf="true" data-offset-key="1448:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1449"><span data-slate-leaf="true" data-offset-key="1449:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1450"><span data-slate-leaf="true" data-offset-key="1450:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1451"><span data-slate-leaf="true" data-offset-key="1451:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1452"><span data-slate-object="text" data-key="1453"><span data-slate-leaf="true" data-offset-key="1453:0" data-first-offset="true"><span data-slate-string="true">            logger.Error(context.Background(), </span></span></span><span data-slate-object="text" data-key="1454"><span data-slate-leaf="true" data-offset-key="1454:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"conn max lift time error"</span></span></span></span><span data-slate-object="text" data-key="1455"><span data-slate-leaf="true" data-offset-key="1455:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1456"><span data-slate-leaf="true" data-offset-key="1456:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1457"><span data-slate-leaf="true" data-offset-key="1457:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1458"><span data-slate-leaf="true" data-offset-key="1458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1459"><span data-slate-leaf="true" data-offset-key="1459:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1460"><span data-slate-leaf="true" data-offset-key="1460:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1461"><span data-slate-leaf="true" data-offset-key="1461:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1462"><span data-slate-object="text" data-key="1463"><span data-slate-leaf="true" data-offset-key="1463:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="1464"><span data-slate-leaf="true" data-offset-key="1464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"err"</span></span></span></span><span data-slate-object="text" data-key="1465"><span data-slate-leaf="true" data-offset-key="1465:0" data-first-offset="true"><span data-slate-string="true">: err,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1466"><span data-slate-object="text" data-key="1467"><span data-slate-leaf="true" data-offset-key="1467:0" data-first-offset="true"><span data-slate-string="true">            })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1468"><span data-slate-object="text" data-key="1469"><span data-slate-leaf="true" data-offset-key="1469:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="1470"><span data-slate-leaf="true" data-offset-key="1470:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="1471"><span data-slate-leaf="true" data-offset-key="1471:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1472"><span data-slate-object="text" data-key="1473"><span data-slate-leaf="true" data-offset-key="1473:0" data-first-offset="true"><span data-slate-string="true">            sqlDB.SetConnMaxLifetime(liftTime)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1474"><span data-slate-object="text" data-key="1475"><span data-slate-leaf="true" data-offset-key="1475:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1476"><span data-slate-object="text" data-key="1477"><span data-slate-leaf="true" data-offset-key="1477:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1478"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1479"><span data-slate-object="text" data-key="1480"><span data-slate-leaf="true" data-offset-key="1480:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1481"><span data-slate-leaf="true" data-offset-key="1481:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1482"><span data-slate-leaf="true" data-offset-key="1482:0" data-first-offset="true"><span data-slate-string="true"> config.ConnMaxIdletime != </span></span></span><span data-slate-object="text" data-key="1483"><span data-slate-leaf="true" data-offset-key="1483:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="1484"><span data-slate-leaf="true" data-offset-key="1484:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1485"><span data-slate-object="text" data-key="1486"><span data-slate-leaf="true" data-offset-key="1486:0" data-first-offset="true"><span data-slate-string="true">        idleTime, err := time.ParseDuration(config.ConnMaxIdletime)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1487"><span data-slate-object="text" data-key="1488"><span data-slate-leaf="true" data-offset-key="1488:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1489"><span data-slate-leaf="true" data-offset-key="1489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1490"><span data-slate-leaf="true" data-offset-key="1490:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1491"><span data-slate-leaf="true" data-offset-key="1491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1492"><span data-slate-leaf="true" data-offset-key="1492:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1493"><span data-slate-object="text" data-key="1494"><span data-slate-leaf="true" data-offset-key="1494:0" data-first-offset="true"><span data-slate-string="true">            logger.Error(context.Background(), </span></span></span><span data-slate-object="text" data-key="1495"><span data-slate-leaf="true" data-offset-key="1495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"conn max idle time error"</span></span></span></span><span data-slate-object="text" data-key="1496"><span data-slate-leaf="true" data-offset-key="1496:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1497"><span data-slate-leaf="true" data-offset-key="1497:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1498"><span data-slate-leaf="true" data-offset-key="1498:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1499"><span data-slate-leaf="true" data-offset-key="1499:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1500"><span data-slate-leaf="true" data-offset-key="1500:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1501"><span data-slate-leaf="true" data-offset-key="1501:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1502"><span data-slate-leaf="true" data-offset-key="1502:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1503"><span data-slate-object="text" data-key="1504"><span data-slate-leaf="true" data-offset-key="1504:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="1505"><span data-slate-leaf="true" data-offset-key="1505:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"err"</span></span></span></span><span data-slate-object="text" data-key="1506"><span data-slate-leaf="true" data-offset-key="1506:0" data-first-offset="true"><span data-slate-string="true">: err,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1507"><span data-slate-object="text" data-key="1508"><span data-slate-leaf="true" data-offset-key="1508:0" data-first-offset="true"><span data-slate-string="true">            })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1509"><span data-slate-object="text" data-key="1510"><span data-slate-leaf="true" data-offset-key="1510:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="1511"><span data-slate-leaf="true" data-offset-key="1511:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="1512"><span data-slate-leaf="true" data-offset-key="1512:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1513"><span data-slate-object="text" data-key="1514"><span data-slate-leaf="true" data-offset-key="1514:0" data-first-offset="true"><span data-slate-string="true">            sqlDB.SetConnMaxIdleTime(idleTime)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1515"><span data-slate-object="text" data-key="1516"><span data-slate-leaf="true" data-offset-key="1516:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1517"><span data-slate-object="text" data-key="1518"><span data-slate-leaf="true" data-offset-key="1518:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1519"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1520"><span data-slate-object="text" data-key="1521"><span data-slate-leaf="true" data-offset-key="1521:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1522"><span data-slate-leaf="true" data-offset-key="1522:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 挂载到 map 中，结束配置</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1523"><span data-slate-object="text" data-key="1524"><span data-slate-leaf="true" data-offset-key="1524:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1525"><span data-slate-leaf="true" data-offset-key="1525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1526"><span data-slate-leaf="true" data-offset-key="1526:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1527"><span data-slate-leaf="true" data-offset-key="1527:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1528"><span data-slate-leaf="true" data-offset-key="1528:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1529"><span data-slate-object="text" data-key="1530"><span data-slate-leaf="true" data-offset-key="1530:0" data-first-offset="true"><span data-slate-string="true">        app.dbs[config.Dsn] = db</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1531"><span data-slate-object="text" data-key="1532"><span data-slate-leaf="true" data-offset-key="1532:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1533"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1534"><span data-slate-object="text" data-key="1535"><span data-slate-leaf="true" data-offset-key="1535:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1536"><span data-slate-leaf="true" data-offset-key="1536:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1537"><span data-slate-leaf="true" data-offset-key="1537:0" data-first-offset="true"><span data-slate-string="true"> db, err</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1538"><span data-slate-object="text" data-key="1539"><span data-slate-leaf="true" data-offset-key="1539:0" data-first-offset="true"><span data-slate-string="true">如果前面的内容都理解了，这段代码实现也没有什么难点了。唯一要注意的地方就是锁的使用，</span></span></span><span data-slate-object="text" data-key="1540"><span data-slate-leaf="true" data-offset-key="1540:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">由于对存在 gorm.DB 的 map 是读多写少，所以这里也是使用读写锁</span></span></span></span><span data-slate-object="text" data-key="1541"><span data-slate-leaf="true" data-offset-key="1541:0" data-first-offset="true"><span data-slate-string="true">，在读取的时候加了一个读锁，如果 map 中没有我们要的 gorm.DB，先把读锁解开，再加一个写锁，初始化完 gorm.DB、保存进入 map 映射后，再把写锁解开。这样能有效防止对 map 的并发读写。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1542"><span data-slate-object="text" data-key="1543"><span data-slate-leaf="true" data-offset-key="1543:0" data-first-offset="true"><span data-slate-string="true">完整的 GetDB 方法可以参考 GitHub 上的 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="1544" one-link-mark="yes"><span data-slate-object="text" data-key="1545"><span data-slate-leaf="true" data-offset-key="1545:0" data-first-offset="true"><span data-slate-string="true">framework/provider/orm/service.go</span></span></span></a><span data-slate-object="text" data-key="1546"><span data-slate-leaf="true" data-offset-key="1546:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1547"><span data-slate-object="text" data-key="1548"><span data-slate-leaf="true" data-offset-key="1548:0" data-first-offset="true"><span data-slate-string="true">最后记得去业务代码 main.go 中，把我们的 GormProvider 注入服务容器：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1549"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1550"><span data-slate-object="text" data-key="1551"><span data-slate-leaf="true" data-offset-key="1551:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1552"><span data-slate-leaf="true" data-offset-key="1552:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1553"><span data-slate-leaf="true" data-offset-key="1553:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="1554"><span data-slate-leaf="true" data-offset-key="1554:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="1555"><span data-slate-leaf="true" data-offset-key="1555:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1556"><span data-slate-object="text" data-key="1557"><span data-slate-leaf="true" data-offset-key="1557:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="1558"><span data-slate-leaf="true" data-offset-key="1558:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化服务容器</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1559"><span data-slate-object="text" data-key="1560"><span data-slate-leaf="true" data-offset-key="1560:0" data-first-offset="true"><span data-slate-string="true">   container := framework.NewHadeContainer()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1561"><span data-slate-object="text" data-key="1562"><span data-slate-leaf="true" data-offset-key="1562:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1563"><span data-slate-object="text" data-key="1564"><span data-slate-leaf="true" data-offset-key="1564:0" data-first-offset="true"><span data-slate-string="true">   container.Bind(&amp;orm.GormProvider{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1565"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1566"><span data-slate-object="text" data-key="1567"><span data-slate-leaf="true" data-offset-key="1567:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1568"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1569"><span data-slate-object="text" data-key="1570"><span data-slate-leaf="true" data-offset-key="1570:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="1571"><span data-slate-leaf="true" data-offset-key="1571:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 运行 root 命令</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1572"><span data-slate-object="text" data-key="1573"><span data-slate-leaf="true" data-offset-key="1573:0" data-first-offset="true"><span data-slate-string="true">   console.RunCommand(container)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1574"><span data-slate-object="text" data-key="1575"><span data-slate-leaf="true" data-offset-key="1575:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1576"><span data-slate-object="text" data-key="1577"><span data-slate-leaf="true" data-offset-key="1577:0" data-first-offset="true"><span data-slate-string="true">整个 Gorm 就已经结合到 hade 框架中了。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="1578" id="sr-toc-8"><span data-slate-object="text" data-key="1579"><span data-slate-leaf="true" data-offset-key="1579:0" data-first-offset="true"><span data-slate-string="true">测试</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="1580"><span data-slate-object="text" data-key="1581"><span data-slate-leaf="true" data-offset-key="1581:0" data-first-offset="true"><span data-slate-string="true">下面来做一下测试。我们用真实的 MySQL 进行测试。当然你需要在本机 / 远端 /Docker 搭建一个 MySQL，至于怎么搭建，教程网上有很多了，这里就不详细描述。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1582"><span data-slate-object="text" data-key="1583"><span data-slate-leaf="true" data-offset-key="1583:0" data-first-offset="true"><span data-slate-string="true">我用的是 Mac，使用 homebrew 能很方便搭建一个 MySQL 服务。我的 MySQL 实例搭建在本机的 3306 端口，并且搭建完成之后，我创建了一个 coredemo 的 database 数据库：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1584"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/e8/68/e81e9f92ea1fe6e27edd3d819f577268.png?wh=1836x1388"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1585"><span data-slate-object="text" data-key="1586"><span data-slate-leaf="true" data-offset-key="1586:0" data-first-offset="true"><span data-slate-string="true">所以我的配置文件 config/development/database.yaml 配置如下：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1587"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1588"><span data-slate-object="text" data-key="1589"><span data-slate-leaf="true" data-offset-key="1589:0" data-first-offset="true"><span data-slate-string="true">conn_max_idle: </span></span></span><span data-slate-object="text" data-key="1590"><span data-slate-leaf="true" data-offset-key="1590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="1591"><span data-slate-leaf="true" data-offset-key="1591:0" data-first-offset="true"><span data-slate-string="true"> # 通用配置，连接池最大空闲连接数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1592"><span data-slate-object="text" data-key="1593"><span data-slate-leaf="true" data-offset-key="1593:0" data-first-offset="true"><span data-slate-string="true">conn_max_open: </span></span></span><span data-slate-object="text" data-key="1594"><span data-slate-leaf="true" data-offset-key="1594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">100</span></span></span></span><span data-slate-object="text" data-key="1595"><span data-slate-leaf="true" data-offset-key="1595:0" data-first-offset="true"><span data-slate-string="true"> # 通用配置，连接池最大连接数</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1596"><span data-slate-object="text" data-key="1597"><span data-slate-leaf="true" data-offset-key="1597:0" data-first-offset="true"><span data-slate-string="true">conn_max_lifetime: </span></span></span><span data-slate-object="text" data-key="1598"><span data-slate-leaf="true" data-offset-key="1598:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1599"><span data-slate-leaf="true" data-offset-key="1599:0" data-first-offset="true"><span data-slate-string="true">h # 通用配置，连接数最大生命周期</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1600"><span data-slate-object="text" data-key="1601"><span data-slate-leaf="true" data-offset-key="1601:0" data-first-offset="true"><span data-slate-string="true">protocol: tcp # 通用配置，传输协议</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1602"><span data-slate-object="text" data-key="1603"><span data-slate-leaf="true" data-offset-key="1603:0" data-first-offset="true"><span data-slate-string="true">loc: Local # 通用配置，时区</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1604"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1605"><span data-slate-object="text" data-key="1606"><span data-slate-leaf="true" data-offset-key="1606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">default</span></span></span></span><span data-slate-object="text" data-key="1607"><span data-slate-leaf="true" data-offset-key="1607:0" data-first-offset="true"><span data-slate-string="true">:</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1608"><span data-slate-object="text" data-key="1609"><span data-slate-leaf="true" data-offset-key="1609:0" data-first-offset="true"><span data-slate-string="true">    driver: mysql # 连接驱动</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1610"><span data-slate-object="text" data-key="1611"><span data-slate-leaf="true" data-offset-key="1611:0" data-first-offset="true"><span data-slate-string="true">    dsn: </span></span></span><span data-slate-object="text" data-key="1612"><span data-slate-leaf="true" data-offset-key="1612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">""</span></span></span></span><span data-slate-object="text" data-key="1613"><span data-slate-leaf="true" data-offset-key="1613:0" data-first-offset="true"><span data-slate-string="true"> # dsn，如果设置了 dsn, 以下的所有设置都不生效</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1614"><span data-slate-object="text" data-key="1615"><span data-slate-leaf="true" data-offset-key="1615:0" data-first-offset="true"><span data-slate-string="true">    host: localhost # ip 地址</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1616"><span data-slate-object="text" data-key="1617"><span data-slate-leaf="true" data-offset-key="1617:0" data-first-offset="true"><span data-slate-string="true">    port: </span></span></span><span data-slate-object="text" data-key="1618"><span data-slate-leaf="true" data-offset-key="1618:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">3306</span></span></span></span><span data-slate-object="text" data-key="1619"><span data-slate-leaf="true" data-offset-key="1619:0" data-first-offset="true"><span data-slate-string="true"> # 端口</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1620"><span data-slate-object="text" data-key="1621"><span data-slate-leaf="true" data-offset-key="1621:0" data-first-offset="true"><span data-slate-string="true">    database: coredemo # 数据库</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1622"><span data-slate-object="text" data-key="1623"><span data-slate-leaf="true" data-offset-key="1623:0" data-first-offset="true"><span data-slate-string="true">    username: jianfengye # 用户名</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1624"><span data-slate-object="text" data-key="1625"><span data-slate-leaf="true" data-offset-key="1625:0" data-first-offset="true"><span data-slate-string="true">    password: </span></span></span><span data-slate-object="text" data-key="1626"><span data-slate-leaf="true" data-offset-key="1626:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"123456789"</span></span></span></span><span data-slate-object="text" data-key="1627"><span data-slate-leaf="true" data-offset-key="1627:0" data-first-offset="true"><span data-slate-string="true"> # 密码</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1628"><span data-slate-object="text" data-key="1629"><span data-slate-leaf="true" data-offset-key="1629:0" data-first-offset="true"><span data-slate-string="true">    charset: utf8mb4 # 字符集</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1630"><span data-slate-object="text" data-key="1631"><span data-slate-leaf="true" data-offset-key="1631:0" data-first-offset="true"><span data-slate-string="true">    collation: utf8mb4_unicode_ci # 字符序</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1632"><span data-slate-object="text" data-key="1633"><span data-slate-leaf="true" data-offset-key="1633:0" data-first-offset="true"><span data-slate-string="true">    timeout: </span></span></span><span data-slate-object="text" data-key="1634"><span data-slate-leaf="true" data-offset-key="1634:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="1635"><span data-slate-leaf="true" data-offset-key="1635:0" data-first-offset="true"><span data-slate-string="true">s # 连接超时</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1636"><span data-slate-object="text" data-key="1637"><span data-slate-leaf="true" data-offset-key="1637:0" data-first-offset="true"><span data-slate-string="true">    read_timeout: </span></span></span><span data-slate-object="text" data-key="1638"><span data-slate-leaf="true" data-offset-key="1638:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="1639"><span data-slate-leaf="true" data-offset-key="1639:0" data-first-offset="true"><span data-slate-string="true">s # 读超时</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1640"><span data-slate-object="text" data-key="1641"><span data-slate-leaf="true" data-offset-key="1641:0" data-first-offset="true"><span data-slate-string="true">    write_timeout: </span></span></span><span data-slate-object="text" data-key="1642"><span data-slate-leaf="true" data-offset-key="1642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2</span></span></span></span><span data-slate-object="text" data-key="1643"><span data-slate-leaf="true" data-offset-key="1643:0" data-first-offset="true"><span data-slate-string="true">s # 写超时</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1644"><span data-slate-object="text" data-key="1645"><span data-slate-leaf="true" data-offset-key="1645:0" data-first-offset="true"><span data-slate-string="true">    parse_time: </span></span></span><span data-slate-object="text" data-key="1646"><span data-slate-leaf="true" data-offset-key="1646:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="1647"><span data-slate-leaf="true" data-offset-key="1647:0" data-first-offset="true"><span data-slate-string="true"> # 是否解析时间</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1648"><span data-slate-object="text" data-key="1649"><span data-slate-leaf="true" data-offset-key="1649:0" data-first-offset="true"><span data-slate-string="true">    protocol: tcp # 传输协议</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1650"><span data-slate-object="text" data-key="1651"><span data-slate-leaf="true" data-offset-key="1651:0" data-first-offset="true"><span data-slate-string="true">    loc: Local # 时区</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1652"><span data-slate-object="text" data-key="1653"><span data-slate-leaf="true" data-offset-key="1653:0" data-first-offset="true"><span data-slate-string="true">我们想在 coredemo 数据库中增加一个 user 表，按照 Gorm 的规范，需要先定义一个数据结构 User。在 app/http/module/demo/model.go 中：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1654"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1655"><span data-slate-object="text" data-key="1656"><span data-slate-leaf="true" data-offset-key="1656:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// User is gorm model</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1657"><span data-slate-object="text" data-key="1658"><span data-slate-leaf="true" data-offset-key="1658:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="1659"><span data-slate-leaf="true" data-offset-key="1659:0" data-first-offset="true"><span data-slate-string="true"> User </span></span></span><span data-slate-object="text" data-key="1660"><span data-slate-leaf="true" data-offset-key="1660:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="1661"><span data-slate-leaf="true" data-offset-key="1661:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1662"><span data-slate-object="text" data-key="1663"><span data-slate-leaf="true" data-offset-key="1663:0" data-first-offset="true"><span data-slate-string="true">   ID           </span></span></span><span data-slate-object="text" data-key="1664"><span data-slate-leaf="true" data-offset-key="1664:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1665"><span data-slate-object="text" data-key="1666"><span data-slate-leaf="true" data-offset-key="1666:0" data-first-offset="true"><span data-slate-string="true">   Name         </span></span></span><span data-slate-object="text" data-key="1667"><span data-slate-leaf="true" data-offset-key="1667:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1668"><span data-slate-object="text" data-key="1669"><span data-slate-leaf="true" data-offset-key="1669:0" data-first-offset="true"><span data-slate-string="true">   Email        *</span></span></span><span data-slate-object="text" data-key="1670"><span data-slate-leaf="true" data-offset-key="1670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1671"><span data-slate-object="text" data-key="1672"><span data-slate-leaf="true" data-offset-key="1672:0" data-first-offset="true"><span data-slate-string="true">   Age          </span></span></span><span data-slate-object="text" data-key="1673"><span data-slate-leaf="true" data-offset-key="1673:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint8</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1674"><span data-slate-object="text" data-key="1675"><span data-slate-leaf="true" data-offset-key="1675:0" data-first-offset="true"><span data-slate-string="true">   Birthday     *time.Time</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1676"><span data-slate-object="text" data-key="1677"><span data-slate-leaf="true" data-offset-key="1677:0" data-first-offset="true"><span data-slate-string="true">   MemberNumber sql.NullString</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1678"><span data-slate-object="text" data-key="1679"><span data-slate-leaf="true" data-offset-key="1679:0" data-first-offset="true"><span data-slate-string="true">   ActivatedAt  sql.NullTime</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1680"><span data-slate-object="text" data-key="1681"><span data-slate-leaf="true" data-offset-key="1681:0" data-first-offset="true"><span data-slate-string="true">   CreatedAt    time.Time</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1682"><span data-slate-object="text" data-key="1683"><span data-slate-leaf="true" data-offset-key="1683:0" data-first-offset="true"><span data-slate-string="true">   UpdatedAt    time.Time</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1684"><span data-slate-object="text" data-key="1685"><span data-slate-leaf="true" data-offset-key="1685:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1686"><span data-slate-object="text" data-key="1687"><span data-slate-leaf="true" data-offset-key="1687:0" data-first-offset="true"><span data-slate-string="true">然后在应用目录 app/http/module/demo/api_orm.go 中，定义了一个新的路由方法 DemoOrm，在这个方法中，我们先从容器中获取到 gorm.DB 的实例，然后使用 db.AutoMigrate 同步数据表 user。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1688"><span data-slate-object="text" data-key="1689"><span data-slate-leaf="true" data-offset-key="1689:0" data-first-offset="true"><span data-slate-string="true">如果第一次执行的时候，数据库中没有表 user，它会自动创建 user 表，然后分别调用 db.Create、db.Save、db.First、db.Delete 来对 user 表进行增删改查操作：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1690"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div><div data-code-line-number="42"></div><div data-code-line-number="43"></div><div data-code-line-number="44"></div><div data-code-line-number="45"></div><div data-code-line-number="46"></div><div data-code-line-number="47"></div><div data-code-line-number="48"></div><div data-code-line-number="49"></div><div data-code-line-number="50"></div><div data-code-line-number="51"></div><div data-code-line-number="52"></div><div data-code-line-number="53"></div><div data-code-line-number="54"></div><div data-code-line-number="55"></div><div data-code-line-number="56"></div><div data-code-line-number="57"></div><div data-code-line-number="58"></div><div data-code-line-number="59"></div><div data-code-line-number="60"></div><div data-code-line-number="61"></div><div data-code-line-number="62"></div><div data-code-line-number="63"></div><div data-code-line-number="64"></div><div data-code-line-number="65"></div><div data-code-line-number="66"></div><div data-code-line-number="67"></div><div data-code-line-number="68"></div><div data-code-line-number="69"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1691"><span data-slate-object="text" data-key="1692"><span data-slate-leaf="true" data-offset-key="1692:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// DemoOrm Orm 的路由方法</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1693"><span data-slate-object="text" data-key="1694"><span data-slate-leaf="true" data-offset-key="1694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1695"><span data-slate-leaf="true" data-offset-key="1695:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1696"><span data-slate-leaf="true" data-offset-key="1696:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(api *DemoApi)</span></span></span></span></span><span data-slate-object="text" data-key="1697"><span data-slate-leaf="true" data-offset-key="1697:0" data-first-offset="true"><span data-slate-string="true"> DemoOrm(c *gin.Context) {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1698"><span data-slate-object="text" data-key="1699"><span data-slate-leaf="true" data-offset-key="1699:0" data-first-offset="true"><span data-slate-string="true">    logger := c.MustMakeLog()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1700"><span data-slate-object="text" data-key="1701"><span data-slate-leaf="true" data-offset-key="1701:0" data-first-offset="true"><span data-slate-string="true">    logger.Info(c, </span></span></span><span data-slate-object="text" data-key="1702"><span data-slate-leaf="true" data-offset-key="1702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"request start"</span></span></span></span><span data-slate-object="text" data-key="1703"><span data-slate-leaf="true" data-offset-key="1703:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1704"><span data-slate-leaf="true" data-offset-key="1704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1705"><span data-slate-leaf="true" data-offset-key="1705:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1706"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1707"><span data-slate-object="text" data-key="1708"><span data-slate-leaf="true" data-offset-key="1708:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1709"><span data-slate-leaf="true" data-offset-key="1709:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 初始化一个 orm.DB</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1710"><span data-slate-object="text" data-key="1711"><span data-slate-leaf="true" data-offset-key="1711:0" data-first-offset="true"><span data-slate-string="true">    gormService := c.MustMake(contract.ORMKey).(contract.ORMService)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1712"><span data-slate-object="text" data-key="1713"><span data-slate-leaf="true" data-offset-key="1713:0" data-first-offset="true"><span data-slate-string="true">    db, err := gormService.GetDB(orm.WithConfigPath(</span></span></span><span data-slate-object="text" data-key="1714"><span data-slate-leaf="true" data-offset-key="1714:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"database.default"</span></span></span></span><span data-slate-object="text" data-key="1715"><span data-slate-leaf="true" data-offset-key="1715:0" data-first-offset="true"><span data-slate-string="true">))</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1716"><span data-slate-object="text" data-key="1717"><span data-slate-leaf="true" data-offset-key="1717:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1718"><span data-slate-leaf="true" data-offset-key="1718:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1719"><span data-slate-leaf="true" data-offset-key="1719:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1720"><span data-slate-leaf="true" data-offset-key="1720:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1721"><span data-slate-leaf="true" data-offset-key="1721:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1722"><span data-slate-object="text" data-key="1723"><span data-slate-leaf="true" data-offset-key="1723:0" data-first-offset="true"><span data-slate-string="true">        logger.Error(c, err.Error(), </span></span></span><span data-slate-object="text" data-key="1724"><span data-slate-leaf="true" data-offset-key="1724:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1725"><span data-slate-leaf="true" data-offset-key="1725:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1726"><span data-slate-object="text" data-key="1727"><span data-slate-leaf="true" data-offset-key="1727:0" data-first-offset="true"><span data-slate-string="true">        c.AbortWithError(</span></span></span><span data-slate-object="text" data-key="1728"><span data-slate-leaf="true" data-offset-key="1728:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">50001</span></span></span></span><span data-slate-object="text" data-key="1729"><span data-slate-leaf="true" data-offset-key="1729:0" data-first-offset="true"><span data-slate-string="true">, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1730"><span data-slate-object="text" data-key="1731"><span data-slate-leaf="true" data-offset-key="1731:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1732"><span data-slate-leaf="true" data-offset-key="1732:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1733"><span data-slate-object="text" data-key="1734"><span data-slate-leaf="true" data-offset-key="1734:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1735"><span data-slate-object="text" data-key="1736"><span data-slate-leaf="true" data-offset-key="1736:0" data-first-offset="true"><span data-slate-string="true">    db.WithContext(c)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1737"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1738"><span data-slate-object="text" data-key="1739"><span data-slate-leaf="true" data-offset-key="1739:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1740"><span data-slate-leaf="true" data-offset-key="1740:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 将 User 模型创建到数据库中</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1741"><span data-slate-object="text" data-key="1742"><span data-slate-leaf="true" data-offset-key="1742:0" data-first-offset="true"><span data-slate-string="true">    err = db.AutoMigrate(&amp;User{})</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1743"><span data-slate-object="text" data-key="1744"><span data-slate-leaf="true" data-offset-key="1744:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1745"><span data-slate-leaf="true" data-offset-key="1745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="1746"><span data-slate-leaf="true" data-offset-key="1746:0" data-first-offset="true"><span data-slate-string="true"> err != </span></span></span><span data-slate-object="text" data-key="1747"><span data-slate-leaf="true" data-offset-key="1747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1748"><span data-slate-leaf="true" data-offset-key="1748:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1749"><span data-slate-object="text" data-key="1750"><span data-slate-leaf="true" data-offset-key="1750:0" data-first-offset="true"><span data-slate-string="true">        c.AbortWithError(</span></span></span><span data-slate-object="text" data-key="1751"><span data-slate-leaf="true" data-offset-key="1751:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">500</span></span></span></span><span data-slate-object="text" data-key="1752"><span data-slate-leaf="true" data-offset-key="1752:0" data-first-offset="true"><span data-slate-string="true">, err)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1753"><span data-slate-object="text" data-key="1754"><span data-slate-leaf="true" data-offset-key="1754:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1755"><span data-slate-leaf="true" data-offset-key="1755:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1756"><span data-slate-object="text" data-key="1757"><span data-slate-leaf="true" data-offset-key="1757:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1758"><span data-slate-object="text" data-key="1759"><span data-slate-leaf="true" data-offset-key="1759:0" data-first-offset="true"><span data-slate-string="true">    logger.Info(c, </span></span></span><span data-slate-object="text" data-key="1760"><span data-slate-leaf="true" data-offset-key="1760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"migrate ok"</span></span></span></span><span data-slate-object="text" data-key="1761"><span data-slate-leaf="true" data-offset-key="1761:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1762"><span data-slate-leaf="true" data-offset-key="1762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="1763"><span data-slate-leaf="true" data-offset-key="1763:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1764"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1765"><span data-slate-object="text" data-key="1766"><span data-slate-leaf="true" data-offset-key="1766:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1767"><span data-slate-leaf="true" data-offset-key="1767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 插入一条数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1768"><span data-slate-object="text" data-key="1769"><span data-slate-leaf="true" data-offset-key="1769:0" data-first-offset="true"><span data-slate-string="true">    email := </span></span></span><span data-slate-object="text" data-key="1770"><span data-slate-leaf="true" data-offset-key="1770:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo@gmail.com"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1771"><span data-slate-object="text" data-key="1772"><span data-slate-leaf="true" data-offset-key="1772:0" data-first-offset="true"><span data-slate-string="true">    name := </span></span></span><span data-slate-object="text" data-key="1773"><span data-slate-leaf="true" data-offset-key="1773:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"foo"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1774"><span data-slate-object="text" data-key="1775"><span data-slate-leaf="true" data-offset-key="1775:0" data-first-offset="true"><span data-slate-string="true">    age := </span></span></span><span data-slate-object="text" data-key="1776"><span data-slate-leaf="true" data-offset-key="1776:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint8</span></span></span></span><span data-slate-object="text" data-key="1777"><span data-slate-leaf="true" data-offset-key="1777:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="1778"><span data-slate-leaf="true" data-offset-key="1778:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">25</span></span></span></span><span data-slate-object="text" data-key="1779"><span data-slate-leaf="true" data-offset-key="1779:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1780"><span data-slate-object="text" data-key="1781"><span data-slate-leaf="true" data-offset-key="1781:0" data-first-offset="true"><span data-slate-string="true">    birthday := time.Date(</span></span></span><span data-slate-object="text" data-key="1782"><span data-slate-leaf="true" data-offset-key="1782:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">2001</span></span></span></span><span data-slate-object="text" data-key="1783"><span data-slate-leaf="true" data-offset-key="1783:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1784"><span data-slate-leaf="true" data-offset-key="1784:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1785"><span data-slate-leaf="true" data-offset-key="1785:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1786"><span data-slate-leaf="true" data-offset-key="1786:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1787"><span data-slate-leaf="true" data-offset-key="1787:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1788"><span data-slate-leaf="true" data-offset-key="1788:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1789"><span data-slate-leaf="true" data-offset-key="1789:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1790"><span data-slate-leaf="true" data-offset-key="1790:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1791"><span data-slate-leaf="true" data-offset-key="1791:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1792"><span data-slate-leaf="true" data-offset-key="1792:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1793"><span data-slate-leaf="true" data-offset-key="1793:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1794"><span data-slate-leaf="true" data-offset-key="1794:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="1795"><span data-slate-leaf="true" data-offset-key="1795:0" data-first-offset="true"><span data-slate-string="true">, time.Local)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1796"><span data-slate-object="text" data-key="1797"><span data-slate-leaf="true" data-offset-key="1797:0" data-first-offset="true"><span data-slate-string="true">    user := &amp;User{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1798"><span data-slate-object="text" data-key="1799"><span data-slate-leaf="true" data-offset-key="1799:0" data-first-offset="true"><span data-slate-string="true">        Name:         name,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1800"><span data-slate-object="text" data-key="1801"><span data-slate-leaf="true" data-offset-key="1801:0" data-first-offset="true"><span data-slate-string="true">        Email:        &amp;email,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1802"><span data-slate-object="text" data-key="1803"><span data-slate-leaf="true" data-offset-key="1803:0" data-first-offset="true"><span data-slate-string="true">        Age:          age,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1804"><span data-slate-object="text" data-key="1805"><span data-slate-leaf="true" data-offset-key="1805:0" data-first-offset="true"><span data-slate-string="true">        Birthday:     &amp;birthday,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1806"><span data-slate-object="text" data-key="1807"><span data-slate-leaf="true" data-offset-key="1807:0" data-first-offset="true"><span data-slate-string="true">        MemberNumber: sql.NullString{},</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1808"><span data-slate-object="text" data-key="1809"><span data-slate-leaf="true" data-offset-key="1809:0" data-first-offset="true"><span data-slate-string="true">        ActivatedAt:  sql.NullTime{},</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1810"><span data-slate-object="text" data-key="1811"><span data-slate-leaf="true" data-offset-key="1811:0" data-first-offset="true"><span data-slate-string="true">        CreatedAt:    time.Now(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1812"><span data-slate-object="text" data-key="1813"><span data-slate-leaf="true" data-offset-key="1813:0" data-first-offset="true"><span data-slate-string="true">        UpdatedAt:    time.Now(),</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1814"><span data-slate-object="text" data-key="1815"><span data-slate-leaf="true" data-offset-key="1815:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1816"><span data-slate-object="text" data-key="1817"><span data-slate-leaf="true" data-offset-key="1817:0" data-first-offset="true"><span data-slate-string="true">    err = db.Create(user).Error</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1818"><span data-slate-object="text" data-key="1819"><span data-slate-leaf="true" data-offset-key="1819:0" data-first-offset="true"><span data-slate-string="true">    logger.Info(c, </span></span></span><span data-slate-object="text" data-key="1820"><span data-slate-leaf="true" data-offset-key="1820:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"insert user"</span></span></span></span><span data-slate-object="text" data-key="1821"><span data-slate-leaf="true" data-offset-key="1821:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1822"><span data-slate-leaf="true" data-offset-key="1822:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1823"><span data-slate-leaf="true" data-offset-key="1823:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1824"><span data-slate-leaf="true" data-offset-key="1824:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1825"><span data-slate-leaf="true" data-offset-key="1825:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1826"><span data-slate-leaf="true" data-offset-key="1826:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1827"><span data-slate-leaf="true" data-offset-key="1827:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1828"><span data-slate-object="text" data-key="1829"><span data-slate-leaf="true" data-offset-key="1829:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1830"><span data-slate-leaf="true" data-offset-key="1830:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="1831"><span data-slate-leaf="true" data-offset-key="1831:0" data-first-offset="true"><span data-slate-string="true">:  user.ID,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1832"><span data-slate-object="text" data-key="1833"><span data-slate-leaf="true" data-offset-key="1833:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1834"><span data-slate-leaf="true" data-offset-key="1834:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"err"</span></span></span></span><span data-slate-object="text" data-key="1835"><span data-slate-leaf="true" data-offset-key="1835:0" data-first-offset="true"><span data-slate-string="true">: err,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1836"><span data-slate-object="text" data-key="1837"><span data-slate-leaf="true" data-offset-key="1837:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1838"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1839"><span data-slate-object="text" data-key="1840"><span data-slate-leaf="true" data-offset-key="1840:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1841"><span data-slate-leaf="true" data-offset-key="1841:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 更新一条数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1842"><span data-slate-object="text" data-key="1843"><span data-slate-leaf="true" data-offset-key="1843:0" data-first-offset="true"><span data-slate-string="true">    user.Name = </span></span></span><span data-slate-object="text" data-key="1844"><span data-slate-leaf="true" data-offset-key="1844:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"bar"</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1845"><span data-slate-object="text" data-key="1846"><span data-slate-leaf="true" data-offset-key="1846:0" data-first-offset="true"><span data-slate-string="true">    err = db.Save(user).Error</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1847"><span data-slate-object="text" data-key="1848"><span data-slate-leaf="true" data-offset-key="1848:0" data-first-offset="true"><span data-slate-string="true">    logger.Info(c, </span></span></span><span data-slate-object="text" data-key="1849"><span data-slate-leaf="true" data-offset-key="1849:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"update user"</span></span></span></span><span data-slate-object="text" data-key="1850"><span data-slate-leaf="true" data-offset-key="1850:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1851"><span data-slate-leaf="true" data-offset-key="1851:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1852"><span data-slate-leaf="true" data-offset-key="1852:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1853"><span data-slate-leaf="true" data-offset-key="1853:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1854"><span data-slate-leaf="true" data-offset-key="1854:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1855"><span data-slate-leaf="true" data-offset-key="1855:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1856"><span data-slate-leaf="true" data-offset-key="1856:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1857"><span data-slate-object="text" data-key="1858"><span data-slate-leaf="true" data-offset-key="1858:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1859"><span data-slate-leaf="true" data-offset-key="1859:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"err"</span></span></span></span><span data-slate-object="text" data-key="1860"><span data-slate-leaf="true" data-offset-key="1860:0" data-first-offset="true"><span data-slate-string="true">: err,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1861"><span data-slate-object="text" data-key="1862"><span data-slate-leaf="true" data-offset-key="1862:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1863"><span data-slate-leaf="true" data-offset-key="1863:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="1864"><span data-slate-leaf="true" data-offset-key="1864:0" data-first-offset="true"><span data-slate-string="true">:  user.ID,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1865"><span data-slate-object="text" data-key="1866"><span data-slate-leaf="true" data-offset-key="1866:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1867"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1868"><span data-slate-object="text" data-key="1869"><span data-slate-leaf="true" data-offset-key="1869:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1870"><span data-slate-leaf="true" data-offset-key="1870:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 查询一条数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1871"><span data-slate-object="text" data-key="1872"><span data-slate-leaf="true" data-offset-key="1872:0" data-first-offset="true"><span data-slate-string="true">    queryUser := &amp;User{ID: user.ID}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1873"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1874"><span data-slate-object="text" data-key="1875"><span data-slate-leaf="true" data-offset-key="1875:0" data-first-offset="true"><span data-slate-string="true">    err = db.First(queryUser).Error</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1876"><span data-slate-object="text" data-key="1877"><span data-slate-leaf="true" data-offset-key="1877:0" data-first-offset="true"><span data-slate-string="true">    logger.Info(c, </span></span></span><span data-slate-object="text" data-key="1878"><span data-slate-leaf="true" data-offset-key="1878:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"query user"</span></span></span></span><span data-slate-object="text" data-key="1879"><span data-slate-leaf="true" data-offset-key="1879:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1880"><span data-slate-leaf="true" data-offset-key="1880:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1881"><span data-slate-leaf="true" data-offset-key="1881:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1882"><span data-slate-leaf="true" data-offset-key="1882:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1883"><span data-slate-leaf="true" data-offset-key="1883:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1884"><span data-slate-leaf="true" data-offset-key="1884:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1885"><span data-slate-leaf="true" data-offset-key="1885:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1886"><span data-slate-object="text" data-key="1887"><span data-slate-leaf="true" data-offset-key="1887:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1888"><span data-slate-leaf="true" data-offset-key="1888:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"err"</span></span></span></span><span data-slate-object="text" data-key="1889"><span data-slate-leaf="true" data-offset-key="1889:0" data-first-offset="true"><span data-slate-string="true">:  err,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1890"><span data-slate-object="text" data-key="1891"><span data-slate-leaf="true" data-offset-key="1891:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1892"><span data-slate-leaf="true" data-offset-key="1892:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"name"</span></span></span></span><span data-slate-object="text" data-key="1893"><span data-slate-leaf="true" data-offset-key="1893:0" data-first-offset="true"><span data-slate-string="true">: queryUser.Name,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1894"><span data-slate-object="text" data-key="1895"><span data-slate-leaf="true" data-offset-key="1895:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1896"></div><div data-slate-type="code-line" data-slate-object="block" data-key="1897"><span data-slate-object="text" data-key="1898"><span data-slate-leaf="true" data-offset-key="1898:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="1899"><span data-slate-leaf="true" data-offset-key="1899:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 删除一条数据</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1900"><span data-slate-object="text" data-key="1901"><span data-slate-leaf="true" data-offset-key="1901:0" data-first-offset="true"><span data-slate-string="true">    err = db.Delete(queryUser).Error</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1902"><span data-slate-object="text" data-key="1903"><span data-slate-leaf="true" data-offset-key="1903:0" data-first-offset="true"><span data-slate-string="true">    logger.Info(c, </span></span></span><span data-slate-object="text" data-key="1904"><span data-slate-leaf="true" data-offset-key="1904:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"delete user"</span></span></span></span><span data-slate-object="text" data-key="1905"><span data-slate-leaf="true" data-offset-key="1905:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1906"><span data-slate-leaf="true" data-offset-key="1906:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">map</span></span></span></span><span data-slate-object="text" data-key="1907"><span data-slate-leaf="true" data-offset-key="1907:0" data-first-offset="true"><span data-slate-string="true">[</span></span></span><span data-slate-object="text" data-key="1908"><span data-slate-leaf="true" data-offset-key="1908:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">string</span></span></span></span><span data-slate-object="text" data-key="1909"><span data-slate-leaf="true" data-offset-key="1909:0" data-first-offset="true"><span data-slate-string="true">]</span></span></span><span data-slate-object="text" data-key="1910"><span data-slate-leaf="true" data-offset-key="1910:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">interface</span></span></span></span><span data-slate-object="text" data-key="1911"><span data-slate-leaf="true" data-offset-key="1911:0" data-first-offset="true"><span data-slate-string="true">{}{</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1912"><span data-slate-object="text" data-key="1913"><span data-slate-leaf="true" data-offset-key="1913:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1914"><span data-slate-leaf="true" data-offset-key="1914:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"err"</span></span></span></span><span data-slate-object="text" data-key="1915"><span data-slate-leaf="true" data-offset-key="1915:0" data-first-offset="true"><span data-slate-string="true">: err,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1916"><span data-slate-object="text" data-key="1917"><span data-slate-leaf="true" data-offset-key="1917:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="1918"><span data-slate-leaf="true" data-offset-key="1918:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"id"</span></span></span></span><span data-slate-object="text" data-key="1919"><span data-slate-leaf="true" data-offset-key="1919:0" data-first-offset="true"><span data-slate-string="true">:  user.ID,</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1920"><span data-slate-object="text" data-key="1921"><span data-slate-leaf="true" data-offset-key="1921:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1922"><span data-slate-object="text" data-key="1923"><span data-slate-leaf="true" data-offset-key="1923:0" data-first-offset="true"><span data-slate-string="true">    c.JSON(</span></span></span><span data-slate-object="text" data-key="1924"><span data-slate-leaf="true" data-offset-key="1924:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">200</span></span></span></span><span data-slate-object="text" data-key="1925"><span data-slate-leaf="true" data-offset-key="1925:0" data-first-offset="true"><span data-slate-string="true">, </span></span></span><span data-slate-object="text" data-key="1926"><span data-slate-leaf="true" data-offset-key="1926:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"ok"</span></span></span></span><span data-slate-object="text" data-key="1927"><span data-slate-leaf="true" data-offset-key="1927:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1928"><span data-slate-object="text" data-key="1929"><span data-slate-leaf="true" data-offset-key="1929:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1930"><span data-slate-object="text" data-key="1931"><span data-slate-leaf="true" data-offset-key="1931:0" data-first-offset="true"><span data-slate-string="true">记得修改 app/http/module/demo/api.go 中的路由注册：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="1932"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="1933"><span data-slate-object="text" data-key="1934"><span data-slate-leaf="true" data-offset-key="1934:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="1935"><span data-slate-leaf="true" data-offset-key="1935:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="1936"><span data-slate-leaf="true" data-offset-key="1936:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">Register</span></span></span></span></span><span data-slate-object="text" data-key="1937"><span data-slate-leaf="true" data-offset-key="1937:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(r *gin.Engine)</span></span></span></span></span><span data-slate-object="text" data-key="1938"><span data-slate-leaf="true" data-offset-key="1938:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1939"><span data-slate-leaf="true" data-offset-key="1939:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">error</span></span></span></span><span data-slate-object="text" data-key="1940"><span data-slate-leaf="true" data-offset-key="1940:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1941"><span data-slate-object="text" data-key="1942"><span data-slate-leaf="true" data-offset-key="1942:0" data-first-offset="true"><span data-slate-string="true">   api := NewDemoApi()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1943"><span data-slate-object="text" data-key="1944"><span data-slate-leaf="true" data-offset-key="1944:0" data-first-offset="true"><span data-slate-string="true">   ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1945"><span data-slate-object="text" data-key="1946"><span data-slate-leaf="true" data-offset-key="1946:0" data-first-offset="true"><span data-slate-string="true">   r.GET(</span></span></span><span data-slate-object="text" data-key="1947"><span data-slate-leaf="true" data-offset-key="1947:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"/demo/orm"</span></span></span></span><span data-slate-object="text" data-key="1948"><span data-slate-leaf="true" data-offset-key="1948:0" data-first-offset="true"><span data-slate-string="true">, api.DemoOrm)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1949"><span data-slate-object="text" data-key="1950"><span data-slate-leaf="true" data-offset-key="1950:0" data-first-offset="true"><span data-slate-string="true">   </span></span></span><span data-slate-object="text" data-key="1951"><span data-slate-leaf="true" data-offset-key="1951:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="1952"><span data-slate-leaf="true" data-offset-key="1952:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="1953"><span data-slate-leaf="true" data-offset-key="1953:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="1954"><span data-slate-object="text" data-key="1955"><span data-slate-leaf="true" data-offset-key="1955:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1956"><span data-slate-object="text" data-key="1957"><span data-slate-leaf="true" data-offset-key="1957:0" data-first-offset="true"><span data-slate-string="true">现在，使用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="1958"><span data-slate-object="text" data-key="1959"><span data-slate-leaf="true" data-offset-key="1959:0" data-first-offset="true"><span data-slate-string="true">./hade build self</span></span></span></span><span data-slate-object="text" data-key="1960"><span data-slate-leaf="true" data-offset-key="1960:0" data-first-offset="true"><span data-slate-string="true"> 来重新编译 hade 文件，使用 </span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="1961"><span data-slate-object="text" data-key="1962"><span data-slate-leaf="true" data-offset-key="1962:0" data-first-offset="true"><span data-slate-string="true">./hade app start</span></span></span></span><span data-slate-object="text" data-key="1963"><span data-slate-leaf="true" data-offset-key="1963:0" data-first-offset="true"><span data-slate-string="true"> 启动服务，并挂起在控制台，日志会输出到控制台。浏览器调用 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="1964" one-link-mark="yes"><span data-slate-object="text" data-key="1965"><span data-slate-leaf="true" data-offset-key="1965:0" data-first-offset="true"><span data-slate-string="true">http://localhost:8888/demo/orm</span></span></span></a><span data-slate-object="text" data-key="1966"><span data-slate-leaf="true" data-offset-key="1966:0" data-first-offset="true"><span data-slate-string="true"> ，控制台打印日志如下：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1967"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/a0/1f7ec4246a851faa3e4f6c9eebfbbda0.png?wh=1920x559"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1968"><span data-slate-object="text" data-key="1969"><span data-slate-leaf="true" data-offset-key="1969:0" data-first-offset="true"><span data-slate-string="true">可以清晰地通过 trace 日志看到底层的 Insert/Update/Select/Delete 的操作，并且可以通过 time 字段看到这个请求的具体耗时。到这里 Gorm 融合 hade 框架就验证完成了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1970"><span data-slate-object="text" data-key="1971"><span data-slate-leaf="true" data-offset-key="1971:0" data-first-offset="true"><span data-slate-string="true">本节课我们主要修改了 framework 目录下的 contract/orm.go 和 provider/orm 目录。目录截图如下，供对比查看，所有代码都已经上传到 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="1972" one-link-mark="yes"><span data-slate-object="text" data-key="1973"><span data-slate-leaf="true" data-offset-key="1973:0" data-first-offset="true"><span data-slate-string="true">geekbang/25</span></span></span></a><span data-slate-object="text" data-key="1974"><span data-slate-leaf="true" data-offset-key="1974:0" data-first-offset="true"><span data-slate-string="true"> 分支了。</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="1975"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/07/00/071144ba671c077937f76a9627263000.png?wh=922x1618"></div></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1976" id="sr-toc-9"><span data-slate-object="text" data-key="1977"><span data-slate-leaf="true" data-offset-key="1977:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1978"><span data-slate-object="text" data-key="1979"><span data-slate-leaf="true" data-offset-key="1979:0" data-first-offset="true"><span data-slate-string="true">对于 Gorm 这样比较庞大的库，要把 Gorm 完美集成到 hade 框架，更好地支持业务对数据库频繁的增删改查操作，我们并不是一开始就动手修改代码，而是先把 Gorm 的实例化部分的源码都理清楚了，再动手集成才不会出现问题。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1980"><span data-slate-object="text" data-key="1981"><span data-slate-leaf="true" data-offset-key="1981:0" data-first-offset="true"><span data-slate-string="true">现在我们可以在 hade 框架中方便获取到 gorm.DB 了。但是在具体开发业务的时候，如何使用好 Gorm 来为业务服务，也是一个非常值得花心思研究的课题。好在我们的技术选型是目前 Golang 业界最火的 Gorm，网络上关于如何使用 Gorm 的课程有非常多了，在具体开发业务的时候，你可以自己参考和研究。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="1982" id="sr-toc-10"><span data-slate-object="text" data-key="1983"><span data-slate-leaf="true" data-offset-key="1983:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="1984"><span data-slate-object="text" data-key="1985"><span data-slate-leaf="true" data-offset-key="1985:0" data-first-offset="true"><span data-slate-string="true">在 ORM 框架中，model 层的存放位置一直是个很有争论的话题。比如 geekbang/25 分支上 model 层的 User 结构，我存放在 app/http/module/demo 中，有同学会觉得 model 层放在 app/http/model 目录比较好么？具体 model 是否应该单独作为一个文件夹出来呢？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="1986"><span data-slate-object="text" data-key="1987"><span data-slate-leaf="true" data-offset-key="1987:0" data-first-offset="true"><span data-slate-string="true">欢迎在留言区分享你的思考。感谢你的收听，如果你觉得今天的内容对你有所帮助，也欢迎分享给你身边的朋友，邀请他一起学习。我们下节课见～</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><a href="javascript:void(0);" one-link-mark="yes">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/60/8b/601539e39d1f599f26bffa89653fca8b.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-11">精选留言 (4)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/2b/24/3d/0682fdb9.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>宁建峰</span></div></div><div>api_orm.go 中，以下代码 gin1.8.1 已经过过限制了，999&lt;code&gt;100，所以这里使用 50001，会发生 panic：invalid WriteHeader code 50001
if err != nil { 
   logger.Error (c, err.Error (), nil) 
   c.AbortWithError (50001, err) 
   return 
}
gin v1.8.1 源码如下：
func checkWriteHeaderCode (code int) {
	// Issue 22880: require valid WriteHeader status codes.
	// For now we only enforce that it's three digits.
	// In the future we might block things over 599 (600 and above aren't defined
	//at https://httpwg.org/specs/rfc7231.html#status.codes)
	//and we might block under 200 (once we have more mature 1xx support).
	// But for now any three digits.
	//
	// We used to send "HTTP/1.1 000 0" on the wire in responses but there's
	//no equivalent bogus thing we can realistically send in HTTP/2,
	//so we'll consistently panic instead and help people find their bugs
	//early. (We can't return an error from WriteHeader even if we wanted to.)
	if code &lt; 100 || code &gt; 999 {
		panic (fmt.Sprintf ("invalid WriteHeader code % v", code))
	}
}</div><div><div>2022-08-24</div><div><div><i></i><span></span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/16/72/85/c337e9a1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 老兵</span></div></div><div>不知道是不是我理解不对，感觉目前 gorm 在数据库字段的迁移的方案还是不行。比如数据库表加一个字段，删除一个字段，用 auto-migrate 还是无法做到精准像 active_record 那样的方便吧？
不知道叶老师是否有一些 golang 下 orm+migration 的经验？
</div><div><div>2022-01-12</div><div><div><i></i><span></span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/23/50/1f5154fe.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>无笔秀才</span></div></div><div>我觉得除了 orm 还应该支持直接 sql, 毕竟很多人不喜欢用 orm</div><div><div>2022-01-11</div><div><div><i></i><span>1</span></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/29/b0/d3/200e82ff.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>功夫熊猫</span></div></div><div>我都是直接靠 Raw 直接写 sql 语句的。因为有时候不太好定义模型</div><div><p>作者回复：还是 orm 之争，哈，看来老哥属于极客型</p></div><div><div>2021-11-19</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".1"><outline class="toc-level-h1" data-reactid=".1.0" style="width: 175px;"><active data-reactid=".1.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".1.0.1"><span data-reactid=".1.0.1.0">26｜GORM（下）：数据库的使用必不可少</span></a></outline><outline class="toc-level-h2" data-reactid=".1.1" style="width: 165px;"><active data-reactid=".1.1.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".1.1.1"><span data-reactid=".1.1.1.0">ORM 服务</span></a></outline><outline class="toc-level-h3" data-reactid=".1.2" style="width: 155px;"><active data-reactid=".1.2.0"></active><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".1.2.1"><span data-reactid=".1.2.1.0">服务接口</span></a></outline><outline class="toc-level-h3" data-reactid=".1.3" style="width: 155px;"><active data-reactid=".1.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".1.3.1"><span data-reactid=".1.3.1.0">服务提供者</span></a></outline><outline class="toc-level-h2" data-reactid=".1.4" style="width: 165px;"><active data-reactid=".1.4.0"></active><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".1.4.1"><span data-reactid=".1.4.1.0">服务实例化</span></a></outline><outline class="toc-level-h3" data-reactid=".1.5" style="width: 155px;"><active data-reactid=".1.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".1.5.1"><span data-reactid=".1.5.1.0">配置</span></a></outline><outline class="toc-level-h3" data-reactid=".1.6" style="width: 155px;"><active data-reactid=".1.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".1.6.1"><span data-reactid=".1.6.1.0">日志</span></a></outline><outline class="toc-level-h3" data-reactid=".1.7" style="width: 155px;"><active data-reactid=".1.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".1.7.1"><span data-reactid=".1.7.1.0">服务实例</span></a></outline><outline class="toc-level-h2" data-reactid=".1.8" style="width: 165px;"><active data-reactid=".1.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".1.8.1"><span data-reactid=".1.8.1.0">测试</span></a></outline><outline class="toc-level-h3" data-reactid=".1.9" style="width: 155px;"><active data-reactid=".1.9.0"></active><a class="toc-outline-theme-github" href="#sr-toc-9" data-reactid=".1.9.1"><span data-reactid=".1.9.1.0">小结</span></a></outline><outline class="toc-level-h3" data-reactid=".1.a" style="width: 155px;"><active data-reactid=".1.a.0"></active><a class="toc-outline-theme-github" href="#sr-toc-10" data-reactid=".1.a.1"><span data-reactid=".1.a.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".1.b" style="width: 165px;"><active data-reactid=".1.b.0"></active><a class="toc-outline-theme-github" href="#sr-toc-11" data-reactid=".1.b.1"><span data-reactid=".1.b.1.0">精选留言 (4)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/440701" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>