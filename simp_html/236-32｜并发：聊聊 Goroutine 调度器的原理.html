
                <html lang="en" class="simpread-font simpread-theme-root" style=''>
                    <head>
                        <meta charset="utf-8">
                        <meta http-equiv="content-type" content="text/html; charset=UTF-8;charset=utf-8">
                        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
                        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
                        <meta name="author" content="Kenshin"/>
                        <meta name="description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展" />
                        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, 简悦, 简阅, read mode, reading mode, reader view, firefox, firefox addon, userscript, safari, opera, tampermonkey"/>
                        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:title" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <meta property="og:type" content="website">
                        <meta property="og:local" content="zh_CN"/>
                        <meta property="og:url" content="http://ksria.com/simpread"/>
                        <meta property="og:image" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>
                        <meta property="og:image:type" content="image/png"/>
                        <meta property="og:image:width" content="960"/>
                        <meta property="og:image:height" content="355"/>
                        <meta property="og:site_name" content="http://ksria.com/simpread"/>
                        <meta property="og:description" content="简悦 SimpRead - 如杂志般沉浸式阅读体验的扩展"/>
                        <style type="text/css">.simpread-font{font:300 16px/1.8 -apple-system,PingFang SC,Microsoft Yahei,Lantinghei SC,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#333;text-rendering:optimizelegibility;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased}.simpread-hidden{display:none}.simpread-read-root{display:-webkit-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:relative;margin:0;top:-1000px;left:0;width:100%;z-index:2147483646;overflow-x:hidden;opacity:0;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}.simpread-read-root-show{top:0}.simpread-read-root-hide{top:1000px}sr-read{display:-webkit-flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column;margin:20px 20%;min-width:400px;min-height:400px;text-align:center}read-process{position:fixed;top:0;left:0;height:3px;width:100%;background-color:#64b5f6;-webkit-transition:width 2s;transition:width 2s;z-index:20000}sr-rd-content-error{display:block;position:relative;margin:0;margin-bottom:30px;padding:25px;background-color:rgba(0,0,0,.05)}sr-rd-footer{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column;font-size:14px}sr-rd-footer,sr-rd-footer-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}sr-rd-footer-group{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-rd-footer-line{width:100%;border-top:1px solid #e0e0e0}sr-rd-footer-text{min-width:150px}sr-rd-footer-copywrite{margin:10px 0 0;color:inherit}sr-rd-footer-copywrite abbr{-webkit-font-feature-settings:normal;font-feature-settings:normal;font-variant:normal;text-decoration:none}sr-rd-footer-copywrite .second{margin:10px 0}sr-rd-footer-copywrite .third a:hover{border:none!important}sr-rd-footer-copywrite .third a:first-child{margin-right:50px}sr-rd-footer-copywrite .sr-icon{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:33px;height:33px;opacity:.8;-webkit-transition:opacity .5s ease;transition:opacity .5s ease;cursor:pointer}sr-rd-footer-copywrite .sr-icon:hover{opacity:1}sr-rd-footer-copywrite a,sr-rd-footer-copywrite a:link,sr-rd-footer-copywrite a:visited{margin:0;padding:0;color:inherit;background-color:transparent;font-size:inherit!important;line-height:normal;text-decoration:none;vertical-align:baseline;vertical-align:initial;border:none!important;box-sizing:border-box}sr-rd-footer-copywrite a:focus,sr-rd-footer-copywrite a:hover,sr-rd-footer a:active{color:inherit;text-decoration:none;border-bottom:1px dotted!important}.simpread-blocks{text-decoration:none!important}.simpread-blocks *{margin:0}.simpread-blocks a{padding:0;text-decoration:none!important}.simpread-blocks img{margin:0;padding:0;border:0;background:transparent;box-shadow:none}.simpread-focus-root{display:block;position:fixed;top:0;left:0;right:0;bottom:0;background-color:hsla(0,0%,92%,.9);z-index:2147483645;opacity:0;-webkit-transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms;transition:opacity 1s cubic-bezier(.23,1,.32,1) 0ms}.simpread-focus-highlight{position:relative;box-shadow:0 0 0 20px #fff;background-color:#fff;overflow:visible;z-index:2147483646}.sr-controlbar-bg sr-rd-crlbar,.sr-controlbar-bg sr-rd-crlbar fab{z-index:2147483647}sr-rd-crlbar.controlbar{position:fixed;right:0;bottom:0;width:100px;height:100%;opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}sr-rd-crlbar.controlbar:hover{opacity:1}sr-rd-crlbar fap *{box-sizing:border-box}@media (max-height:620px){fab{zoom:.8}}@media (max-height:783px){dialog-gp dialog-content{max-height:580px}dialog-gp dialog-footer{border-top:1px solid #e0e0e0}}.simpread-highlight-selector{outline:3px dashed #1976d2!important;cursor:pointer!important}.simpread-highlight-controlbar,.simpread-highlight-selector{background-color:#fafafa!important;opacity:.8!important;-webkit-transition:opacity .5s ease!important;transition:opacity .5s ease!important}.simpread-highlight-controlbar{position:relative!important;border:3px dashed #1976d2!important}simpread-highlight,sr-snapshot-ctlbar{position:fixed;top:0;left:0;right:0;padding:15px;height:50px;background-color:rgba(50,50,50,.9);box-shadow:0 2px 5px rgba(0,0,0,.26);box-sizing:border-box;z-index:2147483640}simpread-highlight,sr-highlight-ctl,sr-snapshot-ctlbar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sr-highlight-ctl{margin:0 5px;width:50px;height:20px;color:#fff;background-color:#1976d2;border-radius:4px;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);cursor:pointer}toc-bg{position:fixed;left:0;top:0;width:50px;height:200px;font-size:medium}toc-bg:hover{z-index:3}.toc-bg-hidden{opacity:0;-webkit-transition:opacity .5s ease;transition:opacity .5s ease}.toc-bg-hidden:hover{opacity:1;z-index:3}.toc-bg-hidden:hover toc{width:180px}toc *{all:unset}toc{position:fixed;left:0;top:100px;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;padding:10px;width:0;max-width:200px;max-height:500px;overflow-x:hidden;overflow-y:hidden;cursor:pointer;border:1px solid hsla(0,0%,62%,.22);-webkit-transition:width .5s;transition:width .5s}toc:hover{overflow-y:auto}toc.mini:hover{width:200px!important}toc::-webkit-scrollbar{width:3px}toc::-webkit-scrollbar-thumb{border-radius:10px;background-color:hsla(36,2%,54%,.5)}toc outline{position:relative;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;padding:2px 0;min-height:21px;line-height:21px;text-align:left}toc outline a,toc outline a:active,toc outline a:focus,toc outline a:visited{display:block;width:100%;color:inherit;font-size:11px;text-decoration:none!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}toc outline a:hover{font-weight:700!important}toc outline a.toc-outline-theme-dark,toc outline a.toc-outline-theme-night{color:#fff!important}.toc-level-h1{padding-left:5px}.toc-level-h2{padding-left:15px}.toc-level-h3{padding-left:25px}.toc-level-h4{padding-left:35px}.toc-outline-active{border-left:2px solid #f44336}toc outline active{position:absolute;left:0;top:0;bottom:0;padding:0 0 0 3px;border-left:2px solid #e8e8e8}sr-kbd{background:-webkit-gradient(linear,0 0,0 100%,from(#fff785),to(#ffc542));border:1px solid #e3be23;-o-border-image:none;border-image:none;-o-border-image:initial;border-image:initial;position:absolute;left:0;padding:1px 3px 0;font-size:11px!important;font-weight:700;box-shadow:0 3px 7px 0 rgba(0,0,0,.3);overflow:hidden;border-radius:3px}.sr-kbd-a{position:relative}kbd-mapping{position:fixed;left:5px;bottom:5px;-ms-flex-flow:row;flex-flow:row;width:250px;height:500px;background-color:#fff;border:1px solid hsla(0,0%,62%,.22);box-shadow:0 2px 5px rgba(0,0,0,.26);border-radius:3px}kbd-mapping,kbd-maps{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}kbd-maps{margin:40px 0 20px;width:100%;overflow-x:auto}kbd-maps::-webkit-scrollbar-thumb{background-clip:padding-box;border-radius:10px;border:2px solid transparent;background-color:rgba(85,85,85,.55)}kbd-maps::-webkit-scrollbar{width:10px;-webkit-transition:width .7s cubic-bezier(.4,0,.2,1);transition:width .7s cubic-bezier(.4,0,.2,1)}kbd-mapping kbd-map-title{position:absolute;margin:5px 0;width:100%;font-size:14px;font-weight:700}kbd-maps-group{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}kbd-maps-title{margin:5px 0;padding-left:53px;font-size:12px;font-weight:700}kbd-map kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}kbd-map kbd-name{display:inline-block;text-align:right;width:50px}kbd-map kbd-desc{padding-left:3px}sharecard-bg{position:fixed;top:0;left:0;width:100%;height:100%;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(0,0,0,.4);z-index:2147483647}sharecard{max-width:450px;background-color:#64b5f6}sharecard,sharecard-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-head{margin:25px;color:#fff;border-radius:10px;box-shadow:0 2px 6px 0 rgba(0,0,0,.2),0 25px 50px 0 rgba(0,0,0,.15)}sharecard-card{-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sharecard-card,sharecard-top{display:-webkit-box;display:-ms-flexbox;display:flex}sharecard-top{-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:65px;background-color:#fff;color:#878787;font-size:25px;font-weight:500;border-top-left-radius:10px;border-top-right-radius:10px}sharecard-top span.logos{display:block;width:48px;height:48px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAABU1BMVEUAAAAnNJMnNZI3Q5onNJInNJMnNJInNJMnNJI8SJ0tOZY/S55EUKAoNJI6RpwoNJNIU6InNJInNJImNJI7SJwmNJJ2fLUiMJFKVaNCTJ9faK1HUaJOWKVSXaUnNJNYY6pye7cmM5JXYKhwebMjMI8mL4719fW9vb0oNZP/UlLz8/QqN5TAwMAnNJPv7+/Pz8/q6+/p6enNzc3Kysry8vMsOJXc3env7/LU1uXo29vR0dHOzs7ExMTwjo73bW37XV3Aj1TCYELl5u3n5+fW2Obn6O7f4OrZ2+g0QJkxPpgvO5bh4uvS1OTP0ePCwsJQW6ZLVqTs7fHd3d3V1dXqv79VX6lET6A1TIxXUIBSgHxWQnpelHf+WVnopkXqbC7j5Ozi4uLDw8NGUaFATJ9SgH3r6+vGyd7BxNva2trX19ejqM2gpczHx8dze7Zha67Z2dlTgH1aXQeSAAAAJnRSTlMA6ff+497Y8NL+/fv49P379sqab/BeOiX06tzVy8m/tKqpalA7G6oKj0EAAAJlSURBVEjHndNXWxpBFIDhcS2ICRLAkt4Dx4WhLk0E6R0MYoIISrWX5P9f5cwSIRC2+T1czMV5n2FnZwn2eWONUqCAv3H2Uf5Ra1hx4+0WEXtDQW0fCPYJ1EffEfIV4CSROAE4jsePoTFsNmTJF/IeIHF2lgCIn57GodlqDWXBK7IwBYatVlMWFAildPKX7I3m74Z9fsCiQChoimoFQAz04Ad2gH1n9fv9n9hgMNDr9euLWD6fLxQKxaLfb7dTSlahbFVdEPwIQtrAihZQgyKCtCagbQe3xh0QFMgy5MR11+ewYY5/qlZ7vT2xu93ULKjbFLpiUxnIIwjgKmVTLDUFXMrAi2NJWCRLIthTBo4xyOLKpwyqU6CuDCI41hFBCVdOhyLw4FgJ1skCAiyl9BSHbCorgo6VJXTru5hrVCQS8Yr5xLzX59YJSFpVFwD9U0BGC3hGdFpATgRupTGe9R9I1b1ePBvXKDyvq/O/44LT4/E4BUbSCAwj8Evq6HlnOBprx6JhJz8Gktc7xeaP9ndY+0coQvCccFBD4JW60UIY50ciLOAODAQRVOeCHm4Q3Xks6uRDY+CQ+AR4T2wMYh6+jMCIQOp78CFoj0H7EQgIuhI3dGaHCrwgADwCPjJvA372GRigCJg49FUdk3D87pq3zp4SA5zc1Zh9DxfwkpjgUg5Mv+lbeE3McC8Lpu7SA3wk2xzcqL2tN5DfIsQC8HB7UamUy6FQOpTO5QKBQDZbKnWSyUzGjdWCwaDA8+7Le4BNgm3qQGWchYh9s5hNq6wVbBlbwhZYOp3OYOA4zmgEypnM2zj8ByIdedKrH8vDAAAAAElFTkSuQmCC");zoom:.8}sharecard-content{padding:15px;max-height:500px;font-size:20px;text-align:justify;background-color:#2196f3;overflow-x:hidden;overflow-y:auto}sharecard-via{padding:10px;font-size:10px;background-color:#2196f3}sharecard-footer{-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding-right:5px;height:100px;background-color:#fff;color:#878787;font-size:15px;font-weight:500;border-bottom-left-radius:10px;border-bottom-right-radius:10px}sharecard-footer,sharecard-footer div{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center}sharecard-footer span.qrcode{display:block;width:100px;height:100px;margin:5px;background-repeat:no-repeat;background-position:50%;background-image:url("data:image/png;base64,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")}sharecard-control{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0 19px;height:80px;background-color:#fff}simpread-snapshot{width:100%;height:100%;cursor:move;z-index:2147483645}simpread-snapshot,sr-mask{position:fixed;left:0;top:0}sr-mask{background-color:rgba(0,0,0,.1)}.simpread-feedback,.simpread-urlscheme{position:fixed;right:20px;bottom:20px;z-index:2147483646}simpread-feedback,simpread-urlscheme{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;padding:20px 20px 0;width:500px;color:rgba(51,51,51,.87);background-color:#fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.12),0 2px 2px rgba(0,0,0,.26);overflow:hidden;-webkit-transform-origin:bottom;transform-origin:bottom;-webkit-transition:all .6s ease;transition:all .6s ease}simpread-feedback *,simpread-urlscheme *{font-size:12px!important;box-sizing:border-box}simpread-feedback.active,simpread-urlscheme.active{-webkit-animation-name:srFadeInUp;animation-name:srFadeInUp;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback.hide,simpread-urlscheme.hide{-webkit-animation-name:srFadeInDown;animation-name:srFadeInDown;-webkit-animation-duration:.45s;animation-duration:.45s;-webkit-animation-fill-mode:both;animation-fill-mode:both}simpread-feedback sr-fb-label,simpread-urlscheme sr-urls-label{width:100%}simpread-feedback sr-fb-head,simpread-urlscheme sr-urls-head{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin-bottom:5px;width:100%}simpread-feedback sr-fb-content,simpread-urlscheme sr-urls-content{margin-bottom:5px;width:100%}simpread-feedback sr-urls-footer,simpread-urlscheme sr-urls-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-fb-a,simpread-urlscheme sr-urls-a{color:#2163f7;cursor:pointer}simpread-feedback text-field-state,simpread-urlscheme text-field-state{border-top:none rgba(34,101,247,.8)!important;border-left:none rgba(34,101,247,.8)!important;border-right:none rgba(34,101,247,.8)!important;border-bottom:2px solid rgba(34,101,247,.8)!important}simpread-feedback switch,simpread-urlscheme switch{margin-top:0!important}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}simpread-feedback sr-fb-head{font-weight:700}simpread-feedback sr-fb-content{-webkit-box-orient:vertical;-ms-flex-direction:column;flex-direction:column}simpread-feedback sr-fb-content,simpread-feedback sr-fb-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-direction:normal}simpread-feedback sr-fb-footer{-webkit-box-orient:horizontal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;width:100%}simpread-feedback sr-close{position:absolute;right:20px;cursor:pointer;-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s;z-index:200}simpread-feedback sr-close:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:10px}simpread-feedback sr-stars i{margin-right:10px;cursor:pointer}simpread-feedback sr-stars i svg{-webkit-transition:all 1s cubic-bezier(.23,1,.32,1) .1s;transition:all 1s cubic-bezier(.23,1,.32,1) .1s}simpread-feedback sr-stars i svg:hover{-webkit-transform:rotate(-15deg) scale(1.3);transform:rotate(-15deg) scale(1.3)}simpread-feedback sr-stars i.active svg{-webkit-transform:rotate(0) scale(1);transform:rotate(0) scale(1)}simpread-feedback sr-emojis{display:block;height:100px;overflow:hidden}simpread-feedback sr-emoji{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:.3s;transition:.3s}simpread-feedback sr-emoji>svg{margin:15px 0;width:70px;height:70px;-ms-flex-negative:0;flex-shrink:0}simpread-feedback sr-stars-footer{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin:10px 0 20px}</style>
                        <style type="text/css">.simpread-theme-root{font-size:62.5%!important}sr-rd-content,sr-rd-desc,sr-rd-title{width:100%}sr-rd-title{display:-webkit-box;margin:1em 0 .5em;overflow:hidden;text-overflow:ellipsis;text-rendering:optimizelegibility;-webkit-line-clamp:3;-webkit-box-orient:vertical}sr-rd-content{text-align:left;word-break:break-word}sr-rd-desc{text-align:justify;line-height:2.4;margin:0 0 1.2em;box-sizing:border-box}sr-rd-content{font-size:25.6px;font-size:1.6rem;line-height:1.6}sr-rd-content h1,sr-rd-content h1 *,sr-rd-content h2,sr-rd-content h2 *,sr-rd-content h3,sr-rd-content h3 *,sr-rd-content h4,sr-rd-content h4 *,sr-rd-content h5,sr-rd-content h5 *,sr-rd-content h6,sr-rd-content h6 *{word-break:break-all}sr-rd-content div,sr-rd-content p{display:block;float:inherit;line-height:1.6;font-size:25.6px;font-size:1.6rem}sr-rd-content div,sr-rd-content p,sr-rd-content pre,sr-rd-content sr-blockquote{margin:0 0 1.2em;word-break:break-word}sr-rd-content a{padding:0 5px;vertical-align:baseline;vertical-align:initial}sr-rd-content a,sr-rd-content a:link{color:inherit;font-size:inherit;font-weight:inherit;border:none}sr-rd-content a:hover{background:transparent}sr-rd-content img{margin:10px;padding:5px;max-width:100%;background:#fff;border:1px solid #bbb;box-shadow:1px 1px 3px #d4d4d4}sr-rd-content figcaption{text-align:center;font-size:14px}sr-rd-content sr-blockquote{display:block;position:relative;padding:15px 25px;text-align:left;line-height:inherit}sr-rd-content sr-blockquote:before{position:absolute}sr-rd-content sr-blockquote *{margin:0;font-size:inherit}sr-rd-content table{width:100%;margin:0 0 1.2em;word-break:keep-all;word-break:normal;overflow:auto;border:none}sr-rd-content table td,sr-rd-content table th{border:none}sr-rd-content ul{margin:0 0 1.2em;margin-left:1.3em;padding:0;list-style:disc}sr-rd-content ol{list-style:decimal;margin:0;padding:0}sr-rd-content ol li,sr-rd-content ul li{font-size:inherit;list-style:disc;margin:0 0 1.2em}sr-rd-content ol li{list-style:decimal;margin-left:1.3em}sr-rd-content ol li *,sr-rd-content ul li *{margin:0;text-align:left;text-align:initial}sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em}sr-rd-content li ul{list-style:circle}sr-rd-content pre{font-family:Consolas,Monaco,Andale Mono,Source Code Pro,Liberation Mono,Courier,monospace;display:block;padding:15px;line-height:1.5;word-break:break-all;word-wrap:break-word;white-space:pre;overflow:auto}sr-rd-content pre,sr-rd-content pre *,sr-rd-content pre div{font-size:17.6px;font-size:1.1rem}sr-rd-content li pre code,sr-rd-content p pre code,sr-rd-content pre{background-color:transparent;border:none}sr-rd-content pre code{margin:0;padding:0}sr-rd-content pre code,sr-rd-content pre code *{font-size:17.6px;font-size:1.1rem}sr-rd-content pre p{margin:0;padding:0;color:inherit;font-size:inherit;line-height:inherit}sr-rd-content li code,sr-rd-content p code{margin:0 4px;padding:2px 4px;font-size:17.6px;font-size:1.1rem}sr-rd-content mark{margin:0 5px;padding:2px;background:#fffdd1;border-bottom:1px solid #ffedce}.sr-rd-content-img{width:90%;height:auto}.sr-rd-content-img-load{width:48px;height:48px;margin:0;padding:0;border-style:none;border-width:0;background-repeat:no-repeat;background-image:url(data:image/gif;base64,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)}.sr-rd-content-center{text-align:center;display:-webkit-box;-webkit-box-align:center;-webkit-box-pack:center;-webkit-box-orient:vertical}.sr-rd-content-center-small{display:-webkit-inline-box;display:-ms-inline-flexbox;display:inline-flex}.sr-rd-content-center-small img{margin:0;padding:0;border:0;box-shadow:none}img.simpread-img-broken{cursor:pointer}.sr-rd-content-nobeautify{margin:0;padding:0;border:0;box-shadow:0 0 0}sr-rd-mult{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;margin:0 0 16px;padding:16px 0 24px;width:100%;background-color:#fff;border-radius:4px;box-shadow:0 1px 2px 0 rgba(60,64,67,.3),0 2px 6px 2px rgba(60,64,67,.15)}sr-rd-mult:hover{-webkit-transition:all .45s 0ms;transition:all .45s 0ms;box-shadow:1px 1px 8px rgba(0,0,0,.16)}sr-rd-mult sr-rd-mult-content{padding:0 16px;overflow:auto}sr-rd-mult sr-rd-mult-avatar,sr-rd-mult sr-rd-mult-content{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}sr-rd-mult sr-rd-mult-avatar{-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 15px}sr-rd-mult sr-rd-mult-avatar span{display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;max-width:75px;overflow:hidden;text-overflow:ellipsis;text-align:left;font-size:16px;font-size:1rem}sr-rd-mult sr-rd-mult-avatar img{margin-bottom:0;max-width:50px;max-height:50px;width:50px;height:50px;border-radius:50%}sr-rd-mult sr-rd-mult-content img{max-width:80%}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center{margin:0}sr-page{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between;width:100%}</style>
                        <style type="text/css">sr-rd-theme-github{display:none}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{position:relative;margin-top:1em;margin-bottom:1pc;font-weight:700;line-height:1.4;text-align:left;color:#363636}sr-rd-content h1{padding-bottom:.3em;font-size:57.6px;font-size:3.6rem;line-height:1.2}sr-rd-content h2{padding-bottom:.3em;font-size:44.8px;font-size:2.8rem;line-height:1.225}sr-rd-content h3{font-size:38.4px;font-size:2.4rem;line-height:1.43}sr-rd-content h4{font-size:32px;font-size:2rem}sr-rd-content h5,sr-rd-content h6{font-size:25.6px;font-size:1.6rem}sr-rd-content h6{color:#777}sr-rd-content ol,sr-rd-content ul{list-style-type:disc;padding:0;padding-left:2em}sr-rd-content ol ol,sr-rd-content ul ol{list-style-type:lower-roman}sr-rd-content ol ol ol,sr-rd-content ol ul ol,sr-rd-content ul ol ol,sr-rd-content ul ul ol{list-style-type:lower-alpha}sr-rd-content table{width:100%;overflow:auto;word-break:normal;word-break:keep-all}sr-rd-content table th{font-weight:700}sr-rd-content table td,sr-rd-content table th{padding:6px 13px;border:1px solid #ddd}sr-rd-content table tr{background-color:#fff;border-top:1px solid #ccc}sr-rd-content table tr:nth-child(2n){background-color:#f8f8f8}sr-rd-content sr-blockquote{border-left:4px solid #ddd}.simpread-theme-root{background-color:#fff;color:#333}sr-rd-title{font-family:PT Sans,SF UI Display,\.PingFang SC,PingFang SC,Neue Haas Grotesk Text Pro,Arial Nova,Segoe UI,Microsoft YaHei,Microsoft JhengHei,Helvetica Neue,Source Han Sans SC,Noto Sans CJK SC,Source Han Sans CN,Noto Sans SC,Source Han Sans TC,Noto Sans CJK TC,Hiragino Sans GB,sans-serif;font-size:54.4px;font-size:3.4rem;font-weight:700;line-height:1.3}sr-rd-desc{position:relative;margin:0;margin-bottom:30px;padding:25px;padding-left:56px;font-size:28.8px;font-size:1.8rem;color:#777;background-color:rgba(0,0,0,.05);box-sizing:border-box}sr-rd-desc:before{content:"\201C";position:absolute;top:-28px;left:16px;font-size:80px;font-family:Arial;color:rgba(0,0,0,.15)}sr-rd-content,sr-rd-content *,sr-rd-content div,sr-rd-content p{color:#363636;font-weight:400;line-height:1.8}sr-rd-content b *,sr-rd-content strong,sr-rd-content strong * sr-rd-content b{-webkit-animation:none 0s ease 0s 1 normal none running;animation:none 0s ease 0s 1 normal none running;-webkit-backface-visibility:visible;backface-visibility:visible;background:transparent none repeat 0 0/auto auto padding-box border-box scroll;border:medium none currentColor;border-collapse:separate;-o-border-image:none;border-image:none;border-radius:0;border-spacing:0;bottom:auto;box-shadow:none;box-sizing:content-box;caption-side:top;clear:none;clip:auto;color:#000;-webkit-columns:auto;-moz-columns:auto;columns:auto;-webkit-column-count:auto;-moz-column-count:auto;column-count:auto;-webkit-column-fill:balance;-moz-column-fill:balance;column-fill:balance;-webkit-column-gap:normal;-moz-column-gap:normal;column-gap:normal;-webkit-column-rule:medium none currentColor;-moz-column-rule:medium none currentColor;column-rule:medium none currentColor;-webkit-column-span:1;-moz-column-span:1;column-span:1;-webkit-column-width:auto;-moz-column-width:auto;column-width:auto;content:normal;counter-increment:none;counter-reset:none;cursor:auto;direction:ltr;display:inline;empty-cells:show;float:none;font-family:serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:400;font-stretch:normal;line-height:normal;height:auto;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;left:auto;letter-spacing:normal;list-style:disc outside none;margin:0;max-height:none;max-width:none;min-height:0;min-width:0;opacity:1;orphans:2;outline:medium none invert;overflow:visible;overflow-x:visible;overflow-y:visible;padding:0;page-break-after:auto;page-break-before:auto;page-break-inside:auto;-webkit-perspective:none;perspective:none;-webkit-perspective-origin:50% 50%;perspective-origin:50% 50%;position:static;right:auto;-moz-tab-size:8;-o-tab-size:8;tab-size:8;table-layout:auto;text-align:left;text-align-last:auto;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;top:auto;-webkit-transform:none;transform:none;-webkit-transform-origin:50% 50% 0;transform-origin:50% 50% 0;-webkit-transform-style:flat;transform-style:flat;-webkit-transition:none 0s ease 0s;transition:none 0s ease 0s;unicode-bidi:normal;vertical-align:baseline;visibility:visible;white-space:normal;widows:2;width:auto;word-spacing:normal;z-index:auto;all:initial}sr-rd-content a,sr-rd-content a:link{color:#4183c4;text-decoration:none}sr-rd-content a:active,sr-rd-content a:focus,sr-rd-content a:hover{color:#4183c4;text-decoration:underline}sr-rd-content pre{background-color:#f7f7f7;border-radius:3px}sr-rd-content li code,sr-rd-content p code{background-color:rgba(0,0,0,.04);border-radius:3px}.simpread-multi-root{background:#f8f9fa}</style>
                        <style type="text/css"></style>
                        <style type="text/css">@media (pointer:coarse){sr-read{margin:20px 5%!important;min-width:0!important;max-width:90%!important}sr-rd-title{margin-top:0;font-size:2.7rem}sr-rd-content sr-blockquote,sr-rd-desc{margin:10 0!important;padding:0 0 0 10px!important;width:90%;font-size:1.8rem;font-style:normal;line-height:1.7;text-align:justify}sr-rd-content{font-size:1.75rem;font-weight:300}sr-rd-content figure{margin:0;padding:0;text-align:center}sr-rd-content a,sr-rd-content a:link,sr-rd-content li code,sr-rd-content p code{font-size:inherit}sr-rd-footer{margin-top:20px}sr-blockquote,sr-blockquote *{margin:5px!important;padding:5px!important}sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6,sr-rd-title{font-family:PingFang SC,Verdana,Helvetica Neue,Microsoft Yahei,Hiragino Sans GB,Microsoft Sans Serif,WenQuanYi Micro Hei,sans-serif;color:#000;font-weight:100;line-height:1.35}sr-rd-content-h1,sr-rd-content-h2,sr-rd-content-h3,sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h1,sr-rd-content h2,sr-rd-content h3,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{margin-top:1.2em;margin-bottom:.6em;line-height:1.35}sr-rd-content-h1,sr-rd-content h1{font-size:1.8em}sr-rd-content-h2,sr-rd-content h2{font-size:1.6em}sr-rd-content-h3,sr-rd-content h3{font-size:1.4em}sr-rd-content-h4,sr-rd-content-h5,sr-rd-content-h6,sr-rd-content h4,sr-rd-content h5,sr-rd-content h6{font-size:1.2em}sr-rd-content-ul,sr-rd-content ul{margin-left:1.3em!important;list-style:disc}sr-rd-content-ol,sr-rd-content ol{list-style:decimal;margin-left:1.9em!important}sr-rd-content-ol ol,sr-rd-content-ol ul,sr-rd-content-ul ol,sr-rd-content-ul ul,sr-rd-content li ol,sr-rd-content li ul{margin-bottom:.8em;margin-left:2em!important}sr-rd-content img{margin:0;padding:0;border:0;max-width:100%!important;height:auto;box-shadow:0 20px 20px -10px rgba(0,0,0,.1)}sr-rd-mult{min-width:0;background-color:#fff;box-shadow:0 1px 6px rgba(32,33,36,.28);border-radius:8px}sr-rd-mult sr-rd-mult-avatar div{margin:0}sr-rd-mult sr-rd-mult-avatar .sr-rd-content-center-small{margin:7px 0!important}sr-rd-mult sr-rd-mult-avatar span{display:block}sr-rd-mult sr-rd-mult-content{padding-left:0}@media only screen and (max-device-width:1024px){.simpread-theme-root,html.simpread-theme-root{font-size:80%!important}sr-rd-mult sr-rd-mult-avatar img{width:50px;height:50px;min-width:50px;min-height:50px}toc-bg toc{width:10px!important}toc-bg:hover toc{width:auto!important}}@media only screen and (max-device-width:414px){.simpread-theme-root,html.simpread-theme-root{font-size:70%!important}sr-rd-mult sr-rd-mult-avatar img{width:30px;height:30px;min-width:30px;min-height:30px}}@media only screen and (max-device-width:320px){.simpread-theme-root,html.simpread-theme-root{font-size:90%!important}sr-rd-content p{margin-bottom:.5em}}}</style>
                        <style type="text/css">undefinedsr-rd-content *, sr-rd-content p, sr-rd-content div {}sr-rd-content pre code, sr-rd-content pre code * {}sr-rd-desc {}sr-rd-content pre {}sr-rd-title {}</style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css"></style>
                        <style type="text/css">sr-rd-content *, sr-rd-content p, sr-rd-content div {
        font-size: 15px;
    }

    .annote-perview, .annote-perview * {
        color: rgb(85, 85, 85);
        font-weight: 400;
        line-height: 1.8;
    }</style>
                        
                        
                        <script>setTimeout(()=>{const e=location.hash.replace("#id=","");let t,a=!1;const n=t=>{for(let n of t){let t;if((t=e.length>6?n.getAttribute("data-id"):n.getAttribute("data-idx"))==e){n.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),a=!0;break}}};e&&(0==(t=document.getElementsByClassName("sr-unread-card")).length&&(t=document.getElementsByTagName("sr-annote")),n(t),a||n(t=document.getElementsByClassName("sr-annote")))},500);</script>
                        <script>document.addEventListener("DOMContentLoaded",function(){if("localhost"==location.hostname){const t=document.getElementsByTagName("img");for(let o of t){const t=o.src;t.startsWith("http")&&(o.src=location.origin+"/proxy?url="+t)}}},!1);</script>
                        <style>toc a {font-size: inherit!important;font-weight: 300!important;}</style><script>setTimeout(()=>{const max=document.getElementsByTagName('sr-annote-note-tip').length;for(let i=0;i<max;i++){const target=document.getElementsByTagName('sr-annote-note-tip')[i],value=target.dataset.value;value&&(target.innerText=value)}},1000);</script><title>简悦 | 32｜并发：聊聊 Goroutine 调度器的原理</title>
                    </head>
                    <body>
                        <sr-read style='font-family: "LXGW WenKai Screen";'>
                            <sr-rd-title>32｜并发：聊聊 Goroutine 调度器的原理</sr-rd-title>
                    <sr-rd-desc style="margin: 0;padding-top: 0;padding-bottom: 0;font-style: normal;font-size: 18px;">今天，我会讲解 Go 语言提供的另一种分支控制结构：switch 语句。和 if 分支语句相比，在一些执行分支较多的场景下，使用 switch 分支控制语</sr-rd-desc>
                    <sr-rd-content><h1 id="sr-toc-0"> 32｜并发：聊聊 Goroutine 调度器的原理</h1><div><span>Tony Bai</span> <span>2022-01-10</span></div><div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/f5/e6/f5a343834fa1ca72c6f2601b9d26f3e6.jpg"></div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAABCAYAAAB35kaxAAAAAXNSR0IArs4c6QAAAChJREFUGFdjfPfu3X8GKBAUFASz3r9/DxNiQBbDxcamn1yzSLEDZi8A2agny86FR+IAAAAASUVORK5CYII="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAABCAYAAAA8TpVcAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFCYtjkAcT9D8ti7hUOAAAAAElFTkSuQmCC"></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAABCAYAAABt2qY/AAAAAXNSR0IArs4c6QAAACdJREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULy2PQQK0YLewiZCQDhUS3LBhDf1QAAAABJRU5ErkJggg=="></div><div class="sr-rd-content-center-small"><img class="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAABCAYAAAA4u0VhAAAAAXNSR0IArs4c6QAAAB1JREFUGFdjfPfu3X9BQUEGEHj//j2YBgFkMULyAF6lD8tbqYWOAAAAAElFTkSuQmCC"></div></div></div><div><div><div></div></div><div><div><div><div><div><div>00:00</div></div><div></div></div></div><a href="javascript:;"> 1.0x <i><span></span></i></a></div><div><span>讲述：Tony Bai</span><span> 大小：15.75M</span><span> 时长：17:15</span></div></div><audio title="32｜并发：聊聊Goroutine调度器的原理" src="https://res001.geekbang.org/media/audio/eb/65/eb6fc98f283176142c92a32aceeb0065/ld/ld.m3u8"></audio></div><div><div><div><div data-slate-editor="true" data-key="15164" autocorrect="off" spellcheck="false" data-gramm="false"><div data-slate-type="paragraph" data-slate-object="block" data-key="15165"><span data-slate-object="text" data-key="15166"><span data-slate-leaf="true" data-offset-key="15166:0" data-first-offset="true"><span data-slate-string="true">你好，我是 Tony Bai。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15167"><span data-slate-object="text" data-key="15168"><span data-slate-leaf="true" data-offset-key="15168:0" data-first-offset="true"><span data-slate-string="true">上一讲我们学习了并发的基本概念和 Go 的并发方案，也就是 Goroutine 的一些基本使用和注意事项。对于大多数 Gopher 来说，这些内容作为 Go 并发入门已经是足够了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15169"><span data-slate-object="text" data-key="15170"><span data-slate-leaf="true" data-offset-key="15170:0" data-first-offset="true"><span data-slate-string="true">但毕竟 Go 没有采用基于线程的并发模型，可能很多 Gopher 都好奇 Go 运行时究竟是如何将一个个 Goroutine 调度到 CPU 上执行的。当然，Goroutine 的调度本来是 Go 语言核心开发团队才应该关注的事情，大多数 Gopher 们无需关心。但就我个人的学习和实践经验而言，</span></span><span data-slate-leaf="true" data-offset-key="15170:1"><span data-slate-object="annotation" data-annotation-key="gkann_e01fb67d" data-attr-id="33743" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">我觉得了解 Goroutine 的调度模型和原理，能够帮助我们编写出更高质量的 Go 代码。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15171"><span data-slate-object="text" data-key="15172"><span data-slate-leaf="true" data-offset-key="15172:0" data-first-offset="true"><span data-slate-string="true">因此，在这一讲中，我想和你一起简单探究一下 Goroutine 调度器的原理和演化历史。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15173" id="sr-toc-1"><span data-slate-object="text" data-key="15174"><span data-slate-leaf="true" data-offset-key="15174:0" data-first-offset="true"><span data-slate-string="true">Goroutine 调度器</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15175"><span data-slate-object="text" data-key="15176"><span data-slate-leaf="true" data-offset-key="15176:0" data-first-offset="true"><span data-slate-string="true">提到 “调度”，我们首先想到的就是操作系统对进程、线程的调度。操作系统调度器会将系统中的多个线程按照一定算法调度到物理 CPU 上去运行。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15177"><span data-slate-object="text" data-key="15178"><span data-slate-leaf="true" data-offset-key="15178:0" data-first-offset="true"><span data-slate-string="true">前面我们也提到，传统的编程语言，比如 C、C++ 等的并发实现，多是基于线程模型的，也就是应用程序负责创建线程（一般通过 libpthread 等库函数调用实现），操作系统负责调度线程。当然，我们也说过，这种传统支持并发的方式有很多不足。为了解决这些问题，Go 语言中的并发实现，使用了 Goroutine，代替了操作系统的线程，也不再依靠操作系统调度。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15179"><span data-slate-object="text" data-key="15180"><span data-slate-leaf="true" data-offset-key="15180:0" data-first-offset="true"><span data-slate-string="true">Goroutine 占用的资源非常小，上节课我们也说过，每个 Goroutine 栈的大小默认是 2KB。而且，Goroutine 调度的切换也不用陷入（trap）操作系统内核层完成，代价很低。因此，一个 Go 程序中可以创建成千上万个并发的 Goroutine。而将这些 Goroutine 按照一定算法放到 “CPU” 上执行的程序，</span></span><span data-slate-leaf="true" data-offset-key="15180:1"><span data-slate-object="annotation" data-annotation-key="gkann_5b75f26f" data-attr-id="44049" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">就被称为 </span></span></span></span><span data-slate-object="text" data-key="15181"><span data-slate-leaf="true" data-offset-key="15181:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5b75f26f" data-attr-id="44049" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Goroutine 调度器（Goroutine Scheduler）</span></span></span></span></span><span data-slate-object="text" data-key="15182"><span data-slate-leaf="true" data-offset-key="15182:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_5b75f26f" data-attr-id="44049" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">，</span></span></span><span data-slate-leaf="true" data-offset-key="15182:1"><span data-slate-string="true">注意，这里说的 “CPU” 打了引号。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15183"><span data-slate-object="text" data-key="15184"><span data-slate-leaf="true" data-offset-key="15184:0" data-first-offset="true"><span data-slate-string="true">不过，一个 Go 程序对于操作系统来说只是一个</span></span></span><span data-slate-object="text" data-key="15185"><span data-slate-leaf="true" data-offset-key="15185:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">用户层程序</span></span></span></span><span data-slate-object="text" data-key="15186"><span data-slate-leaf="true" data-offset-key="15186:0" data-first-offset="true"><span data-slate-string="true">，操作系统眼中只有线程，它甚至不知道有一种叫 </span></span></span><span data-slate-object="text" data-key="15187"><span data-slate-leaf="true" data-offset-key="15187:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Goroutine</span></span></span></span><span data-slate-object="text" data-key="15188"><span data-slate-leaf="true" data-offset-key="15188:0" data-first-offset="true"><span data-slate-string="true"> 的事物存在。</span></span><span data-slate-leaf="true" data-offset-key="15188:1"><span data-slate-object="annotation" data-annotation-key="gkann_eb3a0910" data-attr-id="39363" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">所以，Goroutine 的调度全要靠 Go 自己完成。那么，</span></span></span><span data-slate-leaf="true" data-offset-key="15188:2"><span data-slate-object="annotation" data-annotation-key="gkann_1746feb7" data-attr-id="35674" data-attr-name="public" data-annotation-type="public"><span data-slate-object="annotation" data-annotation-key="gkann_eb3a0910" data-attr-id="39363" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">实现 Go 程序内 Goroutine 之间 “公平” 竞争 “CPU” 资源的任务，就落到了 Go 运行时（runtime）头上了。要知道在一个 Go 程序中，除了用户层代码，剩下的就是 Go 运行时了。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15189"><span data-slate-object="text" data-key="15190"><span data-slate-leaf="true" data-offset-key="15190:0" data-first-offset="true"><span data-slate-string="true">于是，Goroutine 的调度问题就演变为，Go 运行时如何将程序内的众多 Goroutine，按照一定算法调度到 “CPU” 资源上运行的问题了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15191"><span data-slate-object="text" data-key="15192"><span data-slate-leaf="true" data-offset-key="15192:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">可是，在操作系统层面，线程竞争的 “CPU” 资源是真实的物理 CPU，但在 Go 程序层面，各个 Goroutine 要竞争的 “CPU” 资源又是什么呢？</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15193"><span data-slate-object="text" data-key="15194"><span data-slate-leaf="true" data-offset-key="15194:0" data-first-offset="true"><span data-slate-string="true">Go 程序是用户层程序，它本身就是整体运行在一个或多个操作系统线程上的。所以这个答案就出来了：Goroutine 们要竞争的 “CPU” 资源就是操作系统线程。这样，</span></span><span data-slate-leaf="true" data-offset-key="15194:1"><span data-slate-object="annotation" data-annotation-key="gkann_727f468d" data-attr-id="39302" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Goroutine 调度器的任务也就明确了：</span></span></span></span><span data-slate-object="text" data-key="15195"><span data-slate-leaf="true" data-offset-key="15195:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_727f468d" data-attr-id="39302" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">将 Goroutine 按照一定算法放到不同的操作系统线程中去执行</span></span></span></span></span><span data-slate-object="text" data-key="15196"><span data-slate-leaf="true" data-offset-key="15196:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_727f468d" data-attr-id="39302" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15197"><span data-slate-object="text" data-key="15198"><span data-slate-leaf="true" data-offset-key="15198:0" data-first-offset="true"><span data-slate-string="true">那么，Goroutine 调度器究竟是以怎样的算法模型，将 Goroutine 调度到不同的操作系统线程上去的呢？我们继续向下看。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15199" id="sr-toc-2"><span data-slate-object="text" data-key="15200"><span data-slate-leaf="true" data-offset-key="15200:0" data-first-offset="true"><span data-slate-string="true">Goroutine 调度器模型与演化过程</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15201"><span data-slate-object="text" data-key="15202"><span data-slate-leaf="true" data-offset-key="15202:0" data-first-offset="true"><span data-slate-string="true">Goroutine 调度器的实现不是一蹴而就的，它的调度模型与算法也是几经演化，</span></span><span data-slate-leaf="true" data-offset-key="15202:1"><span data-slate-object="annotation" data-annotation-key="gkann_20f9159f" data-attr-id="36419" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">从最初的 G-M 模型、到 G-P-M 模型，从不支持抢占，到支持协作式抢占，再到支持基于信号的异步抢占，Goroutine 调度器经历了不断地优化与打磨。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15203"><span data-slate-object="text" data-key="15204"><span data-slate-leaf="true" data-offset-key="15204:0" data-first-offset="true"><span data-slate-string="true">首先我们来看最初的 </span></span></span><span data-slate-object="text" data-key="15205"><span data-slate-leaf="true" data-offset-key="15205:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">G-M 模型</span></span></span></span><span data-slate-object="text" data-key="15206"><span data-slate-leaf="true" data-offset-key="15206:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15207"><span data-slate-object="text" data-key="15208"><span data-slate-leaf="true" data-offset-key="15208:0" data-first-offset="true"><span data-slate-string="true">2012 年 3 月 28 日，Go 1.0 正式发布。在这个版本中，Go 开发团队实现了一个简单的 Goroutine 调度器。在这个调度器中，每个 Goroutine 对应于运行时中的一个抽象结构：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15209"><span data-slate-object="text" data-key="15210"><span data-slate-leaf="true" data-offset-key="15210:0" data-first-offset="true"><span data-slate-string="true">G(Goroutine)</span></span></span></span><span data-slate-object="text" data-key="15211"><span data-slate-leaf="true" data-offset-key="15211:0" data-first-offset="true"><span data-slate-string="true"> ，</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15212"><span data-slate-object="text" data-key="15213"><span data-slate-leaf="true" data-offset-key="15213:0" data-first-offset="true"><span data-slate-string="true">而被视作 “物理 CPU” 的操作系统线程，则被抽象为另外一个结构：</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15214"><span data-slate-object="text" data-key="15215"><span data-slate-leaf="true" data-offset-key="15215:0" data-first-offset="true"><span data-slate-string="true">M(machine)</span></span></span></span><span data-slate-object="text" data-key="15216"><span data-slate-leaf="true" data-offset-key="15216:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15217"><span data-slate-object="text" data-key="15218"><span data-slate-leaf="true" data-offset-key="15218:0" data-first-offset="true"><span data-slate-string="true">调度器的工作就是将 G 调度到 M 上去运行。为了更好地控制程序中活跃的 M 的数量，调度器引入了 GOMAXPROCS 变量来表示 Go 调度器可见的 “处理器” 的最大数量。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15219"><span data-slate-object="text" data-key="15220"><span data-slate-leaf="true" data-offset-key="15220:0" data-first-offset="true"><span data-slate-string="true">这个模型实现起来比较简单，也能正常工作，但是却存在着诸多问题。前英特尔黑带级工程师、现谷歌工程师</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15221"><span data-slate-object="text" data-key="15222"><span data-slate-leaf="true" data-offset-key="15222:0" data-first-offset="true"><span data-slate-string="true">德米特里・维尤科夫（Dmitry Vyukov</span></span></span></a><span data-slate-object="text" data-key="15223"><span data-slate-leaf="true" data-offset-key="15223:0" data-first-offset="true"><span data-slate-string="true">）在其《</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15224"><span data-slate-object="text" data-key="15225"><span data-slate-leaf="true" data-offset-key="15225:0" data-first-offset="true"><span data-slate-string="true">Scalable Go Scheduler Design</span></span></span></a><span data-slate-object="text" data-key="15226"><span data-slate-leaf="true" data-offset-key="15226:0" data-first-offset="true"><span data-slate-string="true">》一文中指出了 </span></span></span><span data-slate-object="text" data-key="15227"><span data-slate-leaf="true" data-offset-key="15227:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">G-M 模型</span></span></span></span><span data-slate-object="text" data-key="15228"><span data-slate-leaf="true" data-offset-key="15228:0" data-first-offset="true"><span data-slate-string="true">的一个重要不足：限制了 Go 并发程序的伸缩性，尤其是对那些有高吞吐或并行计算需求的服务程序。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15229"><span data-slate-object="text" data-key="15230"><span data-slate-leaf="true" data-offset-key="15230:0" data-first-offset="true"><span data-slate-string="true">这个问题主要体现在这几个方面：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15231"><div data-slate-type="list-line" data-slate-object="block" data-key="15232"><span data-slate-object="text" data-key="15233"><span data-slate-leaf="true" data-offset-key="15233:0" data-first-offset="true"><span data-slate-string="true">单一全局互斥锁</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15234"><span data-slate-object="text" data-key="15235"><span data-slate-leaf="true" data-offset-key="15235:0" data-first-offset="true"><span data-slate-string="true"> (Sched.Lock)</span></span></span></span><span data-slate-object="text" data-key="15236"><span data-slate-leaf="true" data-offset-key="15236:0" data-first-offset="true"><span data-slate-string="true"> 和集中状态存储的存在，导致所有 Goroutine 相关操作，比如创建、重新调度等，都要上锁；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15237"><span data-slate-object="text" data-key="15238"><span data-slate-leaf="true" data-offset-key="15238:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_462cc727" data-attr-id="40607" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Goroutine 传递问题：M 经常在 M 之间传递 “可运行” 的 Goroutine，这导致调度延迟增大，也增加了额外的性能损耗；</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15239"><span data-slate-object="text" data-key="15240"><span data-slate-leaf="true" data-offset-key="15240:0" data-first-offset="true"><span data-slate-string="true">每个 M 都做内存缓存，导致内存占用过高，数据局部性较差；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15241"><span data-slate-object="text" data-key="15242"><span data-slate-leaf="true" data-offset-key="15242:0" data-first-offset="true"><span data-slate-string="true">由于系统调用（syscall）而形成的频繁的工作线程阻塞和解除阻塞，导致额外的性能损耗。</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15243"><span data-slate-object="text" data-key="15244"><span data-slate-leaf="true" data-offset-key="15244:0" data-first-offset="true"><span data-slate-string="true">为了解决这些问题，德米特里・维尤科夫又亲自操刀改进了 Go 调度器，在 Go 1.1 版本中实现了 </span></span></span><span data-slate-object="text" data-key="15245"><span data-slate-leaf="true" data-offset-key="15245:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">G-P-M 调度模型</span></span></span></span><span data-slate-object="text" data-key="15246"><span data-slate-leaf="true" data-offset-key="15246:0" data-first-offset="true"><span data-slate-string="true">和 </span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15247"><span data-slate-object="text" data-key="15248"><span data-slate-leaf="true" data-offset-key="15248:0" data-first-offset="true"><span data-slate-string="true">work stealing 算法</span></span></span></a><span data-slate-object="text" data-key="15249"><span data-slate-leaf="true" data-offset-key="15249:0" data-first-offset="true"><span data-slate-string="true">，这个模型一直沿用至今。模型如下图所示：</span></span></span></div><div data-slate-type="image" data-slate-object="block" data-key="15250"><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/43/a8/43ffdbc6b2203d9400ac98423192caa8.png?wh=1224x1142"></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15251"><span data-slate-object="text" data-key="15252"><span data-slate-leaf="true" data-offset-key="15252:0" data-first-offset="true"><span data-slate-string="true">有人说过：</span></span></span><span data-slate-object="text" data-key="15253"><span data-slate-leaf="true" data-offset-key="15253:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">“计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决”</span></span></span></span><span data-slate-object="text" data-key="15254"><span data-slate-leaf="true" data-offset-key="15254:0" data-first-offset="true"><span data-slate-string="true">，德米特里・维尤科夫的 </span></span></span><span data-slate-object="text" data-key="15255"><span data-slate-leaf="true" data-offset-key="15255:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">G-P-M</span></span></span></span><span data-slate-object="text" data-key="15256"><span data-slate-leaf="true" data-offset-key="15256:0" data-first-offset="true"><span data-slate-string="true"> 模型恰是这一理论的践行者。你可以看到，德米特里・维尤科夫通过向 G-M 模型中增加了一个 P，让 Go 调度器具有很好的伸缩性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15257"><span data-slate-object="text" data-key="15258"><span data-slate-leaf="true" data-offset-key="15258:0" data-first-offset="true"><span data-slate-string="true">P 是一个 “逻辑 Proccessor”，每个 G（Goroutine）要想真正运行起来，首先需要被分配一个 P，也就是进入到 P 的本地运行队列（local runq）中。对于 G 来说，P 就是运行它的 “CPU”，可以说：</span></span></span><span data-slate-object="text" data-key="15259"><span data-slate-leaf="true" data-offset-key="15259:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">在 G 的眼里只有 P</span></span></span></span><span data-slate-object="text" data-key="15260"><span data-slate-leaf="true" data-offset-key="15260:0" data-first-offset="true"><span data-slate-string="true">。但从 Go 调度器的视角来看，真正的 “CPU” 是 M，只有将 P 和 M 绑定，才能让 P 的 runq 中的 G 真正运行起来。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15261"><span data-slate-object="text" data-key="15262"><span data-slate-leaf="true" data-offset-key="15262:0" data-first-offset="true"><span data-slate-string="true">G-P-M 模型的实现算是</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15263"><span data-slate-object="text" data-key="15264"><span data-slate-leaf="true" data-offset-key="15264:0" data-first-offset="true"><span data-slate-string="true"> Go 调度器</span></span></span></span><span data-slate-object="text" data-key="15265"><span data-slate-leaf="true" data-offset-key="15265:0" data-first-offset="true"><span data-slate-string="true">的一大进步，但调度器仍然有一个令人头疼的问题，那就是</span></span></span><span data-slate-object="text" data-key="15266"><span data-slate-leaf="true" data-offset-key="15266:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">不支持抢占式调度</span></span></span></span><span data-slate-object="text" data-key="15267"><span data-slate-leaf="true" data-offset-key="15267:0" data-first-offset="true"><span data-slate-string="true">，这导致一旦某个 G 中出现死循环的代码逻辑，那么 G 将永久占用分配给它的 P 和 M，而位于同一个 P 中的其他 G 将得不到调度，出现 “</span></span></span><span data-slate-object="text" data-key="15268"><span data-slate-leaf="true" data-offset-key="15268:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">饿死</span></span></span></span><span data-slate-object="text" data-key="15269"><span data-slate-leaf="true" data-offset-key="15269:0" data-first-offset="true"><span data-slate-string="true">” 的情况。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15270"><span data-slate-object="text" data-key="15271"><span data-slate-leaf="true" data-offset-key="15271:0" data-first-offset="true"><span data-slate-string="true">更为严重的是，当只有一个 P（GOMAXPROCS=1）时，整个 Go 程序中的其他 G 都将 “饿死”。于是德米特里・维尤科夫又提出了《</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15272"><span data-slate-object="text" data-key="15273"><span data-slate-leaf="true" data-offset-key="15273:0" data-first-offset="true"><span data-slate-string="true">Go Preemptive Scheduler Design</span></span></span></a><span data-slate-object="text" data-key="15274"><span data-slate-leaf="true" data-offset-key="15274:0" data-first-offset="true"><span data-slate-string="true">》并在 </span></span></span><span data-slate-object="text" data-key="15275"><span data-slate-leaf="true" data-offset-key="15275:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">Go 1.2 中实现了基于协作的 “抢占式” 调度</span></span></span></span><span data-slate-object="text" data-key="15276"><span data-slate-leaf="true" data-offset-key="15276:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15277"><span data-slate-object="text" data-key="15278"><span data-slate-leaf="true" data-offset-key="15278:0" data-first-offset="true"><span data-slate-string="true">这个抢占式调度的原理就是，</span></span><span data-slate-leaf="true" data-offset-key="15278:1"><span data-slate-object="annotation" data-annotation-key="gkann_92ab63d8" data-attr-id="36421" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Go 编译器在每个函数或方法的入口处加上了一段额外的代码 (runtime.morestack_noctxt)，让运行时有机会在这段代码中检查是否需要执行抢占调度。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15279"><span data-slate-object="text" data-key="15280"><span data-slate-leaf="true" data-offset-key="15280:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_b9042029" data-attr-id="41656" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">这种解决方案只能说局部解决了 “饿死” 问题，只在有函数调用的地方才能插入 “抢占” 代码（埋点），对于没有函数调用而是纯算法循环计算的 G，Go 调度器依然无法抢占。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15281"><span data-slate-object="text" data-key="15282"><span data-slate-leaf="true" data-offset-key="15282:0" data-first-offset="true"><span data-slate-string="true">比如，死循环等并没有给编译器插入抢占代码的机会，这就会导致 GC 在等待所有 Goroutine 停止时的等待时间过长，从而</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15283"><span data-slate-object="text" data-key="15284"><span data-slate-leaf="true" data-offset-key="15284:0" data-first-offset="true"><span data-slate-string="true">导致 GC 延迟</span></span></span></a><span data-slate-object="text" data-key="15285"><span data-slate-leaf="true" data-offset-key="15285:0" data-first-offset="true"><span data-slate-string="true">，内存占用瞬间冲高；甚至在一些特殊情况下，导致在 STW（stop the world）时死锁。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15286"><span data-slate-object="text" data-key="15287"><span data-slate-leaf="true" data-offset-key="15287:0" data-first-offset="true"><span data-slate-string="true">为了解决这些问题，Go 在 1.14 版本中接受了奥斯汀・克莱门茨（Austin Clements）的</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15288"><span data-slate-object="text" data-key="15289"><span data-slate-leaf="true" data-offset-key="15289:0" data-first-offset="true"><span data-slate-string="true">提案</span></span></span></a><span data-slate-object="text" data-key="15290"><span data-slate-leaf="true" data-offset-key="15290:0" data-first-offset="true"><span data-slate-string="true">，增加了</span></span></span><span data-slate-object="text" data-key="15291"><span data-slate-leaf="true" data-offset-key="15291:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">对非协作的抢占式调度的支持</span></span></span></span><span data-slate-object="text" data-key="15292"><span data-slate-leaf="true" data-offset-key="15292:0" data-first-offset="true"><span data-slate-string="true">，这种抢占式调度是基于系统信号的，也就是通过向线程发送信号的方式来抢占正在运行的 Goroutine。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15293"><span data-slate-object="text" data-key="15294"><span data-slate-leaf="true" data-offset-key="15294:0" data-first-offset="true"><span data-slate-string="true">除了这些大的迭代外，Goroutine 的调度器还有一些小的优化改动，比如</span></span></span><span data-slate-object="text" data-key="15295"><span data-slate-leaf="true" data-offset-key="15295:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">通过文件 I/O poller 减少 M 的阻塞等</span></span></span></span><span data-slate-object="text" data-key="15296"><span data-slate-leaf="true" data-offset-key="15296:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15297"><span data-slate-object="text" data-key="15298"><span data-slate-leaf="true" data-offset-key="15298:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1ec3346b" data-attr-id="36892" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">Go 运行时已经实现了 netpoller，这使得即便 G 发起网络 I/O 操作，也不会导致 M 被阻塞（仅阻塞 G），也就不会导致大量线程（M）被创建出来。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15299"><span data-slate-object="text" data-key="15300"><span data-slate-leaf="true" data-offset-key="15300:0" data-first-offset="true"><span data-slate-string="true">但是对于文件 I/O 操作来说，一旦阻塞，那么线程（M）将进入挂起状态，等待 I/O 返回后被唤醒。这种情况下 P 将与挂起的 M 分离，再选择一个处于空闲状态（idle）的 M。如果此时没有空闲的 M，就会新创建一个 M（线程），</span></span><span data-slate-leaf="true" data-offset-key="15300:1"><span data-slate-object="annotation" data-annotation-key="gkann_2da38dc4" data-attr-id="39409" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">所以，这种情况下，大量 I/O 操作仍然会导致大量线程被创建。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15301"><span data-slate-object="text" data-key="15302"><span data-slate-leaf="true" data-offset-key="15302:0" data-first-offset="true"><span data-slate-string="true">为了解决这个问题，Go 开发团队的伊恩・兰斯・泰勒（Ian Lance Taylor）在 Go 1.9 中增加了一个</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15303"><span data-slate-object="text" data-key="15304"><span data-slate-leaf="true" data-offset-key="15304:0" data-first-offset="true"><span data-slate-string="true">针对文件 I/O 的 Poller</span></span></span></a><span data-slate-object="text" data-key="15305"><span data-slate-leaf="true" data-offset-key="15305:0" data-first-offset="true"><span data-slate-string="true"> 的功能，这个功能可以像 netpoller 那样，在 G 操作那些支持监听（pollable）的文件描述符时，仅会阻塞 G，而不会阻塞 M。不过这个功能依然不能对常规文件有效，常规文件是不支持监听的（pollable）。但对于 Go 调度器而言，这也算是一个不小的进步了。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15306"><span data-slate-object="text" data-key="15307"><span data-slate-leaf="true" data-offset-key="15307:0" data-first-offset="true"><span data-slate-string="true">从 Go 1.2 以后，Go 调度器就一直稳定在 G-P-M 调度模型上，尽管有各种优化和改进，但也都是基于这个模型之上的。那未来的 Go 调度器会往哪方面发展呢？德米特里・维尤科夫在 2014 年 9 月提出了一个新的设计草案文档：《</span></span></span><a data-slate-type="link" data-slate-object="inline" data-key="15308"><span data-slate-object="text" data-key="15309"><span data-slate-leaf="true" data-offset-key="15309:0" data-first-offset="true"><span data-slate-string="true">NUMA‐aware scheduler for Go</span></span></span></a><span data-slate-object="text" data-key="15310"><span data-slate-leaf="true" data-offset-key="15310:0" data-first-offset="true"><span data-slate-string="true">》，作为对未来 Goroutine 调度器演进方向的一个提议，不过至今似乎这个提议也没有列入开发计划。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15311"><span data-slate-object="text" data-key="15312"><span data-slate-leaf="true" data-offset-key="15312:0" data-first-offset="true"><span data-slate-string="true">通过前面对 Goroutine 调度器演化的分析，你可以看到，目前 G-M 模型已经废弃，NUMA 调度模型尚未实现，那么现在我们要理解如今的 Goroutine 调度，只需要学习 G-P-M 模型就可以了，接下来我们就来看看 G-P-M 模型下 Goroutine 的调度原理。</span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15313" id="sr-toc-3"><span data-slate-object="text" data-key="15314"><span data-slate-leaf="true" data-offset-key="15314:0" data-first-offset="true"><span data-slate-string="true">深入 G-P-M 模型</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15315"><span data-slate-object="text" data-key="15316"><span data-slate-leaf="true" data-offset-key="15316:0" data-first-offset="true"><span data-slate-string="true">Go 语言中 Goroutine 的调度、GC、内存管理等是 Go 语言原理最复杂、最难懂的地方，随便拿出一个都可以讲上几节课，并且这三方面的内容随着 Go 版本的演进也在不断更新。因为我们是入门课，所以这里我就只基于 Go 1.12.7 版本（支持基于协作的抢占式调度）给你粗略介绍一下基于 G-P-M 模型的调度原理，如果你还对这方面感兴趣，可以基于这些介绍深入到相关的 Go 源码中去，深入挖掘细节。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15317" id="sr-toc-4"><span data-slate-object="text" data-key="15318"><span data-slate-leaf="true" data-offset-key="15318:0" data-first-offset="true"><span data-slate-string="true">G、P 和 M</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15319"><span data-slate-object="text" data-key="15320"><span data-slate-leaf="true" data-offset-key="15320:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d4a257b0" data-attr-id="40553" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">关于 G、P、M 的定义，我们可以参见</span></span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15321"><span data-slate-object="text" data-key="15322"><span data-slate-leaf="true" data-offset-key="15322:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d4a257b0" data-attr-id="40553" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> $GOROOT/src/runtime/runtime2.go</span></span></span></span></span><span data-slate-object="text" data-key="15323"><span data-slate-leaf="true" data-offset-key="15323:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_d4a257b0" data-attr-id="40553" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true"> 这个源文件。</span></span></span><span data-slate-leaf="true" data-offset-key="15323:1"><span data-slate-string="true">你可以看到，G、P、M 这三个结构体定义都是大块头，每个结构体定义都包含十几个甚至二三十个字段。更不用说，像调度器这样的核心代码向来很复杂，考虑的因素也非常多，代码 “耦合” 成一坨。不过从复杂的代码中，我们依然可以看出来 G、P、M 的各自的大致用途，我们这里简要说明一下：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15324"><div data-slate-type="list-line" data-slate-object="block" data-key="15325"><span data-slate-object="text" data-key="15326"><span data-slate-leaf="true" data-offset-key="15326:0" data-first-offset="true"><span data-slate-string="true">G:  代表 Goroutine，存储了 Goroutine 的执行栈信息、Goroutine 状态以及 Goroutine 的任务函数等，</span></span><span data-slate-leaf="true" data-offset-key="15326:1"><span data-slate-object="annotation" data-annotation-key="gkann_5573385c" data-attr-id="33984" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">而且 G 对象是可以重用的；</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15327"><span data-slate-object="text" data-key="15328"><span data-slate-leaf="true" data-offset-key="15328:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_915c9bee" data-attr-id="39299" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">P:  代表逻辑 processor，P 的数量决定了系统内最大可并行的 G 的数量，P 的最大作用还是其拥有的各种 G 对象队列、链表、一些缓存和状态；</span></span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15329"><span data-slate-object="text" data-key="15330"><span data-slate-leaf="true" data-offset-key="15330:0" data-first-offset="true"><span data-slate-string="true">M:  M 代表着真正的执行计算资源。在绑定有效的 P 后，进入一个调度循环，而调度循环的机制大致是</span></span></span><span data-slate-object="text" data-key="15331"><span data-slate-leaf="true" data-offset-key="15331:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">从 P 的本地运行队列以及全局队列中获取 G，切换到 G 的执行栈上并执行 G 的函数，调用 goexit 做清理工作并回到 M，如此反复</span></span></span></span><span data-slate-object="text" data-key="15332"><span data-slate-leaf="true" data-offset-key="15332:0" data-first-offset="true"><span data-slate-string="true">。</span></span><span data-slate-leaf="true" data-offset-key="15332:1"><span data-slate-object="annotation" data-annotation-key="gkann_5603d886" data-attr-id="33985" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">M 并不保留 G 状态，这是 G 可以跨 M 调度的基础。</span></span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15333"><span data-slate-object="text" data-key="15334"><span data-slate-leaf="true" data-offset-key="15334:0" data-first-offset="true"><span data-slate-string="true">我这里也给出了 G、P、M 定义的代码片段（注意：我们这里使用的是 Go 1.12.7 版本，随着 Go 演化，结构体中的字段定义可能会有不同），你也可以看一看：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15335"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15336"><span data-slate-object="text" data-key="15337"><span data-slate-leaf="true" data-offset-key="15337:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//src/runtime/runtime2.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15338"><span data-slate-object="text" data-key="15339"><span data-slate-leaf="true" data-offset-key="15339:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="15340"><span data-slate-leaf="true" data-offset-key="15340:0" data-first-offset="true"><span data-slate-string="true"> g </span></span></span><span data-slate-object="text" data-key="15341"><span data-slate-leaf="true" data-offset-key="15341:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15342"><span data-slate-leaf="true" data-offset-key="15342:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15343"><span data-slate-object="text" data-key="15344"><span data-slate-leaf="true" data-offset-key="15344:0" data-first-offset="true"><span data-slate-string="true">    stack      stack   </span></span></span><span data-slate-object="text" data-key="15345"><span data-slate-leaf="true" data-offset-key="15345:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// offset known to runtime/cgo</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15346"><span data-slate-object="text" data-key="15347"><span data-slate-leaf="true" data-offset-key="15347:0" data-first-offset="true"><span data-slate-string="true">    sched      gobuf</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15348"><span data-slate-object="text" data-key="15349"><span data-slate-leaf="true" data-offset-key="15349:0" data-first-offset="true"><span data-slate-string="true">    goid       </span></span></span><span data-slate-object="text" data-key="15350"><span data-slate-leaf="true" data-offset-key="15350:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15351"><span data-slate-object="text" data-key="15352"><span data-slate-leaf="true" data-offset-key="15352:0" data-first-offset="true"><span data-slate-string="true">    gopc       </span></span></span><span data-slate-object="text" data-key="15353"><span data-slate-leaf="true" data-offset-key="15353:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uintptr</span></span></span></span><span data-slate-object="text" data-key="15354"><span data-slate-leaf="true" data-offset-key="15354:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15355"><span data-slate-leaf="true" data-offset-key="15355:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// pc of go statement that created this goroutine</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15356"><span data-slate-object="text" data-key="15357"><span data-slate-leaf="true" data-offset-key="15357:0" data-first-offset="true"><span data-slate-string="true">    startpc    </span></span></span><span data-slate-object="text" data-key="15358"><span data-slate-leaf="true" data-offset-key="15358:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uintptr</span></span></span></span><span data-slate-object="text" data-key="15359"><span data-slate-leaf="true" data-offset-key="15359:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15360"><span data-slate-leaf="true" data-offset-key="15360:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// pc of goroutine function</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15361"><span data-slate-object="text" data-key="15362"><span data-slate-leaf="true" data-offset-key="15362:0" data-first-offset="true"><span data-slate-string="true">    ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15363"><span data-slate-object="text" data-key="15364"><span data-slate-leaf="true" data-offset-key="15364:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15365"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15366"><span data-slate-object="text" data-key="15367"><span data-slate-leaf="true" data-offset-key="15367:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="15368"><span data-slate-leaf="true" data-offset-key="15368:0" data-first-offset="true"><span data-slate-string="true"> p </span></span></span><span data-slate-object="text" data-key="15369"><span data-slate-leaf="true" data-offset-key="15369:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15370"><span data-slate-leaf="true" data-offset-key="15370:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15371"><span data-slate-object="text" data-key="15372"><span data-slate-leaf="true" data-offset-key="15372:0" data-first-offset="true"><span data-slate-string="true">    lock mutex</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15373"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15374"><span data-slate-object="text" data-key="15375"><span data-slate-leaf="true" data-offset-key="15375:0" data-first-offset="true"><span data-slate-string="true">    id          </span></span></span><span data-slate-object="text" data-key="15376"><span data-slate-leaf="true" data-offset-key="15376:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int32</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15377"><span data-slate-object="text" data-key="15378"><span data-slate-leaf="true" data-offset-key="15378:0" data-first-offset="true"><span data-slate-string="true">    status      </span></span></span><span data-slate-object="text" data-key="15379"><span data-slate-leaf="true" data-offset-key="15379:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint32</span></span></span></span><span data-slate-object="text" data-key="15380"><span data-slate-leaf="true" data-offset-key="15380:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15381"><span data-slate-leaf="true" data-offset-key="15381:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// one of pidle/prunning/...</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15382"><span data-slate-object="text" data-key="15383"><span data-slate-leaf="true" data-offset-key="15383:0" data-first-offset="true"><span data-slate-string="true">  </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15384"><span data-slate-object="text" data-key="15385"><span data-slate-leaf="true" data-offset-key="15385:0" data-first-offset="true"><span data-slate-string="true">    mcache      *mcache</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15386"><span data-slate-object="text" data-key="15387"><span data-slate-leaf="true" data-offset-key="15387:0" data-first-offset="true"><span data-slate-string="true">    racectx     </span></span></span><span data-slate-object="text" data-key="15388"><span data-slate-leaf="true" data-offset-key="15388:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uintptr</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15389"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15390"><span data-slate-object="text" data-key="15391"><span data-slate-leaf="true" data-offset-key="15391:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15392"><span data-slate-leaf="true" data-offset-key="15392:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Queue of runnable goroutines. Accessed without lock.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15393"><span data-slate-object="text" data-key="15394"><span data-slate-leaf="true" data-offset-key="15394:0" data-first-offset="true"><span data-slate-string="true">    runqhead </span></span></span><span data-slate-object="text" data-key="15395"><span data-slate-leaf="true" data-offset-key="15395:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint32</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15396"><span data-slate-object="text" data-key="15397"><span data-slate-leaf="true" data-offset-key="15397:0" data-first-offset="true"><span data-slate-string="true">    runqtail </span></span></span><span data-slate-object="text" data-key="15398"><span data-slate-leaf="true" data-offset-key="15398:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint32</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15399"><span data-slate-object="text" data-key="15400"><span data-slate-leaf="true" data-offset-key="15400:0" data-first-offset="true"><span data-slate-string="true">    runq     [</span></span></span><span data-slate-object="text" data-key="15401"><span data-slate-leaf="true" data-offset-key="15401:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">256</span></span></span></span><span data-slate-object="text" data-key="15402"><span data-slate-leaf="true" data-offset-key="15402:0" data-first-offset="true"><span data-slate-string="true">]guintptr</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15403"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15404"><span data-slate-object="text" data-key="15405"><span data-slate-leaf="true" data-offset-key="15405:0" data-first-offset="true"><span data-slate-string="true">    runnext guintptr</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15406"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15407"><span data-slate-object="text" data-key="15408"><span data-slate-leaf="true" data-offset-key="15408:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15409"><span data-slate-leaf="true" data-offset-key="15409:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Available G's (status == Gdead)</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15410"><span data-slate-object="text" data-key="15411"><span data-slate-leaf="true" data-offset-key="15411:0" data-first-offset="true"><span data-slate-string="true">    gfree    *g</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15412"><span data-slate-object="text" data-key="15413"><span data-slate-leaf="true" data-offset-key="15413:0" data-first-offset="true"><span data-slate-string="true">    gfreecnt </span></span></span><span data-slate-object="text" data-key="15414"><span data-slate-leaf="true" data-offset-key="15414:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int32</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15415"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15416"><span data-slate-object="text" data-key="15417"><span data-slate-leaf="true" data-offset-key="15417:0" data-first-offset="true"><span data-slate-string="true">    ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15418"><span data-slate-object="text" data-key="15419"><span data-slate-leaf="true" data-offset-key="15419:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15420"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15421"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15422"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15423"><span data-slate-object="text" data-key="15424"><span data-slate-leaf="true" data-offset-key="15424:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">type</span></span></span></span><span data-slate-object="text" data-key="15425"><span data-slate-leaf="true" data-offset-key="15425:0" data-first-offset="true"><span data-slate-string="true"> m </span></span></span><span data-slate-object="text" data-key="15426"><span data-slate-leaf="true" data-offset-key="15426:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">struct</span></span></span></span><span data-slate-object="text" data-key="15427"><span data-slate-leaf="true" data-offset-key="15427:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15428"><span data-slate-object="text" data-key="15429"><span data-slate-leaf="true" data-offset-key="15429:0" data-first-offset="true"><span data-slate-string="true">    g0            *g     </span></span></span><span data-slate-object="text" data-key="15430"><span data-slate-leaf="true" data-offset-key="15430:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// goroutine with scheduling stack</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15431"><span data-slate-object="text" data-key="15432"><span data-slate-leaf="true" data-offset-key="15432:0" data-first-offset="true"><span data-slate-string="true">    mstartfn      </span></span></span><span data-slate-object="text" data-key="15433"><span data-slate-leaf="true" data-offset-key="15433:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15434"><span data-slate-leaf="true" data-offset-key="15434:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15435"><span data-slate-object="text" data-key="15436"><span data-slate-leaf="true" data-offset-key="15436:0" data-first-offset="true"><span data-slate-string="true">    curg          *g     </span></span></span><span data-slate-object="text" data-key="15437"><span data-slate-leaf="true" data-offset-key="15437:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// current running goroutine</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15438"><span data-slate-object="text" data-key="15439"><span data-slate-leaf="true" data-offset-key="15439:0" data-first-offset="true"><span data-slate-string="true">    ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15440"><span data-slate-object="text" data-key="15441"><span data-slate-leaf="true" data-offset-key="15441:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15442"><span data-slate-object="text" data-key="15443"><span data-slate-leaf="true" data-offset-key="15443:0" data-first-offset="true"><span data-slate-string="true">而 Goroutine 调度器的目标，就是公平合理地将各个 G 调度到 P 上 “运行”，下面我们重点看看 G 是如何被调度的。</span></span></span></div><h3 data-slate-type="heading" data-slate-object="block" data-key="15444" id="sr-toc-5"><span data-slate-object="text" data-key="15445"><span data-slate-leaf="true" data-offset-key="15445:0" data-first-offset="true"><span data-slate-string="true">G 被抢占调度</span></span></span></h3><div data-slate-type="paragraph" data-slate-object="block" data-key="15446"><span data-slate-object="text" data-key="15447"><span data-slate-leaf="true" data-offset-key="15447:0" data-first-offset="true"><span data-slate-string="true">我们先来说常规情况，也就是如果某个 G 没有进行系统调用（syscall）、没有进行 I/O 操作、没有阻塞在一个 channel 操作上，</span></span></span><span data-slate-object="text" data-key="15448"><span data-slate-leaf="true" data-offset-key="15448:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">调度器是如何让 G 停下来并调度下一个可运行的 G 的呢</span></span></span></span><span data-slate-object="text" data-key="15449"><span data-slate-leaf="true" data-offset-key="15449:0" data-first-offset="true"><span data-slate-string="true">？</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15450"><span data-slate-object="text" data-key="15451"><span data-slate-leaf="true" data-offset-key="15451:0" data-first-offset="true"><span data-slate-string="true">答案就是：</span></span></span><span data-slate-object="text" data-key="15452"><span data-slate-leaf="true" data-offset-key="15452:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">G 是被抢占调度的</span></span></span></span><span data-slate-object="text" data-key="15453"><span data-slate-leaf="true" data-offset-key="15453:0" data-first-offset="true"><span data-slate-string="true">。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15454"><span data-slate-object="text" data-key="15455"><span data-slate-leaf="true" data-offset-key="15455:0" data-first-offset="true"><span data-slate-string="true">前面说过，除非极端的无限循环，否则只要 G 调用函数，Go 运行时就有了抢占 G 的机会。Go 程序启动时，运行时会去启动一个名为 sysmon 的 M（一般称为监控线程），这个 M 的特殊之处在于它不需要绑定 P 就可以运行（以 g0 这个 G 的形式），这个 M 在整个 Go 程序的运行过程中至关重要，你可以看下我对 sysmon 被创建的部分代码以及 sysmon 的执行逻辑摘录：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15456"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15457"><span data-slate-object="text" data-key="15458"><span data-slate-leaf="true" data-offset-key="15458:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//$GOROOT/src/runtime/proc.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15459"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15460"><span data-slate-object="text" data-key="15461"><span data-slate-leaf="true" data-offset-key="15461:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// The main goroutine.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15462"><span data-slate-object="text" data-key="15463"><span data-slate-leaf="true" data-offset-key="15463:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15464"><span data-slate-leaf="true" data-offset-key="15464:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15465"><span data-slate-leaf="true" data-offset-key="15465:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="15466"><span data-slate-leaf="true" data-offset-key="15466:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="15467"><span data-slate-leaf="true" data-offset-key="15467:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15468"><span data-slate-object="text" data-key="15469"><span data-slate-leaf="true" data-offset-key="15469:0" data-first-offset="true"><span data-slate-string="true">     ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15470"><span data-slate-object="text" data-key="15471"><span data-slate-leaf="true" data-offset-key="15471:0" data-first-offset="true"><span data-slate-string="true">    systemstack(</span></span></span><span data-slate-object="text" data-key="15472"><span data-slate-leaf="true" data-offset-key="15472:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15473"><span data-slate-leaf="true" data-offset-key="15473:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="15474"><span data-slate-leaf="true" data-offset-key="15474:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15475"><span data-slate-object="text" data-key="15476"><span data-slate-leaf="true" data-offset-key="15476:0" data-first-offset="true"><span data-slate-string="true">        newm(sysmon, </span></span></span><span data-slate-object="text" data-key="15477"><span data-slate-leaf="true" data-offset-key="15477:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="15478"><span data-slate-leaf="true" data-offset-key="15478:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15479"><span data-slate-object="text" data-key="15480"><span data-slate-leaf="true" data-offset-key="15480:0" data-first-offset="true"><span data-slate-string="true">    })</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15481"><span data-slate-object="text" data-key="15482"><span data-slate-leaf="true" data-offset-key="15482:0" data-first-offset="true"><span data-slate-string="true">    .... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15483"><span data-slate-object="text" data-key="15484"><span data-slate-leaf="true" data-offset-key="15484:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15485"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15486"><span data-slate-object="text" data-key="15487"><span data-slate-leaf="true" data-offset-key="15487:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Always runs without a P, so write barriers are not allowed.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15488"><span data-slate-object="text" data-key="15489"><span data-slate-leaf="true" data-offset-key="15489:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15490"><span data-slate-object="text" data-key="15491"><span data-slate-leaf="true" data-offset-key="15491:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">//go:nowritebarrierrec</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15492"><span data-slate-object="text" data-key="15493"><span data-slate-leaf="true" data-offset-key="15493:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15494"><span data-slate-leaf="true" data-offset-key="15494:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15495"><span data-slate-leaf="true" data-offset-key="15495:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">sysmon</span></span></span></span></span><span data-slate-object="text" data-key="15496"><span data-slate-leaf="true" data-offset-key="15496:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="15497"><span data-slate-leaf="true" data-offset-key="15497:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15498"><span data-slate-object="text" data-key="15499"><span data-slate-leaf="true" data-offset-key="15499:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15500"><span data-slate-leaf="true" data-offset-key="15500:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// If a heap span goes unused for 5 minutes after a garbage collection,</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15501"><span data-slate-object="text" data-key="15502"><span data-slate-leaf="true" data-offset-key="15502:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15503"><span data-slate-leaf="true" data-offset-key="15503:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// we hand it back to the operating system.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15504"><span data-slate-object="text" data-key="15505"><span data-slate-leaf="true" data-offset-key="15505:0" data-first-offset="true"><span data-slate-string="true">    scavengelimit := </span></span></span><span data-slate-object="text" data-key="15506"><span data-slate-leaf="true" data-offset-key="15506:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="15507"><span data-slate-leaf="true" data-offset-key="15507:0" data-first-offset="true"><span data-slate-string="true">(</span></span></span><span data-slate-object="text" data-key="15508"><span data-slate-leaf="true" data-offset-key="15508:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">5</span></span></span></span><span data-slate-object="text" data-key="15509"><span data-slate-leaf="true" data-offset-key="15509:0" data-first-offset="true"><span data-slate-string="true"> * </span></span></span><span data-slate-object="text" data-key="15510"><span data-slate-leaf="true" data-offset-key="15510:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">60</span></span></span></span><span data-slate-object="text" data-key="15511"><span data-slate-leaf="true" data-offset-key="15511:0" data-first-offset="true"><span data-slate-string="true"> * </span></span></span><span data-slate-object="text" data-key="15512"><span data-slate-leaf="true" data-offset-key="15512:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1e9</span></span></span></span><span data-slate-object="text" data-key="15513"><span data-slate-leaf="true" data-offset-key="15513:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15514"><span data-slate-object="text" data-key="15515"><span data-slate-leaf="true" data-offset-key="15515:0" data-first-offset="true"><span data-slate-string="true">    ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15516"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15517"><span data-slate-object="text" data-key="15518"><span data-slate-leaf="true" data-offset-key="15518:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15519"><span data-slate-leaf="true" data-offset-key="15519:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15520"><span data-slate-leaf="true" data-offset-key="15520:0" data-first-offset="true"><span data-slate-string="true">  .... {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15521"><span data-slate-object="text" data-key="15522"><span data-slate-leaf="true" data-offset-key="15522:0" data-first-offset="true"><span data-slate-string="true">        ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15523"><span data-slate-object="text" data-key="15524"><span data-slate-leaf="true" data-offset-key="15524:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15525"><span data-slate-leaf="true" data-offset-key="15525:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// retake P's blocked in syscalls</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15526"><span data-slate-object="text" data-key="15527"><span data-slate-leaf="true" data-offset-key="15527:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15528"><span data-slate-leaf="true" data-offset-key="15528:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// and preempt long running G's</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15529"><span data-slate-object="text" data-key="15530"><span data-slate-leaf="true" data-offset-key="15530:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15531"><span data-slate-leaf="true" data-offset-key="15531:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15532"><span data-slate-leaf="true" data-offset-key="15532:0" data-first-offset="true"><span data-slate-string="true"> retake(now) != </span></span></span><span data-slate-object="text" data-key="15533"><span data-slate-leaf="true" data-offset-key="15533:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span><span data-slate-object="text" data-key="15534"><span data-slate-leaf="true" data-offset-key="15534:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15535"><span data-slate-object="text" data-key="15536"><span data-slate-leaf="true" data-offset-key="15536:0" data-first-offset="true"><span data-slate-string="true">            idle = </span></span></span><span data-slate-object="text" data-key="15537"><span data-slate-leaf="true" data-offset-key="15537:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">0</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15538"><span data-slate-object="text" data-key="15539"><span data-slate-leaf="true" data-offset-key="15539:0" data-first-offset="true"><span data-slate-string="true">        } </span></span></span><span data-slate-object="text" data-key="15540"><span data-slate-leaf="true" data-offset-key="15540:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">else</span></span></span></span><span data-slate-object="text" data-key="15541"><span data-slate-leaf="true" data-offset-key="15541:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15542"><span data-slate-object="text" data-key="15543"><span data-slate-leaf="true" data-offset-key="15543:0" data-first-offset="true"><span data-slate-string="true">            idle++</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15544"><span data-slate-object="text" data-key="15545"><span data-slate-leaf="true" data-offset-key="15545:0" data-first-offset="true"><span data-slate-string="true">        }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15546"><span data-slate-object="text" data-key="15547"><span data-slate-leaf="true" data-offset-key="15547:0" data-first-offset="true"><span data-slate-string="true">       ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15548"><span data-slate-object="text" data-key="15549"><span data-slate-leaf="true" data-offset-key="15549:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15550"><span data-slate-object="text" data-key="15551"><span data-slate-leaf="true" data-offset-key="15551:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15552"><span data-slate-object="text" data-key="15553"><span data-slate-leaf="true" data-offset-key="15553:0" data-first-offset="true"><span data-slate-string="true">我们看到，sysmon 每 20us~10ms 启动一次，sysmon 主要完成了这些工作：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15554"><div data-slate-type="list-line" data-slate-object="block" data-key="15555"><span data-slate-object="text" data-key="15556"><span data-slate-leaf="true" data-offset-key="15556:0" data-first-offset="true"><span data-slate-string="true">释放闲置超过 5 分钟的 span 内存；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15557"><span data-slate-object="text" data-key="15558"><span data-slate-leaf="true" data-offset-key="15558:0" data-first-offset="true"><span data-slate-string="true">如果超过 2 分钟没有垃圾回收，强制执行；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15559"><span data-slate-object="text" data-key="15560"><span data-slate-leaf="true" data-offset-key="15560:0" data-first-offset="true"><span data-slate-string="true">将长时间未处理的 netpoll 结果添加到任务队列；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15561"><span data-slate-object="text" data-key="15562"><span data-slate-leaf="true" data-offset-key="15562:0" data-first-offset="true"><span data-slate-string="true">向长时间运行的 G 任务发出抢占调度；</span></span></span></div><div data-slate-type="list-line" data-slate-object="block" data-key="15563"><span data-slate-object="text" data-key="15564"><span data-slate-leaf="true" data-offset-key="15564:0" data-first-offset="true"><span data-slate-string="true">收回因 syscall 长时间阻塞的 P；</span></span></span></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15565"><span data-slate-object="text" data-key="15566"><span data-slate-leaf="true" data-offset-key="15566:0" data-first-offset="true"><span data-slate-string="true">我们看到 sysmon 将 “向长时间运行的 G 任务发出抢占调度”，这个事情由函数</span></span></span><span data-slate-type="code" data-slate-object="inline" data-key="15567"><span data-slate-object="text" data-key="15568"><span data-slate-leaf="true" data-offset-key="15568:0" data-first-offset="true"><span data-slate-string="true"> retake</span></span></span></span><span data-slate-object="text" data-key="15569"><span data-slate-leaf="true" data-offset-key="15569:0" data-first-offset="true"><span data-slate-string="true"> 实施：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15570"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div><div data-code-line-number="13"></div><div data-code-line-number="14"></div><div data-code-line-number="15"></div><div data-code-line-number="16"></div><div data-code-line-number="17"></div><div data-code-line-number="18"></div><div data-code-line-number="19"></div><div data-code-line-number="20"></div><div data-code-line-number="21"></div><div data-code-line-number="22"></div><div data-code-line-number="23"></div><div data-code-line-number="24"></div><div data-code-line-number="25"></div><div data-code-line-number="26"></div><div data-code-line-number="27"></div><div data-code-line-number="28"></div><div data-code-line-number="29"></div><div data-code-line-number="30"></div><div data-code-line-number="31"></div><div data-code-line-number="32"></div><div data-code-line-number="33"></div><div data-code-line-number="34"></div><div data-code-line-number="35"></div><div data-code-line-number="36"></div><div data-code-line-number="37"></div><div data-code-line-number="38"></div><div data-code-line-number="39"></div><div data-code-line-number="40"></div><div data-code-line-number="41"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15571"><span data-slate-object="text" data-key="15572"><span data-slate-leaf="true" data-offset-key="15572:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// $GOROOT/src/runtime/proc.go</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15573"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15574"><span data-slate-object="text" data-key="15575"><span data-slate-leaf="true" data-offset-key="15575:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// forcePreemptNS is the time slice given to a G before it is</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15576"><span data-slate-object="text" data-key="15577"><span data-slate-leaf="true" data-offset-key="15577:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// preempted.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15578"><span data-slate-object="text" data-key="15579"><span data-slate-leaf="true" data-offset-key="15579:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">const</span></span></span></span><span data-slate-object="text" data-key="15580"><span data-slate-leaf="true" data-offset-key="15580:0" data-first-offset="true"><span data-slate-string="true"> forcePreemptNS = </span></span></span><span data-slate-object="text" data-key="15581"><span data-slate-leaf="true" data-offset-key="15581:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">10</span></span></span></span><span data-slate-object="text" data-key="15582"><span data-slate-leaf="true" data-offset-key="15582:0" data-first-offset="true"><span data-slate-string="true"> * </span></span></span><span data-slate-object="text" data-key="15583"><span data-slate-leaf="true" data-offset-key="15583:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000</span></span></span></span><span data-slate-object="text" data-key="15584"><span data-slate-leaf="true" data-offset-key="15584:0" data-first-offset="true"><span data-slate-string="true"> * </span></span></span><span data-slate-object="text" data-key="15585"><span data-slate-leaf="true" data-offset-key="15585:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1000</span></span></span></span><span data-slate-object="text" data-key="15586"><span data-slate-leaf="true" data-offset-key="15586:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15587"><span data-slate-leaf="true" data-offset-key="15587:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 10ms</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15588"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15589"><span data-slate-object="text" data-key="15590"><span data-slate-leaf="true" data-offset-key="15590:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15591"><span data-slate-leaf="true" data-offset-key="15591:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15592"><span data-slate-leaf="true" data-offset-key="15592:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">retake</span></span></span></span></span><span data-slate-object="text" data-key="15593"><span data-slate-leaf="true" data-offset-key="15593:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(now </span></span></span></span></span><span data-slate-object="text" data-key="15594"><span data-slate-leaf="true" data-offset-key="15594:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span></span></span><span data-slate-object="text" data-key="15595"><span data-slate-leaf="true" data-offset-key="15595:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">)</span></span></span></span></span><span data-slate-object="text" data-key="15596"><span data-slate-leaf="true" data-offset-key="15596:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15597"><span data-slate-leaf="true" data-offset-key="15597:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint32</span></span></span></span><span data-slate-object="text" data-key="15598"><span data-slate-leaf="true" data-offset-key="15598:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15599"><span data-slate-object="text" data-key="15600"><span data-slate-leaf="true" data-offset-key="15600:0" data-first-offset="true"><span data-slate-string="true">          ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15601"><span data-slate-object="text" data-key="15602"><span data-slate-leaf="true" data-offset-key="15602:0" data-first-offset="true"><span data-slate-string="true">           </span></span></span><span data-slate-object="text" data-key="15603"><span data-slate-leaf="true" data-offset-key="15603:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Preempt G if it's running for too long.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15604"><span data-slate-object="text" data-key="15605"><span data-slate-leaf="true" data-offset-key="15605:0" data-first-offset="true"><span data-slate-string="true">            t := </span></span></span><span data-slate-object="text" data-key="15606"><span data-slate-leaf="true" data-offset-key="15606:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="15607"><span data-slate-leaf="true" data-offset-key="15607:0" data-first-offset="true"><span data-slate-string="true">(_p_.schedtick)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15608"><span data-slate-object="text" data-key="15609"><span data-slate-leaf="true" data-offset-key="15609:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="15610"><span data-slate-leaf="true" data-offset-key="15610:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15611"><span data-slate-leaf="true" data-offset-key="15611:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15612"><span data-slate-leaf="true" data-offset-key="15612:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">int64</span></span></span></span><span data-slate-object="text" data-key="15613"><span data-slate-leaf="true" data-offset-key="15613:0" data-first-offset="true"><span data-slate-string="true">(pd.schedtick) != t {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15614"><span data-slate-object="text" data-key="15615"><span data-slate-leaf="true" data-offset-key="15615:0" data-first-offset="true"><span data-slate-string="true">                pd.schedtick = </span></span></span><span data-slate-object="text" data-key="15616"><span data-slate-leaf="true" data-offset-key="15616:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">uint32</span></span></span></span><span data-slate-object="text" data-key="15617"><span data-slate-leaf="true" data-offset-key="15617:0" data-first-offset="true"><span data-slate-string="true">(t)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15618"><span data-slate-object="text" data-key="15619"><span data-slate-leaf="true" data-offset-key="15619:0" data-first-offset="true"><span data-slate-string="true">                pd.schedwhen = now</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15620"><span data-slate-object="text" data-key="15621"><span data-slate-leaf="true" data-offset-key="15621:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="15622"><span data-slate-leaf="true" data-offset-key="15622:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15623"><span data-slate-object="text" data-key="15624"><span data-slate-leaf="true" data-offset-key="15624:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15625"><span data-slate-object="text" data-key="15626"><span data-slate-leaf="true" data-offset-key="15626:0" data-first-offset="true"><span data-slate-string="true">            </span></span></span><span data-slate-object="text" data-key="15627"><span data-slate-leaf="true" data-offset-key="15627:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15628"><span data-slate-leaf="true" data-offset-key="15628:0" data-first-offset="true"><span data-slate-string="true"> pd.schedwhen+forcePreemptNS &gt; now {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15629"><span data-slate-object="text" data-key="15630"><span data-slate-leaf="true" data-offset-key="15630:0" data-first-offset="true"><span data-slate-string="true">                </span></span></span><span data-slate-object="text" data-key="15631"><span data-slate-leaf="true" data-offset-key="15631:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">continue</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15632"><span data-slate-object="text" data-key="15633"><span data-slate-leaf="true" data-offset-key="15633:0" data-first-offset="true"><span data-slate-string="true">            }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15634"><span data-slate-object="text" data-key="15635"><span data-slate-leaf="true" data-offset-key="15635:0" data-first-offset="true"><span data-slate-string="true">            preemptone(_p_)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15636"><span data-slate-object="text" data-key="15637"><span data-slate-leaf="true" data-offset-key="15637:0" data-first-offset="true"><span data-slate-string="true">         ... ...</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15638"><span data-slate-object="text" data-key="15639"><span data-slate-leaf="true" data-offset-key="15639:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15640"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15641"><span data-slate-object="text" data-key="15642"><span data-slate-leaf="true" data-offset-key="15642:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15643"><span data-slate-leaf="true" data-offset-key="15643:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15644"><span data-slate-leaf="true" data-offset-key="15644:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">preemptone</span></span></span></span></span><span data-slate-object="text" data-key="15645"><span data-slate-leaf="true" data-offset-key="15645:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">(_p_ *p)</span></span></span></span></span><span data-slate-object="text" data-key="15646"><span data-slate-leaf="true" data-offset-key="15646:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15647"><span data-slate-leaf="true" data-offset-key="15647:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">bool</span></span></span></span><span data-slate-object="text" data-key="15648"><span data-slate-leaf="true" data-offset-key="15648:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15649"><span data-slate-object="text" data-key="15650"><span data-slate-leaf="true" data-offset-key="15650:0" data-first-offset="true"><span data-slate-string="true">    mp := _p_.m.ptr()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15651"><span data-slate-object="text" data-key="15652"><span data-slate-leaf="true" data-offset-key="15652:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15653"><span data-slate-leaf="true" data-offset-key="15653:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15654"><span data-slate-leaf="true" data-offset-key="15654:0" data-first-offset="true"><span data-slate-string="true"> mp == </span></span></span><span data-slate-object="text" data-key="15655"><span data-slate-leaf="true" data-offset-key="15655:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="15656"><span data-slate-leaf="true" data-offset-key="15656:0" data-first-offset="true"><span data-slate-string="true"> || mp == getg().m {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15657"><span data-slate-object="text" data-key="15658"><span data-slate-leaf="true" data-offset-key="15658:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15659"><span data-slate-leaf="true" data-offset-key="15659:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15660"><span data-slate-leaf="true" data-offset-key="15660:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15661"><span data-slate-leaf="true" data-offset-key="15661:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15662"><span data-slate-object="text" data-key="15663"><span data-slate-leaf="true" data-offset-key="15663:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15664"><span data-slate-object="text" data-key="15665"><span data-slate-leaf="true" data-offset-key="15665:0" data-first-offset="true"><span data-slate-string="true">    gp := mp.curg</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15666"><span data-slate-object="text" data-key="15667"><span data-slate-leaf="true" data-offset-key="15667:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15668"><span data-slate-leaf="true" data-offset-key="15668:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">if</span></span></span></span><span data-slate-object="text" data-key="15669"><span data-slate-leaf="true" data-offset-key="15669:0" data-first-offset="true"><span data-slate-string="true"> gp == </span></span></span><span data-slate-object="text" data-key="15670"><span data-slate-leaf="true" data-offset-key="15670:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">nil</span></span></span></span><span data-slate-object="text" data-key="15671"><span data-slate-leaf="true" data-offset-key="15671:0" data-first-offset="true"><span data-slate-string="true"> || gp == mp.g0 {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15672"><span data-slate-object="text" data-key="15673"><span data-slate-leaf="true" data-offset-key="15673:0" data-first-offset="true"><span data-slate-string="true">        </span></span></span><span data-slate-object="text" data-key="15674"><span data-slate-leaf="true" data-offset-key="15674:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15675"><span data-slate-leaf="true" data-offset-key="15675:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15676"><span data-slate-leaf="true" data-offset-key="15676:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">false</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15677"><span data-slate-object="text" data-key="15678"><span data-slate-leaf="true" data-offset-key="15678:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15679"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15680"><span data-slate-object="text" data-key="15681"><span data-slate-leaf="true" data-offset-key="15681:0" data-first-offset="true"><span data-slate-string="true">    gp.preempt = </span></span></span><span data-slate-object="text" data-key="15682"><span data-slate-leaf="true" data-offset-key="15682:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span><span data-slate-object="text" data-key="15683"><span data-slate-leaf="true" data-offset-key="15683:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15684"><span data-slate-leaf="true" data-offset-key="15684:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// 设置被抢占标志</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15685"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15686"><span data-slate-object="text" data-key="15687"><span data-slate-leaf="true" data-offset-key="15687:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15688"><span data-slate-leaf="true" data-offset-key="15688:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Every call in a go routine checks for stack overflow by</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15689"><span data-slate-object="text" data-key="15690"><span data-slate-leaf="true" data-offset-key="15690:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15691"><span data-slate-leaf="true" data-offset-key="15691:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// comparing the current stack pointer to gp-&gt;stackguard0.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15692"><span data-slate-object="text" data-key="15693"><span data-slate-leaf="true" data-offset-key="15693:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15694"><span data-slate-leaf="true" data-offset-key="15694:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// Setting gp-&gt;stackguard0 to StackPreempt folds</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15695"><span data-slate-object="text" data-key="15696"><span data-slate-leaf="true" data-offset-key="15696:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15697"><span data-slate-leaf="true" data-offset-key="15697:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">// preemption into the normal stack overflow check.</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15698"><span data-slate-object="text" data-key="15699"><span data-slate-leaf="true" data-offset-key="15699:0" data-first-offset="true"><span data-slate-string="true">    gp.stackguard0 = stackPreempt</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15700"><span data-slate-object="text" data-key="15701"><span data-slate-leaf="true" data-offset-key="15701:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15702"><span data-slate-leaf="true" data-offset-key="15702:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">return</span></span></span></span><span data-slate-object="text" data-key="15703"><span data-slate-leaf="true" data-offset-key="15703:0" data-first-offset="true"><span data-slate-string="true"> </span></span></span><span data-slate-object="text" data-key="15704"><span data-slate-leaf="true" data-offset-key="15704:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">true</span></span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15705"><span data-slate-object="text" data-key="15706"><span data-slate-leaf="true" data-offset-key="15706:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15707"><span data-slate-object="text" data-key="15708"><span data-slate-leaf="true" data-offset-key="15708:0" data-first-offset="true"><span data-slate-string="true">从上面的代码中，我们可以看出，</span></span></span><span data-slate-object="text" data-key="15709"><span data-slate-leaf="true" data-offset-key="15709:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">如果一个 G 任务运行 10ms，sysmon 就会认为它的运行时间太久而发出抢占式调度的请求</span></span></span></span><span data-slate-object="text" data-key="15710"><span data-slate-leaf="true" data-offset-key="15710:0" data-first-offset="true"><span data-slate-string="true">。一旦 G 的抢占标志位被设为 true，那么等到这个 G 下一次调用函数或方法时，运行时就可以将 G 抢占并移出运行状态，</span></span><span data-slate-leaf="true" data-offset-key="15710:1"><span data-slate-object="annotation" data-annotation-key="gkann_68146f70" data-attr-id="35552" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">放入队列中，等待下一次被调度。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15711"><span data-slate-object="text" data-key="15712"><span data-slate-leaf="true" data-offset-key="15712:0" data-first-offset="true"><span data-slate-string="true">不过，除了这个常规调度之外，还有两个特殊情况下 G 的调度方法。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15713"><span data-slate-object="text" data-key="15714"><span data-slate-leaf="true" data-offset-key="15714:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第一种：channel 阻塞或网络 I/O 情况下的调度。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15715"><span data-slate-object="text" data-key="15716"><span data-slate-leaf="true" data-offset-key="15716:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_78038fad" data-attr-id="39300" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果 G 被阻塞在某个 channel 操作或网络 I/O 操作上时，G 会被放置到某个等待（wait）队列中，而 M 会尝试运行 P 的下一个可运行的 G。如果这个时候 P 没有可运行的 G 供 M 运行，那么 M 将解绑 P，并进入挂起状态。当 I/O 操作完成或 channel 操作完成，在等待队列中的 G 会被唤醒，标记为可运行（runnable），并被放入到某 P 的队列中，绑定一个 M 后继续执行。</span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15717"><span data-slate-object="text" data-key="15718"><span data-slate-leaf="true" data-offset-key="15718:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_1a939c4d" data-attr-id="40556" data-attr-name="public" data-annotation-type="public"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">第二种：系统调用阻塞情况下的调度。</span></span></span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15719"><span data-slate-object="text" data-key="15720"><span data-slate-leaf="true" data-offset-key="15720:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_97a18252" data-attr-id="33715" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果 G 被阻塞在某个系统调用（system call）上，那么不光 G 会阻塞，执行这个 G 的 M 也会解绑 P，与 G 一起进入挂起状态。</span></span></span><span data-slate-leaf="true" data-offset-key="15720:1"><span data-slate-string="true">如果此时有空闲的 M，那么 P 就会和它绑定，并继续执行其他 G；如果没有空闲的 M，但仍然有其他 G 要去执行，那么 Go 运行时就会创建一个新 M（线程）。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15721"><span data-slate-object="text" data-key="15722"><span data-slate-leaf="true" data-offset-key="15722:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_fc657d83" data-attr-id="39301" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">当系统调用返回后，阻塞在这个系统调用上的 G 会尝试获取一个可用的 P，如果没有可用的 P，那么 G 会被标记为 runnable，之前的那个挂起的 M 将再次进入挂起状态。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15723" id="sr-toc-6"><span data-slate-object="text" data-key="15724"><span data-slate-leaf="true" data-offset-key="15724:0" data-first-offset="true"><span data-slate-string="true">小结</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15725"><span data-slate-object="text" data-key="15726"><span data-slate-leaf="true" data-offset-key="15726:0" data-first-offset="true"><span data-slate-string="true">好了，今天的课讲到这里就结束了，现在我们一起来回顾一下吧。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15727"><span data-slate-object="text" data-key="15728"><span data-slate-leaf="true" data-offset-key="15728:0" data-first-offset="true"><span data-slate-string="true">基于 Goroutine 的并发设计离不开一个高效的生产级调度器。Goroutine 调度器演进了十余年，先后经历了 G-M 模型、G-P-M 模型和 work stealing 算法、协作式的抢占调度以及基于信号的异步抢占等改进与优化，目前 Goroutine 调度器相对稳定和成熟，可以适合绝大部分生产场合。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15729"><span data-slate-object="text" data-key="15730"><span data-slate-leaf="true" data-offset-key="15730:0" data-first-offset="true"><span data-slate-string="true">现在的 G-P-M 模型和最初的 G-M 模型相比，通过向 G-M 模型中增加了一个代表逻辑处理器的 P，使得 Goroutine 调度器具有了更好的伸缩性。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15731"><span data-slate-object="text" data-key="15732"><span data-slate-leaf="true" data-offset-key="15732:0" data-first-offset="true"><span data-slate-string="true">M 是 Go 代码运行的真实载体，包括 Goroutine 调度器自身的逻辑也是在 M 中运行的。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15733"><span data-slate-object="text" data-key="15734"><span data-slate-leaf="true" data-offset-key="15734:0" data-first-offset="true"><span data-slate-string="true">P 在 G-P-M 模型中占据核心地位，它拥有待调度的 G 的队列，同时 M 要想运行 G 必须绑定一个 P。一个 G 被调度执行的时间不能过长，超过特定长的时间后，G 会被设置为</span></span></span><span data-slate-object="text" data-key="15735"><span data-slate-leaf="true" data-offset-key="15735:0" data-first-offset="true"><span data-slate-type="bold" data-slate-object="mark"><span data-slate-string="true">可抢占</span></span></span></span><span data-slate-object="text" data-key="15736"><span data-slate-leaf="true" data-offset-key="15736:0" data-first-offset="true"><span data-slate-string="true">，并在下一次执行函数或方法时被 Go 运行时移出运行状态。</span></span></span></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15737"><span data-slate-object="text" data-key="15738"><span data-slate-leaf="true" data-offset-key="15738:0" data-first-offset="true"><span data-slate-object="annotation" data-annotation-key="gkann_ccbf150e" data-attr-id="36423" data-attr-name="public" data-annotation-type="public"><span data-slate-string="true">如果 G 被阻塞在某个 channel 操作或网络 I/O 操作上时，M 可以不被阻塞，这避免了大量创建 M 导致的开销。但如果 G 因慢系统调用而阻塞，那么 M 也会一起阻塞，但在阻塞前会与 P 解绑，P 会尝试与其他 M 绑定继续运行其他 G。但若没有现成的 M，Go 运行时会建立新的 M，这也是系统调用可能导致系统线程数量增加的原因，你一定要注意这一点。</span></span></span></span></div><h2 data-slate-type="heading" data-slate-object="block" data-key="15739" id="sr-toc-7"><span data-slate-object="text" data-key="15740"><span data-slate-leaf="true" data-offset-key="15740:0" data-first-offset="true"><span data-slate-string="true">思考题</span></span></span></h2><div data-slate-type="paragraph" data-slate-object="block" data-key="15741"><span data-slate-object="text" data-key="15742"><span data-slate-leaf="true" data-offset-key="15742:0" data-first-offset="true"><span data-slate-string="true">为了让你更好理解 Goroutine 调度原理，我这里留个思考题。请看下面代码：</span></span></span></div><div data-code-language="go" data-slate-type="pre" data-slate-object="block" data-key="15743"><div><span></span></div><div><div data-code-line-number="1"></div><div data-code-line-number="2"></div><div data-code-line-number="3"></div><div data-code-line-number="4"></div><div data-code-line-number="5"></div><div data-code-line-number="6"></div><div data-code-line-number="7"></div><div data-code-line-number="8"></div><div data-code-line-number="9"></div><div data-code-line-number="10"></div><div data-code-line-number="11"></div><div data-code-line-number="12"></div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><div data-origin="pm_code_preview"><div data-slate-type="code-line" data-slate-object="block" data-key="15744"><span data-slate-object="text" data-key="15745"><span data-slate-leaf="true" data-offset-key="15745:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15746"><span data-slate-leaf="true" data-offset-key="15746:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15747"><span data-slate-leaf="true" data-offset-key="15747:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">deadloop</span></span></span></span></span><span data-slate-object="text" data-key="15748"><span data-slate-leaf="true" data-offset-key="15748:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="15749"><span data-slate-leaf="true" data-offset-key="15749:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15750"><span data-slate-object="text" data-key="15751"><span data-slate-leaf="true" data-offset-key="15751:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15752"><span data-slate-leaf="true" data-offset-key="15752:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="15753"><span data-slate-leaf="true" data-offset-key="15753:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15754"><span data-slate-object="text" data-key="15755"><span data-slate-leaf="true" data-offset-key="15755:0" data-first-offset="true"><span data-slate-string="true">    } </span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15756"><span data-slate-object="text" data-key="15757"><span data-slate-leaf="true" data-offset-key="15757:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15758"></div><div data-slate-type="code-line" data-slate-object="block" data-key="15759"><span data-slate-object="text" data-key="15760"><span data-slate-leaf="true" data-offset-key="15760:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">func</span></span></span></span></span><span data-slate-object="text" data-key="15761"><span data-slate-leaf="true" data-offset-key="15761:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true"> </span></span></span></span><span data-slate-object="text" data-key="15762"><span data-slate-leaf="true" data-offset-key="15762:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">main</span></span></span></span></span><span data-slate-object="text" data-key="15763"><span data-slate-leaf="true" data-offset-key="15763:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">()</span></span></span></span></span><span data-slate-object="text" data-key="15764"><span data-slate-leaf="true" data-offset-key="15764:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15765"><span data-slate-object="text" data-key="15766"><span data-slate-leaf="true" data-offset-key="15766:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15767"><span data-slate-leaf="true" data-offset-key="15767:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">go</span></span></span></span><span data-slate-object="text" data-key="15768"><span data-slate-leaf="true" data-offset-key="15768:0" data-first-offset="true"><span data-slate-string="true"> deadloop()</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15769"><span data-slate-object="text" data-key="15770"><span data-slate-leaf="true" data-offset-key="15770:0" data-first-offset="true"><span data-slate-string="true">    </span></span></span><span data-slate-object="text" data-key="15771"><span data-slate-leaf="true" data-offset-key="15771:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">for</span></span></span></span><span data-slate-object="text" data-key="15772"><span data-slate-leaf="true" data-offset-key="15772:0" data-first-offset="true"><span data-slate-string="true"> {</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15773"><span data-slate-object="text" data-key="15774"><span data-slate-leaf="true" data-offset-key="15774:0" data-first-offset="true"><span data-slate-string="true">        time.Sleep(time.Second * </span></span></span><span data-slate-object="text" data-key="15775"><span data-slate-leaf="true" data-offset-key="15775:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">1</span></span></span></span><span data-slate-object="text" data-key="15776"><span data-slate-leaf="true" data-offset-key="15776:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15777"><span data-slate-object="text" data-key="15778"><span data-slate-leaf="true" data-offset-key="15778:0" data-first-offset="true"><span data-slate-string="true">        fmt.Println(</span></span></span><span data-slate-object="text" data-key="15779"><span data-slate-leaf="true" data-offset-key="15779:0" data-first-offset="true"><span data-slate-type="mark-class" data-slate-object="mark"><span data-slate-string="true">"I got scheduled!"</span></span></span></span><span data-slate-object="text" data-key="15780"><span data-slate-leaf="true" data-offset-key="15780:0" data-first-offset="true"><span data-slate-string="true">)</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15781"><span data-slate-object="text" data-key="15782"><span data-slate-leaf="true" data-offset-key="15782:0" data-first-offset="true"><span data-slate-string="true">    }</span></span></span></div><div data-slate-type="code-line" data-slate-object="block" data-key="15783"><span data-slate-object="text" data-key="15784"><span data-slate-leaf="true" data-offset-key="15784:0" data-first-offset="true"><span data-slate-string="true">}</span></span></span></div></div></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15785"><span data-slate-object="text" data-key="15786"><span data-slate-leaf="true" data-offset-key="15786:0" data-first-offset="true"><span data-slate-string="true">我的问题是：</span></span></span></div><div data-slate-type="list" data-slate-object="block" data-key="15787"><div data-slate-type="list-line" data-slate-object="block" data-key="15788"><div data-code-line-number="1"></div><div><span data-slate-object="text" data-key="15789"><span data-slate-leaf="true" data-offset-key="15789:0" data-first-offset="true"><span data-slate-string="true">在一个拥有多核处理器的主机上，使用 Go 1.13.x 版本运行这个示例代码，你在命令行终端上是否能看到 “I got scheduled!” 输出呢？也就是 main goroutine 在创建 deadloop goroutine 之后是否能继续得到调度呢？</span></span></span></div></div><div data-slate-type="list-line" data-slate-object="block" data-key="15790"><div data-code-line-number="2"></div><div><span data-slate-object="text" data-key="15791"><span data-slate-leaf="true" data-offset-key="15791:0" data-first-offset="true"><span data-slate-string="true">我们通过什么方法可以让上面示例中的 main goroutine，在创建 deadloop goroutine 之后无法继续得到调度？</span></span></span></div></div></div><div data-slate-type="paragraph" data-slate-object="block" data-key="15792"><span data-slate-object="text" data-key="15793"><span data-slate-leaf="true" data-offset-key="15793:0" data-first-offset="true"><span data-slate-string="true">欢迎你把这节课分享给更多对 Gouroutine 调度原理感兴趣的朋友。我是 Tony Bai，我们下节课见。</span></span></span></div></div></div></div><div><div></div><div></div><div><div data-simplebar="init"><div><div><div></div></div><div><div><div><div><textarea placeholder="将学到的知识总结成笔记，方便日后快速查找及复习"></textarea></div></div></div></div><div></div></div><div><div></div></div><div><div></div></div></div><div><div>确认放弃笔记？</div><div>放弃后所记笔记将不保留。</div></div><div><div>新功能上线，你的历史笔记已初始化为私密笔记，是否一键批量公开？</div><div>批量公开的笔记不会为你同步至部落</div></div><div></div></div><div><div><div>公开</div><div>同步至部落</div></div><div>取消</div><div>完成</div></div><div><span>0/2000</span></div></div><div><div><span>划线</span></div><div></div><div></div><div></div><div><span>笔记</span></div><div></div><div><span>复制</span></div></div></div><div><div><div><span></span></div><p><span>19</span> 人觉得很赞<a href="javascript:void(0);">给文章提建议</a></p></div></div><div><div class="sr-rd-content-center"><img class="sr-rd-content-img" src="https://static001.geekbang.org/resource/image/1f/81/1f6c18433af717a740f1e49389f2f981.png"></div></div><div><span>©</span> 版权归极客邦科技所有，未经许可不得传播售卖。 页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。 </div></div><div><div><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAgICAgICAgICAgIDAwMDAwMDAwMDAQEBAQEBAQIBAQICAgECAgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwP/wAARCADuAO4DAREAAhEBAxEB/8QAfAABAAICAwEBAAAAAAAAAAAAAAYHBAgBAwUCCgEBAAAAAAAAAAAAAAAAAAAAABAAAgIBAgIECwQJBQAAAAAAAAECAwQRBSEGMWESF0FRgVITk+MUVJTUIkJiB5EyhBVFhbXFNnFygqJTEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD9vAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGHmbhg7fD0mbl4+LF69l32wrctPBCMmpTfUk2BG7ue+Wqm4rNsua6XTi5DWvVKyutPyaoDmnnrlq19l506W9NPTYuSk2/xQqnGPlaQElxM7Dzq/S4WVj5VfhlRbC1Rfil2G3GXU9GBlAAAAAAAAAAAAAAAAAAAAAAAAAAAA4bUU5SajGKblJtJJJattvgkkBVHMnP8AJSswtilHSLcLdxcVLV9DWHCWsdF/6ST1+6uiQFW35F+VbK/Jutvum9Z23WSssk/xTm3JgdIADvx8nIxLY34t9uPdD9W2myVc1412otPR6cV0MC1uWufvTTrwd8cITlpCrcYpQhKT4KOXBaQrbf346R8aXFgWmnrxXFPimvCAAAAAAAAAAAAAAAAAAAAAAAAAAFUfmBzHKLexYVjjrGMtxsg+LU12oYia6E4tSn400vOQFTAAAAAAAuDkDmSWRFbHm2OVtUHLb7ZvWU6oLWeK2+LdMV2ofgTX3UBaAAAAAAAAAAAAAAAAAAAAAAAABi52XDAwsvNs4wxce6+S10cvRQlNQX4ptaLrYGr+RfblX3ZN8nO7Itsutk/vWWSc5Pq4sDpAAAAAABlYWXbgZeNmUPS3Guruhx0TcJJ9mWnTGa4NeFMDaDGvrysejJqeteRTVfW/HC2EbI/9ZAdwAAAAAAAAAAAAAAAAAAAAAACJc8WurlncOzwdrxateqeVT2v0wTXlA18AAAAAAAAAbFcnXSu5a2mcnq402U/8cfJuoivJGtASYAAAAAAAAAAAAAAAAAAAAAABFOdqXdyzuSjxlWse7yVZVMp/or1YGvQAAAAAAAADY3lGiWPy3tNclo5Yzv8AF9nJusyYvyxtQEjAAAAAAAAAAAAAAAAAAAAAAAdGVj15eNkYty1qyaLaLF4exbCVctOvSXADWDNxLsDLycLIj2bsa6dM/E3B6KUfHCa0afhTAxQAAAAAAZ224Nu55+LgUp+kyboV6pa9iDetljXm1VpyfUgNnqaoUU1UVLs101wqrj4oVxUILyRQHYAAAAAAAAAAAAAAAAAAAAAAAAVrz5yzPNh++cGtzyaK1HNpgtZX0QX2bopcZW0R4NdLhp5ujCmQAAAAAAXbyLyzPbaXumdW4ZuVX2aKprSWNjS0bck+Mbr9FqumMeHS2gLDAAAAAAAAAAAAAAAAAAAAAAAAAACuOZOQ6c+dmbtDrxcubc7cWX2cbIm+LlW0n7vbLw8OxJ+bxbCpM7bM/bLXVn4l+NPVpekg1CenhrsWtdseuLaAwQAHo7ftO47raqsDEuyZapSlCOlVevhtul2aql/uaAt3lrkWjbJ15u5yry86Gk6qYrXFxpripfaSd90X0NpRi+hNpSAsIAAAAAAAAAAAAAAAAAAAAAAAAAAAAD4sqrug67a4W1y/WhZCM4P/AFjJNMDw7eVuXrm5T2jCTfT6Kr0C49VLrQHNPK/L1ElKvaMJtcU7alfo/Gle7FqB7cK4VQVdcIVwitIwhFQhFeJRikkgPsAAAAAAAAAAAAAAAAAAAAAAAAAY2XmYuBRPKzL68aiv9ay2XZjq+iKXTKcvBFJt+BARGf5g8uRk4q3LsSeinDFkoy60pyhPR9aQHz3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAHeHy752b8r7QB3h8u+dm/K+0Ad4fLvnZvyvtAMjG575cybY1PKtxnJpRnk0Trq1fglZHtxrXXLRLxgTCMozjGUZKUZJSjKLTjKLWqlFrVNNPgwOQAAAAAAAAAAAAAAAAAAAAUZ+YW43ZG9ywHOSx9vqpUa9fsu7IphkTta8MnCyMepLrYECAAAAAAAAAAAF0/lxuN2Tt+Zg2zlOO320uhyerhTlK1qpPzYWUSa8Xa06NALHAAAAAAAAAAAAAAAAAAAABr3zx/lO6fsX9OxAImAAAAAAAAAAALY/K/+Ofyz+4AWwAAAAAAAAAAAAAAAAAAAADXvnj/ACndP2L+nYgETAAAAAAAAAAAFsflf/HP5Z/cALYAAAAAAAAAAAAAAAAAAAABVvMfJG7bxvOZuONkbdCjI937Eb7cmNq9DiUUS7Ua8S2C1nU2tJPgB4fdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAHdrvvxe0+vzPoAJvyby1ncvfvH323Et989z9F7rZdPs+7+9dvt+loo019OtNNfD0ATcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//Z"></div><div>Geek__653581f21177</div></div><div><textarea placeholder="由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。" rows="16"></textarea></div><div><div>Ctrl + Enter 发表</div><div>0/2000 字符</div><div>提交留言</div></div></div><div><h2 id="sr-toc-8">精选留言 (17)</h2><ul><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div></div><div><div><div><span>Geek_cca544</span></div></div><div>go1.13 的话加上 runtime.GOMAXPROCS (1) main goroutine 在创建 deadloop goroutine 之后就无法继续得到调度
但如果是 go1.14 之后的话即使加上 runtime.GOMAXPROCS (1) main goroutine 在创建 deadloop goroutine 之后还是可以得到调度，应该是因为增加了对非协作的抢占式调度的支持</div><div><p>作者回复: ✅</p></div><div><div>2022-01-11</div><div><div><i></i></div><div><i></i><span>26</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/9d/a4/e481ae48.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>lesserror</span></div></div><div>大白老师这篇算是让我重新对 Go 的 G、P、M 模型有了一个新的认识。感谢。不过还是有几处疑惑的地方：

1. 怎么理解文中的：“集中状态存储” 和 “数据局部性较差”，能再进一步解释一下么？

2. 编译器在每个函数或方法的入口处加上了一段额外的代码 (runtime.morestack_noctxt)，括号中的：runtime.morestack_noctxt 这是一个文件么？

3. 怎么理解 “协作式”、“非协作式” 呢？看了文章还是没太明白。

4. 关于挂起，百度的说法大概是：“暂时被淘汰出内存的进程。”，这里该怎么理解呢？

5. 为什么 M 有时必须要与 G 一起挂起？M 不是可以不保存 G 的状态的吗？M 不能直接去绑定别的 p 吗？为什么要频繁的挂起呢？

PS：老师的文档链接好评，最原始的出处标准的很明确。</div><div><p>作者回复: 1. 按照 Dmitry Vyukov 原文的意思： 集中状态 (centralized state)，我理解就是一把全局锁要保护的数据太多。这样无论访问哪个数据，都要锁这把全局锁。数据局部性差是因为每个 m 都会缓存它执行的代码或数据，但是如果在 m 之间频繁传递 goroutine，那么这种局部缓存的意义就没有了。无法实现局部缓存带来的性能提升。

2. runtime.morestack_noctxt 是一个函数。
3. 协作式：大家都按事先定义好的规则来，比如：一个 goroutine 执行完后，退出，让出 p，然后下一个 goroutine 被调度到 p 上运行。这样做的缺点就在于 是否让出 p 的决定权在 groutine 自身。一旦某个 g 不主动让出 p 或执行时间较长，那么后面的 goroutine 只能等着，没有方法让前者让出 p，导致延迟甚至饿死。而非协作：就是由 runtime 来决定一个 goroutine 运行多长时间，如果你不主动让出，对不起，我有手段可以抢占你，把你踢出去，让后面的 goroutine 进来运行。

4. 挂起这里你可以理解为暂停运行，等待下一次调度。
5. 当进行一些慢系统调用的时候，比如常规文件 io，执行系统调用的 m 就要和 g 一起挂起，这是 os 的要求，不是 go runtime 的要求。毕竟真正执行代码的还是 m。
 </p></div><div><div>2022-01-13</div><div><div><i></i></div><div><i></i><span>13</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTJ8ic8eLTo5rnqIMJicUfpkVBrOUJAW4fANicKIbHdC54O9SOdwSoeK6o8icibaUbh7ZUXAkGF9zwHqo0Q/132"></div></div><div><div><div><span>ivhong</span></div></div><div>谢谢大白老师，能把这么晦涩的原理讲的这么清楚。我反复看了很多遍，做了如下总结，不知道是不是合理，希望老师闲暇之余给予指正，🙏。
在文中提及的 GPM，以及 GPM 之前的相互配合，完成了 go 的并发功能。

G：可以看作关键字 go 后面跟着的可执行代码块（即 goroutine），当然包含这个代码块的一些本身的信息（比如栈信息、状态等等一些必要的属性）。另外存在一个 G 的全局队列，只要是需要执行的 goroutine 都会被放倒这个全局队列里。

P：可以看作逻辑上的 “任务处理器”，go 有多个这个处理器，具体的数量由 runtime.GOMAXPROCS (1) 指定，它有下面的指责：
    1. 它有自己 G 队列。当他发现自己的队列为空时，可以去全局 G 队列里获取等待执行的 goroutine，甚至可以去其他的 P 的队列里抢用 goroutine。他把拿过来的 goroutine 放到自己的队列里
    2. 他可以找到一个空闲的 M 与自己绑定，用来运行自己队列中的 goroutine，如果没有空闲的 M，则创建一个 M 来绑定
    3. 被 P 绑定的 M，可以自己主动的与 P 解绑，当 P 发现自己的 M 被解绑，就执行 2
    4. 如果自己队列中没有 goroutine，也无法从 “外面” 获取 goroutine，则与 M 解绑（解绑 M 时，是按什么逻辑选择挂起 M 或者释放 M 呢？）

M：物理的处理器，具体执行 goroutine 的系统线程，所有 goroutine 都是在 M 中执行的，它被 P 创建，与 P 绑定后可执行 P 队列中的 goroutine，在执行 goroutine 会处理 3 中情况保证并发是顺利的（不会发生 “饿死”，资源分配不平等的情况）
    1. 当 G 长时间运行时，可以被 Go 暂停执行而被移出 M（是不是放到全局 G 队列呢？），等待下次运行（即抢占式调度）。
    2. 如果 G 发生了 channel 等待或者 网络 I/O 请求，则把 G 放到某个等待队列中，M 继续执行下一 goroutine，当 G 等待的结果返回时，会唤醒 “G”，并把它放入到全局 G 的队列中，等待 P 的获取（这里不知道理解的对不对？）。
    3. 如果 G 产生了系统调用，则 M 与 P 解绑，然后 M 和它正执行的 G 被操作系统 “挂起” 等待操作系统的中断返回（对于操作系统而言，M 和 G 是一回事；而对于 GO 来说，G 只有能在 M 中运行，只有运行才触发发系统调用）。

</div><div><p>作者回复: 👍</p></div><div><div>2022-03-15</div><div><div><i></i></div><div><i></i><span>8</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/ba/ce/fd45714f.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>bearlu</span></div></div><div>老师，想学习 goroutine 调度器，演进的关键版本，依次是 go 的什么发行版？还有什么相关资料书籍？谢谢老师</div><div><p>作者回复：欧长坤老师维护的这个 go history 中有关调度器的演化可以参考：https://golang.design/history/#scheduler</p></div><div><div>2022-01-10</div><div><div><i></i><span>2</span></div><div><i></i><span>4</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/27/d8/39/acb7e16e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span> 麦芒极客</span></div></div><div>老师您好，G 遇到网络 IO 阻塞时，真正的线程即 M 不应该也阻塞吗？</div><div><p>作者回复：好问题！不过当网络 I/O 阻塞时，M 真不会阻塞。

因为 runtime 层实现了 netpoller，netpoller 是基于 os 提供的 I/O 多路复用模型实现的 (比如: linux 上的 epoll)，这允许一个线程处理多个 socket。这就使得当某个 goroutine 的 socket 发送 i/o 阻塞时，仅会让 goroutine 变为阻塞状态，runtime 会将对应的 socket 与 goroutine 加入到 netpoller 的监听中，然后 M 继续执行其他 goroutine 的任务。等 netpoller 监视到之前的 socket 可读 / 可写时，再把对应的 goroutine 唤醒继续执行网络 i/o。

</p></div><div><div>2022-05-22</div><div><div><i></i></div><div><i></i><span>3</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/11/53/a8/abc96f70.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>return</span></div></div><div>老师讲的太好了，干货慢慢，老师已经把流程和原理讲清楚了，
原理下的 更底层细节 得自己再研究学习。
</div><div><p>作者回复: 👍</p></div><div><div>2022-01-11</div><div><div><i></i></div><div><i></i><span>2</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/10/f1/de/3ebcbb3f.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>DullBird</span></div></div><div>小结上面一句：之前的那个挂起的 M 将再次进入挂起状态。   最后是不是运行状态吧？</div><div><p>作者回复：文里有说，是在系统调用返回后，找不到 idle 的 P 的情况下，m 会进入到 idle m 池中挂起。</p></div><div><div>2022-01-11</div><div><div><i></i></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/57/4f/6fb51ff1.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span> 一步</span><span><div class="sr-rd-content-center"><img class="" src="https://static001.geekbang.org/resource/image/89/43/89yyff4c4c2e2b73ce4931bb01a6a943.png"></div></span></div></div><div>思考题：
是不是不管怎么处理，main goroutine  都会被调度？</div><div><p>作者回复：试试将 P 的数量置为 1.</p></div><div><div>2022-01-10</div><div><div><i></i><span>2</span></div><div><i></i><span>1</span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="http://thirdwx.qlogo.cn/mmopen/vi_32/7hOJBKZVrJD8ayZoYnq0ECFsoWf9yx6eyq3JU8p1449A6cKEp5rSpicJRg5vH3HZgq5YwbpGicBvyARFutcPLGgw/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Mr_D</span></div></div><div>请问 G 的可重用具体指什么呢？是针对已经运行结束的 G 留下的内存空间，进行相关数据的重填么</div><div><p>作者回复：对，goroutine 退出后，runtime 层的 G 对象会被放入一个 Free G 对象的池子中，后续有新 Goroutine 创建时，优先从池子里 get 一个。可以看 Go 源码：runtime/proc.go 中的代码。</p></div><div><div>2022-08-11</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/0f/54/9a/76c0af70.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>每天晒白牙</span></div></div><div>思考题
1. 在一个拥有多核处理器的主机上，使用 Go 1.13.x 版本运行这个示例代码，你在命令行终端上是否能看到 “I got scheduled!” 输出呢？也就是 main goroutine 在创建 deadloop goroutine 之后是否能继续得到调度呢？
答：不会得到调度，首先 Go 是在 1.2 版本增加的抢占式调度，1.13.x 版本还不支持，因为 deadloop goroutine 是死循环，所以这个 G 会永远占用分配的 P 和 M

2. 我们通过什么方法可以让上面示例中的 main goroutine，在创建 deadloop goroutine 之后无法继续得到调度？
两个必要条件
①go 的版本要在 1.2 之前，因为 1.2 之前不支持抢占式调度，可以确保 G 可以占用分配给它的 P 和 M
②设置 GOMAXPROCS=1
</div><div><p>作者回复: “Go 是在 1.2 版本增加的抢占式调度，1.13.x 版本还不支持” ， 1.2 版本？</p></div><div><div>2022-07-19</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1f/64/8a/bc8cb43c.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>路边的猪</span></div></div><div>第一种，因为网络 io 导致阻塞的处理方式这里。我想问，网络 io 势必会引起系统调用，比如最基础的建立 tcp 连接这些，那这块儿是咋区分系统调用和网络 io 的呢？</div><div><p>作者回复：由于 go 运行时 netpoller 的存在，我们很难精确区分。这种 “网络 io” 会被 runtime 转换为 goroutine 的调度等，不一定真的实施网络 io。</p></div><div><div>2022-06-05</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://wx.qlogo.cn/mmopen/vi_32/wgMMrp1hvSB3E30KqZvMsj3KQdAI3T1uQM77LT7hZ65nVSjPGRg3AbUOyiahnssA6AIT5PAkyHFmlTBzUH9gdyQ/132"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>pythonbug</span></div></div><div>“如果一个 G 任务运行 10ms，...... 那么等到这个 G 下一次调用函数或方法时，...... 等待下一次被调度。”
老师好，有个问题，某个 goroutine 运行超过 10ms 了，为啥不直接抢占，等待下一次是什么意思呢？那么这次是直接运行完吗，既然这次都运行完了，又怎么会有下一次呢。。。这段不大理解，有点懵了。。。</div><div><p>作者回复: go 1.14 版本之前不支持直接抢占，而是在函数或方法中 “添加调度代码”，所以虽然设置了抢占标志，但是只有下一次运行 “添加的调度代码” 时，该 G 才会让出 M。</p></div><div><div>2022-04-28</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/1c/96/dd/1620a744.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>simple_孙</span></div></div><div>每个 P 是不是跟 Java 中的线程一样都有一个就绪队列和等待队列呢</div><div><p>作者回复：每个 P 只有一个队列。</p></div><div><div>2022-03-18</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/14/ce/d7/5315f6ce.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>不负青春不负己🤘</span></div></div><div>mark</div><div><p>作者回复: 👍</p></div><div><div>2022-02-02</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/13/0c/46/dfe32cf4.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>多选参数</span></div></div><div>有几个问题想问老师： 
1. 文章中提到的 Go 运行时这块更多是指哪些内容？Go 调度器应该也是 Go 运行时中的部分内容吧？就是 Go 开源的源代码吗？
2. 有关 Go 运行时比较好的资料推荐吗？比如 Go 运行时的架构、Go 运行时是怎么和用户编写的代码合在一起的，因为我理解的 Go 运行时不像 JVM 那样，Go 是编译性的，也就是说会将用户编写的代码和 Go 运行时代码一起编译成二进制，然后运行是从 Go 运行时开始的，然后在从用户逻辑的代码开始。

老师有空的时候麻烦解答下，谢谢老师～</div><div><p>作者回复: 《Go 语言第一课 FAQ》中有这方面的解答，你可以先看看。 https://tonybai.com/go-course-faq </p></div><div><div>2022-01-29</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QN5aHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YWE3YmZhMDItMzBhMC00MDg3LTg3MmYtOGMwMjMxNjNhZWRjIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjI2MTlEODM3NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI2MTlEODM2NTgzMTExRTk5NDY4Qjk3QUFCNDFBN0QzIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6OTYyRTNCMDNBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6OTYyRTNCMDRBREI4MTFFOEFFNTJDODlGREQ1OTUzMDMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRm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"></div><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/resource/image/eb/56/eb5afbf568af2917033e5a860de0b756.png?x-oss-process=image/resize,w_28"></div></div><div><div><div><span>Geek_0b92d9</span></div></div><div>老师好。关于调度的顺序，想请教下。

func main () {runtime.GOMAXPROCS (1)

	// 启动 4 个协程
	var i int
	for i = 0; i &lt; 4; i++ {
		go func (i int) {
			fmt.Printf ("hello % d \n", i)
		}(i)
	}

	fmt.Println ("hello main")

	time.Sleep (1 * time.Second)
}
// 输出的是 3,0,1,2

如果我在每个子协程打印前，加上 time.Sleep (10 * time.Millisecond) ，完整代码如下：
func main () {
	runtime.GOMAXPROCS (1)

	// 启动 4 个协程
	var i int
	for i = 0; i &lt; 4; i++ {
		go func (i int) {
			time.Sleep (10 * time.Millisecond)
			fmt.Printf ("hello % d \n", i)
		}(i)
	}

	fmt.Println ("hello main")

	time.Sleep (1 * time.Second)
}
// 又输出 0,3,2,1
</div><div><p>作者回复：我觉得这个例子输出顺序不用深究，在我的 mac 和 linux 上，你的第二个程序输出 2 3 0 1。</p></div><div><div>2022-01-21</div><div><div><i></i></div><div><i></i><span></span></div></div></div></div></div></li><li><div><div data-v-3d2acdda=""><div class="sr-rd-content-center-small"><img class="" src="https://static001.geekbang.org/account/avatar/00/18/75/bc/e24e181e.jpg?x-oss-process=image/resize,m_fill,h_68,w_68"></div></div><div><div><div><span>Calvin</span></div></div><div>思考题：
1、可以定时 1 秒间隔地不断看到 “I got scheduled!” 输出；
2、main 函数中，go deadloop () 语句前添加 runtime.GOMAXPROCS (1)，即可使 main goroutine 在创建 deadloop goroutine 之后无法继续得到调度。

PS：基于 go1.17.6 windows/amd64 版本测试，我这测试结果与留言中 Geek_cca544 同学的结论不一样，请问老师问题 2 哪个答案是对的呢？</div><div><p>作者回复：我没看到你的答案与 Geek_cca544 同学的结论有啥不一样啊。你的 go1.17.6 windows/amd64 版本测试结果有啥不一样么？</p></div><div><div>2022-01-15</div><div><div><i></i><span>2</span></div><div><i></i><span></span></div></div></div></div></div></li></ul><div> 收起评论<span></span></div></div></sr-rd-content>
                            <toc-bg><toc style="width: initial;overflow: auto!important;"class="simpread-font simpread-theme-root" data-reactid=".14"><outline class="toc-level-h1" data-reactid=".14.0" style="width: 175px;"><active data-reactid=".14.0.0" ></active><a class="toc-outline-theme-github" href="#sr-toc-0" data-reactid=".14.0.1"><span data-reactid=".14.0.1.0"> 32｜并发：聊聊 Goroutine 调度器的原理</span></a></outline><outline class="toc-level-h2" data-reactid=".14.1" style="width: 165px;"><active data-reactid=".14.1.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-1" data-reactid=".14.1.1"><span data-reactid=".14.1.1.0">Goroutine 调度器</span></a></outline><outline class="toc-level-h2" data-reactid=".14.2" style="width: 165px;"><active data-reactid=".14.2.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-2" data-reactid=".14.2.1"><span data-reactid=".14.2.1.0">Goroutine 调度器模型与演化过程</span></a></outline><outline class="toc-level-h2" data-reactid=".14.3" style="width: 165px;"><active data-reactid=".14.3.0"></active><a class="toc-outline-theme-github" href="#sr-toc-3" data-reactid=".14.3.1"><span data-reactid=".14.3.1.0">深入 G-P-M 模型</span></a></outline><outline class="toc-level-h3" data-reactid=".14.4" style="width: 155px;"><active data-reactid=".14.4.0"></active><pangu> </pangu><a class="toc-outline-theme-github" href="#sr-toc-4" data-reactid=".14.4.1"><span data-reactid=".14.4.1.0">G、P 和 M</span></a></outline><outline class="toc-level-h3" data-reactid=".14.5" style="width: 155px;"><active data-reactid=".14.5.0"></active><a class="toc-outline-theme-github" href="#sr-toc-5" data-reactid=".14.5.1"><span data-reactid=".14.5.1.0">G 被抢占调度</span></a></outline><outline class="toc-level-h2" data-reactid=".14.6" style="width: 165px;"><active data-reactid=".14.6.0"></active><a class="toc-outline-theme-github" href="#sr-toc-6" data-reactid=".14.6.1"><span data-reactid=".14.6.1.0">小结</span></a></outline><outline class="toc-level-h2" data-reactid=".14.7" style="width: 165px;"><active data-reactid=".14.7.0"></active><a class="toc-outline-theme-github" href="#sr-toc-7" data-reactid=".14.7.1"><span data-reactid=".14.7.1.0">思考题</span></a></outline><outline class="toc-level-h2" data-reactid=".14.8" style="width: 165px;"><active data-reactid=".14.8.0"></active><a class="toc-outline-theme-github" href="#sr-toc-8" data-reactid=".14.8.1"><span data-reactid=".14.8.1.0">精选留言 (17)</span></a></outline></toc></toc-bg>
                            <sr-rd-footer>
                                <sr-rd-footer-group>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                                    <sr-rd-footer-line></sr-rd-footer-line>
                                </sr-rd-footer-group>
                                <sr-rd-footer-copywrite>
                                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="https://time.geekbang.org/column/article/476643" target="_blank">原文地址 </a></div>
                                </sr-rd-footer-copywrite>
                            </sr-rd-footer>
                        </sr-read>
                    </body>
                </html>